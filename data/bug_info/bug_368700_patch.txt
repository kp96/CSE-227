Index: content/html/document/src/nsHTMLDocument.cpp
===================================================================
RCS file: /cvsroot/mozilla/content/html/document/src/nsHTMLDocument.cpp,v
retrieving revision 3.716
diff -p -u -8 -r3.716 nsHTMLDocument.cpp
--- content/html/document/src/nsHTMLDocument.cpp	27 Mar 2007 15:33:38 -0000	3.716
+++ content/html/document/src/nsHTMLDocument.cpp	3 Apr 2007 21:18:24 -0000
@@ -121,16 +121,17 @@
 #include "nsICacheEntryDescriptor.h"
 #include "nsIJSContextStack.h"
 #include "nsIDocumentViewer.h"
 #include "nsIWyciwygChannel.h"
 #include "nsIScriptElement.h"
 #include "nsIScriptError.h"
 #include "nsIMutableArray.h"
 #include "nsArrayUtils.h"
+#include "nsIEffectiveTLDService.h"
 
 #include "nsIPrompt.h"
 //AHMED 12-2
 #include "nsBidiUtils.h"
 
 #include "nsIEditingSession.h"
 #include "nsIEditor.h"
 #include "nsNodeInfoManager.h"
@@ -1637,18 +1638,32 @@ nsHTMLDocument::SetDomain(const nsAStrin
   PRBool ok = PR_FALSE;
   if (current.Equals(aDomain)) {
     ok = PR_TRUE;
   } else if (aDomain.Length() < current.Length()) {
     nsAutoString suffix;
     current.Right(suffix, aDomain.Length());
     PRUnichar c = current.CharAt(current.Length() - aDomain.Length() - 1);
     if (suffix.Equals(aDomain, nsCaseInsensitiveStringComparator()) &&
-        (c == '.'))
-      ok = PR_TRUE;
+        (c == '.')) {
+      // Using only a TLD is forbidden (bug 368700)
+      nsCOMPtr<nsIEffectiveTLDService> tldService =
+        do_GetService(NS_EFFECTIVETLDSERVICE_CONTRACTID);
+      if (!tldService)
+        return NS_ERROR_NOT_AVAILABLE;
+
+      NS_ConvertUTF16toUTF8 str(aDomain);
+      PRUint32 tldLength;
+      nsresult rv = tldService->GetEffectiveTLDLength(str, &tldLength);
+      if (NS_FAILED(rv))
+        return rv;
+
+      if (tldLength < str.Length())
+        ok = PR_TRUE;
+    }
   }
   if (!ok) {
     // Error: illegal domain
     return NS_ERROR_DOM_BAD_DOCUMENT_DOMAIN;
   }
 
   // Create new URI
   nsCOMPtr<nsIURI> uri;
