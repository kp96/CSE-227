{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basa4ad8c4\""},"diff":[{"chunks":[{"content":"@@ -75,7 +75,7 @@ static POINTL gDragLastPoint;","changes":[{"type":"normal","normal":true,"ln1":75,"ln2":75,"content":" // construction"},{"type":"normal","normal":true,"ln1":76,"ln2":76,"content":" //-----------------------------------------------------"},{"type":"normal","normal":true,"ln1":77,"ln2":77,"content":" nsNativeDragTarget::nsNativeDragTarget(nsIWidget * aWnd)"},{"type":"del","del":true,"ln":78,"content":"-  : m_cRef(0), mWindow(aWnd), mCanMove(PR_TRUE)"},{"type":"add","add":true,"ln":78,"content":"+  : m_cRef(0), mWindow(aWnd), mCanMove(PR_TRUE), mDragCancelled(PR_FALSE)"},{"type":"normal","normal":true,"ln1":79,"ln2":79,"content":" {"},{"type":"normal","normal":true,"ln1":80,"ln2":80,"content":"   mHWnd = (HWND)mWindow->GetNativeData(NS_NATIVE_WINDOW);"},{"type":"normal","normal":true,"ln1":81,"ln2":81,"content":" "}],"oldStart":75,"oldLines":7,"newStart":75,"newLines":7},{"content":"@@ -294,10 +294,15 @@ nsNativeDragTarget::DragOver(DWORD   grfKeyState,","changes":[{"type":"normal","normal":true,"ln1":294,"ln2":294,"content":" \t\treturn ResultFromScode(E_FAIL);"},{"type":"normal","normal":true,"ln1":295,"ln2":295,"content":"   }"},{"type":"normal","normal":true,"ln1":296,"ln2":296,"content":" "},{"type":"add","add":true,"ln":297,"content":"+  // without the AddRef() |this| can get destroyed in an event handler"},{"type":"add","add":true,"ln":298,"content":"+  this->AddRef();"},{"type":"normal","normal":true,"ln1":297,"ln2":299,"content":"   mDragService->FireDragEventAtSource(NS_DRAGDROP_DRAG);"},{"type":"add","add":true,"ln":300,"content":"+  if (!mDragCancelled) {"},{"type":"add","add":true,"ln":301,"content":"+    // Now process the native drag state and then dispatch the event"},{"type":"add","add":true,"ln":302,"content":"+    ProcessDrag(nsnull, NS_DRAGDROP_OVER, grfKeyState, pt, pdwEffect);"},{"type":"add","add":true,"ln":303,"content":"+  }"},{"type":"add","add":true,"ln":304,"content":"+  this->Release();"},{"type":"normal","normal":true,"ln1":298,"ln2":305,"content":" "},{"type":"del","del":true,"ln":299,"content":"-  // Now process the native drag state and then dispatch the event"},{"type":"del","del":true,"ln":300,"content":"-  ProcessDrag(nsnull, NS_DRAGDROP_OVER, grfKeyState, pt, pdwEffect);"},{"type":"normal","normal":true,"ln1":301,"ln2":306,"content":"   return S_OK;"},{"type":"normal","normal":true,"ln1":302,"ln2":307,"content":" }"},{"type":"normal","normal":true,"ln1":303,"ln2":308,"content":" "}],"oldStart":294,"oldLines":10,"newStart":294,"newLines":15}],"deletions":3,"additions":8,"from":"widget/src/windows/nsNativeDragTarget.cpp","to":"widget/src/windows/nsNativeDragTarget.cpp","index":["80e283f..78bff4e","100644"]},{"chunks":[{"content":"@@ -90,6 +90,8 @@ public:","changes":[{"type":"normal","normal":true,"ln1":90,"ln2":90,"content":"   STDMETHODIMP Drop(LPDATAOBJECT pSource, DWORD grfKeyState,"},{"type":"normal","normal":true,"ln1":91,"ln2":91,"content":"                     POINTL point, DWORD* pEffect);"},{"type":"normal","normal":true,"ln1":92,"ln2":92,"content":" "},{"type":"add","add":true,"ln":93,"content":"+  PRBool           mDragCancelled;"},{"type":"add","add":true,"ln":94,"content":"+"},{"type":"normal","normal":true,"ln1":93,"ln2":95,"content":" protected:"},{"type":"normal","normal":true,"ln1":94,"ln2":96,"content":" "},{"type":"normal","normal":true,"ln1":95,"ln2":97,"content":"   void GetGeckoDragAction(LPDATAOBJECT pData, DWORD grfKeyState,"}],"oldStart":90,"oldLines":6,"newStart":90,"newLines":8}],"deletions":0,"additions":2,"from":"widget/src/windows/nsNativeDragTarget.h","to":"widget/src/windows/nsNativeDragTarget.h","index":["c599e82..8462fc4","100644"]},{"chunks":[{"content":"@@ -3096,6 +3096,7 @@ NS_METHOD nsWindow::EnableDragDrop(PRBool aEnable)","changes":[{"type":"normal","normal":true,"ln1":3096,"ln2":3096,"content":"       if (S_OK == ::CoLockObjectExternal((LPUNKNOWN)mNativeDragTarget, FALSE, TRUE)) {"},{"type":"normal","normal":true,"ln1":3097,"ln2":3097,"content":"         rv = NS_OK;"},{"type":"normal","normal":true,"ln1":3098,"ln2":3098,"content":"       }"},{"type":"add","add":true,"ln":3099,"content":"+      mNativeDragTarget->mDragCancelled = PR_TRUE;"},{"type":"normal","normal":true,"ln1":3099,"ln2":3100,"content":"       NS_RELEASE(mNativeDragTarget);"},{"type":"normal","normal":true,"ln1":3100,"ln2":3101,"content":"     }"},{"type":"normal","normal":true,"ln1":3101,"ln2":3102,"content":"   }"}],"oldStart":3096,"oldLines":6,"newStart":3096,"newLines":7},{"content":"@@ -4608,11 +4609,11 @@ PRBool nsWindow::ProcessMessage(UINT msg, WPARAM wParam, LPARAM lParam, LRESULT","changes":[{"type":"normal","normal":true,"ln1":4608,"ln2":4609,"content":" #endif"},{"type":"normal","normal":true,"ln1":4609,"ln2":4610,"content":" "},{"type":"normal","normal":true,"ln1":4610,"ln2":4611,"content":"     case WM_SETFOCUS:"},{"type":"del","del":true,"ln":4611,"content":"-      result = DispatchFocus(NS_GOTFOCUS, PR_TRUE);\r"},{"type":"del","del":true,"ln":4612,"content":"-      if (gJustGotActivate) {\r"},{"type":"del","del":true,"ln":4613,"content":"-        gJustGotActivate = PR_FALSE;\r"},{"type":"del","del":true,"ln":4614,"content":"-        gJustGotDeactivate = PR_FALSE;\r"},{"type":"del","del":true,"ln":4615,"content":"-        result = DispatchFocus(NS_ACTIVATE, PR_TRUE);\r"},{"type":"add","add":true,"ln":4612,"content":"+      result = DispatchFocus(NS_GOTFOCUS, PR_TRUE);"},{"type":"add","add":true,"ln":4613,"content":"+      if (gJustGotActivate) {"},{"type":"add","add":true,"ln":4614,"content":"+        gJustGotActivate = PR_FALSE;"},{"type":"add","add":true,"ln":4615,"content":"+        gJustGotDeactivate = PR_FALSE;"},{"type":"add","add":true,"ln":4616,"content":"+        result = DispatchFocus(NS_ACTIVATE, PR_TRUE);"},{"type":"normal","normal":true,"ln1":4616,"ln2":4617,"content":"       }"},{"type":"normal","normal":true,"ln1":4617,"ln2":4618,"content":" "},{"type":"normal","normal":true,"ln1":4618,"ln2":4619,"content":" #ifdef ACCESSIBILITY"}],"oldStart":4608,"oldLines":11,"newStart":4609,"newLines":11}],"deletions":5,"additions":6,"from":"widget/src/windows/nsWindow.cpp","to":"widget/src/windows/nsWindow.cpp","index":["d1a11f6..0fd8629","100644"]}]}