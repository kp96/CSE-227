From: timeless@mozdev.org
Bug 504423 ReadAnnotationEntry leaks key if nsCStringKey sets rv to failure
r=dveditz

diff --git a/caps/src/nsPrincipal.cpp b/caps/src/nsPrincipal.cpp
--- a/caps/src/nsPrincipal.cpp
+++ b/caps/src/nsPrincipal.cpp
@@ -1042,7 +1042,11 @@ ReadAnnotationEntry(nsIObjectInputStream
 {
   nsresult rv;
   nsCStringKey* key = new nsCStringKey(aStream, &rv);
+  if (!key)
+    return NS_ERROR_OUT_OF_MEMORY;
+
   if (NS_FAILED(rv)) {
+    delete key;
     return rv;
   }
 
