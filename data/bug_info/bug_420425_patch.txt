Index: docshell/base/nsDocShell.cpp
===================================================================
RCS file: /cvsroot/mozilla/docshell/base/nsDocShell.cpp,v
retrieving revision 1.888
diff -p -u -w -6 -r1.888 nsDocShell.cpp
--- docshell/base/nsDocShell.cpp	12 Mar 2008 21:52:48 -0000	1.888
+++ docshell/base/nsDocShell.cpp	17 Mar 2008 08:28:40 -0000
@@ -1023,12 +1023,15 @@ nsDocShell::FirePageHideNotification(PRB
 //
 // Bug 13871: Prevent frameset spoofing
 //
 // This routine answers: 'Is origin's document from same domain as
 // target's document?'
 //
+// file: uris are considered the same domain for the purpose of
+// frame navigation regardless of script accessibility (bug 420425)
+//
 /* static */
 PRBool
 nsDocShell::ValidateOrigin(nsIDocShellTreeItem* aOriginTreeItem,
                            nsIDocShellTreeItem* aTargetTreeItem)
 {
     nsCOMPtr<nsIScriptSecurityManager> securityManager =
@@ -1063,16 +1066,31 @@ nsDocShell::ValidateOrigin(nsIDocShellTr
     nsCOMPtr<nsIDOMDocument> targetDOMDocument =
         do_GetInterface(aTargetTreeItem);
     nsCOMPtr<nsIDocument> targetDocument(do_QueryInterface(targetDOMDocument));
     NS_ENSURE_TRUE(targetDocument, PR_FALSE);
 
     PRBool equal;
+    rv = originDocument->NodePrincipal()->
+            Equals(targetDocument->NodePrincipal(), &equal);
+    if (NS_SUCCEEDED(rv) && equal) {
+        return PR_TRUE;
+    }
+
+    // Not strictly equal, special case if both are file: uris
+    PRBool originIsFile = PR_FALSE;
+    PRBool targetIsFile = PR_FALSE;
+    nsCOMPtr<nsIURI> originURI;
+    nsCOMPtr<nsIURI> targetURI;
     return
         NS_SUCCEEDED(originDocument->NodePrincipal()->
-                       Equals(targetDocument->NodePrincipal(), &equal)) &&
-        equal;
+                        GetURI(getter_AddRefs(originURI))) &&
+        NS_SUCCEEDED(targetDocument->NodePrincipal()->
+                        GetURI(getter_AddRefs(targetURI))) &&
+        NS_SUCCEEDED(originURI->SchemeIs("file", &originIsFile)) &&
+        NS_SUCCEEDED(targetURI->SchemeIs("file", &targetIsFile)) &&
+        originIsFile && targetIsFile;
 }
 
 NS_IMETHODIMP
 nsDocShell::GetEldestPresContext(nsPresContext** aPresContext)
 {
     nsresult rv = NS_OK;
@@ -1912,12 +1930,13 @@ nsDocShell::CanAccessItem(nsIDocShellTre
 
     // For historical context, see:
     // 
     // Bug 13871:  Prevent frameset spoofing
     // Bug 103638: Targets with same name in different windows open in wrong
     //             window with javascript
+    // Bug 408052: Adopt "ancestor" frame navigation policy
 
     // Now do a security check
     //
     // Allow navigation if
     //  1) aAccessingItem can script aTargetItem or one of its ancestors in
     //     the frame hierarchy or
