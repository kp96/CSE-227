Index: src/application/MainController.h
===================================================================
RCS file: /cvsroot/mozilla/camino/src/application/MainController.h,v
retrieving revision 1.91
diff -u -8 -r1.91 MainController.h
--- src/application/MainController.h	22 Jul 2009 17:39:43 -0000	1.91
+++ src/application/MainController.h	31 Jul 2009 14:34:40 -0000
@@ -173,16 +173,17 @@
 - (IBAction)nextTab:(id)aSender;
 - (IBAction)toggleTabThumbnailView:(id)aSender;
 - (IBAction)downloadsWindow:(id)aSender;
 
 // Help menu actions
 - (IBAction)supportLink:(id)aSender;
 - (IBAction)keyboardShortcutsLink:(id)aSender;
 - (IBAction)infoLink:(id)aSender;
+- (IBAction)reportPhishingPage:(id)aSender;
 - (IBAction)aboutPlugins:(id)aSender;
 
 // used by export bookmarks popup to set file extension for the resulting bookmarks file
 - (IBAction)setFileExtension:(id)aSender;
 // used by page info panel to show certificate information
 - (IBAction)showCertificates:(id)aSender;
 
 // if the main/key window is a browser window, return its controller, otherwise nil
Index: src/application/MainController.mm
===================================================================
RCS file: /cvsroot/mozilla/camino/src/application/MainController.mm,v
retrieving revision 1.284
diff -u -8 -r1.284 MainController.mm
--- src/application/MainController.mm	24 Jul 2009 23:50:13 -0000	1.284
+++ src/application/MainController.mm	31 Jul 2009 14:34:42 -0000
@@ -1730,16 +1730,21 @@
 
 - (IBAction)infoLink:(id)aSender
 {
   NSString* pageToLoad = NSLocalizedStringFromTable(@"InfoPage", @"WebsiteDefaults", nil);
   if (![pageToLoad isEqualToString:@"InfoPage"])
     [self loadApplicationPage:pageToLoad];
 }
 
+- (IBAction)reportPhishingPage:(id)aSender
+{
+  [[self mainWindowBrowserController] reportPhishingPage:aSender];
+}
+
 - (IBAction)aboutPlugins:(id)aSender
 {
   [self loadApplicationPage:@"about:plugins"];
 }
 
 #pragma mark -
 #pragma mark Menu Maintenance
 
@@ -1840,17 +1845,18 @@
       action == @selector(makeTextSmaller:) ||
       action == @selector(makeTextDefaultSize:) ||
       action == @selector(makePageBigger:) ||
       action == @selector(makePageSmaller:) ||
       action == @selector(makePageDefaultSize:) ||
       action == @selector(viewPageSource:) ||
       action == @selector(sendURL:) ||
       action == @selector(printDocument:) ||
-      action == @selector(pageSetup:))
+      action == @selector(pageSetup:) ||
+      action == @selector(reportPhishingPage:))
   {
     if ([browserController shouldSuppressWindowActions])
       return NO;
     return (browserController && [browserController validateActionBySelector:action]);
   }
 
   if (action == @selector(checkForUpdates:) &&
       ![[[NSBundle mainBundle] objectForInfoDictionaryKey:@"SUEnableAutomaticChecks"] boolValue])
Index: src/browser/BrowserWindowController.h
===================================================================
RCS file: /cvsroot/mozilla/camino/src/browser/BrowserWindowController.h,v
retrieving revision 1.130
diff -u -8 -r1.130 BrowserWindowController.h
--- src/browser/BrowserWindowController.h	3 Jul 2009 17:31:02 -0000	1.130
+++ src/browser/BrowserWindowController.h	31 Jul 2009 14:34:43 -0000
@@ -247,16 +247,20 @@
 
 - (BOOL)canMakeTextBigger;
 - (BOOL)canMakeTextSmaller;
 - (BOOL)canMakeTextDefaultSize;
 - (IBAction)makeTextBigger:(id)aSender;
 - (IBAction)makeTextSmaller:(id)aSender;
 - (IBAction)makeTextDefaultSize:(id)aSender;
 
+// Returns YES if the current page is reasonable to report to the safe browsing
+// data provider as a suspected phishing site.
+- (BOOL)canReportCurrentPageAsPhishing;
+
 - (BOOL)canMakePageBigger;
 - (BOOL)canMakePageSmaller;
 - (BOOL)canMakePageDefaultSize;
 - (IBAction)makePageBigger:(id)aSender;
 - (IBAction)makePageSmaller:(id)aSender;
 - (IBAction)makePageDefaultSize:(id)aSender;
 
 - (IBAction)getInfo:(id)sender;
@@ -294,16 +298,19 @@
 
 - (IBAction)reloadWithNewCharset:(NSString*)charset;
 - (NSString*)currentCharset;
 
 - (IBAction)frameToNewWindow:(id)sender;
 - (IBAction)frameToNewTab:(id)sender;
 - (IBAction)frameToThisWindow:(id)sender;
 
+// Reports the current page as one suspected of phishing.
+- (IBAction)reportPhishingPage:(id)aSender;
+
 - (BrowserWindowController*)openNewWindowWithURL: (NSString*)aURLSpec referrer:(NSString*)aReferrer loadInBackground: (BOOL)aLoadInBG allowPopups:(BOOL)inAllowPopups;
 - (void)openNewTabWithURL: (NSString*)aURLSpec referrer: (NSString*)aReferrer loadInBackground: (BOOL)aLoadInBG allowPopups:(BOOL)inAllowPopups setJumpback:(BOOL)inSetJumpback;
 
 - (CHBrowserView*)createNewTabBrowser:(BOOL)inLoadInBG;
 
 - (void)openURLArray:(NSArray*)urlArray tabOpenPolicy:(ETabOpenPolicy)tabPolicy allowPopups:(BOOL)inAllowPopups;
 - (void)openURLArrayReplacingTabs:(NSArray*)urlArray closeExtraTabs:(BOOL)closeExtra allowPopups:(BOOL)inAllowPopups;
 
Index: src/browser/BrowserWindowController.mm
===================================================================
RCS file: /cvsroot/mozilla/camino/src/browser/BrowserWindowController.mm,v
retrieving revision 1.409
diff -u -8 -r1.409 BrowserWindowController.mm
--- src/browser/BrowserWindowController.mm	24 Jul 2009 23:50:14 -0000	1.409
+++ src/browser/BrowserWindowController.mm	31 Jul 2009 14:34:47 -0000
@@ -1935,16 +1935,19 @@
   }
   if (action == @selector(printDocument:) ||
       action == @selector(pageSetup:) ||
       action == @selector(savePage:))
   {
     return (![self bookmarkManagerIsVisible] && ![[self browserWrapper] isBlockedErrorOverlayShowing]);
   }
 
+  if (action == @selector(reportPhishingPage:))
+    return [self canReportCurrentPageAsPhishing];
+
   return YES;
 }
 
 - (BOOL)shouldSuppressWindowActions
 {
   return ([[self window] attachedSheet] || [mContentView tabThumbnailGridViewIsVisible]);
 }
 
@@ -5308,16 +5311,44 @@
   NSString* reportURL = [listManager listReportingURLForPrefKey:prefToFetch
                                                     urlToReport:aBlockedURL];
   if (reportURL)
     [self loadURL:reportURL referrer:nil focusContent:YES allowPopups:NO];
   else
     NSLog(@"Unable to find an error reporting URL for the current safe browsing data provider");
 }
 
+- (IBAction)reportPhishingPage:(id)aSender
+{
+  NSString* urlToReport = [[self browserWrapper] currentURI];
+  if (!urlToReport)
+    return;
+
+  SafeBrowsingListManager* listManager = [SafeBrowsingListManager sharedInstance];
+
+  NSString* reportURL = [listManager listReportingURLForPrefKey:kGeckoPrefSafeBrowsingDataProviderReportPhishingURL
+                                                    urlToReport:urlToReport];
+  if (reportURL)
+    [self loadURL:reportURL referrer:nil focusContent:YES allowPopups:NO];
+}
+
+- (BOOL)canReportCurrentPageAsPhishing
+{
+  BrowserWrapper* browserWrapper = [self browserWrapper];
+
+  if ([browserWrapper isBlockedErrorOverlayShowing] || [browserWrapper isPageLoadErrorOverlayShowing])
+    return NO;
+
+  NSString* currentURI = [browserWrapper currentURI];
+  if (!([currentURI hasPrefix:@"http://"] || [currentURI hasPrefix:@"https://"]))
+    return NO;
+
+  return YES;
+}
+
 @end
 
 #pragma mark -
 
 @implementation ThrobberHandler
 
 -(id)initWithToolbarItem:(NSToolbarItem*)inButton images:(NSArray*)inImages
 {
Index: src/browser/BrowserWrapper.h
===================================================================
RCS file: /cvsroot/mozilla/camino/src/browser/BrowserWrapper.h,v
retrieving revision 1.72
diff -u -8 -r1.72 BrowserWrapper.h
--- src/browser/BrowserWrapper.h	24 Jul 2009 23:50:15 -0000	1.72
+++ src/browser/BrowserWrapper.h	31 Jul 2009 14:34:48 -0000
@@ -214,16 +214,17 @@
 
 
 // accessors
 - (CHBrowserView*)browserView;
 - (BOOL)isBusy;
 - (BOOL)isEmpty;                      // is about:blank loaded?
 - (BOOL)isInternalURI;
 - (BOOL)isBlockedErrorOverlayShowing; // is about:safebrowsingblocked loaded?
+- (BOOL)isPageLoadErrorOverlayShowing;
 - (BOOL)isBookmarkable;
 - (BOOL)canReload;
 
 - (NSString*)pendingURI;
 - (NSString*)currentURI;
 - (NSString*)documentURI;
 - (NSString*)pageTitle;
 - (NSString*)pageSource;
Index: src/browser/BrowserWrapper.mm
===================================================================
RCS file: /cvsroot/mozilla/camino/src/browser/BrowserWrapper.mm,v
retrieving revision 1.167
diff -u -8 -r1.167 BrowserWrapper.mm
--- src/browser/BrowserWrapper.mm	24 Jul 2009 23:50:15 -0000	1.167
+++ src/browser/BrowserWrapper.mm	31 Jul 2009 14:34:49 -0000
@@ -1363,16 +1363,21 @@
   // Quick heuristic before double-checking by inspecting the DOM.
   if ([currentTitle isEqualToString:NSLocalizedString(@"PhishingTitleText", nil)] ||
       [currentTitle isEqualToString:NSLocalizedString(@"MalwareTitleText", nil)]) {
     return [[self documentURI] hasPrefix:@"about:safebrowsingblocked"];
   }
   return NO;
 }
 
+- (BOOL)isPageLoadErrorOverlayShowing
+{
+  return [[self documentURI] hasPrefix:@"about:neterror"];
+}
+
 //
 // -isBookmarkable
 //
 // Returns YES if the current URI is appropriate and safe for bookmarking.
 //
 - (BOOL)isBookmarkable
 {
   if ([self isEmpty] || [self isBlockedErrorOverlayShowing])
