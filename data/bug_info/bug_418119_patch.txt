Index: parser/htmlparser/src/nsExpatDriver.cpp
===================================================================
RCS file: /cvsroot/mozilla/parser/htmlparser/src/nsExpatDriver.cpp,v
retrieving revision 3.107
diff -p -u -8 -r3.107 nsExpatDriver.cpp
--- parser/htmlparser/src/nsExpatDriver.cpp	8 Feb 2008 22:07:53 -0000	3.107
+++ parser/htmlparser/src/nsExpatDriver.cpp	20 Feb 2008 11:14:12 -0000
@@ -51,16 +51,19 @@
 #include "nsNetUtil.h"
 #include "prprf.h"
 #include "prmem.h"
 #include "nsTextFormatter.h"
 #include "nsDirectoryServiceDefs.h"
 #include "nsCRT.h"
 #include "nsIConsoleService.h"
 #include "nsIScriptError.h"
+#include "nsIContentPolicy.h"
+#include "nsContentPolicyUtils.h"
+#include "nsContentErrors.h"
 #include "nsXPCOMCIDInternal.h"
 #include "nsUnicharInputStream.h"
 
 #define kExpatSeparatorChar 0xFFFF
 
 static const PRUnichar kUTF16[] = { 'U', 'T', 'F', '-', '1', '6', '\0' };
 
 #ifdef PR_LOGGING
@@ -791,16 +794,34 @@ nsExpatDriver::OpenInputStreamFromExtern
     nsCOMPtr<nsIURI> localURI;
     if (!IsLoadableDTD(mCatalogData, uri, getter_AddRefs(localURI))) {
       return NS_ERROR_NOT_IMPLEMENTED;
     }
 
     localURI.swap(uri);
   }
 
+  nsCOMPtr<nsIContentSink> sink = do_QueryInterface(mSink);
+  nsCOMPtr<nsIDocument> doc;
+  if (sink)
+    doc = do_QueryInterface(sink->GetTarget());
+  PRInt16 shouldLoad = nsIContentPolicy::ACCEPT;
+  rv = NS_CheckContentLoadPolicy(nsIContentPolicy::TYPE_OTHER,
+                                uri,
+                                (doc ? doc->NodePrincipal() : nsnull),
+                                doc,
+                                EmptyCString(), //mime guess
+                                nsnull,         //extra
+                                &shouldLoad);
+  if (NS_FAILED(rv)) return rv;
+  if (NS_CP_REJECTED(shouldLoad)) {
+    // Disallowed by content policy
+    return NS_ERROR_CONTENT_BLOCKED;
+  }
+
   rv = NS_OpenURI(aStream, uri);
 
   nsCAutoString absURL;
   uri->GetSpec(absURL);
 
   CopyUTF8toUTF16(absURL, aAbsURL);
 
   return rv;
Index: parser/htmlparser/src/Makefile.in
===================================================================
RCS file: /cvsroot/mozilla/parser/htmlparser/src/Makefile.in,v
retrieving revision 1.105
diff -p -u -8 -r1.105 Makefile.in
--- parser/htmlparser/src/Makefile.in	14 Mar 2007 16:44:50 -0000	1.105
+++ parser/htmlparser/src/Makefile.in	20 Feb 2008 11:14:12 -0000
@@ -61,16 +61,20 @@ REQUIRES	= xpcom \
 		  expat \
 		  xml \
 		  content \
 		  dom \
 		  pref \
 		  nkcache \
 		  intl \
 		  xpconnect \
+		  layout \
+		  widget \
+		  caps \
+		  js \
 		  $(NULL)
 
 SHARED_LIBRARY_LIBS = \
 		$(DEPTH)/parser/expat/lib/$(LIB_PREFIX)mozexpat_s.$(LIB_SUFFIX) \
 		$(DEPTH)/parser/xml/src/$(LIB_PREFIX)saxp.$(LIB_SUFFIX) \
 		$(NULL)
 
 ifdef MOZ_PERF_METRICS
