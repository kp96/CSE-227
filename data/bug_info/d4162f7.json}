{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basd4162f7\""},"diff":[{"chunks":[{"content":"@@ -63,6 +63,7 @@ REQUIRES += \\","changes":[{"type":"normal","normal":true,"ln1":63,"ln2":63,"content":" \t\t  unicharutil \\"},{"type":"normal","normal":true,"ln1":64,"ln2":64,"content":" \t\t  necko \\"},{"type":"normal","normal":true,"ln1":65,"ln2":65,"content":" \t\t  htmlparser \\"},{"type":"add","add":true,"ln":66,"content":"+\t\t  caps \\"},{"type":"normal","normal":true,"ln1":66,"ln2":67,"content":" \t\t  $(NULL)"},{"type":"normal","normal":true,"ln1":67,"ln2":68,"content":" else"},{"type":"normal","normal":true,"ln1":68,"ln2":69,"content":" REQUIRES += expat"}],"oldStart":63,"oldLines":6,"newStart":63,"newLines":7}],"deletions":0,"additions":1,"from":"content/xslt/src/xml/Makefile.in","to":"content/xslt/src/xml/Makefile.in","index":["9381572..2517b31","100644"]},{"chunks":[{"content":"@@ -45,6 +45,7 @@","changes":[{"type":"normal","normal":true,"ln1":45,"ln2":45,"content":" #include \"nsIDOMDocument.h\""},{"type":"normal","normal":true,"ln1":46,"ln2":46,"content":" #include \"nsSyncLoadService.h\""},{"type":"normal","normal":true,"ln1":47,"ln2":47,"content":" #include \"nsNetUtil.h\""},{"type":"add","add":true,"ln":48,"content":"+#include \"nsIPrincipal.h\""},{"type":"normal","normal":true,"ln1":48,"ln2":49,"content":" #else"},{"type":"normal","normal":true,"ln1":49,"ln2":50,"content":" #include \"expat_config.h\""},{"type":"normal","normal":true,"ln1":50,"ln2":51,"content":" #include \"expat.h\""}],"oldStart":45,"oldLines":6,"newStart":45,"newLines":7},{"content":"@@ -98,8 +99,13 @@ txParseDocumentFromURI(const nsAString& aHref, const txXPathNode& aLoader,","changes":[{"type":"normal","normal":true,"ln1":98,"ln2":99,"content":"     nsIDocument* loaderDocument = txXPathNativeNode::getDocument(aLoader);"},{"type":"normal","normal":true,"ln1":99,"ln2":100,"content":" "},{"type":"normal","normal":true,"ln1":100,"ln2":101,"content":"     nsCOMPtr<nsILoadGroup> loadGroup = loaderDocument->GetDocumentLoadGroup();"},{"type":"del","del":true,"ln":101,"content":"-    nsIURI *loaderUri = loaderDocument->GetDocumentURI();"},{"type":"del","del":true,"ln":102,"content":"-    NS_ENSURE_TRUE(loaderUri, NS_ERROR_FAILURE);"},{"type":"add","add":true,"ln":102,"content":"+"},{"type":"add","add":true,"ln":103,"content":"+    nsCOMPtr<nsIURI> loaderUri;"},{"type":"add","add":true,"ln":104,"content":"+    rv = loaderDocument->NodePrincipal()->GetURI(getter_AddRefs(loaderUri));"},{"type":"add","add":true,"ln":105,"content":"+    NS_ENSURE_SUCCESS(rv, rv);"},{"type":"add","add":true,"ln":106,"content":"+"},{"type":"add","add":true,"ln":107,"content":"+    // For the system principal loaderUri will be null here, which is good"},{"type":"add","add":true,"ln":108,"content":"+    // since that means that chrome documents can load any uri."},{"type":"normal","normal":true,"ln1":103,"ln2":109,"content":" "},{"type":"normal","normal":true,"ln1":104,"ln2":110,"content":"     // Raw pointer, we want the resulting txXPathNode to hold a reference to"},{"type":"normal","normal":true,"ln1":105,"ln2":111,"content":"     // the document."}],"oldStart":98,"oldLines":8,"newStart":99,"newLines":13}],"deletions":2,"additions":8,"from":"content/xslt/src/xml/txXMLParser.cpp","to":"content/xslt/src/xml/txXMLParser.cpp","index":["4e39fa9..f951d38","100644"]},{"chunks":[{"content":"@@ -422,48 +422,16 @@ txStylesheetSink::GetInterface(const nsIID& aIID, void** aResult)","changes":[{"type":"normal","normal":true,"ln1":422,"ln2":422,"content":"     return QueryInterface(aIID, aResult);"},{"type":"normal","normal":true,"ln1":423,"ln2":423,"content":" }"},{"type":"normal","normal":true,"ln1":424,"ln2":424,"content":" "},{"type":"del","del":true,"ln":425,"content":"-static nsresult"},{"type":"del","del":true,"ln":426,"content":"-CheckLoadURI(nsIURI *aUri, nsIURI *aReferrerUri,"},{"type":"del","del":true,"ln":427,"content":"-             nsIPrincipal *aReferrerPrincipal, nsISupports *aContext)"},{"type":"del","del":true,"ln":428,"content":"-{"},{"type":"del","del":true,"ln":429,"content":"-    // First do a security check."},{"type":"del","del":true,"ln":430,"content":"-    nsresult rv;"},{"type":"del","del":true,"ln":431,"content":"-    nsCOMPtr<nsIScriptSecurityManager> securityManager = "},{"type":"del","del":true,"ln":432,"content":"-        do_GetService(NS_SCRIPTSECURITYMANAGER_CONTRACTID, &rv);"},{"type":"del","del":true,"ln":433,"content":"-    NS_ENSURE_SUCCESS(rv, rv);"},{"type":"del","del":true,"ln":434,"content":"-"},{"type":"del","del":true,"ln":435,"content":"-    rv = securityManager->"},{"type":"del","del":true,"ln":436,"content":"-        CheckLoadURIWithPrincipal(aReferrerPrincipal, aUri,"},{"type":"del","del":true,"ln":437,"content":"-                                  nsIScriptSecurityManager::STANDARD);"},{"type":"del","del":true,"ln":438,"content":"-    NS_ENSURE_SUCCESS(rv, NS_ERROR_XSLT_LOAD_BLOCKED_ERROR);"},{"type":"del","del":true,"ln":439,"content":"-"},{"type":"del","del":true,"ln":440,"content":"-    rv = securityManager->CheckSameOriginURI(aReferrerUri, aUri);"},{"type":"del","del":true,"ln":441,"content":"-    NS_ENSURE_SUCCESS(rv, NS_ERROR_XSLT_LOAD_BLOCKED_ERROR);"},{"type":"del","del":true,"ln":442,"content":"-"},{"type":"del","del":true,"ln":443,"content":"-    // Then do a content policy check."},{"type":"del","del":true,"ln":444,"content":"-    PRInt16 decision = nsIContentPolicy::ACCEPT;"},{"type":"del","del":true,"ln":445,"content":"-    rv = NS_CheckContentLoadPolicy(nsIContentPolicy::TYPE_STYLESHEET,"},{"type":"del","del":true,"ln":446,"content":"-                                   aUri, aReferrerPrincipal, aContext,"},{"type":"del","del":true,"ln":447,"content":"-                                   NS_LITERAL_CSTRING(\"application/xml\"), nsnull,"},{"type":"del","del":true,"ln":448,"content":"-                                   &decision,"},{"type":"del","del":true,"ln":449,"content":"-                                   nsContentUtils::GetContentPolicy(),"},{"type":"del","del":true,"ln":450,"content":"-                                   nsContentUtils::GetSecurityManager());"},{"type":"del","del":true,"ln":451,"content":"-    NS_ENSURE_SUCCESS(rv, rv);"},{"type":"del","del":true,"ln":452,"content":"-"},{"type":"del","del":true,"ln":453,"content":"-    return NS_CP_REJECTED(decision) ? NS_ERROR_XSLT_LOAD_BLOCKED_ERROR : NS_OK;"},{"type":"del","del":true,"ln":454,"content":"-}"},{"type":"del","del":true,"ln":455,"content":"-"},{"type":"normal","normal":true,"ln1":456,"ln2":425,"content":" class txCompileObserver : public txACompileObserver"},{"type":"normal","normal":true,"ln1":457,"ln2":426,"content":" {"},{"type":"normal","normal":true,"ln1":458,"ln2":427,"content":" public:"},{"type":"normal","normal":true,"ln1":459,"ln2":428,"content":"     txCompileObserver(txMozillaXSLTProcessor* aProcessor,"},{"type":"del","del":true,"ln":460,"content":"-                      nsILoadGroup* aLoadGroup,"},{"type":"del","del":true,"ln":461,"content":"-                      nsIPrincipal* aCallerPrincipal);"},{"type":"add","add":true,"ln":429,"content":"+                      nsILoadGroup* aLoadGroup);"},{"type":"normal","normal":true,"ln1":462,"ln2":430,"content":" "},{"type":"normal","normal":true,"ln1":463,"ln2":431,"content":"     TX_DECL_ACOMPILEOBSERVER;"},{"type":"normal","normal":true,"ln1":464,"ln2":432,"content":" "},{"type":"normal","normal":true,"ln1":465,"ln2":433,"content":"     nsresult startLoad(nsIURI* aUri, txStylesheetCompiler* aCompiler,"},{"type":"del","del":true,"ln":466,"content":"-                       nsIURI* aReferrerURI);"},{"type":"add","add":true,"ln":434,"content":"+                       nsIPrincipal* aSourcePrincipal);"},{"type":"normal","normal":true,"ln1":467,"ln2":435,"content":" "},{"type":"normal","normal":true,"ln1":468,"ln2":436,"content":" protected:"},{"type":"normal","normal":true,"ln1":469,"ln2":437,"content":"     nsAutoRefCnt mRefCnt;"}],"oldStart":422,"oldLines":48,"newStart":422,"newLines":16},{"content":"@@ -479,11 +447,9 @@ protected:","changes":[{"type":"normal","normal":true,"ln1":479,"ln2":447,"content":" };"},{"type":"normal","normal":true,"ln1":480,"ln2":448,"content":" "},{"type":"normal","normal":true,"ln1":481,"ln2":449,"content":" txCompileObserver::txCompileObserver(txMozillaXSLTProcessor* aProcessor,"},{"type":"del","del":true,"ln":482,"content":"-                                     nsILoadGroup* aLoadGroup,"},{"type":"del","del":true,"ln":483,"content":"-                                     nsIPrincipal* aCallerPrincipal)"},{"type":"add","add":true,"ln":450,"content":"+                                     nsILoadGroup* aLoadGroup)"},{"type":"normal","normal":true,"ln1":484,"ln2":451,"content":"     : mProcessor(aProcessor),"},{"type":"del","del":true,"ln":485,"content":"-      mLoadGroup(aLoadGroup),"},{"type":"del","del":true,"ln":486,"content":"-      mCallerPrincipal(aCallerPrincipal)"},{"type":"add","add":true,"ln":452,"content":"+      mLoadGroup(aLoadGroup)"},{"type":"normal","normal":true,"ln1":487,"ln2":453,"content":" {"},{"type":"normal","normal":true,"ln1":488,"ln2":454,"content":" }"},{"type":"normal","normal":true,"ln1":489,"ln2":455,"content":" "}],"oldStart":479,"oldLines":11,"newStart":447,"newLines":9},{"content":"@@ -521,11 +487,20 @@ txCompileObserver::loadURI(const nsAString& aUri,","changes":[{"type":"normal","normal":true,"ln1":521,"ln2":487,"content":"     rv = NS_NewURI(getter_AddRefs(referrerUri), aReferrerUri);"},{"type":"normal","normal":true,"ln1":522,"ln2":488,"content":"     NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":523,"ln2":489,"content":" "},{"type":"add","add":true,"ln":490,"content":"+    nsCOMPtr<nsIPrincipal> referrerPrincipal;"},{"type":"add","add":true,"ln":491,"content":"+    rv = nsContentUtils::GetSecurityManager()->"},{"type":"add","add":true,"ln":492,"content":"+      GetCodebasePrincipal(referrerUri, getter_AddRefs(referrerPrincipal));"},{"type":"add","add":true,"ln":493,"content":"+    NS_ENSURE_SUCCESS(rv, rv);"},{"type":"add","add":true,"ln":494,"content":"+"},{"type":"normal","normal":true,"ln1":524,"ln2":495,"content":"     // Do security check."},{"type":"del","del":true,"ln":525,"content":"-    rv = CheckLoadURI(uri, referrerUri, mCallerPrincipal, nsnull);"},{"type":"add","add":true,"ln":496,"content":"+    rv = nsContentUtils::"},{"type":"add","add":true,"ln":497,"content":"+      CheckSecurityBeforeLoad(uri, referrerPrincipal,"},{"type":"add","add":true,"ln":498,"content":"+                              nsIScriptSecurityManager::STANDARD, PR_FALSE,"},{"type":"add","add":true,"ln":499,"content":"+                              nsIContentPolicy::TYPE_STYLESHEET,"},{"type":"add","add":true,"ln":500,"content":"+                              nsnull, NS_LITERAL_CSTRING(\"application/xml\"));"},{"type":"normal","normal":true,"ln1":526,"ln2":501,"content":"     NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":527,"ln2":502,"content":" "},{"type":"del","del":true,"ln":528,"content":"-    return startLoad(uri, aCompiler, referrerUri);"},{"type":"add","add":true,"ln":503,"content":"+    return startLoad(uri, aCompiler, referrerPrincipal);"},{"type":"normal","normal":true,"ln1":529,"ln2":504,"content":" }"},{"type":"normal","normal":true,"ln1":530,"ln2":505,"content":" "},{"type":"normal","normal":true,"ln1":531,"ln2":506,"content":" void"}],"oldStart":521,"oldLines":11,"newStart":487,"newLines":20},{"content":"@@ -544,7 +519,7 @@ txCompileObserver::onDoneCompiling(txStylesheetCompiler* aCompiler,","changes":[{"type":"normal","normal":true,"ln1":544,"ln2":519,"content":" "},{"type":"normal","normal":true,"ln1":545,"ln2":520,"content":" nsresult"},{"type":"normal","normal":true,"ln1":546,"ln2":521,"content":" txCompileObserver::startLoad(nsIURI* aUri, txStylesheetCompiler* aCompiler,"},{"type":"del","del":true,"ln":547,"content":"-                             nsIURI* aReferrerURI)"},{"type":"add","add":true,"ln":522,"content":"+                             nsIPrincipal* aReferrerPrincipal)"},{"type":"normal","normal":true,"ln1":548,"ln2":523,"content":" {"},{"type":"normal","normal":true,"ln1":549,"ln2":524,"content":"     nsCOMPtr<nsIChannel> channel;"},{"type":"normal","normal":true,"ln1":550,"ln2":525,"content":"     nsresult rv = NS_NewChannel(getter_AddRefs(channel), aUri);"}],"oldStart":544,"oldLines":7,"newStart":519,"newLines":7},{"content":"@@ -560,8 +535,10 @@ txCompileObserver::startLoad(nsIURI* aUri, txStylesheetCompiler* aCompiler,","changes":[{"type":"normal","normal":true,"ln1":560,"ln2":535,"content":"                                       NS_LITERAL_CSTRING(\"text/xml,application/xml,application/xhtml+xml,*/*;q=0.1\"),"},{"type":"normal","normal":true,"ln1":561,"ln2":536,"content":"                                       PR_FALSE);"},{"type":"normal","normal":true,"ln1":562,"ln2":537,"content":" "},{"type":"del","del":true,"ln":563,"content":"-        if (aReferrerURI) {"},{"type":"del","del":true,"ln":564,"content":"-            httpChannel->SetReferrer(aReferrerURI);"},{"type":"add","add":true,"ln":538,"content":"+        nsCOMPtr<nsIURI> referrerURI;"},{"type":"add","add":true,"ln":539,"content":"+        aReferrerPrincipal->GetURI(getter_AddRefs(referrerURI));"},{"type":"add","add":true,"ln":540,"content":"+        if (referrerURI) {"},{"type":"add","add":true,"ln":541,"content":"+            httpChannel->SetReferrer(referrerURI);"},{"type":"normal","normal":true,"ln1":565,"ln2":542,"content":"         }"},{"type":"normal","normal":true,"ln1":566,"ln2":543,"content":"     }"},{"type":"normal","normal":true,"ln1":567,"ln2":544,"content":" "}],"oldStart":560,"oldLines":8,"newStart":535,"newLines":10},{"content":"@@ -588,24 +565,24 @@ TX_LoadSheet(nsIURI* aUri, txMozillaXSLTProcessor* aProcessor,","changes":[{"type":"normal","normal":true,"ln1":588,"ln2":565,"content":"     aUri->GetSpec(spec);"},{"type":"normal","normal":true,"ln1":589,"ln2":566,"content":"     PR_LOG(txLog::xslt, PR_LOG_ALWAYS, (\"TX_LoadSheet: %s\\n\", spec.get()));"},{"type":"normal","normal":true,"ln1":590,"ln2":567,"content":" "},{"type":"del","del":true,"ln":591,"content":"-    nsCOMPtr<nsIURI> referrerURI;"},{"type":"del","del":true,"ln":592,"content":"-    aCallerPrincipal->GetURI(getter_AddRefs(referrerURI));"},{"type":"del","del":true,"ln":593,"content":"-    NS_ASSERTION(referrerURI, \"Caller principal must have a URI!\");"},{"type":"del","del":true,"ln":594,"content":"-"},{"type":"normal","normal":true,"ln1":595,"ln2":568,"content":"     // Pass source document as the context"},{"type":"del","del":true,"ln":596,"content":"-    nsresult rv = CheckLoadURI(aUri, referrerURI, aCallerPrincipal,"},{"type":"del","del":true,"ln":597,"content":"-                               aProcessor->GetSourceContentModel());"},{"type":"add","add":true,"ln":569,"content":"+    nsresult rv = nsContentUtils::"},{"type":"add","add":true,"ln":570,"content":"+      CheckSecurityBeforeLoad(aUri, aCallerPrincipal,"},{"type":"add","add":true,"ln":571,"content":"+                              nsIScriptSecurityManager::STANDARD, PR_FALSE,"},{"type":"add","add":true,"ln":572,"content":"+                              nsIContentPolicy::TYPE_STYLESHEET,"},{"type":"add","add":true,"ln":573,"content":"+                              aProcessor->GetSourceContentModel(),"},{"type":"add","add":true,"ln":574,"content":"+                              NS_LITERAL_CSTRING(\"application/xml\"));"},{"type":"normal","normal":true,"ln1":598,"ln2":575,"content":"     NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":599,"ln2":576,"content":" "},{"type":"normal","normal":true,"ln1":600,"ln2":577,"content":"     nsRefPtr<txCompileObserver> observer ="},{"type":"del","del":true,"ln":601,"content":"-        new txCompileObserver(aProcessor, aLoadGroup, aCallerPrincipal);"},{"type":"add","add":true,"ln":578,"content":"+        new txCompileObserver(aProcessor, aLoadGroup);"},{"type":"normal","normal":true,"ln1":602,"ln2":579,"content":"     NS_ENSURE_TRUE(observer, NS_ERROR_OUT_OF_MEMORY);"},{"type":"normal","normal":true,"ln1":603,"ln2":580,"content":" "},{"type":"normal","normal":true,"ln1":604,"ln2":581,"content":"     nsRefPtr<txStylesheetCompiler> compiler ="},{"type":"normal","normal":true,"ln1":605,"ln2":582,"content":"         new txStylesheetCompiler(NS_ConvertUTF8toUTF16(spec), observer);"},{"type":"normal","normal":true,"ln1":606,"ln2":583,"content":"     NS_ENSURE_TRUE(compiler, NS_ERROR_OUT_OF_MEMORY);"},{"type":"normal","normal":true,"ln1":607,"ln2":584,"content":" "},{"type":"del","del":true,"ln":608,"content":"-    return observer->startLoad(aUri, compiler, referrerURI);"},{"type":"add","add":true,"ln":585,"content":"+    return observer->startLoad(aUri, compiler, aCallerPrincipal);"},{"type":"normal","normal":true,"ln1":609,"ln2":586,"content":" }"},{"type":"normal","normal":true,"ln1":610,"ln2":587,"content":" "},{"type":"normal","normal":true,"ln1":611,"ln2":588,"content":" /**"}],"oldStart":588,"oldLines":24,"newStart":565,"newLines":24},{"content":"@@ -613,105 +590,88 @@ TX_LoadSheet(nsIURI* aUri, txMozillaXSLTProcessor* aProcessor,","changes":[{"type":"normal","normal":true,"ln1":613,"ln2":590,"content":"  * Observer needs to do synchronous loads."},{"type":"normal","normal":true,"ln1":614,"ln2":591,"content":"  */"},{"type":"normal","normal":true,"ln1":615,"ln2":592,"content":" static nsresult"},{"type":"del","del":true,"ln":616,"content":"-handleNode(nsIDOMNode* aNode, txStylesheetCompiler* aCompiler)"},{"type":"add","add":true,"ln":593,"content":"+handleNode(nsINode* aNode, txStylesheetCompiler* aCompiler)"},{"type":"normal","normal":true,"ln1":617,"ln2":594,"content":" {"},{"type":"normal","normal":true,"ln1":618,"ln2":595,"content":"     nsresult rv = NS_OK;"},{"type":"del","del":true,"ln":619,"content":"-    PRUint16 nodetype;"},{"type":"del","del":true,"ln":620,"content":"-    aNode->GetNodeType(&nodetype);"},{"type":"del","del":true,"ln":621,"content":"-    switch (nodetype) {"},{"type":"del","del":true,"ln":622,"content":"-        case nsIDOMNode::ELEMENT_NODE:"},{"type":"del","del":true,"ln":623,"content":"-        {"},{"type":"del","del":true,"ln":624,"content":"-            nsCOMPtr<nsIContent> element = do_QueryInterface(aNode);"},{"type":"del","del":true,"ln":625,"content":"-"},{"type":"del","del":true,"ln":626,"content":"-            PRUint32 attsCount = element->GetAttrCount();"},{"type":"del","del":true,"ln":627,"content":"-            nsAutoArrayPtr<txStylesheetAttr> atts;"},{"type":"del","del":true,"ln":628,"content":"-            if (attsCount > 0) {"},{"type":"del","del":true,"ln":629,"content":"-                atts = new txStylesheetAttr[attsCount];"},{"type":"del","del":true,"ln":630,"content":"-                NS_ENSURE_TRUE(atts, NS_ERROR_OUT_OF_MEMORY);"},{"type":"del","del":true,"ln":631,"content":"-"},{"type":"del","del":true,"ln":632,"content":"-                PRUint32 counter;"},{"type":"del","del":true,"ln":633,"content":"-                for (counter = 0; counter < attsCount; ++counter) {"},{"type":"del","del":true,"ln":634,"content":"-                    txStylesheetAttr& att = atts[counter];"},{"type":"del","del":true,"ln":635,"content":"-                    const nsAttrName* name = element->GetAttrNameAt(counter);"},{"type":"del","del":true,"ln":636,"content":"-                    att.mNamespaceID = name->NamespaceID();"},{"type":"del","del":true,"ln":637,"content":"-                    att.mLocalName = name->LocalName();"},{"type":"del","del":true,"ln":638,"content":"-                    att.mPrefix = name->GetPrefix();"},{"type":"del","del":true,"ln":639,"content":"-                    element->GetAttr(att.mNamespaceID, att.mLocalName, att.mValue);"},{"type":"del","del":true,"ln":640,"content":"-                }"},{"type":"del","del":true,"ln":641,"content":"-            }"},{"type":"del","del":true,"ln":642,"content":"-"},{"type":"del","del":true,"ln":643,"content":"-            nsINodeInfo *ni = element->NodeInfo();"},{"type":"del","del":true,"ln":644,"content":"-"},{"type":"del","del":true,"ln":645,"content":"-            rv = aCompiler->startElement(ni->NamespaceID(),"},{"type":"del","del":true,"ln":646,"content":"-                                         ni->NameAtom(),"},{"type":"del","del":true,"ln":647,"content":"-                                         ni->GetPrefixAtom(), atts,"},{"type":"del","del":true,"ln":648,"content":"-                                         attsCount);"},{"type":"del","del":true,"ln":649,"content":"-            NS_ENSURE_SUCCESS(rv, rv);"},{"type":"del","del":true,"ln":650,"content":"-"},{"type":"del","del":true,"ln":651,"content":"-            // explicitly destroy the attrs here since we no longer need it"},{"type":"del","del":true,"ln":652,"content":"-            atts = nsnull;"},{"type":"del","del":true,"ln":653,"content":"-"},{"type":"del","del":true,"ln":654,"content":"-            PRUint32 childCount = element->GetChildCount();"},{"type":"del","del":true,"ln":655,"content":"-            if (childCount > 0) {"},{"type":"del","del":true,"ln":656,"content":"-                PRUint32 counter = 0;"},{"type":"del","del":true,"ln":657,"content":"-                nsIContent *child;"},{"type":"del","del":true,"ln":658,"content":"-                while ((child = element->GetChildAt(counter++))) {"},{"type":"del","del":true,"ln":659,"content":"-                    nsCOMPtr<nsIDOMNode> childNode = do_QueryInterface(child);"},{"type":"del","del":true,"ln":660,"content":"-                    rv = handleNode(childNode, aCompiler);"},{"type":"del","del":true,"ln":661,"content":"-                    NS_ENSURE_SUCCESS(rv, rv);"},{"type":"del","del":true,"ln":662,"content":"-                }"},{"type":"add","add":true,"ln":596,"content":"+    "},{"type":"add","add":true,"ln":597,"content":"+    if (aNode->IsNodeOfType(nsINode::eELEMENT)) {"},{"type":"add","add":true,"ln":598,"content":"+        nsIContent* element = static_cast<nsIContent*>(aNode);"},{"type":"add","add":true,"ln":599,"content":"+"},{"type":"add","add":true,"ln":600,"content":"+        PRUint32 attsCount = element->GetAttrCount();"},{"type":"add","add":true,"ln":601,"content":"+        nsAutoArrayPtr<txStylesheetAttr> atts;"},{"type":"add","add":true,"ln":602,"content":"+        if (attsCount > 0) {"},{"type":"add","add":true,"ln":603,"content":"+            atts = new txStylesheetAttr[attsCount];"},{"type":"add","add":true,"ln":604,"content":"+            NS_ENSURE_TRUE(atts, NS_ERROR_OUT_OF_MEMORY);"},{"type":"add","add":true,"ln":605,"content":"+"},{"type":"add","add":true,"ln":606,"content":"+            PRUint32 counter;"},{"type":"add","add":true,"ln":607,"content":"+            for (counter = 0; counter < attsCount; ++counter) {"},{"type":"add","add":true,"ln":608,"content":"+                txStylesheetAttr& att = atts[counter];"},{"type":"add","add":true,"ln":609,"content":"+                const nsAttrName* name = element->GetAttrNameAt(counter);"},{"type":"add","add":true,"ln":610,"content":"+                att.mNamespaceID = name->NamespaceID();"},{"type":"add","add":true,"ln":611,"content":"+                att.mLocalName = name->LocalName();"},{"type":"add","add":true,"ln":612,"content":"+                att.mPrefix = name->GetPrefix();"},{"type":"add","add":true,"ln":613,"content":"+                element->GetAttr(att.mNamespaceID, att.mLocalName, att.mValue);"},{"type":"normal","normal":true,"ln1":663,"ln2":614,"content":"             }"},{"type":"add","add":true,"ln":615,"content":"+        }"},{"type":"normal","normal":true,"ln1":664,"ln2":616,"content":" "},{"type":"del","del":true,"ln":665,"content":"-            rv = aCompiler->endElement();"},{"type":"del","del":true,"ln":666,"content":"-            NS_ENSURE_SUCCESS(rv, rv);"},{"type":"add","add":true,"ln":617,"content":"+        nsINodeInfo *ni = element->NodeInfo();"},{"type":"normal","normal":true,"ln1":667,"ln2":618,"content":" "},{"type":"del","del":true,"ln":668,"content":"-            break;"},{"type":"del","del":true,"ln":669,"content":"-        }"},{"type":"del","del":true,"ln":670,"content":"-        case nsIDOMNode::CDATA_SECTION_NODE:"},{"type":"del","del":true,"ln":671,"content":"-        case nsIDOMNode::TEXT_NODE:"},{"type":"del","del":true,"ln":672,"content":"-        {"},{"type":"del","del":true,"ln":673,"content":"-            nsAutoString chars;"},{"type":"del","del":true,"ln":674,"content":"-            aNode->GetNodeValue(chars);"},{"type":"del","del":true,"ln":675,"content":"-            rv = aCompiler->characters(chars);"},{"type":"del","del":true,"ln":676,"content":"-            NS_ENSURE_SUCCESS(rv, rv);"},{"type":"add","add":true,"ln":619,"content":"+        rv = aCompiler->startElement(ni->NamespaceID(),"},{"type":"add","add":true,"ln":620,"content":"+                                     ni->NameAtom(),"},{"type":"add","add":true,"ln":621,"content":"+                                     ni->GetPrefixAtom(), atts,"},{"type":"add","add":true,"ln":622,"content":"+                                     attsCount);"},{"type":"add","add":true,"ln":623,"content":"+        NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":677,"ln2":624,"content":" "},{"type":"del","del":true,"ln":678,"content":"-            break;"},{"type":"del","del":true,"ln":679,"content":"-        }"},{"type":"del","del":true,"ln":680,"content":"-        case nsIDOMNode::DOCUMENT_NODE:"},{"type":"del","del":true,"ln":681,"content":"-        {"},{"type":"del","del":true,"ln":682,"content":"-            nsCOMPtr<nsIDocument> document = do_QueryInterface(aNode);"},{"type":"add","add":true,"ln":625,"content":"+        // explicitly destroy the attrs here since we no longer need it"},{"type":"add","add":true,"ln":626,"content":"+        atts = nsnull;"},{"type":"normal","normal":true,"ln1":683,"ln2":627,"content":" "},{"type":"add","add":true,"ln":628,"content":"+        PRUint32 childCount = element->GetChildCount();"},{"type":"add","add":true,"ln":629,"content":"+        if (childCount > 0) {"},{"type":"normal","normal":true,"ln1":684,"ln2":630,"content":"             PRUint32 counter = 0;"},{"type":"normal","normal":true,"ln1":685,"ln2":631,"content":"             nsIContent *child;"},{"type":"del","del":true,"ln":686,"content":"-            while ((child = document->GetChildAt(counter++))) {"},{"type":"del","del":true,"ln":687,"content":"-                nsCOMPtr<nsIDOMNode> childNode = do_QueryInterface(child);"},{"type":"del","del":true,"ln":688,"content":"-                rv = handleNode(childNode, aCompiler);"},{"type":"add","add":true,"ln":632,"content":"+            while ((child = element->GetChildAt(counter++))) {"},{"type":"add","add":true,"ln":633,"content":"+                rv = handleNode(child, aCompiler);"},{"type":"normal","normal":true,"ln1":689,"ln2":634,"content":"                 NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":690,"ln2":635,"content":"             }"},{"type":"del","del":true,"ln":691,"content":"-            break;"},{"type":"add","add":true,"ln":636,"content":"+        }"},{"type":"add","add":true,"ln":637,"content":"+"},{"type":"add","add":true,"ln":638,"content":"+        rv = aCompiler->endElement();"},{"type":"add","add":true,"ln":639,"content":"+        NS_ENSURE_SUCCESS(rv, rv);"},{"type":"add","add":true,"ln":640,"content":"+    }"},{"type":"add","add":true,"ln":641,"content":"+    else if (aNode->IsNodeOfType(nsINode::eTEXT)) {"},{"type":"add","add":true,"ln":642,"content":"+        nsAutoString chars;"},{"type":"add","add":true,"ln":643,"content":"+        static_cast<nsIContent*>(aNode)->AppendTextTo(chars);"},{"type":"add","add":true,"ln":644,"content":"+        rv = aCompiler->characters(chars);"},{"type":"add","add":true,"ln":645,"content":"+        NS_ENSURE_SUCCESS(rv, rv);"},{"type":"add","add":true,"ln":646,"content":"+    }"},{"type":"add","add":true,"ln":647,"content":"+    else if (aNode->IsNodeOfType(nsINode::eDOCUMENT)) {"},{"type":"add","add":true,"ln":648,"content":"+        nsIDocument* document = static_cast<nsIDocument*>(aNode);"},{"type":"add","add":true,"ln":649,"content":"+"},{"type":"add","add":true,"ln":650,"content":"+        PRUint32 counter = 0;"},{"type":"add","add":true,"ln":651,"content":"+        nsIContent *child;"},{"type":"add","add":true,"ln":652,"content":"+        while ((child = document->GetChildAt(counter++))) {"},{"type":"add","add":true,"ln":653,"content":"+            rv = handleNode(child, aCompiler);"},{"type":"add","add":true,"ln":654,"content":"+            NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":692,"ln2":655,"content":"         }"},{"type":"normal","normal":true,"ln1":693,"ln2":656,"content":"     }"},{"type":"add","add":true,"ln":657,"content":"+"},{"type":"normal","normal":true,"ln1":694,"ln2":658,"content":"     return NS_OK;"},{"type":"normal","normal":true,"ln1":695,"ln2":659,"content":" }"},{"type":"normal","normal":true,"ln1":696,"ln2":660,"content":" "},{"type":"normal","normal":true,"ln1":697,"ln2":661,"content":" class txSyncCompileObserver : public txACompileObserver"},{"type":"normal","normal":true,"ln1":698,"ln2":662,"content":" {"},{"type":"normal","normal":true,"ln1":699,"ln2":663,"content":" public:"},{"type":"del","del":true,"ln":700,"content":"-    txSyncCompileObserver(txMozillaXSLTProcessor* aProcessor,"},{"type":"del","del":true,"ln":701,"content":"-                          nsIPrincipal* aCallerPrincipal);"},{"type":"add","add":true,"ln":664,"content":"+    txSyncCompileObserver(txMozillaXSLTProcessor* aProcessor);"},{"type":"normal","normal":true,"ln1":702,"ln2":665,"content":" "},{"type":"normal","normal":true,"ln1":703,"ln2":666,"content":"     TX_DECL_ACOMPILEOBSERVER;"},{"type":"normal","normal":true,"ln1":704,"ln2":667,"content":" "},{"type":"normal","normal":true,"ln1":705,"ln2":668,"content":" protected:"},{"type":"normal","normal":true,"ln1":706,"ln2":669,"content":"     nsRefPtr<txMozillaXSLTProcessor> mProcessor;"},{"type":"del","del":true,"ln":707,"content":"-    nsCOMPtr<nsIPrincipal> mCallerPrincipal;"},{"type":"normal","normal":true,"ln1":708,"ln2":670,"content":"     nsAutoRefCnt mRefCnt;"},{"type":"normal","normal":true,"ln1":709,"ln2":671,"content":" };"},{"type":"normal","normal":true,"ln1":710,"ln2":672,"content":" "},{"type":"del","del":true,"ln":711,"content":"-txSyncCompileObserver::txSyncCompileObserver(txMozillaXSLTProcessor* aProcessor,"},{"type":"del","del":true,"ln":712,"content":"-                                            nsIPrincipal* aCallerPrincipal)"},{"type":"del","del":true,"ln":713,"content":"-  : mProcessor(aProcessor),"},{"type":"del","del":true,"ln":714,"content":"-    mCallerPrincipal(aCallerPrincipal)"},{"type":"add","add":true,"ln":673,"content":"+txSyncCompileObserver::txSyncCompileObserver(txMozillaXSLTProcessor* aProcessor)"},{"type":"add","add":true,"ln":674,"content":"+  : mProcessor(aProcessor)"},{"type":"normal","normal":true,"ln1":715,"ln2":675,"content":" {"},{"type":"normal","normal":true,"ln1":716,"ln2":676,"content":" }"},{"type":"normal","normal":true,"ln1":717,"ln2":677,"content":" "}],"oldStart":613,"oldLines":105,"newStart":590,"newLines":88},{"content":"@@ -749,7 +709,16 @@ txSyncCompileObserver::loadURI(const nsAString& aUri,","changes":[{"type":"normal","normal":true,"ln1":749,"ln2":709,"content":"     rv = NS_NewURI(getter_AddRefs(referrerUri), aReferrerUri);"},{"type":"normal","normal":true,"ln1":750,"ln2":710,"content":"     NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":751,"ln2":711,"content":" "},{"type":"del","del":true,"ln":752,"content":"-    rv = CheckLoadURI(uri, referrerUri, mCallerPrincipal, nsnull);"},{"type":"add","add":true,"ln":712,"content":"+    nsCOMPtr<nsIPrincipal> referrerPrincipal;"},{"type":"add","add":true,"ln":713,"content":"+    rv = nsContentUtils::GetSecurityManager()->"},{"type":"add","add":true,"ln":714,"content":"+      GetCodebasePrincipal(referrerUri, getter_AddRefs(referrerPrincipal));"},{"type":"add","add":true,"ln":715,"content":"+    NS_ENSURE_SUCCESS(rv, rv);"},{"type":"add","add":true,"ln":716,"content":"+"},{"type":"add","add":true,"ln":717,"content":"+    rv = nsContentUtils::"},{"type":"add","add":true,"ln":718,"content":"+      CheckSecurityBeforeLoad(uri, referrerPrincipal,"},{"type":"add","add":true,"ln":719,"content":"+                              nsIScriptSecurityManager::STANDARD,"},{"type":"add","add":true,"ln":720,"content":"+                              PR_FALSE, nsIContentPolicy::TYPE_STYLESHEET,"},{"type":"add","add":true,"ln":721,"content":"+                              nsnull, NS_LITERAL_CSTRING(\"application/xml\"));"},{"type":"normal","normal":true,"ln1":753,"ln2":722,"content":"     NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":754,"ln2":723,"content":" "},{"type":"normal","normal":true,"ln1":755,"ln2":724,"content":"     // This is probably called by js, a loadGroup for the channel doesn't"}],"oldStart":749,"oldLines":7,"newStart":709,"newLines":16},{"content":"@@ -758,7 +727,9 @@ txSyncCompileObserver::loadURI(const nsAString& aUri,","changes":[{"type":"normal","normal":true,"ln1":758,"ln2":727,"content":"     rv = nsSyncLoadService::LoadDocument(uri, referrerUri, nsnull, PR_FALSE,"},{"type":"normal","normal":true,"ln1":759,"ln2":728,"content":"                                          getter_AddRefs(document));"},{"type":"normal","normal":true,"ln1":760,"ln2":729,"content":"     NS_ENSURE_SUCCESS(rv, rv);"},{"type":"del","del":true,"ln":761,"content":"-    rv = handleNode(document, aCompiler);"},{"type":"add","add":true,"ln":730,"content":"+"},{"type":"add","add":true,"ln":731,"content":"+    nsCOMPtr<nsIDocument> doc = do_QueryInterface(document);"},{"type":"add","add":true,"ln":732,"content":"+    rv = handleNode(doc, aCompiler);"},{"type":"normal","normal":true,"ln1":762,"ln2":733,"content":"     if (NS_FAILED(rv)) {"},{"type":"normal","normal":true,"ln1":763,"ln2":734,"content":"         nsCAutoString spec;"},{"type":"normal","normal":true,"ln1":764,"ln2":735,"content":"         uri->GetSpec(spec);"}],"oldStart":758,"oldLines":7,"newStart":727,"newLines":9},{"content":"@@ -778,27 +749,22 @@ void txSyncCompileObserver::onDoneCompiling(txStylesheetCompiler* aCompiler,","changes":[{"type":"normal","normal":true,"ln1":778,"ln2":749,"content":" }"},{"type":"normal","normal":true,"ln1":779,"ln2":750,"content":" "},{"type":"normal","normal":true,"ln1":780,"ln2":751,"content":" nsresult"},{"type":"del","del":true,"ln":781,"content":"-TX_CompileStylesheet(nsIDOMNode* aNode, txMozillaXSLTProcessor* aProcessor,"},{"type":"add","add":true,"ln":752,"content":"+TX_CompileStylesheet(nsINode* aNode, txMozillaXSLTProcessor* aProcessor,"},{"type":"normal","normal":true,"ln1":782,"ln2":753,"content":"                      nsIPrincipal* aCallerPrincipal,"},{"type":"normal","normal":true,"ln1":783,"ln2":754,"content":"                      txStylesheet** aStylesheet)"},{"type":"normal","normal":true,"ln1":784,"ln2":755,"content":" {"},{"type":"normal","normal":true,"ln1":785,"ln2":756,"content":"     // If we move GetBaseURI to nsINode this can be simplified."},{"type":"del","del":true,"ln":786,"content":"-    nsCOMPtr<nsIURI> uri;"},{"type":"del","del":true,"ln":787,"content":"-    nsCOMPtr<nsIDocument> doc;"},{"type":"del","del":true,"ln":788,"content":"-    nsCOMPtr<nsIContent> cont = do_QueryInterface(aNode);"},{"type":"del","del":true,"ln":789,"content":"-    if (cont) {"},{"type":"del","del":true,"ln":790,"content":"-        doc = cont->GetOwnerDoc();"},{"type":"del","del":true,"ln":791,"content":"-        NS_ENSURE_TRUE(doc, NS_ERROR_FAILURE);"},{"type":"add","add":true,"ln":757,"content":"+    nsCOMPtr<nsIDocument> doc = aNode->GetOwnerDoc();"},{"type":"add","add":true,"ln":758,"content":"+    NS_ENSURE_TRUE(doc, NS_ERROR_FAILURE);"},{"type":"normal","normal":true,"ln1":792,"ln2":759,"content":" "},{"type":"del","del":true,"ln":793,"content":"-        uri = cont->GetBaseURI();"},{"type":"add","add":true,"ln":760,"content":"+    nsCOMPtr<nsIURI> uri;"},{"type":"add","add":true,"ln":761,"content":"+    if (aNode->IsNodeOfType(nsINode::eCONTENT)) {"},{"type":"add","add":true,"ln":762,"content":"+      uri = static_cast<nsIContent*>(aNode)->GetBaseURI();"},{"type":"normal","normal":true,"ln1":794,"ln2":763,"content":"     }"},{"type":"del","del":true,"ln":795,"content":"-    else {"},{"type":"del","del":true,"ln":796,"content":"-        doc = do_QueryInterface(aNode);"},{"type":"del","del":true,"ln":797,"content":"-        NS_ASSERTION(doc, \"aNode should be a doc or an element by now\");"},{"type":"del","del":true,"ln":798,"content":"-"},{"type":"del","del":true,"ln":799,"content":"-        uri = doc->GetBaseURI();"},{"type":"add","add":true,"ln":764,"content":"+    else { "},{"type":"add","add":true,"ln":765,"content":"+      NS_ASSERTION(aNode->IsNodeOfType(nsINode::eDOCUMENT), \"not a doc\");"},{"type":"add","add":true,"ln":766,"content":"+      uri = static_cast<nsIDocument*>(aNode)->GetBaseURI();"},{"type":"normal","normal":true,"ln1":800,"ln2":767,"content":"     }"},{"type":"del","del":true,"ln":801,"content":"-"},{"type":"normal","normal":true,"ln1":802,"ln2":768,"content":"     NS_ENSURE_TRUE(uri, NS_ERROR_FAILURE);"},{"type":"normal","normal":true,"ln1":803,"ln2":769,"content":"     "},{"type":"normal","normal":true,"ln1":804,"ln2":770,"content":"     nsCAutoString spec;"}],"oldStart":778,"oldLines":27,"newStart":749,"newLines":22},{"content":"@@ -812,7 +778,7 @@ TX_CompileStylesheet(nsIDOMNode* aNode, txMozillaXSLTProcessor* aProcessor,","changes":[{"type":"normal","normal":true,"ln1":812,"ln2":778,"content":"     NS_ConvertUTF8toUTF16 stylesheetURI(spec);"},{"type":"normal","normal":true,"ln1":813,"ln2":779,"content":" "},{"type":"normal","normal":true,"ln1":814,"ln2":780,"content":"     nsRefPtr<txSyncCompileObserver> obs ="},{"type":"del","del":true,"ln":815,"content":"-        new txSyncCompileObserver(aProcessor, aCallerPrincipal);"},{"type":"add","add":true,"ln":781,"content":"+        new txSyncCompileObserver(aProcessor);"},{"type":"normal","normal":true,"ln1":816,"ln2":782,"content":"     NS_ENSURE_TRUE(obs, NS_ERROR_OUT_OF_MEMORY);"},{"type":"normal","normal":true,"ln1":817,"ln2":783,"content":" "},{"type":"normal","normal":true,"ln1":818,"ln2":784,"content":"     nsRefPtr<txStylesheetCompiler> compiler ="}],"oldStart":812,"oldLines":7,"newStart":778,"newLines":7}],"deletions":140,"additions":106,"from":"content/xslt/src/xslt/txMozillaStylesheetCompiler.cpp","to":"content/xslt/src/xslt/txMozillaStylesheetCompiler.cpp","index":["0d83c96..cfb71cc","100644"]},{"chunks":[{"content":"@@ -338,7 +338,8 @@ txMozillaXSLTProcessor::TransformDocument(nsIDOMNode* aSourceDOM,","changes":[{"type":"normal","normal":true,"ln1":338,"ln2":338,"content":"                    type == nsIDOMNode::DOCUMENT_NODE,"},{"type":"normal","normal":true,"ln1":339,"ln2":339,"content":"                    NS_ERROR_INVALID_ARG);"},{"type":"normal","normal":true,"ln1":340,"ln2":340,"content":" "},{"type":"del","del":true,"ln":341,"content":"-    nsresult rv = TX_CompileStylesheet(aStyleDOM, this, mPrincipal,"},{"type":"add","add":true,"ln":341,"content":"+    nsCOMPtr<nsINode> styleNode = do_QueryInterface(aStyleDOM);"},{"type":"add","add":true,"ln":342,"content":"+    nsresult rv = TX_CompileStylesheet(styleNode, this, mPrincipal,"},{"type":"normal","normal":true,"ln1":342,"ln2":343,"content":"                                        getter_AddRefs(mStylesheet));"},{"type":"normal","normal":true,"ln1":343,"ln2":344,"content":"     NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":344,"ln2":345,"content":" "}],"oldStart":338,"oldLines":7,"newStart":338,"newLines":8},{"content":"@@ -586,29 +587,25 @@ txMozillaXSLTProcessor::ImportStylesheet(nsIDOMNode *aStyle)","changes":[{"type":"normal","normal":true,"ln1":586,"ln2":587,"content":"         return NS_ERROR_DOM_SECURITY_ERR;"},{"type":"normal","normal":true,"ln1":587,"ln2":588,"content":"     }"},{"type":"normal","normal":true,"ln1":588,"ln2":589,"content":"     "},{"type":"del","del":true,"ln":589,"content":"-    PRUint16 type = 0;"},{"type":"del","del":true,"ln":590,"content":"-    aStyle->GetNodeType(&type);"},{"type":"del","del":true,"ln":591,"content":"-    NS_ENSURE_TRUE(type == nsIDOMNode::ELEMENT_NODE ||"},{"type":"del","del":true,"ln":592,"content":"-                   type == nsIDOMNode::DOCUMENT_NODE,"},{"type":"add","add":true,"ln":590,"content":"+    nsCOMPtr<nsINode> styleNode = do_QueryInterface(aStyle);"},{"type":"add","add":true,"ln":591,"content":"+    NS_ENSURE_TRUE(styleNode &&"},{"type":"add","add":true,"ln":592,"content":"+                   (styleNode->IsNodeOfType(nsINode::eELEMENT) ||"},{"type":"add","add":true,"ln":593,"content":"+                    styleNode->IsNodeOfType(nsINode::eDOCUMENT)),"},{"type":"normal","normal":true,"ln1":593,"ln2":594,"content":"                    NS_ERROR_INVALID_ARG);"},{"type":"normal","normal":true,"ln1":594,"ln2":595,"content":" "},{"type":"del","del":true,"ln":595,"content":"-    nsresult rv = TX_CompileStylesheet(aStyle, this, mPrincipal,"},{"type":"add","add":true,"ln":596,"content":"+    nsresult rv = TX_CompileStylesheet(styleNode, this, mPrincipal,"},{"type":"normal","normal":true,"ln1":596,"ln2":597,"content":"                                        getter_AddRefs(mStylesheet));"},{"type":"normal","normal":true,"ln1":597,"ln2":598,"content":"     // XXX set up exception context, bug 204658"},{"type":"normal","normal":true,"ln1":598,"ln2":599,"content":"     NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":599,"ln2":600,"content":" "},{"type":"del","del":true,"ln":600,"content":"-    if (type == nsIDOMNode::ELEMENT_NODE) {"},{"type":"del","del":true,"ln":601,"content":"-        nsCOMPtr<nsIDOMDocument> domDoc;"},{"type":"del","del":true,"ln":602,"content":"-        aStyle->GetOwnerDocument(getter_AddRefs(domDoc));"},{"type":"del","del":true,"ln":603,"content":"-        NS_ENSURE_TRUE(domDoc, NS_ERROR_UNEXPECTED);"},{"type":"add","add":true,"ln":601,"content":"+    if (styleNode->IsNodeOfType(nsINode::eELEMENT)) {"},{"type":"add","add":true,"ln":602,"content":"+        mStylesheetDocument = styleNode->GetOwnerDoc();"},{"type":"add","add":true,"ln":603,"content":"+        NS_ENSURE_TRUE(mStylesheetDocument, NS_ERROR_UNEXPECTED);"},{"type":"normal","normal":true,"ln1":604,"ln2":604,"content":" "},{"type":"del","del":true,"ln":605,"content":"-        nsCOMPtr<nsIDocument> styleDoc = do_QueryInterface(domDoc);"},{"type":"del","del":true,"ln":606,"content":"-        mStylesheetDocument = styleDoc;"},{"type":"del","del":true,"ln":607,"content":"-        mEmbeddedStylesheetRoot = do_QueryInterface(aStyle);"},{"type":"add","add":true,"ln":605,"content":"+        mEmbeddedStylesheetRoot = static_cast<nsIContent*>(styleNode.get());"},{"type":"normal","normal":true,"ln1":608,"ln2":606,"content":"     }"},{"type":"normal","normal":true,"ln1":609,"ln2":607,"content":"     else {"},{"type":"del","del":true,"ln":610,"content":"-        nsCOMPtr<nsIDocument> styleDoc = do_QueryInterface(aStyle);"},{"type":"del","del":true,"ln":611,"content":"-        mStylesheetDocument = styleDoc;"},{"type":"add","add":true,"ln":608,"content":"+        mStylesheetDocument = static_cast<nsIDocument*>(styleNode.get());"},{"type":"normal","normal":true,"ln1":612,"ln2":609,"content":"     }"},{"type":"normal","normal":true,"ln1":613,"ln2":610,"content":" "},{"type":"normal","normal":true,"ln1":614,"ln2":611,"content":"     mStylesheetDocument->AddMutationObserver(this);"}],"oldStart":586,"oldLines":29,"newStart":587,"newLines":25},{"content":"@@ -1173,10 +1170,11 @@ txMozillaXSLTProcessor::ensureStylesheet()","changes":[{"type":"normal","normal":true,"ln1":1173,"ln2":1170,"content":" "},{"type":"normal","normal":true,"ln1":1174,"ln2":1171,"content":"     NS_ENSURE_TRUE(mStylesheetDocument, NS_ERROR_NOT_INITIALIZED);"},{"type":"normal","normal":true,"ln1":1175,"ln2":1172,"content":" "},{"type":"del","del":true,"ln":1176,"content":"-    nsCOMPtr<nsIDOMNode> style = do_QueryInterface(mEmbeddedStylesheetRoot);"},{"type":"add","add":true,"ln":1173,"content":"+    nsINode* style = mEmbeddedStylesheetRoot;"},{"type":"normal","normal":true,"ln1":1177,"ln2":1174,"content":"     if (!style) {"},{"type":"del","del":true,"ln":1178,"content":"-        style = do_QueryInterface(mStylesheetDocument);"},{"type":"add","add":true,"ln":1175,"content":"+        style = mStylesheetDocument;"},{"type":"normal","normal":true,"ln1":1179,"ln2":1176,"content":"     }"},{"type":"add","add":true,"ln":1177,"content":"+"},{"type":"normal","normal":true,"ln1":1180,"ln2":1178,"content":"     return TX_CompileStylesheet(style, this, mPrincipal,"},{"type":"normal","normal":true,"ln1":1181,"ln2":1179,"content":"                                 getter_AddRefs(mStylesheet));"},{"type":"normal","normal":true,"ln1":1182,"ln2":1180,"content":" }"}],"oldStart":1173,"oldLines":10,"newStart":1170,"newLines":11}],"deletions":17,"additions":15,"from":"content/xslt/src/xslt/txMozillaXSLTProcessor.cpp","to":"content/xslt/src/xslt/txMozillaXSLTProcessor.cpp","index":["47e53a9..5c59d63","100644"]},{"chunks":[{"content":"@@ -171,7 +171,7 @@ extern nsresult TX_LoadSheet(nsIURI* aUri, txMozillaXSLTProcessor* aProcessor,","changes":[{"type":"normal","normal":true,"ln1":171,"ln2":171,"content":"                              nsILoadGroup* aLoadGroup,"},{"type":"normal","normal":true,"ln1":172,"ln2":172,"content":"                              nsIPrincipal* aCallerPrincipal);"},{"type":"normal","normal":true,"ln1":173,"ln2":173,"content":" "},{"type":"del","del":true,"ln":174,"content":"-extern nsresult TX_CompileStylesheet(nsIDOMNode* aNode,"},{"type":"add","add":true,"ln":174,"content":"+extern nsresult TX_CompileStylesheet(nsINode* aNode,"},{"type":"normal","normal":true,"ln1":175,"ln2":175,"content":"                                      txMozillaXSLTProcessor* aProcessor,"},{"type":"normal","normal":true,"ln1":176,"ln2":176,"content":"                                      nsIPrincipal* aCallerPrincipal,"},{"type":"normal","normal":true,"ln1":177,"ln2":177,"content":"                                      txStylesheet** aStylesheet);"}],"oldStart":171,"oldLines":7,"newStart":171,"newLines":7}],"deletions":1,"additions":1,"from":"content/xslt/src/xslt/txMozillaXSLTProcessor.h","to":"content/xslt/src/xslt/txMozillaXSLTProcessor.h","index":["8b4bd60..7dbd225","100644"]}]}