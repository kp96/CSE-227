{"bug_id":223159,"commitHash":"80abdd0","commit_info":{"sha":"80abdd06f37e61ff79558f6b06a9f88e653c5ce7","commit":{"author":{"name":"timeless%mozdev.org","email":"timeless%mozdev.org","date":"2004-08-18T22:15:11Z"},"committer":{"name":"timeless%mozdev.org","email":"timeless%mozdev.org","date":"2004-08-18T22:15:11Z"},"message":"Bug 223159 Script with UniversalBrowserWrite privilige still unable to window.close() a non-JS-created window\nr=caillon sr=jst","tree":{"sha":"62eecde593795fffe599bcca3d080d6e789aab2a","url":"https://api.github.com/repos/mozilla/gecko-dev/git/trees/62eecde593795fffe599bcca3d080d6e789aab2a"},"url":"https://api.github.com/repos/mozilla/gecko-dev/git/commits/80abdd06f37e61ff79558f6b06a9f88e653c5ce7","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/mozilla/gecko-dev/commits/80abdd06f37e61ff79558f6b06a9f88e653c5ce7","html_url":"https://github.com/mozilla/gecko-dev/commit/80abdd06f37e61ff79558f6b06a9f88e653c5ce7","comments_url":"https://api.github.com/repos/mozilla/gecko-dev/commits/80abdd06f37e61ff79558f6b06a9f88e653c5ce7/comments","author":null,"committer":null,"parents":[{"sha":"c5771baf3eb4211632187e5830e07be1b96ca8ed","url":"https://api.github.com/repos/mozilla/gecko-dev/commits/c5771baf3eb4211632187e5830e07be1b96ca8ed","html_url":"https://github.com/mozilla/gecko-dev/commit/c5771baf3eb4211632187e5830e07be1b96ca8ed"}],"stats":{"total":19,"additions":12,"deletions":7},"files":[{"sha":"4590fc73a61380ebac14c4158885ec5161b163dd","filename":"dom/src/base/nsGlobalWindow.cpp","status":"modified","additions":12,"deletions":7,"changes":19,"blob_url":"https://github.com/mozilla/gecko-dev/blob/80abdd06f37e61ff79558f6b06a9f88e653c5ce7/dom/src/base/nsGlobalWindow.cpp","raw_url":"https://github.com/mozilla/gecko-dev/raw/80abdd06f37e61ff79558f6b06a9f88e653c5ce7/dom/src/base/nsGlobalWindow.cpp","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/dom/src/base/nsGlobalWindow.cpp?ref=80abdd06f37e61ff79558f6b06a9f88e653c5ce7","patch":"@@ -1411,9 +1411,9 @@ GlobalWindowImpl::GetOpener(nsIDOMWindowInternal** aOpener)\n   // First, check if we were called from a privileged chrome script\n \n   NS_ENSURE_TRUE(sSecMan, NS_ERROR_FAILURE);\n-  PRBool inChrome;\n-  nsresult rv = sSecMan->SubjectPrincipalIsSystem(&inChrome);\n-  if (NS_SUCCEEDED(rv) && inChrome) {\n+  PRBool allowClose;\n+  nsresult rv = sSecMan->SubjectPrincipalIsSystem(&allowClose);\n+  if (NS_SUCCEEDED(rv) && allowClose) {\n     *aOpener = mOpener;\n     NS_IF_ADDREF(*aOpener);\n     return NS_OK;\n@@ -3480,10 +3480,15 @@ GlobalWindowImpl::Close()\n     nsCOMPtr<nsIScriptSecurityManager> secMan(\n       do_GetService(NS_SCRIPTSECURITYMANAGER_CONTRACTID, &rv));\n     if (NS_SUCCEEDED(rv)) {\n-      PRBool inChrome = PR_TRUE;\n-      rv = secMan->SubjectPrincipalIsSystem(&inChrome);\n-      if (NS_SUCCEEDED(rv) && !inChrome) {\n-        PRBool allowClose =\n+      PRBool allowClose = PR_TRUE;\n+      rv = secMan->SubjectPrincipalIsSystem(&allowClose);\n+\n+      if (!allowClose)\n+        rv = sSecMan->IsCapabilityEnabled(\"UniversalBrowserWrite\",\n+                                          &allowClose);\n+\n+      if (NS_SUCCEEDED(rv) && !allowClose) {\n+        allowClose =\n           nsContentUtils::GetBoolPref(\"dom.allow_scripts_to_close_windows\",\n                                       PR_TRUE);\n         if (!allowClose) {"}]},"blames":["18c8067f","f27fd6f6","b37c501c"]}