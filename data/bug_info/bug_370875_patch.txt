Index: security/manager/ssl/src/nsNSSIOLayer.cpp
===================================================================
RCS file: /cvsroot/mozilla/security/manager/ssl/src/nsNSSIOLayer.cpp,v
retrieving revision 1.128
diff -u -r1.128 nsNSSIOLayer.cpp
--- security/manager/ssl/src/nsNSSIOLayer.cpp	7 Mar 2007 19:54:54 -0000	1.128
+++ security/manager/ssl/src/nsNSSIOLayer.cpp	15 May 2007 16:42:31 -0000
@@ -73,6 +73,7 @@
 #include "nsThreadUtils.h"
 #include "nsIDocShell.h"
 #include "nsISecureBrowserUI.h"
+#include "nsProxyRelease.h"
 
 #include "ssl.h"
 #include "secerr.h"
@@ -332,10 +333,18 @@
   nsCOMPtr<nsIDocShell> docshell(do_GetInterface(mCallbacks));
   if (docshell)
   {
-    nsCOMPtr<nsISecureBrowserUI> secureUI;
-    docshell->GetSecurityUI(getter_AddRefs(secureUI));
+    nsCOMPtr<nsIDocShell> proxiedDocShell;
+    NS_GetProxyForObject(NS_PROXY_TO_MAIN_THREAD,
+                         NS_GET_IID(nsIDocShell),
+                         docshell.get(),
+                         NS_PROXY_SYNC,
+                         getter_AddRefs(proxiedDocShell));
+    nsISecureBrowserUI* secureUI;
+    proxiedDocShell->GetSecurityUI(&secureUI);
     if (secureUI)
     {
+      nsCOMPtr<nsIThread> mainThread(do_GetMainThread());
+      NS_ProxyRelease(mainThread, secureUI, PR_FALSE);
       mExternalErrorReporting = PR_TRUE;
     }
   }
