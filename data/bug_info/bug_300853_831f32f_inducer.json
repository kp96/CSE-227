{"bug_id":300853,"commitHash":"831f32f","commit_info":{"sha":"831f32feaa7e5366eebfd1cca914ccceb6e8a083","commit":{"author":{"name":"timeless%mozdev.org","email":"timeless%mozdev.org","date":"2005-07-19T21:55:36Z"},"committer":{"name":"timeless%mozdev.org","email":"timeless%mozdev.org","date":"2005-07-19T21:55:36Z"},"message":"Bug 300853 Caps crash on cleanup [@ DomainPolicy::Drop]\npatch by g.maone@informaction.com r=caillon sr=dveditz a=bsmedberg","tree":{"sha":"991a1e13769c7c1031a11715b896df90a7f340c2","url":"https://api.github.com/repos/mozilla/gecko-dev/git/trees/991a1e13769c7c1031a11715b896df90a7f340c2"},"url":"https://api.github.com/repos/mozilla/gecko-dev/git/commits/831f32feaa7e5366eebfd1cca914ccceb6e8a083","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/mozilla/gecko-dev/commits/831f32feaa7e5366eebfd1cca914ccceb6e8a083","html_url":"https://github.com/mozilla/gecko-dev/commit/831f32feaa7e5366eebfd1cca914ccceb6e8a083","comments_url":"https://api.github.com/repos/mozilla/gecko-dev/commits/831f32feaa7e5366eebfd1cca914ccceb6e8a083/comments","author":null,"committer":null,"parents":[{"sha":"60bf29aac8165c3e5cffb1d23d4247811f95f34c","url":"https://api.github.com/repos/mozilla/gecko-dev/commits/60bf29aac8165c3e5cffb1d23d4247811f95f34c","html_url":"https://github.com/mozilla/gecko-dev/commit/60bf29aac8165c3e5cffb1d23d4247811f95f34c"}],"stats":{"total":15,"additions":12,"deletions":3},"files":[{"sha":"dafce92b782072d52333e4d2550728165063a079","filename":"caps/include/nsPrincipal.h","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/mozilla/gecko-dev/blob/831f32feaa7e5366eebfd1cca914ccceb6e8a083/caps/include/nsPrincipal.h","raw_url":"https://github.com/mozilla/gecko-dev/raw/831f32feaa7e5366eebfd1cca914ccceb6e8a083/caps/include/nsPrincipal.h","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/caps/include/nsPrincipal.h?ref=831f32feaa7e5366eebfd1cca914ccceb6e8a083","patch":"@@ -21,6 +21,7 @@\n  *\n  * Contributor(s):\n  *   Christopher A. Aillon <christopher@aillon.com>\n+ *   Giorgio Maone <g.maone@informaction.com>\n  *\n  * Alternatively, the contents of this file may be used under the terms of\n  * either the GNU General Public License Version 2 or later (the \"GPL\"), or"},{"sha":"b32503df2b00941536161ff1581c96a98e8ff3a2","filename":"caps/include/nsScriptSecurityManager.h","status":"modified","additions":4,"deletions":1,"changes":5,"blob_url":"https://github.com/mozilla/gecko-dev/blob/831f32feaa7e5366eebfd1cca914ccceb6e8a083/caps/include/nsScriptSecurityManager.h","raw_url":"https://github.com/mozilla/gecko-dev/raw/831f32feaa7e5366eebfd1cca914ccceb6e8a083/caps/include/nsScriptSecurityManager.h","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/caps/include/nsScriptSecurityManager.h?ref=831f32feaa7e5366eebfd1cca914ccceb6e8a083","patch":"@@ -23,6 +23,7 @@\n  *   Norris Boyd  <nboyd@atg.com>\n  *   Mitch Stoltz <mstoltz@netscape.com>\n  *   Christopher A. Aillon <christopher@aillon.com>\n+ *   Giorgio Maone <g.maone@informaction.com>\n  *\n  * Alternatively, the contents of this file may be used under the terms of\n  * either of the GNU General Public License Version 2 or later (the \"GPL\"),\n@@ -79,6 +80,7 @@ struct ClassPolicy;\n #define DEBUG_CAPS_CanCreateWrapper\n #define DEBUG_CAPS_CanCreateInstance\n #define DEBUG_CAPS_CanGetService\n+#define DEBUG_CAPS_DomainPolicyLifeCycle\n #endif\n \n /////////////////////\n@@ -290,8 +292,9 @@ class DomainPolicy : public PLDHashTable\n     ~DomainPolicy()\n     {\n         PL_DHashTableFinish(this);\n-\n+        NS_ASSERTION(mRefCount == 0, \"Wrong refcount in DomainPolicy dtor\");\n #ifdef DEBUG_CAPS_DomainPolicyLifeCycle\n+        printf(\"DomainPolicy deleted with mRefCount = %d\\n\", mRefCount);\n         --sObjects;\n         _printPopulationInfo();\n #endif"},{"sha":"063982f805c39d55fdcc3b88bd22d9d8bc7da023","filename":"caps/src/nsPrincipal.cpp","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/mozilla/gecko-dev/blob/831f32feaa7e5366eebfd1cca914ccceb6e8a083/caps/src/nsPrincipal.cpp","raw_url":"https://github.com/mozilla/gecko-dev/raw/831f32feaa7e5366eebfd1cca914ccceb6e8a083/caps/src/nsPrincipal.cpp","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/caps/src/nsPrincipal.cpp?ref=831f32feaa7e5366eebfd1cca914ccceb6e8a083","patch":"@@ -21,6 +21,7 @@\n  *\n  * Contributor(s):\n  *   Christopher A. Aillon <christopher@aillon.com>\n+ *   Giorgio Maone <g.maone@informaction.com>\n  *\n  * Alternatively, the contents of this file may be used under the terms of\n  * either the GNU General Public License Version 2 or later (the \"GPL\"), or"},{"sha":"e694cb759154954fd1efe4c2b9bed96a182d611f","filename":"caps/src/nsScriptSecurityManager.cpp","status":"modified","additions":6,"deletions":2,"changes":8,"blob_url":"https://github.com/mozilla/gecko-dev/blob/831f32feaa7e5366eebfd1cca914ccceb6e8a083/caps/src/nsScriptSecurityManager.cpp","raw_url":"https://github.com/mozilla/gecko-dev/raw/831f32feaa7e5366eebfd1cca914ccceb6e8a083/caps/src/nsScriptSecurityManager.cpp","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/caps/src/nsScriptSecurityManager.cpp?ref=831f32feaa7e5366eebfd1cca914ccceb6e8a083","patch":"@@ -24,6 +24,7 @@\n  *   Mitch Stoltz\n  *   Steve Morse\n  *   Christopher A. Aillon\n+ *   Giorgio Maone\n  *\n  * Alternatively, the contents of this file may be used under the terms of\n  * either of the GNU General Public License Version 2 or later (the \"GPL\"),\n@@ -2891,7 +2892,8 @@ jsval nsScriptSecurityManager::sEnabledID   = JSVAL_VOID;\n nsScriptSecurityManager::~nsScriptSecurityManager(void)\n {\n     delete mOriginToPolicyMap;\n-    delete mDefaultPolicy;\n+    if(mDefaultPolicy)\n+        mDefaultPolicy->Drop();\n     delete mCapabilities;\n     gScriptSecMan = nsnull;\n }\n@@ -2980,8 +2982,10 @@ nsScriptSecurityManager::InitPolicies()\n     DomainPolicy::InvalidateAll();\n     \n     //-- Release old default policy\n-    if(mDefaultPolicy)\n+    if(mDefaultPolicy) {\n         mDefaultPolicy->Drop();\n+        mDefaultPolicy = nsnull;\n+    }\n     \n     //-- Initialize a new mOriginToPolicyMap\n     mOriginToPolicyMap ="}]},"blames":["91b7c60b","9d2ee492","11248436","66caced6","4756b716","e5d4028f","2ad41d5c","91b7c60b","9d2ee492","11248436","4756b716","f7460d02","1c574be0","2ad41d5c"]}