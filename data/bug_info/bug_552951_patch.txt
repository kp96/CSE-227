# HG changeset patch
# Parent 1a872d13ac2c096497f011b34e6f52d9e66a1675
# User timeless@mozdev.org
Bug 552951 nsKeygenFormProcessor::GetPublicKey doesn't use pqgParams/arena created by decode_pqg_params
r=kaie

diff --git a/security/manager/ssl/src/nsKeygenHandler.cpp b/security/manager/ssl/src/nsKeygenHandler.cpp
--- a/security/manager/ssl/src/nsKeygenHandler.cpp
+++ b/security/manager/ssl/src/nsKeygenHandler.cpp
@@ -513,7 +513,6 @@ nsKeygenFormProcessor::GetPublicKey(nsAS
     KeyType type;
     PRUint32 keyGenMechanism;
     PRInt32 primeBits;
-    PQGParams *pqgParams;
     PK11SlotInfo *slot = nsnull;
     PK11RSAGenParams rsaParams;
     SECOidTag algTag;
@@ -577,7 +576,7 @@ nsKeygenFormProcessor::GetPublicKey(nsAS
         } while (end != nsnull);
         goto loser;
 found_match:
-        pqgParams = decode_pqg_params(str);
+        (void)0;
     } else if (aKeyType.LowerCaseEqualsLiteral("ec")) {
         keyparamsString = ToNewCString(aKeyParams);
         if (!keyparamsString) {
@@ -597,7 +596,7 @@ found_match:
     if (NS_FAILED(rv)) {
         goto loser;
     }
-      switch (keyGenMechanism) {
+    switch (keyGenMechanism) {
         case CKM_RSA_PKCS_KEY_PAIR_GEN:
             rsaParams.keySizeInBits = keysize;
             rsaParams.pe = DEFAULT_RSA_KEYGEN_PE;
@@ -656,7 +655,7 @@ found_match:
     /* Make sure token is initialized. */
     rv = setPassword(slot, m_ctx);
     if (NS_FAILED(rv))
-    goto loser;
+        goto loser;
 
     sec_rv = PK11_Authenticate(slot, PR_TRUE, m_ctx);
     if (sec_rv != SECSuccess) {
@@ -669,9 +668,7 @@ found_match:
 
     if (NS_SUCCEEDED(rv)) {
         KeygenRunnable = new nsKeygenThread();
-        if (KeygenRunnable) {
-            NS_ADDREF(KeygenRunnable);
-        }
+        NS_IF_ADDREF(KeygenRunnable);
     }
 
     if (NS_FAILED(rv) || !KeygenRunnable) {
@@ -774,7 +771,7 @@ loser:
         }
     }
     if ( spkInfo ) {
-      SECKEY_DestroySubjectPublicKeyInfo(spkInfo);
+        SECKEY_DestroySubjectPublicKeyInfo(spkInfo);
     }
     if ( publicKey ) {
         SECKEY_DestroyPublicKey(publicKey);
@@ -783,13 +780,13 @@ loser:
         SECKEY_DestroyPrivateKey(privateKey);
     }
     if ( arena ) {
-      PORT_FreeArena(arena, PR_TRUE);
+        PORT_FreeArena(arena, PR_TRUE);
     }
     if (slot != nsnull) {
         PK11_FreeSlot(slot);
     }
     if (KeygenRunnable) {
-      NS_RELEASE(KeygenRunnable);
+        NS_RELEASE(KeygenRunnable);
     }
     if (keyparamsString) {
         nsMemory::Free(keyparamsString);
