{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basef804e9\""},"diff":[{"chunks":[{"content":"@@ -213,7 +213,6 @@ Gdiplus.h","changes":[{"type":"normal","normal":true,"ln1":213,"ln2":213,"content":" gdk/gdkevents.h"},{"type":"normal","normal":true,"ln1":214,"ln2":214,"content":" gdk/gdk.h"},{"type":"normal","normal":true,"ln1":215,"ln2":215,"content":" gdk/gdkkeysyms.h"},{"type":"del","del":true,"ln":216,"content":"-gdk/gdkpango.h"},{"type":"normal","normal":true,"ln1":217,"ln2":216,"content":" gdk/gdkprivate.h"},{"type":"normal","normal":true,"ln1":218,"ln2":217,"content":" gdk/gdkregion.h"},{"type":"normal","normal":true,"ln1":219,"ln2":218,"content":" gdk/gdkwindow.h"}],"oldStart":213,"oldLines":7,"newStart":213,"newLines":6},{"content":"@@ -506,7 +505,6 @@ PALM_CMN.H","changes":[{"type":"normal","normal":true,"ln1":506,"ln2":505,"content":" pango-engine.h"},{"type":"normal","normal":true,"ln1":507,"ln2":506,"content":" pango-glyph.h"},{"type":"normal","normal":true,"ln1":508,"ln2":507,"content":" pango-modules.h"},{"type":"del","del":true,"ln":509,"content":"-pango/pangocairo.h"},{"type":"normal","normal":true,"ln1":510,"ln2":508,"content":" pango/pangofc-decoder.h"},{"type":"normal","normal":true,"ln1":511,"ln2":509,"content":" pango/pangofc-font.h"},{"type":"normal","normal":true,"ln1":512,"ln2":510,"content":" pango/pangofc-fontmap.h"}],"oldStart":506,"oldLines":7,"newStart":505,"newLines":6},{"content":"@@ -515,7 +513,6 @@ pango/pango-fontmap.h","changes":[{"type":"normal","normal":true,"ln1":515,"ln2":513,"content":" pango/pango.h"},{"type":"normal","normal":true,"ln1":516,"ln2":514,"content":" pango/pangoxft.h"},{"type":"normal","normal":true,"ln1":517,"ln2":515,"content":" pango/pangox.h"},{"type":"del","del":true,"ln":518,"content":"-pango/pango-utils.h"},{"type":"normal","normal":true,"ln1":519,"ln2":516,"content":" pango-types.h"},{"type":"normal","normal":true,"ln1":520,"ln2":517,"content":" pascal.h"},{"type":"normal","normal":true,"ln1":521,"ln2":518,"content":" Patches.h"}],"oldStart":515,"oldLines":7,"newStart":513,"newLines":6}],"deletions":3,"additions":0,"from":"config/system-headers","to":"config/system-headers","index":["b195469..c40e1dc","100644"]},{"chunks":[{"content":"@@ -116,8 +116,7 @@ PERL_VERSION=5.006","changes":[{"type":"normal","normal":true,"ln1":116,"ln2":116,"content":" LIBART_VERSION=2.3.4"},{"type":"normal","normal":true,"ln1":117,"ln2":117,"content":" CAIRO_VERSION=1.4.2"},{"type":"normal","normal":true,"ln1":118,"ln2":118,"content":" GLITZ_VERSION=0.4.0"},{"type":"del","del":true,"ln":119,"content":"-PANGO_VERSION=1.10.0"},{"type":"del","del":true,"ln":120,"content":"-GTK2_VERSION=1.8.0"},{"type":"add","add":true,"ln":119,"content":"+GTK2_VERSION=1.3.7"},{"type":"normal","normal":true,"ln1":121,"ln2":120,"content":" MAKE_VERSION=3.78"},{"type":"normal","normal":true,"ln1":122,"ln2":121,"content":" WINDRES_VERSION=2.14.90"},{"type":"normal","normal":true,"ln1":123,"ln2":122,"content":" W32API_VERSION=3.8"}],"oldStart":116,"oldLines":8,"newStart":116,"newLines":7},{"content":"@@ -4568,7 +4567,7 @@ fi","changes":[{"type":"normal","normal":true,"ln1":4568,"ln2":4567,"content":" if test \"$COMPILE_ENVIRONMENT\"; then"},{"type":"normal","normal":true,"ln1":4569,"ln2":4568,"content":" if test \"$MOZ_ENABLE_GTK2\""},{"type":"normal","normal":true,"ln1":4570,"ln2":4569,"content":" then"},{"type":"del","del":true,"ln":4571,"content":"-    PKG_CHECK_MODULES(MOZ_GTK2, gtk+-2.0 >= $GTK2_VERSION gdk-x11-2.0 glib-2.0 gobject-2.0)"},{"type":"add","add":true,"ln":4570,"content":"+    PKG_CHECK_MODULES(MOZ_GTK2, gtk+-2.0 >= 1.3.7 gdk-x11-2.0 glib-2.0 gobject-2.0)"},{"type":"normal","normal":true,"ln1":4572,"ln2":4571,"content":" fi"},{"type":"normal","normal":true,"ln1":4573,"ln2":4572,"content":" fi # COMPILE_ENVIRONMENT"},{"type":"normal","normal":true,"ln1":4574,"ln2":4573,"content":" "}],"oldStart":4568,"oldLines":7,"newStart":4567,"newLines":7},{"content":"@@ -4783,7 +4782,7 @@ if test \"$MOZ_ENABLE_XFT\"","changes":[{"type":"normal","normal":true,"ln1":4783,"ln2":4782,"content":" then"},{"type":"normal","normal":true,"ln1":4784,"ln2":4783,"content":"     AC_DEFINE(MOZ_ENABLE_XFT)"},{"type":"normal","normal":true,"ln1":4785,"ln2":4784,"content":"     PKG_CHECK_MODULES(MOZ_XFT, xft)"},{"type":"del","del":true,"ln":4786,"content":"-    PKG_CHECK_MODULES(_PANGOCHK, pango >= $PANGO_VERSION)"},{"type":"add","add":true,"ln":4785,"content":"+    PKG_CHECK_MODULES(_PANGOCHK, pango >= 1.1.0)"},{"type":"normal","normal":true,"ln1":4787,"ln2":4786,"content":" fi"},{"type":"normal","normal":true,"ln1":4788,"ln2":4787,"content":" "},{"type":"normal","normal":true,"ln1":4789,"ln2":4788,"content":" AC_SUBST(MOZ_ENABLE_XFT)"}],"oldStart":4783,"oldLines":7,"newStart":4782,"newLines":7},{"content":"@@ -4800,7 +4799,12 @@ MOZ_ARG_ENABLE_BOOL(pango,","changes":[{"type":"normal","normal":true,"ln1":4800,"ln2":4799,"content":" "},{"type":"normal","normal":true,"ln1":4801,"ln2":4800,"content":" if test \"$MOZ_ENABLE_PANGO\" && test -z \"$MOZ_ENABLE_CAIRO_GFX\""},{"type":"normal","normal":true,"ln1":4802,"ln2":4801,"content":" then"},{"type":"del","del":true,"ln":4803,"content":"-    AC_MSG_ERROR([Cairo gfx is required for Pango font rendering])"},{"type":"add","add":true,"ln":4802,"content":"+    AC_DEFINE(MOZ_ENABLE_PANGO)"},{"type":"add","add":true,"ln":4803,"content":"+    PKG_CHECK_MODULES(MOZ_PANGO, pangoxft >= 1.6.0)"},{"type":"add","add":true,"ln":4804,"content":"+"},{"type":"add","add":true,"ln":4805,"content":"+    AC_SUBST(MOZ_ENABLE_PANGO)"},{"type":"add","add":true,"ln":4806,"content":"+    AC_SUBST(MOZ_PANGO_CFLAGS)"},{"type":"add","add":true,"ln":4807,"content":"+    AC_SUBST(MOZ_PANGO_LIBS)"},{"type":"normal","normal":true,"ln1":4804,"ln2":4808,"content":" fi"},{"type":"normal","normal":true,"ln1":4805,"ln2":4809,"content":" "},{"type":"normal","normal":true,"ln1":4806,"ln2":4810,"content":" if test \"$MOZ_ENABLE_GTK2\" && test \"$MOZ_ENABLE_CAIRO_GFX\""}],"oldStart":4800,"oldLines":7,"newStart":4799,"newLines":12},{"content":"@@ -4816,7 +4820,13 @@ fi","changes":[{"type":"normal","normal":true,"ln1":4816,"ln2":4820,"content":" if test \"$MOZ_ENABLE_PANGO\" && test \"$MOZ_ENABLE_CAIRO_GFX\""},{"type":"normal","normal":true,"ln1":4817,"ln2":4821,"content":" then"},{"type":"normal","normal":true,"ln1":4818,"ln2":4822,"content":"     AC_DEFINE(MOZ_ENABLE_PANGO)"},{"type":"del","del":true,"ln":4819,"content":"-    PKG_CHECK_MODULES(MOZ_PANGO, pango >= $PANGO_VERSION pangocairo >= $PANGO_VERSION pangoft2 >= $PANGO_VERSION)"},{"type":"add","add":true,"ln":4823,"content":"+    dnl PKG_CHECK_MODULES(MOZ_PANGO, pango >= 1.10.0 pangocairo >= 1.10.0)"},{"type":"add","add":true,"ln":4824,"content":"+    if test \"$MOZ_X11\"; then"},{"type":"add","add":true,"ln":4825,"content":"+        PKG_CHECK_MODULES(MOZ_PANGO, pango >= 1.6.0 pangoft2 >= 1.6.0 pangoxft >= 1.6.0)"},{"type":"add","add":true,"ln":4826,"content":"+    else"},{"type":"add","add":true,"ln":4827,"content":"+        PKG_CHECK_MODULES(MOZ_PANGO, pango >= 1.6.0 pangoft2 >= 1.6.0)"},{"type":"add","add":true,"ln":4828,"content":"+    fi"},{"type":"add","add":true,"ln":4829,"content":"+"},{"type":"normal","normal":true,"ln1":4820,"ln2":4830,"content":"     AC_SUBST(MOZ_ENABLE_PANGO)"},{"type":"normal","normal":true,"ln1":4821,"ln2":4831,"content":"     AC_SUBST(MOZ_PANGO_CFLAGS)"},{"type":"normal","normal":true,"ln1":4822,"ln2":4832,"content":"     AC_SUBST(MOZ_PANGO_LIBS)"}],"oldStart":4816,"oldLines":7,"newStart":4820,"newLines":13}],"deletions":6,"additions":16,"from":"configure.in","to":"configure.in","index":["5c52f67..0d410f7","100644"]},{"chunks":[{"content":"@@ -44,15 +44,14 @@","changes":[{"type":"normal","normal":true,"ln1":44,"ln2":44,"content":" #include \"gfxFont.h\""},{"type":"normal","normal":true,"ln1":45,"ln2":45,"content":" "},{"type":"normal","normal":true,"ln1":46,"ln2":46,"content":" #include <pango/pango.h>"},{"type":"add","add":true,"ln":47,"content":"+#include <X11/Xft/Xft.h>"},{"type":"normal","normal":true,"ln1":47,"ln2":48,"content":" "},{"type":"del","del":true,"ln":48,"content":"-// Control when we bypass Pango"},{"type":"del","del":true,"ln":49,"content":"-// Enable this to use FreeType to glyph-convert 8bit-only textruns, but use Pango"},{"type":"add","add":true,"ln":49,"content":"+// Control when we use Xft directly, bypassing Pango"},{"type":"add","add":true,"ln":50,"content":"+// Enable this to use Xft to glyph-convert 8bit-only textruns, but use Pango"},{"type":"normal","normal":true,"ln1":50,"ln2":51,"content":" // to shape any textruns with non-8bit characters"},{"type":"del","del":true,"ln":51,"content":"-// XXX"},{"type":"del","del":true,"ln":52,"content":"-#define ENABLE_FAST_PATH_8BIT"},{"type":"del","del":true,"ln":53,"content":"-// Enable this to bypass Pango shaping for all textruns.  Don't expect"},{"type":"del","del":true,"ln":54,"content":"-// anything other than simple Latin work though!"},{"type":"del","del":true,"ln":55,"content":"-//#define ENABLE_FAST_PATH_ALWAYS"},{"type":"add","add":true,"ln":52,"content":"+#define ENABLE_XFT_FAST_PATH_8BIT"},{"type":"add","add":true,"ln":53,"content":"+// Enable this to use Xft to glyph-convert all textruns"},{"type":"add","add":true,"ln":54,"content":"+// #define ENABLE_XFT_FAST_PATH_ALWAYS"},{"type":"normal","normal":true,"ln1":56,"ln2":55,"content":" "},{"type":"normal","normal":true,"ln1":57,"ln2":56,"content":" #include \"nsDataHashtable.h\""},{"type":"normal","normal":true,"ln1":58,"ln2":57,"content":" #include \"nsClassHashtable.h\""}],"oldStart":44,"oldLines":15,"newStart":44,"newLines":14},{"content":"@@ -71,15 +70,17 @@ public:","changes":[{"type":"normal","normal":true,"ln1":71,"ln2":70,"content":" "},{"type":"normal","normal":true,"ln1":72,"ln2":71,"content":"     virtual const gfxFont::Metrics& GetMetrics();"},{"type":"normal","normal":true,"ln1":73,"ln2":72,"content":" "},{"type":"del","del":true,"ln":74,"content":"-    PangoFontDescription *GetPangoFontDescription() { if (!mPangoFontDesc) RealizeFont(); return mPangoFontDesc; }"},{"type":"del","del":true,"ln":75,"content":"-    PangoContext *GetPangoContext() { if (!mPangoFontDesc) RealizeFont(); return mPangoCtx; }"},{"type":"add","add":true,"ln":73,"content":"+    PangoFontDescription *GetPangoFontDescription() { RealizeFont(); return mPangoFontDesc; }"},{"type":"add","add":true,"ln":74,"content":"+    PangoContext *GetPangoContext() { RealizeFont(); return mPangoCtx; }"},{"type":"normal","normal":true,"ln1":76,"ln2":75,"content":" "},{"type":"normal","normal":true,"ln1":77,"ln2":76,"content":"     void GetMozLang(nsACString &aMozLang);"},{"type":"normal","normal":true,"ln1":78,"ln2":77,"content":"     void GetActualFontFamily(nsACString &aFamily);"},{"type":"normal","normal":true,"ln1":79,"ln2":78,"content":" "},{"type":"del","del":true,"ln":80,"content":"-    PangoFont *GetPangoFont() { if (!mPangoFont) RealizePangoFont(); return mPangoFont; }"},{"type":"del","del":true,"ln":81,"content":"-    gfxFloat GetAdjustedSize() { if (!mPangoFontDesc) RealizeFont(); return mAdjustedSize; }"},{"type":"add","add":true,"ln":79,"content":"+    XftFont *GetXftFont () { RealizeXftFont (); return mXftFont; }"},{"type":"add","add":true,"ln":80,"content":"+    PangoFont *GetPangoFont() { RealizePangoFont(); return mPangoFont; }"},{"type":"add","add":true,"ln":81,"content":"+    gfxFloat GetAdjustedSize() { RealizeFont(); return mAdjustedSize; }"},{"type":"normal","normal":true,"ln1":82,"ln2":82,"content":" "},{"type":"add","add":true,"ln":83,"content":"+    PRBool HasGlyph(const PRUint32 aChar);"},{"type":"normal","normal":true,"ln1":83,"ln2":84,"content":"     PRUint32 GetGlyph(const PRUint32 aChar);"},{"type":"normal","normal":true,"ln1":84,"ln2":85,"content":" "},{"type":"normal","normal":true,"ln1":85,"ln2":86,"content":"     virtual nsString GetUniqueName();"}],"oldStart":71,"oldLines":15,"newStart":70,"newLines":17},{"content":"@@ -94,7 +95,9 @@ protected:","changes":[{"type":"normal","normal":true,"ln1":94,"ln2":95,"content":"     PangoFontDescription *mPangoFontDesc;"},{"type":"normal","normal":true,"ln1":95,"ln2":96,"content":"     PangoContext *mPangoCtx;"},{"type":"normal","normal":true,"ln1":96,"ln2":97,"content":" "},{"type":"add","add":true,"ln":98,"content":"+    XftFont *mXftFont;"},{"type":"normal","normal":true,"ln1":97,"ln2":99,"content":"     PangoFont *mPangoFont;"},{"type":"add","add":true,"ln":100,"content":"+    PangoFont *mGlyphTestingFont;"},{"type":"normal","normal":true,"ln1":98,"ln2":101,"content":"     cairo_scaled_font_t *mCairoFont;"},{"type":"normal","normal":true,"ln1":99,"ln2":102,"content":" "},{"type":"normal","normal":true,"ln1":100,"ln2":103,"content":"     PRBool   mHasMetrics;"}],"oldStart":94,"oldLines":7,"newStart":95,"newLines":9},{"content":"@@ -103,6 +106,7 @@ protected:","changes":[{"type":"normal","normal":true,"ln1":103,"ln2":106,"content":"     gfxFloat mAdjustedSize;"},{"type":"normal","normal":true,"ln1":104,"ln2":107,"content":" "},{"type":"normal","normal":true,"ln1":105,"ln2":108,"content":"     void RealizeFont(PRBool force = PR_FALSE);"},{"type":"add","add":true,"ln":109,"content":"+    void RealizeXftFont(PRBool force = PR_FALSE);"},{"type":"normal","normal":true,"ln1":106,"ln2":110,"content":"     void RealizePangoFont(PRBool aForce = PR_FALSE);"},{"type":"normal","normal":true,"ln1":107,"ln2":111,"content":"     void GetCharSize(const char aChar, gfxSize& aInkSize, gfxSize& aLogSize,"},{"type":"normal","normal":true,"ln1":108,"ln2":112,"content":"                      PRUint32 *aGlyphID = nsnull);"}],"oldStart":103,"oldLines":6,"newStart":106,"newLines":7},{"content":"@@ -120,7 +124,7 @@ public:","changes":[{"type":"normal","normal":true,"ln1":120,"ln2":124,"content":" "},{"type":"normal","normal":true,"ln1":121,"ln2":125,"content":"     virtual gfxFontGroup *Copy(const gfxFontStyle *aStyle);"},{"type":"normal","normal":true,"ln1":122,"ln2":126,"content":" "},{"type":"del","del":true,"ln":123,"content":"-    // Create and initialize a textrun using Pango"},{"type":"add","add":true,"ln":127,"content":"+    // Create and initialize a textrun using Pango (or Xft)"},{"type":"normal","normal":true,"ln1":124,"ln2":128,"content":"     virtual gfxTextRun *MakeTextRun(const PRUnichar *aString, PRUint32 aLength,"},{"type":"normal","normal":true,"ln1":125,"ln2":129,"content":"                                     const Parameters *aParams, PRUint32 aFlags);"},{"type":"normal","normal":true,"ln1":126,"ln2":130,"content":"     virtual gfxTextRun *MakeTextRun(const PRUint8 *aString, PRUint32 aLength,"}],"oldStart":120,"oldLines":7,"newStart":124,"newLines":7},{"content":"@@ -142,8 +146,8 @@ protected:","changes":[{"type":"normal","normal":true,"ln1":142,"ln2":146,"content":"      * but stored in UTF16 format)"},{"type":"normal","normal":true,"ln1":143,"ln2":147,"content":"      */"},{"type":"normal","normal":true,"ln1":144,"ln2":148,"content":"     void InitTextRun(gfxTextRun *aTextRun, const gchar *aUTF8Text,"},{"type":"del","del":true,"ln":145,"content":"-                     PRUint32 aUTF8Length, PRBool aTake8BitPath);"},{"type":"del","del":true,"ln":146,"content":"-"},{"type":"add","add":true,"ln":149,"content":"+                     PRUint32 aUTF8Length, PRUint32 aUTF8HeaderLength,"},{"type":"add","add":true,"ln":150,"content":"+                     PRBool aTake8BitPath);"},{"type":"normal","normal":true,"ln1":147,"ln2":151,"content":"     // Returns NS_ERROR_FAILURE if there's a missing glyph"},{"type":"normal","normal":true,"ln1":148,"ln2":152,"content":"     nsresult SetGlyphs(gfxTextRun *aTextRun, gfxPangoFont *aFont,"},{"type":"normal","normal":true,"ln1":149,"ln2":153,"content":"                        const gchar *aUTF8, PRUint32 aUTF8Length,"}],"oldStart":142,"oldLines":8,"newStart":146,"newLines":8},{"content":"@@ -154,11 +158,11 @@ protected:","changes":[{"type":"normal","normal":true,"ln1":154,"ln2":158,"content":"                               const gchar *aUTF8, PRUint32 aUTF8Length,"},{"type":"normal","normal":true,"ln1":155,"ln2":159,"content":"                               PRUint32 *aUTF16Offset);"},{"type":"normal","normal":true,"ln1":156,"ln2":160,"content":"     void CreateGlyphRunsItemizing(gfxTextRun *aTextRun,"},{"type":"del","del":true,"ln":157,"content":"-                                  const gchar *aUTF8, PRUint32 aUTF8Length);"},{"type":"del","del":true,"ln":158,"content":"-#if defined(ENABLE_FAST_PATH_8BIT) || defined(ENABLE_FAST_PATH_ALWAYS)"},{"type":"del","del":true,"ln":159,"content":"-    PRBool CanTakeFastPath(PRUint32 aFlags);"},{"type":"del","del":true,"ln":160,"content":"-    void CreateGlyphRunsFast(gfxTextRun *aTextRun,"},{"type":"del","del":true,"ln":161,"content":"-                             const gchar *aUTF8, PRUint32 aUTF8Length);"},{"type":"add","add":true,"ln":161,"content":"+                                  const gchar *aUTF8, PRUint32 aUTF8Length,"},{"type":"add","add":true,"ln":162,"content":"+                                  PRUint32 aUTF8HeaderLength);"},{"type":"add","add":true,"ln":163,"content":"+#if defined(ENABLE_XFT_FAST_PATH_8BIT) || defined(ENABLE_XFT_FAST_PATH_ALWAYS)"},{"type":"add","add":true,"ln":164,"content":"+    void CreateGlyphRunsXft(gfxTextRun *aTextRun,"},{"type":"add","add":true,"ln":165,"content":"+                            const gchar *aUTF8, PRUint32 aUTF8Length);"},{"type":"normal","normal":true,"ln1":162,"ln2":166,"content":" #endif"},{"type":"normal","normal":true,"ln1":163,"ln2":167,"content":" "},{"type":"normal","normal":true,"ln1":164,"ln2":168,"content":"     static PRBool FontCallback (const nsAString& fontName,"}],"oldStart":154,"oldLines":11,"newStart":158,"newLines":11},{"content":"@@ -208,4 +212,30 @@ private:","changes":[{"type":"normal","normal":true,"ln1":208,"ln2":212,"content":"     nsClassHashtable<nsUint32HashKey,  gfxPangoFontWrapper> mPangoFonts;"},{"type":"normal","normal":true,"ln1":209,"ln2":213,"content":" };"},{"type":"normal","normal":true,"ln1":210,"ln2":214,"content":" "},{"type":"add","add":true,"ln":215,"content":"+// XXX we should remove this class, because this class is used only in |HasGlyph| of gfxPangoFont."},{"type":"add","add":true,"ln":216,"content":"+// But it can use fontconfig directly after bug 366664."},{"type":"add","add":true,"ln":217,"content":"+class gfxPangoFontNameMap"},{"type":"add","add":true,"ln":218,"content":"+{"},{"type":"add","add":true,"ln":219,"content":"+public:"},{"type":"add","add":true,"ln":220,"content":"+    gfxPangoFontNameMap();"},{"type":"add","add":true,"ln":221,"content":"+    ~gfxPangoFontNameMap();"},{"type":"add","add":true,"ln":222,"content":"+"},{"type":"add","add":true,"ln":223,"content":"+    static gfxPangoFontNameMap* GetPangoFontNameMap() {"},{"type":"add","add":true,"ln":224,"content":"+        if (!sPangoFontNameMap)"},{"type":"add","add":true,"ln":225,"content":"+            sPangoFontNameMap = new gfxPangoFontNameMap();"},{"type":"add","add":true,"ln":226,"content":"+        return sPangoFontNameMap;"},{"type":"add","add":true,"ln":227,"content":"+    }"},{"type":"add","add":true,"ln":228,"content":"+    static void Shutdown() {"},{"type":"add","add":true,"ln":229,"content":"+        if (sPangoFontNameMap)"},{"type":"add","add":true,"ln":230,"content":"+            delete sPangoFontNameMap;"},{"type":"add","add":true,"ln":231,"content":"+        sPangoFontNameMap = nsnull;"},{"type":"add","add":true,"ln":232,"content":"+    }"},{"type":"add","add":true,"ln":233,"content":"+"},{"type":"add","add":true,"ln":234,"content":"+    void Put(const nsACString &aName, PangoFont *aPangoFont);"},{"type":"add","add":true,"ln":235,"content":"+    PangoFont* Get(const nsACString &aName);"},{"type":"add","add":true,"ln":236,"content":"+"},{"type":"add","add":true,"ln":237,"content":"+private:"},{"type":"add","add":true,"ln":238,"content":"+    static gfxPangoFontNameMap *sPangoFontNameMap;"},{"type":"add","add":true,"ln":239,"content":"+    nsClassHashtable<nsCStringHashKey, gfxPangoFontWrapper> mPangoFonts;"},{"type":"add","add":true,"ln":240,"content":"+};"},{"type":"normal","normal":true,"ln1":211,"ln2":241,"content":" #endif /* GFX_PANGOFONTS_H */"}],"oldStart":208,"oldLines":4,"newStart":212,"newLines":30}],"deletions":19,"additions":49,"from":"gfx/thebes/public/gfxPangoFonts.h","to":"gfx/thebes/public/gfxPangoFonts.h","index":["f0a63d7..a90ff13","100644"]},{"chunks":[{"content":"@@ -79,7 +79,7 @@ public:","changes":[{"type":"normal","normal":true,"ln1":79,"ln2":79,"content":"         if (sDPI == -1) {"},{"type":"normal","normal":true,"ln1":80,"ln2":80,"content":"             InitDPI();"},{"type":"normal","normal":true,"ln1":81,"ln2":81,"content":"         }"},{"type":"del","del":true,"ln":82,"content":"-        NS_ASSERTION(sDPI > 0, \"Something is wrong\");"},{"type":"add","add":true,"ln":82,"content":"+        NS_ASSERTION(sDPI != 0, \"Something is wrong\");"},{"type":"normal","normal":true,"ln1":83,"ln2":83,"content":"         return sDPI;"},{"type":"normal","normal":true,"ln1":84,"ln2":84,"content":"     }"},{"type":"normal","normal":true,"ln1":85,"ln2":85,"content":" "}],"oldStart":79,"oldLines":7,"newStart":79,"newLines":7}],"deletions":1,"additions":1,"from":"gfx/thebes/public/gfxPlatformGtk.h","to":"gfx/thebes/public/gfxPlatformGtk.h","index":["4c7eafd..0177304","100644"]},{"chunks":[{"content":"@@ -21,7 +21,6 @@","changes":[{"type":"normal","normal":true,"ln1":21,"ln2":21,"content":"  * Contributor(s):"},{"type":"normal","normal":true,"ln1":22,"ln2":22,"content":"  *   Vladimir Vukicevic <vladimir@mozilla.com>"},{"type":"normal","normal":true,"ln1":23,"ln2":23,"content":"  *   Masayuki Nakano <masayuki@d-toybox.com>"},{"type":"del","del":true,"ln":24,"content":"- *   Behdad Esfahbod <behdad@gnome.org>"},{"type":"normal","normal":true,"ln1":25,"ln2":24,"content":"  *"},{"type":"normal","normal":true,"ln1":26,"ln2":25,"content":"  * based on nsFontMetricsPango.cpp by"},{"type":"normal","normal":true,"ln1":27,"ln2":26,"content":"  *   Christopher Blizzard <blizzard@mozilla.org>"}],"oldStart":21,"oldLines":7,"newStart":21,"newLines":6},{"content":"@@ -40,6 +39,11 @@","changes":[{"type":"normal","normal":true,"ln1":40,"ln2":39,"content":"  *"},{"type":"normal","normal":true,"ln1":41,"ln2":40,"content":"  * ***** END LICENSE BLOCK ***** */"},{"type":"normal","normal":true,"ln1":42,"ln2":41,"content":" "},{"type":"add","add":true,"ln":42,"content":"+#ifdef XP_BEOS"},{"type":"add","add":true,"ln":43,"content":"+#define THEBES_USE_PANGO_CAIRO"},{"type":"add","add":true,"ln":44,"content":"+#endif"},{"type":"add","add":true,"ln":45,"content":"+"},{"type":"add","add":true,"ln":46,"content":"+#define PANGO_ENABLE_ENGINE"},{"type":"normal","normal":true,"ln1":43,"ln2":47,"content":" #define PANGO_ENABLE_BACKEND"},{"type":"normal","normal":true,"ln1":44,"ln2":48,"content":" "},{"type":"normal","normal":true,"ln1":45,"ln2":49,"content":" #include \"prtypes.h\""}],"oldStart":40,"oldLines":6,"newStart":39,"newLines":11},{"content":"@@ -58,38 +62,45 @@","changes":[{"type":"normal","normal":true,"ln1":58,"ln2":62,"content":" #include \"nsPromiseFlatString.h\""},{"type":"normal","normal":true,"ln1":59,"ln2":63,"content":" "},{"type":"normal","normal":true,"ln1":60,"ln2":64,"content":" #include \"gfxContext.h\""},{"type":"del","del":true,"ln":61,"content":"-#include \"gfxPlatformGtk.h\""},{"type":"normal","normal":true,"ln1":62,"ln2":65,"content":" #include \"gfxPangoFonts.h\""},{"type":"normal","normal":true,"ln1":63,"ln2":66,"content":" "},{"type":"normal","normal":true,"ln1":64,"ln2":67,"content":" #include \"nsCRT.h\""},{"type":"normal","normal":true,"ln1":65,"ln2":68,"content":" "},{"type":"add","add":true,"ln":69,"content":"+#include \"cairo.h\""},{"type":"add","add":true,"ln":70,"content":"+"},{"type":"add","add":true,"ln":71,"content":"+#ifndef THEBES_USE_PANGO_CAIRO"},{"type":"add","add":true,"ln":72,"content":"+#include <gdk/gdk.h>"},{"type":"add","add":true,"ln":73,"content":"+#include <gdk/gdkx.h>"},{"type":"add","add":true,"ln":74,"content":"+#include <gdk/gdkpango.h>"},{"type":"add","add":true,"ln":75,"content":"+"},{"type":"add","add":true,"ln":76,"content":"+"},{"type":"normal","normal":true,"ln1":66,"ln2":77,"content":" #include <freetype/tttables.h>"},{"type":"add","add":true,"ln":78,"content":"+#include <fontconfig/fontconfig.h>"},{"type":"normal","normal":true,"ln1":67,"ln2":79,"content":" "},{"type":"del","del":true,"ln":68,"content":"-#include <cairo.h>"},{"type":"del","del":true,"ln":69,"content":"-#include <cairo-ft.h>"},{"type":"add","add":true,"ln":80,"content":"+#include <pango/pango-font.h>"},{"type":"add","add":true,"ln":81,"content":"+#include <pango/pangoxft.h>"},{"type":"add","add":true,"ln":82,"content":"+"},{"type":"add","add":true,"ln":83,"content":"+#include \"cairo-ft.h\""},{"type":"add","add":true,"ln":84,"content":"+"},{"type":"add","add":true,"ln":85,"content":"+#include \"gfxPlatformGtk.h\""},{"type":"add","add":true,"ln":86,"content":"+"},{"type":"add","add":true,"ln":87,"content":"+#else // THEBES_USE_PANGO_CAIRO"},{"type":"normal","normal":true,"ln1":70,"ln2":88,"content":" "},{"type":"del","del":true,"ln":71,"content":"-#include <pango/pango.h>"},{"type":"del","del":true,"ln":72,"content":"-#include <pango/pango-utils.h>"},{"type":"normal","normal":true,"ln1":73,"ln2":89,"content":" #include <pango/pangocairo.h>"},{"type":"del","del":true,"ln":74,"content":"-#include <pango/pangofc-fontmap.h>"},{"type":"normal","normal":true,"ln1":75,"ln2":90,"content":" "},{"type":"del","del":true,"ln":76,"content":"-#include <gdk/gdkpango.h>"},{"type":"add","add":true,"ln":91,"content":"+#endif // THEBES_USE_PANGO_CAIRO"},{"type":"normal","normal":true,"ln1":77,"ln2":92,"content":" "},{"type":"normal","normal":true,"ln1":78,"ln2":93,"content":" #include <math.h>"},{"type":"normal","normal":true,"ln1":79,"ln2":94,"content":" "},{"type":"normal","normal":true,"ln1":80,"ln2":95,"content":" #define FLOAT_PANGO_SCALE ((gfxFloat)PANGO_SCALE)"},{"type":"normal","normal":true,"ln1":81,"ln2":96,"content":" "},{"type":"del","del":true,"ln":82,"content":"-#ifndef PANGO_GLYPH_UNKNOWN_FLAG"},{"type":"del","del":true,"ln":83,"content":"-#define PANGO_GLYPH_UNKNOWN_FLAG ((PangoGlyph)0x10000000)"},{"type":"del","del":true,"ln":84,"content":"-#endif"},{"type":"del","del":true,"ln":85,"content":"-#ifndef PANGO_GLYPH_EMPTY"},{"type":"del","del":true,"ln":86,"content":"-#define PANGO_GLYPH_EMPTY           ((PangoGlyph)0)"},{"type":"del","del":true,"ln":87,"content":"-#endif"},{"type":"del","del":true,"ln":88,"content":"-#define IS_MISSING_GLYPH(g) (((g) & PANGO_GLYPH_UNKNOWN_FLAG) || (g) == PANGO_GLYPH_EMPTY)"},{"type":"add","add":true,"ln":97,"content":"+#define IS_MISSING_GLYPH(g) (((g) & 0x10000000) || (g) == 0x0FFFFFFF)"},{"type":"normal","normal":true,"ln1":89,"ln2":98,"content":" "},{"type":"normal","normal":true,"ln1":90,"ln2":99,"content":" static PangoLanguage *GetPangoLanguage(const nsACString& aLangGroup);"},{"type":"add","add":true,"ln":100,"content":"+static void GetMozLanguage(const PangoLanguage *aLang, nsACString &aMozLang);"},{"type":"normal","normal":true,"ln1":91,"ln2":101,"content":" "},{"type":"normal","normal":true,"ln1":92,"ln2":102,"content":" /* static */ gfxPangoFontCache* gfxPangoFontCache::sPangoFontCache = nsnull;"},{"type":"add","add":true,"ln":103,"content":"+/* static */ gfxPangoFontNameMap* gfxPangoFontNameMap::sPangoFontNameMap = nsnull;"},{"type":"normal","normal":true,"ln1":93,"ln2":104,"content":" "},{"type":"normal","normal":true,"ln1":94,"ln2":105,"content":" /**"},{"type":"normal","normal":true,"ln1":95,"ln2":106,"content":"  ** gfxPangoFontGroup"}],"oldStart":58,"oldLines":38,"newStart":62,"newLines":45},{"content":"@@ -155,7 +166,6 @@ gfxPangoFontGroup::gfxPangoFontGroup (const nsAString& families,","changes":[{"type":"normal","normal":true,"ln1":155,"ln2":166,"content":" "},{"type":"normal","normal":true,"ln1":156,"ln2":167,"content":"     // XXX If there are no actual fonts, we should use dummy family."},{"type":"normal","normal":true,"ln1":157,"ln2":168,"content":"     // Pango will resolve from this."},{"type":"del","del":true,"ln":158,"content":"-    // behdad: yep, looks good."},{"type":"normal","normal":true,"ln1":159,"ln2":169,"content":"     if (familyArray.Count() == 0) {"},{"type":"normal","normal":true,"ln1":160,"ln2":170,"content":"         // printf(\"%s(%s)\\n\", NS_ConvertUTF16toUTF8(families).get(),"},{"type":"normal","normal":true,"ln1":161,"ln2":171,"content":"         //                    aStyle->langGroup.get());"}],"oldStart":155,"oldLines":7,"newStart":166,"newLines":6},{"content":"@@ -184,12 +194,82 @@ gfxPangoFontGroup::Copy(const gfxFontStyle *aStyle)","changes":[{"type":"normal","normal":true,"ln1":184,"ln2":194,"content":"  ** gfxPangoFont"},{"type":"normal","normal":true,"ln1":185,"ln2":195,"content":"  **/"},{"type":"normal","normal":true,"ln1":186,"ln2":196,"content":" "},{"type":"add","add":true,"ln":197,"content":"+// Glue to avoid build/runtime dependencies on Pango > 1.6,"},{"type":"add","add":true,"ln":198,"content":"+// because we like living in 1999"},{"type":"add","add":true,"ln":199,"content":"+"},{"type":"add","add":true,"ln":200,"content":"+#ifndef THEBES_USE_PANGO_CAIRO"},{"type":"add","add":true,"ln":201,"content":"+static void"},{"type":"add","add":true,"ln":202,"content":"+(* PTR_pango_font_description_set_absolute_size)(PangoFontDescription*, double)"},{"type":"add","add":true,"ln":203,"content":"+    = nsnull;"},{"type":"add","add":true,"ln":204,"content":"+"},{"type":"add","add":true,"ln":205,"content":"+static void InitPangoLib()"},{"type":"add","add":true,"ln":206,"content":"+{"},{"type":"add","add":true,"ln":207,"content":"+    static PRBool initialized = PR_FALSE;"},{"type":"add","add":true,"ln":208,"content":"+    if (initialized)"},{"type":"add","add":true,"ln":209,"content":"+        return;"},{"type":"add","add":true,"ln":210,"content":"+    initialized = PR_TRUE;"},{"type":"add","add":true,"ln":211,"content":"+"},{"type":"add","add":true,"ln":212,"content":"+    g_type_init();"},{"type":"add","add":true,"ln":213,"content":"+"},{"type":"add","add":true,"ln":214,"content":"+    PRLibrary *pangoLib = nsnull;"},{"type":"add","add":true,"ln":215,"content":"+    PTR_pango_font_description_set_absolute_size ="},{"type":"add","add":true,"ln":216,"content":"+        (void (*)(PangoFontDescription*, double))"},{"type":"add","add":true,"ln":217,"content":"+        PR_FindFunctionSymbolAndLibrary(\"pango_font_description_set_absolute_size\","},{"type":"add","add":true,"ln":218,"content":"+                                        &pangoLib);"},{"type":"add","add":true,"ln":219,"content":"+    if (pangoLib)"},{"type":"add","add":true,"ln":220,"content":"+        PR_UnloadLibrary(pangoLib);"},{"type":"add","add":true,"ln":221,"content":"+"},{"type":"add","add":true,"ln":222,"content":"+    PRLibrary *xftLib = nsnull;"},{"type":"add","add":true,"ln":223,"content":"+    int *xft_max_freetype_files_ptr = nsnull;"},{"type":"add","add":true,"ln":224,"content":"+    xft_max_freetype_files_ptr = (int*) PR_FindSymbolAndLibrary(\"XftMaxFreeTypeFiles\", &xftLib);"},{"type":"add","add":true,"ln":225,"content":"+    if (xft_max_freetype_files_ptr && *xft_max_freetype_files_ptr < 50)"},{"type":"add","add":true,"ln":226,"content":"+        *xft_max_freetype_files_ptr = 50;"},{"type":"add","add":true,"ln":227,"content":"+    if (xftLib)"},{"type":"add","add":true,"ln":228,"content":"+        PR_UnloadLibrary(xftLib);"},{"type":"add","add":true,"ln":229,"content":"+}"},{"type":"add","add":true,"ln":230,"content":"+"},{"type":"add","add":true,"ln":231,"content":"+static void"},{"type":"add","add":true,"ln":232,"content":"+ShutdownPangoLib()"},{"type":"add","add":true,"ln":233,"content":"+{"},{"type":"add","add":true,"ln":234,"content":"+}"},{"type":"add","add":true,"ln":235,"content":"+"},{"type":"add","add":true,"ln":236,"content":"+static void"},{"type":"add","add":true,"ln":237,"content":"+MOZ_pango_font_description_set_absolute_size(PangoFontDescription *desc,"},{"type":"add","add":true,"ln":238,"content":"+                                             double size)"},{"type":"add","add":true,"ln":239,"content":"+{"},{"type":"add","add":true,"ln":240,"content":"+    if (PTR_pango_font_description_set_absolute_size) {"},{"type":"add","add":true,"ln":241,"content":"+        PTR_pango_font_description_set_absolute_size(desc, size);"},{"type":"add","add":true,"ln":242,"content":"+    } else {"},{"type":"add","add":true,"ln":243,"content":"+        pango_font_description_set_size(desc,"},{"type":"add","add":true,"ln":244,"content":"+                                        (gint)(size * 72.0 /"},{"type":"add","add":true,"ln":245,"content":"+                                               gfxPlatformGtk::DPI()));"},{"type":"add","add":true,"ln":246,"content":"+    }"},{"type":"add","add":true,"ln":247,"content":"+}"},{"type":"add","add":true,"ln":248,"content":"+#else"},{"type":"add","add":true,"ln":249,"content":"+static inline void InitPangoLib()"},{"type":"add","add":true,"ln":250,"content":"+{"},{"type":"add","add":true,"ln":251,"content":"+}"},{"type":"add","add":true,"ln":252,"content":"+"},{"type":"add","add":true,"ln":253,"content":"+static inline void ShutdownPangoLib()"},{"type":"add","add":true,"ln":254,"content":"+{"},{"type":"add","add":true,"ln":255,"content":"+}"},{"type":"add","add":true,"ln":256,"content":"+"},{"type":"add","add":true,"ln":257,"content":"+static inline void"},{"type":"add","add":true,"ln":258,"content":"+MOZ_pango_font_description_set_absolute_size(PangoFontDescription *desc, double size)"},{"type":"add","add":true,"ln":259,"content":"+{"},{"type":"add","add":true,"ln":260,"content":"+    pango_font_description_set_absolute_size(desc, size);"},{"type":"add","add":true,"ln":261,"content":"+}"},{"type":"add","add":true,"ln":262,"content":"+#endif"},{"type":"add","add":true,"ln":263,"content":"+"},{"type":"normal","normal":true,"ln1":187,"ln2":264,"content":" gfxPangoFont::gfxPangoFont(const nsAString &aName,"},{"type":"normal","normal":true,"ln1":188,"ln2":265,"content":"                            const gfxFontStyle *aFontStyle)"},{"type":"normal","normal":true,"ln1":189,"ln2":266,"content":"     : gfxFont(aName, aFontStyle),"},{"type":"del","del":true,"ln":190,"content":"-    mPangoFontDesc(nsnull), mPangoCtx(nsnull), mPangoFont(nsnull),"},{"type":"del","del":true,"ln":191,"content":"-    mCairoFont(nsnull), mHasMetrics(PR_FALSE), mAdjustedSize(0)"},{"type":"add","add":true,"ln":267,"content":"+    mPangoFontDesc(nsnull), mPangoCtx(nsnull),"},{"type":"add","add":true,"ln":268,"content":"+    mXftFont(nsnull), mPangoFont(nsnull), mGlyphTestingFont(nsnull),"},{"type":"add","add":true,"ln":269,"content":"+    mCairoFont(nsnull), mHasMetrics(PR_FALSE),"},{"type":"add","add":true,"ln":270,"content":"+    mAdjustedSize(0)"},{"type":"normal","normal":true,"ln1":192,"ln2":271,"content":" {"},{"type":"add","add":true,"ln":272,"content":"+    InitPangoLib();"},{"type":"normal","normal":true,"ln1":193,"ln2":273,"content":" }"},{"type":"normal","normal":true,"ln1":194,"ln2":274,"content":" "},{"type":"normal","normal":true,"ln1":195,"ln2":275,"content":" gfxPangoFont::~gfxPangoFont()"}],"oldStart":184,"oldLines":12,"newStart":194,"newLines":82},{"content":"@@ -200,6 +280,9 @@ gfxPangoFont::~gfxPangoFont()","changes":[{"type":"normal","normal":true,"ln1":200,"ln2":280,"content":"     if (mPangoFont)"},{"type":"normal","normal":true,"ln1":201,"ln2":281,"content":"         g_object_unref(mPangoFont);"},{"type":"normal","normal":true,"ln1":202,"ln2":282,"content":" "},{"type":"add","add":true,"ln":283,"content":"+    if (mGlyphTestingFont)"},{"type":"add","add":true,"ln":284,"content":"+        g_object_unref(mGlyphTestingFont);"},{"type":"add","add":true,"ln":285,"content":"+"},{"type":"normal","normal":true,"ln1":203,"ln2":286,"content":"     if (mPangoFontDesc)"},{"type":"normal","normal":true,"ln1":204,"ln2":287,"content":"         pango_font_description_free(mPangoFontDesc);"},{"type":"normal","normal":true,"ln1":205,"ln2":288,"content":" "}],"oldStart":200,"oldLines":6,"newStart":280,"newLines":9},{"content":"@@ -210,12 +293,9 @@ gfxPangoFont::~gfxPangoFont()","changes":[{"type":"normal","normal":true,"ln1":210,"ln2":293,"content":" /* static */ void"},{"type":"normal","normal":true,"ln1":211,"ln2":294,"content":" gfxPangoFont::Shutdown()"},{"type":"normal","normal":true,"ln1":212,"ln2":295,"content":" {"},{"type":"add","add":true,"ln":296,"content":"+    ShutdownPangoLib();"},{"type":"normal","normal":true,"ln1":213,"ln2":297,"content":"     gfxPangoFontCache::Shutdown();"},{"type":"del","del":true,"ln":214,"content":"-"},{"type":"del","del":true,"ln":215,"content":"-    PangoFontMap *fontmap = pango_cairo_font_map_get_default ();"},{"type":"del","del":true,"ln":216,"content":"-    if (PANGO_IS_FC_FONT_MAP (fontmap))"},{"type":"del","del":true,"ln":217,"content":"-        pango_fc_font_map_shutdown (PANGO_FC_FONT_MAP (fontmap));"},{"type":"del","del":true,"ln":218,"content":"-"},{"type":"add","add":true,"ln":298,"content":"+    gfxPangoFontNameMap::Shutdown();"},{"type":"normal","normal":true,"ln1":219,"ln2":299,"content":" }"},{"type":"normal","normal":true,"ln1":220,"ln2":300,"content":" "},{"type":"normal","normal":true,"ln1":221,"ln2":301,"content":" static PangoStyle"}],"oldStart":210,"oldLines":12,"newStart":293,"newLines":9},{"content":"@@ -295,24 +375,28 @@ gfxPangoFont::RealizeFont(PRBool force)","changes":[{"type":"normal","normal":true,"ln1":295,"ln2":375,"content":"     if (mPangoFont) {"},{"type":"normal","normal":true,"ln1":296,"ln2":376,"content":"         g_object_unref(mPangoFont);"},{"type":"normal","normal":true,"ln1":297,"ln2":377,"content":"         mPangoFont = nsnull;"},{"type":"add","add":true,"ln":378,"content":"+        mXftFont = nsnull;"},{"type":"add","add":true,"ln":379,"content":"+        // XXX we don't need to reset mGlyphTestingFont"},{"type":"normal","normal":true,"ln1":298,"ln2":380,"content":"     }"},{"type":"normal","normal":true,"ln1":299,"ln2":381,"content":" "},{"type":"normal","normal":true,"ln1":300,"ln2":382,"content":"     mPangoFontDesc = pango_font_description_new();"},{"type":"normal","normal":true,"ln1":301,"ln2":383,"content":" "},{"type":"normal","normal":true,"ln1":302,"ln2":384,"content":"     pango_font_description_set_family(mPangoFontDesc, NS_ConvertUTF16toUTF8(mName).get());"},{"type":"normal","normal":true,"ln1":303,"ln2":385,"content":"     gfxFloat size = mAdjustedSize ? mAdjustedSize : GetStyle()->size;"},{"type":"del","del":true,"ln":304,"content":"-    pango_font_description_set_absolute_size(mPangoFontDesc, size * PANGO_SCALE);"},{"type":"add","add":true,"ln":386,"content":"+    MOZ_pango_font_description_set_absolute_size(mPangoFontDesc, size * PANGO_SCALE);"},{"type":"normal","normal":true,"ln1":305,"ln2":387,"content":"     pango_font_description_set_style(mPangoFontDesc, ThebesStyleToPangoStyle(GetStyle()));"},{"type":"normal","normal":true,"ln1":306,"ln2":388,"content":"     pango_font_description_set_weight(mPangoFontDesc, ThebesStyleToPangoWeight(GetStyle()));"},{"type":"normal","normal":true,"ln1":307,"ln2":389,"content":" "},{"type":"normal","normal":true,"ln1":308,"ln2":390,"content":"     //printf (\"%s, %f, %d, %d\\n\", NS_ConvertUTF16toUTF8(mName).get(), GetStyle()->size, ThebesStyleToPangoStyle(GetStyle()), ThebesStyleToPangoWeight(GetStyle()));"},{"type":"del","del":true,"ln":309,"content":"-    mPangoCtx = gdk_pango_context_get ();"},{"type":"add","add":true,"ln":391,"content":"+#ifndef THEBES_USE_PANGO_CAIRO"},{"type":"add","add":true,"ln":392,"content":"+    mPangoCtx = pango_xft_get_context(GDK_DISPLAY(), 0);"},{"type":"add","add":true,"ln":393,"content":"+    gdk_pango_context_set_colormap(mPangoCtx, gdk_rgb_get_cmap());"},{"type":"add","add":true,"ln":394,"content":"+#else"},{"type":"add","add":true,"ln":395,"content":"+    mPangoCtx = pango_cairo_font_map_create_context(PANGO_CAIRO_FONT_MAP(pango_cairo_font_map_get_default()));"},{"type":"add","add":true,"ln":396,"content":"+#endif"},{"type":"normal","normal":true,"ln1":310,"ln2":397,"content":" "},{"type":"del","del":true,"ln":311,"content":"-    if (!GetStyle()->langGroup.IsEmpty()) {"},{"type":"del","del":true,"ln":312,"content":"-        PangoLanguage *lang = GetPangoLanguage(GetStyle()->langGroup);"},{"type":"del","del":true,"ln":313,"content":"-        if (lang)"},{"type":"del","del":true,"ln":314,"content":"-            pango_context_set_language(mPangoCtx, lang);"},{"type":"del","del":true,"ln":315,"content":"-    }"},{"type":"add","add":true,"ln":398,"content":"+    if (!GetStyle()->langGroup.IsEmpty())"},{"type":"add","add":true,"ln":399,"content":"+        pango_context_set_language(mPangoCtx, GetPangoLanguage(GetStyle()->langGroup));"},{"type":"normal","normal":true,"ln1":316,"ln2":400,"content":" "},{"type":"normal","normal":true,"ln1":317,"ln2":401,"content":"     pango_context_set_font_description(mPangoCtx, mPangoFontDesc);"},{"type":"normal","normal":true,"ln1":318,"ln2":402,"content":" "}],"oldStart":295,"oldLines":24,"newStart":375,"newLines":28},{"content":"@@ -333,6 +417,20 @@ gfxPangoFont::RealizeFont(PRBool force)","changes":[{"type":"normal","normal":true,"ln1":333,"ln2":417,"content":" }"},{"type":"normal","normal":true,"ln1":334,"ln2":418,"content":" "},{"type":"normal","normal":true,"ln1":335,"ln2":419,"content":" void"},{"type":"add","add":true,"ln":420,"content":"+gfxPangoFont::RealizeXftFont(PRBool force)"},{"type":"add","add":true,"ln":421,"content":"+{"},{"type":"add","add":true,"ln":422,"content":"+    // already realized?"},{"type":"add","add":true,"ln":423,"content":"+    if (!force && mXftFont)"},{"type":"add","add":true,"ln":424,"content":"+        return;"},{"type":"add","add":true,"ln":425,"content":"+    if (GDK_DISPLAY() == 0) {"},{"type":"add","add":true,"ln":426,"content":"+        mXftFont = nsnull;"},{"type":"add","add":true,"ln":427,"content":"+        return;"},{"type":"add","add":true,"ln":428,"content":"+    }"},{"type":"add","add":true,"ln":429,"content":"+"},{"type":"add","add":true,"ln":430,"content":"+    mXftFont = pango_xft_font_get_font(GetPangoFont());"},{"type":"add","add":true,"ln":431,"content":"+}"},{"type":"add","add":true,"ln":432,"content":"+"},{"type":"add","add":true,"ln":433,"content":"+void"},{"type":"normal","normal":true,"ln1":336,"ln2":434,"content":" gfxPangoFont::RealizePangoFont(PRBool aForce)"},{"type":"normal","normal":true,"ln1":337,"ln2":435,"content":" {"},{"type":"normal","normal":true,"ln1":338,"ln2":436,"content":"     if (!aForce && mPangoFont)"}],"oldStart":333,"oldLines":6,"newStart":417,"newLines":20},{"content":"@@ -340,6 +438,7 @@ gfxPangoFont::RealizePangoFont(PRBool aForce)","changes":[{"type":"normal","normal":true,"ln1":340,"ln2":438,"content":"     if (mPangoFont) {"},{"type":"normal","normal":true,"ln1":341,"ln2":439,"content":"         g_object_unref(mPangoFont);"},{"type":"normal","normal":true,"ln1":342,"ln2":440,"content":"         mPangoFont = nsnull;"},{"type":"add","add":true,"ln":441,"content":"+        mXftFont = nsnull;"},{"type":"normal","normal":true,"ln1":343,"ln2":442,"content":"     }"},{"type":"normal","normal":true,"ln1":344,"ln2":443,"content":"     RealizeFont();"},{"type":"normal","normal":true,"ln1":345,"ln2":444,"content":"     gfxPangoFontCache *cache = gfxPangoFontCache::GetPangoFontCache();"}],"oldStart":340,"oldLines":6,"newStart":438,"newLines":7},{"content":"@@ -352,6 +451,19 @@ gfxPangoFont::RealizePangoFont(PRBool aForce)","changes":[{"type":"normal","normal":true,"ln1":352,"ln2":451,"content":"     if (!mPangoFont)"},{"type":"normal","normal":true,"ln1":353,"ln2":452,"content":"         return; // Error"},{"type":"normal","normal":true,"ln1":354,"ln2":453,"content":"     cache->Put(mPangoFontDesc, mPangoFont);"},{"type":"add","add":true,"ln":454,"content":"+"},{"type":"add","add":true,"ln":455,"content":"+    if (mGlyphTestingFont)"},{"type":"add","add":true,"ln":456,"content":"+        return;"},{"type":"add","add":true,"ln":457,"content":"+"},{"type":"add","add":true,"ln":458,"content":"+    // Append this to font name map"},{"type":"add","add":true,"ln":459,"content":"+    gfxPangoFontNameMap *fontNameMap = gfxPangoFontNameMap::GetPangoFontNameMap();"},{"type":"add","add":true,"ln":460,"content":"+    if (!fontNameMap)"},{"type":"add","add":true,"ln":461,"content":"+        return; // Error"},{"type":"add","add":true,"ln":462,"content":"+    NS_ConvertUTF16toUTF8 name(mName);"},{"type":"add","add":true,"ln":463,"content":"+    mGlyphTestingFont = fontNameMap->Get(name);"},{"type":"add","add":true,"ln":464,"content":"+    if (mGlyphTestingFont)"},{"type":"add","add":true,"ln":465,"content":"+        return;"},{"type":"add","add":true,"ln":466,"content":"+    fontNameMap->Put(name, mPangoFont);"},{"type":"normal","normal":true,"ln1":355,"ln2":467,"content":" }"},{"type":"normal","normal":true,"ln1":356,"ln2":468,"content":" "},{"type":"normal","normal":true,"ln1":357,"ln2":469,"content":" void"}],"oldStart":352,"oldLines":6,"newStart":451,"newLines":19},{"content":"@@ -408,6 +520,89 @@ gfxPangoFont::GetMetrics()","changes":[{"type":"normal","normal":true,"ln1":408,"ln2":520,"content":"     if (mHasMetrics)"},{"type":"normal","normal":true,"ln1":409,"ln2":521,"content":"         return mMetrics;"},{"type":"normal","normal":true,"ln1":410,"ln2":522,"content":" "},{"type":"add","add":true,"ln":523,"content":"+#ifndef THEBES_USE_PANGO_CAIRO"},{"type":"add","add":true,"ln":524,"content":"+    float val;"},{"type":"add","add":true,"ln":525,"content":"+"},{"type":"add","add":true,"ln":526,"content":"+    XftFont *xftFont = GetXftFont(); // RealizeFont is called here."},{"type":"add","add":true,"ln":527,"content":"+    if (!xftFont)"},{"type":"add","add":true,"ln":528,"content":"+        return mMetrics;        // XXX error"},{"type":"add","add":true,"ln":529,"content":"+"},{"type":"add","add":true,"ln":530,"content":"+    FT_Face face = XftLockFace(xftFont);"},{"type":"add","add":true,"ln":531,"content":"+    if (!face)"},{"type":"add","add":true,"ln":532,"content":"+        return mMetrics;        // XXX error"},{"type":"add","add":true,"ln":533,"content":"+"},{"type":"add","add":true,"ln":534,"content":"+    int size;"},{"type":"add","add":true,"ln":535,"content":"+    PangoFcFont *fcfont = PANGO_FC_FONT(mPangoFont);"},{"type":"add","add":true,"ln":536,"content":"+    if (FcPatternGetInteger(fcfont->font_pattern, FC_PIXEL_SIZE, 0, &size) != FcResultMatch)"},{"type":"add","add":true,"ln":537,"content":"+        size = 12;"},{"type":"add","add":true,"ln":538,"content":"+    mMetrics.emHeight = PR_MAX(1, size);"},{"type":"add","add":true,"ln":539,"content":"+"},{"type":"add","add":true,"ln":540,"content":"+    mMetrics.maxAscent = xftFont->ascent;"},{"type":"add","add":true,"ln":541,"content":"+    mMetrics.maxDescent = xftFont->descent;"},{"type":"add","add":true,"ln":542,"content":"+"},{"type":"add","add":true,"ln":543,"content":"+    double lineHeight = mMetrics.maxAscent + mMetrics.maxDescent;"},{"type":"add","add":true,"ln":544,"content":"+"},{"type":"add","add":true,"ln":545,"content":"+    if (lineHeight > mMetrics.emHeight)"},{"type":"add","add":true,"ln":546,"content":"+        mMetrics.internalLeading = lineHeight - mMetrics.emHeight;"},{"type":"add","add":true,"ln":547,"content":"+    else"},{"type":"add","add":true,"ln":548,"content":"+        mMetrics.internalLeading = 0;"},{"type":"add","add":true,"ln":549,"content":"+    mMetrics.externalLeading = 0;"},{"type":"add","add":true,"ln":550,"content":"+"},{"type":"add","add":true,"ln":551,"content":"+    mMetrics.maxHeight = lineHeight;"},{"type":"add","add":true,"ln":552,"content":"+    mMetrics.emAscent = mMetrics.maxAscent * mMetrics.emHeight / lineHeight;"},{"type":"add","add":true,"ln":553,"content":"+    mMetrics.emDescent = mMetrics.emHeight - mMetrics.emAscent;"},{"type":"add","add":true,"ln":554,"content":"+    mMetrics.maxAdvance = xftFont->max_advance_width;"},{"type":"add","add":true,"ln":555,"content":"+"},{"type":"add","add":true,"ln":556,"content":"+    gfxSize isz, lsz;"},{"type":"add","add":true,"ln":557,"content":"+    GetCharSize(' ', isz, lsz, &mSpaceGlyph);"},{"type":"add","add":true,"ln":558,"content":"+    mMetrics.spaceWidth = lsz.width;"},{"type":"add","add":true,"ln":559,"content":"+"},{"type":"add","add":true,"ln":560,"content":"+    // XXX do some FcCharSetHasChar work here to make sure"},{"type":"add","add":true,"ln":561,"content":"+    // we have an \"x\""},{"type":"add","add":true,"ln":562,"content":"+    GetCharSize('x', isz, lsz);"},{"type":"add","add":true,"ln":563,"content":"+    mMetrics.xHeight = isz.height;"},{"type":"add","add":true,"ln":564,"content":"+    mMetrics.aveCharWidth = isz.width;"},{"type":"add","add":true,"ln":565,"content":"+"},{"type":"add","add":true,"ln":566,"content":"+    val = CONVERT_DESIGN_UNITS_TO_PIXELS(face->underline_position,"},{"type":"add","add":true,"ln":567,"content":"+                                         face->size->metrics.y_scale);"},{"type":"add","add":true,"ln":568,"content":"+    if (!val)"},{"type":"add","add":true,"ln":569,"content":"+        val = - PR_MAX(1, floor(0.1 * xftFont->height + 0.5));"},{"type":"add","add":true,"ln":570,"content":"+"},{"type":"add","add":true,"ln":571,"content":"+    mMetrics.underlineOffset = val;"},{"type":"add","add":true,"ln":572,"content":"+"},{"type":"add","add":true,"ln":573,"content":"+    val = CONVERT_DESIGN_UNITS_TO_PIXELS(face->underline_thickness,"},{"type":"add","add":true,"ln":574,"content":"+                                         face->size->metrics.y_scale);"},{"type":"add","add":true,"ln":575,"content":"+    if (!val)"},{"type":"add","add":true,"ln":576,"content":"+        val = floor(0.05 * xftFont->height + 0.5);"},{"type":"add","add":true,"ln":577,"content":"+"},{"type":"add","add":true,"ln":578,"content":"+    mMetrics.underlineSize = PR_MAX(1, val);"},{"type":"add","add":true,"ln":579,"content":"+"},{"type":"add","add":true,"ln":580,"content":"+    TT_OS2 *os2 = (TT_OS2 *) FT_Get_Sfnt_Table(face, ft_sfnt_os2);"},{"type":"add","add":true,"ln":581,"content":"+"},{"type":"add","add":true,"ln":582,"content":"+    if (os2 && os2->ySuperscriptYOffset) {"},{"type":"add","add":true,"ln":583,"content":"+        val = CONVERT_DESIGN_UNITS_TO_PIXELS(os2->ySuperscriptYOffset,"},{"type":"add","add":true,"ln":584,"content":"+                                             face->size->metrics.y_scale);"},{"type":"add","add":true,"ln":585,"content":"+        mMetrics.superscriptOffset = PR_MAX(1, val);"},{"type":"add","add":true,"ln":586,"content":"+    } else {"},{"type":"add","add":true,"ln":587,"content":"+        mMetrics.superscriptOffset = mMetrics.xHeight;"},{"type":"add","add":true,"ln":588,"content":"+    }"},{"type":"add","add":true,"ln":589,"content":"+"},{"type":"add","add":true,"ln":590,"content":"+    // mSubscriptOffset"},{"type":"add","add":true,"ln":591,"content":"+    if (os2 && os2->ySubscriptYOffset) {"},{"type":"add","add":true,"ln":592,"content":"+        val = CONVERT_DESIGN_UNITS_TO_PIXELS(os2->ySubscriptYOffset,"},{"type":"add","add":true,"ln":593,"content":"+                                             face->size->metrics.y_scale);"},{"type":"add","add":true,"ln":594,"content":"+        // some fonts have the incorrect sign. "},{"type":"add","add":true,"ln":595,"content":"+        val = (val < 0) ? -val : val;"},{"type":"add","add":true,"ln":596,"content":"+        mMetrics.subscriptOffset = PR_MAX(1, val);"},{"type":"add","add":true,"ln":597,"content":"+    } else {"},{"type":"add","add":true,"ln":598,"content":"+        mMetrics.subscriptOffset = mMetrics.xHeight;"},{"type":"add","add":true,"ln":599,"content":"+    }"},{"type":"add","add":true,"ln":600,"content":"+"},{"type":"add","add":true,"ln":601,"content":"+    mMetrics.strikeoutOffset = mMetrics.xHeight / 2.0;"},{"type":"add","add":true,"ln":602,"content":"+    mMetrics.strikeoutSize = mMetrics.underlineSize;"},{"type":"add","add":true,"ln":603,"content":"+"},{"type":"add","add":true,"ln":604,"content":"+    XftUnlockFace(xftFont);"},{"type":"add","add":true,"ln":605,"content":"+#else"},{"type":"normal","normal":true,"ln1":411,"ln2":606,"content":"     /* pango_cairo case; try to get all the metrics from pango itself */"},{"type":"normal","normal":true,"ln1":412,"ln2":607,"content":"     PangoFont *font = GetPangoFont(); // RealizeFont is called here."},{"type":"normal","normal":true,"ln1":413,"ln2":608,"content":" "}],"oldStart":408,"oldLines":6,"newStart":520,"newLines":89},{"content":"@@ -432,8 +627,7 @@ gfxPangoFont::GetMetrics()","changes":[{"type":"normal","normal":true,"ln1":432,"ln2":627,"content":"     mMetrics.emAscent = mMetrics.maxAscent * mMetrics.emHeight / lineHeight;"},{"type":"normal","normal":true,"ln1":433,"ln2":628,"content":"     mMetrics.emDescent = mMetrics.emHeight - mMetrics.emAscent;"},{"type":"normal","normal":true,"ln1":434,"ln2":629,"content":" "},{"type":"del","del":true,"ln":435,"content":"-    // XXX should we move this down, get max-advance from FT_Face?"},{"type":"del","del":true,"ln":436,"content":"-    mMetrics.maxAdvance = pango_font_metrics_get_approximate_char_width(pfm) / FLOAT_PANGO_SCALE;"},{"type":"add","add":true,"ln":630,"content":"+    mMetrics.maxAdvance = pango_font_metrics_get_approximate_char_width(pfm) / FLOAT_PANGO_SCALE; // XXX"},{"type":"normal","normal":true,"ln1":437,"ln2":631,"content":" "},{"type":"normal","normal":true,"ln1":438,"ln2":632,"content":"     gfxSize isz, lsz;"},{"type":"normal","normal":true,"ln1":439,"ln2":633,"content":"     GetCharSize(' ', isz, lsz, &mSpaceGlyph);"}],"oldStart":432,"oldLines":8,"newStart":627,"newLines":7},{"content":"@@ -449,43 +643,14 @@ gfxPangoFont::GetMetrics()","changes":[{"type":"normal","normal":true,"ln1":449,"ln2":643,"content":"     mMetrics.strikeoutOffset = pango_font_metrics_get_strikethrough_position(pfm) / FLOAT_PANGO_SCALE;"},{"type":"normal","normal":true,"ln1":450,"ln2":644,"content":"     mMetrics.strikeoutSize = pango_font_metrics_get_strikethrough_thickness(pfm) / FLOAT_PANGO_SCALE;"},{"type":"normal","normal":true,"ln1":451,"ln2":645,"content":" "},{"type":"del","del":true,"ln":452,"content":"-    FT_Face face = NULL;"},{"type":"del","del":true,"ln":453,"content":"-    if (PANGO_IS_FC_FONT (font))"},{"type":"del","del":true,"ln":454,"content":"-        face = pango_fc_font_lock_face (PANGO_FC_FONT (font));"},{"type":"del","del":true,"ln":455,"content":"-"},{"type":"del","del":true,"ln":456,"content":"-    if (face) {"},{"type":"del","del":true,"ln":457,"content":"-        float val;"},{"type":"del","del":true,"ln":458,"content":"-"},{"type":"del","del":true,"ln":459,"content":"-        TT_OS2 *os2 = (TT_OS2 *) FT_Get_Sfnt_Table(face, ft_sfnt_os2);"},{"type":"del","del":true,"ln":460,"content":"-    "},{"type":"del","del":true,"ln":461,"content":"-        if (os2 && os2->ySuperscriptYOffset) {"},{"type":"del","del":true,"ln":462,"content":"-            val = CONVERT_DESIGN_UNITS_TO_PIXELS(os2->ySuperscriptYOffset,"},{"type":"del","del":true,"ln":463,"content":"-                                                 face->size->metrics.y_scale);"},{"type":"del","del":true,"ln":464,"content":"-            mMetrics.superscriptOffset = PR_MAX(1, val);"},{"type":"del","del":true,"ln":465,"content":"-        } else {"},{"type":"del","del":true,"ln":466,"content":"-            mMetrics.superscriptOffset = mMetrics.xHeight;"},{"type":"del","del":true,"ln":467,"content":"-        }"},{"type":"del","del":true,"ln":468,"content":"-    "},{"type":"del","del":true,"ln":469,"content":"-        // mSubscriptOffset"},{"type":"del","del":true,"ln":470,"content":"-        if (os2 && os2->ySubscriptYOffset) {"},{"type":"del","del":true,"ln":471,"content":"-            val = CONVERT_DESIGN_UNITS_TO_PIXELS(os2->ySubscriptYOffset,"},{"type":"del","del":true,"ln":472,"content":"-                                                 face->size->metrics.y_scale);"},{"type":"del","del":true,"ln":473,"content":"-            // some fonts have the incorrect sign. "},{"type":"del","del":true,"ln":474,"content":"-            val = (val < 0) ? -val : val;"},{"type":"del","del":true,"ln":475,"content":"-            mMetrics.subscriptOffset = PR_MAX(1, val);"},{"type":"del","del":true,"ln":476,"content":"-        } else {"},{"type":"del","del":true,"ln":477,"content":"-            mMetrics.subscriptOffset = mMetrics.xHeight;"},{"type":"del","del":true,"ln":478,"content":"-        }"},{"type":"del","del":true,"ln":479,"content":"-"},{"type":"del","del":true,"ln":480,"content":"-        pango_fc_font_unlock_face(PANGO_FC_FONT(font));"},{"type":"del","del":true,"ln":481,"content":"-    } else {"},{"type":"del","del":true,"ln":482,"content":"-"},{"type":"del","del":true,"ln":483,"content":"-        mMetrics.superscriptOffset = mMetrics.xHeight;"},{"type":"del","del":true,"ln":484,"content":"-        mMetrics.subscriptOffset = mMetrics.xHeight;"},{"type":"del","del":true,"ln":485,"content":"-    }"},{"type":"del","del":true,"ln":486,"content":"-"},{"type":"add","add":true,"ln":646,"content":"+    // these are specified by the so-called OS2 SFNT info, but"},{"type":"add","add":true,"ln":647,"content":"+    // pango doesn't expose this to us.  This really sucks,"},{"type":"add","add":true,"ln":648,"content":"+    // so we just assume it's the xHeight"},{"type":"add","add":true,"ln":649,"content":"+    mMetrics.superscriptOffset = mMetrics.xHeight;"},{"type":"add","add":true,"ln":650,"content":"+    mMetrics.subscriptOffset = mMetrics.xHeight;"},{"type":"normal","normal":true,"ln1":487,"ln2":651,"content":" "},{"type":"normal","normal":true,"ln1":488,"ln2":652,"content":"     pango_font_metrics_unref (pfm);"},{"type":"add","add":true,"ln":653,"content":"+#endif"},{"type":"normal","normal":true,"ln1":489,"ln2":654,"content":" "},{"type":"normal","normal":true,"ln1":490,"ln2":655,"content":" #if 0"},{"type":"normal","normal":true,"ln1":491,"ln2":656,"content":"     fprintf (stderr, \"Font: %s\\n\", NS_ConvertUTF16toUTF8(mName).get());"}],"oldStart":449,"oldLines":43,"newStart":643,"newLines":14},{"content":"@@ -500,13 +665,66 @@ gfxPangoFont::GetMetrics()","changes":[{"type":"normal","normal":true,"ln1":500,"ln2":665,"content":"     return mMetrics;"},{"type":"normal","normal":true,"ln1":501,"ln2":666,"content":" }"},{"type":"normal","normal":true,"ln1":502,"ln2":667,"content":" "},{"type":"add","add":true,"ln":668,"content":"+// XXX we should replace this to |pango_is_zero_width| after we don't support pre pango 1.10"},{"type":"add","add":true,"ln":669,"content":"+static PRBool MOZ_pango_is_zero_width(PRUint32 aChar)"},{"type":"add","add":true,"ln":670,"content":"+{"},{"type":"add","add":true,"ln":671,"content":"+    if (aChar == 0x00AD)"},{"type":"add","add":true,"ln":672,"content":"+        return PR_TRUE;"},{"type":"add","add":true,"ln":673,"content":"+    if (aChar < 0x200B)"},{"type":"add","add":true,"ln":674,"content":"+        return PR_FALSE;"},{"type":"add","add":true,"ln":675,"content":"+    if (aChar <= 0x200F || aChar == 0x2028)"},{"type":"add","add":true,"ln":676,"content":"+        return PR_TRUE;"},{"type":"add","add":true,"ln":677,"content":"+    if (aChar < 0x202A)"},{"type":"add","add":true,"ln":678,"content":"+        return PR_FALSE;"},{"type":"add","add":true,"ln":679,"content":"+    if (aChar <= 0x202E)"},{"type":"add","add":true,"ln":680,"content":"+        return PR_TRUE;"},{"type":"add","add":true,"ln":681,"content":"+    if (aChar < 0x2060)"},{"type":"add","add":true,"ln":682,"content":"+        return PR_FALSE;"},{"type":"add","add":true,"ln":683,"content":"+    if (aChar <= 0x2063 || aChar == 0xFEFF)"},{"type":"add","add":true,"ln":684,"content":"+        return PR_TRUE;"},{"type":"add","add":true,"ln":685,"content":"+    return PR_FALSE;"},{"type":"add","add":true,"ln":686,"content":"+}"},{"type":"add","add":true,"ln":687,"content":"+PRBool"},{"type":"add","add":true,"ln":688,"content":"+gfxPangoFont::HasGlyph(PRUint32 aChar)"},{"type":"add","add":true,"ln":689,"content":"+{"},{"type":"add","add":true,"ln":690,"content":"+    // Ensure that null character should be missing."},{"type":"add","add":true,"ln":691,"content":"+    if (aChar == 0)"},{"type":"add","add":true,"ln":692,"content":"+        return PR_FALSE;"},{"type":"add","add":true,"ln":693,"content":"+"},{"type":"add","add":true,"ln":694,"content":"+    if (MOZ_pango_is_zero_width(aChar))"},{"type":"add","add":true,"ln":695,"content":"+        return PR_TRUE;"},{"type":"add","add":true,"ln":696,"content":"+"},{"type":"add","add":true,"ln":697,"content":"+    PangoFont *font = nsnull;"},{"type":"add","add":true,"ln":698,"content":"+    if (mPangoFont)"},{"type":"add","add":true,"ln":699,"content":"+        font = mPangoFont;"},{"type":"add","add":true,"ln":700,"content":"+    else if (mGlyphTestingFont)"},{"type":"add","add":true,"ln":701,"content":"+        font = mGlyphTestingFont;"},{"type":"add","add":true,"ln":702,"content":"+    else {"},{"type":"add","add":true,"ln":703,"content":"+        gfxPangoFontNameMap *fontNameMap = gfxPangoFontNameMap::GetPangoFontNameMap();"},{"type":"add","add":true,"ln":704,"content":"+        NS_ENSURE_TRUE(fontNameMap, PR_FALSE);"},{"type":"add","add":true,"ln":705,"content":"+        // XXX in a prinsiple, we need to add weight and style for the key."},{"type":"add","add":true,"ln":706,"content":"+        // But this method should be independent from pango for the performance."},{"type":"add","add":true,"ln":707,"content":"+        // For the temporary, the name is enough for the key. The members of"},{"type":"add","add":true,"ln":708,"content":"+        // a font-family should have same glyphs."},{"type":"add","add":true,"ln":709,"content":"+        NS_ConvertUTF16toUTF8 name(mName);"},{"type":"add","add":true,"ln":710,"content":"+        mGlyphTestingFont = fontNameMap->Get(name);"},{"type":"add","add":true,"ln":711,"content":"+        if (!mGlyphTestingFont) {"},{"type":"add","add":true,"ln":712,"content":"+            font = GetPangoFont();"},{"type":"add","add":true,"ln":713,"content":"+            NS_ENSURE_TRUE(font, PR_FALSE);"},{"type":"add","add":true,"ln":714,"content":"+        } else"},{"type":"add","add":true,"ln":715,"content":"+            font = mGlyphTestingFont;"},{"type":"add","add":true,"ln":716,"content":"+    }"},{"type":"add","add":true,"ln":717,"content":"+    return pango_fc_font_has_char(PANGO_FC_FONT(font), aChar) ? PR_TRUE : PR_FALSE;"},{"type":"add","add":true,"ln":718,"content":"+}"},{"type":"add","add":true,"ln":719,"content":"+"},{"type":"normal","normal":true,"ln1":503,"ln2":720,"content":" PRUint32"},{"type":"normal","normal":true,"ln1":504,"ln2":721,"content":" gfxPangoFont::GetGlyph(const PRUint32 aChar)"},{"type":"normal","normal":true,"ln1":505,"ln2":722,"content":" {"},{"type":"normal","normal":true,"ln1":506,"ln2":723,"content":"     // Ensure that null character should be missing."},{"type":"normal","normal":true,"ln1":507,"ln2":724,"content":"     if (aChar == 0)"},{"type":"normal","normal":true,"ln1":508,"ln2":725,"content":"         return 0;"},{"type":"del","del":true,"ln":509,"content":"-    return pango_fc_font_get_glyph(PANGO_FC_FONT(GetPangoFont()), aChar);"},{"type":"add","add":true,"ln":726,"content":"+    RealizePangoFont();"},{"type":"add","add":true,"ln":727,"content":"+    return pango_fc_font_get_glyph(PANGO_FC_FONT(mPangoFont), aChar);"},{"type":"normal","normal":true,"ln1":510,"ln2":728,"content":" }"},{"type":"normal","normal":true,"ln1":511,"ln2":729,"content":" "},{"type":"normal","normal":true,"ln1":512,"ln2":730,"content":" nsString"}],"oldStart":500,"oldLines":13,"newStart":665,"newLines":66},{"content":"@@ -514,9 +732,16 @@ gfxPangoFont::GetUniqueName()","changes":[{"type":"normal","normal":true,"ln1":514,"ln2":732,"content":" {"},{"type":"normal","normal":true,"ln1":515,"ln2":733,"content":"     PangoFont *font = GetPangoFont();"},{"type":"normal","normal":true,"ln1":516,"ln2":734,"content":"     PangoFontDescription *desc = pango_font_describe(font);"},{"type":"del","del":true,"ln":517,"content":"-    pango_font_description_unset_fields (desc, PANGO_FONT_MASK_SIZE);"},{"type":"normal","normal":true,"ln1":518,"ln2":735,"content":"     char *str = pango_font_description_to_string(desc);"},{"type":"del","del":true,"ln":519,"content":"-    pango_font_description_free (desc);"},{"type":"add","add":true,"ln":736,"content":"+"},{"type":"add","add":true,"ln":737,"content":"+    // chop off the trailing size, e.g. \"Albany AMT 15.359375\" -> \"Albany AMT\""},{"type":"add","add":true,"ln":738,"content":"+    PRUint32 end = strlen(str);"},{"type":"add","add":true,"ln":739,"content":"+    while (end > 0) {"},{"type":"add","add":true,"ln":740,"content":"+        --end;"},{"type":"add","add":true,"ln":741,"content":"+        if (str[end] == ' ')"},{"type":"add","add":true,"ln":742,"content":"+            break;"},{"type":"add","add":true,"ln":743,"content":"+    }"},{"type":"add","add":true,"ln":744,"content":"+    str[end] = 0;"},{"type":"normal","normal":true,"ln1":520,"ln2":745,"content":" "},{"type":"normal","normal":true,"ln1":521,"ln2":746,"content":"     nsString result;"},{"type":"normal","normal":true,"ln1":522,"ln2":747,"content":"     CopyUTF8toUTF16(str, result);"}],"oldStart":514,"oldLines":9,"newStart":732,"newLines":16},{"content":"@@ -524,6 +749,32 @@ gfxPangoFont::GetUniqueName()","changes":[{"type":"normal","normal":true,"ln1":524,"ln2":749,"content":"     return result;"},{"type":"normal","normal":true,"ln1":525,"ln2":750,"content":" }"},{"type":"normal","normal":true,"ln1":526,"ln2":751,"content":" "},{"type":"add","add":true,"ln":752,"content":"+static const char *sCJKLangGroup[] = {"},{"type":"add","add":true,"ln":753,"content":"+    \"ja\","},{"type":"add","add":true,"ln":754,"content":"+    \"ko\","},{"type":"add","add":true,"ln":755,"content":"+    \"zh-CN\","},{"type":"add","add":true,"ln":756,"content":"+    \"zh-HK\","},{"type":"add","add":true,"ln":757,"content":"+    \"zh-TW\""},{"type":"add","add":true,"ln":758,"content":"+};"},{"type":"add","add":true,"ln":759,"content":"+"},{"type":"add","add":true,"ln":760,"content":"+#define COUNT_OF_CJK_LANG_GROUP 5"},{"type":"add","add":true,"ln":761,"content":"+#define CJK_LANG_JA    sCJKLangGroup[0]"},{"type":"add","add":true,"ln":762,"content":"+#define CJK_LANG_KO    sCJKLangGroup[1]"},{"type":"add","add":true,"ln":763,"content":"+#define CJK_LANG_ZH_CN sCJKLangGroup[2]"},{"type":"add","add":true,"ln":764,"content":"+#define CJK_LANG_ZH_HK sCJKLangGroup[3]"},{"type":"add","add":true,"ln":765,"content":"+#define CJK_LANG_ZH_TW sCJKLangGroup[4]"},{"type":"add","add":true,"ln":766,"content":"+"},{"type":"add","add":true,"ln":767,"content":"+static PRInt32"},{"type":"add","add":true,"ln":768,"content":"+GetCJKLangGroupIndex(const char *aLangGroup)"},{"type":"add","add":true,"ln":769,"content":"+{"},{"type":"add","add":true,"ln":770,"content":"+    PRInt32 i;"},{"type":"add","add":true,"ln":771,"content":"+    for (i = 0; i < COUNT_OF_CJK_LANG_GROUP; i++) {"},{"type":"add","add":true,"ln":772,"content":"+        if (!PL_strcasecmp(aLangGroup, sCJKLangGroup[i]))"},{"type":"add","add":true,"ln":773,"content":"+            return i;"},{"type":"add","add":true,"ln":774,"content":"+    }"},{"type":"add","add":true,"ln":775,"content":"+    return -1;"},{"type":"add","add":true,"ln":776,"content":"+}"},{"type":"add","add":true,"ln":777,"content":"+"},{"type":"normal","normal":true,"ln1":527,"ln2":778,"content":" /**"},{"type":"normal","normal":true,"ln1":528,"ln2":779,"content":"  ** gfxTextRun"},{"type":"normal","normal":true,"ln1":529,"ln2":780,"content":"  * "}],"oldStart":524,"oldLines":6,"newStart":749,"newLines":32},{"content":"@@ -537,6 +788,19 @@ gfxPangoFont::GetUniqueName()","changes":[{"type":"normal","normal":true,"ln1":537,"ln2":788,"content":"  * "},{"type":"normal","normal":true,"ln1":538,"ln2":789,"content":"  **/"},{"type":"normal","normal":true,"ln1":539,"ln2":790,"content":" "},{"type":"add","add":true,"ln":791,"content":"+/**"},{"type":"add","add":true,"ln":792,"content":"+ * We use this to append an LTR or RTL Override character to the start of the"},{"type":"add","add":true,"ln":793,"content":"+ * string. This forces Pango to honour our direction even if there are neutral characters"},{"type":"add","add":true,"ln":794,"content":"+ * in the string."},{"type":"add","add":true,"ln":795,"content":"+ */"},{"type":"add","add":true,"ln":796,"content":"+static PRInt32 AppendDirectionalIndicatorUTF8(PRBool aIsRTL, nsACString& aString)"},{"type":"add","add":true,"ln":797,"content":"+{"},{"type":"add","add":true,"ln":798,"content":"+    static const PRUnichar overrides[2][2] ="},{"type":"add","add":true,"ln":799,"content":"+      { { 0x202d, 0 }, { 0x202e, 0 }}; // LRO, RLO"},{"type":"add","add":true,"ln":800,"content":"+    AppendUTF16toUTF8(overrides[aIsRTL], aString);"},{"type":"add","add":true,"ln":801,"content":"+    return 3; // both overrides map to 3 bytes in UTF8"},{"type":"add","add":true,"ln":802,"content":"+}"},{"type":"add","add":true,"ln":803,"content":"+"},{"type":"normal","normal":true,"ln1":540,"ln2":804,"content":" gfxTextRun *"},{"type":"normal","normal":true,"ln1":541,"ln2":805,"content":" gfxPangoFontGroup::MakeTextRun(const PRUint8 *aString, PRUint32 aLength,"},{"type":"normal","normal":true,"ln1":542,"ln2":806,"content":"                                const Parameters *aParams, PRUint32 aFlags)"}],"oldStart":537,"oldLines":6,"newStart":788,"newLines":19},{"content":"@@ -548,33 +812,35 @@ gfxPangoFontGroup::MakeTextRun(const PRUint8 *aString, PRUint32 aLength,","changes":[{"type":"normal","normal":true,"ln1":548,"ln2":812,"content":" "},{"type":"normal","normal":true,"ln1":549,"ln2":813,"content":"     PRBool isRTL = run->IsRightToLeft();"},{"type":"normal","normal":true,"ln1":550,"ln2":814,"content":"     if ((aFlags & TEXT_IS_ASCII) && !isRTL) {"},{"type":"add","add":true,"ln":815,"content":"+        // We don't need to send an override character here, the characters must be all"},{"type":"add","add":true,"ln":816,"content":"+        // LTR"},{"type":"normal","normal":true,"ln1":551,"ln2":817,"content":"         const gchar *utf8Chars = reinterpret_cast<const gchar*>(aString);"},{"type":"del","del":true,"ln":552,"content":"-        InitTextRun(run, utf8Chars, aLength, PR_TRUE);"},{"type":"add","add":true,"ln":818,"content":"+        InitTextRun(run, utf8Chars, aLength, 0, PR_TRUE);"},{"type":"normal","normal":true,"ln1":553,"ln2":819,"content":"     } else {"},{"type":"del","del":true,"ln":554,"content":"-        // this is really gross..."},{"type":"normal","normal":true,"ln1":555,"ln2":820,"content":"         const char *chars = reinterpret_cast<const char*>(aString);"},{"type":"add","add":true,"ln":821,"content":"+        // XXX this could be more efficient."},{"type":"add","add":true,"ln":822,"content":"+        // Although chars in not necessarily ASCII (as it may point to the low"},{"type":"add","add":true,"ln":823,"content":"+        // bytes of any UCS-2 characters < 256), NS_ConvertASCIItoUTF16 seems"},{"type":"add","add":true,"ln":824,"content":"+        // to DTRT."},{"type":"normal","normal":true,"ln1":556,"ln2":825,"content":"         NS_ConvertASCIItoUTF16 unicodeString(chars, aLength);"},{"type":"del","del":true,"ln":557,"content":"-        NS_ConvertUTF16toUTF8 utf8String(unicodeString);"},{"type":"del","del":true,"ln":558,"content":"-        InitTextRun(run, utf8String.get(), utf8String.Length(), PR_TRUE);"},{"type":"add","add":true,"ln":826,"content":"+        nsCAutoString utf8;"},{"type":"add","add":true,"ln":827,"content":"+        PRInt32 headerLen = AppendDirectionalIndicatorUTF8(isRTL, utf8);"},{"type":"add","add":true,"ln":828,"content":"+        AppendUTF16toUTF8(unicodeString, utf8);"},{"type":"add","add":true,"ln":829,"content":"+        InitTextRun(run, utf8.get(), utf8.Length(), headerLen, PR_TRUE);"},{"type":"normal","normal":true,"ln1":559,"ln2":830,"content":"     }"},{"type":"normal","normal":true,"ln1":560,"ln2":831,"content":"     run->FetchGlyphExtents(aParams->mContext);"},{"type":"normal","normal":true,"ln1":561,"ln2":832,"content":"     return run;"},{"type":"normal","normal":true,"ln1":562,"ln2":833,"content":" }"},{"type":"normal","normal":true,"ln1":563,"ln2":834,"content":" "},{"type":"del","del":true,"ln":564,"content":"-#if defined(ENABLE_FAST_PATH_8BIT)"},{"type":"del","del":true,"ln":565,"content":"-PRBool"},{"type":"del","del":true,"ln":566,"content":"-gfxPangoFontGroup::CanTakeFastPath(PRUint32 aFlags)"},{"type":"add","add":true,"ln":835,"content":"+static PRBool"},{"type":"add","add":true,"ln":836,"content":"+CanTakeFastPath(PRUint32 aFlags)"},{"type":"normal","normal":true,"ln1":567,"ln2":837,"content":" {"},{"type":"del","del":true,"ln":568,"content":"-    if (!PANGO_IS_FC_FONT (GetFontAt(0)->GetPangoFont ()))"},{"type":"del","del":true,"ln":569,"content":"-        return FALSE;"},{"type":"del","del":true,"ln":570,"content":"-"},{"type":"normal","normal":true,"ln1":571,"ln2":838,"content":"     // Can take fast path only if OPTIMIZE_SPEED is set and IS_RTL isn't"},{"type":"normal","normal":true,"ln1":572,"ln2":839,"content":"     // We need to always use Pango for RTL text, in case glyph mirroring is required"},{"type":"normal","normal":true,"ln1":573,"ln2":840,"content":"     return (aFlags &"},{"type":"normal","normal":true,"ln1":574,"ln2":841,"content":"             (gfxTextRunFactory::TEXT_OPTIMIZE_SPEED | gfxTextRunFactory::TEXT_IS_RTL)) =="},{"type":"normal","normal":true,"ln1":575,"ln2":842,"content":"         gfxTextRunFactory::TEXT_OPTIMIZE_SPEED;"},{"type":"normal","normal":true,"ln1":576,"ln2":843,"content":" }"},{"type":"del","del":true,"ln":577,"content":"-#endif"},{"type":"normal","normal":true,"ln1":578,"ln2":844,"content":" "},{"type":"normal","normal":true,"ln1":579,"ln2":845,"content":" gfxTextRun *"},{"type":"normal","normal":true,"ln1":580,"ln2":846,"content":" gfxPangoFontGroup::MakeTextRun(const PRUnichar *aString, PRUint32 aLength,"}],"oldStart":548,"oldLines":33,"newStart":812,"newLines":35},{"content":"@@ -586,10 +852,11 @@ gfxPangoFontGroup::MakeTextRun(const PRUnichar *aString, PRUint32 aLength,","changes":[{"type":"normal","normal":true,"ln1":586,"ln2":852,"content":" "},{"type":"normal","normal":true,"ln1":587,"ln2":853,"content":"     run->RecordSurrogates(aString);"},{"type":"normal","normal":true,"ln1":588,"ln2":854,"content":" "},{"type":"del","del":true,"ln":589,"content":"-    NS_ConvertUTF16toUTF8 utf8(aString, aLength);"},{"type":"add","add":true,"ln":855,"content":"+    nsCAutoString utf8;"},{"type":"add","add":true,"ln":856,"content":"+    PRInt32 headerLen = AppendDirectionalIndicatorUTF8(run->IsRightToLeft(), utf8);"},{"type":"add","add":true,"ln":857,"content":"+    AppendUTF16toUTF8(Substring(aString, aString + aLength), utf8);"},{"type":"normal","normal":true,"ln1":590,"ln2":858,"content":"     PRBool is8Bit = PR_FALSE;"},{"type":"del","del":true,"ln":591,"content":"-"},{"type":"del","del":true,"ln":592,"content":"-#if defined(ENABLE_FAST_PATH_8BIT)"},{"type":"add","add":true,"ln":859,"content":"+#if defined(ENABLE_XFT_FAST_PATH_8BIT)"},{"type":"normal","normal":true,"ln1":593,"ln2":860,"content":"     if (CanTakeFastPath(aFlags)) {"},{"type":"normal","normal":true,"ln1":594,"ln2":861,"content":"         PRUint32 allBits = 0;"},{"type":"normal","normal":true,"ln1":595,"ln2":862,"content":"         PRUint32 i;"}],"oldStart":586,"oldLines":10,"newStart":852,"newLines":11},{"content":"@@ -599,21 +866,22 @@ gfxPangoFontGroup::MakeTextRun(const PRUnichar *aString, PRUint32 aLength,","changes":[{"type":"normal","normal":true,"ln1":599,"ln2":866,"content":"         is8Bit = (allBits & 0xFF00) == 0;"},{"type":"normal","normal":true,"ln1":600,"ln2":867,"content":"     }"},{"type":"normal","normal":true,"ln1":601,"ln2":868,"content":" #endif"},{"type":"del","del":true,"ln":602,"content":"-    InitTextRun(run, utf8.get(), utf8.Length(), is8Bit);"},{"type":"add","add":true,"ln":869,"content":"+    InitTextRun(run, utf8.get(), utf8.Length(), headerLen, is8Bit);"},{"type":"normal","normal":true,"ln1":603,"ln2":870,"content":"     run->FetchGlyphExtents(aParams->mContext);"},{"type":"normal","normal":true,"ln1":604,"ln2":871,"content":"     return run;"},{"type":"normal","normal":true,"ln1":605,"ln2":872,"content":" }"},{"type":"normal","normal":true,"ln1":606,"ln2":873,"content":" "},{"type":"normal","normal":true,"ln1":607,"ln2":874,"content":" void"},{"type":"normal","normal":true,"ln1":608,"ln2":875,"content":" gfxPangoFontGroup::InitTextRun(gfxTextRun *aTextRun, const gchar *aUTF8Text,"},{"type":"del","del":true,"ln":609,"content":"-                               PRUint32 aUTF8Length, PRBool aTake8BitPath)"},{"type":"add","add":true,"ln":876,"content":"+                               PRUint32 aUTF8Length, PRUint32 aUTF8HeaderLength,"},{"type":"add","add":true,"ln":877,"content":"+                               PRBool aTake8BitPath)"},{"type":"normal","normal":true,"ln1":610,"ln2":878,"content":" {"},{"type":"del","del":true,"ln":611,"content":"-#if defined(ENABLE_FAST_PATH_ALWAYS)"},{"type":"del","del":true,"ln":612,"content":"-    CreateGlyphRunsFast(aTextRun, aUTF8Text, aUTF8Length);"},{"type":"add","add":true,"ln":879,"content":"+#if defined(ENABLE_XFT_FAST_PATH_ALWAYS)"},{"type":"add","add":true,"ln":880,"content":"+    CreateGlyphRunsXft(aTextRun, aUTF8Text + aUTF8HeaderLength, aUTF8Length - aUTF8HeaderLength);"},{"type":"normal","normal":true,"ln1":613,"ln2":881,"content":" #else"},{"type":"del","del":true,"ln":614,"content":"-#if defined(ENABLE_FAST_PATH_8BIT)"},{"type":"add","add":true,"ln":882,"content":"+#if defined(ENABLE_XFT_FAST_PATH_8BIT)"},{"type":"normal","normal":true,"ln1":615,"ln2":883,"content":"     if (aTake8BitPath && CanTakeFastPath(aTextRun->GetFlags())) {"},{"type":"del","del":true,"ln":616,"content":"-        CreateGlyphRunsFast(aTextRun, aUTF8Text, aUTF8Length);"},{"type":"add","add":true,"ln":884,"content":"+        CreateGlyphRunsXft(aTextRun, aUTF8Text + aUTF8HeaderLength, aUTF8Length - aUTF8HeaderLength);"},{"type":"normal","normal":true,"ln1":617,"ln2":885,"content":"         return;"},{"type":"normal","normal":true,"ln1":618,"ln2":886,"content":"     }"},{"type":"normal","normal":true,"ln1":619,"ln2":887,"content":" #endif"}],"oldStart":599,"oldLines":21,"newStart":866,"newLines":22},{"content":"@@ -622,20 +890,13 @@ gfxPangoFontGroup::InitTextRun(gfxTextRun *aTextRun, const gchar *aUTF8Text,","changes":[{"type":"normal","normal":true,"ln1":622,"ln2":890,"content":"                                (aTextRun->IsRightToLeft()"},{"type":"normal","normal":true,"ln1":623,"ln2":891,"content":"                                   ? PANGO_DIRECTION_RTL : PANGO_DIRECTION_LTR));"},{"type":"normal","normal":true,"ln1":624,"ln2":892,"content":" "},{"type":"del","del":true,"ln":625,"content":"-    CreateGlyphRunsItemizing(aTextRun, aUTF8Text, aUTF8Length);"},{"type":"add","add":true,"ln":893,"content":"+    CreateGlyphRunsItemizing(aTextRun, aUTF8Text, aUTF8Length, aUTF8HeaderLength);"},{"type":"normal","normal":true,"ln1":626,"ln2":894,"content":" #endif"},{"type":"normal","normal":true,"ln1":627,"ln2":895,"content":" }"},{"type":"normal","normal":true,"ln1":628,"ln2":896,"content":" "},{"type":"normal","normal":true,"ln1":629,"ln2":897,"content":" static cairo_scaled_font_t*"},{"type":"normal","normal":true,"ln1":630,"ln2":898,"content":" CreateScaledFont(cairo_t *aCR, cairo_matrix_t *aCTM, PangoFont *aPangoFont)"},{"type":"normal","normal":true,"ln1":631,"ln2":899,"content":" {"},{"type":"del","del":true,"ln":632,"content":"-#if 0"},{"type":"del","del":true,"ln":633,"content":"-//XXX enalbe this #if defined(PANGO_VERSION_CHECK) && PANGO_VERSION_CHECK(1,17,5)"},{"type":"del","del":true,"ln":634,"content":"-    // Lets just use pango_cairo_font_get_scaled_font() for now.  it's only"},{"type":"del","del":true,"ln":635,"content":"-    // available in pango 1.17.x though :("},{"type":"del","del":true,"ln":636,"content":"-    return cairo_scaled_font_reference (pango_cairo_font_get_scaled_font (PANGO_CAIRO_FONT (aPangoFont)));"},{"type":"del","del":true,"ln":637,"content":"-#else"},{"type":"del","del":true,"ln":638,"content":"-"},{"type":"normal","normal":true,"ln1":639,"ln2":900,"content":"     // XXX is this safe really? We should probably check the font type or something."},{"type":"normal","normal":true,"ln1":640,"ln2":901,"content":"     // XXX does this really create the same font that Pango used for measurement?"},{"type":"normal","normal":true,"ln1":641,"ln2":902,"content":"     // We probably need to work harder here. We should pay particular attention"}],"oldStart":622,"oldLines":20,"newStart":890,"newLines":13},{"content":"@@ -654,7 +915,6 @@ CreateScaledFont(cairo_t *aCR, cairo_matrix_t *aCTM, PangoFont *aPangoFont)","changes":[{"type":"normal","normal":true,"ln1":654,"ln2":915,"content":"     cairo_font_options_destroy(fontOptions);"},{"type":"normal","normal":true,"ln1":655,"ln2":916,"content":"     cairo_font_face_destroy(face);"},{"type":"normal","normal":true,"ln1":656,"ln2":917,"content":"     return scaledFont;"},{"type":"del","del":true,"ln":657,"content":"-#endif"},{"type":"normal","normal":true,"ln1":658,"ln2":918,"content":" }"},{"type":"normal","normal":true,"ln1":659,"ln2":919,"content":" "},{"type":"normal","normal":true,"ln1":660,"ln2":920,"content":" PRBool"}],"oldStart":654,"oldLines":7,"newStart":915,"newLines":6},{"content":"@@ -694,8 +954,6 @@ SetupClusterBoundaries(gfxTextRun* aTextRun, const gchar *aUTF8, PRUint32 aUTF8L","changes":[{"type":"normal","normal":true,"ln1":694,"ln2":954,"content":"     if (aTextRun->GetFlags() & gfxTextRunFactory::TEXT_IS_8BIT) {"},{"type":"normal","normal":true,"ln1":695,"ln2":955,"content":"         // 8-bit text doesn't have clusters."},{"type":"normal","normal":true,"ln1":696,"ln2":956,"content":"         // XXX is this true in all languages???"},{"type":"del","del":true,"ln":697,"content":"-        // behdad: don't think so.  Czech for example IIRC has a"},{"type":"del","del":true,"ln":698,"content":"-        // 'ch' grapheme."},{"type":"normal","normal":true,"ln1":699,"ln2":957,"content":"         return;"},{"type":"normal","normal":true,"ln1":700,"ln2":958,"content":"     }"},{"type":"normal","normal":true,"ln1":701,"ln2":959,"content":" "}],"oldStart":694,"oldLines":8,"newStart":954,"newLines":6},{"content":"@@ -924,10 +1182,9 @@ gfxPangoFontGroup::SetGlyphs(gfxTextRun *aTextRun, gfxPangoFont *aFont,","changes":[{"type":"normal","normal":true,"ln1":924,"ln2":1182,"content":"         } else {"},{"type":"normal","normal":true,"ln1":925,"ln2":1183,"content":"             gunichar ch = g_utf8_get_char(clusterUTF8);"},{"type":"normal","normal":true,"ln1":926,"ln2":1184,"content":"             do { // Does pango ever provide more than one glyph in the cluster"},{"type":"del","del":true,"ln":927,"content":"-                // if there is a missing glyph?"},{"type":"del","del":true,"ln":928,"content":"-                // behdad: yes"},{"type":"add","add":true,"ln":1185,"content":"+                 // if there is a missing glyph?"},{"type":"normal","normal":true,"ln1":929,"ln2":1186,"content":"                 if (IS_MISSING_GLYPH(glyphs[glyphIndex].glyph)) {"},{"type":"del","del":true,"ln":930,"content":"-                    if (pango_is_zero_width(ch)) {"},{"type":"add","add":true,"ln":1187,"content":"+                    if (MOZ_pango_is_zero_width(ch)) {"},{"type":"normal","normal":true,"ln1":931,"ln2":1188,"content":"                         // the zero width characters returns empty glyph ID at shaping,"},{"type":"normal","normal":true,"ln1":932,"ln2":1189,"content":"                         // we should override it if the font has the character."},{"type":"normal","normal":true,"ln1":933,"ln2":1190,"content":"                         glyphs[glyphIndex].glyph = aFont->GetGlyph(' ');"}],"oldStart":924,"oldLines":10,"newStart":1182,"newLines":9},{"content":"@@ -987,15 +1244,15 @@ gfxPangoFontGroup::SetMissingGlyphs(gfxTextRun *aTextRun,","changes":[{"type":"normal","normal":true,"ln1":987,"ln2":1244,"content":"     return NS_OK;"},{"type":"normal","normal":true,"ln1":988,"ln2":1245,"content":" }"},{"type":"normal","normal":true,"ln1":989,"ln2":1246,"content":" "},{"type":"del","del":true,"ln":990,"content":"-#if defined(ENABLE_FAST_PATH_8BIT) || defined(ENABLE_FAST_PATH_ALWAYS)"},{"type":"add","add":true,"ln":1247,"content":"+#if defined(ENABLE_XFT_FAST_PATH_8BIT) || defined(ENABLE_XFT_FAST_PATH_ALWAYS)"},{"type":"normal","normal":true,"ln1":991,"ln2":1248,"content":" void"},{"type":"del","del":true,"ln":992,"content":"-gfxPangoFontGroup::CreateGlyphRunsFast(gfxTextRun *aTextRun,"},{"type":"del","del":true,"ln":993,"content":"-                                       const gchar *aUTF8, PRUint32 aUTF8Length)"},{"type":"add","add":true,"ln":1249,"content":"+gfxPangoFontGroup::CreateGlyphRunsXft(gfxTextRun *aTextRun,"},{"type":"add","add":true,"ln":1250,"content":"+                                      const gchar *aUTF8, PRUint32 aUTF8Length)"},{"type":"normal","normal":true,"ln1":994,"ln2":1251,"content":" {"},{"type":"normal","normal":true,"ln1":995,"ln2":1252,"content":"     const gchar *p = aUTF8;"},{"type":"add","add":true,"ln":1253,"content":"+    Display *dpy = GDK_DISPLAY();"},{"type":"normal","normal":true,"ln1":996,"ln2":1254,"content":"     gfxPangoFont *font = GetFontAt(0);"},{"type":"del","del":true,"ln":997,"content":"-    PangoFont *pangofont = font->GetPangoFont();"},{"type":"del","del":true,"ln":998,"content":"-    PangoFcFont *fcfont = PANGO_FC_FONT (pangofont);"},{"type":"add","add":true,"ln":1255,"content":"+    XftFont *xfont = font->GetXftFont();"},{"type":"normal","normal":true,"ln1":999,"ln2":1256,"content":"     PRUint32 utf16Offset = 0;"},{"type":"normal","normal":true,"ln1":1000,"ln2":1257,"content":"     gfxTextRun::CompressedGlyph g;"},{"type":"normal","normal":true,"ln1":1001,"ln2":1258,"content":"     const PRUint32 appUnitsPerDevUnit = aTextRun->GetAppUnitsPerDevUnit();"}],"oldStart":987,"oldLines":15,"newStart":1244,"newLines":15},{"content":"@@ -1016,11 +1273,14 @@ gfxPangoFontGroup::CreateGlyphRunsFast(gfxTextRun *aTextRun,","changes":[{"type":"normal","normal":true,"ln1":1016,"ln2":1273,"content":"             aTextRun->SetMissingGlyph(utf16Offset, 0);"},{"type":"normal","normal":true,"ln1":1017,"ln2":1274,"content":"         } else {"},{"type":"normal","normal":true,"ln1":1018,"ln2":1275,"content":"             NS_ASSERTION(!IsInvalidChar(ch), \"Invalid char detected\");"},{"type":"del","del":true,"ln":1019,"content":"-            FT_UInt glyph = pango_fc_font_get_glyph (fcfont, ch);"},{"type":"del","del":true,"ln":1020,"content":"-            PangoRectangle rect;"},{"type":"del","del":true,"ln":1021,"content":"-            pango_font_get_glyph_extents (pangofont, glyph, NULL, &rect);"},{"type":"add","add":true,"ln":1276,"content":"+            FT_UInt glyph = XftCharIndex(dpy, xfont, ch);"},{"type":"add","add":true,"ln":1277,"content":"+            XGlyphInfo info;"},{"type":"add","add":true,"ln":1278,"content":"+            XftGlyphExtents(dpy, xfont, &glyph, 1, &info);"},{"type":"add","add":true,"ln":1279,"content":"+            if (info.yOff > 0) {"},{"type":"add","add":true,"ln":1280,"content":"+                NS_WARNING(\"vertical offsets not supported\");"},{"type":"add","add":true,"ln":1281,"content":"+            }"},{"type":"normal","normal":true,"ln1":1022,"ln2":1282,"content":" "},{"type":"del","del":true,"ln":1023,"content":"-            PRInt32 advance = PANGO_PIXELS (rect.width * appUnitsPerDevUnit);"},{"type":"add","add":true,"ln":1283,"content":"+            PRInt32 advance = info.xOff*appUnitsPerDevUnit;"},{"type":"normal","normal":true,"ln1":1024,"ln2":1284,"content":"             if (advance >= 0 &&"},{"type":"normal","normal":true,"ln1":1025,"ln2":1285,"content":"                 gfxTextRun::CompressedGlyph::IsSimpleAdvance(advance) &&"},{"type":"normal","normal":true,"ln1":1026,"ln2":1286,"content":"                 gfxTextRun::CompressedGlyph::IsSimpleGlyphID(glyph)) {"}],"oldStart":1016,"oldLines":11,"newStart":1273,"newLines":14},{"content":"@@ -1054,92 +1314,319 @@ gfxPangoFontGroup::CreateGlyphRunsFast(gfxTextRun *aTextRun,","changes":[{"type":"normal","normal":true,"ln1":1054,"ln2":1314,"content":" }"},{"type":"normal","normal":true,"ln1":1055,"ln2":1315,"content":" #endif"},{"type":"normal","normal":true,"ln1":1056,"ln2":1316,"content":" "},{"type":"del","del":true,"ln":1057,"content":"-void "},{"type":"del","del":true,"ln":1058,"content":"-gfxPangoFontGroup::CreateGlyphRunsItemizing(gfxTextRun *aTextRun,"},{"type":"del","del":true,"ln":1059,"content":"-                                            const gchar *aUTF8, PRUint32 aUTF8Length)"},{"type":"add","add":true,"ln":1317,"content":"+class FontSelector"},{"type":"normal","normal":true,"ln1":1060,"ln2":1318,"content":" {"},{"type":"add","add":true,"ln":1319,"content":"+public:"},{"type":"add","add":true,"ln":1320,"content":"+    FontSelector(const gchar *aString, PRInt32 aLength,"},{"type":"add","add":true,"ln":1321,"content":"+                 gfxPangoFontGroup *aGroup, gfxTextRun *aTextRun,"},{"type":"add","add":true,"ln":1322,"content":"+                 PangoItem *aItem, PRUint32 aUTF16Offset, PRPackedBool aIsRTL) :"},{"type":"add","add":true,"ln":1323,"content":"+        mItem(aItem),"},{"type":"add","add":true,"ln":1324,"content":"+        mGroup(aGroup), mTextRun(aTextRun), mString(aString),"},{"type":"add","add":true,"ln":1325,"content":"+        mFontIndex(0), mLength(aLength), mUTF16Offset(aUTF16Offset),"},{"type":"add","add":true,"ln":1326,"content":"+        mTriedPrefFonts(0), mTriedOtherFonts(0), mIsRTL(aIsRTL)"},{"type":"add","add":true,"ln":1327,"content":"+    {"},{"type":"add","add":true,"ln":1328,"content":"+        for (PRUint32 i = 0; i < mGroup->FontListLength(); ++i)"},{"type":"add","add":true,"ln":1329,"content":"+            mFonts.AppendElement(mGroup->GetFontAt(i));"},{"type":"add","add":true,"ln":1330,"content":"+        mSpaceWidth = NS_lround(mGroup->GetFontAt(0)->GetMetrics().spaceWidth * FLOAT_PANGO_SCALE);"},{"type":"add","add":true,"ln":1331,"content":"+    }"},{"type":"add","add":true,"ln":1332,"content":"+    "},{"type":"add","add":true,"ln":1333,"content":"+    nsresult Run()"},{"type":"add","add":true,"ln":1334,"content":"+    {"},{"type":"add","add":true,"ln":1335,"content":"+        return InitSegments(mString, mLength);"},{"type":"add","add":true,"ln":1336,"content":"+    }"},{"type":"normal","normal":true,"ln1":1061,"ln2":1337,"content":" "},{"type":"del","del":true,"ln":1062,"content":"-    PangoContext *context = gdk_pango_context_get ();"},{"type":"add","add":true,"ln":1338,"content":"+    PRUint32 GetUTF16Offset() { return mUTF16Offset; }"},{"type":"normal","normal":true,"ln1":1063,"ln2":1339,"content":" "},{"type":"del","del":true,"ln":1064,"content":"-    PangoFontDescription *fontDesc = pango_font_description_new();"},{"type":"add","add":true,"ln":1340,"content":"+    static PRBool ExistsFont(FontSelector *aFs,"},{"type":"add","add":true,"ln":1341,"content":"+                             const nsAString &aName) {"},{"type":"add","add":true,"ln":1342,"content":"+        PRUint32 len = aFs->mFonts.Length();"},{"type":"add","add":true,"ln":1343,"content":"+        for (PRUint32 i = 0; i < len; ++i) {"},{"type":"add","add":true,"ln":1344,"content":"+            if (aName.Equals(aFs->mFonts[i]->GetName()))"},{"type":"add","add":true,"ln":1345,"content":"+                return PR_TRUE;"},{"type":"add","add":true,"ln":1346,"content":"+        }"},{"type":"add","add":true,"ln":1347,"content":"+        return PR_FALSE;"},{"type":"add","add":true,"ln":1348,"content":"+    }"},{"type":"add","add":true,"ln":1349,"content":"+"},{"type":"add","add":true,"ln":1350,"content":"+    static PRBool AddFontCallback(const nsAString &aName,"},{"type":"add","add":true,"ln":1351,"content":"+                                  const nsACString &aGenericName,"},{"type":"add","add":true,"ln":1352,"content":"+                                  void *closure) {"},{"type":"add","add":true,"ln":1353,"content":"+        if (aName.IsEmpty())"},{"type":"add","add":true,"ln":1354,"content":"+            return PR_TRUE;"},{"type":"add","add":true,"ln":1355,"content":"+"},{"type":"add","add":true,"ln":1356,"content":"+        FontSelector *fs = static_cast<FontSelector*>(closure);"},{"type":"normal","normal":true,"ln1":1065,"ln2":1357,"content":" "},{"type":"del","del":true,"ln":1066,"content":"-    // these should be FontEntries or something similar rather than gfxPangoFonts..."},{"type":"del","del":true,"ln":1067,"content":"-    nsString fontList;"},{"type":"add","add":true,"ln":1358,"content":"+        // XXX do something better than this to remove dups"},{"type":"add","add":true,"ln":1359,"content":"+        if (ExistsFont(fs, aName))"},{"type":"add","add":true,"ln":1360,"content":"+            return PR_TRUE;"},{"type":"normal","normal":true,"ln1":1068,"ln2":1361,"content":" "},{"type":"del","del":true,"ln":1069,"content":"-    for (PRUint32 i = 0; i < mFonts.Length(); i++) {"},{"type":"del","del":true,"ln":1070,"content":"-        fontList.Append(mFonts[i]->GetName());"},{"type":"del","del":true,"ln":1071,"content":"-        fontList.Append(NS_LITERAL_STRING(\", \"));"},{"type":"add","add":true,"ln":1362,"content":"+        nsRefPtr<gfxPangoFont> font = GetOrMakeFont(aName, fs->mGroup->GetStyle());"},{"type":"add","add":true,"ln":1363,"content":"+        if (font) {"},{"type":"add","add":true,"ln":1364,"content":"+            fs->mFonts.AppendElement(font);"},{"type":"add","add":true,"ln":1365,"content":"+        }"},{"type":"add","add":true,"ln":1366,"content":"+"},{"type":"add","add":true,"ln":1367,"content":"+        return PR_TRUE;"},{"type":"normal","normal":true,"ln1":1072,"ln2":1368,"content":"     }"},{"type":"normal","normal":true,"ln1":1073,"ln2":1369,"content":" "},{"type":"del","del":true,"ln":1074,"content":"-    PangoLanguage *lang = GetPangoLanguage(GetStyle()->langGroup);"},{"type":"add","add":true,"ln":1370,"content":"+private:"},{"type":"add","add":true,"ln":1371,"content":"+    PangoItem *mItem;"},{"type":"normal","normal":true,"ln1":1075,"ln2":1372,"content":" "},{"type":"del","del":true,"ln":1076,"content":"-    pango_font_description_set_family(fontDesc, NS_ConvertUTF16toUTF8(fontList).get());"},{"type":"del","del":true,"ln":1077,"content":"-    pango_font_description_set_absolute_size(fontDesc, GetStyle()->size * PANGO_SCALE);"},{"type":"del","del":true,"ln":1078,"content":"-    pango_font_description_set_style(fontDesc, ThebesStyleToPangoStyle(GetStyle()));"},{"type":"del","del":true,"ln":1079,"content":"-    pango_font_description_set_weight(fontDesc, ThebesStyleToPangoWeight(GetStyle()));"},{"type":"add","add":true,"ln":1373,"content":"+    nsTArray< nsRefPtr<gfxPangoFont> > mFonts;"},{"type":"normal","normal":true,"ln1":1080,"ln2":1374,"content":" "},{"type":"del","del":true,"ln":1081,"content":"-    pango_context_set_font_description(context, fontDesc);"},{"type":"add","add":true,"ln":1375,"content":"+    gfxPangoFontGroup *mGroup;"},{"type":"add","add":true,"ln":1376,"content":"+    gfxTextRun   *mTextRun;"},{"type":"add","add":true,"ln":1377,"content":"+    const char        *mString; // UTF-8"},{"type":"add","add":true,"ln":1378,"content":"+    PRUint32           mFontIndex;"},{"type":"add","add":true,"ln":1379,"content":"+    PRInt32            mLength;"},{"type":"add","add":true,"ln":1380,"content":"+    PRUint32           mUTF16Offset;"},{"type":"add","add":true,"ln":1381,"content":"+    PRUint32           mSpaceWidth;"},{"type":"normal","normal":true,"ln1":1082,"ln2":1382,"content":" "},{"type":"del","del":true,"ln":1083,"content":"-    // we should set this to null if we don't have a text language from the page..."},{"type":"del","del":true,"ln":1084,"content":"-    // except that we almost always have something..."},{"type":"del","del":true,"ln":1085,"content":"-    pango_context_set_language(context, lang);"},{"type":"add","add":true,"ln":1383,"content":"+    PRPackedBool mTriedPrefFonts;"},{"type":"add","add":true,"ln":1384,"content":"+    PRPackedBool mTriedOtherFonts;"},{"type":"add","add":true,"ln":1385,"content":"+    PRPackedBool mIsRTL;"},{"type":"normal","normal":true,"ln1":1086,"ln2":1386,"content":" "},{"type":"del","del":true,"ln":1087,"content":"-    PangoDirection dir = aTextRun->IsRightToLeft() ? PANGO_DIRECTION_RTL : PANGO_DIRECTION_LTR;"},{"type":"del","del":true,"ln":1088,"content":"-    GList *items = pango_itemize_with_base_dir(context, dir, aUTF8, 0, aUTF8Length, nsnull, nsnull);"},{"type":"add","add":true,"ln":1387,"content":"+    nsresult InitSegments(const gchar *aUTF8, PRUint32 aLength) {"},{"type":"add","add":true,"ln":1388,"content":"+        if (aLength == 0)"},{"type":"add","add":true,"ln":1389,"content":"+            return NS_OK;"},{"type":"add","add":true,"ln":1390,"content":"+        const gchar *start = aUTF8;"},{"type":"add","add":true,"ln":1391,"content":"+        const gchar *last = start + aLength;"},{"type":"normal","normal":true,"ln1":1089,"ln2":1392,"content":" "},{"type":"del","del":true,"ln":1090,"content":"-    PRUint32 utf16Offset = 0;"},{"type":"del","del":true,"ln":1091,"content":"-    PRBool isRTL = aTextRun->IsRightToLeft();"},{"type":"del","del":true,"ln":1092,"content":"-    GList *pos = items;"},{"type":"del","del":true,"ln":1093,"content":"-    for (; pos && pos->data; pos = pos->next) {"},{"type":"del","del":true,"ln":1094,"content":"-        PangoItem *item = (PangoItem *)pos->data;"},{"type":"del","del":true,"ln":1095,"content":"-        NS_ASSERTION(isRTL == item->analysis.level % 2, \"RTL assumption mismatch\");"},{"type":"add","add":true,"ln":1393,"content":"+RetryNextFont:"},{"type":"add","add":true,"ln":1394,"content":"+        nsRefPtr<gfxPangoFont> font = GetNextFont();"},{"type":"normal","normal":true,"ln1":1096,"ln2":1395,"content":" "},{"type":"del","del":true,"ln":1097,"content":"-        PRUint32 offset = item->offset;"},{"type":"del","del":true,"ln":1098,"content":"-        PRUint32 length = item->length;"},{"type":"add","add":true,"ln":1396,"content":"+        // If we cannot found the font that has the current character glyph,"},{"type":"add","add":true,"ln":1397,"content":"+        // we should return default font's missing data."},{"type":"add","add":true,"ln":1398,"content":"+        if (!font)"},{"type":"add","add":true,"ln":1399,"content":"+            return AppendMissingSegment(start, last - start);"},{"type":"normal","normal":true,"ln1":1099,"ln2":1400,"content":" "},{"type":"del","del":true,"ln":1100,"content":"-        // need to append glyph runs here."},{"type":"del","del":true,"ln":1101,"content":"-        PangoGlyphString *glyphString = pango_glyph_string_new();"},{"type":"del","del":true,"ln":1102,"content":"-        if (!glyphString)"},{"type":"del","del":true,"ln":1103,"content":"-            return; // OOM"},{"type":"add","add":true,"ln":1401,"content":"+        nsresult rv;"},{"type":"add","add":true,"ln":1402,"content":"+        for (const gchar *c = start; c < last;) {"},{"type":"add","add":true,"ln":1403,"content":"+            // find the first missing glyph"},{"type":"add","add":true,"ln":1404,"content":"+            gunichar u = g_utf8_get_char(c);"},{"type":"add","add":true,"ln":1405,"content":"+            if (font->HasGlyph(PRUint32(u))) {"},{"type":"add","add":true,"ln":1406,"content":"+                c = g_utf8_next_char(c);"},{"type":"add","add":true,"ln":1407,"content":"+                continue;"},{"type":"add","add":true,"ln":1408,"content":"+            }"},{"type":"add","add":true,"ln":1409,"content":"+"},{"type":"add","add":true,"ln":1410,"content":"+            // find the next point that can be renderd with current font"},{"type":"add","add":true,"ln":1411,"content":"+            const gchar *missingStart = c;"},{"type":"add","add":true,"ln":1412,"content":"+            const gchar *next;"},{"type":"add","add":true,"ln":1413,"content":"+            for (next = g_utf8_next_char(missingStart); next < last; next = g_utf8_next_char(next)) {"},{"type":"add","add":true,"ln":1414,"content":"+                u = g_utf8_get_char(next);"},{"type":"add","add":true,"ln":1415,"content":"+                if (font->HasGlyph(PRUint32(u)))"},{"type":"add","add":true,"ln":1416,"content":"+                    break;"},{"type":"add","add":true,"ln":1417,"content":"+            }"},{"type":"normal","normal":true,"ln1":1104,"ln2":1418,"content":" "},{"type":"del","del":true,"ln":1105,"content":"-        pango_shape(aUTF8 + offset, length, &item->analysis, glyphString);"},{"type":"add","add":true,"ln":1419,"content":"+            // current font has 0 glyphs for current segment, try with next font"},{"type":"add","add":true,"ln":1420,"content":"+            if (missingStart == start && next == last)"},{"type":"add","add":true,"ln":1421,"content":"+                goto RetryNextFont;"},{"type":"normal","normal":true,"ln1":1106,"ln2":1422,"content":" "},{"type":"del","del":true,"ln":1107,"content":"-        /* look up the gfxPangoFont from the PangoFont */"},{"type":"del","del":true,"ln":1108,"content":"-        // XXX we need a function to do this.. until then do this"},{"type":"del","del":true,"ln":1109,"content":"-        // behdad: use g_object_[sg]et_qdata() for it."},{"type":"del","del":true,"ln":1110,"content":"-        PangoFontDescription *d = pango_font_describe(item->analysis.font);"},{"type":"del","del":true,"ln":1111,"content":"-        nsRefPtr<gfxPangoFont> font = GetOrMakeFont(NS_ConvertUTF8toUTF16(pango_font_description_get_family(d)), GetStyle());"},{"type":"add","add":true,"ln":1423,"content":"+            // create the segment for found glyphs"},{"type":"add","add":true,"ln":1424,"content":"+            rv = AppendSegment(font, start, missingStart - start);"},{"type":"add","add":true,"ln":1425,"content":"+            NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":1112,"ln2":1426,"content":" "},{"type":"del","del":true,"ln":1113,"content":"-        //printf(\"Using %s\\n\", pango_font_description_get_family(d));"},{"type":"add","add":true,"ln":1427,"content":"+            // init the missing glyphs with remains fonts."},{"type":"add","add":true,"ln":1428,"content":"+            PRUint32 fontIndex = mFontIndex;"},{"type":"add","add":true,"ln":1429,"content":"+            rv = InitSegments(missingStart, next - missingStart);"},{"type":"add","add":true,"ln":1430,"content":"+            mFontIndex = fontIndex;"},{"type":"add","add":true,"ln":1431,"content":"+            NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":1114,"ln2":1432,"content":" "},{"type":"del","del":true,"ln":1115,"content":"-        pango_font_description_free(d);"},{"type":"del","del":true,"ln":1116,"content":"-        SetupClusterBoundaries(aTextRun, aUTF8 + offset, length, utf16Offset, &item->analysis);"},{"type":"add","add":true,"ln":1433,"content":"+            start = c = next;"},{"type":"add","add":true,"ln":1434,"content":"+        }"},{"type":"add","add":true,"ln":1435,"content":"+"},{"type":"add","add":true,"ln":1436,"content":"+        rv = AppendSegment(font, start, last - start);"},{"type":"add","add":true,"ln":1437,"content":"+        NS_ENSURE_SUCCESS(rv, rv);"},{"type":"add","add":true,"ln":1438,"content":"+        return NS_OK;"},{"type":"add","add":true,"ln":1439,"content":"+    }"},{"type":"add","add":true,"ln":1440,"content":"+"},{"type":"add","add":true,"ln":1441,"content":"+    nsresult AppendSegment(gfxPangoFont* aFont, const gchar *aUTF8, PRUint32 aLength) {"},{"type":"add","add":true,"ln":1442,"content":"+        if (aLength == 0)"},{"type":"add","add":true,"ln":1443,"content":"+            return NS_OK;"},{"type":"add","add":true,"ln":1444,"content":"+"},{"type":"add","add":true,"ln":1445,"content":"+        PangoFont* pf = aFont->GetPangoFont();"},{"type":"normal","normal":true,"ln1":1117,"ln2":1446,"content":" "},{"type":"del","del":true,"ln":1118,"content":"-        nsresult rv = aTextRun->AddGlyphRun(font, utf16Offset, PR_TRUE);"},{"type":"add","add":true,"ln":1447,"content":"+        PangoGlyphString *glyphString = pango_glyph_string_new();"},{"type":"add","add":true,"ln":1448,"content":"+        if (!glyphString)"},{"type":"add","add":true,"ln":1449,"content":"+            return NS_ERROR_OUT_OF_MEMORY;"},{"type":"add","add":true,"ln":1450,"content":"+        PangoFont *tmpFont = mItem->analysis.font;"},{"type":"add","add":true,"ln":1451,"content":"+        mItem->analysis.font = pf;"},{"type":"add","add":true,"ln":1452,"content":"+        pango_shape(aUTF8, aLength, &mItem->analysis, glyphString);"},{"type":"add","add":true,"ln":1453,"content":"+        mItem->analysis.font = tmpFont;"},{"type":"add","add":true,"ln":1454,"content":"+"},{"type":"add","add":true,"ln":1455,"content":"+        nsresult rv = mTextRun->AddGlyphRun(aFont, mUTF16Offset);"},{"type":"normal","normal":true,"ln1":1119,"ln2":1456,"content":"         if (NS_FAILED(rv)) {"},{"type":"normal","normal":true,"ln1":1120,"ln2":1457,"content":"             NS_ERROR(\"AddGlyphRun Failed\");"},{"type":"normal","normal":true,"ln1":1121,"ln2":1458,"content":"             pango_glyph_string_free(glyphString);"},{"type":"del","del":true,"ln":1122,"content":"-            return;"},{"type":"add","add":true,"ln":1459,"content":"+            return rv;"},{"type":"normal","normal":true,"ln1":1123,"ln2":1460,"content":"         }"},{"type":"add","add":true,"ln":1461,"content":"+        PRUint32 utf16Offset = mUTF16Offset;"},{"type":"add","add":true,"ln":1462,"content":"+        rv = mGroup->SetGlyphs(mTextRun, aFont, aUTF8, aLength,"},{"type":"add","add":true,"ln":1463,"content":"+                               &utf16Offset, glyphString, mSpaceWidth, PR_FALSE);"},{"type":"add","add":true,"ln":1464,"content":"+        pango_glyph_string_free(glyphString);"},{"type":"add","add":true,"ln":1465,"content":"+        NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":1124,"ln2":1466,"content":" "},{"type":"del","del":true,"ln":1125,"content":"-        PRUint32 spaceWidth = NS_lround(font->GetMetrics().spaceWidth * FLOAT_PANGO_SCALE);"},{"type":"add","add":true,"ln":1467,"content":"+        mUTF16Offset = utf16Offset;"},{"type":"add","add":true,"ln":1468,"content":"+        return NS_OK;"},{"type":"add","add":true,"ln":1469,"content":"+    }"},{"type":"normal","normal":true,"ln1":1126,"ln2":1470,"content":" "},{"type":"del","del":true,"ln":1127,"content":"-        rv = SetGlyphs(aTextRun, font, aUTF8 + offset, length, &utf16Offset, glyphString, spaceWidth, PR_FALSE);"},{"type":"add","add":true,"ln":1471,"content":"+    nsresult AppendMissingSegment(const gchar *aUTF8, PRUint32 aLength) {"},{"type":"add","add":true,"ln":1472,"content":"+        if (aLength == 0)"},{"type":"add","add":true,"ln":1473,"content":"+            return NS_OK;"},{"type":"normal","normal":true,"ln1":1128,"ln2":1474,"content":" "},{"type":"del","del":true,"ln":1129,"content":"-        pango_glyph_string_free(glyphString);"},{"type":"del","del":true,"ln":1130,"content":"-    }"},{"type":"add","add":true,"ln":1475,"content":"+        nsresult rv = mTextRun->AddGlyphRun(mFonts[0], mUTF16Offset);"},{"type":"add","add":true,"ln":1476,"content":"+        NS_ENSURE_SUCCESS(rv, rv);"},{"type":"add","add":true,"ln":1477,"content":"+        PRUint32 utf16Offset = mUTF16Offset;"},{"type":"add","add":true,"ln":1478,"content":"+        rv = mGroup->SetMissingGlyphs(mTextRun, aUTF8, aLength, &utf16Offset);"},{"type":"add","add":true,"ln":1479,"content":"+        NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":1131,"ln2":1480,"content":" "},{"type":"del","del":true,"ln":1132,"content":"-    if (items)"},{"type":"del","del":true,"ln":1133,"content":"-        g_list_free(items);"},{"type":"add","add":true,"ln":1481,"content":"+        mUTF16Offset = utf16Offset;"},{"type":"add","add":true,"ln":1482,"content":"+        return NS_OK;"},{"type":"add","add":true,"ln":1483,"content":"+    }"},{"type":"normal","normal":true,"ln1":1134,"ln2":1484,"content":" "},{"type":"del","del":true,"ln":1135,"content":"-    pango_font_description_free(fontDesc);"},{"type":"add","add":true,"ln":1485,"content":"+    gfxPangoFont *GetNextFont() {"},{"type":"add","add":true,"ln":1486,"content":"+TRY_AGAIN_HOPE_FOR_THE_BEST_2:"},{"type":"add","add":true,"ln":1487,"content":"+        if (mFontIndex < mFonts.Length()) {"},{"type":"add","add":true,"ln":1488,"content":"+            return mFonts[mFontIndex++];"},{"type":"add","add":true,"ln":1489,"content":"+        } else if (!mTriedPrefFonts) {"},{"type":"add","add":true,"ln":1490,"content":"+            mTriedPrefFonts = PR_TRUE;"},{"type":"add","add":true,"ln":1491,"content":"+            nsCAutoString mozLang;"},{"type":"add","add":true,"ln":1492,"content":"+            GetMozLanguage(mItem->analysis.language, mozLang);"},{"type":"add","add":true,"ln":1493,"content":"+            if (!mozLang.IsEmpty()) {"},{"type":"add","add":true,"ln":1494,"content":"+                PRInt32 index = GetCJKLangGroupIndex(mozLang.get());"},{"type":"add","add":true,"ln":1495,"content":"+                if (index >= 0)"},{"type":"add","add":true,"ln":1496,"content":"+                    AppendCJKPrefFonts();"},{"type":"add","add":true,"ln":1497,"content":"+                else"},{"type":"add","add":true,"ln":1498,"content":"+                    AppendPrefFonts(mozLang.get());"},{"type":"add","add":true,"ln":1499,"content":"+            } else {"},{"type":"add","add":true,"ln":1500,"content":"+                NS_ConvertUTF8toUTF16 str(mString);"},{"type":"add","add":true,"ln":1501,"content":"+                PRBool appenedCJKFonts = PR_FALSE;"},{"type":"add","add":true,"ln":1502,"content":"+                for (PRUint32 i = 0; i < str.Length(); ++i) {"},{"type":"add","add":true,"ln":1503,"content":"+                    const PRUnichar ch = str[i];"},{"type":"add","add":true,"ln":1504,"content":"+                    PRUint32 unicodeRange = FindCharUnicodeRange(ch);"},{"type":"add","add":true,"ln":1505,"content":"+"},{"type":"add","add":true,"ln":1506,"content":"+                    /* special case CJK */"},{"type":"add","add":true,"ln":1507,"content":"+                    if (unicodeRange == kRangeSetCJK) {"},{"type":"add","add":true,"ln":1508,"content":"+                        if (!appenedCJKFonts) {"},{"type":"add","add":true,"ln":1509,"content":"+                            appenedCJKFonts = PR_TRUE;"},{"type":"add","add":true,"ln":1510,"content":"+                            AppendCJKPrefFonts();"},{"type":"add","add":true,"ln":1511,"content":"+                        }"},{"type":"add","add":true,"ln":1512,"content":"+                    } else {"},{"type":"add","add":true,"ln":1513,"content":"+                        const char *langGroup ="},{"type":"add","add":true,"ln":1514,"content":"+                            LangGroupFromUnicodeRange(unicodeRange);"},{"type":"add","add":true,"ln":1515,"content":"+                        if (langGroup)"},{"type":"add","add":true,"ln":1516,"content":"+                            AppendPrefFonts(langGroup);"},{"type":"add","add":true,"ln":1517,"content":"+                    }"},{"type":"add","add":true,"ln":1518,"content":"+                }"},{"type":"add","add":true,"ln":1519,"content":"+            }"},{"type":"add","add":true,"ln":1520,"content":"+            goto TRY_AGAIN_HOPE_FOR_THE_BEST_2;"},{"type":"add","add":true,"ln":1521,"content":"+        } else if (!mTriedOtherFonts) {"},{"type":"add","add":true,"ln":1522,"content":"+            mTriedOtherFonts = PR_TRUE;"},{"type":"add","add":true,"ln":1523,"content":"+            // XXX we should try by all system fonts"},{"type":"add","add":true,"ln":1524,"content":"+            goto TRY_AGAIN_HOPE_FOR_THE_BEST_2;"},{"type":"add","add":true,"ln":1525,"content":"+        }"},{"type":"add","add":true,"ln":1526,"content":"+        return nsnull;"},{"type":"add","add":true,"ln":1527,"content":"+    }"},{"type":"normal","normal":true,"ln1":1136,"ln2":1528,"content":" "},{"type":"del","del":true,"ln":1137,"content":"-    g_object_unref(context);"},{"type":"add","add":true,"ln":1529,"content":"+    void AppendPrefFonts(const char *aLangGroup) {"},{"type":"add","add":true,"ln":1530,"content":"+        NS_ASSERTION(aLangGroup, \"aLangGroup is null\");"},{"type":"add","add":true,"ln":1531,"content":"+        gfxPlatform *platform = gfxPlatform::GetPlatform();"},{"type":"add","add":true,"ln":1532,"content":"+        nsString fonts;"},{"type":"add","add":true,"ln":1533,"content":"+        platform->GetPrefFonts(aLangGroup, fonts);"},{"type":"add","add":true,"ln":1534,"content":"+        if (fonts.IsEmpty())"},{"type":"add","add":true,"ln":1535,"content":"+            return;"},{"type":"add","add":true,"ln":1536,"content":"+        gfxFontGroup::ForEachFont(fonts, nsDependentCString(aLangGroup),"},{"type":"add","add":true,"ln":1537,"content":"+                                  FontSelector::AddFontCallback, this);"},{"type":"add","add":true,"ln":1538,"content":"+        return;"},{"type":"add","add":true,"ln":1539,"content":"+   }"},{"type":"add","add":true,"ln":1540,"content":"+"},{"type":"add","add":true,"ln":1541,"content":"+   void AppendCJKPrefFonts() {"},{"type":"add","add":true,"ln":1542,"content":"+       nsCOMPtr<nsIPrefService> prefs ="},{"type":"add","add":true,"ln":1543,"content":"+           do_GetService(NS_PREFSERVICE_CONTRACTID);"},{"type":"add","add":true,"ln":1544,"content":"+       if (!prefs)"},{"type":"add","add":true,"ln":1545,"content":"+           return;"},{"type":"add","add":true,"ln":1546,"content":"+"},{"type":"add","add":true,"ln":1547,"content":"+       nsCOMPtr<nsIPrefBranch> prefBranch;"},{"type":"add","add":true,"ln":1548,"content":"+       prefs->GetBranch(0, getter_AddRefs(prefBranch));"},{"type":"add","add":true,"ln":1549,"content":"+       if (!prefBranch)"},{"type":"add","add":true,"ln":1550,"content":"+           return;"},{"type":"add","add":true,"ln":1551,"content":"+"},{"type":"add","add":true,"ln":1552,"content":"+       // Add the accept languages."},{"type":"add","add":true,"ln":1553,"content":"+       nsXPIDLCString list;"},{"type":"add","add":true,"ln":1554,"content":"+       nsresult rv = prefBranch->GetCharPref(\"intl.accept_languages\","},{"type":"add","add":true,"ln":1555,"content":"+                                             getter_Copies(list));"},{"type":"add","add":true,"ln":1556,"content":"+       if (NS_SUCCEEDED(rv) && !list.IsEmpty()) {"},{"type":"add","add":true,"ln":1557,"content":"+           const char kComma = ',';"},{"type":"add","add":true,"ln":1558,"content":"+           const char *p, *p_end;"},{"type":"add","add":true,"ln":1559,"content":"+           list.BeginReading(p);"},{"type":"add","add":true,"ln":1560,"content":"+           list.EndReading(p_end);"},{"type":"add","add":true,"ln":1561,"content":"+           while (p < p_end) {"},{"type":"add","add":true,"ln":1562,"content":"+               while (nsCRT::IsAsciiSpace(*p)) {"},{"type":"add","add":true,"ln":1563,"content":"+                   if (++p == p_end)"},{"type":"add","add":true,"ln":1564,"content":"+                       break;"},{"type":"add","add":true,"ln":1565,"content":"+               }"},{"type":"add","add":true,"ln":1566,"content":"+               if (p == p_end)"},{"type":"add","add":true,"ln":1567,"content":"+                   break;"},{"type":"add","add":true,"ln":1568,"content":"+               const char *start = p;"},{"type":"add","add":true,"ln":1569,"content":"+               while (++p != p_end && *p != kComma)"},{"type":"add","add":true,"ln":1570,"content":"+                   /* nothing */ ;"},{"type":"add","add":true,"ln":1571,"content":"+               nsCAutoString lang(Substring(start, p));"},{"type":"add","add":true,"ln":1572,"content":"+               lang.CompressWhitespace(PR_FALSE, PR_TRUE);"},{"type":"add","add":true,"ln":1573,"content":"+               PRInt32 index = GetCJKLangGroupIndex(lang.get());"},{"type":"add","add":true,"ln":1574,"content":"+               if (index >= 0)"},{"type":"add","add":true,"ln":1575,"content":"+                   AppendPrefFonts(sCJKLangGroup[index]);"},{"type":"add","add":true,"ln":1576,"content":"+               p++;"},{"type":"add","add":true,"ln":1577,"content":"+           }"},{"type":"add","add":true,"ln":1578,"content":"+       }"},{"type":"add","add":true,"ln":1579,"content":"+"},{"type":"add","add":true,"ln":1580,"content":"+       // XXX I think that we should append system locale here if it is CJK."},{"type":"add","add":true,"ln":1581,"content":"+"},{"type":"add","add":true,"ln":1582,"content":"+       // last resort..."},{"type":"add","add":true,"ln":1583,"content":"+       AppendPrefFonts(CJK_LANG_JA);"},{"type":"add","add":true,"ln":1584,"content":"+       AppendPrefFonts(CJK_LANG_KO);"},{"type":"add","add":true,"ln":1585,"content":"+       AppendPrefFonts(CJK_LANG_ZH_CN);"},{"type":"add","add":true,"ln":1586,"content":"+       AppendPrefFonts(CJK_LANG_ZH_HK);"},{"type":"add","add":true,"ln":1587,"content":"+       AppendPrefFonts(CJK_LANG_ZH_TW);"},{"type":"add","add":true,"ln":1588,"content":"+    }"},{"type":"add","add":true,"ln":1589,"content":"+};"},{"type":"normal","normal":true,"ln1":1138,"ln2":1590,"content":" "},{"type":"del","del":true,"ln":1139,"content":"-    aTextRun->SortGlyphRuns();"},{"type":"del","del":true,"ln":1140,"content":"-}"},{"type":"add","add":true,"ln":1591,"content":"+void "},{"type":"add","add":true,"ln":1592,"content":"+gfxPangoFontGroup::CreateGlyphRunsItemizing(gfxTextRun *aTextRun,"},{"type":"add","add":true,"ln":1593,"content":"+                                            const gchar *aUTF8, PRUint32 aUTF8Length,"},{"type":"add","add":true,"ln":1594,"content":"+                                            PRUint32 aUTF8HeaderLen)"},{"type":"add","add":true,"ln":1595,"content":"+{"},{"type":"add","add":true,"ln":1596,"content":"+    GList *items = pango_itemize(GetFontAt(0)->GetPangoContext(), aUTF8, 0,"},{"type":"add","add":true,"ln":1597,"content":"+                                 aUTF8Length, nsnull, nsnull);"},{"type":"add","add":true,"ln":1598,"content":"+    "},{"type":"add","add":true,"ln":1599,"content":"+    PRUint32 utf16Offset = 0;"},{"type":"add","add":true,"ln":1600,"content":"+    PRBool isRTL = aTextRun->IsRightToLeft();"},{"type":"add","add":true,"ln":1601,"content":"+    GList *pos = items;"},{"type":"add","add":true,"ln":1602,"content":"+    for (; pos && pos->data; pos = pos->next) {"},{"type":"add","add":true,"ln":1603,"content":"+        PangoItem *item = (PangoItem *)pos->data;"},{"type":"add","add":true,"ln":1604,"content":"+        NS_ASSERTION(isRTL == item->analysis.level % 2, \"RTL assumption mismatch\");"},{"type":"normal","normal":true,"ln1":1141,"ln2":1605,"content":" "},{"type":"add","add":true,"ln":1606,"content":"+        PRUint32 offset = item->offset;"},{"type":"add","add":true,"ln":1607,"content":"+        PRUint32 length = item->length;"},{"type":"add","add":true,"ln":1608,"content":"+        if (offset < aUTF8HeaderLen) {"},{"type":"add","add":true,"ln":1609,"content":"+            if (offset + length <= aUTF8HeaderLen) {"},{"type":"add","add":true,"ln":1610,"content":"+                pango_item_free(item);"},{"type":"add","add":true,"ln":1611,"content":"+                continue;"},{"type":"add","add":true,"ln":1612,"content":"+            }"},{"type":"add","add":true,"ln":1613,"content":"+            length -= aUTF8HeaderLen - offset;"},{"type":"add","add":true,"ln":1614,"content":"+            offset = aUTF8HeaderLen;"},{"type":"add","add":true,"ln":1615,"content":"+        }"},{"type":"add","add":true,"ln":1616,"content":"+        "},{"type":"add","add":true,"ln":1617,"content":"+        SetupClusterBoundaries(aTextRun, aUTF8 + offset, length, utf16Offset, &item->analysis);"},{"type":"add","add":true,"ln":1618,"content":"+        FontSelector fs(aUTF8 + offset, length, this, aTextRun, item, utf16Offset, isRTL);"},{"type":"add","add":true,"ln":1619,"content":"+        fs.Run(); // appends GlyphRuns"},{"type":"add","add":true,"ln":1620,"content":"+        utf16Offset = fs.GetUTF16Offset();"},{"type":"add","add":true,"ln":1621,"content":"+        pango_item_free(item);"},{"type":"add","add":true,"ln":1622,"content":"+    }"},{"type":"normal","normal":true,"ln1":1142,"ln2":1623,"content":" "},{"type":"add","add":true,"ln":1624,"content":"+    NS_ASSERTION(utf16Offset == aTextRun->GetLength(),"},{"type":"add","add":true,"ln":1625,"content":"+                 \"Didn't resolve all characters\");"},{"type":"add","add":true,"ln":1626,"content":"+  "},{"type":"add","add":true,"ln":1627,"content":"+    if (items)"},{"type":"add","add":true,"ln":1628,"content":"+        g_list_free(items);"},{"type":"add","add":true,"ln":1629,"content":"+}"},{"type":"normal","normal":true,"ln1":1143,"ln2":1630,"content":" "},{"type":"normal","normal":true,"ln1":1144,"ln2":1631,"content":" /**"},{"type":"normal","normal":true,"ln1":1145,"ln2":1632,"content":"  ** language group helpers"}],"oldStart":1054,"oldLines":92,"newStart":1314,"newLines":319},{"content":"@@ -1209,7 +1696,7 @@ GetPangoLanguage(const nsACString& cname)","changes":[{"type":"normal","normal":true,"ln1":1209,"ln2":1696,"content":"     else if (langGroup->PangoLang) "},{"type":"normal","normal":true,"ln1":1210,"ln2":1697,"content":"         return pango_language_from_string(langGroup->PangoLang);"},{"type":"normal","normal":true,"ln1":1211,"ln2":1698,"content":" "},{"type":"del","del":true,"ln":1212,"content":"-    return nsnull;"},{"type":"add","add":true,"ln":1699,"content":"+    return pango_language_from_string(\"en\");"},{"type":"normal","normal":true,"ln1":1213,"ln2":1700,"content":" }"},{"type":"normal","normal":true,"ln1":1214,"ln2":1701,"content":" "},{"type":"normal","normal":true,"ln1":1215,"ln2":1702,"content":" // See pango-script-lang-table.h in pango."}],"oldStart":1209,"oldLines":7,"newStart":1696,"newLines":7},{"content":"@@ -1393,7 +1880,38 @@ static const MozPangoLangGroup PangoAllLangGroup[] = {","changes":[{"type":"normal","normal":true,"ln1":1393,"ln2":1880,"content":"     { \"x-western\",      \"zu\"    },"},{"type":"normal","normal":true,"ln1":1394,"ln2":1881,"content":" };"},{"type":"normal","normal":true,"ln1":1395,"ln2":1882,"content":" "},{"type":"del","del":true,"ln":1396,"content":"-#define NUM_PANGO_ALL_LANG_GROUPS (G_N_ELEMENTS (PangoAllLangGroup))"},{"type":"add","add":true,"ln":1883,"content":"+#define NUM_PANGO_ALL_LANG_GROUPS (sizeof (PangoAllLangGroup) / \\"},{"type":"add","add":true,"ln":1884,"content":"+                                   sizeof (PangoAllLangGroup[0]))"},{"type":"add","add":true,"ln":1885,"content":"+"},{"type":"add","add":true,"ln":1886,"content":"+/* static */"},{"type":"add","add":true,"ln":1887,"content":"+void"},{"type":"add","add":true,"ln":1888,"content":"+GetMozLanguage(const PangoLanguage *aLang, nsACString &aMozLang)"},{"type":"add","add":true,"ln":1889,"content":"+{"},{"type":"add","add":true,"ln":1890,"content":"+    aMozLang.Truncate();"},{"type":"add","add":true,"ln":1891,"content":"+    if (!aLang)"},{"type":"add","add":true,"ln":1892,"content":"+        return;"},{"type":"add","add":true,"ln":1893,"content":"+"},{"type":"add","add":true,"ln":1894,"content":"+    nsCAutoString lang(pango_language_to_string(aLang));"},{"type":"add","add":true,"ln":1895,"content":"+    if (lang.IsEmpty() || lang.Equals(\"xx\"))"},{"type":"add","add":true,"ln":1896,"content":"+        return;"},{"type":"add","add":true,"ln":1897,"content":"+"},{"type":"add","add":true,"ln":1898,"content":"+    while (1) {"},{"type":"add","add":true,"ln":1899,"content":"+        for (PRUint32 i = 0; i < NUM_PANGO_ALL_LANG_GROUPS; ++i) {"},{"type":"add","add":true,"ln":1900,"content":"+            if (lang.Equals(PangoAllLangGroup[i].PangoLang)) {"},{"type":"add","add":true,"ln":1901,"content":"+                if (PangoAllLangGroup[i].mozLangGroup)"},{"type":"add","add":true,"ln":1902,"content":"+                    aMozLang.Assign(PangoAllLangGroup[i].mozLangGroup);"},{"type":"add","add":true,"ln":1903,"content":"+                return;"},{"type":"add","add":true,"ln":1904,"content":"+            }"},{"type":"add","add":true,"ln":1905,"content":"+        }"},{"type":"add","add":true,"ln":1906,"content":"+"},{"type":"add","add":true,"ln":1907,"content":"+        PRInt32 hyphen = lang.FindChar('-');"},{"type":"add","add":true,"ln":1908,"content":"+        if (hyphen != kNotFound) {"},{"type":"add","add":true,"ln":1909,"content":"+            lang.Cut(hyphen, lang.Length());"},{"type":"add","add":true,"ln":1910,"content":"+            continue;"},{"type":"add","add":true,"ln":1911,"content":"+        }"},{"type":"add","add":true,"ln":1912,"content":"+        break;"},{"type":"add","add":true,"ln":1913,"content":"+    }"},{"type":"add","add":true,"ln":1914,"content":"+}"},{"type":"normal","normal":true,"ln1":1397,"ln2":1915,"content":" "},{"type":"normal","normal":true,"ln1":1398,"ln2":1916,"content":" gfxPangoFontCache::gfxPangoFontCache()"},{"type":"normal","normal":true,"ln1":1399,"ln2":1917,"content":" {"}],"oldStart":1393,"oldLines":7,"newStart":1880,"newLines":38},{"content":"@@ -1427,3 +1945,39 @@ gfxPangoFontCache::Get(const PangoFontDescription *aFontDesc)","changes":[{"type":"normal","normal":true,"ln1":1427,"ln2":1945,"content":"     g_object_ref(font);"},{"type":"normal","normal":true,"ln1":1428,"ln2":1946,"content":"     return font;"},{"type":"normal","normal":true,"ln1":1429,"ln2":1947,"content":" }"},{"type":"add","add":true,"ln":1948,"content":"+"},{"type":"add","add":true,"ln":1949,"content":"+gfxPangoFontNameMap::gfxPangoFontNameMap()"},{"type":"add","add":true,"ln":1950,"content":"+{"},{"type":"add","add":true,"ln":1951,"content":"+    mPangoFonts.Init(100);"},{"type":"add","add":true,"ln":1952,"content":"+}"},{"type":"add","add":true,"ln":1953,"content":"+"},{"type":"add","add":true,"ln":1954,"content":"+gfxPangoFontNameMap::~gfxPangoFontNameMap()"},{"type":"add","add":true,"ln":1955,"content":"+{"},{"type":"add","add":true,"ln":1956,"content":"+}"},{"type":"add","add":true,"ln":1957,"content":"+"},{"type":"add","add":true,"ln":1958,"content":"+void"},{"type":"add","add":true,"ln":1959,"content":"+gfxPangoFontNameMap::Put(const nsACString &aName, PangoFont *aPangoFont)"},{"type":"add","add":true,"ln":1960,"content":"+{"},{"type":"add","add":true,"ln":1961,"content":"+    nsCAutoString key(aName);"},{"type":"add","add":true,"ln":1962,"content":"+    ToLowerCase(key);"},{"type":"add","add":true,"ln":1963,"content":"+    gfxPangoFontWrapper *value;"},{"type":"add","add":true,"ln":1964,"content":"+    if (!mPangoFonts.Get(key, &value)) {"},{"type":"add","add":true,"ln":1965,"content":"+        value = new gfxPangoFontWrapper(aPangoFont);"},{"type":"add","add":true,"ln":1966,"content":"+        if (!value)"},{"type":"add","add":true,"ln":1967,"content":"+            return;"},{"type":"add","add":true,"ln":1968,"content":"+        mPangoFonts.Put(key, value);"},{"type":"add","add":true,"ln":1969,"content":"+    }"},{"type":"add","add":true,"ln":1970,"content":"+}"},{"type":"add","add":true,"ln":1971,"content":"+"},{"type":"add","add":true,"ln":1972,"content":"+PangoFont*"},{"type":"add","add":true,"ln":1973,"content":"+gfxPangoFontNameMap::Get(const nsACString &aName)"},{"type":"add","add":true,"ln":1974,"content":"+{"},{"type":"add","add":true,"ln":1975,"content":"+    nsCAutoString key(aName);"},{"type":"add","add":true,"ln":1976,"content":"+    ToLowerCase(key);"},{"type":"add","add":true,"ln":1977,"content":"+    gfxPangoFontWrapper *value;"},{"type":"add","add":true,"ln":1978,"content":"+    if (!mPangoFonts.Get(key, &value))"},{"type":"add","add":true,"ln":1979,"content":"+        return nsnull;"},{"type":"add","add":true,"ln":1980,"content":"+    PangoFont *font = value->Get();"},{"type":"add","add":true,"ln":1981,"content":"+    g_object_ref(font);"},{"type":"add","add":true,"ln":1982,"content":"+    return font;"},{"type":"add","add":true,"ln":1983,"content":"+}"}],"oldStart":1427,"oldLines":3,"newStart":1945,"newLines":39}],"deletions":169,"additions":723,"from":"gfx/thebes/src/gfxPangoFonts.cpp","to":"gfx/thebes/src/gfxPangoFonts.cpp","index":["b1fb201..1696cd1","100644"]},{"chunks":[{"content":"@@ -60,6 +60,12 @@","changes":[{"type":"normal","normal":true,"ln1":60,"ln2":60,"content":" "},{"type":"normal","normal":true,"ln1":61,"ln2":61,"content":" #include <fontconfig/fontconfig.h>"},{"type":"normal","normal":true,"ln1":62,"ln2":62,"content":" "},{"type":"add","add":true,"ln":63,"content":"+#ifndef THEBES_USE_PANGO_CAIRO"},{"type":"add","add":true,"ln":64,"content":"+#include <pango/pangoxft.h>"},{"type":"add","add":true,"ln":65,"content":"+#endif // THEBES_USE_PANGO_CAIRO"},{"type":"add","add":true,"ln":66,"content":"+"},{"type":"add","add":true,"ln":67,"content":"+#include <pango/pango-font.h>"},{"type":"add","add":true,"ln":68,"content":"+"},{"type":"normal","normal":true,"ln1":63,"ln2":69,"content":" #include \"nsMathUtils.h\""},{"type":"normal","normal":true,"ln1":64,"ln2":70,"content":" "},{"type":"normal","normal":true,"ln1":65,"ln2":71,"content":" #include \"lcms.h\""}],"oldStart":60,"oldLines":6,"newStart":60,"newLines":12},{"content":"@@ -83,8 +89,6 @@ gfxPlatformGtk::gfxPlatformGtk()","changes":[{"type":"normal","normal":true,"ln1":83,"ln2":89,"content":" #endif"},{"type":"normal","normal":true,"ln1":84,"ln2":90,"content":"     if (!sFontconfigUtils)"},{"type":"normal","normal":true,"ln1":85,"ln2":91,"content":"         sFontconfigUtils = gfxFontconfigUtils::GetFontconfigUtils();"},{"type":"del","del":true,"ln":86,"content":"-"},{"type":"del","del":true,"ln":87,"content":"-    InitDPI();"},{"type":"normal","normal":true,"ln1":88,"ln2":92,"content":" }"},{"type":"normal","normal":true,"ln1":89,"ln2":93,"content":" "},{"type":"normal","normal":true,"ln1":90,"ln2":94,"content":" gfxPlatformGtk::~gfxPlatformGtk()"}],"oldStart":83,"oldLines":8,"newStart":89,"newLines":6},{"content":"@@ -94,6 +98,10 @@ gfxPlatformGtk::~gfxPlatformGtk()","changes":[{"type":"normal","normal":true,"ln1":94,"ln2":98,"content":" "},{"type":"normal","normal":true,"ln1":95,"ln2":99,"content":"     gfxPangoFont::Shutdown();"},{"type":"normal","normal":true,"ln1":96,"ln2":100,"content":" "},{"type":"add","add":true,"ln":101,"content":"+#ifndef THEBES_USE_PANGO_CAIRO"},{"type":"add","add":true,"ln":102,"content":"+    pango_xft_shutdown_display(GDK_DISPLAY(), 0);"},{"type":"add","add":true,"ln":103,"content":"+#endif"},{"type":"add","add":true,"ln":104,"content":"+"},{"type":"normal","normal":true,"ln1":97,"ln2":105,"content":" #if 0"},{"type":"normal","normal":true,"ln1":98,"ln2":106,"content":"     // It would be nice to do this (although it might need to be after"},{"type":"normal","normal":true,"ln1":99,"ln2":107,"content":"     // the cairo shutdown that happens in ~gfxPlatform).  It even looks"}],"oldStart":94,"oldLines":6,"newStart":98,"newLines":10},{"content":"@@ -270,17 +278,93 @@ gfxPlatformGtk::CreateFontGroup(const nsAString &aFamilies,","changes":[{"type":"normal","normal":true,"ln1":270,"ln2":278,"content":"     return new gfxPangoFontGroup(aFamilies, aStyle);"},{"type":"normal","normal":true,"ln1":271,"ln2":279,"content":" }"},{"type":"normal","normal":true,"ln1":272,"ln2":280,"content":" "},{"type":"add","add":true,"ln":281,"content":"+static PRInt32"},{"type":"add","add":true,"ln":282,"content":"+GetXftDPI()"},{"type":"add","add":true,"ln":283,"content":"+{"},{"type":"add","add":true,"ln":284,"content":"+  char *val = XGetDefault(GDK_DISPLAY(), \"Xft\", \"dpi\");"},{"type":"add","add":true,"ln":285,"content":"+  if (val) {"},{"type":"add","add":true,"ln":286,"content":"+    char *e;"},{"type":"add","add":true,"ln":287,"content":"+    double d = strtod(val, &e);"},{"type":"add","add":true,"ln":288,"content":"+"},{"type":"add","add":true,"ln":289,"content":"+    if (e != val)"},{"type":"add","add":true,"ln":290,"content":"+      return NS_lround(d);"},{"type":"add","add":true,"ln":291,"content":"+  }"},{"type":"add","add":true,"ln":292,"content":"+"},{"type":"add","add":true,"ln":293,"content":"+  return -1;"},{"type":"add","add":true,"ln":294,"content":"+}"},{"type":"add","add":true,"ln":295,"content":"+"},{"type":"add","add":true,"ln":296,"content":"+static PRInt32"},{"type":"add","add":true,"ln":297,"content":"+GetDPIFromPangoFont()"},{"type":"add","add":true,"ln":298,"content":"+{"},{"type":"add","add":true,"ln":299,"content":"+#ifndef THEBES_USE_PANGO_CAIRO"},{"type":"add","add":true,"ln":300,"content":"+    PangoContext* ctx = pango_xft_get_context(GDK_DISPLAY(), 0);"},{"type":"add","add":true,"ln":301,"content":"+    gdk_pango_context_set_colormap(ctx, gdk_rgb_get_cmap());"},{"type":"add","add":true,"ln":302,"content":"+#else"},{"type":"add","add":true,"ln":303,"content":"+    PangoContext* ctx ="},{"type":"add","add":true,"ln":304,"content":"+        pango_cairo_font_map_create_context("},{"type":"add","add":true,"ln":305,"content":"+          PANGO_CAIRO_FONT_MAP(pango_cairo_font_map_get_default()));"},{"type":"add","add":true,"ln":306,"content":"+#endif"},{"type":"add","add":true,"ln":307,"content":"+"},{"type":"add","add":true,"ln":308,"content":"+    if (!ctx) {"},{"type":"add","add":true,"ln":309,"content":"+        return 0;"},{"type":"add","add":true,"ln":310,"content":"+    }"},{"type":"add","add":true,"ln":311,"content":"+"},{"type":"add","add":true,"ln":312,"content":"+    double dblDPI = 0.0f;"},{"type":"add","add":true,"ln":313,"content":"+    GList *items = nsnull;"},{"type":"add","add":true,"ln":314,"content":"+    PangoItem *item = nsnull;"},{"type":"add","add":true,"ln":315,"content":"+    PangoFcFont *fcfont = nsnull;"},{"type":"add","add":true,"ln":316,"content":"+    "},{"type":"add","add":true,"ln":317,"content":"+    PangoAttrList *al = pango_attr_list_new();"},{"type":"add","add":true,"ln":318,"content":"+"},{"type":"add","add":true,"ln":319,"content":"+    if (!al) {"},{"type":"add","add":true,"ln":320,"content":"+        goto cleanup;"},{"type":"add","add":true,"ln":321,"content":"+    }"},{"type":"add","add":true,"ln":322,"content":"+"},{"type":"add","add":true,"ln":323,"content":"+    // Just using the string \"a\" because we need _some_ text."},{"type":"add","add":true,"ln":324,"content":"+    items = pango_itemize(ctx, \"a\", 0, 1, al, NULL);"},{"type":"add","add":true,"ln":325,"content":"+"},{"type":"add","add":true,"ln":326,"content":"+    if (!items) {"},{"type":"add","add":true,"ln":327,"content":"+        goto cleanup;"},{"type":"add","add":true,"ln":328,"content":"+    }"},{"type":"add","add":true,"ln":329,"content":"+"},{"type":"add","add":true,"ln":330,"content":"+    item = (PangoItem*)items->data;"},{"type":"add","add":true,"ln":331,"content":"+"},{"type":"add","add":true,"ln":332,"content":"+    if (!item) {"},{"type":"add","add":true,"ln":333,"content":"+        goto cleanup;"},{"type":"add","add":true,"ln":334,"content":"+    }"},{"type":"add","add":true,"ln":335,"content":"+"},{"type":"add","add":true,"ln":336,"content":"+    fcfont = PANGO_FC_FONT(item->analysis.font);"},{"type":"add","add":true,"ln":337,"content":"+"},{"type":"add","add":true,"ln":338,"content":"+    if (!fcfont) {"},{"type":"add","add":true,"ln":339,"content":"+        goto cleanup;"},{"type":"add","add":true,"ln":340,"content":"+    }"},{"type":"add","add":true,"ln":341,"content":"+"},{"type":"add","add":true,"ln":342,"content":"+    FcPatternGetDouble(fcfont->font_pattern, FC_DPI, 0, &dblDPI);"},{"type":"add","add":true,"ln":343,"content":"+"},{"type":"add","add":true,"ln":344,"content":"+ cleanup:   "},{"type":"add","add":true,"ln":345,"content":"+    if (al)"},{"type":"add","add":true,"ln":346,"content":"+        pango_attr_list_unref(al);"},{"type":"add","add":true,"ln":347,"content":"+    if (item)"},{"type":"add","add":true,"ln":348,"content":"+        pango_item_free(item);"},{"type":"add","add":true,"ln":349,"content":"+    if (items)"},{"type":"add","add":true,"ln":350,"content":"+        g_list_free(items);"},{"type":"add","add":true,"ln":351,"content":"+    if (ctx)"},{"type":"add","add":true,"ln":352,"content":"+        g_object_unref(ctx);"},{"type":"add","add":true,"ln":353,"content":"+"},{"type":"add","add":true,"ln":354,"content":"+    return NS_lround(dblDPI);"},{"type":"add","add":true,"ln":355,"content":"+}"},{"type":"add","add":true,"ln":356,"content":"+"},{"type":"normal","normal":true,"ln1":273,"ln2":357,"content":" /* static */"},{"type":"normal","normal":true,"ln1":274,"ln2":358,"content":" void"},{"type":"normal","normal":true,"ln1":275,"ln2":359,"content":" gfxPlatformGtk::InitDPI()"},{"type":"normal","normal":true,"ln1":276,"ln2":360,"content":" {"},{"type":"del","del":true,"ln":277,"content":"-    PangoContext *context = gdk_pango_context_get ();"},{"type":"del","del":true,"ln":278,"content":"-    sDPI = pango_cairo_context_get_resolution (context);"},{"type":"del","del":true,"ln":279,"content":"-    g_object_unref (context);"},{"type":"del","del":true,"ln":280,"content":"-"},{"type":"add","add":true,"ln":361,"content":"+    sDPI = GetXftDPI();"},{"type":"normal","normal":true,"ln1":281,"ln2":362,"content":"     if (sDPI <= 0) {"},{"type":"del","del":true,"ln":282,"content":"-\t// Fall back to something sane"},{"type":"del","del":true,"ln":283,"content":"-\tsDPI = 96;"},{"type":"add","add":true,"ln":363,"content":"+        sDPI = GetDPIFromPangoFont();"},{"type":"add","add":true,"ln":364,"content":"+        if (sDPI <= 0) {"},{"type":"add","add":true,"ln":365,"content":"+            // Fall back to something sane"},{"type":"add","add":true,"ln":366,"content":"+            sDPI = 96;"},{"type":"add","add":true,"ln":367,"content":"+        }"},{"type":"normal","normal":true,"ln1":284,"ln2":368,"content":"     }"},{"type":"normal","normal":true,"ln1":285,"ln2":369,"content":" }"},{"type":"normal","normal":true,"ln1":286,"ln2":370,"content":" "}],"oldStart":270,"oldLines":17,"newStart":278,"newLines":93}],"deletions":8,"additions":92,"from":"gfx/thebes/src/gfxPlatformGtk.cpp","to":"gfx/thebes/src/gfxPlatformGtk.cpp","index":["826f997..4d5f4e0","100644"]}]}