# HG changeset patch
# Parent 096ac689dbe96c8bdee96432f062057f70a335ce
diff --git a/security/manager/ssl/tests/mochitest/mixedcontent/mixedContentTest.js b/security/manager/ssl/tests/mochitest/mixedcontent/mixedContentTest.js
--- a/security/manager/ssl/tests/mochitest/mixedcontent/mixedContentTest.js
+++ b/security/manager/ssl/tests/mochitest/mixedcontent/mixedContentTest.js
@@ -203,8 +203,21 @@ function isSecurityState(expectedState, 
       break;
     case "EV":
       test(ui && !isInsecure && !isBroken && isEV, "for 'EV' expected flags [0,0,1], " + (message || ""));
       break;
     default:
       throw "Invalid isSecurityState state";
   }
 }
+
+function waitForSecurityState(expectedState, callback)
+{
+  var roundsLeft = 200; // Wait for 20 seconds (=200*100ms)
+  var interval =
+  window.setInterval(function() {
+    isSecurityState(expectedState, "", function(isok) {if (isok) {roundsLeft = 0;}});
+    if (!roundsLeft--) {
+      window.clearInterval(interval);
+      callback();
+    }
+  }, 100);
+}
diff --git a/security/manager/ssl/tests/mochitest/mixedcontent/test_cssContent2.html b/security/manager/ssl/tests/mochitest/mixedcontent/test_cssContent2.html
--- a/security/manager/ssl/tests/mochitest/mixedcontent/test_cssContent2.html
+++ b/security/manager/ssl/tests/mochitest/mixedcontent/test_cssContent2.html
@@ -10,20 +10,21 @@
   <script class="testbody" type="text/javascript">
 
   function runTest()
   {
     isSecurityState("secure");
     document.getElementById("para").style.content =
       "url('http://example.com/tests/security/ssl/mixedcontent/moonsurface.jpg')";
 
-    window.setTimeout(function() {
+    waitForSecurityState("broken", function()
+    {
       isSecurityState("broken", "insecure content added by styling breaks security");
       finish();
-    }, 500);
+    });
   }
 
   function afterNavigationTest()
   {
     is(document.getElementById("para").style.content, "");
     isSecurityState("secure", "security full after navigation");
     finish();
   }
diff --git a/security/manager/ssl/tests/mochitest/mixedcontent/test_dynDelayedUnsecurePicture.html b/security/manager/ssl/tests/mochitest/mixedcontent/test_dynDelayedUnsecurePicture.html
--- a/security/manager/ssl/tests/mochitest/mixedcontent/test_dynDelayedUnsecurePicture.html
+++ b/security/manager/ssl/tests/mochitest/mixedcontent/test_dynDelayedUnsecurePicture.html
@@ -13,20 +13,21 @@
   {
     isSecurityState("secure");
     window.setTimeout(function() {
       // Don't do this synchronously from onload handler
       document.getElementById("image1").src =
         "http://example.com/tests/security/ssl/mixedcontent/moonsurface.jpg";
     }, 0);
 
-    window.setTimeout(function() {
+    waitForSecurityState("broken", function()
+    {
       isSecurityState("broken", "src='http://...' changed to broken");
       finish();
-    }, 500);
+    });
   }
 
   function afterNavigationTest()
   {
     is(document.getElementById("image1").src,
       "https://example.com/tests/security/ssl/mixedcontent/moonsurface.jpg",
       "img.src secure again");
     isSecurityState("secure", "security full after navigation");
diff --git a/security/manager/ssl/tests/mochitest/mixedcontent/test_dynUnsecureBackground.html b/security/manager/ssl/tests/mochitest/mixedcontent/test_dynUnsecureBackground.html
--- a/security/manager/ssl/tests/mochitest/mixedcontent/test_dynUnsecureBackground.html
+++ b/security/manager/ssl/tests/mochitest/mixedcontent/test_dynUnsecureBackground.html
@@ -12,20 +12,21 @@
   // This test, as is, equals to https://kuix.de/misc/test17/358438.php
 
   function runTest()
   {
     isSecurityState("secure");
     document.body.background =
       "http://example.com/tests/security/ssl/mixedcontent/moonsurface.jpg";
 
-    window.setTimeout(function() {
+    waitForSecurityState("broken", function() 
+    {
       isSecurityState("broken", "document.body.background='http://...' changed to broken");
       finish();
-    }, 500);
+    });
   }
 
   function afterNavigationTest()
   {
     is(document.body.background,
       "https://example.com/tests/security/ssl/mixedcontent/moonsurface.jpg",
       "document backround secure again");
     isSecurityState("secure", "secure after re-navigation");
diff --git a/security/manager/ssl/tests/mochitest/mixedcontent/test_innerHtmlDelayedUnsecurePicture.html b/security/manager/ssl/tests/mochitest/mixedcontent/test_innerHtmlDelayedUnsecurePicture.html
--- a/security/manager/ssl/tests/mochitest/mixedcontent/test_innerHtmlDelayedUnsecurePicture.html
+++ b/security/manager/ssl/tests/mochitest/mixedcontent/test_innerHtmlDelayedUnsecurePicture.html
@@ -14,21 +14,21 @@
     isSecurityState("secure");
     
     window.setTimeout(function() 
     {
       document.getElementById("buddy").innerHTML =
         "<img id='image1' src='http://example.com/tests/security/ssl/mixedcontent/moonsurface.jpg' />";
     }, 1);
 
-    window.setTimeout(function() 
+    waitForSecurityState("broken", function() 
     {
       isSecurityState("broken", "innerHTML loading insecure changed to broken");
       finish();
-    }, 500);
+    });
   }
 
   function afterNavigationTest()
   {
     is(document.getElementById("buddy").innerHTML, "", "innerHTML back to previous");
     isSecurityState("secure");
     finish();    
   }
