{"bug_id":315871,"commitHash":"6613df3","commit_info":{"sha":"6613df3bd1791371c80fd56d49854d460d3cfe72","commit":{"author":{"name":"kaie@kuix.de","email":"kaie@kuix.de","date":"2007-10-01T16:38:21Z"},"committer":{"name":"kaie@kuix.de","email":"kaie@kuix.de","date":"2007-10-01T16:38:21Z"},"message":"Bug 315871, In Certificate Viewer, allow to export cert or full chain Also covers Bug 161275, Support export of SSL, S/MIME, and CA certs Patch contributed by Kaspar Brand r=kengert, sr=rrelyea, a=dsicore","tree":{"sha":"653e8853aedf1e2a15a29e143ce5cf9872736cd3","url":"https://api.github.com/repos/mozilla/gecko-dev/git/trees/653e8853aedf1e2a15a29e143ce5cf9872736cd3"},"url":"https://api.github.com/repos/mozilla/gecko-dev/git/commits/6613df3bd1791371c80fd56d49854d460d3cfe72","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/mozilla/gecko-dev/commits/6613df3bd1791371c80fd56d49854d460d3cfe72","html_url":"https://github.com/mozilla/gecko-dev/commit/6613df3bd1791371c80fd56d49854d460d3cfe72","comments_url":"https://api.github.com/repos/mozilla/gecko-dev/commits/6613df3bd1791371c80fd56d49854d460d3cfe72/comments","author":{"login":"kaie","id":1382288,"avatar_url":"https://avatars0.githubusercontent.com/u/1382288?v=4","gravatar_id":"","url":"https://api.github.com/users/kaie","html_url":"https://github.com/kaie","followers_url":"https://api.github.com/users/kaie/followers","following_url":"https://api.github.com/users/kaie/following{/other_user}","gists_url":"https://api.github.com/users/kaie/gists{/gist_id}","starred_url":"https://api.github.com/users/kaie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kaie/subscriptions","organizations_url":"https://api.github.com/users/kaie/orgs","repos_url":"https://api.github.com/users/kaie/repos","events_url":"https://api.github.com/users/kaie/events{/privacy}","received_events_url":"https://api.github.com/users/kaie/received_events","type":"User","site_admin":false},"committer":{"login":"kaie","id":1382288,"avatar_url":"https://avatars0.githubusercontent.com/u/1382288?v=4","gravatar_id":"","url":"https://api.github.com/users/kaie","html_url":"https://github.com/kaie","followers_url":"https://api.github.com/users/kaie/followers","following_url":"https://api.github.com/users/kaie/following{/other_user}","gists_url":"https://api.github.com/users/kaie/gists{/gist_id}","starred_url":"https://api.github.com/users/kaie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kaie/subscriptions","organizations_url":"https://api.github.com/users/kaie/orgs","repos_url":"https://api.github.com/users/kaie/repos","events_url":"https://api.github.com/users/kaie/events{/privacy}","received_events_url":"https://api.github.com/users/kaie/received_events","type":"User","site_admin":false},"parents":[{"sha":"59d112fa4c8cc9e14c2ccd446a1b63988f70f00f","url":"https://api.github.com/repos/mozilla/gecko-dev/commits/59d112fa4c8cc9e14c2ccd446a1b63988f70f00f","html_url":"https://github.com/mozilla/gecko-dev/commit/59d112fa4c8cc9e14c2ccd446a1b63988f70f00f"}],"stats":{"total":433,"additions":406,"deletions":27},"files":[{"sha":"762af9fd7f41f4ec65cdbf58e3143ed98f0d493e","filename":"security/manager/locales/en-US/chrome/pippki/certManager.dtd","status":"modified","additions":8,"deletions":6,"changes":14,"blob_url":"https://github.com/mozilla/gecko-dev/blob/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/locales/en-US/chrome/pippki/certManager.dtd","raw_url":"https://github.com/mozilla/gecko-dev/raw/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/locales/en-US/chrome/pippki/certManager.dtd","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/security/manager/locales/en-US/chrome/pippki/certManager.dtd?ref=6613df3bd1791371c80fd56d49854d460d3cfe72","patch":"@@ -102,21 +102,23 @@\n \n <!ENTITY certmgr.close.label                  \"Close\">\n <!ENTITY certmgr.close.accesskey              \"C\">\n-<!ENTITY certmgr.view.label                   \"View\">\n+<!ENTITY certmgr.view2.label                   \"View…\">\n <!ENTITY certmgr.view.accesskey               \"V\">\n-<!ENTITY certmgr.edit.label                   \"Edit\">\n+<!ENTITY certmgr.edit2.label                   \"Edit…\">\n <!ENTITY certmgr.edit.accesskey               \"E\">\n <!ENTITY certmgr.editca.label                 \"Edit CA Trust\">\n <!ENTITY certmgr.editca.accesskey             \"d\">\n <!ENTITY certmgr.add.label                    \"Add\">\n <!ENTITY certmgr.add.accesskey                \"A\">\n-<!ENTITY certmgr.delete.label                 \"Delete\">\n+<!ENTITY certmgr.export.label                 \"Export…\">\n+<!ENTITY certmgr.export.accesskey             \"x\">\n+<!ENTITY certmgr.delete2.label                 \"Delete…\">\n <!ENTITY certmgr.delete.accesskey             \"D\">\n-<!ENTITY certmgr.backup.label                 \"Backup\">\n+<!ENTITY certmgr.backup2.label                 \"Backup…\">\n <!ENTITY certmgr.backup.accesskey             \"B\">\n-<!ENTITY certmgr.backupall.label              \"Backup All\">\n+<!ENTITY certmgr.backupall2.label              \"Backup All…\">\n <!ENTITY certmgr.backupall.accesskey          \"k\">\n-<!ENTITY certmgr.restore.label                \"Import\">\n+<!ENTITY certmgr.restore2.label                \"Import…\">\n <!ENTITY certmgr.restore.accesskey            \"m\">\n <!ENTITY certmgr.details.label                \"Certificate Fields\">\n <!ENTITY certmgr.details.accesskey            \"F\">"},{"sha":"65baa063e34a2d1d7171b98721048a538399df82","filename":"security/manager/locales/en-US/chrome/pippki/pippki.properties","status":"modified","additions":14,"deletions":0,"changes":14,"blob_url":"https://github.com/mozilla/gecko-dev/blob/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/locales/en-US/chrome/pippki/pippki.properties","raw_url":"https://github.com/mozilla/gecko-dev/raw/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/locales/en-US/chrome/pippki/pippki.properties","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/security/manager/locales/en-US/chrome/pippki/pippki.properties?ref=6613df3bd1791371c80fd56d49854d460d3cfe72","patch":"@@ -195,3 +195,17 @@ file_browse_Certificate_spec=Certificate Files\n \n # Form Signing confirmation prompt\n formSigningIntro=The site '%S' has requested that you sign the following text message:\n+\n+# Cert export\n+SaveCertAs=Save Certificate To File\n+CertFormatBase64=X.509 Certificate (PEM)\n+CertFormatBase64Chain=X.509 Certificate with chain (PEM)\n+CertFormatDER=X.509 Certificate (DER)\n+CertFormatPKCS7=X.509 Certificate (PKCS#7)\n+CertFormatPKCS7Chain=X.509 Certificate with chain (PKCS#7)\n+writeFileFailure=File Error\n+writeFileFailed=Can't write to file %S:\\n%S.\n+writeFileAccessDenied=Access denied\n+writeFileIsLocked=File is locked\n+writeFileNoDeviceSpace=No space left on device\n+writeFileUnknownError=Unknown error"},{"sha":"4e52e3b51c45cde57a369c8b9d9e10b418f158ca","filename":"security/manager/pki/resources/content/CAOverlay.xul","status":"modified","additions":8,"deletions":4,"changes":12,"blob_url":"https://github.com/mozilla/gecko-dev/blob/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/pki/resources/content/CAOverlay.xul","raw_url":"https://github.com/mozilla/gecko-dev/raw/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/pki/resources/content/CAOverlay.xul","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/security/manager/pki/resources/content/CAOverlay.xul?ref=6613df3bd1791371c80fd56d49854d460d3cfe72","patch":"@@ -66,19 +66,23 @@\n \n     <hbox>\n       <button id=\"ca_viewButton\"\n-              label=\"&certmgr.view.label;\"\n+              label=\"&certmgr.view2.label;\"\n               accesskey=\"&certmgr.view.accesskey;\"\n               disabled=\"true\" oncommand=\"viewCerts();\"/>\n       <button id=\"ca_editButton\"\n-              label=\"&certmgr.edit.label;\"\n+              label=\"&certmgr.edit2.label;\"\n               accesskey=\"&certmgr.edit.accesskey;\"\n               disabled=\"true\" oncommand=\"editCerts();\"/>\n       <button id=\"ca_addButton\"\n-              label=\"&certmgr.restore.label;\"\n+              label=\"&certmgr.restore2.label;\"\n               accesskey=\"&certmgr.restore.accesskey;\"\n               oncommand=\"addCACerts();\"/>\n+      <button id=\"ca_exportButton\"\n+              label=\"&certmgr.export.label;\"\n+              accesskey=\"&certmgr.export.accesskey;\"\n+              disabled=\"true\" oncommand=\"exportCerts();\"/>\n       <button id=\"ca_deleteButton\"\n-              label=\"&certmgr.delete.label;\"\n+              label=\"&certmgr.delete2.label;\"\n               accesskey=\"&certmgr.delete.accesskey;\"\n               disabled=\"true\" oncommand=\"deleteCerts();\"/>\n     </hbox>"},{"sha":"e6a1015140f38f2c1a228061ffb066eebd49ded6","filename":"security/manager/pki/resources/content/MineOverlay.xul","status":"modified","additions":5,"deletions":5,"changes":10,"blob_url":"https://github.com/mozilla/gecko-dev/blob/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/pki/resources/content/MineOverlay.xul","raw_url":"https://github.com/mozilla/gecko-dev/raw/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/pki/resources/content/MineOverlay.xul","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/security/manager/pki/resources/content/MineOverlay.xul?ref=6613df3bd1791371c80fd56d49854d460d3cfe72","patch":"@@ -82,23 +82,23 @@\n \n     <hbox>\n        <button id=\"mine_viewButton\" class=\"normal\" \n-               label=\"&certmgr.view.label;\"\n+               label=\"&certmgr.view2.label;\"\n                accesskey=\"&certmgr.view.accesskey;\"\n                disabled=\"true\" oncommand=\"viewCerts();\"/>\n        <button id=\"mine_backupButton\" class=\"normal\" \n-               label=\"&certmgr.backup.label;\"\n+               label=\"&certmgr.backup2.label;\"\n                accesskey=\"&certmgr.backup.accesskey;\"\n                disabled=\"true\" oncommand=\"backupCerts();\"/>\n        <button id=\"mine_backupAllButton\" class=\"normal\" \n-               label=\"&certmgr.backupall.label;\"\n+               label=\"&certmgr.backupall2.label;\"\n                accesskey=\"&certmgr.backupall.accesskey;\"\n                oncommand=\"backupAllCerts();\"/>\n        <button id=\"mine_restoreButton\" class=\"normal\" \n-               label=\"&certmgr.restore.label;\"\n+               label=\"&certmgr.restore2.label;\"\n                accesskey=\"&certmgr.restore.accesskey;\"\n                oncommand=\"restoreCerts();\"/>\n        <button id=\"mine_deleteButton\" class=\"normal\" \n-               label=\"&certmgr.delete.label;\"\n+               label=\"&certmgr.delete2.label;\"\n                accesskey=\"&certmgr.delete.accesskey;\"\n                disabled=\"true\" oncommand=\"deleteCerts();\"/>\n     </hbox>"},{"sha":"1a66fff60ca19f91f33db0d8dce8b83ae392aec1","filename":"security/manager/pki/resources/content/OrphanOverlay.xul","status":"modified","additions":6,"deletions":2,"changes":8,"blob_url":"https://github.com/mozilla/gecko-dev/blob/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/pki/resources/content/OrphanOverlay.xul","raw_url":"https://github.com/mozilla/gecko-dev/raw/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/pki/resources/content/OrphanOverlay.xul","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/security/manager/pki/resources/content/OrphanOverlay.xul?ref=6613df3bd1791371c80fd56d49854d460d3cfe72","patch":"@@ -67,11 +67,15 @@\n \n     <hbox>\n        <button id=\"orphan_viewButton\" class=\"normal\" \n-               label=\"&certmgr.view.label;\"\n+               label=\"&certmgr.view2.label;\"\n                accesskey=\"&certmgr.view.accesskey;\"\n                disabled=\"true\" oncommand=\"viewCerts();\"/>\n+       <button id=\"orphan_exportButton\" class=\"normal\" \n+               label=\"&certmgr.export.label;\"\n+               accesskey=\"&certmgr.export.accesskey;\"\n+               disabled=\"true\" oncommand=\"exportCerts();\"/>\n        <button id=\"orphan_deleteButton\" class=\"normal\" \n-               label=\"&certmgr.delete.label;\"\n+               label=\"&certmgr.delete2.label;\"\n                accesskey=\"&certmgr.delete.accesskey;\"\n                disabled=\"true\" oncommand=\"deleteCerts();\"/>\n     </hbox>"},{"sha":"8a5dc4e81f26f770701d3f7e0d4fc8bb132fb111","filename":"security/manager/pki/resources/content/OthersOverlay.xul","status":"modified","additions":8,"deletions":4,"changes":12,"blob_url":"https://github.com/mozilla/gecko-dev/blob/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/pki/resources/content/OthersOverlay.xul","raw_url":"https://github.com/mozilla/gecko-dev/raw/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/pki/resources/content/OthersOverlay.xul","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/security/manager/pki/resources/content/OthersOverlay.xul?ref=6613df3bd1791371c80fd56d49854d460d3cfe72","patch":"@@ -73,19 +73,23 @@\n \n     <hbox>\n       <button id=\"email_viewButton\"\n-              label=\"&certmgr.view.label;\"\n+              label=\"&certmgr.view2.label;\"\n               accesskey=\"&certmgr.view.accesskey;\"\n               disabled=\"true\" oncommand=\"viewCerts();\"/>\n       <button id=\"email_editButton\"\n-              label=\"&certmgr.edit.label;\"\n+              label=\"&certmgr.edit2.label;\"\n               accesskey=\"&certmgr.edit.accesskey;\"\n               disabled=\"true\" oncommand=\"editCerts();\"/>\n       <button id=\"email_addButton\"\n-              label=\"&certmgr.restore.label;\"\n+              label=\"&certmgr.restore2.label;\"\n               accesskey=\"&certmgr.restore.accesskey;\"\n               oncommand=\"addEmailCert();\"/>\n+      <button id=\"email_exportButton\"\n+              label=\"&certmgr.export.label;\"\n+              accesskey=\"&certmgr.export.accesskey;\"\n+              disabled=\"true\" oncommand=\"exportCerts();\"/>\n       <button id=\"email_deleteButton\"\n-              label=\"&certmgr.delete.label;\"\n+              label=\"&certmgr.delete2.label;\"\n               accesskey=\"&certmgr.delete.accesskey;\"\n               disabled=\"true\" oncommand=\"deleteCerts();\"/>\n     </hbox>"},{"sha":"ce8da8d4e6aee5e2fd6043d57119171543198f15","filename":"security/manager/pki/resources/content/WebSitesOverlay.xul","status":"modified","additions":8,"deletions":4,"changes":12,"blob_url":"https://github.com/mozilla/gecko-dev/blob/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/pki/resources/content/WebSitesOverlay.xul","raw_url":"https://github.com/mozilla/gecko-dev/raw/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/pki/resources/content/WebSitesOverlay.xul","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/security/manager/pki/resources/content/WebSitesOverlay.xul?ref=6613df3bd1791371c80fd56d49854d460d3cfe72","patch":"@@ -72,19 +72,23 @@\n \n     <hbox>\n       <button id=\"websites_viewButton\"\n-              label=\"&certmgr.view.label;\"\n+              label=\"&certmgr.view2.label;\"\n               accesskey=\"&certmgr.view.accesskey;\"\n               disabled=\"true\" oncommand=\"viewCerts();\"/>\n       <button id=\"websites_editButton\"\n-              label=\"&certmgr.edit.label;\"\n+              label=\"&certmgr.edit2.label;\"\n               accesskey=\"&certmgr.edit.accesskey;\"\n               disabled=\"true\" oncommand=\"editCerts();\"/>\n       <button id=\"websites_addButton\"\n-              label=\"&certmgr.restore.label;\"\n+              label=\"&certmgr.restore2.label;\"\n               accesskey=\"&certmgr.restore.accesskey;\"\n               oncommand=\"addWebSiteCert();\"/>\n+      <button id=\"websites_exportButton\"\n+              label=\"&certmgr.export.label;\"\n+              accesskey=\"&certmgr.export.accesskey;\"\n+              disabled=\"true\" oncommand=\"exportCerts();\"/>\n       <button id=\"websites_deleteButton\"\n-              label=\"&certmgr.delete.label;\"\n+              label=\"&certmgr.delete2.label;\"\n               accesskey=\"&certmgr.delete.accesskey;\"\n               disabled=\"true\" oncommand=\"deleteCerts();\"/>\n     </hbox>"},{"sha":"590cc1083e598758df90ba55fe01cbee9d1e124f","filename":"security/manager/pki/resources/content/certDump.xul","status":"modified","additions":7,"deletions":0,"changes":7,"blob_url":"https://github.com/mozilla/gecko-dev/blob/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/pki/resources/content/certDump.xul","raw_url":"https://github.com/mozilla/gecko-dev/raw/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/pki/resources/content/certDump.xul","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/security/manager/pki/resources/content/certDump.xul?ref=6613df3bd1791371c80fd56d49854d460d3cfe72","patch":"@@ -65,5 +65,12 @@\n   <label class=\"header\" value=\"&certmgr.fields.label;\"/>\n   <textbox id=\"certDumpVal\"  multiline=\"true\" rows=\"8\"\n            readonly=\"true\" style=\"font-family: -moz-fixed;\"/>\n+  \n+  <separator class=\"thin\"/>\n+  <hbox>\n+    <button id=\"export_cert\" class=\"normal\" label=\"&certmgr.export.label;\"\n+            accesskey=\"&certmgr.export.accesskey;\"\n+            oncommand=\"exportToFile(window, getCurrentCert());\"/>\n+  </hbox>\n </vbox>\n </overlay>"},{"sha":"042f6b7f1157f66d858646d60e6ae22ab374269b","filename":"security/manager/pki/resources/content/certManager.js","status":"modified","additions":20,"deletions":0,"changes":20,"blob_url":"https://github.com/mozilla/gecko-dev/blob/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/pki/resources/content/certManager.js","raw_url":"https://github.com/mozilla/gecko-dev/raw/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/pki/resources/content/certManager.js","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/security/manager/pki/resources/content/certManager.js?ref=6613df3bd1791371c80fd56d49854d460d3cfe72","patch":"@@ -198,6 +198,8 @@ function ca_enableButtons()\n   enableViewButton.setAttribute(\"disabled\",toggle);\n   var enableEditButton=document.getElementById('ca_editButton');\n   enableEditButton.setAttribute(\"disabled\",edit_toggle);\n+  var enableExportButton=document.getElementById('ca_exportButton');\n+  enableExportButton.setAttribute(\"disabled\",toggle);\n   var enableDeleteButton=document.getElementById('ca_deleteButton');\n   enableDeleteButton.setAttribute(\"disabled\",toggle);\n }\n@@ -228,6 +230,8 @@ function websites_enableButtons()\n   enableViewButton.setAttribute(\"disabled\",toggle);\n   var enableEditButton=document.getElementById('websites_editButton');\n   enableEditButton.setAttribute(\"disabled\",toggle);\n+  var enableExportButton=document.getElementById('websites_exportButton');\n+  enableExportButton.setAttribute(\"disabled\",toggle);\n   var enableDeleteButton=document.getElementById('websites_deleteButton');\n   enableDeleteButton.setAttribute(\"disabled\",toggle);\n }\n@@ -243,6 +247,8 @@ function email_enableButtons()\n   enableViewButton.setAttribute(\"disabled\",toggle);\n   var enableEditButton=document.getElementById('email_editButton');\n   enableEditButton.setAttribute(\"disabled\",toggle);\n+  var enableExportButton=document.getElementById('email_exportButton');\n+  enableExportButton.setAttribute(\"disabled\",toggle);\n   var enableDeleteButton=document.getElementById('email_deleteButton');\n   enableDeleteButton.setAttribute(\"disabled\",toggle);\n }\n@@ -256,6 +262,8 @@ function orphan_enableButtons()\n   }\n   var enableViewButton=document.getElementById('orphan_viewButton');\n   enableViewButton.setAttribute(\"disabled\",toggle);\n+  var enableExportButton=document.getElementById('orphan_exportButton');\n+  enableExportButton.setAttribute(\"disabled\",toggle);\n   var enableDeleteButton=document.getElementById('orphan_deleteButton');\n   enableDeleteButton.setAttribute(\"disabled\",toggle);\n }\n@@ -334,6 +342,18 @@ function restoreCerts()\n   }\n }\n \n+function exportCerts()\n+{\n+  getSelectedCerts();\n+  var numcerts = selected_certs.length;\n+  if (!numcerts)\n+    return;\n+\n+  for (var t=0; t<numcerts; t++) {\n+    exportToFile(window, selected_certs[t]);\n+  }\n+}\n+\n function deleteCerts()\n {\n   getSelectedCerts();"},{"sha":"5df84d3097fdd2a5feafb5f2e00c677465dd470f","filename":"security/manager/pki/resources/content/crlManager.xul","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/mozilla/gecko-dev/blob/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/pki/resources/content/crlManager.xul","raw_url":"https://github.com/mozilla/gecko-dev/raw/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/pki/resources/content/crlManager.xul","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/security/manager/pki/resources/content/crlManager.xul?ref=6613df3bd1791371c80fd56d49854d460d3cfe72","patch":"@@ -97,7 +97,7 @@\n             accesskey=\"&validation.updatecrl.accesskey;\"\n             oncommand=\"UpdateCRL();\"/>\n     <button id=\"importCRL\" class=\"push\"\n-            label=\"&certmgr.restore.label;\"\n+            label=\"&certmgr.restore2.label;\"\n             accesskey=\"&certmgr.restore.accesskey;\"\n             oncommand=\"ImportCRL();\"/>\n     <spacer flex=\"2\"/>"},{"sha":"916a7d13a546ac525c8db4aeac2d54da34256fe5","filename":"security/manager/pki/resources/content/pippki.js","status":"modified","additions":131,"deletions":0,"changes":131,"blob_url":"https://github.com/mozilla/gecko-dev/blob/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/pki/resources/content/pippki.js","raw_url":"https://github.com/mozilla/gecko-dev/raw/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/pki/resources/content/pippki.js","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/security/manager/pki/resources/content/pippki.js?ref=6613df3bd1791371c80fd56d49854d460d3cfe72","patch":"@@ -22,6 +22,7 @@\n  *\n  * Contributor(s):\n  *   Javier Delgadillo <javi@netscape.com>\n+ *   Kaspar Brand <mozcontrib@velox.ch>\n  *\n  * Alternatively, the contents of this file may be used under the terms of\n  * either the GNU General Public License Version 2 or later (the \"GPL\"), or\n@@ -61,3 +62,133 @@ function viewCertHelper(parent, cert) {\n   var cd = Components.classes[nsCertificateDialogs].getService(nsICertificateDialogs);\n   cd.viewCert(parent, cert);\n }\n+\n+function getDERString(cert)\n+{\n+  var length = {};\n+  var derArray = cert.getRawDER(length);\n+  var derString = '';\n+  for (var i = 0; i < derArray.length; i++) {\n+    derString += String.fromCharCode(derArray[i]);\n+  }\n+  return derString;\n+}\n+\n+function getPKCS7String(cert, chainMode)\n+{\n+  var length = {};\n+  cert.QueryInterface(Components.interfaces.nsIX509Cert3);\n+  var pkcs7Array = cert.exportAsCMS(chainMode, length);\n+  var pkcs7String = '';\n+  for (var i = 0; i < pkcs7Array.length; i++) {\n+    pkcs7String += String.fromCharCode(pkcs7Array[i]);\n+  }\n+  return pkcs7String;\n+}\n+\n+function getPEMString(cert)\n+{\n+  var derb64 = btoa(getDERString(cert));\n+  // Wrap the Base64 string into lines of 64 characters, \n+  // with CRLF line breaks (as specified in RFC 1421).\n+  var wrapped = derb64.replace(/(\\S{64}(?!$))/g, \"$1\\r\\n\");\n+  return \"-----BEGIN CERTIFICATE-----\\r\\n\"\n+         + wrapped\n+         + \"\\r\\n-----END CERTIFICATE-----\\r\\n\";\n+}\n+ \n+function alertPromptService(title, message)\n+{\n+  var ps = null;\n+  var ps = Components.classes[\"@mozilla.org/embedcomp/prompt-service;1\"].\n+           getService(Components.interfaces.nsIPromptService);\n+  ps.alert(window, title, message);\n+}\n+\n+function exportToFile(parent, cert)\n+{\n+  var bundle = srGetStrBundle(\"chrome://pippki/locale/pippki.properties\");\n+  if (!cert)\n+    return;\n+\n+  var nsIFilePicker = Components.interfaces.nsIFilePicker;\n+  var fp = Components.classes[\"@mozilla.org/filepicker;1\"].\n+           createInstance(nsIFilePicker);\n+  fp.init(parent, bundle.GetStringFromName(\"SaveCertAs\"),\n+          nsIFilePicker.modeSave);\n+  var filename = cert.commonName;\n+  if (!filename.length)\n+    filename = cert.windowTitle;\n+  // remove all whitespace from the default filename\n+  fp.defaultString = filename.replace(/\\s*/g,'');\n+  fp.defaultExtension = \"crt\";\n+  fp.appendFilter(bundle.GetStringFromName(\"CertFormatBase64\"), \"*.crt; *.pem\");\n+  fp.appendFilter(bundle.GetStringFromName(\"CertFormatBase64Chain\"), \"*.crt; *.pem\");\n+  fp.appendFilter(bundle.GetStringFromName(\"CertFormatDER\"), \"*.der\");\n+  fp.appendFilter(bundle.GetStringFromName(\"CertFormatPKCS7\"), \"*.p7c\");\n+  fp.appendFilter(bundle.GetStringFromName(\"CertFormatPKCS7Chain\"), \"*.p7c\");\n+  fp.appendFilters(nsIFilePicker.filterAll);\n+  var res = fp.show();\n+  if (res != nsIFilePicker.returnOK && res != nsIFilePicker.returnReplace)\n+    return;\n+\n+  var content = '';\n+  switch (fp.filterIndex) {\n+    case 1:\n+      content = getPEMString(cert);\n+      var chain = cert.getChain();\n+      for (var i = 1; i < chain.length; i++)\n+        content += getPEMString(chain.queryElementAt(i, Components.interfaces.nsIX509Cert));\n+      break;\n+    case 2:\n+      content = getDERString(cert);\n+      break;\n+    case 3:\n+      content = getPKCS7String(cert, Components.interfaces.nsIX509Cert3.CMS_CHAIN_MODE_CertOnly);\n+      break;\n+    case 4:\n+      content = getPKCS7String(cert, Components.interfaces.nsIX509Cert3.CMS_CHAIN_MODE_CertChainWithRoot);\n+      break;\n+    case 0:\n+    default:\n+      content = getPEMString(cert);\n+      break;\n+  }\n+  var msg;\n+  var written = 0;\n+  try {\n+    var file = Components.classes[\"@mozilla.org/file/local;1\"].\n+               createInstance(Components.interfaces.nsILocalFile);\n+    file.initWithPath(fp.file.path);\n+    var fos = Components.classes[\"@mozilla.org/network/file-output-stream;1\"].\n+              createInstance(Components.interfaces.nsIFileOutputStream);\n+    // flags: PR_WRONLY | PR_CREATE_FILE | PR_TRUNCATE\n+    fos.init(file, 0x02 | 0x08 | 0x20, 00644, 0);\n+    written = fos.write(content, content.length);\n+    fos.close();\n+  }\n+  catch(e) {\n+    switch (e.result) {\n+      case Components.results.NS_ERROR_FILE_ACCESS_DENIED:\n+        msg = bundle.GetStringFromName(\"writeFileAccessDenied\");\n+        break;\n+      case Components.results.NS_ERROR_FILE_IS_LOCKED:\n+        msg = bundle.GetStringFromName(\"writeFileIsLocked\");\n+        break;\n+      case Components.results.NS_ERROR_FILE_NO_DEVICE_SPACE:\n+      case Components.results.NS_ERROR_FILE_DISK_FULL:\n+        msg = bundle.GetStringFromName(\"writeFileNoDeviceSpace\");\n+        break;\n+      default:\n+        msg = e.message;\n+        break;\n+    }\n+  }\n+  if (written != content.length) {\n+    if (!msg.length)\n+      msg = bundle.GetStringFromName(\"writeFileUnknownError\");\n+    alertPromptService(bundle.GetStringFromName(\"writeFileFailure\"),\n+                       bundle.formatStringFromName(\"writeFileFailed\",\n+                         [ fp.file.path, msg ], 2));\n+  }\n+}"},{"sha":"2917c7ad27f3282c03e04acfe1d860f427f6dc21","filename":"security/manager/pki/resources/content/viewCertDetails.js","status":"modified","additions":27,"deletions":0,"changes":27,"blob_url":"https://github.com/mozilla/gecko-dev/blob/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/pki/resources/content/viewCertDetails.js","raw_url":"https://github.com/mozilla/gecko-dev/raw/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/pki/resources/content/viewCertDetails.js","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/security/manager/pki/resources/content/viewCertDetails.js?ref=6613df3bd1791371c80fd56d49854d460d3cfe72","patch":"@@ -23,6 +23,7 @@\n  *   Ian McGreer <mcgreer@netscape.com>\n  *   Javier Delgadillo <javi@netscape.com>\n  *   Kai Engert <kengert@redhat.com>\n+ *   Kaspar Brand <mozcontrib@velox.ch>\n  *\n  * Alternatively, the contents of this file may be used under the terms of\n  * either the GNU General Public License Version 2 or later (the \"GPL\"), or\n@@ -321,3 +322,29 @@ function getProxyOnUIThread(aObject, aInterface) {\n             aInterface, aObject, 5);\n     // 5 == NS_PROXY_ALWAYS | NS_PROXY_SYNC\n }\n+\n+function getCurrentCert()\n+{\n+  var realIndex;\n+  var tree = document.getElementById('treesetDump');\n+  if (tree.view.selection.isSelected(tree.currentIndex)\n+      && document.getElementById('prettyprint_tab').selected) {\n+    /* if the user manually selected a cert on the Details tab,\n+       then take that one  */\n+    realIndex = tree.currentIndex;    \n+  } else {\n+    /* otherwise, take the one at the bottom of the chain\n+       (i.e. the one of the end-entity, unless we're displaying\n+       CA certs) */\n+    realIndex = tree.view.rowCount - 1;\n+  }\n+  if (realIndex >= 0) {\n+    var item = tree.contentView.getItemAtIndex(realIndex);\n+    var dbKey = item.firstChild.firstChild.getAttribute('display');\n+    var certdb = Components.classes[nsX509CertDB].getService(nsIX509CertDB);\n+    var cert = certdb.findCertByDBKey(dbKey,null);\n+    return cert;\n+  }\n+  /* shouldn't really happen */\n+  return null;\n+}"},{"sha":"fbe7a9f0fb760cefae09a8b73dd0f3b109edce39","filename":"security/manager/ssl/public/nsIX509Cert3.idl","status":"modified","additions":21,"deletions":1,"changes":22,"blob_url":"https://github.com/mozilla/gecko-dev/blob/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/ssl/public/nsIX509Cert3.idl","raw_url":"https://github.com/mozilla/gecko-dev/raw/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/ssl/public/nsIX509Cert3.idl","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/security/manager/ssl/public/nsIX509Cert3.idl?ref=6613df3bd1791371c80fd56d49854d460d3cfe72","patch":"@@ -46,16 +46,36 @@ interface nsICertVerificationListener;\n  * TODO: nsIX509Cert3 should be derived from nsIX509Cert2\n  *       (and nsIX509Cert2 derived from nsIX509Cert)\n  */\n-[scriptable, uuid(402aee39-653c-403f-8be1-6d1824223bf9)]\n+[scriptable, uuid(89d9f248-1160-4935-9f99-2bdbf67b5849)]\n interface nsIX509Cert3 : nsISupports {\n \n+  /**\n+   *  Constants for specifying the chain mode when exporting a certificate\n+   */\n+  const unsigned long CMS_CHAIN_MODE_CertOnly = 1;\n+  const unsigned long CMS_CHAIN_MODE_CertChain = 2;\n+  const unsigned long CMS_CHAIN_MODE_CertChainWithRoot = 3;\n+\n   /**\n    *  Async version of nsIX509Cert::getUsagesArray()\n    *\n    *  Will not block, will request results asynchronously,\n    *  availability of results will be notified.\n    */ \n   void requestUsagesArrayAsync(in nsICertVerificationListener cvl);\n+\n+  /**\n+   *  Obtain the certificate wrapped in a PKCS#7 SignedData structure,\n+   *  with or without the certificate chain\n+   *\n+   *  @param chainMode Whether to include the chain (with or without the root),\n+                       see CMS_CHAIN_MODE constants.\n+   *  @param length The number of bytes of the PKCS#7 data.\n+   *  @param data The bytes representing the PKCS#7 wrapped certificate.\n+   */\n+  void exportAsCMS(in unsigned long chainMode,\n+                   out unsigned long length,\n+                   [retval, array, size_is(length)] out octet data);\n };\n \n [scriptable, uuid(2fd0a785-9f2d-4327-8871-8c3e0783891d)]"},{"sha":"1358b811d63dab22e6c161a96571664ec3cfffb7","filename":"security/manager/ssl/src/nsNSSCertificate.cpp","status":"modified","additions":140,"deletions":0,"changes":140,"blob_url":"https://github.com/mozilla/gecko-dev/blob/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/ssl/src/nsNSSCertificate.cpp","raw_url":"https://github.com/mozilla/gecko-dev/raw/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/ssl/src/nsNSSCertificate.cpp","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/security/manager/ssl/src/nsNSSCertificate.cpp?ref=6613df3bd1791371c80fd56d49854d460d3cfe72","patch":"@@ -43,6 +43,7 @@\n #include \"prprf.h\"\n \n #include \"nsNSSComponent.h\" // for PIPNSS string bundle calls.\n+#include \"nsNSSCleaner.h\"\n #include \"nsCOMPtr.h\"\n #include \"nsIMutableArray.h\"\n #include \"nsNSSCertificate.h\"\n@@ -86,13 +87,21 @@ extern \"C\" {\n #include \"ssl.h\"\n #include \"ocsp.h\"\n #include \"plbase64.h\"\n+#include \"cms.h\"\n+#include \"cert.h\"\n \n #ifdef PR_LOGGING\n extern PRLogModuleInfo* gPIPNSSLog;\n #endif\n \n static NS_DEFINE_CID(kNSSComponentCID, NS_NSSCOMPONENT_CID);\n \n+NSSCleanupAutoPtrClass(CERTCertificateList, CERT_DestroyCertificateList)\n+NSSCleanupAutoPtrClass(CERTCertificate, CERT_DestroyCertificate)\n+NSSCleanupAutoPtrClass(NSSCMSMessage, NSS_CMSMessage_Destroy)\n+NSSCleanupAutoPtrClass_WithParam(PLArenaPool, PORT_FreeArena, FalseParam, PR_FALSE)\n+NSSCleanupAutoPtrClass(NSSCMSSignedData, NSS_CMSSignedData_Destroy)\n+\n // This is being stored in an PRUint32 that can otherwise\n // only take values from nsIX509Cert's list of cert types.\n // As nsIX509Cert is frozen, we choose a value not contained\n@@ -967,6 +976,137 @@ nsNSSCertificate::GetRawDER(PRUint32 *aLength, PRUint8 **aArray)\n   return NS_ERROR_FAILURE;\n }\n \n+NS_IMETHODIMP\n+nsNSSCertificate::ExportAsCMS(PRUint32 chainMode,\n+                              PRUint32 *aLength, PRUint8 **aArray)\n+{\n+  NS_ENSURE_ARG(aLength);\n+  NS_ENSURE_ARG(aArray);\n+\n+  nsNSSShutDownPreventionLock locker;\n+  if (isAlreadyShutDown())\n+    return NS_ERROR_NOT_AVAILABLE;\n+\n+  if (!mCert)\n+    return NS_ERROR_FAILURE;\n+\n+  switch (chainMode) {\n+    case nsIX509Cert3::CMS_CHAIN_MODE_CertOnly:\n+    case nsIX509Cert3::CMS_CHAIN_MODE_CertChain:\n+    case nsIX509Cert3::CMS_CHAIN_MODE_CertChainWithRoot:\n+      break;\n+    default:\n+      return NS_ERROR_INVALID_ARG;\n+  };\n+\n+  PLArenaPool *arena = PORT_NewArena(1024);\n+  PLArenaPoolCleanerFalseParam arenaCleaner(arena);\n+  if (!arena) {\n+    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG,\n+           (\"nsNSSCertificate::ExportAsCMS - out of memory\\n\"));\n+    return NS_ERROR_OUT_OF_MEMORY;\n+  }\n+\n+  NSSCMSMessage *cmsg = NSS_CMSMessage_Create(nsnull);\n+  NSSCMSMessageCleaner cmsgCleaner(cmsg);\n+  if (!cmsg) {\n+    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG,\n+           (\"nsNSSCertificate::ExportAsCMS - can't create CMS message\\n\"));\n+    return NS_ERROR_OUT_OF_MEMORY;\n+  }\n+\n+  /*\n+   * first, create SignedData with the certificate only (no chain)\n+   */\n+  NSSCMSSignedData *sigd = NSS_CMSSignedData_CreateCertsOnly(cmsg, mCert, PR_FALSE);\n+  NSSCMSSignedDataCleaner sigdCleaner(sigd);\n+  if (!sigd) {\n+    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG,\n+           (\"nsNSSCertificate::ExportAsCMS - can't create SignedData\\n\"));\n+    return NS_ERROR_FAILURE;\n+  }\n+\n+  /*\n+   * Calling NSS_CMSSignedData_CreateCertsOnly() will not allow us\n+   * to specify the inclusion of the root, but CERT_CertChainFromCert() does.\n+   * Since CERT_CertChainFromCert() also includes the certificate itself,\n+   * we have to start at the issuing cert (to avoid duplicate certs\n+   * in the SignedData).\n+   */\n+  if (chainMode == nsIX509Cert3::CMS_CHAIN_MODE_CertChain ||\n+      chainMode == nsIX509Cert3::CMS_CHAIN_MODE_CertChainWithRoot) {\n+    CERTCertificate *issuerCert = CERT_FindCertIssuer(mCert, PR_Now(), certUsageAnyCA);\n+    CERTCertificateCleaner issuerCertCleaner(issuerCert);\n+    /*\n+     * the issuerCert of a self signed root is the cert itself,\n+     * so make sure we're not adding duplicates, again\n+     */\n+    if (issuerCert && issuerCert != mCert) {\n+      PRBool includeRoot = \n+        (chainMode == nsIX509Cert3::CMS_CHAIN_MODE_CertChainWithRoot);\n+      CERTCertificateList *certChain = CERT_CertChainFromCert(issuerCert, certUsageAnyCA, includeRoot);\n+      CERTCertificateListCleaner certChainCleaner(certChain);\n+      if (certChain) {\n+        if (NSS_CMSSignedData_AddCertList(sigd, certChain) == SECSuccess) {\n+          certChainCleaner.detach();\n+        }\n+        else {\n+          PR_LOG(gPIPNSSLog, PR_LOG_DEBUG,\n+                 (\"nsNSSCertificate::ExportAsCMS - can't add chain\\n\"));\n+          return NS_ERROR_FAILURE;\n+        }\n+      }\n+      else { \n+        /* try to add the issuerCert, at least */\n+        if (NSS_CMSSignedData_AddCertificate(sigd, issuerCert)\n+            == SECSuccess) {\n+          issuerCertCleaner.detach();\n+        }\n+        else {\n+          PR_LOG(gPIPNSSLog, PR_LOG_DEBUG,\n+                 (\"nsNSSCertificate::ExportAsCMS - can't add issuer cert\\n\"));\n+          return NS_ERROR_FAILURE;\n+        }\n+      }\n+    }\n+  }\n+\n+  NSSCMSContentInfo *cinfo = NSS_CMSMessage_GetContentInfo(cmsg);\n+  if (NSS_CMSContentInfo_SetContent_SignedData(cmsg, cinfo, sigd)\n+       == SECSuccess) {\n+    sigdCleaner.detach();\n+  }\n+  else {\n+    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG,\n+           (\"nsNSSCertificate::ExportAsCMS - can't attach SignedData\\n\"));\n+    return NS_ERROR_FAILURE;\n+  }\n+\n+  SECItem certP7 = { siBuffer, nsnull, 0 };\n+  NSSCMSEncoderContext *ecx = NSS_CMSEncoder_Start(cmsg, nsnull, nsnull, &certP7, arena,\n+                                                   nsnull, nsnull, nsnull, nsnull, nsnull,\n+                                                   nsnull);\n+  if (!ecx) {\n+    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG,\n+           (\"nsNSSCertificate::ExportAsCMS - can't create encoder context\\n\"));\n+    return NS_ERROR_FAILURE;\n+  }\n+\n+  if (NSS_CMSEncoder_Finish(ecx) != SECSuccess) {\n+    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG,\n+           (\"nsNSSCertificate::ExportAsCMS - failed to add encoded data\\n\"));\n+    return NS_ERROR_FAILURE;\n+  }\n+\n+  *aArray = (PRUint8*)nsMemory::Alloc(certP7.len);\n+  if (!*aArray)\n+    return NS_ERROR_OUT_OF_MEMORY;\n+\n+  memcpy(*aArray, certP7.data, certP7.len);\n+  *aLength = certP7.len;\n+  return NS_OK;\n+}\n+\n CERTCertificate *\n nsNSSCertificate::GetCert()\n {"},{"sha":"1bb6683f0d92d74e1e3fc56cef9af6abd90c4828","filename":"security/manager/ssl/src/nsNSSCleaner.h","status":"modified","additions":2,"deletions":0,"changes":2,"blob_url":"https://github.com/mozilla/gecko-dev/blob/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/ssl/src/nsNSSCleaner.h","raw_url":"https://github.com/mozilla/gecko-dev/raw/6613df3bd1791371c80fd56d49854d460d3cfe72/security/manager/ssl/src/nsNSSCleaner.h","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/security/manager/ssl/src/nsNSSCleaner.h?ref=6613df3bd1791371c80fd56d49854d460d3cfe72","patch":"@@ -101,6 +101,7 @@ public:                                            \\\n       object = nsnull;                             \\\n     }                                              \\\n   }                                                \\\n+  void detach() {object=nsnull;}                   \\\n };\n \n #define NSSCleanupAutoPtrClass_WithParam(nsstype, cleanfunc, namesuffix, paramvalue) \\\n@@ -120,6 +121,7 @@ public:                                            \\\n       object = nsnull;                             \\\n     }                                              \\\n   }                                                \\\n+  void detach() {object=nsnull;}                   \\\n };\n \n #endif"}]},"blames":["2b5e9f73","7fe9ea37","545ad9d0","2a9620c30","b53e7e987","9d7a5cb5c","7fe9ea373","65e51528a","02d9df0cf","2a9620c30","b53e7e987","65e51528a","7fe9ea373","07ea6d51","2a9620c3","1a64376d","9d7a5cb5","7fe9ea37","02d9df0c","2a9620c30","b53e7e987","9d7a5cb5c","7fe9ea373","65e51528a","02d9df0cf","9d7a5cb5c","aaa4ab622","65e51528a","461525bb","1a8bd896","1a64376d","e0682e5b","07ea6d51","d1493d11","5852d51b","02d9df0c","7fe9ea37","cc76b7eb","f8583a45","6561bbcb","147e289d","3634d4d9","31db9b54","3634d4d9","9b7392ff","7a6fd67f","b5aaffdf","d4192852","33891979","26d4eeb2","70a0f220","fd5d0bca","1e11b7a6","090cc567","dd409892","1a64376d","fc9a8580","01c86dfa","9254cecf","62f4c951"]}