Index: dom/src/jsurl/nsJSProtocolHandler.cpp
===================================================================
RCS file: /cvsroot/mozilla/dom/src/jsurl/nsJSProtocolHandler.cpp,v
retrieving revision 1.91
diff -u -9 -p -r1.91 nsJSProtocolHandler.cpp
--- dom/src/jsurl/nsJSProtocolHandler.cpp	15 May 2003 01:23:26 -0000	1.91
+++ dom/src/jsurl/nsJSProtocolHandler.cpp	20 May 2003 02:45:21 -0000
@@ -186,43 +186,18 @@ nsresult nsJSThunk::EvaluateScript(nsICh
     }
 
     nsCOMPtr<nsIScriptContext> scriptContext;
     rv = global->GetContext(getter_AddRefs(scriptContext));
     if (NS_FAILED(rv))
         return rv;
 
     if (!scriptContext) return NS_ERROR_FAILURE;
 
-    // Grab a context to evaluate the javascript: URL on. If the
-    // evaluation of a javascript: URL is caused by some running
-    // script, use the context of the running script. If no JS is
-    // running, use the context of the window where the javascript:
-    // URL is being evaluated.
-    nsCOMPtr<nsIScriptContext> evalContext;
-
-    nsCOMPtr<nsIJSContextStack> stack = 
-        do_GetService("@mozilla.org/js/xpc/ContextStack;1");
-    if (stack) {
-        JSContext *cx;
-        if (NS_SUCCEEDED(stack->Peek(&cx)) && cx &&
-            (::JS_GetOptions(cx) & JSOPTION_PRIVATE_IS_NSISUPPORTS)) {
-            nsISupports *supports =
-                NS_STATIC_CAST(nsISupports*, ::JS_GetContextPrivate(cx));
-
-            evalContext = do_QueryInterface(supports);
-        }
-    }
-
-    if (!evalContext) {
-        // No JS on the stack, use the window's context.
-        evalContext = scriptContext;
-    }
-
     // Unescape the script
     NS_UnescapeURL(script);
 
     // Get the url.
     nsCAutoString url;
     rv = mURI->GetSpec(url);
     if (NS_FAILED(rv)) return rv;
 
     // Get principal of code for execution
@@ -291,26 +266,26 @@ nsresult nsJSThunk::EvaluateScript(nsICh
         if (NS_FAILED(rv) || !principal) {
             return NS_ERROR_FAILURE;
         }
     }
 
     // Finally, we have everything needed to evaluate the expression.
     nsString result;
     PRBool bIsUndefined;
 
-    rv = evalContext->EvaluateString(NS_ConvertUTF8toUCS2(script),
-                                     globalJSObject, // obj
-                                     principal,
-                                     url.get(),      // url
-                                     1,              // line no
-                                     nsnull,
-                                     result,
-                                     &bIsUndefined);
+    rv = scriptContext->EvaluateString(NS_ConvertUTF8toUCS2(script),
+                                       globalJSObject, // obj
+                                       principal,
+                                       url.get(),      // url
+                                       1,              // line no
+                                       nsnull,
+                                       result,
+                                       &bIsUndefined);
 
     if (NS_FAILED(rv)) {
         rv = NS_ERROR_MALFORMED_URI;
     }
     else if (bIsUndefined) {
         rv = NS_ERROR_DOM_RETVAL_UNDEFINED;
     }
     else {
         // NS_NewStringInputStream calls ToNewCString
