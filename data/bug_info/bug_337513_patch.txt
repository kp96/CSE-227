Index: caps/src/nsNullPrincipal.cpp
===================================================================
RCS file: /home/bzbarsky/mozilla/cvs-mirror/mozilla/caps/src/nsNullPrincipal.cpp,v
retrieving revision 1.1
diff -u -p -d -8 -r1.1 nsNullPrincipal.cpp
--- caps/src/nsNullPrincipal.cpp	2 Apr 2006 20:58:24 -0000	1.1
+++ caps/src/nsNullPrincipal.cpp	10 May 2006 23:27:01 -0000
@@ -44,16 +44,19 @@
 
 #include "nsNullPrincipal.h"
 #include "nsMemory.h"
 #include "nsIUUIDGenerator.h"
 #include "nsID.h"
 #include "prmem.h" // For PF_Free, 'cause nsID::ToString sucks like that
 #include "nsNetUtil.h"
 #include "nsIClassInfoImpl.h"
+#include "nsNetCID.h"
+
+static NS_DEFINE_CID(kSimpleURICID, NS_SIMPLEURI_CID);
 
 NS_IMPL_QUERY_INTERFACE2_CI(nsNullPrincipal,
                             nsIPrincipal,
                             nsISerializable)
 NS_IMPL_CI_INTERFACE_GETTER2(nsNullPrincipal,
                              nsIPrincipal,
                              nsISerializable)
 
@@ -110,19 +113,25 @@ nsNullPrincipal::Init()
   str.Append(chars);
 
   PR_Free(chars);
   
   if (str.Length() != prefixLen + suffixLen) {
     return NS_ERROR_OUT_OF_MEMORY;
   }
 
-  rv = NS_NewURI(getter_AddRefs(mURI), str);
+  // Use CID so we're sure we get the impl we want
+  mURI = do_CreateInstance(kSimpleURICID, &rv);
   NS_ENSURE_SUCCESS(rv, rv);
 
+  rv = mURI->SetSpec(str);
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  NS_TryToSetImmutable(mURI);
+
   return mJSPrincipals.Init(this, str.get());
 }
 
 /**
  * nsIPrincipal implementation
  */
 
 NS_IMETHODIMP
