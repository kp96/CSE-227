{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas0ea0b1f\""},"diff":[{"chunks":[{"content":"@@ -160,8 +160,6 @@ PlacesTreeView.prototype = {","changes":[{"type":"normal","normal":true,"ln1":160,"ln2":160,"content":"    * Call to completely rebuild the list of visible items. Note if there is no"},{"type":"normal","normal":true,"ln1":161,"ln2":161,"content":"    * tree or root this will just clear out the list, so you can also call this"},{"type":"normal","normal":true,"ln1":162,"ln2":162,"content":"    * when a tree is detached to clear the list."},{"type":"del","del":true,"ln":163,"content":"-   *"},{"type":"del","del":true,"ln":164,"content":"-   * This does NOT update the screen."},{"type":"normal","normal":true,"ln1":165,"ln2":163,"content":"    */"},{"type":"normal","normal":true,"ln1":166,"ln2":164,"content":"   _buildVisibleList: function PTV__buildVisibleList() {"},{"type":"normal","normal":true,"ln1":167,"ln2":165,"content":"     if (this._result) {"}],"oldStart":160,"oldLines":8,"newStart":160,"newLines":6},{"content":"@@ -171,11 +169,6 @@ PlacesTreeView.prototype = {","changes":[{"type":"normal","normal":true,"ln1":171,"ln2":169,"content":"       }"},{"type":"normal","normal":true,"ln1":172,"ln2":170,"content":"     }"},{"type":"normal","normal":true,"ln1":173,"ln2":171,"content":" "},{"type":"del","del":true,"ln":174,"content":"-    var oldCount = this.rowCount;"},{"type":"del","del":true,"ln":175,"content":"-    this._visibleElements.splice(0);"},{"type":"del","del":true,"ln":176,"content":"-    if (this._tree)"},{"type":"del","del":true,"ln":177,"content":"-      this._tree.rowCountChanged(0, -oldCount);"},{"type":"del","del":true,"ln":178,"content":"-"},{"type":"normal","normal":true,"ln1":179,"ln2":172,"content":"     var rootNode = this._result.root;"},{"type":"normal","normal":true,"ln1":180,"ln2":173,"content":"     if (rootNode && this._tree) {"},{"type":"normal","normal":true,"ln1":181,"ln2":174,"content":"       this._computeShowSessions();"}],"oldStart":171,"oldLines":11,"newStart":169,"newLines":6},{"content":"@@ -189,7 +182,7 @@ PlacesTreeView.prototype = {","changes":[{"type":"normal","normal":true,"ln1":189,"ln2":182,"content":"       }"},{"type":"normal","normal":true,"ln1":190,"ln2":183,"content":"       else if (!rootNode.containerOpen) {"},{"type":"normal","normal":true,"ln1":191,"ln2":184,"content":"         // this triggers containerOpened which then builds the visible"},{"type":"del","del":true,"ln":192,"content":"-        // selection"},{"type":"add","add":true,"ln":185,"content":"+        // section"},{"type":"normal","normal":true,"ln1":193,"ln2":186,"content":"         rootNode.containerOpen = true;"},{"type":"normal","normal":true,"ln1":194,"ln2":187,"content":"         return;"},{"type":"normal","normal":true,"ln1":195,"ln2":188,"content":"       }"}],"oldStart":189,"oldLines":7,"newStart":182,"newLines":7},{"content":"@@ -325,8 +318,8 @@ PlacesTreeView.prototype = {","changes":[{"type":"normal","normal":true,"ln1":325,"ln2":318,"content":"     if (aContainer.viewIndex != -1)"},{"type":"normal","normal":true,"ln1":326,"ln2":319,"content":"       replaceCount-=1;"},{"type":"normal","normal":true,"ln1":327,"ln2":320,"content":" "},{"type":"del","del":true,"ln":328,"content":"-    // Mark the removees as invisible"},{"type":"del","del":true,"ln":329,"content":"-    for (var i = 0; i < replaceCount; i ++)"},{"type":"add","add":true,"ln":321,"content":"+    // Mark the removes as invisible"},{"type":"add","add":true,"ln":322,"content":"+    for (var i = 0; i < replaceCount; i++)"},{"type":"normal","normal":true,"ln1":330,"ln2":323,"content":"       this._visibleElements[startReplacement + i].viewIndex = -1;"},{"type":"normal","normal":true,"ln1":331,"ln2":324,"content":" "},{"type":"normal","normal":true,"ln1":332,"ln2":325,"content":"     // Building the new list will set the new elements' visible indices."}],"oldStart":325,"oldLines":8,"newStart":318,"newLines":8},{"content":"@@ -334,6 +327,22 @@ PlacesTreeView.prototype = {","changes":[{"type":"normal","normal":true,"ln1":334,"ln2":327,"content":"     var toOpenElements = [];"},{"type":"normal","normal":true,"ln1":335,"ln2":328,"content":"     this._buildVisibleSection(aContainer, newElements, toOpenElements, startReplacement);"},{"type":"normal","normal":true,"ln1":336,"ln2":329,"content":" "},{"type":"add","add":true,"ln":330,"content":"+    // Persist selection state"},{"type":"add","add":true,"ln":331,"content":"+    var nodesToSelect = [];"},{"type":"add","add":true,"ln":332,"content":"+    var selection = this.selection;"},{"type":"add","add":true,"ln":333,"content":"+    var rc = selection.getRangeCount();"},{"type":"add","add":true,"ln":334,"content":"+    for (var rangeIndex = 0; rangeIndex < rc; rangeIndex++) {"},{"type":"add","add":true,"ln":335,"content":"+      var min = { }, max = { };"},{"type":"add","add":true,"ln":336,"content":"+      selection.getRangeAt(rangeIndex, min, max);"},{"type":"add","add":true,"ln":337,"content":"+      if (min.value > startReplacement + replaceCount)"},{"type":"add","add":true,"ln":338,"content":"+        continue;"},{"type":"add","add":true,"ln":339,"content":"+"},{"type":"add","add":true,"ln":340,"content":"+      for (var nodeIndex = min.value; nodeIndex <= max.value; nodeIndex++) {"},{"type":"add","add":true,"ln":341,"content":"+        if (newElements.indexOf(this._visibleElements[nodeIndex]) != -1)"},{"type":"add","add":true,"ln":342,"content":"+          nodesToSelect.push(this._visibleElements[nodeIndex]);"},{"type":"add","add":true,"ln":343,"content":"+      }"},{"type":"add","add":true,"ln":344,"content":"+    }"},{"type":"add","add":true,"ln":345,"content":"+"},{"type":"normal","normal":true,"ln1":337,"ln2":346,"content":"     // actually update the visible list"},{"type":"normal","normal":true,"ln1":338,"ln2":347,"content":"     this._visibleElements ="},{"type":"normal","normal":true,"ln1":339,"ln2":348,"content":"       this._visibleElements.slice(0, startReplacement).concat(newElements)"}],"oldStart":334,"oldLines":6,"newStart":327,"newLines":22},{"content":"@@ -350,6 +359,9 @@ PlacesTreeView.prototype = {","changes":[{"type":"normal","normal":true,"ln1":350,"ln2":359,"content":"     }"},{"type":"normal","normal":true,"ln1":351,"ln2":360,"content":" "},{"type":"normal","normal":true,"ln1":352,"ln2":361,"content":"     // now update the number of elements"},{"type":"add","add":true,"ln":362,"content":"+    if (nodesToSelect.length > 0)"},{"type":"add","add":true,"ln":363,"content":"+      selection.selectEventsSuppressed = true;"},{"type":"add","add":true,"ln":364,"content":"+"},{"type":"normal","normal":true,"ln1":353,"ln2":365,"content":"     this._tree.beginUpdateBatch();"},{"type":"normal","normal":true,"ln1":354,"ln2":366,"content":"     if (replaceCount)"},{"type":"normal","normal":true,"ln1":355,"ln2":367,"content":"       this._tree.rowCountChanged(startReplacement, -replaceCount);"}],"oldStart":350,"oldLines":6,"newStart":359,"newLines":9},{"content":"@@ -362,6 +374,15 @@ PlacesTreeView.prototype = {","changes":[{"type":"normal","normal":true,"ln1":362,"ln2":374,"content":"       var item = asContainer(toOpenElements[i]);"},{"type":"normal","normal":true,"ln1":363,"ln2":375,"content":"       item.containerOpen = !item.containerOpen;"},{"type":"normal","normal":true,"ln1":364,"ln2":376,"content":"     }"},{"type":"add","add":true,"ln":377,"content":"+"},{"type":"add","add":true,"ln":378,"content":"+    // restore selection"},{"type":"add","add":true,"ln":379,"content":"+    if (nodesToSelect.length > 0) {"},{"type":"add","add":true,"ln":380,"content":"+      for each (var node in nodesToSelect) {"},{"type":"add","add":true,"ln":381,"content":"+        var index = node.viewIndex;"},{"type":"add","add":true,"ln":382,"content":"+        selection.rangedSelect(index, index, true);"},{"type":"add","add":true,"ln":383,"content":"+      }"},{"type":"add","add":true,"ln":384,"content":"+      selection.selectEventsSuppressed = false;"},{"type":"add","add":true,"ln":385,"content":"+    }"},{"type":"normal","normal":true,"ln1":365,"ln2":386,"content":"   },"},{"type":"normal","normal":true,"ln1":366,"ln2":387,"content":" "},{"type":"normal","normal":true,"ln1":367,"ln2":388,"content":"   /**"}],"oldStart":362,"oldLines":6,"newStart":374,"newLines":15},{"content":"@@ -387,7 +408,7 @@ PlacesTreeView.prototype = {","changes":[{"type":"normal","normal":true,"ln1":387,"ln2":408,"content":"     aShowThisOne.value = aTop.time < aNext.time;"},{"type":"normal","normal":true,"ln1":388,"ln2":409,"content":"     return true;"},{"type":"normal","normal":true,"ln1":389,"ln2":410,"content":"   },"},{"type":"del","del":true,"ln":390,"content":"-  "},{"type":"add","add":true,"ln":411,"content":"+"},{"type":"normal","normal":true,"ln1":391,"ln2":412,"content":"   _convertPRTimeToString: function PTV__convertPRTimeToString(aTime) {"},{"type":"normal","normal":true,"ln1":392,"ln2":413,"content":"     var timeInMilliseconds = aTime / 1000; // PRTime is in microseconds"},{"type":"normal","normal":true,"ln1":393,"ln2":414,"content":"     var timeObj = new Date(timeInMilliseconds);"}],"oldStart":387,"oldLines":7,"newStart":408,"newLines":7},{"content":"@@ -415,7 +436,7 @@ PlacesTreeView.prototype = {","changes":[{"type":"normal","normal":true,"ln1":415,"ln2":436,"content":"       timeObj.getDate(), timeObj.getHours(),"},{"type":"normal","normal":true,"ln1":416,"ln2":437,"content":"       timeObj.getMinutes(), timeObj.getSeconds()));"},{"type":"normal","normal":true,"ln1":417,"ln2":438,"content":"   },"},{"type":"del","del":true,"ln":418,"content":"-  "},{"type":"add","add":true,"ln":439,"content":"+"},{"type":"normal","normal":true,"ln1":419,"ln2":440,"content":"   COLUMN_TYPE_UNKNOWN: 0,"},{"type":"normal","normal":true,"ln1":420,"ln2":441,"content":"   COLUMN_TYPE_TITLE: 1,"},{"type":"normal","normal":true,"ln1":421,"ln2":442,"content":"   COLUMN_TYPE_URI: 2,"}],"oldStart":415,"oldLines":7,"newStart":436,"newLines":7},{"content":"@@ -726,12 +747,6 @@ PlacesTreeView.prototype = {","changes":[{"type":"normal","normal":true,"ln1":726,"ln2":747,"content":" "},{"type":"normal","normal":true,"ln1":727,"ln2":748,"content":"     // update flat list to new contents"},{"type":"normal","normal":true,"ln1":728,"ln2":749,"content":"     this._buildVisibleList();"},{"type":"del","del":true,"ln":729,"content":"-"},{"type":"del","del":true,"ln":730,"content":"-    // redraw the tree, inserting new items"},{"type":"del","del":true,"ln":731,"content":"-    this._tree.beginUpdateBatch();"},{"type":"del","del":true,"ln":732,"content":"-    this._tree.rowCountChanged(0, -oldRowCount);"},{"type":"del","del":true,"ln":733,"content":"-    this._tree.rowCountChanged(0, this._visibleElements.length);"},{"type":"del","del":true,"ln":734,"content":"-    this._tree.endUpdateBatch();"},{"type":"normal","normal":true,"ln1":735,"ln2":750,"content":"   },"},{"type":"normal","normal":true,"ln1":736,"ln2":751,"content":" "},{"type":"normal","normal":true,"ln1":737,"ln2":752,"content":"   sortingChanged: function PTV__sortingChanged(aSortingMode) {"}],"oldStart":726,"oldLines":12,"newStart":747,"newLines":6}],"deletions":18,"additions":33,"from":"browser/components/places/content/treeView.js","to":"browser/components/places/content/treeView.js","index":["e845467..7ff2bbb","100644"]}]}