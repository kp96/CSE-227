{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basd18facd\""},"diff":[{"chunks":[{"content":"@@ -171,6 +171,12 @@ nsScriptLoader::~nsScriptLoader()","changes":[{"type":"normal","normal":true,"ln1":171,"ln2":171,"content":"   for (PRInt32 i = 0; i < mPendingRequests.Count(); i++) {"},{"type":"normal","normal":true,"ln1":172,"ln2":172,"content":"     mPendingRequests[i]->FireScriptAvailable(NS_ERROR_ABORT);"},{"type":"normal","normal":true,"ln1":173,"ln2":173,"content":"   }"},{"type":"add","add":true,"ln":174,"content":"+"},{"type":"add","add":true,"ln":175,"content":"+  // Unblock the kids, in case any of them moved to a different document"},{"type":"add","add":true,"ln":176,"content":"+  // subtree in the meantime and therefore aren't actually going away."},{"type":"add","add":true,"ln":177,"content":"+  for (PRUint32 j = 0; j < mPendingChildLoaders.Length(); ++j) {"},{"type":"add","add":true,"ln":178,"content":"+    mPendingChildLoaders[j]->RemoveExecuteBlocker();"},{"type":"add","add":true,"ln":179,"content":"+  }  "},{"type":"normal","normal":true,"ln1":174,"ln2":180,"content":" }"},{"type":"normal","normal":true,"ln1":175,"ln2":181,"content":" "},{"type":"normal","normal":true,"ln1":176,"ln2":182,"content":" NS_IMPL_ISUPPORTS1(nsScriptLoader, nsIStreamLoaderObserver)"}],"oldStart":171,"oldLines":6,"newStart":171,"newLines":12},{"content":"@@ -636,7 +642,7 @@ nsScriptLoader::EvaluateScript(nsScriptLoadRequest* aRequest,","changes":[{"type":"normal","normal":true,"ln1":636,"ln2":642,"content":" void"},{"type":"normal","normal":true,"ln1":637,"ln2":643,"content":" nsScriptLoader::ProcessPendingRequestsAsync()"},{"type":"normal","normal":true,"ln1":638,"ln2":644,"content":" {"},{"type":"del","del":true,"ln":639,"content":"-  if (mPendingRequests.Count()) {"},{"type":"add","add":true,"ln":645,"content":"+  if (mPendingRequests.Count() || !mPendingChildLoaders.IsEmpty()) {"},{"type":"normal","normal":true,"ln1":640,"ln2":646,"content":"     nsCOMPtr<nsIRunnable> ev = new nsRunnableMethod<nsScriptLoader>(this,"},{"type":"normal","normal":true,"ln1":641,"ln2":647,"content":"       &nsScriptLoader::ProcessPendingRequests);"},{"type":"normal","normal":true,"ln1":642,"ln2":648,"content":" "}],"oldStart":636,"oldLines":7,"newStart":642,"newLines":7},{"content":"@@ -653,6 +659,33 @@ nsScriptLoader::ProcessPendingRequests()","changes":[{"type":"normal","normal":true,"ln1":653,"ln2":659,"content":"     mPendingRequests.RemoveObjectAt(0);"},{"type":"normal","normal":true,"ln1":654,"ln2":660,"content":"     ProcessRequest(request);"},{"type":"normal","normal":true,"ln1":655,"ln2":661,"content":"   }"},{"type":"add","add":true,"ln":662,"content":"+"},{"type":"add","add":true,"ln":663,"content":"+  while (ReadyToExecuteScripts() && !mPendingChildLoaders.IsEmpty()) {"},{"type":"add","add":true,"ln":664,"content":"+    nsRefPtr<nsScriptLoader> child = mPendingChildLoaders[0];"},{"type":"add","add":true,"ln":665,"content":"+    mPendingChildLoaders.RemoveElementAt(0);"},{"type":"add","add":true,"ln":666,"content":"+    child->RemoveExecuteBlocker();"},{"type":"add","add":true,"ln":667,"content":"+  }"},{"type":"add","add":true,"ln":668,"content":"+}"},{"type":"add","add":true,"ln":669,"content":"+"},{"type":"add","add":true,"ln":670,"content":"+PRBool"},{"type":"add","add":true,"ln":671,"content":"+nsScriptLoader::ReadyToExecuteScripts()"},{"type":"add","add":true,"ln":672,"content":"+{"},{"type":"add","add":true,"ln":673,"content":"+  // Make sure the SelfReadyToExecuteScripts check is first, so that"},{"type":"add","add":true,"ln":674,"content":"+  // we don't block twice on an ancestor."},{"type":"add","add":true,"ln":675,"content":"+  if (!SelfReadyToExecuteScripts()) {"},{"type":"add","add":true,"ln":676,"content":"+    return PR_FALSE;"},{"type":"add","add":true,"ln":677,"content":"+  }"},{"type":"add","add":true,"ln":678,"content":"+  "},{"type":"add","add":true,"ln":679,"content":"+  for (nsIDocument* doc = mDocument; doc; doc = doc->GetParentDocument()) {"},{"type":"add","add":true,"ln":680,"content":"+    nsScriptLoader* ancestor = doc->ScriptLoader();"},{"type":"add","add":true,"ln":681,"content":"+    if (!ancestor->SelfReadyToExecuteScripts() &&"},{"type":"add","add":true,"ln":682,"content":"+        ancestor->AddPendingChildLoader(this)) {"},{"type":"add","add":true,"ln":683,"content":"+      AddExecuteBlocker();"},{"type":"add","add":true,"ln":684,"content":"+      return PR_FALSE;"},{"type":"add","add":true,"ln":685,"content":"+    }"},{"type":"add","add":true,"ln":686,"content":"+  }"},{"type":"add","add":true,"ln":687,"content":"+"},{"type":"add","add":true,"ln":688,"content":"+  return PR_TRUE;"},{"type":"normal","normal":true,"ln1":656,"ln2":689,"content":" }"},{"type":"normal","normal":true,"ln1":657,"ln2":690,"content":" "},{"type":"normal","normal":true,"ln1":658,"ln2":691,"content":" "}],"oldStart":653,"oldLines":6,"newStart":659,"newLines":33}],"deletions":1,"additions":34,"from":"content/base/src/nsScriptLoader.cpp","to":"content/base/src/nsScriptLoader.cpp","index":["e7ec96c..1bb6891","100644"]},{"chunks":[{"content":"@@ -47,6 +47,8 @@","changes":[{"type":"normal","normal":true,"ln1":47,"ln2":47,"content":" #include \"nsIScriptElement.h\""},{"type":"normal","normal":true,"ln1":48,"ln2":48,"content":" #include \"nsIURI.h\""},{"type":"normal","normal":true,"ln1":49,"ln2":49,"content":" #include \"nsCOMArray.h\""},{"type":"add","add":true,"ln":50,"content":"+#include \"nsTArray.h\""},{"type":"add","add":true,"ln":51,"content":"+#include \"nsAutoPtr.h\""},{"type":"normal","normal":true,"ln1":50,"ln2":52,"content":" #include \"nsIDocument.h\""},{"type":"normal","normal":true,"ln1":51,"ln2":53,"content":" #include \"nsIStreamLoader.h\""},{"type":"normal","normal":true,"ln1":52,"ln2":54,"content":" "}],"oldStart":47,"oldLines":6,"newStart":47,"newLines":8},{"content":"@@ -202,11 +204,26 @@ protected:","changes":[{"type":"normal","normal":true,"ln1":202,"ln2":204,"content":"    */"},{"type":"normal","normal":true,"ln1":203,"ln2":205,"content":"   virtual void ProcessPendingRequestsAsync();"},{"type":"normal","normal":true,"ln1":204,"ln2":206,"content":" "},{"type":"del","del":true,"ln":205,"content":"-  PRBool ReadyToExecuteScripts()"},{"type":"add","add":true,"ln":207,"content":"+  /**"},{"type":"add","add":true,"ln":208,"content":"+   * If true, the loader is ready to execute scripts, and so are all its"},{"type":"add","add":true,"ln":209,"content":"+   * ancestors.  If the loader itself is ready but some ancestor is not, this"},{"type":"add","add":true,"ln":210,"content":"+   * function will add an execute blocker and ask the ancestor to remove it"},{"type":"add","add":true,"ln":211,"content":"+   * once it becomes ready."},{"type":"add","add":true,"ln":212,"content":"+   */"},{"type":"add","add":true,"ln":213,"content":"+  PRBool ReadyToExecuteScripts();"},{"type":"add","add":true,"ln":214,"content":"+"},{"type":"add","add":true,"ln":215,"content":"+  /**"},{"type":"add","add":true,"ln":216,"content":"+   * Return whether just this loader is ready to execute scripts."},{"type":"add","add":true,"ln":217,"content":"+   */"},{"type":"add","add":true,"ln":218,"content":"+  PRBool SelfReadyToExecuteScripts()"},{"type":"normal","normal":true,"ln1":206,"ln2":219,"content":"   {"},{"type":"normal","normal":true,"ln1":207,"ln2":220,"content":"     return mEnabled && !mBlockerCount;"},{"type":"normal","normal":true,"ln1":208,"ln2":221,"content":"   }"},{"type":"normal","normal":true,"ln1":209,"ln2":222,"content":" "},{"type":"add","add":true,"ln":223,"content":"+  PRBool AddPendingChildLoader(nsScriptLoader* aChild) {"},{"type":"add","add":true,"ln":224,"content":"+    return mPendingChildLoaders.AppendElement(aChild) != nsnull;"},{"type":"add","add":true,"ln":225,"content":"+  }"},{"type":"add","add":true,"ln":226,"content":"+  "},{"type":"normal","normal":true,"ln1":210,"ln2":227,"content":"   nsresult ProcessRequest(nsScriptLoadRequest* aRequest);"},{"type":"normal","normal":true,"ln1":211,"ln2":228,"content":"   void FireScriptAvailable(nsresult aResult,"},{"type":"normal","normal":true,"ln1":212,"ln2":229,"content":"                            nsScriptLoadRequest* aRequest);"}],"oldStart":202,"oldLines":11,"newStart":204,"newLines":26},{"content":"@@ -225,6 +242,8 @@ protected:","changes":[{"type":"normal","normal":true,"ln1":225,"ln2":242,"content":"   nsCOMArray<nsIScriptLoaderObserver> mObservers;"},{"type":"normal","normal":true,"ln1":226,"ln2":243,"content":"   nsCOMArray<nsScriptLoadRequest> mPendingRequests;"},{"type":"normal","normal":true,"ln1":227,"ln2":244,"content":"   nsCOMPtr<nsIScriptElement> mCurrentScript;"},{"type":"add","add":true,"ln":245,"content":"+  // XXXbz do we want to cycle-collect these or something?  Not sure."},{"type":"add","add":true,"ln":246,"content":"+  nsTArray< nsRefPtr<nsScriptLoader> > mPendingChildLoaders;"},{"type":"normal","normal":true,"ln1":228,"ln2":247,"content":"   PRUint32 mBlockerCount;"},{"type":"normal","normal":true,"ln1":229,"ln2":248,"content":"   PRPackedBool mEnabled;"},{"type":"normal","normal":true,"ln1":230,"ln2":249,"content":"   PRPackedBool mHadPendingScripts;"}],"oldStart":225,"oldLines":6,"newStart":242,"newLines":8}],"deletions":1,"additions":20,"from":"content/base/src/nsScriptLoader.h","to":"content/base/src/nsScriptLoader.h","index":["5f3efc7..58d8556","100644"]}]}