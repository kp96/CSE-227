{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas93dbb94\""},"diff":[{"chunks":[{"content":"@@ -65,6 +65,7 @@","changes":[{"type":"normal","normal":true,"ln1":65,"ln2":65,"content":" #include \"jsfun.h\""},{"type":"normal","normal":true,"ln1":66,"ln2":66,"content":" #include \"jsgc.h\""},{"type":"normal","normal":true,"ln1":67,"ln2":67,"content":" #include \"jsinterp.h\""},{"type":"add","add":true,"ln":68,"content":"+#include \"jsiter.h\""},{"type":"normal","normal":true,"ln1":68,"ln2":69,"content":" #include \"jslock.h\""},{"type":"normal","normal":true,"ln1":69,"ln2":70,"content":" #include \"jsmath.h\""},{"type":"normal","normal":true,"ln1":70,"ln2":71,"content":" #include \"jsnum.h\""}],"oldStart":65,"oldLines":6,"newStart":65,"newLines":7},{"content":"@@ -86,10 +87,6 @@","changes":[{"type":"normal","normal":true,"ln1":86,"ln2":87,"content":" #include \"jsxml.h\""},{"type":"normal","normal":true,"ln1":87,"ln2":88,"content":" #endif"},{"type":"normal","normal":true,"ln1":88,"ln2":89,"content":" "},{"type":"del","del":true,"ln":89,"content":"-#if JS_HAS_GENERATORS"},{"type":"del","del":true,"ln":90,"content":"-#include \"jsiter.h\""},{"type":"del","del":true,"ln":91,"content":"-#endif"},{"type":"del","del":true,"ln":92,"content":"-"},{"type":"normal","normal":true,"ln1":93,"ln2":90,"content":" #ifdef HAVE_VA_LIST_AS_ARRAY"},{"type":"normal","normal":true,"ln1":94,"ln2":91,"content":" #define JS_ADDRESSOF_VA_LIST(ap) ((va_list *)(ap))"},{"type":"normal","normal":true,"ln1":95,"ln2":92,"content":" #else"}],"oldStart":86,"oldLines":10,"newStart":87,"newLines":6},{"content":"@@ -5549,6 +5546,12 @@ JS_ThrowReportedError(JSContext *cx, const char *message,","changes":[{"type":"normal","normal":true,"ln1":5549,"ln2":5546,"content":"     return js_ErrorToException(cx, message, reportp);"},{"type":"normal","normal":true,"ln1":5550,"ln2":5547,"content":" }"},{"type":"normal","normal":true,"ln1":5551,"ln2":5548,"content":" "},{"type":"add","add":true,"ln":5549,"content":"+JS_PUBLIC_API(JSBool)"},{"type":"add","add":true,"ln":5550,"content":"+JS_ThrowStopIteration(JSContext *cx)"},{"type":"add","add":true,"ln":5551,"content":"+{"},{"type":"add","add":true,"ln":5552,"content":"+    return js_ThrowStopIteration(cx);"},{"type":"add","add":true,"ln":5553,"content":"+}"},{"type":"add","add":true,"ln":5554,"content":"+"},{"type":"normal","normal":true,"ln1":5552,"ln2":5555,"content":" #ifdef JS_THREADSAFE"},{"type":"normal","normal":true,"ln1":5553,"ln2":5556,"content":" /*"},{"type":"normal","normal":true,"ln1":5554,"ln2":5557,"content":"  * Get the owning thread id of a context. Returns 0 if the context is not"}],"oldStart":5549,"oldLines":6,"newStart":5546,"newLines":12}],"deletions":4,"additions":7,"from":"js/src/jsapi.c","to":"js/src/jsapi.c","index":["429c480..1e36f2e","100644"]},{"chunks":[{"content":"@@ -2465,6 +2465,12 @@ extern JS_PUBLIC_API(JSBool)","changes":[{"type":"normal","normal":true,"ln1":2465,"ln2":2465,"content":" JS_ThrowReportedError(JSContext *cx, const char *message,"},{"type":"normal","normal":true,"ln1":2466,"ln2":2466,"content":"                       JSErrorReport *reportp);"},{"type":"normal","normal":true,"ln1":2467,"ln2":2467,"content":" "},{"type":"add","add":true,"ln":2468,"content":"+/*"},{"type":"add","add":true,"ln":2469,"content":"+ * Throws a StopIteration exception on cx."},{"type":"add","add":true,"ln":2470,"content":"+ */"},{"type":"add","add":true,"ln":2471,"content":"+extern JS_PUBLIC_API(JSBool)"},{"type":"add","add":true,"ln":2472,"content":"+JS_ThrowStopIteration(JSContext *cx);"},{"type":"add","add":true,"ln":2473,"content":"+"},{"type":"normal","normal":true,"ln1":2468,"ln2":2474,"content":" #ifdef JS_THREADSAFE"},{"type":"normal","normal":true,"ln1":2469,"ln2":2475,"content":" "},{"type":"normal","normal":true,"ln1":2470,"ln2":2476,"content":" /*"}],"oldStart":2465,"oldLines":6,"newStart":2465,"newLines":12}],"deletions":0,"additions":6,"from":"js/src/jsapi.h","to":"js/src/jsapi.h","index":["e80b715..06da165","100644"]},{"chunks":[{"content":"@@ -270,8 +270,8 @@ IteratorNextImpl(JSContext *cx, JSObject *obj, jsval *rval)","changes":[{"type":"normal","normal":true,"ln1":270,"ln2":270,"content":"     return JS_TRUE;"},{"type":"normal","normal":true,"ln1":271,"ln2":271,"content":" }"},{"type":"normal","normal":true,"ln1":272,"ln2":272,"content":" "},{"type":"del","del":true,"ln":273,"content":"-static JSBool"},{"type":"del","del":true,"ln":274,"content":"-js_ThrowStopIteration(JSContext *cx, JSObject *obj)"},{"type":"add","add":true,"ln":273,"content":"+JSBool"},{"type":"add","add":true,"ln":274,"content":"+js_ThrowStopIteration(JSContext *cx)"},{"type":"normal","normal":true,"ln1":275,"ln2":275,"content":" {"},{"type":"normal","normal":true,"ln1":276,"ln2":276,"content":"     jsval v;"},{"type":"normal","normal":true,"ln1":277,"ln2":277,"content":" "}],"oldStart":270,"oldLines":8,"newStart":270,"newLines":8},{"content":"@@ -295,7 +295,7 @@ iterator_next(JSContext *cx, uintN argc, jsval *vp)","changes":[{"type":"normal","normal":true,"ln1":295,"ln2":295,"content":" "},{"type":"normal","normal":true,"ln1":296,"ln2":296,"content":"     if (*vp == JSVAL_HOLE) {"},{"type":"normal","normal":true,"ln1":297,"ln2":297,"content":"         *vp = JSVAL_NULL;"},{"type":"del","del":true,"ln":298,"content":"-        js_ThrowStopIteration(cx, obj);"},{"type":"add","add":true,"ln":298,"content":"+        js_ThrowStopIteration(cx);"},{"type":"normal","normal":true,"ln1":299,"ln2":299,"content":"         return JS_FALSE;"},{"type":"normal","normal":true,"ln1":300,"ln2":300,"content":"     }"},{"type":"normal","normal":true,"ln1":301,"ln2":301,"content":"     return JS_TRUE;"}],"oldStart":295,"oldLines":7,"newStart":295,"newLines":7},{"content":"@@ -916,7 +916,7 @@ SendToGenerator(JSContext *cx, JSGeneratorOp op, JSObject *obj,","changes":[{"type":"normal","normal":true,"ln1":916,"ln2":916,"content":"             *rval = JSVAL_VOID;"},{"type":"normal","normal":true,"ln1":917,"ln2":917,"content":"             return JS_TRUE;"},{"type":"normal","normal":true,"ln1":918,"ln2":918,"content":"         }"},{"type":"del","del":true,"ln":919,"content":"-        return js_ThrowStopIteration(cx, obj);"},{"type":"add","add":true,"ln":919,"content":"+        return js_ThrowStopIteration(cx);"},{"type":"normal","normal":true,"ln1":920,"ln2":920,"content":"     }"},{"type":"normal","normal":true,"ln1":921,"ln2":921,"content":" "},{"type":"normal","normal":true,"ln1":922,"ln2":922,"content":"     /*"}],"oldStart":916,"oldLines":7,"newStart":916,"newLines":7},{"content":"@@ -990,7 +990,7 @@ generator_op(JSContext *cx, JSGeneratorOp op, jsval *vp)","changes":[{"type":"normal","normal":true,"ln1":990,"ln2":990,"content":"         switch (op) {"},{"type":"normal","normal":true,"ln1":991,"ln2":991,"content":"           case JSGENOP_NEXT:"},{"type":"normal","normal":true,"ln1":992,"ln2":992,"content":"           case JSGENOP_SEND:"},{"type":"del","del":true,"ln":993,"content":"-            return js_ThrowStopIteration(cx, obj);"},{"type":"add","add":true,"ln":993,"content":"+            return js_ThrowStopIteration(cx);"},{"type":"normal","normal":true,"ln1":994,"ln2":994,"content":"           case JSGENOP_THROW:"},{"type":"normal","normal":true,"ln1":995,"ln2":995,"content":"             JS_SetPendingException(cx, vp[2]);"},{"type":"normal","normal":true,"ln1":996,"ln2":996,"content":"             return JS_FALSE;"}],"oldStart":990,"oldLines":7,"newStart":990,"newLines":7}],"deletions":5,"additions":5,"from":"js/src/jsiter.c","to":"js/src/jsiter.c","index":["54dcfa9..7047126","100644"]},{"chunks":[{"content":"@@ -77,6 +77,9 @@ js_CallIteratorNext(JSContext *cx, JSObject *iterobj, jsval *rval);","changes":[{"type":"normal","normal":true,"ln1":77,"ln2":77,"content":" extern void"},{"type":"normal","normal":true,"ln1":78,"ln2":78,"content":" js_CloseNativeIterator(JSContext *cx, JSObject *iterobj);"},{"type":"normal","normal":true,"ln1":79,"ln2":79,"content":" "},{"type":"add","add":true,"ln":80,"content":"+extern JSBool"},{"type":"add","add":true,"ln":81,"content":"+js_ThrowStopIteration(JSContext *cx);"},{"type":"add","add":true,"ln":82,"content":"+"},{"type":"normal","normal":true,"ln1":80,"ln2":83,"content":" #if JS_HAS_GENERATORS"},{"type":"normal","normal":true,"ln1":81,"ln2":84,"content":" "},{"type":"normal","normal":true,"ln1":82,"ln2":85,"content":" /*"}],"oldStart":77,"oldLines":6,"newStart":77,"newLines":9}],"deletions":0,"additions":3,"from":"js/src/jsiter.h","to":"js/src/jsiter.h","index":["4da2ad6..f04cab2","100644"]},{"chunks":[{"content":"@@ -41,6 +41,7 @@","changes":[{"type":"normal","normal":true,"ln1":41,"ln2":41,"content":" #include \"nsDOMError.h\""},{"type":"normal","normal":true,"ln1":42,"ln2":42,"content":" #include \"jsdbgapi.h\""},{"type":"normal","normal":true,"ln1":43,"ln2":43,"content":" #include \"jsobj.h\"    // For OBJ_GET_PROPERTY."},{"type":"add","add":true,"ln":44,"content":"+#include \"jscntxt.h\"  // For JSAutoTempValueRooter."},{"type":"normal","normal":true,"ln1":44,"ln2":45,"content":" #include \"XPCWrapper.h\""},{"type":"normal","normal":true,"ln1":45,"ln2":46,"content":" #include \"nsIDOMWindow.h\""},{"type":"normal","normal":true,"ln1":46,"ln2":47,"content":" #include \"nsIDOMWindowCollection.h\""}],"oldStart":41,"oldLines":6,"newStart":41,"newLines":7},{"content":"@@ -87,6 +88,9 @@ XPC_XOW_Construct(JSContext *cx, JSObject *obj, uintN argc, jsval *argv,","changes":[{"type":"normal","normal":true,"ln1":87,"ln2":88,"content":" JS_STATIC_DLL_CALLBACK(JSBool)"},{"type":"normal","normal":true,"ln1":88,"ln2":89,"content":" XPC_XOW_Equality(JSContext *cx, JSObject *obj, jsval v, JSBool *bp);"},{"type":"normal","normal":true,"ln1":89,"ln2":90,"content":" "},{"type":"add","add":true,"ln":91,"content":"+JS_STATIC_DLL_CALLBACK(JSObject *)"},{"type":"add","add":true,"ln":92,"content":"+XPC_XOW_Iterator(JSContext *cx, JSObject *obj, JSBool keysonly);"},{"type":"add","add":true,"ln":93,"content":"+"},{"type":"normal","normal":true,"ln1":90,"ln2":94,"content":" JSExtendedClass sXPC_XOW_JSClass = {"},{"type":"normal","normal":true,"ln1":91,"ln2":95,"content":"   // JSClass (JSExtendedClass.base) initialization"},{"type":"normal","normal":true,"ln1":92,"ln2":96,"content":"   { \"XPCCrossOriginWrapper\","}],"oldStart":87,"oldLines":6,"newStart":88,"newLines":9},{"content":"@@ -101,8 +105,13 @@ JSExtendedClass sXPC_XOW_JSClass = {","changes":[{"type":"normal","normal":true,"ln1":101,"ln2":105,"content":"     nsnull,              nsnull,"},{"type":"normal","normal":true,"ln1":102,"ln2":106,"content":"     nsnull,              nsnull"},{"type":"normal","normal":true,"ln1":103,"ln2":107,"content":"   },"},{"type":"add","add":true,"ln":108,"content":"+"},{"type":"normal","normal":true,"ln1":104,"ln2":109,"content":"   // JSExtendedClass initialization"},{"type":"del","del":true,"ln":105,"content":"-  XPC_XOW_Equality"},{"type":"add","add":true,"ln":110,"content":"+  XPC_XOW_Equality,"},{"type":"add","add":true,"ln":111,"content":"+  nsnull,             // outerObject"},{"type":"add","add":true,"ln":112,"content":"+  nsnull,             // innerObject"},{"type":"add","add":true,"ln":113,"content":"+  XPC_XOW_Iterator,"},{"type":"add","add":true,"ln":114,"content":"+  JSCLASS_NO_RESERVED_MEMBERS"},{"type":"normal","normal":true,"ln1":106,"ln2":115,"content":" };"},{"type":"normal","normal":true,"ln1":107,"ln2":116,"content":" "},{"type":"normal","normal":true,"ln1":108,"ln2":117,"content":" // The slot that we stick our scope into."}],"oldStart":101,"oldLines":8,"newStart":105,"newLines":13},{"content":"@@ -813,10 +822,10 @@ XPC_XOW_Finalize(JSContext *cx, JSObject *obj)","changes":[{"type":"normal","normal":true,"ln1":813,"ln2":822,"content":" "},{"type":"normal","normal":true,"ln1":814,"ln2":823,"content":"   // Now that we have our scope, see if it's going away. If it is,"},{"type":"normal","normal":true,"ln1":815,"ln2":824,"content":"   // then our work here is going to be done when we destroy the scope"},{"type":"del","del":true,"ln":816,"content":"-  // entirely."},{"type":"add","add":true,"ln":825,"content":"+  // entirely. Scope can be null if we're an enumerating XOW."},{"type":"normal","normal":true,"ln1":817,"ln2":826,"content":"   XPCWrappedNativeScope *scope = reinterpret_cast<XPCWrappedNativeScope *>"},{"type":"normal","normal":true,"ln1":818,"ln2":827,"content":"                                                  (JSVAL_TO_PRIVATE(scopeVal));"},{"type":"del","del":true,"ln":819,"content":"-  if (XPCWrappedNativeScope::IsDyingScope(scope)) {"},{"type":"add","add":true,"ln":828,"content":"+  if (!scope || XPCWrappedNativeScope::IsDyingScope(scope)) {"},{"type":"normal","normal":true,"ln1":820,"ln2":829,"content":"     return;"},{"type":"normal","normal":true,"ln1":821,"ln2":830,"content":"   }"},{"type":"normal","normal":true,"ln1":822,"ln2":831,"content":" "}],"oldStart":813,"oldLines":10,"newStart":822,"newLines":10},{"content":"@@ -937,6 +946,160 @@ XPC_XOW_Equality(JSContext *cx, JSObject *obj, jsval v, JSBool *bp)","changes":[{"type":"normal","normal":true,"ln1":937,"ln2":946,"content":"     equality(cx, obj, OBJECT_TO_JSVAL(test), bp);"},{"type":"normal","normal":true,"ln1":938,"ln2":947,"content":" }"},{"type":"normal","normal":true,"ln1":939,"ln2":948,"content":" "},{"type":"add","add":true,"ln":949,"content":"+JS_STATIC_DLL_CALLBACK(void)"},{"type":"add","add":true,"ln":950,"content":"+IteratorFinalize(JSContext *cx, JSObject *obj)"},{"type":"add","add":true,"ln":951,"content":"+{"},{"type":"add","add":true,"ln":952,"content":"+  jsval v;"},{"type":"add","add":true,"ln":953,"content":"+  JS_GetReservedSlot(cx, obj, 0, &v);"},{"type":"add","add":true,"ln":954,"content":"+"},{"type":"add","add":true,"ln":955,"content":"+  JSIdArray *ida = reinterpret_cast<JSIdArray *>(JSVAL_TO_PRIVATE(v));"},{"type":"add","add":true,"ln":956,"content":"+  if (ida) {"},{"type":"add","add":true,"ln":957,"content":"+    JS_DestroyIdArray(cx, ida);"},{"type":"add","add":true,"ln":958,"content":"+  }"},{"type":"add","add":true,"ln":959,"content":"+}"},{"type":"add","add":true,"ln":960,"content":"+"},{"type":"add","add":true,"ln":961,"content":"+JS_STATIC_DLL_CALLBACK(JSBool)"},{"type":"add","add":true,"ln":962,"content":"+IteratorNext(JSContext *cx, uintN argc, jsval *vp)"},{"type":"add","add":true,"ln":963,"content":"+{"},{"type":"add","add":true,"ln":964,"content":"+  JSObject *obj = JSVAL_TO_OBJECT(vp[1]);"},{"type":"add","add":true,"ln":965,"content":"+  jsval v;"},{"type":"add","add":true,"ln":966,"content":"+"},{"type":"add","add":true,"ln":967,"content":"+  JS_GetReservedSlot(cx, obj, 0, &v);"},{"type":"add","add":true,"ln":968,"content":"+  JSIdArray *ida = reinterpret_cast<JSIdArray *>(JSVAL_TO_PRIVATE(v));"},{"type":"add","add":true,"ln":969,"content":"+"},{"type":"add","add":true,"ln":970,"content":"+  JS_GetReservedSlot(cx, obj, 1, &v);"},{"type":"add","add":true,"ln":971,"content":"+  jsint idx = JSVAL_TO_INT(v);"},{"type":"add","add":true,"ln":972,"content":"+"},{"type":"add","add":true,"ln":973,"content":"+  if (idx == ida->length) {"},{"type":"add","add":true,"ln":974,"content":"+    return JS_ThrowStopIteration(cx);"},{"type":"add","add":true,"ln":975,"content":"+  }"},{"type":"add","add":true,"ln":976,"content":"+"},{"type":"add","add":true,"ln":977,"content":"+  JS_GetReservedSlot(cx, obj, 2, &v);"},{"type":"add","add":true,"ln":978,"content":"+  jsid id = ida->vector[idx++];"},{"type":"add","add":true,"ln":979,"content":"+  if (JSVAL_TO_BOOLEAN(v)) {"},{"type":"add","add":true,"ln":980,"content":"+    if (!JS_IdToValue(cx, id, &v)) {"},{"type":"add","add":true,"ln":981,"content":"+      return JS_FALSE;"},{"type":"add","add":true,"ln":982,"content":"+    }"},{"type":"add","add":true,"ln":983,"content":"+"},{"type":"add","add":true,"ln":984,"content":"+    *vp = v;"},{"type":"add","add":true,"ln":985,"content":"+  } else {"},{"type":"add","add":true,"ln":986,"content":"+    // We need to return an [id, value] pair."},{"type":"add","add":true,"ln":987,"content":"+    if (!OBJ_GET_PROPERTY(cx, JS_GetParent(cx, obj), id, &v)) {"},{"type":"add","add":true,"ln":988,"content":"+      return JS_FALSE;"},{"type":"add","add":true,"ln":989,"content":"+    }"},{"type":"add","add":true,"ln":990,"content":"+"},{"type":"add","add":true,"ln":991,"content":"+    jsval name;"},{"type":"add","add":true,"ln":992,"content":"+    if (!JS_IdToValue(cx, id, &name)) {"},{"type":"add","add":true,"ln":993,"content":"+      return JS_FALSE;"},{"type":"add","add":true,"ln":994,"content":"+    }"},{"type":"add","add":true,"ln":995,"content":"+"},{"type":"add","add":true,"ln":996,"content":"+    jsval vec[2] = { name, v };"},{"type":"add","add":true,"ln":997,"content":"+    JSAutoTempValueRooter tvr(cx, 2, vec);"},{"type":"add","add":true,"ln":998,"content":"+    JSObject *array = JS_NewArrayObject(cx, 2, vec);"},{"type":"add","add":true,"ln":999,"content":"+    if (!array) {"},{"type":"add","add":true,"ln":1000,"content":"+      return JS_FALSE;"},{"type":"add","add":true,"ln":1001,"content":"+    }"},{"type":"add","add":true,"ln":1002,"content":"+"},{"type":"add","add":true,"ln":1003,"content":"+    *vp = OBJECT_TO_JSVAL(array);"},{"type":"add","add":true,"ln":1004,"content":"+  }"},{"type":"add","add":true,"ln":1005,"content":"+"},{"type":"add","add":true,"ln":1006,"content":"+  JS_SetReservedSlot(cx, obj, 1, INT_TO_JSVAL(idx));"},{"type":"add","add":true,"ln":1007,"content":"+  return JS_TRUE;"},{"type":"add","add":true,"ln":1008,"content":"+}"},{"type":"add","add":true,"ln":1009,"content":"+"},{"type":"add","add":true,"ln":1010,"content":"+static JSClass IteratorClass = {"},{"type":"add","add":true,"ln":1011,"content":"+  \"XOW iterator\", JSCLASS_HAS_RESERVED_SLOTS(3),"},{"type":"add","add":true,"ln":1012,"content":"+  JS_PropertyStub, JS_PropertyStub,"},{"type":"add","add":true,"ln":1013,"content":"+  JS_PropertyStub, JS_PropertyStub,"},{"type":"add","add":true,"ln":1014,"content":"+  JS_EnumerateStub, JS_ResolveStub,"},{"type":"add","add":true,"ln":1015,"content":"+  JS_ConvertStub, IteratorFinalize,"},{"type":"add","add":true,"ln":1016,"content":"+"},{"type":"add","add":true,"ln":1017,"content":"+  JSCLASS_NO_OPTIONAL_MEMBERS"},{"type":"add","add":true,"ln":1018,"content":"+};"},{"type":"add","add":true,"ln":1019,"content":"+"},{"type":"add","add":true,"ln":1020,"content":"+"},{"type":"add","add":true,"ln":1021,"content":"+JS_STATIC_DLL_CALLBACK(JSObject *)"},{"type":"add","add":true,"ln":1022,"content":"+XPC_XOW_Iterator(JSContext *cx, JSObject *obj, JSBool keysonly)"},{"type":"add","add":true,"ln":1023,"content":"+{"},{"type":"add","add":true,"ln":1024,"content":"+  // This is rather ugly: we want to use the trick seen in Enumerate,"},{"type":"add","add":true,"ln":1025,"content":"+  // where we use our wrapper's resolve hook to determine if we should"},{"type":"add","add":true,"ln":1026,"content":"+  // enumerate a given property. However, we don't want to pollute the"},{"type":"add","add":true,"ln":1027,"content":"+  // identifiers with a next method, so we create an object that"},{"type":"add","add":true,"ln":1028,"content":"+  // delegates (via the __proto__ link) to a XOW."},{"type":"add","add":true,"ln":1029,"content":"+"},{"type":"add","add":true,"ln":1030,"content":"+  jsval root = JSVAL_NULL;"},{"type":"add","add":true,"ln":1031,"content":"+"},{"type":"add","add":true,"ln":1032,"content":"+  // Root v's address so we can set it and have the right value rooted."},{"type":"add","add":true,"ln":1033,"content":"+  JSAutoTempValueRooter tvr(cx, 1, &root);"},{"type":"add","add":true,"ln":1034,"content":"+"},{"type":"add","add":true,"ln":1035,"content":"+  JSObject *wrapperIter = JS_NewObject(cx, &sXPC_XOW_JSClass.base, nsnull,"},{"type":"add","add":true,"ln":1036,"content":"+                                       JS_GetGlobalForObject(cx, obj));"},{"type":"add","add":true,"ln":1037,"content":"+  if (!wrapperIter) {"},{"type":"add","add":true,"ln":1038,"content":"+    return nsnull;"},{"type":"add","add":true,"ln":1039,"content":"+  }"},{"type":"add","add":true,"ln":1040,"content":"+"},{"type":"add","add":true,"ln":1041,"content":"+  root = OBJECT_TO_JSVAL(wrapperIter);"},{"type":"add","add":true,"ln":1042,"content":"+"},{"type":"add","add":true,"ln":1043,"content":"+  JSObject *iterObj = JS_NewObject(cx, &IteratorClass, wrapperIter, obj);"},{"type":"add","add":true,"ln":1044,"content":"+  if (!iterObj) {"},{"type":"add","add":true,"ln":1045,"content":"+    return nsnull;"},{"type":"add","add":true,"ln":1046,"content":"+  }"},{"type":"add","add":true,"ln":1047,"content":"+"},{"type":"add","add":true,"ln":1048,"content":"+  root = OBJECT_TO_JSVAL(iterObj);"},{"type":"add","add":true,"ln":1049,"content":"+"},{"type":"add","add":true,"ln":1050,"content":"+  // Do this sooner rather than later to avoid complications in"},{"type":"add","add":true,"ln":1051,"content":"+  // IteratorFinalize."},{"type":"add","add":true,"ln":1052,"content":"+  if (!JS_SetReservedSlot(cx, iterObj, 0, PRIVATE_TO_JSVAL(nsnull))) {"},{"type":"add","add":true,"ln":1053,"content":"+    return nsnull;"},{"type":"add","add":true,"ln":1054,"content":"+  }"},{"type":"add","add":true,"ln":1055,"content":"+"},{"type":"add","add":true,"ln":1056,"content":"+  // Initialize iterObj."},{"type":"add","add":true,"ln":1057,"content":"+  if (!JS_DefineFunction(cx, iterObj, \"next\", (JSNative)IteratorNext, 0,"},{"type":"add","add":true,"ln":1058,"content":"+                         JSFUN_FAST_NATIVE)) {"},{"type":"add","add":true,"ln":1059,"content":"+    return nsnull;"},{"type":"add","add":true,"ln":1060,"content":"+  }"},{"type":"add","add":true,"ln":1061,"content":"+"},{"type":"add","add":true,"ln":1062,"content":"+  // Initialize our XOW."},{"type":"add","add":true,"ln":1063,"content":"+  JSObject *innerObj = GetWrappedObject(cx, obj);"},{"type":"add","add":true,"ln":1064,"content":"+  if (!innerObj) {"},{"type":"add","add":true,"ln":1065,"content":"+    ThrowException(NS_ERROR_INVALID_ARG, cx);"},{"type":"add","add":true,"ln":1066,"content":"+    return nsnull;"},{"type":"add","add":true,"ln":1067,"content":"+  }"},{"type":"add","add":true,"ln":1068,"content":"+"},{"type":"add","add":true,"ln":1069,"content":"+  jsval v = OBJECT_TO_JSVAL(innerObj);"},{"type":"add","add":true,"ln":1070,"content":"+  if (!JS_SetReservedSlot(cx, wrapperIter, XPCWrapper::sWrappedObjSlot, v) ||"},{"type":"add","add":true,"ln":1071,"content":"+      !JS_SetReservedSlot(cx, wrapperIter, XPCWrapper::sResolvingSlot,"},{"type":"add","add":true,"ln":1072,"content":"+                          JSVAL_FALSE) ||"},{"type":"add","add":true,"ln":1073,"content":"+      !JS_SetReservedSlot(cx, wrapperIter, XPCWrapper::sNumSlots,"},{"type":"add","add":true,"ln":1074,"content":"+                          PRIVATE_TO_JSVAL(nsnull))) {"},{"type":"add","add":true,"ln":1075,"content":"+    return nsnull;"},{"type":"add","add":true,"ln":1076,"content":"+  }"},{"type":"add","add":true,"ln":1077,"content":"+"},{"type":"add","add":true,"ln":1078,"content":"+  // Start enumerating over all of our properties."},{"type":"add","add":true,"ln":1079,"content":"+  do {"},{"type":"add","add":true,"ln":1080,"content":"+    if (!XPCWrapper::Enumerate(cx, iterObj, innerObj)) {"},{"type":"add","add":true,"ln":1081,"content":"+      return nsnull;"},{"type":"add","add":true,"ln":1082,"content":"+    }"},{"type":"add","add":true,"ln":1083,"content":"+  } while ((innerObj = JS_GetPrototype(cx, innerObj)) != nsnull);"},{"type":"add","add":true,"ln":1084,"content":"+"},{"type":"add","add":true,"ln":1085,"content":"+  JSIdArray *ida = JS_Enumerate(cx, iterObj);"},{"type":"add","add":true,"ln":1086,"content":"+  if (!ida) {"},{"type":"add","add":true,"ln":1087,"content":"+    return nsnull;"},{"type":"add","add":true,"ln":1088,"content":"+  }"},{"type":"add","add":true,"ln":1089,"content":"+"},{"type":"add","add":true,"ln":1090,"content":"+  if (!JS_SetReservedSlot(cx, iterObj, 0, PRIVATE_TO_JSVAL(ida)) ||"},{"type":"add","add":true,"ln":1091,"content":"+      !JS_SetReservedSlot(cx, iterObj, 1, JSVAL_ZERO) ||"},{"type":"add","add":true,"ln":1092,"content":"+      !JS_SetReservedSlot(cx, iterObj, 2, BOOLEAN_TO_JSVAL(keysonly))) {"},{"type":"add","add":true,"ln":1093,"content":"+    return nsnull;"},{"type":"add","add":true,"ln":1094,"content":"+  }"},{"type":"add","add":true,"ln":1095,"content":"+"},{"type":"add","add":true,"ln":1096,"content":"+  if (!JS_SetPrototype(cx, iterObj, nsnull)) {"},{"type":"add","add":true,"ln":1097,"content":"+    return nsnull;"},{"type":"add","add":true,"ln":1098,"content":"+  }"},{"type":"add","add":true,"ln":1099,"content":"+"},{"type":"add","add":true,"ln":1100,"content":"+  return iterObj;"},{"type":"add","add":true,"ln":1101,"content":"+}"},{"type":"add","add":true,"ln":1102,"content":"+"},{"type":"normal","normal":true,"ln1":940,"ln2":1103,"content":" JS_STATIC_DLL_CALLBACK(JSBool)"},{"type":"normal","normal":true,"ln1":941,"ln2":1104,"content":" XPC_XOW_toString(JSContext *cx, JSObject *obj, uintN argc, jsval *argv,"},{"type":"normal","normal":true,"ln1":942,"ln2":1105,"content":"                  jsval *rval)"}],"oldStart":937,"oldLines":6,"newStart":946,"newLines":160}],"deletions":3,"additions":166,"from":"js/src/xpconnect/src/XPCCrossOriginWrapper.cpp","to":"js/src/xpconnect/src/XPCCrossOriginWrapper.cpp","index":["c7b9a8f..3eb2d71","100644"]},{"chunks":[{"content":"@@ -106,30 +106,38 @@ XPCWrapper::Enumerate(JSContext *cx, JSObject *wrapperObj, JSObject *innerObj)","changes":[{"type":"normal","normal":true,"ln1":106,"ln2":106,"content":" "},{"type":"normal","normal":true,"ln1":107,"ln2":107,"content":"   JSBool ok = JS_TRUE;"},{"type":"normal","normal":true,"ln1":108,"ln2":108,"content":" "},{"type":"del","del":true,"ln":109,"content":"-  do {"},{"type":"del","del":true,"ln":110,"content":"-    JSIdArray *ida = JS_Enumerate(cx, innerObj);"},{"type":"del","del":true,"ln":111,"content":"-    if (!ida) {"},{"type":"del","del":true,"ln":112,"content":"-      return JS_FALSE;"},{"type":"add","add":true,"ln":109,"content":"+  JSIdArray *ida = JS_Enumerate(cx, innerObj);"},{"type":"add","add":true,"ln":110,"content":"+  if (!ida) {"},{"type":"add","add":true,"ln":111,"content":"+    return JS_FALSE;"},{"type":"add","add":true,"ln":112,"content":"+  }"},{"type":"add","add":true,"ln":113,"content":"+"},{"type":"add","add":true,"ln":114,"content":"+  for (jsint i = 0, n = ida->length; i < n; i++) {"},{"type":"add","add":true,"ln":115,"content":"+    JSObject *pobj;"},{"type":"add","add":true,"ln":116,"content":"+    JSProperty *prop;"},{"type":"add","add":true,"ln":117,"content":"+"},{"type":"add","add":true,"ln":118,"content":"+    // Let OBJ_LOOKUP_PROPERTY, in particular our NewResolve hook,"},{"type":"add","add":true,"ln":119,"content":"+    // figure out whether this id should be reflected."},{"type":"add","add":true,"ln":120,"content":"+    ok = OBJ_LOOKUP_PROPERTY(cx, wrapperObj, ida->vector[i], &pobj, &prop);"},{"type":"add","add":true,"ln":121,"content":"+    if (!ok) {"},{"type":"add","add":true,"ln":122,"content":"+      break;"},{"type":"normal","normal":true,"ln1":113,"ln2":123,"content":"     }"},{"type":"normal","normal":true,"ln1":114,"ln2":124,"content":" "},{"type":"del","del":true,"ln":115,"content":"-    for (jsint i = 0, n = ida->length; i < n; i++) {"},{"type":"del","del":true,"ln":116,"content":"-      JSObject *pobj;"},{"type":"del","del":true,"ln":117,"content":"-      JSProperty *prop;"},{"type":"add","add":true,"ln":125,"content":"+    if (prop) {"},{"type":"add","add":true,"ln":126,"content":"+      OBJ_DROP_PROPERTY(cx, pobj, prop);"},{"type":"add","add":true,"ln":127,"content":"+    }"},{"type":"normal","normal":true,"ln1":118,"ln2":128,"content":" "},{"type":"del","del":true,"ln":119,"content":"-      // Let OBJ_LOOKUP_PROPERTY, in particular our NewResolve hook,"},{"type":"del","del":true,"ln":120,"content":"-      // figure out whether this id should be reflected."},{"type":"del","del":true,"ln":121,"content":"-      ok = OBJ_LOOKUP_PROPERTY(cx, wrapperObj, ida->vector[i], &pobj, &prop);"},{"type":"del","del":true,"ln":122,"content":"-      if (!ok) {"},{"type":"del","del":true,"ln":123,"content":"-        break;"},{"type":"del","del":true,"ln":124,"content":"-      }"},{"type":"add","add":true,"ln":129,"content":"+    if (pobj != wrapperObj) {"},{"type":"add","add":true,"ln":130,"content":"+      ok = OBJ_DEFINE_PROPERTY(cx, wrapperObj, ida->vector[i], JSVAL_VOID,"},{"type":"add","add":true,"ln":131,"content":"+                               nsnull, nsnull, JSPROP_ENUMERATE | JSPROP_SHARED,"},{"type":"add","add":true,"ln":132,"content":"+                               nsnull);"},{"type":"add","add":true,"ln":133,"content":"+    }"},{"type":"normal","normal":true,"ln1":125,"ln2":134,"content":" "},{"type":"del","del":true,"ln":126,"content":"-      if (prop) {"},{"type":"del","del":true,"ln":127,"content":"-        OBJ_DROP_PROPERTY(cx, pobj, prop);"},{"type":"del","del":true,"ln":128,"content":"-      }"},{"type":"add","add":true,"ln":135,"content":"+    if (!ok) {"},{"type":"add","add":true,"ln":136,"content":"+      break;"},{"type":"normal","normal":true,"ln1":129,"ln2":137,"content":"     }"},{"type":"add","add":true,"ln":138,"content":"+  }"},{"type":"normal","normal":true,"ln1":130,"ln2":139,"content":" "},{"type":"del","del":true,"ln":131,"content":"-    JS_DestroyIdArray(cx, ida);"},{"type":"del","del":true,"ln":132,"content":"-  } while (ok && (innerObj = JS_GetPrototype(cx, innerObj)) != nsnull);"},{"type":"add","add":true,"ln":140,"content":"+  JS_DestroyIdArray(cx, ida);"},{"type":"normal","normal":true,"ln1":133,"ln2":141,"content":" "},{"type":"normal","normal":true,"ln1":134,"ln2":142,"content":"   return ok;"},{"type":"normal","normal":true,"ln1":135,"ln2":143,"content":" }"}],"oldStart":106,"oldLines":30,"newStart":106,"newLines":38}],"deletions":18,"additions":26,"from":"js/src/xpconnect/src/XPCWrapper.cpp","to":"js/src/xpconnect/src/XPCWrapper.cpp","index":["45c7d88..3db44bb","100644"]},{"chunks":[{"content":"@@ -58,13 +58,14 @@ const char* XPCJSRuntime::mStrings[] = {","changes":[{"type":"normal","normal":true,"ln1":58,"ln2":58,"content":"     \"Function\",             // IDX_FUNCTION"},{"type":"normal","normal":true,"ln1":59,"ln2":59,"content":"     \"prototype\",            // IDX_PROTOTYPE"},{"type":"normal","normal":true,"ln1":60,"ln2":60,"content":"     \"createInstance\",       // IDX_CREATE_INSTANCE"},{"type":"del","del":true,"ln":61,"content":"-    \"item\"                  // IDX_ITEM"},{"type":"add","add":true,"ln":61,"content":"+    \"item\",                 // IDX_ITEM"},{"type":"add","add":true,"ln":62,"content":"+    \"__proto__\",            // IDX_PROTO"},{"type":"add","add":true,"ln":63,"content":"+    \"__iterator__\"          // IDX_ITERATOR"},{"type":"normal","normal":true,"ln1":62,"ln2":64,"content":" #ifdef XPC_IDISPATCH_SUPPORT"},{"type":"normal","normal":true,"ln1":63,"ln2":65,"content":"     , \"GeckoActiveXObject\"  // IDX_ACTIVEX_OBJECT"},{"type":"normal","normal":true,"ln1":64,"ln2":66,"content":"     , \"COMObject\"           // IDX_COMOBJECT"},{"type":"normal","normal":true,"ln1":65,"ln2":67,"content":"     , \"supports\"            // IDX_ACTIVEX_SUPPORTS"},{"type":"normal","normal":true,"ln1":66,"ln2":68,"content":" #endif"},{"type":"del","del":true,"ln":67,"content":"-    , \"__proto__\"           // IDX_PROTO"},{"type":"normal","normal":true,"ln1":68,"ln2":69,"content":" };"},{"type":"normal","normal":true,"ln1":69,"ln2":70,"content":" "},{"type":"normal","normal":true,"ln1":70,"ln2":71,"content":" /***************************************************************************/"}],"oldStart":58,"oldLines":13,"newStart":58,"newLines":14}],"deletions":2,"additions":3,"from":"js/src/xpconnect/src/xpcjsruntime.cpp","to":"js/src/xpconnect/src/xpcjsruntime.cpp","index":["3b65294..b02612f","100644"]},{"chunks":[{"content":"@@ -649,12 +649,13 @@ public:","changes":[{"type":"normal","normal":true,"ln1":649,"ln2":649,"content":"         IDX_PROTOTYPE               ,"},{"type":"normal","normal":true,"ln1":650,"ln2":650,"content":"         IDX_CREATE_INSTANCE         ,"},{"type":"normal","normal":true,"ln1":651,"ln2":651,"content":"         IDX_ITEM                    ,"},{"type":"add","add":true,"ln":652,"content":"+        IDX_PROTO                   ,"},{"type":"add","add":true,"ln":653,"content":"+        IDX_ITERATOR                ,"},{"type":"normal","normal":true,"ln1":652,"ln2":654,"content":" #ifdef XPC_IDISPATCH_SUPPORT"},{"type":"normal","normal":true,"ln1":653,"ln2":655,"content":"         IDX_ACTIVEX_OBJECT          ,"},{"type":"normal","normal":true,"ln1":654,"ln2":656,"content":"         IDX_COM_OBJECT              ,"},{"type":"normal","normal":true,"ln1":655,"ln2":657,"content":"         IDX_ACTIVEX_SUPPORTS        ,"},{"type":"normal","normal":true,"ln1":656,"ln2":658,"content":" #endif"},{"type":"del","del":true,"ln":657,"content":"-        IDX_PROTO                   ,"},{"type":"normal","normal":true,"ln1":658,"ln2":659,"content":"         IDX_TOTAL_COUNT // just a count of the above"},{"type":"normal","normal":true,"ln1":659,"ln2":660,"content":"     };"},{"type":"normal","normal":true,"ln1":660,"ln2":661,"content":" "}],"oldStart":649,"oldLines":12,"newStart":649,"newLines":13}],"deletions":1,"additions":2,"from":"js/src/xpconnect/src/xpcprivate.h","to":"js/src/xpconnect/src/xpcprivate.h","index":["767db75..0bcc64c","100644"]}]}