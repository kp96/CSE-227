Index: nsScriptSecurityManager.cpp
===================================================================
RCS file: /cvsroot/mozilla/caps/src/nsScriptSecurityManager.cpp,v
retrieving revision 1.239
diff -up -r1.239 nsScriptSecurityManager.cpp
--- nsScriptSecurityManager.cpp
+++ nsScriptSecurityManager.cpp
@@ -1868,23 +1896,23 @@ nsScriptSecurityManager::GetPrincipalAnd
                                               nsIPrincipal **result,
                                               JSStackFrame **frameResult)
 {
-    // Get principals from innermost frame of JavaScript or Java.
-    JSStackFrame *fp = nsnull; // tell JS_FrameIterator to start at innermost
-    for (fp = JS_FrameIterator(cx, &fp); fp; fp = JS_FrameIterator(cx, &fp))
-    {
-        if (NS_FAILED(GetFramePrincipal(cx, fp, result)))
-            return NS_ERROR_FAILURE;
-        if (*result)
-        {
-            *frameResult = fp;
-            return NS_OK;
-        }
-    }
-
     //-- If there's no principal on the stack, look at the global object
     //   and return the innermost frame for annotations.
     if (cx)
     {
+        // Get principals from innermost frame of JavaScript or Java.
+        JSStackFrame *fp = nsnull; // tell JS_FrameIterator to start at innermost
+        for (fp = JS_FrameIterator(cx, &fp); fp; fp = JS_FrameIterator(cx, &fp))
+        {
+            if (NS_FAILED(GetFramePrincipal(cx, fp, result)))
+                return NS_ERROR_FAILURE;
+            if (*result)
+            {
+                *frameResult = fp;
+                return NS_OK;
+            }
+        }
+
         nsIScriptContext *scriptContext = GetScriptContext(cx);
         if (scriptContext)
         {
@@ -2286,6 +2314,9 @@ nsScriptSecurityManager::EnableCapabilit
     nsCOMPtr<nsIPrincipal> principal;
     if (NS_FAILED(GetPrincipalAndFrame(cx, getter_AddRefs(principal), &fp)))
         return NS_ERROR_FAILURE;
+    if (!principal)
+        return NS_ERROR_NOT_AVAILABLE;
+
     void *annotation = JS_GetFrameAnnotation(cx, fp);
     PRBool enabled;
     if (NS_FAILED(principal->IsCapabilityEnabled(capability, annotation,
@@ -2342,6 +2373,8 @@ nsScriptSecurityManager::RevertCapabilit
     nsCOMPtr<nsIPrincipal> principal;
     if (NS_FAILED(GetPrincipalAndFrame(cx, getter_AddRefs(principal), &fp)))
         return NS_ERROR_FAILURE;
+    if (!principal)
+        return NS_ERROR_NOT_AVAILABLE;
     void *annotation = JS_GetFrameAnnotation(cx, fp);
     principal->RevertCapability(capability, &annotation);
     JS_SetFrameAnnotation(cx, fp, annotation);
@@ -2356,6 +2389,8 @@ nsScriptSecurityManager::DisableCapabili
     nsCOMPtr<nsIPrincipal> principal;
     if (NS_FAILED(GetPrincipalAndFrame(cx, getter_AddRefs(principal), &fp)))
         return NS_ERROR_FAILURE;
+    if (!principal)
+        return NS_ERROR_NOT_AVAILABLE;
     void *annotation = JS_GetFrameAnnotation(cx, fp);
     principal->DisableCapability(capability, &annotation);
     JS_SetFrameAnnotation(cx, fp, annotation);
