Index: caps/src/nsScriptSecurityManager.cpp
===================================================================
RCS file: /home/bzbarsky/mozilla/cvs-mirror/mozilla/caps/src/nsScriptSecurityManager.cpp,v
retrieving revision 1.253
diff -u -p -d -8 -r1.253 nsScriptSecurityManager.cpp
--- caps/src/nsScriptSecurityManager.cpp	10 Apr 2005 23:27:07 -0000	1.253
+++ caps/src/nsScriptSecurityManager.cpp	12 Apr 2005 04:53:42 -0000
@@ -652,18 +652,17 @@ nsScriptSecurityManager::CheckPropertyAc
         case SCRIPT_SECURITY_SAME_ORIGIN_ACCESS:
             {
 #ifdef DEBUG_CAPS_CheckPropertyAccessImpl
                 printf("sameOrigin ");
 #endif
                 nsCOMPtr<nsIPrincipal> objectPrincipal;
                 if(aJSObject)
                 {
-                    objectPrincipal =
-                        doGetObjectPrincipal(cx, aJSObject);
+                    objectPrincipal = doGetObjectPrincipal(cx, aJSObject);
                     if (!objectPrincipal)
                         return NS_ERROR_FAILURE;
                 }
                 else if(aTargetURI)
                 {
                     if (NS_FAILED(GetCodebasePrincipal(
                           aTargetURI, getter_AddRefs(objectPrincipal))))
                         return NS_ERROR_FAILURE;
@@ -1905,16 +1919,17 @@ nsScriptSecurityManager::GetPrincipalAnd
         // Get principals from innermost frame of JavaScript or Java.
         JSStackFrame *fp = nsnull; // tell JS_FrameIterator to start at innermost
         for (fp = JS_FrameIterator(cx, &fp); fp; fp = JS_FrameIterator(cx, &fp))
         {
             nsIPrincipal* result = GetFramePrincipal(cx, fp, rv);
             if (result)
             {
                 NS_ASSERTION(NS_SUCCEEDED(*rv), "Weird return");
+                *frameResult = fp;
                 return result;
             }
         }
 
         nsIScriptContext *scriptContext = GetScriptContext(cx);
         if (scriptContext)
         {
             nsCOMPtr<nsIScriptObjectPrincipal> globalData =
