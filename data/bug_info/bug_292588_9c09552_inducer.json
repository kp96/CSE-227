{"bug_id":292588,"commitHash":"9c09552","commit_info":{"sha":"9c0955251d982d4ecaf480ee632eecdcb2c988e1","commit":{"author":{"name":"timeless%mozdev.org","email":"timeless%mozdev.org","date":"2005-06-07T21:57:56Z"},"committer":{"name":"timeless%mozdev.org","email":"timeless%mozdev.org","date":"2005-06-07T21:57:56Z"},"message":"Bug 292588 shutdown crash !sXPConnect [@ nsScriptSecurityManager::CheckObjectAccess]\nstore the runtime, unset the callback at shutdown\nr=dveditz sr=jst a=asa","tree":{"sha":"a9b68ad5dff02379adae772f7b62b60e84de6712","url":"https://api.github.com/repos/mozilla/gecko-dev/git/trees/a9b68ad5dff02379adae772f7b62b60e84de6712"},"url":"https://api.github.com/repos/mozilla/gecko-dev/git/commits/9c0955251d982d4ecaf480ee632eecdcb2c988e1","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/mozilla/gecko-dev/commits/9c0955251d982d4ecaf480ee632eecdcb2c988e1","html_url":"https://github.com/mozilla/gecko-dev/commit/9c0955251d982d4ecaf480ee632eecdcb2c988e1","comments_url":"https://api.github.com/repos/mozilla/gecko-dev/commits/9c0955251d982d4ecaf480ee632eecdcb2c988e1/comments","author":null,"committer":null,"parents":[{"sha":"af0391257d73663ed796735cd0d94918920050a2","url":"https://api.github.com/repos/mozilla/gecko-dev/commits/af0391257d73663ed796735cd0d94918920050a2","html_url":"https://github.com/mozilla/gecko-dev/commit/af0391257d73663ed796735cd0d94918920050a2"}],"stats":{"total":15,"additions":12,"deletions":3},"files":[{"sha":"6602c0b34ee120a713f4e5ba04ca2c7dc3b82a5c","filename":"caps/include/nsScriptSecurityManager.h","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/mozilla/gecko-dev/blob/9c0955251d982d4ecaf480ee632eecdcb2c988e1/caps/include/nsScriptSecurityManager.h","raw_url":"https://github.com/mozilla/gecko-dev/raw/9c0955251d982d4ecaf480ee632eecdcb2c988e1/caps/include/nsScriptSecurityManager.h","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/caps/include/nsScriptSecurityManager.h?ref=9c0955251d982d4ecaf480ee632eecdcb2c988e1","patch":"@@ -507,6 +507,7 @@ class nsScriptSecurityManager : public nsIScriptSecurityManager,\n     static nsIIOService    *sIOService;\n     static nsIXPConnect    *sXPConnect;\n     static nsIStringBundle *sStrBundle;\n+    static JSRuntime       *sRuntime;\n };\n \n #endif // nsScriptSecurityManager_h__"},{"sha":"d9c9188d6f77ea36367de73627809aad97b91726","filename":"caps/src/nsScriptSecurityManager.cpp","status":"modified","additions":11,"deletions":3,"changes":14,"blob_url":"https://github.com/mozilla/gecko-dev/blob/9c0955251d982d4ecaf480ee632eecdcb2c988e1/caps/src/nsScriptSecurityManager.cpp","raw_url":"https://github.com/mozilla/gecko-dev/raw/9c0955251d982d4ecaf480ee632eecdcb2c988e1/caps/src/nsScriptSecurityManager.cpp","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/caps/src/nsScriptSecurityManager.cpp?ref=9c0955251d982d4ecaf480ee632eecdcb2c988e1","patch":"@@ -85,6 +85,7 @@ static NS_DEFINE_CID(kZipReaderCID, NS_ZIPREADER_CID);\n nsIIOService    *nsScriptSecurityManager::sIOService = nsnull;\n nsIXPConnect    *nsScriptSecurityManager::sXPConnect = nsnull;\n nsIStringBundle *nsScriptSecurityManager::sStrBundle = nsnull;\n+JSRuntime       *nsScriptSecurityManager::sRuntime   = 0;\n \n ///////////////////////////\n // Convenience Functions //\n@@ -2862,14 +2863,13 @@ nsresult nsScriptSecurityManager::Init()\n         do_GetService(\"@mozilla.org/js/xpc/RuntimeService;1\", &rv);\n     NS_ENSURE_SUCCESS(rv, rv);\n \n-    JSRuntime *rt;\n-    rv = runtimeService->GetRuntime(&rt);\n+    rv = runtimeService->GetRuntime(&sRuntime);\n     NS_ENSURE_SUCCESS(rv, rv);\n \n #ifdef DEBUG\n     JSCheckAccessOp oldCallback =\n #endif\n-        JS_SetCheckObjectAccessCallback(rt, CheckObjectAccess);\n+        JS_SetCheckObjectAccessCallback(sRuntime, CheckObjectAccess);\n \n     // For now, assert that no callback was set previously\n     NS_ASSERTION(!oldCallback, \"Someone already set a JS CheckObjectAccess callback\");\n@@ -2891,6 +2891,14 @@ nsScriptSecurityManager::~nsScriptSecurityManager(void)\n void\n nsScriptSecurityManager::Shutdown()\n {\n+    if (sRuntime) {\n+#ifdef DEBUG\n+        JSCheckAccessOp oldCallback =\n+#endif\n+            JS_SetCheckObjectAccessCallback(sRuntime, nsnull);\n+        NS_ASSERTION(oldCallback == CheckObjectAccess, \"Oops, we just clobbered someone else, oh well.\");\n+        sRuntime = nsnull;\n+    }\n     sEnabledID = JSVAL_VOID;\n \n     NS_IF_RELEASE(sIOService);"}]},"blames":["66caced6","b6f6ad74","91b7c60b","66caced6","b6f6ad74","1b252b2e","4756b716","25276e6b","1c574be0","3c9f658a"]}