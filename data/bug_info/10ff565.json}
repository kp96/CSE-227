{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas10ff565\""},"diff":[{"chunks":[{"content":"@@ -98,6 +98,9 @@","changes":[{"type":"normal","normal":true,"ln1":98,"ln2":98,"content":" #include \"nsISelectionController.h\""},{"type":"normal","normal":true,"ln1":99,"ln2":99,"content":" #include \"nsFrameSelection.h\""},{"type":"normal","normal":true,"ln1":100,"ln2":100,"content":" #include \"nsIDOMEventTarget.h\""},{"type":"add","add":true,"ln":101,"content":"+#include \"nsWidgetsCID.h\""},{"type":"add","add":true,"ln":102,"content":"+"},{"type":"add","add":true,"ln":103,"content":"+static NS_DEFINE_CID(kHTMLConverterCID,        NS_HTMLFORMATCONVERTER_CID);"},{"type":"normal","normal":true,"ln1":101,"ln2":104,"content":" "},{"type":"normal","normal":true,"ln1":102,"ln2":105,"content":" // private clipboard data flavors for html copy, used by editor when pasting"},{"type":"normal","normal":true,"ln1":103,"ln2":106,"content":" #define kHTMLContext   \"text/_moz_htmlcontext\""}],"oldStart":98,"oldLines":6,"newStart":98,"newLines":9},{"content":"@@ -137,11 +140,8 @@ private:","changes":[{"type":"normal","normal":true,"ln1":137,"ln2":140,"content":"   static void GetSelectedLink(nsISelection* inSelection,"},{"type":"normal","normal":true,"ln1":138,"ln2":141,"content":"                               nsIDOMNode **outLinkNode);"},{"type":"normal","normal":true,"ln1":139,"ln2":142,"content":" "},{"type":"del","del":true,"ln":140,"content":"-  enum serializationMode {serializeAsText, serializeAsHTML};"},{"type":"normal","normal":true,"ln1":141,"ln2":143,"content":"   // if inNode is null, use the selection from the window"},{"type":"del","del":true,"ln":142,"content":"-  static nsresult SerializeNodeOrSelection(serializationMode inMode,"},{"type":"del","del":true,"ln":143,"content":"-                                           PRUint32 inFlags,"},{"type":"del","del":true,"ln":144,"content":"-                                           nsIDOMWindow* inWindow,"},{"type":"add","add":true,"ln":144,"content":"+  static nsresult SerializeNodeOrSelection(nsIDOMWindow* inWindow,"},{"type":"normal","normal":true,"ln1":145,"ln2":145,"content":"                                            nsIDOMNode* inNode,"},{"type":"normal","normal":true,"ln1":146,"ln2":146,"content":"                                            nsAString& outResultString,"},{"type":"normal","normal":true,"ln1":147,"ln2":147,"content":"                                            nsAString& outHTMLContext,"}],"oldStart":137,"oldLines":11,"newStart":140,"newLines":8},{"content":"@@ -1338,16 +1338,24 @@ nsTransferableFactory::Produce(PRBool* aDragSelection,","changes":[{"type":"normal","normal":true,"ln1":1338,"ln2":1338,"content":"       nodeToSerialize = nsnull;"},{"type":"normal","normal":true,"ln1":1339,"ln2":1339,"content":"     }"},{"type":"normal","normal":true,"ln1":1340,"ln2":1340,"content":" "},{"type":"del","del":true,"ln":1341,"content":"-    SerializeNodeOrSelection(serializeAsHTML,"},{"type":"del","del":true,"ln":1342,"content":"-                             nsIDocumentEncoder::OutputAbsoluteLinks |"},{"type":"del","del":true,"ln":1343,"content":"-                             nsIDocumentEncoder::OutputEncodeW3CEntities,"},{"type":"del","del":true,"ln":1344,"content":"-                             window, nodeToSerialize,"},{"type":"add","add":true,"ln":1341,"content":"+    SerializeNodeOrSelection(window, nodeToSerialize,"},{"type":"normal","normal":true,"ln1":1345,"ln2":1342,"content":"                              mHtmlString, mContextString, mInfoString);"},{"type":"normal","normal":true,"ln1":1346,"ln2":1343,"content":" "},{"type":"del","del":true,"ln":1347,"content":"-    nsAutoString dummy1, dummy2;"},{"type":"del","del":true,"ln":1348,"content":"-    SerializeNodeOrSelection(serializeAsText, 0,"},{"type":"del","del":true,"ln":1349,"content":"-                             window, nodeToSerialize,"},{"type":"del","del":true,"ln":1350,"content":"-                             mTitleString, dummy1, dummy2);"},{"type":"add","add":true,"ln":1344,"content":"+    nsCOMPtr<nsIFormatConverter> htmlConverter ="},{"type":"add","add":true,"ln":1345,"content":"+      do_CreateInstance(kHTMLConverterCID);"},{"type":"add","add":true,"ln":1346,"content":"+    NS_ENSURE_TRUE(htmlConverter, NS_ERROR_FAILURE);"},{"type":"add","add":true,"ln":1347,"content":"+"},{"type":"add","add":true,"ln":1348,"content":"+    nsCOMPtr<nsISupportsString> html ="},{"type":"add","add":true,"ln":1349,"content":"+      do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID);"},{"type":"add","add":true,"ln":1350,"content":"+    NS_ENSURE_TRUE(html, NS_ERROR_FAILURE);"},{"type":"add","add":true,"ln":1351,"content":"+    html->SetData(mHtmlString);"},{"type":"add","add":true,"ln":1352,"content":"+"},{"type":"add","add":true,"ln":1353,"content":"+    nsCOMPtr<nsISupportsString> text;"},{"type":"add","add":true,"ln":1354,"content":"+    PRUint32 textLen;"},{"type":"add","add":true,"ln":1355,"content":"+    htmlConverter->Convert(kHTMLMime, html, mHtmlString.Length() * 2,"},{"type":"add","add":true,"ln":1356,"content":"+                           kUnicodeMime, getter_AddRefs(text), &textLen);"},{"type":"add","add":true,"ln":1357,"content":"+    NS_ENSURE_TRUE(text, NS_ERROR_FAILURE);"},{"type":"add","add":true,"ln":1358,"content":"+    text->GetData(mTitleString);"},{"type":"normal","normal":true,"ln1":1351,"ln2":1359,"content":" "},{"type":"normal","normal":true,"ln1":1352,"ln2":1360,"content":" #ifdef CHANGE_SELECTION_ON_DRAG"},{"type":"normal","normal":true,"ln1":1353,"ln2":1361,"content":"     // We used to change the selection to wrap the dragged node (mainly"}],"oldStart":1338,"oldLines":16,"newStart":1338,"newLines":24},{"content":"@@ -1688,9 +1696,7 @@ void nsTransferableFactory::GetSelectedLink(nsISelection* inSelection,","changes":[{"type":"normal","normal":true,"ln1":1688,"ln2":1696,"content":" "},{"type":"normal","normal":true,"ln1":1689,"ln2":1697,"content":" // static"},{"type":"normal","normal":true,"ln1":1690,"ln2":1698,"content":" nsresult"},{"type":"del","del":true,"ln":1691,"content":"-nsTransferableFactory::SerializeNodeOrSelection(serializationMode inMode,"},{"type":"del","del":true,"ln":1692,"content":"-                                                PRUint32 inFlags,"},{"type":"del","del":true,"ln":1693,"content":"-                                                nsIDOMWindow* inWindow,"},{"type":"add","add":true,"ln":1699,"content":"+nsTransferableFactory::SerializeNodeOrSelection(nsIDOMWindow* inWindow,"},{"type":"normal","normal":true,"ln1":1694,"ln2":1700,"content":"                                                 nsIDOMNode* inNode,"},{"type":"normal","normal":true,"ln1":1695,"ln2":1701,"content":"                                                 nsAString& outResultString,"},{"type":"normal","normal":true,"ln1":1696,"ln2":1702,"content":"                                                 nsAString& outContext,"}],"oldStart":1688,"oldLines":9,"newStart":1696,"newLines":7},{"content":"@@ -1699,22 +1705,16 @@ nsTransferableFactory::SerializeNodeOrSelection(serializationMode inMode,","changes":[{"type":"normal","normal":true,"ln1":1699,"ln2":1705,"content":"   NS_ENSURE_ARG_POINTER(inWindow);"},{"type":"normal","normal":true,"ln1":1700,"ln2":1706,"content":" "},{"type":"normal","normal":true,"ln1":1701,"ln2":1707,"content":"   nsresult rv;"},{"type":"del","del":true,"ln":1702,"content":"-  nsCOMPtr<nsIDocumentEncoder> encoder;"},{"type":"del","del":true,"ln":1703,"content":"-  static const char *textplain = \"text/plain\";"},{"type":"del","del":true,"ln":1704,"content":"-"},{"type":"del","del":true,"ln":1705,"content":"-  if (inMode == serializeAsText) {"},{"type":"del","del":true,"ln":1706,"content":"-    nsCAutoString formatType(NS_DOC_ENCODER_CONTRACTID_BASE);"},{"type":"del","del":true,"ln":1707,"content":"-    formatType.Append(textplain);"},{"type":"del","del":true,"ln":1708,"content":"-    encoder = do_CreateInstance(formatType.get(), &rv);"},{"type":"del","del":true,"ln":1709,"content":"-  } else {"},{"type":"del","del":true,"ln":1710,"content":"-    encoder = do_CreateInstance(NS_HTMLCOPY_ENCODER_CONTRACTID, &rv);"},{"type":"del","del":true,"ln":1711,"content":"-  }"},{"type":"del","del":true,"ln":1712,"content":"-  NS_ENSURE_SUCCESS(rv, rv);"},{"type":"add","add":true,"ln":1708,"content":"+  nsCOMPtr<nsIDocumentEncoder> encoder ="},{"type":"add","add":true,"ln":1709,"content":"+    do_CreateInstance(NS_HTMLCOPY_ENCODER_CONTRACTID);"},{"type":"add","add":true,"ln":1710,"content":"+  NS_ENSURE_TRUE(encoder, NS_ERROR_FAILURE);"},{"type":"normal","normal":true,"ln1":1713,"ln2":1711,"content":" "},{"type":"normal","normal":true,"ln1":1714,"ln2":1712,"content":"   nsCOMPtr<nsIDOMDocument> domDoc;"},{"type":"normal","normal":true,"ln1":1715,"ln2":1713,"content":"   inWindow->GetDocument(getter_AddRefs(domDoc));"},{"type":"normal","normal":true,"ln1":1716,"ln2":1714,"content":"   NS_ENSURE_TRUE(domDoc, NS_ERROR_FAILURE);"},{"type":"normal","normal":true,"ln1":1717,"ln2":1715,"content":" "},{"type":"add","add":true,"ln":1716,"content":"+  PRUint32 flags = nsIDocumentEncoder::OutputAbsoluteLinks |"},{"type":"add","add":true,"ln":1717,"content":"+                   nsIDocumentEncoder::OutputEncodeW3CEntities;"},{"type":"normal","normal":true,"ln1":1718,"ln2":1718,"content":"   nsCOMPtr<nsIDOMRange> range;"},{"type":"normal","normal":true,"ln1":1719,"ln2":1719,"content":"   nsCOMPtr<nsISelection> selection;"},{"type":"normal","normal":true,"ln1":1720,"ln2":1720,"content":"   if (inNode) {"}],"oldStart":1699,"oldLines":22,"newStart":1705,"newLines":16},{"content":"@@ -1725,14 +1725,10 @@ nsTransferableFactory::SerializeNodeOrSelection(serializationMode inMode,","changes":[{"type":"normal","normal":true,"ln1":1725,"ln2":1725,"content":"     NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":1726,"ln2":1726,"content":"   } else {"},{"type":"normal","normal":true,"ln1":1727,"ln2":1727,"content":"     inWindow->GetSelection(getter_AddRefs(selection));"},{"type":"del","del":true,"ln":1728,"content":"-    inFlags |= nsIDocumentEncoder::OutputSelectionOnly;"},{"type":"add","add":true,"ln":1728,"content":"+    flags |= nsIDocumentEncoder::OutputSelectionOnly;"},{"type":"normal","normal":true,"ln1":1729,"ln2":1729,"content":"   }"},{"type":"normal","normal":true,"ln1":1730,"ln2":1730,"content":" "},{"type":"del","del":true,"ln":1731,"content":"-  if (inMode == serializeAsText) {"},{"type":"del","del":true,"ln":1732,"content":"-    rv = encoder->Init(domDoc, NS_ConvertASCIItoUTF16(textplain), inFlags);"},{"type":"del","del":true,"ln":1733,"content":"-  } else {"},{"type":"del","del":true,"ln":1734,"content":"-    rv = encoder->Init(domDoc, NS_LITERAL_STRING(kHTMLMime), inFlags);"},{"type":"del","del":true,"ln":1735,"content":"-  }"},{"type":"add","add":true,"ln":1731,"content":"+  rv = encoder->Init(domDoc, NS_LITERAL_STRING(kHTMLMime), flags);"},{"type":"normal","normal":true,"ln1":1736,"ln2":1732,"content":"   NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":1737,"ln2":1733,"content":" "},{"type":"normal","normal":true,"ln1":1738,"ln2":1734,"content":"   if (range) {"}],"oldStart":1725,"oldLines":14,"newStart":1725,"newLines":10},{"content":"@@ -1741,12 +1737,6 @@ nsTransferableFactory::SerializeNodeOrSelection(serializationMode inMode,","changes":[{"type":"normal","normal":true,"ln1":1741,"ln2":1737,"content":"     encoder->SetSelection(selection);"},{"type":"normal","normal":true,"ln1":1742,"ln2":1738,"content":"   }"},{"type":"normal","normal":true,"ln1":1743,"ln2":1739,"content":" "},{"type":"del","del":true,"ln":1744,"content":"-  if (inMode == serializeAsText) {"},{"type":"del","del":true,"ln":1745,"content":"-    outContext.Truncate();"},{"type":"del","del":true,"ln":1746,"content":"-    outInfo.Truncate();"},{"type":"del","del":true,"ln":1747,"content":"-    return encoder->EncodeToString(outResultString);"},{"type":"del","del":true,"ln":1748,"content":"-  }"},{"type":"del","del":true,"ln":1749,"content":"-"},{"type":"normal","normal":true,"ln1":1750,"ln2":1740,"content":"   return encoder->EncodeToStringWithContext(outContext, outInfo,"},{"type":"normal","normal":true,"ln1":1751,"ln2":1741,"content":"                                             outResultString);"},{"type":"normal","normal":true,"ln1":1752,"ln2":1742,"content":" }"}],"oldStart":1741,"oldLines":12,"newStart":1737,"newLines":6}],"deletions":38,"additions":28,"from":"content/base/src/nsContentAreaDragDrop.cpp","to":"content/base/src/nsContentAreaDragDrop.cpp","index":["3741ab1..7722b6c","100644"]}]}