# HG changeset patch
# Parent bab018a34da3e260279f88e6624f397f99f0f1bc
# User Blake Kaplan <mrbkap@gmail.com>
Fix bug 617879.

diff --git a/dom/base/nsHistory.cpp b/dom/base/nsHistory.cpp
--- a/dom/base/nsHistory.cpp
+++ b/dom/base/nsHistory.cpp
@@ -320,25 +320,28 @@ nsHistory::ReplaceState(nsIVariant *aDat
   // create a new one.
   return mDocShell->AddState(aData, aTitle, aURL, PR_TRUE);
 }
 
 NS_IMETHODIMP
 nsHistory::Item(PRUint32 aIndex, nsAString& aReturn)
 {
   aReturn.Truncate();
+  if (!nsContentUtils::IsCallerTrustedForRead()) {
+    return NS_ERROR_DOM_SECURITY_ERR;
+  }
 
   nsresult rv = NS_OK;
   nsCOMPtr<nsISHistory>  session_history;
 
   GetSessionHistoryFromDocShell(mDocShell, getter_AddRefs(session_history));
   NS_ENSURE_TRUE(session_history, NS_ERROR_FAILURE);
 
- 	nsCOMPtr<nsIHistoryEntry> sh_entry;
- 	nsCOMPtr<nsIURI> uri;
+  nsCOMPtr<nsIHistoryEntry> sh_entry;
+  nsCOMPtr<nsIURI> uri;
 
   rv = session_history->GetEntryAtIndex(aIndex, PR_FALSE,
                                         getter_AddRefs(sh_entry));
 
   if (sh_entry) {
     rv = sh_entry->GetURI(getter_AddRefs(uri));
   }
 
