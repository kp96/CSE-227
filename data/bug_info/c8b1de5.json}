{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basc8b1de5\""},"diff":[{"chunks":[{"content":"@@ -111,6 +111,7 @@ LOCAL_INCLUDES\t= \\","changes":[{"type":"normal","normal":true,"ln1":111,"ln2":111,"content":" \t\t-I$(srcdir)/../../xul/document/src \\"},{"type":"normal","normal":true,"ln1":112,"ln2":112,"content":" \t\t-I$(srcdir)/../../events/src \\"},{"type":"normal","normal":true,"ln1":113,"ln2":113,"content":" \t\t-I$(srcdir)/../../../layout/style \\"},{"type":"add","add":true,"ln":114,"content":"+\t\t-I$(srcdir)/../../../dom/src/base \\"},{"type":"normal","normal":true,"ln1":114,"ln2":115,"content":" \t\t$(NULL)"},{"type":"normal","normal":true,"ln1":115,"ln2":116,"content":" "},{"type":"normal","normal":true,"ln1":116,"ln2":117,"content":" DEFINES += -D_IMPL_NS_LAYOUT"}],"oldStart":111,"oldLines":6,"newStart":111,"newLines":7}],"deletions":0,"additions":1,"from":"content/xbl/src/Makefile.in","to":"content/xbl/src/Makefile.in","index":["3c4986d..ae32022","100644"]},{"chunks":[{"content":"@@ -102,27 +102,134 @@","changes":[{"type":"normal","normal":true,"ln1":102,"ln2":102,"content":" #include \"prprf.h\""},{"type":"normal","normal":true,"ln1":103,"ln2":103,"content":" #include \"nsNodeUtils.h\""},{"type":"normal","normal":true,"ln1":104,"ln2":104,"content":" "},{"type":"add","add":true,"ln":105,"content":"+// Nasty hack.  Maybe we could move some of the classinfo utility methods"},{"type":"add","add":true,"ln":106,"content":"+// (e.g. WrapNative and ThrowJSException) over to nsContentUtils?"},{"type":"add","add":true,"ln":107,"content":"+#include \"nsDOMClassInfo.h\""},{"type":"add","add":true,"ln":108,"content":"+#include \"nsJSUtils.h\""},{"type":"add","add":true,"ln":109,"content":"+"},{"type":"normal","normal":true,"ln1":105,"ln2":110,"content":" // Helper classes"},{"type":"normal","normal":true,"ln1":106,"ln2":111,"content":" "},{"type":"normal","normal":true,"ln1":107,"ln2":112,"content":" /***********************************************************************/"},{"type":"normal","normal":true,"ln1":108,"ln2":113,"content":" //"},{"type":"normal","normal":true,"ln1":109,"ln2":114,"content":" // The JS class for XBLBinding"},{"type":"normal","normal":true,"ln1":110,"ln2":115,"content":" //"},{"type":"del","del":true,"ln":111,"content":"-PR_STATIC_CALLBACK(void)"},{"type":"add","add":true,"ln":116,"content":"+JS_STATIC_DLL_CALLBACK(void)"},{"type":"normal","normal":true,"ln1":112,"ln2":117,"content":" XBLFinalize(JSContext *cx, JSObject *obj)"},{"type":"normal","normal":true,"ln1":113,"ln2":118,"content":" {"},{"type":"add","add":true,"ln":119,"content":"+  nsIXBLDocumentInfo* docInfo ="},{"type":"add","add":true,"ln":120,"content":"+    static_cast<nsIXBLDocumentInfo*>(::JS_GetPrivate(cx, obj));"},{"type":"add","add":true,"ln":121,"content":"+  NS_RELEASE(docInfo);"},{"type":"add","add":true,"ln":122,"content":"+  "},{"type":"normal","normal":true,"ln1":114,"ln2":123,"content":"   nsXBLJSClass* c = static_cast<nsXBLJSClass*>(::JS_GetClass(cx, obj));"},{"type":"normal","normal":true,"ln1":115,"ln2":124,"content":"   c->Drop();"},{"type":"normal","normal":true,"ln1":116,"ln2":125,"content":" }"},{"type":"normal","normal":true,"ln1":117,"ln2":126,"content":" "},{"type":"add","add":true,"ln":127,"content":"+JS_STATIC_DLL_CALLBACK(JSBool)"},{"type":"add","add":true,"ln":128,"content":"+XBLResolve(JSContext *cx, JSObject *obj, jsval id, uintN flags,"},{"type":"add","add":true,"ln":129,"content":"+           JSObject **objp)"},{"type":"add","add":true,"ln":130,"content":"+{"},{"type":"add","add":true,"ln":131,"content":"+  // Note: if we get here, that means that the implementation for some binding"},{"type":"add","add":true,"ln":132,"content":"+  // was installed, which means that AllowScripts() tested true.  Hence no need"},{"type":"add","add":true,"ln":133,"content":"+  // to do checks like that here."},{"type":"add","add":true,"ln":134,"content":"+  "},{"type":"add","add":true,"ln":135,"content":"+  // Default to not resolving things."},{"type":"add","add":true,"ln":136,"content":"+  NS_ASSERTION(*objp, \"Must have starting object\");"},{"type":"add","add":true,"ln":137,"content":"+"},{"type":"add","add":true,"ln":138,"content":"+  JSObject* origObj = *objp;"},{"type":"add","add":true,"ln":139,"content":"+  *objp = NULL;"},{"type":"add","add":true,"ln":140,"content":"+"},{"type":"add","add":true,"ln":141,"content":"+  if (!JSVAL_IS_STRING(id)) {"},{"type":"add","add":true,"ln":142,"content":"+    return JS_TRUE;"},{"type":"add","add":true,"ln":143,"content":"+  }"},{"type":"add","add":true,"ln":144,"content":"+"},{"type":"add","add":true,"ln":145,"content":"+  nsDependentJSString fieldName(id);"},{"type":"add","add":true,"ln":146,"content":"+"},{"type":"add","add":true,"ln":147,"content":"+  jsval slotVal;"},{"type":"add","add":true,"ln":148,"content":"+  ::JS_GetReservedSlot(cx, obj, 0, &slotVal);"},{"type":"add","add":true,"ln":149,"content":"+  NS_ASSERTION(!JSVAL_IS_VOID(slotVal), \"How did that happen?\");"},{"type":"add","add":true,"ln":150,"content":"+    "},{"type":"add","add":true,"ln":151,"content":"+  nsXBLPrototypeBinding* protoBinding ="},{"type":"add","add":true,"ln":152,"content":"+    static_cast<nsXBLPrototypeBinding*>(JSVAL_TO_PRIVATE(slotVal));"},{"type":"add","add":true,"ln":153,"content":"+  NS_ASSERTION(protoBinding, \"Must have prototype binding!\");"},{"type":"add","add":true,"ln":154,"content":"+"},{"type":"add","add":true,"ln":155,"content":"+  nsXBLProtoImplField* field = protoBinding->FindField(fieldName);"},{"type":"add","add":true,"ln":156,"content":"+  if (!field) {"},{"type":"add","add":true,"ln":157,"content":"+    return JS_TRUE;"},{"type":"add","add":true,"ln":158,"content":"+  }"},{"type":"add","add":true,"ln":159,"content":"+"},{"type":"add","add":true,"ln":160,"content":"+  // We have this field.  Time to install it.  Get our node."},{"type":"add","add":true,"ln":161,"content":"+  JSClass* nodeClass = ::JS_GetClass(cx, origObj);"},{"type":"add","add":true,"ln":162,"content":"+  if (!nodeClass) {"},{"type":"add","add":true,"ln":163,"content":"+    return JS_FALSE;"},{"type":"add","add":true,"ln":164,"content":"+  }"},{"type":"add","add":true,"ln":165,"content":"+  "},{"type":"add","add":true,"ln":166,"content":"+  if (~nodeClass->flags &"},{"type":"add","add":true,"ln":167,"content":"+      (JSCLASS_HAS_PRIVATE | JSCLASS_PRIVATE_IS_NSISUPPORTS)) {"},{"type":"add","add":true,"ln":168,"content":"+    // Looks like whatever |origObj| is it's not our nsIContent.  It might well"},{"type":"add","add":true,"ln":169,"content":"+    // be the proto our binding installed, however, so just baul out quietly."},{"type":"add","add":true,"ln":170,"content":"+    // Do NOT throw an exception here."},{"type":"add","add":true,"ln":171,"content":"+    // We could make this stricter by checking the class maybe, but whatever"},{"type":"add","add":true,"ln":172,"content":"+    return JS_TRUE;"},{"type":"add","add":true,"ln":173,"content":"+  }"},{"type":"add","add":true,"ln":174,"content":"+"},{"type":"add","add":true,"ln":175,"content":"+  nsCOMPtr<nsIXPConnectWrappedNative> xpcWrapper ="},{"type":"add","add":true,"ln":176,"content":"+    do_QueryInterface(static_cast<nsISupports*>(::JS_GetPrivate(cx, origObj)));"},{"type":"add","add":true,"ln":177,"content":"+  if (!xpcWrapper) {"},{"type":"add","add":true,"ln":178,"content":"+    nsDOMClassInfo::ThrowJSException(cx, NS_ERROR_UNEXPECTED);"},{"type":"add","add":true,"ln":179,"content":"+    return JS_FALSE;"},{"type":"add","add":true,"ln":180,"content":"+  }"},{"type":"add","add":true,"ln":181,"content":"+"},{"type":"add","add":true,"ln":182,"content":"+  nsCOMPtr<nsIContent> content = do_QueryWrappedNative(xpcWrapper);"},{"type":"add","add":true,"ln":183,"content":"+  if (!content) {"},{"type":"add","add":true,"ln":184,"content":"+    nsDOMClassInfo::ThrowJSException(cx, NS_ERROR_UNEXPECTED);"},{"type":"add","add":true,"ln":185,"content":"+    return JS_FALSE;"},{"type":"add","add":true,"ln":186,"content":"+  }"},{"type":"add","add":true,"ln":187,"content":"+"},{"type":"add","add":true,"ln":188,"content":"+  // This mirrors code in nsXBLProtoImpl::InstallImplementation"},{"type":"add","add":true,"ln":189,"content":"+  nsIDocument* doc = content->GetOwnerDoc();"},{"type":"add","add":true,"ln":190,"content":"+  if (!doc) {"},{"type":"add","add":true,"ln":191,"content":"+    return JS_TRUE;"},{"type":"add","add":true,"ln":192,"content":"+  }"},{"type":"add","add":true,"ln":193,"content":"+"},{"type":"add","add":true,"ln":194,"content":"+  nsIScriptGlobalObject* global = doc->GetScriptGlobalObject();"},{"type":"add","add":true,"ln":195,"content":"+  if (!global) {"},{"type":"add","add":true,"ln":196,"content":"+    return JS_TRUE;"},{"type":"add","add":true,"ln":197,"content":"+  }"},{"type":"add","add":true,"ln":198,"content":"+"},{"type":"add","add":true,"ln":199,"content":"+  nsCOMPtr<nsIScriptContext> context = global->GetContext();"},{"type":"add","add":true,"ln":200,"content":"+  if (!context) {"},{"type":"add","add":true,"ln":201,"content":"+    return JS_TRUE;"},{"type":"add","add":true,"ln":202,"content":"+  }"},{"type":"add","add":true,"ln":203,"content":"+"},{"type":"add","add":true,"ln":204,"content":"+"},{"type":"add","add":true,"ln":205,"content":"+  // Now we either resolve or fail"},{"type":"add","add":true,"ln":206,"content":"+  *objp = origObj;"},{"type":"add","add":true,"ln":207,"content":"+  nsresult rv = field->InstallField(context, origObj,"},{"type":"add","add":true,"ln":208,"content":"+                                    protoBinding->DocURI());"},{"type":"add","add":true,"ln":209,"content":"+  if (NS_FAILED(rv)) {"},{"type":"add","add":true,"ln":210,"content":"+    if (!::JS_IsExceptionPending(cx)) {"},{"type":"add","add":true,"ln":211,"content":"+      nsDOMClassInfo::ThrowJSException(cx, rv);"},{"type":"add","add":true,"ln":212,"content":"+    }"},{"type":"add","add":true,"ln":213,"content":"+"},{"type":"add","add":true,"ln":214,"content":"+    return JS_FALSE;"},{"type":"add","add":true,"ln":215,"content":"+  }"},{"type":"add","add":true,"ln":216,"content":"+"},{"type":"add","add":true,"ln":217,"content":"+  return JS_TRUE;"},{"type":"add","add":true,"ln":218,"content":"+}"},{"type":"add","add":true,"ln":219,"content":"+"},{"type":"normal","normal":true,"ln1":118,"ln2":220,"content":" nsXBLJSClass::nsXBLJSClass(const nsAFlatCString& aClassName)"},{"type":"normal","normal":true,"ln1":119,"ln2":221,"content":" {"},{"type":"normal","normal":true,"ln1":120,"ln2":222,"content":"   memset(this, 0, sizeof(nsXBLJSClass));"},{"type":"normal","normal":true,"ln1":121,"ln2":223,"content":"   next = prev = static_cast<JSCList*>(this);"},{"type":"normal","normal":true,"ln1":122,"ln2":224,"content":"   name = ToNewCString(aClassName);"},{"type":"add","add":true,"ln":225,"content":"+  flags ="},{"type":"add","add":true,"ln":226,"content":"+    JSCLASS_HAS_PRIVATE | JSCLASS_PRIVATE_IS_NSISUPPORTS |"},{"type":"add","add":true,"ln":227,"content":"+    JSCLASS_NEW_RESOLVE | JSCLASS_NEW_RESOLVE_GETS_START |"},{"type":"add","add":true,"ln":228,"content":"+    // Our one reserved slot holds the relevant nsXBLPrototypeBinding"},{"type":"add","add":true,"ln":229,"content":"+    JSCLASS_HAS_RESERVED_SLOTS(1);"},{"type":"normal","normal":true,"ln1":123,"ln2":230,"content":"   addProperty = delProperty = setProperty = getProperty = ::JS_PropertyStub;"},{"type":"normal","normal":true,"ln1":124,"ln2":231,"content":"   enumerate = ::JS_EnumerateStub;"},{"type":"del","del":true,"ln":125,"content":"-  resolve = ::JS_ResolveStub;"},{"type":"add","add":true,"ln":232,"content":"+  resolve = (JSResolveOp)XBLResolve;"},{"type":"normal","normal":true,"ln1":126,"ln2":233,"content":"   convert = ::JS_ConvertStub;"},{"type":"normal","normal":true,"ln1":127,"ln2":234,"content":"   finalize = XBLFinalize;"},{"type":"normal","normal":true,"ln1":128,"ln2":235,"content":" }"}],"oldStart":102,"oldLines":27,"newStart":102,"newLines":134},{"content":"@@ -1034,6 +1141,7 @@ nsXBLBinding::WalkRules(nsIStyleRuleProcessor::EnumFunc aFunc, void* aData)","changes":[{"type":"normal","normal":true,"ln1":1034,"ln2":1141,"content":" nsresult"},{"type":"normal","normal":true,"ln1":1035,"ln2":1142,"content":" nsXBLBinding::DoInitJSClass(JSContext *cx, JSObject *global, JSObject *obj,"},{"type":"normal","normal":true,"ln1":1036,"ln2":1143,"content":"                             const nsAFlatCString& aClassName,"},{"type":"add","add":true,"ln":1144,"content":"+                            nsXBLPrototypeBinding* aProtoBinding,"},{"type":"normal","normal":true,"ln1":1037,"ln2":1145,"content":"                             void **aClassObject)"},{"type":"normal","normal":true,"ln1":1038,"ln2":1146,"content":" {"},{"type":"normal","normal":true,"ln1":1039,"ln2":1147,"content":"   // First ensure our JS class is initialized."}],"oldStart":1034,"oldLines":6,"newStart":1141,"newLines":7},{"content":"@@ -1139,6 +1247,20 @@ nsXBLBinding::DoInitJSClass(JSContext *cx, JSObject *global, JSObject *obj,","changes":[{"type":"normal","normal":true,"ln1":1139,"ln2":1247,"content":"       return NS_ERROR_OUT_OF_MEMORY;"},{"type":"normal","normal":true,"ln1":1140,"ln2":1248,"content":"     }"},{"type":"normal","normal":true,"ln1":1141,"ln2":1249,"content":" "},{"type":"add","add":true,"ln":1250,"content":"+    // Keep this proto binding alive while we're alive.  Do this first so that"},{"type":"add","add":true,"ln":1251,"content":"+    // we can guarantee that in XBLFinalize this will be non-null."},{"type":"add","add":true,"ln":1252,"content":"+    nsIXBLDocumentInfo* docInfo = aProtoBinding->XBLDocumentInfo();"},{"type":"add","add":true,"ln":1253,"content":"+    ::JS_SetPrivate(cx, proto, docInfo);"},{"type":"add","add":true,"ln":1254,"content":"+    NS_ADDREF(docInfo);"},{"type":"add","add":true,"ln":1255,"content":"+"},{"type":"add","add":true,"ln":1256,"content":"+    if (!::JS_SetReservedSlot(cx, proto, 0, PRIVATE_TO_JSVAL(aProtoBinding))) {"},{"type":"add","add":true,"ln":1257,"content":"+      (nsXBLService::gClassTable)->Remove(&key);"},{"type":"add","add":true,"ln":1258,"content":"+"},{"type":"add","add":true,"ln":1259,"content":"+      // |c| will get dropped when |proto| is finalized"},{"type":"add","add":true,"ln":1260,"content":"+"},{"type":"add","add":true,"ln":1261,"content":"+      return NS_ERROR_OUT_OF_MEMORY;"},{"type":"add","add":true,"ln":1262,"content":"+    }"},{"type":"add","add":true,"ln":1263,"content":"+"},{"type":"normal","normal":true,"ln1":1142,"ln2":1264,"content":"     *aClassObject = (void*)proto;"},{"type":"normal","normal":true,"ln1":1143,"ln2":1265,"content":"   }"},{"type":"normal","normal":true,"ln1":1144,"ln2":1266,"content":"   else {"}],"oldStart":1139,"oldLines":6,"newStart":1247,"newLines":20},{"content":"@@ -1155,63 +1277,6 @@ nsXBLBinding::DoInitJSClass(JSContext *cx, JSObject *global, JSObject *obj,","changes":[{"type":"normal","normal":true,"ln1":1155,"ln2":1277,"content":"   return NS_OK;"},{"type":"normal","normal":true,"ln1":1156,"ln2":1278,"content":" }"},{"type":"normal","normal":true,"ln1":1157,"ln2":1279,"content":" "},{"type":"del","del":true,"ln":1158,"content":"-"},{"type":"del","del":true,"ln":1159,"content":"-nsresult"},{"type":"del","del":true,"ln":1160,"content":"-nsXBLBinding::InitClass(const nsCString& aClassName,"},{"type":"del","del":true,"ln":1161,"content":"-                        nsIScriptContext* aContext, "},{"type":"del","del":true,"ln":1162,"content":"-                        nsIDocument* aDocument, void** aScriptObject,"},{"type":"del","del":true,"ln":1163,"content":"-                        void** aClassObject)"},{"type":"del","del":true,"ln":1164,"content":"-{"},{"type":"del","del":true,"ln":1165,"content":"-  *aClassObject = nsnull;"},{"type":"del","del":true,"ln":1166,"content":"-  *aScriptObject = nsnull;"},{"type":"del","del":true,"ln":1167,"content":"-"},{"type":"del","del":true,"ln":1168,"content":"-  nsresult rv;"},{"type":"del","del":true,"ln":1169,"content":"-"},{"type":"del","del":true,"ln":1170,"content":"-  // Obtain the bound element's current script object."},{"type":"del","del":true,"ln":1171,"content":"-  JSContext* cx = (JSContext*)aContext->GetNativeContext();"},{"type":"del","del":true,"ln":1172,"content":"-"},{"type":"del","del":true,"ln":1173,"content":"-  nsIDocument *ownerDoc = mBoundElement->GetOwnerDoc();"},{"type":"del","del":true,"ln":1174,"content":"-  nsIScriptGlobalObject *sgo;"},{"type":"del","del":true,"ln":1175,"content":"-"},{"type":"del","del":true,"ln":1176,"content":"-  if (!ownerDoc || !(sgo = ownerDoc->GetScriptGlobalObject())) {"},{"type":"del","del":true,"ln":1177,"content":"-    NS_ERROR(\"Can't find global object for bound content!\");"},{"type":"del","del":true,"ln":1178,"content":"-"},{"type":"del","del":true,"ln":1179,"content":"-    return NS_ERROR_UNEXPECTED;"},{"type":"del","del":true,"ln":1180,"content":"-  }"},{"type":"del","del":true,"ln":1181,"content":"-"},{"type":"del","del":true,"ln":1182,"content":"-  nsCOMPtr<nsIXPConnectJSObjectHolder> wrapper;"},{"type":"del","del":true,"ln":1183,"content":"-  rv = nsContentUtils::XPConnect()->WrapNative(cx, sgo->GetGlobalJSObject(),"},{"type":"del","del":true,"ln":1184,"content":"-                                               mBoundElement,"},{"type":"del","del":true,"ln":1185,"content":"-                                               NS_GET_IID(nsISupports),"},{"type":"del","del":true,"ln":1186,"content":"-                                               getter_AddRefs(wrapper));"},{"type":"del","del":true,"ln":1187,"content":"-  NS_ENSURE_SUCCESS(rv, rv);"},{"type":"del","del":true,"ln":1188,"content":"-"},{"type":"del","del":true,"ln":1189,"content":"-  JSObject* object = nsnull;"},{"type":"del","del":true,"ln":1190,"content":"-  rv = wrapper->GetJSObject(&object);"},{"type":"del","del":true,"ln":1191,"content":"-  NS_ENSURE_SUCCESS(rv, rv);"},{"type":"del","del":true,"ln":1192,"content":"-"},{"type":"del","del":true,"ln":1193,"content":"-  *aScriptObject = object;"},{"type":"del","del":true,"ln":1194,"content":"-"},{"type":"del","del":true,"ln":1195,"content":"-  // First ensure our JS class is initialized."},{"type":"del","del":true,"ln":1196,"content":"-"},{"type":"del","del":true,"ln":1197,"content":"-  rv = DoInitJSClass(cx, sgo->GetGlobalJSObject(), object, aClassName,"},{"type":"del","del":true,"ln":1198,"content":"-                     aClassObject);"},{"type":"del","del":true,"ln":1199,"content":"-  NS_ENSURE_SUCCESS(rv, rv);"},{"type":"del","del":true,"ln":1200,"content":"-"},{"type":"del","del":true,"ln":1201,"content":"-  // Root mBoundElement so that it doesn't lose it's binding"},{"type":"del","del":true,"ln":1202,"content":"-  nsIDocument* doc = mBoundElement->GetOwnerDoc();"},{"type":"del","del":true,"ln":1203,"content":"-"},{"type":"del","del":true,"ln":1204,"content":"-  if (doc) {"},{"type":"del","del":true,"ln":1205,"content":"-    nsCOMPtr<nsIXPConnectWrappedNative> native_wrapper ="},{"type":"del","del":true,"ln":1206,"content":"-      do_QueryInterface(wrapper);"},{"type":"del","del":true,"ln":1207,"content":"-    if (native_wrapper) {"},{"type":"del","del":true,"ln":1208,"content":"-      doc->AddReference(mBoundElement, native_wrapper);"},{"type":"del","del":true,"ln":1209,"content":"-    }"},{"type":"del","del":true,"ln":1210,"content":"-  }"},{"type":"del","del":true,"ln":1211,"content":"-"},{"type":"del","del":true,"ln":1212,"content":"-  return NS_OK;"},{"type":"del","del":true,"ln":1213,"content":"-}"},{"type":"del","del":true,"ln":1214,"content":"-"},{"type":"normal","normal":true,"ln1":1215,"ln2":1280,"content":" PRBool"},{"type":"normal","normal":true,"ln1":1216,"ln2":1281,"content":" nsXBLBinding::AllowScripts()"},{"type":"normal","normal":true,"ln1":1217,"ln2":1282,"content":" {"}],"oldStart":1155,"oldLines":63,"newStart":1277,"newLines":6},{"content":"@@ -1344,6 +1409,20 @@ nsXBLBinding::GetFirstStyleBinding()","changes":[{"type":"normal","normal":true,"ln1":1344,"ln2":1409,"content":"   return mNextBinding ? mNextBinding->GetFirstStyleBinding() : nsnull;"},{"type":"normal","normal":true,"ln1":1345,"ln2":1410,"content":" }"},{"type":"normal","normal":true,"ln1":1346,"ln2":1411,"content":" "},{"type":"add","add":true,"ln":1412,"content":"+PRBool"},{"type":"add","add":true,"ln":1413,"content":"+nsXBLBinding::ResolveAllFields(JSContext *cx, JSObject *obj) const"},{"type":"add","add":true,"ln":1414,"content":"+{"},{"type":"add","add":true,"ln":1415,"content":"+  if (!mPrototypeBinding->ResolveAllFields(cx, obj)) {"},{"type":"add","add":true,"ln":1416,"content":"+    return PR_FALSE;"},{"type":"add","add":true,"ln":1417,"content":"+  }"},{"type":"add","add":true,"ln":1418,"content":"+"},{"type":"add","add":true,"ln":1419,"content":"+  if (mNextBinding) {"},{"type":"add","add":true,"ln":1420,"content":"+    return mNextBinding->ResolveAllFields(cx, obj);"},{"type":"add","add":true,"ln":1421,"content":"+  }"},{"type":"add","add":true,"ln":1422,"content":"+"},{"type":"add","add":true,"ln":1423,"content":"+  return PR_TRUE;"},{"type":"add","add":true,"ln":1424,"content":"+}"},{"type":"add","add":true,"ln":1425,"content":"+"},{"type":"normal","normal":true,"ln1":1347,"ln2":1426,"content":" void"},{"type":"normal","normal":true,"ln1":1348,"ln2":1427,"content":" nsXBLBinding::MarkForDeath()"},{"type":"normal","normal":true,"ln1":1349,"ln2":1428,"content":" {"}],"oldStart":1344,"oldLines":6,"newStart":1409,"newLines":20}],"deletions":59,"additions":138,"from":"content/xbl/src/nsXBLBinding.cpp","to":"content/xbl/src/nsXBLBinding.cpp","index":["08b226b..e9f83e7","100644"]},{"chunks":[{"content":"@@ -132,6 +132,10 @@ public:","changes":[{"type":"normal","normal":true,"ln1":132,"ln2":132,"content":"   nsXBLBinding* RootBinding();"},{"type":"normal","normal":true,"ln1":133,"ln2":133,"content":"   nsXBLBinding* GetFirstStyleBinding();"},{"type":"normal","normal":true,"ln1":134,"ln2":134,"content":" "},{"type":"add","add":true,"ln":135,"content":"+  // Resolve all the fields for this binding and all ancestor bindings on the"},{"type":"add","add":true,"ln":136,"content":"+  // object |obj|.  False return means a JS exception was set."},{"type":"add","add":true,"ln":137,"content":"+  PRBool ResolveAllFields(JSContext *cx, JSObject *obj) const;"},{"type":"add","add":true,"ln":138,"content":"+"},{"type":"normal","normal":true,"ln1":135,"ln2":139,"content":"   // Get the list of insertion points for aParent. The nsInsertionPointList"},{"type":"normal","normal":true,"ln1":136,"ln2":140,"content":"   // is owned by the binding, you should not delete it."},{"type":"normal","normal":true,"ln1":137,"ln2":141,"content":"   nsresult GetInsertionPointsFor(nsIContent* aParent,"}],"oldStart":132,"oldLines":6,"newStart":132,"newLines":10},{"content":"@@ -155,16 +159,11 @@ public:","changes":[{"type":"normal","normal":true,"ln1":155,"ln2":159,"content":" "},{"type":"normal","normal":true,"ln1":156,"ln2":160,"content":"   static nsresult DoInitJSClass(JSContext *cx, JSObject *global, JSObject *obj,"},{"type":"normal","normal":true,"ln1":157,"ln2":161,"content":"                                 const nsAFlatCString& aClassName,"},{"type":"add","add":true,"ln":162,"content":"+                                nsXBLPrototypeBinding* aProtoBinding,"},{"type":"normal","normal":true,"ln1":158,"ln2":163,"content":"                                 void **aClassObject);"},{"type":"normal","normal":true,"ln1":159,"ln2":164,"content":" "},{"type":"normal","normal":true,"ln1":160,"ln2":165,"content":"   PRBool AllowScripts();  // XXX make const"},{"type":"normal","normal":true,"ln1":161,"ln2":166,"content":" "},{"type":"del","del":true,"ln":162,"content":"-// Internal member functions"},{"type":"del","del":true,"ln":163,"content":"-protected:"},{"type":"del","del":true,"ln":164,"content":"-  nsresult InitClass(const nsCString& aClassName, nsIScriptContext* aContext,"},{"type":"del","del":true,"ln":165,"content":"-                     nsIDocument* aDocument, void** aScriptObject,"},{"type":"del","del":true,"ln":166,"content":"-                     void** aClassObject);"},{"type":"del","del":true,"ln":167,"content":"-"},{"type":"normal","normal":true,"ln1":168,"ln2":167,"content":" // MEMBER VARIABLES"},{"type":"normal","normal":true,"ln1":169,"ln2":168,"content":" protected:"},{"type":"normal","normal":true,"ln1":170,"ln2":169,"content":"   nsAutoRefCnt mRefCnt;"}],"oldStart":155,"oldLines":16,"newStart":159,"newLines":11}],"deletions":6,"additions":5,"from":"content/xbl/src/nsXBLBinding.h","to":"content/xbl/src/nsXBLBinding.h","index":["744c418..55b571f","100644"]},{"chunks":[{"content":"@@ -83,12 +83,13 @@ nsXBLContentSink::nsXBLContentSink()","changes":[{"type":"normal","normal":true,"ln1":83,"ln2":83,"content":"   : mState(eXBL_InDocument),"},{"type":"normal","normal":true,"ln1":84,"ln2":84,"content":"     mSecondaryState(eXBL_None),"},{"type":"normal","normal":true,"ln1":85,"ln2":85,"content":"     mDocInfo(nsnull),"},{"type":"del","del":true,"ln":86,"content":"-    mFoundFirstBinding(PR_FALSE),    "},{"type":"normal","normal":true,"ln1":87,"ln2":86,"content":"     mIsChromeOrResource(PR_FALSE),"},{"type":"add","add":true,"ln":87,"content":"+    mFoundFirstBinding(PR_FALSE),    "},{"type":"normal","normal":true,"ln1":88,"ln2":88,"content":"     mBinding(nsnull),"},{"type":"normal","normal":true,"ln1":89,"ln2":89,"content":"     mHandler(nsnull),"},{"type":"normal","normal":true,"ln1":90,"ln2":90,"content":"     mImplementation(nsnull),"},{"type":"normal","normal":true,"ln1":91,"ln2":91,"content":"     mImplMember(nsnull),"},{"type":"add","add":true,"ln":92,"content":"+    mImplField(nsnull),"},{"type":"normal","normal":true,"ln1":92,"ln2":93,"content":"     mProperty(nsnull),"},{"type":"normal","normal":true,"ln1":93,"ln2":94,"content":"     mMethod(nsnull),"},{"type":"normal","normal":true,"ln1":94,"ln2":95,"content":"     mField(nsnull)"}],"oldStart":83,"oldLines":12,"newStart":83,"newLines":13},{"content":"@@ -263,6 +264,18 @@ nsXBLContentSink::AddMember(nsXBLProtoImplMember* aMember)","changes":[{"type":"normal","normal":true,"ln1":263,"ln2":264,"content":"   mImplMember = aMember; // Adjust our pointer to point to the new last member in the chain."},{"type":"normal","normal":true,"ln1":264,"ln2":265,"content":" }"},{"type":"normal","normal":true,"ln1":265,"ln2":266,"content":" "},{"type":"add","add":true,"ln":267,"content":"+void"},{"type":"add","add":true,"ln":268,"content":"+nsXBLContentSink::AddField(nsXBLProtoImplField* aField)"},{"type":"add","add":true,"ln":269,"content":"+{"},{"type":"add","add":true,"ln":270,"content":"+  // Add this field to our chain."},{"type":"add","add":true,"ln":271,"content":"+  if (mImplField)"},{"type":"add","add":true,"ln":272,"content":"+    mImplField->SetNext(aField); // Already have a chain. Just append to the end."},{"type":"add","add":true,"ln":273,"content":"+  else"},{"type":"add","add":true,"ln":274,"content":"+    mImplementation->SetFieldList(aField); // We're the first member in the chain."},{"type":"add","add":true,"ln":275,"content":"+"},{"type":"add","add":true,"ln":276,"content":"+  mImplField = aField; // Adjust our pointer to point to the new last field in the chain."},{"type":"add","add":true,"ln":277,"content":"+}"},{"type":"add","add":true,"ln":278,"content":"+"},{"type":"normal","normal":true,"ln1":266,"ln2":279,"content":" NS_IMETHODIMP "},{"type":"normal","normal":true,"ln1":267,"ln2":280,"content":" nsXBLContentSink::HandleStartElement(const PRUnichar *aName, "},{"type":"normal","normal":true,"ln1":268,"ln2":281,"content":"                                      const PRUnichar **aAtts, "}],"oldStart":263,"oldLines":6,"newStart":264,"newLines":18},{"content":"@@ -703,7 +716,8 @@ nsXBLContentSink::ConstructImplementation(const PRUnichar **aAtts)","changes":[{"type":"normal","normal":true,"ln1":703,"ln2":716,"content":" {"},{"type":"normal","normal":true,"ln1":704,"ln2":717,"content":"   mImplementation = nsnull;"},{"type":"normal","normal":true,"ln1":705,"ln2":718,"content":"   mImplMember = nsnull;"},{"type":"del","del":true,"ln":706,"content":"-      "},{"type":"add","add":true,"ln":719,"content":"+  mImplField = nsnull;"},{"type":"add","add":true,"ln":720,"content":"+  "},{"type":"normal","normal":true,"ln1":707,"ln2":721,"content":"   if (!mBinding)"},{"type":"normal","normal":true,"ln1":708,"ln2":722,"content":"     return;"},{"type":"normal","normal":true,"ln1":709,"ln2":723,"content":" "}],"oldStart":703,"oldLines":7,"newStart":716,"newLines":8},{"content":"@@ -777,7 +791,7 @@ nsXBLContentSink::ConstructField(const PRUnichar **aAtts, PRUint32 aLineNumber)","changes":[{"type":"normal","normal":true,"ln1":777,"ln2":791,"content":"     mField = new nsXBLProtoImplField(name, readonly);"},{"type":"normal","normal":true,"ln1":778,"ln2":792,"content":"     if (mField) {"},{"type":"normal","normal":true,"ln1":779,"ln2":793,"content":"       mField->SetLineNumber(aLineNumber);"},{"type":"del","del":true,"ln":780,"content":"-      AddMember(mField);"},{"type":"add","add":true,"ln":794,"content":"+      AddField(mField);"},{"type":"normal","normal":true,"ln1":781,"ln2":795,"content":"     }"},{"type":"normal","normal":true,"ln1":782,"ln2":796,"content":"   }"},{"type":"normal","normal":true,"ln1":783,"ln2":797,"content":" }"}],"oldStart":777,"oldLines":7,"newStart":791,"newLines":7}],"deletions":3,"additions":17,"from":"content/xbl/src/nsXBLContentSink.cpp","to":"content/xbl/src/nsXBLContentSink.cpp","index":["19bdf77..ea2ee5c","100644"]},{"chunks":[{"content":"@@ -157,6 +157,7 @@ protected:","changes":[{"type":"normal","normal":true,"ln1":157,"ln2":157,"content":"   nsresult ReportUnexpectedElement(nsIAtom* aElementName, PRUint32 aLineNumber);"},{"type":"normal","normal":true,"ln1":158,"ln2":158,"content":" "},{"type":"normal","normal":true,"ln1":159,"ln2":159,"content":"   void AddMember(nsXBLProtoImplMember* aMember);"},{"type":"add","add":true,"ln":160,"content":"+  void AddField(nsXBLProtoImplField* aField);"},{"type":"normal","normal":true,"ln1":160,"ln2":161,"content":"   "},{"type":"normal","normal":true,"ln1":161,"ln2":162,"content":"   XBLPrimaryState mState;"},{"type":"normal","normal":true,"ln1":162,"ln2":163,"content":"   XBLSecondaryState mSecondaryState;"}],"oldStart":157,"oldLines":6,"newStart":157,"newLines":7},{"content":"@@ -168,6 +169,7 @@ protected:","changes":[{"type":"normal","normal":true,"ln1":168,"ln2":169,"content":"   nsXBLPrototypeHandler* mHandler; // current handler, owned by its PrototypeBinding"},{"type":"normal","normal":true,"ln1":169,"ln2":170,"content":"   nsXBLProtoImpl* mImplementation;"},{"type":"normal","normal":true,"ln1":170,"ln2":171,"content":"   nsXBLProtoImplMember* mImplMember;"},{"type":"add","add":true,"ln":172,"content":"+  nsXBLProtoImplField* mImplField;"},{"type":"normal","normal":true,"ln1":171,"ln2":173,"content":"   nsXBLProtoImplProperty* mProperty;"},{"type":"normal","normal":true,"ln1":172,"ln2":174,"content":"   nsXBLProtoImplMethod* mMethod;"},{"type":"normal","normal":true,"ln1":173,"ln2":175,"content":"   nsXBLProtoImplField* mField;"}],"oldStart":168,"oldLines":6,"newStart":169,"newLines":7}],"deletions":0,"additions":2,"from":"content/xbl/src/nsXBLContentSink.h","to":"content/xbl/src/nsXBLContentSink.h","index":["0d59fff..2cb1368","100644"]},{"chunks":[{"content":"@@ -409,6 +409,8 @@ nsXBLDocGlobalObject::GetPrincipal()","changes":[{"type":"normal","normal":true,"ln1":409,"ln2":409,"content":" {"},{"type":"normal","normal":true,"ln1":410,"ln2":410,"content":"   nsresult rv = NS_OK;"},{"type":"normal","normal":true,"ln1":411,"ln2":411,"content":"   if (!mGlobalObjectOwner) {"},{"type":"add","add":true,"ln":412,"content":"+    // XXXbz this should really save the principal when"},{"type":"add","add":true,"ln":413,"content":"+    // ClearGlobalObjectOwner() happens."},{"type":"normal","normal":true,"ln1":412,"ln2":414,"content":"     return nsnull;"},{"type":"normal","normal":true,"ln1":413,"ln2":415,"content":"   }"},{"type":"normal","normal":true,"ln1":414,"ln2":416,"content":" "}],"oldStart":409,"oldLines":6,"newStart":409,"newLines":8},{"content":"@@ -442,8 +444,19 @@ TraverseProtos(nsHashKey *aKey, void *aData, void* aClosure)","changes":[{"type":"normal","normal":true,"ln1":442,"ln2":444,"content":"   return kHashEnumerateNext;"},{"type":"normal","normal":true,"ln1":443,"ln2":445,"content":" }"},{"type":"normal","normal":true,"ln1":444,"ln2":446,"content":" "},{"type":"add","add":true,"ln":447,"content":"+static PRIntn PR_CALLBACK"},{"type":"add","add":true,"ln":448,"content":"+UnlinkProtos(nsHashKey *aKey, void *aData, void* aClosure)"},{"type":"add","add":true,"ln":449,"content":"+{"},{"type":"add","add":true,"ln":450,"content":"+  nsXBLPrototypeBinding *proto = static_cast<nsXBLPrototypeBinding*>(aData);"},{"type":"add","add":true,"ln":451,"content":"+  proto->Unlink();"},{"type":"add","add":true,"ln":452,"content":"+  return kHashEnumerateNext;"},{"type":"add","add":true,"ln":453,"content":"+}"},{"type":"add","add":true,"ln":454,"content":"+"},{"type":"normal","normal":true,"ln1":445,"ln2":455,"content":" NS_IMPL_CYCLE_COLLECTION_CLASS(nsXBLDocumentInfo)"},{"type":"normal","normal":true,"ln1":446,"ln2":456,"content":" NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(nsXBLDocumentInfo)"},{"type":"add","add":true,"ln":457,"content":"+  if (tmp->mBindingTable) {"},{"type":"add","add":true,"ln":458,"content":"+    tmp->mBindingTable->Enumerate(UnlinkProtos, nsnull);"},{"type":"add","add":true,"ln":459,"content":"+  }"},{"type":"normal","normal":true,"ln1":447,"ln2":460,"content":"   NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mDocument)"},{"type":"normal","normal":true,"ln1":448,"ln2":461,"content":"   NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mGlobalObject)"},{"type":"normal","normal":true,"ln1":449,"ln2":462,"content":" NS_IMPL_CYCLE_COLLECTION_UNLINK_END"}],"oldStart":442,"oldLines":8,"newStart":444,"newLines":19}],"deletions":0,"additions":13,"from":"content/xbl/src/nsXBLDocumentInfo.cpp","to":"content/xbl/src/nsXBLDocumentInfo.cpp","index":["9fa254c..4da0e37","100644"]},{"chunks":[{"content":"@@ -47,6 +47,7 @@","changes":[{"type":"normal","normal":true,"ln1":47,"ln2":47,"content":" #include \"nsIServiceManager.h\""},{"type":"normal","normal":true,"ln1":48,"ln2":48,"content":" #include \"nsIXBLDocumentInfo.h\""},{"type":"normal","normal":true,"ln1":49,"ln2":49,"content":" #include \"nsIDOMNode.h\""},{"type":"add","add":true,"ln":50,"content":"+#include \"nsXBLPrototypeBinding.h\""},{"type":"normal","normal":true,"ln1":50,"ln2":51,"content":" "},{"type":"normal","normal":true,"ln1":51,"ln2":52,"content":" nsresult"},{"type":"normal","normal":true,"ln1":52,"ln2":53,"content":" nsXBLProtoImpl::InstallImplementation(nsXBLPrototypeBinding* aBinding, nsIContent* aBoundElement)"}],"oldStart":47,"oldLines":6,"newStart":47,"newLines":7},{"content":"@@ -55,7 +56,7 @@ nsXBLProtoImpl::InstallImplementation(nsXBLPrototypeBinding* aBinding, nsIConten","changes":[{"type":"normal","normal":true,"ln1":55,"ln2":56,"content":"   // this prototype implementation as a guide.  The prototype implementation is compiled lazily,"},{"type":"normal","normal":true,"ln1":56,"ln2":57,"content":"   // so for the first bound element that needs a concrete implementation, we also build the"},{"type":"normal","normal":true,"ln1":57,"ln2":58,"content":"   // prototype implementation."},{"type":"del","del":true,"ln":58,"content":"-  if (!mMembers)  // Constructor and destructor also live in mMembers"},{"type":"add","add":true,"ln":59,"content":"+  if (!mMembers && !mFields)  // Constructor and destructor also live in mMembers"},{"type":"normal","normal":true,"ln1":59,"ln2":60,"content":"     return NS_OK; // Nothing to do, so let's not waste time."},{"type":"normal","normal":true,"ln1":60,"ln2":61,"content":" "},{"type":"normal","normal":true,"ln1":61,"ln2":62,"content":"   // If the way this gets the script context changes, fix"}],"oldStart":55,"oldLines":7,"newStart":56,"newLines":7},{"content":"@@ -215,6 +216,45 @@ nsXBLProtoImpl::Traverse(nsCycleCollectionTraversalCallback &cb) const","changes":[{"type":"normal","normal":true,"ln1":215,"ln2":216,"content":" }"},{"type":"normal","normal":true,"ln1":216,"ln2":217,"content":" "},{"type":"normal","normal":true,"ln1":217,"ln2":218,"content":" void"},{"type":"add","add":true,"ln":219,"content":"+nsXBLProtoImpl::Unlink()"},{"type":"add","add":true,"ln":220,"content":"+{"},{"type":"add","add":true,"ln":221,"content":"+  if (mClassObject) {"},{"type":"add","add":true,"ln":222,"content":"+    DestroyMembers(nsnull);"},{"type":"add","add":true,"ln":223,"content":"+  }"},{"type":"add","add":true,"ln":224,"content":"+}"},{"type":"add","add":true,"ln":225,"content":"+"},{"type":"add","add":true,"ln":226,"content":"+nsXBLProtoImplField*"},{"type":"add","add":true,"ln":227,"content":"+nsXBLProtoImpl::FindField(const nsString& aFieldName) const"},{"type":"add","add":true,"ln":228,"content":"+{"},{"type":"add","add":true,"ln":229,"content":"+  for (nsXBLProtoImplField* f = mFields; f; f = f->GetNext()) {"},{"type":"add","add":true,"ln":230,"content":"+    if (aFieldName.Equals(f->GetName())) {"},{"type":"add","add":true,"ln":231,"content":"+      return f;"},{"type":"add","add":true,"ln":232,"content":"+    }"},{"type":"add","add":true,"ln":233,"content":"+  }"},{"type":"add","add":true,"ln":234,"content":"+"},{"type":"add","add":true,"ln":235,"content":"+  return nsnull;"},{"type":"add","add":true,"ln":236,"content":"+}"},{"type":"add","add":true,"ln":237,"content":"+"},{"type":"add","add":true,"ln":238,"content":"+PRBool"},{"type":"add","add":true,"ln":239,"content":"+nsXBLProtoImpl::ResolveAllFields(JSContext *cx, JSObject *obj) const"},{"type":"add","add":true,"ln":240,"content":"+{"},{"type":"add","add":true,"ln":241,"content":"+  for (nsXBLProtoImplField* f = mFields; f; f = f->GetNext()) {"},{"type":"add","add":true,"ln":242,"content":"+    // Using OBJ_LOOKUP_PROPERTY is a pain, since what we have is a"},{"type":"add","add":true,"ln":243,"content":"+    // PRUnichar* for the property name.  Let's just use the public API and"},{"type":"add","add":true,"ln":244,"content":"+    // all."},{"type":"add","add":true,"ln":245,"content":"+    nsDependentString name(f->GetName());"},{"type":"add","add":true,"ln":246,"content":"+    jsval dummy;"},{"type":"add","add":true,"ln":247,"content":"+    if (!::JS_LookupUCProperty(cx, obj,"},{"type":"add","add":true,"ln":248,"content":"+                               reinterpret_cast<const jschar*>(name.get()),"},{"type":"add","add":true,"ln":249,"content":"+                               name.Length(), &dummy)) {"},{"type":"add","add":true,"ln":250,"content":"+      return PR_FALSE;"},{"type":"add","add":true,"ln":251,"content":"+    }"},{"type":"add","add":true,"ln":252,"content":"+  }"},{"type":"add","add":true,"ln":253,"content":"+"},{"type":"add","add":true,"ln":254,"content":"+  return PR_TRUE;"},{"type":"add","add":true,"ln":255,"content":"+}"},{"type":"add","add":true,"ln":256,"content":"+"},{"type":"add","add":true,"ln":257,"content":"+void"},{"type":"normal","normal":true,"ln1":218,"ln2":258,"content":" nsXBLProtoImpl::DestroyMembers(nsXBLProtoImplMember* aBrokenMember)"},{"type":"normal","normal":true,"ln1":219,"ln2":259,"content":" {"},{"type":"normal","normal":true,"ln1":220,"ln2":260,"content":"   NS_ASSERTION(mClassObject, \"This should never be called when there is no class object\");"}],"oldStart":215,"oldLines":6,"newStart":216,"newLines":45}],"deletions":1,"additions":41,"from":"content/xbl/src/nsXBLProtoImpl.cpp","to":"content/xbl/src/nsXBLProtoImpl.cpp","index":["1a1feff..efe7bd2","100644"]},{"chunks":[{"content":"@@ -42,9 +42,11 @@","changes":[{"type":"normal","normal":true,"ln1":42,"ln2":42,"content":" #include \"nsMemory.h\""},{"type":"normal","normal":true,"ln1":43,"ln2":43,"content":" #include \"nsXBLPrototypeHandler.h\""},{"type":"normal","normal":true,"ln1":44,"ln2":44,"content":" #include \"nsXBLProtoImplMember.h\""},{"type":"del","del":true,"ln":45,"content":"-#include \"nsXBLPrototypeBinding.h\""},{"type":"add","add":true,"ln":45,"content":"+#include \"nsXBLProtoImplField.h\""},{"type":"normal","normal":true,"ln1":46,"ln2":46,"content":" "},{"type":"normal","normal":true,"ln1":47,"ln2":47,"content":" class nsIXPConnectJSObjectHolder;"},{"type":"add","add":true,"ln":48,"content":"+class nsXBLPrototypeBinding;"},{"type":"add","add":true,"ln":49,"content":"+class nsXBLProtoImplAnonymousMethod;"},{"type":"normal","normal":true,"ln1":48,"ln2":50,"content":" "},{"type":"normal","normal":true,"ln1":49,"ln2":51,"content":" class nsXBLProtoImpl"},{"type":"normal","normal":true,"ln1":50,"ln2":52,"content":" {"}],"oldStart":42,"oldLines":9,"newStart":42,"newLines":11},{"content":"@@ -52,6 +54,7 @@ public:","changes":[{"type":"normal","normal":true,"ln1":52,"ln2":54,"content":"   nsXBLProtoImpl() "},{"type":"normal","normal":true,"ln1":53,"ln2":55,"content":"     : mClassObject(nsnull),"},{"type":"normal","normal":true,"ln1":54,"ln2":56,"content":"       mMembers(nsnull),"},{"type":"add","add":true,"ln":57,"content":"+      mFields(nsnull),"},{"type":"normal","normal":true,"ln1":55,"ln2":58,"content":"       mConstructor(nsnull),"},{"type":"normal","normal":true,"ln1":56,"ln2":59,"content":"       mDestructor(nsnull)"},{"type":"normal","normal":true,"ln1":57,"ln2":60,"content":"   { "}],"oldStart":52,"oldLines":6,"newStart":54,"newLines":7},{"content":"@@ -64,7 +67,8 @@ public:","changes":[{"type":"normal","normal":true,"ln1":64,"ln2":67,"content":"     // clean them up automatically."},{"type":"normal","normal":true,"ln1":65,"ln2":68,"content":"     for (nsXBLProtoImplMember* curr = mMembers; curr; curr=curr->GetNext())"},{"type":"normal","normal":true,"ln1":66,"ln2":69,"content":"       curr->Destroy(mClassObject != nsnull);"},{"type":"del","del":true,"ln":67,"content":"-    delete mMembers; "},{"type":"add","add":true,"ln":70,"content":"+    delete mMembers;"},{"type":"add","add":true,"ln":71,"content":"+    delete mFields;"},{"type":"normal","normal":true,"ln1":68,"ln2":72,"content":"   }"},{"type":"normal","normal":true,"ln1":69,"ln2":73,"content":"   "},{"type":"normal","normal":true,"ln1":70,"ln2":74,"content":"   nsresult InstallImplementation(nsXBLPrototypeBinding* aBinding, nsIContent* aBoundElement);"}],"oldStart":64,"oldLines":7,"newStart":67,"newLines":8},{"content":"@@ -74,9 +78,26 @@ public:","changes":[{"type":"normal","normal":true,"ln1":74,"ln2":78,"content":"                              void** aTargetClassObject);"},{"type":"normal","normal":true,"ln1":75,"ln2":79,"content":"   nsresult CompilePrototypeMembers(nsXBLPrototypeBinding* aBinding);"},{"type":"normal","normal":true,"ln1":76,"ln2":80,"content":" "},{"type":"del","del":true,"ln":77,"content":"-  void SetMemberList(nsXBLProtoImplMember* aMemberList) { delete mMembers; mMembers = aMemberList; }"},{"type":"add","add":true,"ln":81,"content":"+  void SetMemberList(nsXBLProtoImplMember* aMemberList)"},{"type":"add","add":true,"ln":82,"content":"+  {"},{"type":"add","add":true,"ln":83,"content":"+    delete mMembers;"},{"type":"add","add":true,"ln":84,"content":"+    mMembers = aMemberList;"},{"type":"add","add":true,"ln":85,"content":"+  }"},{"type":"add","add":true,"ln":86,"content":"+"},{"type":"add","add":true,"ln":87,"content":"+  void SetFieldList(nsXBLProtoImplField* aFieldList)"},{"type":"add","add":true,"ln":88,"content":"+  {"},{"type":"add","add":true,"ln":89,"content":"+    delete mFields;"},{"type":"add","add":true,"ln":90,"content":"+    mFields = aFieldList;"},{"type":"add","add":true,"ln":91,"content":"+  }"},{"type":"normal","normal":true,"ln1":78,"ln2":92,"content":" "},{"type":"normal","normal":true,"ln1":79,"ln2":93,"content":"   void Traverse(nsCycleCollectionTraversalCallback &cb) const;"},{"type":"add","add":true,"ln":94,"content":"+  void Unlink();"},{"type":"add","add":true,"ln":95,"content":"+"},{"type":"add","add":true,"ln":96,"content":"+  nsXBLProtoImplField* FindField(const nsString& aFieldName) const;"},{"type":"add","add":true,"ln":97,"content":"+"},{"type":"add","add":true,"ln":98,"content":"+  // Resolve all the fields for this implementation on the object |obj| False"},{"type":"add","add":true,"ln":99,"content":"+  // return means a JS exception was set."},{"type":"add","add":true,"ln":100,"content":"+  PRBool ResolveAllFields(JSContext *cx, JSObject *obj) const;"},{"type":"normal","normal":true,"ln1":80,"ln2":101,"content":" "},{"type":"normal","normal":true,"ln1":81,"ln2":102,"content":" protected:"},{"type":"normal","normal":true,"ln1":82,"ln2":103,"content":"   // Function to call if compilation of a member fails.  When this is called,"}],"oldStart":74,"oldLines":9,"newStart":78,"newLines":26},{"content":"@@ -93,6 +114,8 @@ protected:","changes":[{"type":"normal","normal":true,"ln1":93,"ln2":114,"content":"                         // and methods for the binding."},{"type":"normal","normal":true,"ln1":94,"ln2":115,"content":" "},{"type":"normal","normal":true,"ln1":95,"ln2":116,"content":"   nsXBLProtoImplMember* mMembers; // The members of an implementation are chained in this singly-linked list."},{"type":"add","add":true,"ln":117,"content":"+"},{"type":"add","add":true,"ln":118,"content":"+  nsXBLProtoImplField* mFields; // Our fields"},{"type":"normal","normal":true,"ln1":96,"ln2":119,"content":"   "},{"type":"normal","normal":true,"ln1":97,"ln2":120,"content":" public:"},{"type":"normal","normal":true,"ln1":98,"ln2":121,"content":"   nsXBLProtoImplAnonymousMethod* mConstructor; // Our class constructor."}],"oldStart":93,"oldLines":6,"newStart":114,"newLines":8}],"deletions":3,"additions":26,"from":"content/xbl/src/nsXBLProtoImpl.h","to":"content/xbl/src/nsXBLProtoImpl.h","index":["54f36b1..2b4e0ad","100644"]},{"chunks":[{"content":"@@ -46,14 +46,17 @@","changes":[{"type":"normal","normal":true,"ln1":46,"ln2":46,"content":" #include \"nsXBLProtoImplField.h\""},{"type":"normal","normal":true,"ln1":47,"ln2":47,"content":" #include \"nsIScriptContext.h\""},{"type":"normal","normal":true,"ln1":48,"ln2":48,"content":" #include \"nsContentUtils.h\""},{"type":"add","add":true,"ln":49,"content":"+#include \"nsIURI.h\""},{"type":"normal","normal":true,"ln1":49,"ln2":50,"content":" "},{"type":"normal","normal":true,"ln1":50,"ln2":51,"content":" nsXBLProtoImplField::nsXBLProtoImplField(const PRUnichar* aName, const PRUnichar* aReadOnly)"},{"type":"del","del":true,"ln":51,"content":"-  : nsXBLProtoImplMember(aName),"},{"type":"add","add":true,"ln":52,"content":"+  : mNext(nsnull),"},{"type":"normal","normal":true,"ln1":52,"ln2":53,"content":"     mFieldText(nsnull),"},{"type":"normal","normal":true,"ln1":53,"ln2":54,"content":"     mFieldTextLength(0),"},{"type":"normal","normal":true,"ln1":54,"ln2":55,"content":"     mLineNumber(0)"},{"type":"normal","normal":true,"ln1":55,"ln2":56,"content":" {"},{"type":"normal","normal":true,"ln1":56,"ln2":57,"content":"   MOZ_COUNT_CTOR(nsXBLProtoImplField);"},{"type":"add","add":true,"ln":58,"content":"+  mName = NS_strdup(aName);  // XXXbz make more sense to use a stringbuffer?"},{"type":"add","add":true,"ln":59,"content":"+  "},{"type":"normal","normal":true,"ln1":57,"ln2":60,"content":"   mJSAttributes = JSPROP_ENUMERATE;"},{"type":"normal","normal":true,"ln1":58,"ln2":61,"content":"   if (aReadOnly) {"},{"type":"normal","normal":true,"ln1":59,"ln2":62,"content":"     nsAutoString readOnly; readOnly.Assign(*aReadOnly);"}],"oldStart":46,"oldLines":14,"newStart":46,"newLines":17},{"content":"@@ -67,11 +70,8 @@ nsXBLProtoImplField::~nsXBLProtoImplField()","changes":[{"type":"normal","normal":true,"ln1":67,"ln2":70,"content":"   MOZ_COUNT_DTOR(nsXBLProtoImplField);"},{"type":"normal","normal":true,"ln1":68,"ln2":71,"content":"   if (mFieldText)"},{"type":"normal","normal":true,"ln1":69,"ln2":72,"content":"     nsMemory::Free(mFieldText);"},{"type":"del","del":true,"ln":70,"content":"-}"},{"type":"del","del":true,"ln":71,"content":"-"},{"type":"del","del":true,"ln":72,"content":"-void"},{"type":"del","del":true,"ln":73,"content":"-nsXBLProtoImplField::Destroy(PRBool aIsCompiled)"},{"type":"del","del":true,"ln":74,"content":"-{"},{"type":"add","add":true,"ln":73,"content":"+  NS_Free(mName);"},{"type":"add","add":true,"ln":74,"content":"+  delete mNext;"},{"type":"normal","normal":true,"ln1":75,"ln2":75,"content":" }"},{"type":"normal","normal":true,"ln1":76,"ln2":76,"content":" "},{"type":"normal","normal":true,"ln1":77,"ln2":77,"content":" void "}],"oldStart":67,"oldLines":11,"newStart":70,"newLines":8},{"content":"@@ -92,27 +92,15 @@ nsXBLProtoImplField::AppendFieldText(const nsAString& aText)","changes":[{"type":"normal","normal":true,"ln1":92,"ln2":92,"content":" }"},{"type":"normal","normal":true,"ln1":93,"ln2":93,"content":" "},{"type":"normal","normal":true,"ln1":94,"ln2":94,"content":" nsresult"},{"type":"del","del":true,"ln":95,"content":"-nsXBLProtoImplField::InstallMember(nsIScriptContext* aContext,"},{"type":"del","del":true,"ln":96,"content":"-                                   nsIContent* aBoundElement, "},{"type":"del","del":true,"ln":97,"content":"-                                   void* aScriptObject,"},{"type":"del","del":true,"ln":98,"content":"-                                   void* aTargetClassObject,"},{"type":"del","del":true,"ln":99,"content":"-                                   const nsCString& aClassStr)"},{"type":"add","add":true,"ln":95,"content":"+nsXBLProtoImplField::InstallField(nsIScriptContext* aContext,"},{"type":"add","add":true,"ln":96,"content":"+                                  JSObject* aBoundNode,"},{"type":"add","add":true,"ln":97,"content":"+                                  nsIURI* aBindingDocURI) const"},{"type":"normal","normal":true,"ln1":100,"ln2":98,"content":" {"},{"type":"del","del":true,"ln":101,"content":"-  if (mFieldTextLength == 0)"},{"type":"del","del":true,"ln":102,"content":"-    return NS_OK; // nothing to do."},{"type":"del","del":true,"ln":103,"content":"-"},{"type":"del","del":true,"ln":104,"content":"-  JSContext* cx = (JSContext*) aContext->GetNativeContext();"},{"type":"del","del":true,"ln":105,"content":"-  NS_ASSERTION(aScriptObject, \"uh-oh, script Object should NOT be null or bad things will happen\");"},{"type":"del","del":true,"ln":106,"content":"-  if (!aScriptObject)"},{"type":"del","del":true,"ln":107,"content":"-    return NS_ERROR_FAILURE;"},{"type":"add","add":true,"ln":99,"content":"+  NS_PRECONDITION(aBoundNode,"},{"type":"add","add":true,"ln":100,"content":"+                  \"uh-oh, bound node should NOT be null or bad things will \""},{"type":"add","add":true,"ln":101,"content":"+                  \"happen\");"},{"type":"normal","normal":true,"ln1":108,"ln2":102,"content":" "},{"type":"del","del":true,"ln":109,"content":"-  nsCAutoString bindingURI(aClassStr);"},{"type":"del","del":true,"ln":110,"content":"-  PRInt32 hash = bindingURI.RFindChar('#');"},{"type":"del","del":true,"ln":111,"content":"-  if (hash != kNotFound)"},{"type":"del","del":true,"ln":112,"content":"-    bindingURI.Truncate(hash);"},{"type":"del","del":true,"ln":113,"content":"-  "},{"type":"del","del":true,"ln":114,"content":"-  // compile the literal string "},{"type":"del","del":true,"ln":115,"content":"-  jsval result = JSVAL_NULL;"},{"type":"add","add":true,"ln":103,"content":"+  jsval result = JSVAL_VOID;"},{"type":"normal","normal":true,"ln1":116,"ln2":104,"content":"   "},{"type":"normal","normal":true,"ln1":117,"ln2":105,"content":"   // EvaluateStringWithValue and JS_DefineUCProperty can both trigger GC, so"},{"type":"normal","normal":true,"ln1":118,"ln2":106,"content":"   // protect |result| here."}],"oldStart":92,"oldLines":27,"newStart":92,"newLines":15},{"content":"@@ -120,39 +108,40 @@ nsXBLProtoImplField::InstallMember(nsIScriptContext* aContext,","changes":[{"type":"normal","normal":true,"ln1":120,"ln2":108,"content":"   nsAutoGCRoot root(&result, &rv);"},{"type":"normal","normal":true,"ln1":121,"ln2":109,"content":"   if (NS_FAILED(rv))"},{"type":"normal","normal":true,"ln1":122,"ln2":110,"content":"     return rv;"},{"type":"del","del":true,"ln":123,"content":"-  PRBool undefined;"},{"type":"del","del":true,"ln":124,"content":"-  // XXX Need a URI here!"},{"type":"del","del":true,"ln":125,"content":"-  nsCOMPtr<nsIScriptContext> context = aContext;"},{"type":"del","del":true,"ln":126,"content":"-  rv = context->EvaluateStringWithValue(nsDependentString(mFieldText,"},{"type":"del","del":true,"ln":127,"content":"-                                                          mFieldTextLength), "},{"type":"del","del":true,"ln":128,"content":"-                                        aScriptObject,"},{"type":"del","del":true,"ln":129,"content":"-                                        nsnull, bindingURI.get(),"},{"type":"del","del":true,"ln":130,"content":"-                                        mLineNumber, nsnull,"},{"type":"del","del":true,"ln":131,"content":"-                                        (void*) &result, &undefined);"},{"type":"del","del":true,"ln":132,"content":"-  if (NS_FAILED(rv))"},{"type":"del","del":true,"ln":133,"content":"-    return rv;"},{"type":"normal","normal":true,"ln1":134,"ln2":111,"content":" "},{"type":"del","del":true,"ln":135,"content":"-  if (!undefined) {"},{"type":"del","del":true,"ln":136,"content":"-    // Define the evaluated result as a JS property"},{"type":"del","del":true,"ln":137,"content":"-    nsDependentString name(mName);"},{"type":"del","del":true,"ln":138,"content":"-    JSAutoRequest ar(cx);"},{"type":"del","del":true,"ln":139,"content":"-    if (!::JS_DefineUCProperty(cx, static_cast<JSObject *>(aScriptObject),"},{"type":"del","del":true,"ln":140,"content":"-                               reinterpret_cast<const jschar*>(mName), "},{"type":"del","del":true,"ln":141,"content":"-                               name.Length(), result, nsnull, nsnull, mJSAttributes))"},{"type":"del","del":true,"ln":142,"content":"-      return NS_ERROR_OUT_OF_MEMORY;"},{"type":"del","del":true,"ln":143,"content":"-  }"},{"type":"add","add":true,"ln":112,"content":"+  if (mFieldTextLength != 0) {"},{"type":"add","add":true,"ln":113,"content":"+    nsCAutoString uriSpec;"},{"type":"add","add":true,"ln":114,"content":"+    aBindingDocURI->GetSpec(uriSpec);"},{"type":"normal","normal":true,"ln1":144,"ln2":115,"content":"   "},{"type":"del","del":true,"ln":145,"content":"-  return NS_OK;"},{"type":"del","del":true,"ln":146,"content":"-}"},{"type":"add","add":true,"ln":116,"content":"+    // compile the literal string"},{"type":"add","add":true,"ln":117,"content":"+    // XXX Could we produce a better principal here?  Should be able"},{"type":"add","add":true,"ln":118,"content":"+    // to, really!"},{"type":"add","add":true,"ln":119,"content":"+    PRBool undefined;"},{"type":"add","add":true,"ln":120,"content":"+    nsCOMPtr<nsIScriptContext> context = aContext;"},{"type":"add","add":true,"ln":121,"content":"+    rv = context->EvaluateStringWithValue(nsDependentString(mFieldText,"},{"type":"add","add":true,"ln":122,"content":"+                                                            mFieldTextLength), "},{"type":"add","add":true,"ln":123,"content":"+                                          aBoundNode,"},{"type":"add","add":true,"ln":124,"content":"+                                          nsnull, uriSpec.get(),"},{"type":"add","add":true,"ln":125,"content":"+                                          mLineNumber, nsnull,"},{"type":"add","add":true,"ln":126,"content":"+                                          (void*) &result, &undefined);"},{"type":"add","add":true,"ln":127,"content":"+    if (NS_FAILED(rv))"},{"type":"add","add":true,"ln":128,"content":"+      return rv;"},{"type":"normal","normal":true,"ln1":147,"ln2":129,"content":" "},{"type":"del","del":true,"ln":148,"content":"-nsresult "},{"type":"del","del":true,"ln":149,"content":"-nsXBLProtoImplField::CompileMember(nsIScriptContext* aContext, const nsCString& aClassStr,"},{"type":"del","del":true,"ln":150,"content":"-                                   void* aClassObject)"},{"type":"del","del":true,"ln":151,"content":"-{"},{"type":"del","del":true,"ln":152,"content":"-  return NS_OK;"},{"type":"del","del":true,"ln":153,"content":"-}"},{"type":"add","add":true,"ln":130,"content":"+    if (undefined) {"},{"type":"add","add":true,"ln":131,"content":"+      result = JSVAL_VOID;"},{"type":"add","add":true,"ln":132,"content":"+    }"},{"type":"add","add":true,"ln":133,"content":"+  }"},{"type":"normal","normal":true,"ln1":154,"ln2":134,"content":" "},{"type":"del","del":true,"ln":155,"content":"-void"},{"type":"del","del":true,"ln":156,"content":"-nsXBLProtoImplField::Traverse(nsCycleCollectionTraversalCallback &cb) const"},{"type":"del","del":true,"ln":157,"content":"-{"},{"type":"add","add":true,"ln":135,"content":"+  // Define the evaluated result as a JS property"},{"type":"add","add":true,"ln":136,"content":"+  nsDependentString name(mName);"},{"type":"add","add":true,"ln":137,"content":"+  JSContext* cx = (JSContext*) aContext->GetNativeContext();"},{"type":"add","add":true,"ln":138,"content":"+  JSAutoRequest ar(cx);"},{"type":"add","add":true,"ln":139,"content":"+  if (!::JS_DefineUCProperty(cx, aBoundNode,"},{"type":"add","add":true,"ln":140,"content":"+                             reinterpret_cast<const jschar*>(mName), "},{"type":"add","add":true,"ln":141,"content":"+                             name.Length(), result, nsnull, nsnull,"},{"type":"add","add":true,"ln":142,"content":"+                             mJSAttributes)) {"},{"type":"add","add":true,"ln":143,"content":"+    return NS_ERROR_OUT_OF_MEMORY;"},{"type":"add","add":true,"ln":144,"content":"+  }"},{"type":"add","add":true,"ln":145,"content":"+  "},{"type":"add","add":true,"ln":146,"content":"+  return NS_OK;"},{"type":"normal","normal":true,"ln1":158,"ln2":147,"content":" }"}],"oldStart":120,"oldLines":39,"newStart":108,"newLines":40}],"deletions":56,"additions":45,"from":"content/xbl/src/nsXBLProtoImplField.cpp","to":"content/xbl/src/nsXBLProtoImplField.cpp","index":["4c7480a..cf129df","100644"]},{"chunks":[{"content":"@@ -46,30 +46,31 @@","changes":[{"type":"normal","normal":true,"ln1":46,"ln2":46,"content":" #include \"nsString.h\""},{"type":"normal","normal":true,"ln1":47,"ln2":47,"content":" #include \"nsXBLProtoImplMember.h\""},{"type":"normal","normal":true,"ln1":48,"ln2":48,"content":" "},{"type":"del","del":true,"ln":49,"content":"-class nsXBLProtoImplField: public nsXBLProtoImplMember"},{"type":"add","add":true,"ln":49,"content":"+class nsIURI;"},{"type":"add","add":true,"ln":50,"content":"+"},{"type":"add","add":true,"ln":51,"content":"+class nsXBLProtoImplField"},{"type":"normal","normal":true,"ln1":50,"ln2":52,"content":" {"},{"type":"normal","normal":true,"ln1":51,"ln2":53,"content":" public:"},{"type":"normal","normal":true,"ln1":52,"ln2":54,"content":"   nsXBLProtoImplField(const PRUnichar* aName, const PRUnichar* aReadOnly);"},{"type":"del","del":true,"ln":53,"content":"-  virtual ~nsXBLProtoImplField();"},{"type":"del","del":true,"ln":54,"content":"-  virtual void Destroy(PRBool aIsCompiled);"},{"type":"add","add":true,"ln":55,"content":"+  ~nsXBLProtoImplField();"},{"type":"normal","normal":true,"ln1":55,"ln2":56,"content":" "},{"type":"normal","normal":true,"ln1":56,"ln2":57,"content":"   void AppendFieldText(const nsAString& aText);"},{"type":"normal","normal":true,"ln1":57,"ln2":58,"content":"   void SetLineNumber(PRUint32 aLineNumber) {"},{"type":"normal","normal":true,"ln1":58,"ln2":59,"content":"     mLineNumber = aLineNumber;"},{"type":"normal","normal":true,"ln1":59,"ln2":60,"content":"   }"},{"type":"normal","normal":true,"ln1":60,"ln2":61,"content":"   "},{"type":"del","del":true,"ln":61,"content":"-  virtual nsresult InstallMember(nsIScriptContext* aContext,"},{"type":"del","del":true,"ln":62,"content":"-                                 nsIContent* aBoundElement, "},{"type":"del","del":true,"ln":63,"content":"-                                 void* aScriptObject,"},{"type":"del","del":true,"ln":64,"content":"-                                 void* aTargetClassObject,"},{"type":"del","del":true,"ln":65,"content":"-                                 const nsCString& aClassStr);"},{"type":"del","del":true,"ln":66,"content":"-  virtual nsresult CompileMember(nsIScriptContext* aContext,"},{"type":"del","del":true,"ln":67,"content":"-                                 const nsCString& aClassStr,"},{"type":"del","del":true,"ln":68,"content":"-                                 void* aClassObject);"},{"type":"add","add":true,"ln":62,"content":"+  nsXBLProtoImplField* GetNext() const { return mNext; }"},{"type":"add","add":true,"ln":63,"content":"+  void SetNext(nsXBLProtoImplField* aNext) { mNext = aNext; }"},{"type":"add","add":true,"ln":64,"content":"+"},{"type":"add","add":true,"ln":65,"content":"+  nsresult InstallField(nsIScriptContext* aContext,"},{"type":"add","add":true,"ln":66,"content":"+                        JSObject* aBoundNode, nsIURI*"},{"type":"add","add":true,"ln":67,"content":"+                        aBindingDocURI) const;"},{"type":"normal","normal":true,"ln1":69,"ln2":68,"content":" "},{"type":"del","del":true,"ln":70,"content":"-  virtual void Traverse(nsCycleCollectionTraversalCallback &cb) const;"},{"type":"add","add":true,"ln":69,"content":"+  const PRUnichar* GetName() const { return mName; }"},{"type":"normal","normal":true,"ln1":71,"ln2":70,"content":" "},{"type":"normal","normal":true,"ln1":72,"ln2":71,"content":" protected:"},{"type":"add","add":true,"ln":72,"content":"+  nsXBLProtoImplField* mNext;"},{"type":"add","add":true,"ln":73,"content":"+  PRUnichar* mName;"},{"type":"normal","normal":true,"ln1":73,"ln2":74,"content":"   PRUnichar* mFieldText;"},{"type":"normal","normal":true,"ln1":74,"ln2":75,"content":"   PRUint32 mFieldTextLength;"},{"type":"normal","normal":true,"ln1":75,"ln2":76,"content":"   PRUint32 mLineNumber;"}],"oldStart":46,"oldLines":30,"newStart":46,"newLines":31}],"deletions":12,"additions":13,"from":"content/xbl/src/nsXBLProtoImplField.h","to":"content/xbl/src/nsXBLProtoImplField.h","index":["06758e2..8c1d582","100644"]},{"chunks":[{"content":"@@ -366,6 +366,25 @@ nsXBLPrototypeBinding::Traverse(nsCycleCollectionTraversalCallback &cb) const","changes":[{"type":"normal","normal":true,"ln1":366,"ln2":366,"content":" }"},{"type":"normal","normal":true,"ln1":367,"ln2":367,"content":" "},{"type":"normal","normal":true,"ln1":368,"ln2":368,"content":" void"},{"type":"add","add":true,"ln":369,"content":"+nsXBLPrototypeBinding::Unlink()"},{"type":"add","add":true,"ln":370,"content":"+{"},{"type":"add","add":true,"ln":371,"content":"+  mBinding = nsnull;"},{"type":"add","add":true,"ln":372,"content":"+  if (mImplementation)"},{"type":"add","add":true,"ln":373,"content":"+    mImplementation->Unlink();"},{"type":"add","add":true,"ln":374,"content":"+  if (mResources)"},{"type":"add","add":true,"ln":375,"content":"+    NS_IF_RELEASE(mResources->mLoader);"},{"type":"add","add":true,"ln":376,"content":"+"},{"type":"add","add":true,"ln":377,"content":"+  // I'm not sure whether it would be safer to just nuke the tables or to"},{"type":"add","add":true,"ln":378,"content":"+  // traverse them with unlinking functions...  or whether we even need to"},{"type":"add","add":true,"ln":379,"content":"+  // unlink them.  I think we need to at least clean up mInsertionPointTable"},{"type":"add","add":true,"ln":380,"content":"+  // becase it can hold strong refs to nodes in the binding document."},{"type":"add","add":true,"ln":381,"content":"+  delete mInsertionPointTable;"},{"type":"add","add":true,"ln":382,"content":"+  mInsertionPointTable = nsnull;"},{"type":"add","add":true,"ln":383,"content":"+  delete mInterfaceTable;"},{"type":"add","add":true,"ln":384,"content":"+  mInterfaceTable = nsnull;"},{"type":"add","add":true,"ln":385,"content":"+}"},{"type":"add","add":true,"ln":386,"content":"+"},{"type":"add","add":true,"ln":387,"content":"+void"},{"type":"normal","normal":true,"ln1":369,"ln2":388,"content":" nsXBLPrototypeBinding::Initialize()"},{"type":"normal","normal":true,"ln1":370,"ln2":389,"content":" {"},{"type":"normal","normal":true,"ln1":371,"ln2":390,"content":"   nsIContent* content = GetImmediateChild(nsGkAtoms::content);"}],"oldStart":366,"oldLines":6,"newStart":366,"newLines":25},{"content":"@@ -822,7 +841,7 @@ nsXBLPrototypeBinding::InitClass(const nsCString& aClassName,","changes":[{"type":"normal","normal":true,"ln1":822,"ln2":841,"content":"   *aClassObject = nsnull;"},{"type":"normal","normal":true,"ln1":823,"ln2":842,"content":" "},{"type":"normal","normal":true,"ln1":824,"ln2":843,"content":"   return nsXBLBinding::DoInitJSClass(aContext, aGlobal, aScriptObject,"},{"type":"del","del":true,"ln":825,"content":"-                                     aClassName, aClassObject);"},{"type":"add","add":true,"ln":844,"content":"+                                     aClassName, this, aClassObject);"},{"type":"normal","normal":true,"ln1":826,"ln2":845,"content":" }"},{"type":"normal","normal":true,"ln1":827,"ln2":846,"content":" "},{"type":"normal","normal":true,"ln1":828,"ln2":847,"content":" nsIContent*"}],"oldStart":822,"oldLines":7,"newStart":841,"newLines":7}],"deletions":1,"additions":20,"from":"content/xbl/src/nsXBLPrototypeBinding.cpp","to":"content/xbl/src/nsXBLPrototypeBinding.cpp","index":["24f6205..f41c948","100644"]},{"chunks":[{"content":"@@ -50,6 +50,7 @@","changes":[{"type":"normal","normal":true,"ln1":50,"ln2":50,"content":" #include \"nsHashtable.h\""},{"type":"normal","normal":true,"ln1":51,"ln2":51,"content":" #include \"nsIXBLDocumentInfo.h\""},{"type":"normal","normal":true,"ln1":52,"ln2":52,"content":" #include \"nsCOMArray.h\""},{"type":"add","add":true,"ln":53,"content":"+#include \"nsXBLProtoImpl.h\""},{"type":"normal","normal":true,"ln1":53,"ln2":54,"content":" "},{"type":"normal","normal":true,"ln1":54,"ln2":55,"content":" class nsIAtom;"},{"type":"normal","normal":true,"ln1":55,"ln2":56,"content":" class nsIDocument;"}],"oldStart":50,"oldLines":6,"newStart":50,"newLines":7},{"content":"@@ -58,7 +59,7 @@ class nsISupportsArray;","changes":[{"type":"normal","normal":true,"ln1":58,"ln2":59,"content":" class nsSupportsHashtable;"},{"type":"normal","normal":true,"ln1":59,"ln2":60,"content":" class nsIXBLService;"},{"type":"normal","normal":true,"ln1":60,"ln2":61,"content":" class nsFixedSizeAllocator;"},{"type":"del","del":true,"ln":61,"content":"-class nsXBLProtoImpl;"},{"type":"add","add":true,"ln":62,"content":"+class nsXBLProtoImplField;"},{"type":"normal","normal":true,"ln1":62,"ln2":63,"content":" class nsXBLBinding;"},{"type":"normal","normal":true,"ln1":63,"ln2":64,"content":" "},{"type":"normal","normal":true,"ln1":64,"ln2":65,"content":" // *********************************************************************/"}],"oldStart":58,"oldLines":7,"newStart":59,"newLines":7},{"content":"@@ -94,6 +95,22 @@ public:","changes":[{"type":"normal","normal":true,"ln1":94,"ln2":95,"content":"   nsXBLProtoImplAnonymousMethod* GetDestructor();"},{"type":"normal","normal":true,"ln1":95,"ln2":96,"content":"   nsresult SetDestructor(nsXBLProtoImplAnonymousMethod* aDestructor);"},{"type":"normal","normal":true,"ln1":96,"ln2":97,"content":" "},{"type":"add","add":true,"ln":98,"content":"+  nsXBLProtoImplField* FindField(const nsString& aFieldName) const"},{"type":"add","add":true,"ln":99,"content":"+  {"},{"type":"add","add":true,"ln":100,"content":"+    return mImplementation ? mImplementation->FindField(aFieldName) : nsnull;"},{"type":"add","add":true,"ln":101,"content":"+  }"},{"type":"add","add":true,"ln":102,"content":"+"},{"type":"add","add":true,"ln":103,"content":"+  // Resolve all the fields for this binding on the object |obj|."},{"type":"add","add":true,"ln":104,"content":"+  // False return means a JS exception was set."},{"type":"add","add":true,"ln":105,"content":"+  PRBool ResolveAllFields(JSContext* cx, JSObject* obj) const"},{"type":"add","add":true,"ln":106,"content":"+  {"},{"type":"add","add":true,"ln":107,"content":"+    return !mImplementation || mImplementation->ResolveAllFields(cx, obj);"},{"type":"add","add":true,"ln":108,"content":"+  }"},{"type":"add","add":true,"ln":109,"content":"+"},{"type":"add","add":true,"ln":110,"content":"+  const nsCString& ClassName() const {"},{"type":"add","add":true,"ln":111,"content":"+    return mImplementation ? mImplementation->mClassName : EmptyCString();"},{"type":"add","add":true,"ln":112,"content":"+  }"},{"type":"add","add":true,"ln":113,"content":"+"},{"type":"normal","normal":true,"ln1":97,"ln2":114,"content":"   nsresult InitClass(const nsCString& aClassName, JSContext * aContext,"},{"type":"normal","normal":true,"ln1":98,"ln2":115,"content":"                      JSObject * aGlobal, JSObject * aScriptObject,"},{"type":"normal","normal":true,"ln1":99,"ln2":116,"content":"                      void ** aClassObject);"}],"oldStart":94,"oldLines":6,"newStart":95,"newLines":22},{"content":"@@ -172,6 +189,7 @@ public:","changes":[{"type":"normal","normal":true,"ln1":172,"ln2":189,"content":"                 nsIContent* aElement);"},{"type":"normal","normal":true,"ln1":173,"ln2":190,"content":" "},{"type":"normal","normal":true,"ln1":174,"ln2":191,"content":"   void Traverse(nsCycleCollectionTraversalCallback &cb) const;"},{"type":"add","add":true,"ln":192,"content":"+  void Unlink();"},{"type":"normal","normal":true,"ln1":175,"ln2":193,"content":" "},{"type":"normal","normal":true,"ln1":176,"ln2":194,"content":" // Static members"},{"type":"normal","normal":true,"ln1":177,"ln2":195,"content":"   static PRUint32 gRefCnt;"}],"oldStart":172,"oldLines":6,"newStart":189,"newLines":7}],"deletions":1,"additions":19,"from":"content/xbl/src/nsXBLPrototypeBinding.h","to":"content/xbl/src/nsXBLPrototypeBinding.h","index":["ee6e770..3e21c34a","100644"]},{"chunks":[{"content":"@@ -60,7 +60,9 @@","changes":[{"type":"normal","normal":true,"ln1":60,"ln2":60,"content":" #include \"nsContentUtils.h\""},{"type":"normal","normal":true,"ln1":61,"ln2":61,"content":" "},{"type":"normal","normal":true,"ln1":62,"ln2":62,"content":" NS_IMPL_CYCLE_COLLECTION_CLASS(nsXBLResourceLoader)"},{"type":"del","del":true,"ln":63,"content":"-NS_IMPL_CYCLE_COLLECTION_UNLINK_0(nsXBLResourceLoader)"},{"type":"add","add":true,"ln":63,"content":"+NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(nsXBLResourceLoader)"},{"type":"add","add":true,"ln":64,"content":"+NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMARRAY(mBoundElements)"},{"type":"add","add":true,"ln":65,"content":"+NS_IMPL_CYCLE_COLLECTION_UNLINK_END"},{"type":"normal","normal":true,"ln1":64,"ln2":66,"content":" NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN(nsXBLResourceLoader)"},{"type":"normal","normal":true,"ln1":65,"ln2":67,"content":" NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMARRAY(mBoundElements)"},{"type":"normal","normal":true,"ln1":66,"ln2":68,"content":" NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END"}],"oldStart":60,"oldLines":7,"newStart":60,"newLines":9}],"deletions":1,"additions":3,"from":"content/xbl/src/nsXBLResourceLoader.cpp","to":"content/xbl/src/nsXBLResourceLoader.cpp","index":["26766c7..b349a56","100644"]},{"chunks":[{"content":"@@ -50,6 +50,7 @@ _TEST_FILES =\t\\","changes":[{"type":"normal","normal":true,"ln1":50,"ln2":50,"content":" \t\ttest_bug296375.xul \\"},{"type":"normal","normal":true,"ln1":51,"ln2":51,"content":" \t\ttest_bug366770.html \\"},{"type":"normal","normal":true,"ln1":52,"ln2":52,"content":" \t\ttest_bug371724.xhtml \\"},{"type":"add","add":true,"ln":53,"content":"+\t\ttest_bug372769.xhtml \\"},{"type":"normal","normal":true,"ln1":53,"ln2":54,"content":" \t\t$(NULL)"},{"type":"normal","normal":true,"ln1":54,"ln2":55,"content":" "},{"type":"normal","normal":true,"ln1":55,"ln2":56,"content":" libs:: $(_TEST_FILES)"}],"oldStart":50,"oldLines":6,"newStart":50,"newLines":7}],"deletions":0,"additions":1,"from":"content/xbl/test/Makefile.in","to":"content/xbl/test/Makefile.in","index":["029ec10..26db993","100644"]},{"chunks":[{"content":"@@ -477,7 +477,8 @@ static const char kDOMStringBundleURL[] =","changes":[{"type":"normal","normal":true,"ln1":477,"ln2":477,"content":" // possible."},{"type":"normal","normal":true,"ln1":478,"ln2":478,"content":" "},{"type":"normal","normal":true,"ln1":479,"ln2":479,"content":" #define ELEMENT_SCRIPTABLE_FLAGS                                              \\"},{"type":"del","del":true,"ln":480,"content":"-  (NODE_SCRIPTABLE_FLAGS & ~nsIXPCScriptable::CLASSINFO_INTERFACES_ONLY)"},{"type":"add","add":true,"ln":480,"content":"+  ((NODE_SCRIPTABLE_FLAGS & ~nsIXPCScriptable::CLASSINFO_INTERFACES_ONLY) |   \\"},{"type":"add","add":true,"ln":481,"content":"+   nsIXPCScriptable::WANT_ENUMERATE)"},{"type":"normal","normal":true,"ln1":481,"ln2":482,"content":" "},{"type":"normal","normal":true,"ln1":482,"ln2":483,"content":" #define EXTERNAL_OBJ_SCRIPTABLE_FLAGS                                         \\"},{"type":"normal","normal":true,"ln1":483,"ln2":484,"content":"   (ELEMENT_SCRIPTABLE_FLAGS & ~nsIXPCScriptable::USE_JSSTUB_FOR_SETPROPERTY | \\"}],"oldStart":477,"oldLines":7,"newStart":477,"newLines":8},{"content":"@@ -6940,6 +6941,32 @@ nsElementSH::PostCreate(nsIXPConnectWrappedNative *wrapper, JSContext *cx,","changes":[{"type":"normal","normal":true,"ln1":6940,"ln2":6941,"content":"   return NS_OK;"},{"type":"normal","normal":true,"ln1":6941,"ln2":6942,"content":" }"},{"type":"normal","normal":true,"ln1":6942,"ln2":6943,"content":" "},{"type":"add","add":true,"ln":6944,"content":"+NS_IMETHODIMP"},{"type":"add","add":true,"ln":6945,"content":"+nsElementSH::Enumerate(nsIXPConnectWrappedNative *wrapper, JSContext *cx,"},{"type":"add","add":true,"ln":6946,"content":"+                       JSObject *obj, PRBool *_retval)"},{"type":"add","add":true,"ln":6947,"content":"+{"},{"type":"add","add":true,"ln":6948,"content":"+  // Make sure to not call the superclass here!"},{"type":"add","add":true,"ln":6949,"content":"+  nsCOMPtr<nsIContent> content(do_QueryWrappedNative(wrapper));"},{"type":"add","add":true,"ln":6950,"content":"+  NS_ENSURE_TRUE(content, NS_ERROR_UNEXPECTED);"},{"type":"add","add":true,"ln":6951,"content":"+"},{"type":"add","add":true,"ln":6952,"content":"+  nsIDocument* doc = content->GetOwnerDoc();"},{"type":"add","add":true,"ln":6953,"content":"+  if (!doc) {"},{"type":"add","add":true,"ln":6954,"content":"+    // Nothing else to do here"},{"type":"add","add":true,"ln":6955,"content":"+    return NS_OK;"},{"type":"add","add":true,"ln":6956,"content":"+  }"},{"type":"add","add":true,"ln":6957,"content":"+"},{"type":"add","add":true,"ln":6958,"content":"+  nsXBLBinding* binding = doc->BindingManager()->GetBinding(content);"},{"type":"add","add":true,"ln":6959,"content":"+  if (!binding) {"},{"type":"add","add":true,"ln":6960,"content":"+    // Nothing else to do here"},{"type":"add","add":true,"ln":6961,"content":"+    return NS_OK;"},{"type":"add","add":true,"ln":6962,"content":"+  }"},{"type":"add","add":true,"ln":6963,"content":"+"},{"type":"add","add":true,"ln":6964,"content":"+  *_retval = binding->ResolveAllFields(cx, obj);"},{"type":"add","add":true,"ln":6965,"content":"+  "},{"type":"add","add":true,"ln":6966,"content":"+  return NS_OK;"},{"type":"add","add":true,"ln":6967,"content":"+}"},{"type":"add","add":true,"ln":6968,"content":"+  "},{"type":"add","add":true,"ln":6969,"content":"+"},{"type":"normal","normal":true,"ln1":6943,"ln2":6970,"content":" // Generic array scriptable helper."},{"type":"normal","normal":true,"ln1":6944,"ln2":6971,"content":" "},{"type":"normal","normal":true,"ln1":6945,"ln2":6972,"content":" NS_IMETHODIMP"}],"oldStart":6940,"oldLines":6,"newStart":6941,"newLines":32}],"deletions":1,"additions":28,"from":"dom/src/base/nsDOMClassInfo.cpp","to":"dom/src/base/nsDOMClassInfo.cpp","index":["5c18513..0ff7b6a","100644"]},{"chunks":[{"content":"@@ -563,6 +563,8 @@ protected:","changes":[{"type":"normal","normal":true,"ln1":563,"ln2":563,"content":" public:"},{"type":"normal","normal":true,"ln1":564,"ln2":564,"content":"   NS_IMETHOD PostCreate(nsIXPConnectWrappedNative *wrapper, JSContext *cx,"},{"type":"normal","normal":true,"ln1":565,"ln2":565,"content":"                         JSObject *obj);"},{"type":"add","add":true,"ln":566,"content":"+  NS_IMETHOD Enumerate(nsIXPConnectWrappedNative *wrapper, JSContext *cx,"},{"type":"add","add":true,"ln":567,"content":"+                       JSObject *obj, PRBool *_retval);"},{"type":"normal","normal":true,"ln1":566,"ln2":568,"content":" "},{"type":"normal","normal":true,"ln1":567,"ln2":569,"content":"   static nsIClassInfo *doCreate(nsDOMClassInfoData* aData)"},{"type":"normal","normal":true,"ln1":568,"ln2":570,"content":"   {"}],"oldStart":563,"oldLines":6,"newStart":563,"newLines":8}],"deletions":0,"additions":2,"from":"dom/src/base/nsDOMClassInfo.h","to":"dom/src/base/nsDOMClassInfo.h","index":["da0f838..34bbc96","100644"]}]}