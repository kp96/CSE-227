# HG changeset patch
# Parent d6c46ca4793a44a54c72504d1bb0d4a81efa0478
# User timeless@mozdev.org
Bug 557893 ProcessRDN leaks decodeItem on failure
r=kaie

diff --git a/security/manager/ssl/src/nsNSSCertHelper.cpp b/security/manager/ssl/src/nsNSSCertHelper.cpp
--- a/security/manager/ssl/src/nsNSSCertHelper.cpp
+++ b/security/manager/ssl/src/nsNSSCertHelper.cpp
@@ -937,16 +937,20 @@ ProcessRDN(CERTRDN* rdn, nsAString &fina
     PRIntn escapedValueCapacity = decodeItem->len * 3 + 3;
     nsAutoArrayPtr<char> escapedValue;
     escapedValue = new char[escapedValueCapacity];
-    if (!escapedValue)
+    if (!escapedValue) {
+      SECITEM_FreeItem(decodeItem, PR_TRUE);
       return NS_ERROR_OUT_OF_MEMORY;
+    }
 
     SECStatus status = CERT_RFC1485_EscapeAndQuote(
           escapedValue.get(),
           escapedValueCapacity, 
           (char*)decodeItem->data, 
           decodeItem->len);
-    if (SECSuccess != status)
+    if (SECSuccess != status) {
+      SECITEM_FreeItem(decodeItem, PR_TRUE);
       return NS_ERROR_FAILURE;
+    }
 
     avavalue = NS_ConvertUTF8toUTF16(escapedValue);
     
