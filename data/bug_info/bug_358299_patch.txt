Index: Camino.xcodeproj/project.pbxproj
===================================================================
RCS file: /cvsroot/mozilla/camino/Camino.xcodeproj/project.pbxproj,v
retrieving revision 1.92
diff -u -8 -r1.92 project.pbxproj
--- Camino.xcodeproj/project.pbxproj	27 Jan 2009 04:33:10 -0000	1.92
+++ Camino.xcodeproj/project.pbxproj	29 Jan 2009 03:50:38 -0000
@@ -990,16 +990,28 @@
 		C713F0900E9AF7DB002313B3 /* CHSlidingViewAnimation.m in Sources */ = {isa = PBXBuildFile; fileRef = C713F08E0E9AF7DB002313B3 /* CHSlidingViewAnimation.m */; };
 		C713F0910E9AF7DB002313B3 /* CHSlidingViewAnimation.m in Sources */ = {isa = PBXBuildFile; fileRef = C713F08E0E9AF7DB002313B3 /* CHSlidingViewAnimation.m */; };
 		C79573880D35314D0028A773 /* XMLSearchPluginParser.mm in Sources */ = {isa = PBXBuildFile; fileRef = C79573840D35314D0028A773 /* XMLSearchPluginParser.mm */; };
 		C795738A0D35314D0028A773 /* OpenSearchParser.mm in Sources */ = {isa = PBXBuildFile; fileRef = C79573860D35314D0028A773 /* OpenSearchParser.mm */; };
 		C795738C0D35314D0028A773 /* XMLSearchPluginParser.mm in Sources */ = {isa = PBXBuildFile; fileRef = C79573840D35314D0028A773 /* XMLSearchPluginParser.mm */; };
 		C795738E0D35314D0028A773 /* OpenSearchParser.mm in Sources */ = {isa = PBXBuildFile; fileRef = C79573860D35314D0028A773 /* OpenSearchParser.mm */; };
 		C7AB1EA00EEC5FEB0053A08A /* NSTextView+Utils.m in Sources */ = {isa = PBXBuildFile; fileRef = C7AB1E9E0EEC5FEB0053A08A /* NSTextView+Utils.m */; };
 		C7AB1EA10EEC5FEB0053A08A /* NSTextView+Utils.m in Sources */ = {isa = PBXBuildFile; fileRef = C7AB1E9E0EEC5FEB0053A08A /* NSTextView+Utils.m */; };
+		C7DE8DD70F30CFAC00CD3872 /* SafeBrowsingListManager.mm in Sources */ = {isa = PBXBuildFile; fileRef = C7DE8DD30F30CFAC00CD3872 /* SafeBrowsingListManager.mm */; };
+		C7DE8DD80F30CFAC00CD3872 /* SafeBrowsingAboutModule.mm in Sources */ = {isa = PBXBuildFile; fileRef = C7DE8DD50F30CFAC00CD3872 /* SafeBrowsingAboutModule.mm */; };
+		C7DE8DD90F30CFAC00CD3872 /* SafeBrowsingListManager.mm in Sources */ = {isa = PBXBuildFile; fileRef = C7DE8DD30F30CFAC00CD3872 /* SafeBrowsingListManager.mm */; };
+		C7DE8DDA0F30CFAC00CD3872 /* SafeBrowsingAboutModule.mm in Sources */ = {isa = PBXBuildFile; fileRef = C7DE8DD50F30CFAC00CD3872 /* SafeBrowsingAboutModule.mm */; };
+		C7DE8E2D0F30D27300CD3872 /* libcaminosafebrowsing.dylib in Frameworks */ = {isa = PBXBuildFile; fileRef = C7DE8E2B0F30D27300CD3872 /* libcaminosafebrowsing.dylib */; };
+		C7DE8E2F0F30D2AD00CD3872 /* libcaminosafebrowsing.dylib in Copy Component Libraries */ = {isa = PBXBuildFile; fileRef = C7DE8E2B0F30D27300CD3872 /* libcaminosafebrowsing.dylib */; };
+		C7DE8E300F30D2C100CD3872 /* nsUrlClassifierListManager.js in Copy Component Libraries */ = {isa = PBXBuildFile; fileRef = C7DE8E150F30D14F00CD3872 /* nsUrlClassifierListManager.js */; };
+		C7DE8E310F30D2C100CD3872 /* nsUrlClassifierLib.js in Copy Component Libraries */ = {isa = PBXBuildFile; fileRef = C7DE8E160F30D14F00CD3872 /* nsUrlClassifierLib.js */; };
+		C7DE8E420F30D2FF00CD3872 /* url-classifier.xpt in Copy Component XPTs */ = {isa = PBXBuildFile; fileRef = C7DE8E260F30D1BC00CD3872 /* url-classifier.xpt */; };
+		C7DE8E430F30D32700CD3872 /* url-classifier.xpt in Copy Component XPTs */ = {isa = PBXBuildFile; fileRef = C7DE8E260F30D1BC00CD3872 /* url-classifier.xpt */; };
+		C7DE8E4B0F30D41500CD3872 /* nsUrlClassifierListManager.js in Copy Component Libraries */ = {isa = PBXBuildFile; fileRef = C7DE8E150F30D14F00CD3872 /* nsUrlClassifierListManager.js */; };
+		C7DE8E4C0F30D41500CD3872 /* nsUrlClassifierLib.js in Copy Component Libraries */ = {isa = PBXBuildFile; fileRef = C7DE8E160F30D14F00CD3872 /* nsUrlClassifierLib.js */; };
 		C7FF536C0D35281F00194776 /* search_editor_bottom_background.png in Resources */ = {isa = PBXBuildFile; fileRef = C7FF536A0D35281F00194776 /* search_editor_bottom_background.png */; };
 		C7FF536D0D35281F00194776 /* search_editor_action.png in Resources */ = {isa = PBXBuildFile; fileRef = C7FF536B0D35281F00194776 /* search_editor_action.png */; };
 		C7FF536E0D35281F00194776 /* search_editor_bottom_background.png in Resources */ = {isa = PBXBuildFile; fileRef = C7FF536A0D35281F00194776 /* search_editor_bottom_background.png */; };
 		C7FF536F0D35281F00194776 /* search_editor_action.png in Resources */ = {isa = PBXBuildFile; fileRef = C7FF536B0D35281F00194776 /* search_editor_action.png */; };
 		C7FF53720D35285400194776 /* SearchEngineEditor.nib in Resources */ = {isa = PBXBuildFile; fileRef = C7FF53700D35285400194776 /* SearchEngineEditor.nib */; };
 		C7FF53730D35285400194776 /* SearchEngineEditor.nib in Resources */ = {isa = PBXBuildFile; fileRef = C7FF53700D35285400194776 /* SearchEngineEditor.nib */; };
 		C7FF53760D35286800194776 /* WebSearchEngines.plist in Resources */ = {isa = PBXBuildFile; fileRef = C7FF53740D35286800194776 /* WebSearchEngines.plist */; };
 		C7FF53770D35286800194776 /* WebSearchEngines.plist in Resources */ = {isa = PBXBuildFile; fileRef = C7FF53740D35286800194776 /* WebSearchEngines.plist */; };
@@ -1653,18 +1665,21 @@
 				3F44AD1205BDFB9F00CB4B08 /* libxpconnect.dylib in Copy Component Libraries */,
 				3F44AD2305BDFB9F00CB4B08 /* libgkplugin.dylib in Copy Component Libraries */,
 				3F44AD2605BDFB9F00CB4B08 /* liboji.dylib in Copy Component Libraries */,
 				3F44AD2905BDFB9F00CB4B08 /* libi18n.dylib in Copy Component Libraries */,
 				3F44AD2A05BDFB9F00CB4B08 /* libxmlextras.dylib in Copy Component Libraries */,
 				3F44AD2B05BDFB9F00CB4B08 /* libsuitetypeaheadfind.dylib in Copy Component Libraries */,
 				0F518833088592020091F3FB /* libpermissions.dylib in Copy Component Libraries */,
 				DEC87B100C2882DC002EB106 /* libstoragecomps.dylib in Copy Component Libraries */,
+				C7DE8E2F0F30D2AD00CD3872 /* libcaminosafebrowsing.dylib in Copy Component Libraries */,
 				3F44AD2705BDFB9F00CB4B08 /* nsProxyAutoConfig.js in Copy Component Libraries */,
 				0098B1230CAEA77500DA0F2F /* nsHandlerService.js in Copy Component Libraries */,
+				C7DE8E300F30D2C100CD3872 /* nsUrlClassifierListManager.js in Copy Component Libraries */,
+				C7DE8E310F30D2C100CD3872 /* nsUrlClassifierLib.js in Copy Component Libraries */,
 			);
 			name = "Copy Component Libraries";
 			runOnlyForDeploymentPostprocessing = 0;
 		};
 		33819D740D98189700CA9F52 /* Copy Feed Handlers */ = {
 			isa = PBXCopyFilesBuildPhase;
 			buildActionMask = 2147483647;
 			dstPath = FeedHandlers;
@@ -1693,16 +1708,18 @@
 		3386CD380CB18D6A00B8E89D /* Copy Component Libraries */ = {
 			isa = PBXCopyFilesBuildPhase;
 			buildActionMask = 2147483647;
 			dstPath = components;
 			dstSubfolderSpec = 6;
 			files = (
 				3F44AF4405BDFBA000CB4B08 /* nsProxyAutoConfig.js in Copy Component Libraries */,
 				0098B12A0CAEA81700DA0F2F /* nsHandlerService.js in Copy Component Libraries */,
+				C7DE8E4B0F30D41500CD3872 /* nsUrlClassifierListManager.js in Copy Component Libraries */,
+				C7DE8E4C0F30D41500CD3872 /* nsUrlClassifierLib.js in Copy Component Libraries */,
 			);
 			name = "Copy Component Libraries";
 			runOnlyForDeploymentPostprocessing = 0;
 		};
 		3F44ACCF05BDFB9E00CB4B08 /* Copy Component XPTs */ = {
 			isa = PBXCopyFilesBuildPhase;
 			buildActionMask = 2147483647;
 			dstPath = components;
@@ -1764,16 +1781,17 @@
 				3F44AD0A05BDFB9F00CB4B08 /* necko.xpt in Copy Component XPTs */,
 				3F44AD1305BDFB9F00CB4B08 /* pref.xpt in Copy Component XPTs */,
 				3F44AD1505BDFB9F00CB4B08 /* rdf.xpt in Copy Component XPTs */,
 				3F44AD1605BDFB9F00CB4B08 /* shistory.xpt in Copy Component XPTs */,
 				DEC87B120C288337002EB106 /* storage.xpt in Copy Component XPTs */,
 				3F44AD1705BDFB9F00CB4B08 /* uconv.xpt in Copy Component XPTs */,
 				3F44AD1805BDFB9F00CB4B08 /* unicharutil.xpt in Copy Component XPTs */,
 				3F44AD1905BDFB9F00CB4B08 /* uriloader.xpt in Copy Component XPTs */,
+				C7DE8E420F30D2FF00CD3872 /* url-classifier.xpt in Copy Component XPTs */,
 				3F44AD1A05BDFB9F00CB4B08 /* xpcom_base.xpt in Copy Component XPTs */,
 				3F44AD1B05BDFB9F00CB4B08 /* xpcom_components.xpt in Copy Component XPTs */,
 				3F44AD1C05BDFB9F00CB4B08 /* xpcom_ds.xpt in Copy Component XPTs */,
 				3F44AD1D05BDFB9F00CB4B08 /* xpcom_io.xpt in Copy Component XPTs */,
 				3F44AD1E05BDFB9F00CB4B08 /* xpcom_threads.xpt in Copy Component XPTs */,
 				3F44AD1F05BDFB9F00CB4B08 /* xpcom_xpti.xpt in Copy Component XPTs */,
 				3F44AD2005BDFB9F00CB4B08 /* xpconnect.xpt in Copy Component XPTs */,
 				3F44AD2105BDFB9F00CB4B08 /* embed_base.xpt in Copy Component XPTs */,
@@ -2048,16 +2066,17 @@
 				3F44AF3205BDFBA000CB4B08 /* necko.xpt in Copy Component XPTs */,
 				3F44AF3305BDFBA000CB4B08 /* pref.xpt in Copy Component XPTs */,
 				3F44AF3505BDFBA000CB4B08 /* rdf.xpt in Copy Component XPTs */,
 				3F44AF3605BDFBA000CB4B08 /* shistory.xpt in Copy Component XPTs */,
 				DEC87B130C288337002EB106 /* storage.xpt in Copy Component XPTs */,
 				3F44AF3705BDFBA000CB4B08 /* uconv.xpt in Copy Component XPTs */,
 				3F44AF3805BDFBA000CB4B08 /* unicharutil.xpt in Copy Component XPTs */,
 				3F44AF3905BDFBA000CB4B08 /* uriloader.xpt in Copy Component XPTs */,
+				C7DE8E430F30D32700CD3872 /* url-classifier.xpt in Copy Component XPTs */,
 				3F44AF3A05BDFBA000CB4B08 /* xpcom_base.xpt in Copy Component XPTs */,
 				3F44AF3B05BDFBA000CB4B08 /* xpcom_components.xpt in Copy Component XPTs */,
 				3F44AF3C05BDFBA000CB4B08 /* xpcom_ds.xpt in Copy Component XPTs */,
 				3F44AF3D05BDFBA000CB4B08 /* xpcom_io.xpt in Copy Component XPTs */,
 				3F44AF3E05BDFBA000CB4B08 /* xpcom_threads.xpt in Copy Component XPTs */,
 				3F44AF3F05BDFBA000CB4B08 /* xpcom_xpti.xpt in Copy Component XPTs */,
 				3F44AF4005BDFBA000CB4B08 /* xpconnect.xpt in Copy Component XPTs */,
 				3F44AF4105BDFBA000CB4B08 /* embed_base.xpt in Copy Component XPTs */,
@@ -2753,16 +2772,24 @@
 		C713F08E0E9AF7DB002313B3 /* CHSlidingViewAnimation.m */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.objc; name = CHSlidingViewAnimation.m; path = src/extensions/CHSlidingViewAnimation.m; sourceTree = "<group>"; };
 		C713F08F0E9AF7DB002313B3 /* CHSlidingViewAnimation.h */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.h; name = CHSlidingViewAnimation.h; path = src/extensions/CHSlidingViewAnimation.h; sourceTree = "<group>"; };
 		C79573840D35314D0028A773 /* XMLSearchPluginParser.mm */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.cpp.objcpp; name = XMLSearchPluginParser.mm; path = src/websearch/XMLSearchPluginParser.mm; sourceTree = "<group>"; };
 		C79573850D35314D0028A773 /* XMLSearchPluginParser.h */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.h; name = XMLSearchPluginParser.h; path = src/websearch/XMLSearchPluginParser.h; sourceTree = "<group>"; };
 		C79573860D35314D0028A773 /* OpenSearchParser.mm */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.cpp.objcpp; name = OpenSearchParser.mm; path = src/websearch/OpenSearchParser.mm; sourceTree = "<group>"; };
 		C79573870D35314D0028A773 /* OpenSearchParser.h */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.h; name = OpenSearchParser.h; path = src/websearch/OpenSearchParser.h; sourceTree = "<group>"; };
 		C7AB1E9E0EEC5FEB0053A08A /* NSTextView+Utils.m */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.objc; name = "NSTextView+Utils.m"; path = "src/extensions/NSTextView+Utils.m"; sourceTree = "<group>"; };
 		C7AB1E9F0EEC5FEB0053A08A /* NSTextView+Utils.h */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.h; name = "NSTextView+Utils.h"; path = "src/extensions/NSTextView+Utils.h"; sourceTree = "<group>"; };
+		C7DE8DD30F30CFAC00CD3872 /* SafeBrowsingListManager.mm */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.cpp.objcpp; name = SafeBrowsingListManager.mm; path = src/safebrowsing/SafeBrowsingListManager.mm; sourceTree = "<group>"; };
+		C7DE8DD40F30CFAC00CD3872 /* SafeBrowsingListManager.h */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.h; name = SafeBrowsingListManager.h; path = src/safebrowsing/SafeBrowsingListManager.h; sourceTree = "<group>"; };
+		C7DE8DD50F30CFAC00CD3872 /* SafeBrowsingAboutModule.mm */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.cpp.objcpp; name = SafeBrowsingAboutModule.mm; path = src/safebrowsing/SafeBrowsingAboutModule.mm; sourceTree = "<group>"; };
+		C7DE8DD60F30CFAC00CD3872 /* SafeBrowsingAboutModule.h */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.h; name = SafeBrowsingAboutModule.h; path = src/safebrowsing/SafeBrowsingAboutModule.h; sourceTree = "<group>"; };
+		C7DE8E150F30D14F00CD3872 /* nsUrlClassifierListManager.js */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.javascript; name = nsUrlClassifierListManager.js; path = ../dist/bin/components/nsUrlClassifierListManager.js; sourceTree = SOURCE_ROOT; };
+		C7DE8E160F30D14F00CD3872 /* nsUrlClassifierLib.js */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.javascript; name = nsUrlClassifierLib.js; path = ../dist/bin/components/nsUrlClassifierLib.js; sourceTree = SOURCE_ROOT; };
+		C7DE8E260F30D1BC00CD3872 /* url-classifier.xpt */ = {isa = PBXFileReference; lastKnownFileType = file; name = "url-classifier.xpt"; path = "../dist/bin/components/url-classifier.xpt"; sourceTree = SOURCE_ROOT; };
+		C7DE8E2B0F30D27300CD3872 /* libcaminosafebrowsing.dylib */ = {isa = PBXFileReference; lastKnownFileType = "compiled.mach-o.bundle"; name = libcaminosafebrowsing.dylib; path = ../dist/bin/components/libcaminosafebrowsing.dylib; sourceTree = SOURCE_ROOT; };
 		C7FF536A0D35281F00194776 /* search_editor_bottom_background.png */ = {isa = PBXFileReference; lastKnownFileType = image.png; name = search_editor_bottom_background.png; path = chrome/search_editor_bottom_background.png; sourceTree = "<group>"; };
 		C7FF536B0D35281F00194776 /* search_editor_action.png */ = {isa = PBXFileReference; lastKnownFileType = image.png; name = search_editor_action.png; path = chrome/search_editor_action.png; sourceTree = "<group>"; };
 		C7FF53710D35285400194776 /* English */ = {isa = PBXFileReference; lastKnownFileType = wrapper.nib; name = English; path = resources/localized/English.lproj/SearchEngineEditor.nib; sourceTree = "<group>"; };
 		C7FF53750D35286800194776 /* English */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = text.plist.xml; name = English; path = resources/localized/English.lproj/WebSearchEngines.plist; sourceTree = "<group>"; };
 		C7FF53790D3528B700194776 /* SearchEngineManager.mm */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.cpp.objcpp; name = SearchEngineManager.mm; path = src/websearch/SearchEngineManager.mm; sourceTree = "<group>"; };
 		C7FF537A0D3528B700194776 /* SearchEngineManager.h */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.h; name = SearchEngineManager.h; path = src/websearch/SearchEngineManager.h; sourceTree = "<group>"; };
 		C7FF537B0D3528B700194776 /* SearchEngineEditor.mm */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.cpp.objcpp; name = SearchEngineEditor.mm; path = src/websearch/SearchEngineEditor.mm; sourceTree = "<group>"; };
 		C7FF537C0D3528B700194776 /* SearchEngineEditor.h */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.h; name = SearchEngineEditor.h; path = src/websearch/SearchEngineEditor.h; sourceTree = "<group>"; };
@@ -3390,16 +3417,17 @@
 				DEB968310B0D8E9F0023F8B1 /* Security.framework in Frameworks */,
 				DE62E4320B72B50C00142851 /* libauth.a in Frameworks */,
 				DEC87B150C288403002EB106 /* libstoragecomps.a in Frameworks */,
 				33B775AB0C4EAC1E00A6D67F /* libsqlite3.dylib in Frameworks */,
 				7B64B7E30CCFDA860098406C /* Sparkle.framework in Frameworks */,
 				7B9A26190D411275008CDB39 /* libnssutil3.dylib in Frameworks */,
 				DE846DA90D84D03400009C6A /* libimgicon.a in Frameworks */,
 				DEFAA3440F241C1600BD51C1 /* Growl.framework in Frameworks */,
+				C7DE8E2D0F30D27300CD3872 /* libcaminosafebrowsing.dylib in Frameworks */,
 			);
 			runOnlyForDeploymentPostprocessing = 0;
 		};
 /* End PBXFrameworksBuildPhase section */
 
 /* Begin PBXGroup section */
 		032FFDCC077351A800440548 /* Downloads */ = {
 			isa = PBXGroup;
@@ -3448,16 +3476,17 @@
 				F558B1F603107E4A0166970F /* Gecko Embedding */,
 				F512F52A02D1287F01072C9F /* Apple Events */,
 				F5A3669402CCFAF601DC3354 /* Bookmarks */,
 				F50D9DE602ECC32301BB4219 /* Downloads */,
 				F5A3669602CCFAF601DC3354 /* History */,
 				F512F52B02D1287F01072C9F /* Dialogs */,
 				3FBDC7D608252CD600D7F8E0 /* Form Fill */,
 				C7FF53690D3527F400194776 /* Web Search */,
+				C7DE8DD00F30CF8A00CD3872 /* Safe Browsing */,
 				335639250C84DF4F00DC4D06 /* UI Components */,
 				33563A6C0C84F44900DC4D06 /* Backend Components */,
 				F5571935022B401B010001CA /* Categories */,
 			);
 			name = Classes;
 			sourceTree = "<group>";
 		};
 		0E6A988C097E0007007962C1 /* fonts */ = {
@@ -3505,16 +3534,17 @@
 				F6BD644F01B315FA01A962F7 /* libgkplugin.dylib */,
 				F53A902202C1127A01A967F3 /* liboji.dylib */,
 				A708E74103FB9041003C038B /* libi18n.dylib */,
 				A708E74303FB90AB003C038B /* libxmlextras.dylib */,
 				A7D88E680465D94000A80196 /* libsuitetypeaheadfind.dylib */,
 				0F5187C308858E620091F3FB /* libpermissions.dylib */,
 				DE62E42F0B72B3D200142851 /* libauth.dylib */,
 				DEC87B0F0C2882DC002EB106 /* libstoragecomps.dylib */,
+				C7DE8E2B0F30D27300CD3872 /* libcaminosafebrowsing.dylib */,
 			);
 			name = Components;
 			sourceTree = "<group>";
 		};
 		0FA8EFA30423B37000A80166 /* XPT files */ = {
 			isa = PBXGroup;
 			children = (
 				F6BD639401B3131201A962F7 /* caps.xpt */,
@@ -3574,16 +3604,17 @@
 				E4C7D99E0A32109D00B455AD /* spellchecker.xpt */,
 				DEC87B110C288337002EB106 /* storage.xpt */,
 				82CE28C80736633900B4DE07 /* txmgr.xpt */,
 				F6BD63B301B3131201A962F7 /* txtsvc.xpt */,
 				A7D88E6A0465D9F800A80196 /* suitetypeaheadfind.xpt */,
 				F6BD642101B3156701A962F7 /* uconv.xpt */,
 				F6BD642201B3156701A962F7 /* unicharutil.xpt */,
 				F6BD642301B3156701A962F7 /* uriloader.xpt */,
+				C7DE8E260F30D1BC00CD3872 /* url-classifier.xpt */,
 				F6BD63B401B3131201A962F7 /* webBrowser_core.xpt */,
 				3F7C6CC505B5B42E002FFFD3 /* widget.xpt */,
 				F6BD63B501B3131201A962F7 /* windowwatcher.xpt */,
 				F6BD642501B3156701A962F7 /* xpcom_base.xpt */,
 				F6BD642601B3156701A962F7 /* xpcom_components.xpt */,
 				F6BD642701B3156701A962F7 /* xpcom_ds.xpt */,
 				F6BD642801B3156701A962F7 /* xpcom_io.xpt */,
 				F6BD642901B3156701A962F7 /* xpcom_threads.xpt */,
@@ -4122,16 +4153,27 @@
 				00335B8B0C655ABC00A607F2 /* WebSearchField.h */,
 				00335B8C0C655ABC00A607F2 /* WebSearchField.mm */,
 				33E1EA0D0D34550A00910BBD /* AddSearchProviderHandler.h */,
 				33E1EA0E0D34550A00910BBD /* AddSearchProviderHandler.mm */,
 			);
 			name = UI;
 			sourceTree = "<group>";
 		};
+		C7DE8DD00F30CF8A00CD3872 /* Safe Browsing */ = {
+			isa = PBXGroup;
+			children = (
+				C7DE8DD40F30CFAC00CD3872 /* SafeBrowsingListManager.h */,
+				C7DE8DD30F30CFAC00CD3872 /* SafeBrowsingListManager.mm */,
+				C7DE8DD60F30CFAC00CD3872 /* SafeBrowsingAboutModule.h */,
+				C7DE8DD50F30CFAC00CD3872 /* SafeBrowsingAboutModule.mm */,
+			);
+			name = "Safe Browsing";
+			sourceTree = "<group>";
+		};
 		C7FF53690D3527F400194776 /* Web Search */ = {
 			isa = PBXGroup;
 			children = (
 				C795737B0D35310B0028A773 /* Backend */,
 				C795737E0D35311B0028A773 /* UI */,
 				C795737C0D3531100028A773 /* Plug-ins */,
 			);
 			name = "Web Search";
@@ -4876,16 +4918,18 @@
 				F50DCB4302C2856001A967F3 /* libjsj.dylib */,
 				008115420B180F35001CB3F0 /* libthebes.dylib */,
 				F6BD638701B30F5301A962F7 /* libgkgfx.dylib */,
 				0E6A9882097DFF9A007962C1 /* libucvmath.dylib */,
 				3FE5B9FC068A090F0001CECD /* libmozz.dylib */,
 				33B777950C55851800A6D67F /* libmozlcms.dylib */,
 				F5461CBB03AAC25C01A96660 /* nsProxyAutoConfig.js */,
 				0098B11D0CAEA75700DA0F2F /* nsHandlerService.js */,
+				C7DE8E150F30D14F00CD3872 /* nsUrlClassifierListManager.js */,
+				C7DE8E160F30D14F00CD3872 /* nsUrlClassifierLib.js */,
 				0098B17F0CAEA9CF00DA0F2F /* XPCOMUtils.jsm */,
 				F5F14E9602A5A43A01A967F3 /* libwidget.rsrc */,
 				F5247C2F0228B5E7013DD99A /* Gecko Security */,
 				F6BD645501B3167601A962F7 /* Gecko Res */,
 				F6BD64FB01B3184301A962F7 /* Gecko Pref Defaults */,
 				F507BA530213C26501D93544 /* Gecko Profile Defaults */,
 				F56F242202AC6F7101A967F3 /* Gecko Static Components */,
 				F6BD638901B30F5301A962F7 /* Gecko Components */,
@@ -6076,16 +6120,18 @@
 				00BBBC860D66C13400C2D916 /* CHGradient.m in Sources */,
 				001D4A270D75B0B100464BE4 /* MoveCommand.mm in Sources */,
 				33819AD70D938A3B00CA9F52 /* GeckoPrefConstants.mm in Sources */,
 				0095FACA0D9C99880039B3D8 /* CHBrowserView+Spelling.mm in Sources */,
 				336234490E6BC2FB00DD5373 /* HTMLBookmarkConverter.m in Sources */,
 				C713F0900E9AF7DB002313B3 /* CHSlidingViewAnimation.m in Sources */,
 				C7AB1EA00EEC5FEB0053A08A /* NSTextView+Utils.m in Sources */,
 				DE18FBFD0F2435F700325C11 /* GrowlController.mm in Sources */,
+				C7DE8DD70F30CFAC00CD3872 /* SafeBrowsingListManager.mm in Sources */,
+				C7DE8DD80F30CFAC00CD3872 /* SafeBrowsingAboutModule.mm in Sources */,
 			);
 			runOnlyForDeploymentPostprocessing = 0;
 		};
 		3F44AD9405BDFB9F00CB4B08 /* Sources */ = {
 			isa = PBXSourcesBuildPhase;
 			buildActionMask = 2147483647;
 			files = (
 				3F44AD9605BDFB9F00CB4B08 /* Appearance.mm in Sources */,
@@ -6261,16 +6307,18 @@
 				00BBBC850D66C13400C2D916 /* CHGradient.m in Sources */,
 				001D4A260D75B0B100464BE4 /* MoveCommand.mm in Sources */,
 				33819AD80D938A3B00CA9F52 /* GeckoPrefConstants.mm in Sources */,
 				0095FAC90D9C99880039B3D8 /* CHBrowserView+Spelling.mm in Sources */,
 				336234480E6BC2FB00DD5373 /* HTMLBookmarkConverter.m in Sources */,
 				C713F0910E9AF7DB002313B3 /* CHSlidingViewAnimation.m in Sources */,
 				C7AB1EA10EEC5FEB0053A08A /* NSTextView+Utils.m in Sources */,
 				DE18FBFC0F2435F700325C11 /* GrowlController.mm in Sources */,
+				C7DE8DD90F30CFAC00CD3872 /* SafeBrowsingListManager.mm in Sources */,
+				C7DE8DDA0F30CFAC00CD3872 /* SafeBrowsingAboutModule.mm in Sources */,
 			);
 			runOnlyForDeploymentPostprocessing = 0;
 		};
 /* End PBXSourcesBuildPhase section */
 
 /* Begin PBXTargetDependency section */
 		7B0B578D0D4A5098003BC853 /* PBXTargetDependency */ = {
 			isa = PBXTargetDependency;
@@ -7345,16 +7393,17 @@
 					../embedding/base,
 					../js/src/liveconnect,
 					../js/src/xpconnect/loader,
 					../jpeg,
 					../modules/libimg/png,
 					../gfx/cairo/cairo/src,
 					../gfx/cairo/libpixman/src,
 					../profile/dirserviceprovider/src,
+					../dist/bin/components,
 				);
 				OTHER_CFLAGS = (
 					"$(OTHER_CFLAGS)",
 					"-DDEBUG",
 					"-DMOZ_DEBUG",
 					"-DTRACING",
 				);
 			};
@@ -7375,16 +7424,17 @@
 					../embedding/base,
 					../js/src/liveconnect,
 					../js/src/xpconnect/loader,
 					../jpeg,
 					../modules/libimg/png,
 					../gfx/cairo/cairo/src,
 					../gfx/cairo/libpixman/src,
 					../profile/dirserviceprovider/src,
+					../dist/bin/components,
 				);
 			};
 			name = Deployment;
 		};
 		3323778F0C4D0F9600A34879 /* Development */ = {
 			isa = XCBuildConfiguration;
 			baseConfigurationReference = 332377CF0C4D886800A34879 /* Debug.xcconfig */;
 			buildSettings = {
Index: Makefile.in
===================================================================
RCS file: /cvsroot/mozilla/camino/Makefile.in,v
retrieving revision 1.50
diff -u -8 -r1.50 Makefile.in
--- Makefile.in	27 Jan 2009 04:33:10 -0000	1.50
+++ Makefile.in	29 Jan 2009 03:50:38 -0000
@@ -44,16 +44,17 @@
 
 include $(DEPTH)/config/autoconf.mk
 
 DIRS = \
 	feedhandlers \
 	flashblock \
 	idl \
 	striptease \
+	safebrowsing \
 	$(NULL)
 
 APP_NAME	= Camino
 
 RSYNC_ALL = rsync -aC --exclude .cvsignore --delete
 
 CM_APP_VERSION_FILE = $(srcdir)/config/version.txt
 CM_APP_VERSION := $(shell cat $(CM_APP_VERSION_FILE))
Index: confvars.sh
===================================================================
RCS file: /cvsroot/mozilla/camino/confvars.sh,v
retrieving revision 1.5
diff -u -8 -r1.5 confvars.sh
--- confvars.sh	23 Dec 2007 20:53:25 -0000	1.5
+++ confvars.sh	29 Jan 2009 03:50:38 -0000
@@ -44,8 +44,9 @@
 MOZ_APP_DISPLAYNAME=Mozilla
 MOZ_APP_VERSION=$MOZILLA_VERSION
 MOZ_EXTENSIONS_DEFAULT=" typeaheadfind"
 MOZ_XUL_APP=
 MOZ_PREF_EXTENSIONS=
 MOZ_WEBSERVICES=
 MOZ_NO_XPCOM_OBSOLETE=1
 MOZ_XPINSTALL=
+MOZ_URL_CLASSIFIER=1
Index: makefiles.sh
===================================================================
RCS file: /cvsroot/mozilla/camino/makefiles.sh,v
retrieving revision 1.3
diff -u -8 -r1.3 makefiles.sh
--- makefiles.sh	2 Feb 2008 06:05:06 -0000	1.3
+++ makefiles.sh	29 Jan 2009 03:50:38 -0000
@@ -39,9 +39,10 @@
 add_makefiles "
 camino/Makefile
 camino/IBPalette/Makefile
 camino/feedhandlers/Makefile
 camino/flashblock/Makefile
 camino/idl/Makefile
 camino/installer/Makefile
 camino/striptease/Makefile
+camino/safebrowsing/Makefile
 "
Index: config/Camino.xcconfig
===================================================================
RCS file: /cvsroot/mozilla/camino/config/Camino.xcconfig,v
retrieving revision 1.17
diff -u -8 -r1.17 Camino.xcconfig
--- config/Camino.xcconfig	27 Jan 2009 04:33:11 -0000	1.17
+++ config/Camino.xcconfig	29 Jan 2009 03:50:38 -0000
@@ -9,16 +9,16 @@
 GCC_ENABLE_OBJC_EXCEPTIONS = YES
 GCC_ENABLE_CPP_EXCEPTIONS = NO
 GCC_ENABLE_CPP_RTTI = NO
 OTHER_CFLAGS = -fshort-wchar
 GCC_ENABLE_PASCAL_STRINGS = YES
 GCC_PREPROCESSOR_DEFINITIONS = OSTYPE=Darwin1.4 OSARCH=Darwin MOZILLA_INTERNAL_API=1
 OTHER_LDFLAGS = -lpthread -lm -Wl,-executable_path,../dist/bin
 LIBRARY_SEARCH_PATHS = ../dist/bin ../dist/lib
-HEADER_SEARCH_PATHS = ../dist/include ../dist/include/appcomps ../dist/include/camino ../dist/include/caps ../dist/include/chardet ../dist/include/chrome ../dist/include/commandhandler ../dist/include/composer ../dist/include/content ../dist/include/cookie ../dist/include/docshell ../dist/include/dom ../dist/include/downloads ../dist/include/editor ../dist/include/embed_base ../dist/include/exthandler ../dist/include/find ../dist/include/gfx ../dist/include/helperAppDlg ../dist/include/history ../dist/include/htmlparser ../dist/include/intl ../dist/include/js ../dist/include/layout ../dist/include/locale ../dist/include/mimetype ../dist/include/mork ../dist/include/necko ../dist/include/nkcache ../dist/include/nspr ../dist/include/pipboot ../dist/include/pipnss ../dist/include/pref ../dist/include/profdirserviceprovider ../dist/include/shistory ../dist/include/spellchecker ../dist/include/string ../dist/include/thebes ../dist/include/txtsvc ../dist/include/uconv ../dist/include/unicharutil ../dist/include/uriloader ../dist/include/view ../dist/include/webbrowserpersist ../dist/include/webbrwsr ../dist/include/webshell ../dist/include/widget ../dist/include/windowwatcher ../dist/include/xmlextras ../dist/include/xpcom ../dist/include/xpconnect ../dist/include/xultmpl ../dist/public/nss $(SYSTEM_DEVELOPER_DIR)/Headers/FlatCarbon
+HEADER_SEARCH_PATHS = ../dist/include ../dist/include/appcomps ../dist/include/camino ../dist/include/caps ../dist/include/chardet ../dist/include/chrome ../dist/include/commandhandler ../dist/include/composer ../dist/include/content ../dist/include/cookie ../dist/include/docshell ../dist/include/dom ../dist/include/downloads ../dist/include/editor ../dist/include/embed_base ../dist/include/exthandler ../dist/include/find ../dist/include/gfx ../dist/include/helperAppDlg ../dist/include/history ../dist/include/htmlparser ../dist/include/intl ../dist/include/js ../dist/include/layout ../dist/include/locale ../dist/include/mimetype ../dist/include/mork ../dist/include/necko ../dist/include/nkcache ../dist/include/nspr ../dist/include/pipboot ../dist/include/pipnss ../dist/include/pref ../dist/include/profdirserviceprovider ../dist/include/shistory ../dist/include/spellchecker ../dist/include/string ../dist/include/thebes ../dist/include/txtsvc ../dist/include/uconv ../dist/include/unicharutil ../dist/include/uriloader ../dist/include/url-classifier ../dist/include/view ../dist/include/webbrowserpersist ../dist/include/webbrwsr ../dist/include/webshell ../dist/include/widget ../dist/include/windowwatcher ../dist/include/xmlextras ../dist/include/xpcom ../dist/include/xpconnect ../dist/include/xultmpl ../dist/public/nss $(SYSTEM_DEVELOPER_DIR)/Headers/FlatCarbon
 FRAMEWORK_SEARCH_PATHS = sharedmenuscocoa/build/$(CONFIGURATION) sparkle/build/Release growl/build/$(CONFIGURATION)
 
 // Warning settings
 GCC_TREAT_WARNINGS_AS_ERRORS = YES
 GCC_WARN_SIGN_COMPARE = YES
 WARNING_CFLAGS = -Wall -Wno-four-char-constants
 OTHER_CPLUSPLUSFLAGS = $(OTHER_CPLUSPLUSFLAGS) -Wno-non-virtual-dtor
Index: embed-replacements/locale/en-US/global/safebrowsing/blockedSite-strings.dtd
===================================================================
RCS file: embed-replacements/locale/en-US/global/safebrowsing/blockedSite-strings.dtd
diff -N embed-replacements/locale/en-US/global/safebrowsing/blockedSite-strings.dtd
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ embed-replacements/locale/en-US/global/safebrowsing/blockedSite-strings.dtd	29 Jan 2009 03:50:38 -0000
@@ -0,0 +1,13 @@
+<!ENTITY safeb.button.getMeOut.label "Get me out of here!">
+<!ENTITY safeb.button.ignoreWarning.label "Ignore this warning">
+<!ENTITY safeb.button.moreInformation.label "Why was this site blocked?">
+
+<!ENTITY safeb.blocked.malware.title "Reported Attack Site!">
+<!-- Localization note (safeb.blocked.malware.shortDesc) - Please don't translate the contents of the <span id="malware_sitename"/> tag.  It will be replaced at runtime with a domain name (e.g. www.badsite.com) -->
+<!ENTITY safeb.blocked.malware.shortDesc "This web site at <span id='malware_sitename'/> has been reported as an attack site and has been blocked based on your security preferences.">
+<!ENTITY safeb.blocked.malware.longDesc "<p>Attack sites try to install programs that steal private information, use your computer to attack others, or damage your system.</p><p>Some attack sites intentionally distribute harmful software, but many are compromised without the knowledge or permission of their owners.</p>">
+
+<!ENTITY safeb.blocked.phishing.title "Reported Web Forgery!">
+<!-- Localization note (safeb.blocked.phishing.shortDesc) - Please don't translate the contents of the <span id="phishing_sitename"/> tag. It will be replaced at runtime with a domain name (e.g. www.badsite.com) -->
+<!ENTITY safeb.blocked.phishing.shortDesc "This web site at <span id='phishing_sitename'/> has been reported as a web forgery and has been blocked based on your security preferences.">
+<!ENTITY safeb.blocked.phishing.longDesc "<p>Web forgeries are designed to trick you into revealing personal or financial information by imitating sources you may trust.</p><p>Entering any information on this web page may result in identity theft or other fraud.</p>">
Index: embed-replacements/locale/en-US/global/safebrowsing/blockedSite.xhtml
===================================================================
RCS file: embed-replacements/locale/en-US/global/safebrowsing/blockedSite.xhtml
diff -N embed-replacements/locale/en-US/global/safebrowsing/blockedSite.xhtml
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ embed-replacements/locale/en-US/global/safebrowsing/blockedSite.xhtml	29 Jan 2009 03:50:38 -0000
@@ -0,0 +1,221 @@
+<?xml version="1.0" encoding="UTF-8"?>
+
+<!DOCTYPE html [
+  <!ENTITY % htmlDTD PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
+  <!ENTITY % blockedSiteDTD SYSTEM "chrome://global/locale/safebrowsing/blockedSite-strings.dtd">
+  %blockedSiteDTD;
+]>
+
+<!-- ***** BEGIN LICENSE BLOCK *****
+   - Version: MPL 1.1/GPL 2.0/LGPL 2.1
+   -
+   - The contents of this file are subject to the Mozilla Public License Version
+   - 1.1 (the "License"); you may not use this file except in compliance with
+   - the License. You may obtain a copy of the License at
+   - http://www.mozilla.org/MPL/
+   -
+   - Software distributed under the License is distributed on an "AS IS" basis,
+   - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+   - for the specific language governing rights and limitations under the
+   - License.
+   -
+   - The Original Code is mozilla.org code.
+   -
+   - The Initial Developer of the Original Code is
+   - Netscape Communications Corporation.
+   - Portions created by the Initial Developer are Copyright (C) 1998
+   - the Initial Developer. All Rights Reserved.
+   -
+   - Contributor(s):
+   -   Adam Lock <adamlock@netscape.com>
+   -   William R. Price <wrprice@alumni.rice.edu>
+   -   Henrik Skupin <mozilla@hskupin.info>
+   -   Jeff Walden <jwalden+code@mit.edu>
+   -   Johnathan Nightingale <johnath@mozilla.com>
+   -   Sean Murphy <murph@seanmurph.com>
+   -
+   - Alternatively, the contents of this file may be used under the terms of
+   - either the GNU General Public License Version 2 or later (the "GPL"), or
+   - the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+   - in which case the provisions of the GPL or the LGPL are applicable instead
+   - of those above. If you wish to allow use of your version of this file only
+   - under the terms of either the GPL or the LGPL, and not to allow others to
+   - use your version of this file under the terms of the MPL, indicate your
+   - decision by deleting the provisions above and replace them with the notice
+   - and other provisions required by the LGPL or the GPL. If you do not delete
+   - the provisions above, a recipient may use your version of this file under
+   - the terms of any one of the MPL, the GPL or the LGPL.
+   -
+   - ***** END LICENSE BLOCK ***** -->
+
+<html xmlns="http://www.w3.org/1999/xhtml" class="blacklist">
+  <head>
+    <link rel="stylesheet" href="chrome://global/skin/netError.css" type="text/css" media="all" />
+
+    <script type="application/javascript" src="chrome://global/content/strres.js"/>
+    <script type="application/javascript"><![CDATA[
+      // Error url MUST be formatted like this:
+      //   about:blocked?e=error_code&u=url
+      
+      // Note that this file uses document.documentURI to get
+      // the URL (with the format from above). This is because
+      // document.location.href gets the current URI off the docshell,
+      // which is the URL displayed in the location bar, i.e.
+      // the URI that the user attempted to load.
+
+      function getErrorCode()
+      {
+        var url = document.documentURI;
+        var error = url.search(/e\=/);
+        var duffUrl = url.search(/\&u\=/);
+        return decodeURIComponent(url.slice(error + 2, duffUrl));
+      }
+
+      function getURL()
+      {
+        var url = document.documentURI;
+        var index = url.search(/u\=/);
+
+        // index == -1 if not found; if so, return an empty string
+        // instead of what would turn out to be portions of the URI
+        if (index == -1)
+          return "";
+
+        return decodeURIComponent(url.slice(index + 2));
+      }
+      
+      /**
+       * Attempt to parse the result of getURL and extract a hostname.  Fail back
+       * to getURL so that we always return something meaningful.
+       */
+      function getHostString()
+      {
+        return document.location.hostname;
+      }
+      
+      function initPage()
+      {
+        // Handoff to the appropriate initializer, based on error code
+        switch(getErrorCode()) {
+          case "malwareBlocked" :
+            initPage_malware();
+            break;
+          case "phishingBlocked" :
+            initPage_phishing();
+            break;
+        }
+      }        
+      
+      /**
+       * Initialize custom strings and functionality for blocked malware case
+       */
+      function initPage_malware()
+      {
+        // Remove phishing strings
+        var el = document.getElementById("errorTitleText_phishing");
+        el.parentNode.removeChild(el);
+
+        el = document.getElementById("errorShortDescText_phishing");
+        el.parentNode.removeChild(el);
+
+        el = document.getElementById("errorLongDescText_phishing");
+        el.parentNode.removeChild(el);
+
+        // Set sitename
+        document.getElementById("malware_sitename").textContent = getHostString();
+        document.title = document.getElementById("errorTitleText_malware")
+                                 .innerHTML;
+      }
+      
+      /**
+       * Initialize custom strings and functionality for blocked phishing case
+       */
+      function initPage_phishing()
+      {
+        // Remove malware strings
+        var el = document.getElementById("errorTitleText_malware");
+        el.parentNode.removeChild(el);
+
+        el = document.getElementById("errorShortDescText_malware");
+        el.parentNode.removeChild(el);
+
+        el = document.getElementById("errorLongDescText_malware");
+        el.parentNode.removeChild(el);
+
+        // Set sitename
+        document.getElementById("phishing_sitename").textContent = getHostString();
+        document.title = document.getElementById("errorTitleText_phishing")
+                                 .innerHTML;
+      }
+    ]]></script>
+    <style type="text/css">
+      /* Style warning button to look like a small text link in the
+         bottom right. This is preferable to just using a text link
+         since there is already a mechanism in browser.js for trapping
+         oncommand events from unprivileged chrome pages (BrowserOnCommand).*/
+      #ignoreWarningButton {
+        -moz-appearance: none;
+        background: transparent;
+        border: none;
+        color: white;  /* Hard coded because netError.css forces this page's background to dark red */
+        text-decoration: underline;
+        margin: 0;
+        padding: 0;
+        position: relative;
+        top: 23px;
+        left: 20px;
+        font-size: smaller;
+        cursor: pointer;
+      }
+      
+      #ignoreWarning {
+        text-align: right;
+      }
+    </style>
+  </head>
+
+  <body>
+    <div id="errorPageContainer">
+    
+      <!-- Error Title -->
+      <div id="errorTitle">
+        <h1 id="errorTitleText_phishing">&safeb.blocked.phishing.title;</h1>
+        <h1 id="errorTitleText_malware">&safeb.blocked.malware.title;</h1>
+      </div>
+      
+      <div id="errorLongContent">
+      
+        <!-- Short Description -->
+        <div id="errorShortDesc">
+          <p id="errorShortDescText_phishing">&safeb.blocked.phishing.shortDesc;</p>
+          <p id="errorShortDescText_malware">&safeb.blocked.malware.shortDesc;</p>
+        </div>
+
+        <!-- Long Description -->
+        <div id="errorLongDesc">
+          <p id="errorLongDescText_phishing">&safeb.blocked.phishing.longDesc;</p>
+          <p id="errorLongDescText_malware">&safeb.blocked.malware.longDesc;</p>
+        </div>
+        
+        <!-- Action buttons -->
+        <div id="buttons">
+          <!-- Commands handled in browser.js -->
+          <xul:button xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
+                      id="getMeOutButton" label="&safeb.button.getMeOut.label;"/>
+          <xul:button xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
+                      id="whyBlockedButton" label="&safeb.button.moreInformation.label;"/>
+        </div>
+      </div>
+      <div id="ignoreWarning">
+        <xul:button xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
+                    id="ignoreWarningButton" label="&safeb.button.ignoreWarning.label;"/>
+      </div>
+    </div>
+    <!--
+    - Note: It is important to run the script this way, instead of using
+    - an onload handler. This is because error pages are loaded as
+    - LOAD_BACKGROUND, which means that onload handlers will not be executed.
+    -->
+    <script type="application/javascript">initPage();</script>
+  </body>
+</html>
Index: embed-replacements/skin/classic/global/netError.css
===================================================================
RCS file: /cvsroot/mozilla/camino/embed-replacements/skin/classic/global/netError.css,v
retrieving revision 1.3
diff -u -8 -r1.3 netError.css
--- embed-replacements/skin/classic/global/netError.css	6 Sep 2008 21:14:51 -0000	1.3
+++ embed-replacements/skin/classic/global/netError.css	29 Jan 2009 03:50:40 -0000
@@ -2,16 +2,17 @@
  *  This defines the look-and-feel styling of the error pages.
  *  (see: netError.xhtml)
  *
  *  Original styling by William Price <bugzilla@mob.rice.edu>
  *  Updated by: Steven Garrity <steven@silverorange.com>
  *              Henrik Skupin  <mozilla@hskupin.info>
  *              Jon Hicks <jon@hicksdesign.co.uk>
  *              Philippe Wittenbergh <phiw@l-c-n.com>
+ *              Sean Murphy <murph@seanmurph.com> (Blacklist styling)
  */
 
 html {
   background: #F2F2F2;
 }
 
 body {
   margin: 0;
@@ -142,28 +143,40 @@
 #securityOverrideContent > button {
   margin: 0;
 }
 
 /* Custom styling for 'blacklist' error class - bug 380932  */
 :root.blacklist #errorTitle, :root.blacklist #errorLongContent,
 :root.blacklist #errorShortDesc, :root.blacklist #errorLongDesc,
 :root.blacklist a {
-  background-color: #722; /* Dark red */
+  background-color: #763033;
   color: white;
 }
 
 :root.blacklist #errorPageContainer {
-  background-image: url("chrome://global/skin/icons/blacklist_large.png");
-  background-color: #722;
+  background-image: url("data:image/png;base64,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");
+  background-color: #763033;
 }
 
 :root.blacklist {
-  background: #333;
+  background: #353535;
 }
 
 :root.blacklist #errorTryAgain {
   display: none;
 }
 
+:root.blacklist #errorShortDesc > p {
+  color: #ffdc00;
+}
+
+:root.blacklist #errorTitle h1 {
+  color: white;
+}
+
+:root.blacklist #buttons {
+  padding-top: 10px;
+}
+
 ul strong {
 	color: #000;
 }
Index: resources/application/all-camino.js.in
===================================================================
RCS file: /cvsroot/mozilla/camino/resources/application/all-camino.js.in,v
retrieving revision 1.17
diff -u -8 -r1.17 all-camino.js.in
--- resources/application/all-camino.js.in	2 Jan 2009 19:24:26 -0000	1.17
+++ resources/application/all-camino.js.in	29 Jan 2009 03:50:40 -0000
@@ -17,16 +17,17 @@
  * The Initial Developer of the Original Code is
  * Netscape Communications Corporation.
  * Portions created by the Initial Developer are Copyright (C) 2002
  * the Initial Developer. All Rights Reserved.
  *
  * Contributor(s):
  *  Brian Ryner <bryner@brianryner.com>
  *  Smokey Ardisson <alqahira@ardisson.org>
+ *  Sean Murphy <murph@seanmurph.com>
  *
  * Alternatively, the contents of this file may be used under the terms of
  * either the GNU General Public License Version 2 or later (the "GPL"), or
  * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
  * in which case the provisions of the GPL or the LGPL are applicable instead
  * of those above. If you wish to allow use of your version of this file only
  * under the terms of either the GPL or the LGPL, and not to allow others to
  * use your version of this file under the terms of the MPL, indicate your
@@ -203,8 +204,47 @@
 // auto-update URL base
 pref("app.update.url", "%APP_UPDATE_URL%");
 
 // obey OS font size threshold for disabling text smoothing
 pref("gfx.use_text_smoothing_setting", true);
 
 // force <select>s to display as Aqua rather than honor author styles
 pref("camino.use_aqua_selects", true);
+
+// Prevent loading of suspected phishing sites
+pref("browser.safebrowsing.enabled", true);
+
+// Prevent loading of suspected malware sites
+pref("browser.safebrowsing.malware.enabled", true);
+
+// The active safe browsing data provider
+pref("browser.safebrowsing.dataProvider", 0);
+
+// Properties for the safe browsing data providers
+pref("browser.safebrowsing.provider.0.name", "Google");
+pref("browser.safebrowsing.provider.0.updateURL", "http://safebrowsing.clients.google.com/safebrowsing/downloads?client={moz:client}&appver={moz:version}&pver=2.2");
+pref("browser.safebrowsing.provider.0.gethashURL", "http://safebrowsing.clients.google.com/safebrowsing/gethash?client={moz:client}&appver={moz:version}&pver=2.2");
+pref("browser.safebrowsing.provider.0.keyURL", "https://sb-ssl.google.com/safebrowsing/newkey?client={moz:client}&appver={moz:version}&pver=2.2");
+pref("browser.safebrowsing.provider.0.reportURL", "http://safebrowsing.clients.google.com/safebrowsing/report?");
+
+// Safe browsing report pages
+pref("browser.safebrowsing.provider.0.reportGenericURL", "http://{moz:locale}.phish-generic.mozilla.com/?hl={moz:locale}");
+pref("browser.safebrowsing.provider.0.reportErrorURL", "http://{moz:locale}.phish-error.mozilla.com/?hl={moz:locale}");
+pref("browser.safebrowsing.provider.0.reportPhishURL", "http://{moz:locale}.phish-report.mozilla.com/?hl={moz:locale}");
+
+// Location to more information about the safe browsing feature
+pref("browser.safebrowsing.warning.infoURL", "http://en-us.www.mozilla.com/en-US/firefox/phishing-protection/");
+
+// Name of the about: page contributed by safebrowsing to handle display of error
+// pages on phishing/malware hits.
+pref("urlclassifier.alternate_error_page", "safebrowsingblocked");
+
+// The number of random entries to send with a gethash request.
+pref("urlclassifier.gethashnoise", 4);
+
+// The list of tables that use the gethash request to confirm partial results.
+pref("urlclassifier.gethashtables", "goog-phish-shavar,goog-malware-shavar");
+
+// If an urlclassifier table has not been updated in this number of seconds,
+// a gethash request will be forced to check that the result is still in
+// the database.
+pref("urlclassifier.confirm-age", 2700);
Index: safebrowsing/CHSafeBrowsingModule.cpp
===================================================================
RCS file: safebrowsing/CHSafeBrowsingModule.cpp
diff -N safebrowsing/CHSafeBrowsingModule.cpp
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ safebrowsing/CHSafeBrowsingModule.cpp	29 Jan 2009 03:50:41 -0000
@@ -0,0 +1,92 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Camino code.
+ *
+ * The Initial Developer of the Original Code is
+ * Sean Murphy
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Sean Murphy <murph@seanmurph.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#include "nsIGenericFactory.h"
+
+#include "nsUrlClassifierDBService.h"
+#include "nsUrlClassifierStreamUpdater.h"
+#include "nsUrlClassifierUtils.h"
+#include "nsUrlClassifierHashCompleter.h"
+#include "nsDocShellCID.h"
+
+NS_GENERIC_FACTORY_CONSTRUCTOR(nsUrlClassifierStreamUpdater)
+NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsUrlClassifierUtils, Init)
+NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsUrlClassifierHashCompleter, Init)
+
+static NS_IMETHODIMP
+nsUrlClassifierDBServiceConstructor(nsISupports *aOuter, REFNSIID aIID,
+                                    void **aResult)
+{
+  nsresult rv;
+  NS_ENSURE_ARG_POINTER(aResult);
+  NS_ENSURE_NO_AGGREGATION(aOuter);
+
+  nsUrlClassifierDBService *sharedDBService = nsUrlClassifierDBService::GetInstance(&rv);
+  if (NS_FAILED(rv))
+      return rv;
+  rv = sharedDBService->QueryInterface(aIID, aResult);
+  NS_RELEASE(sharedDBService);
+
+  return rv;
+}
+
+static const nsModuleComponentInfo components[] =
+{
+  { "Url Classifier DB Service",
+    NS_URLCLASSIFIERDBSERVICE_CID,
+    NS_URLCLASSIFIERDBSERVICE_CONTRACTID,
+    nsUrlClassifierDBServiceConstructor },
+  { "Url Classifier DB Service",
+    NS_URLCLASSIFIERDBSERVICE_CID,
+    NS_URICLASSIFIERSERVICE_CONTRACTID,
+    nsUrlClassifierDBServiceConstructor },
+  { "Url Classifier Stream Updater",
+    NS_URLCLASSIFIERSTREAMUPDATER_CID,
+    NS_URLCLASSIFIERSTREAMUPDATER_CONTRACTID,
+    nsUrlClassifierStreamUpdaterConstructor },
+  { "Url Classifier Utils",
+    NS_URLCLASSIFIERUTILS_CID,
+    NS_URLCLASSIFIERUTILS_CONTRACTID,
+    nsUrlClassifierUtilsConstructor },
+  { "Url Classifier Hash Completer",
+    NS_URLCLASSIFIERHASHCOMPLETER_CID,
+    NS_URLCLASSIFIERHASHCOMPLETER_CONTRACTID,
+    nsUrlClassifierHashCompleterConstructor },
+};
+
+NS_IMPL_NSGETMODULE(CHSafeBrowsingModule, components)
Index: safebrowsing/Makefile.in
===================================================================
RCS file: safebrowsing/Makefile.in
diff -N safebrowsing/Makefile.in
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ safebrowsing/Makefile.in	29 Jan 2009 03:50:41 -0000
@@ -0,0 +1,75 @@
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is just a lowly Makefile.
+#
+# The Initial Developer of the Original Code is Sean Murphy
+# Portions created by the Initial Developer are Copyright (C) 2008
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#  Sean Murphy <murph@seanmurph.com> (Original Author)
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+DEPTH     = ../..
+topsrcdir = @top_srcdir@
+srcdir    = @srcdir@
+VPATH     = @srcdir@
+
+include $(DEPTH)/config/autoconf.mk
+
+MODULE = camino
+LIBRARY_NAME = caminosafebrowsing
+SHORT_LIBNAME = caminosb
+EXPORT_LIBRARY = 1
+IS_COMPONENT = 1
+MODULE_NAME = CHSafeBrowsingModule
+LIBXUL_LIBRARY = 1
+
+REQUIRES = \
+  xpcom \
+  string \
+  docshell \
+  necko \
+  pipnss \
+  url-classifier \
+  $(NULL)
+
+CPPSRCS = CHSafeBrowsingModule.cpp
+
+LOCAL_INCLUDES = \
+  -I$(srcdir)/../../toolkit/components/url-classifier/src \
+  -I$(srcdir)/../../toolkit/components/build \
+  $(NULL)
+
+SHARED_LIBRARY_LIBS = ../../toolkit/components/url-classifier/src/$(LIB_PREFIX)urlclassifier_s.$(LIB_SUFFIX)
+
+EXTRA_DSO_LDOPTS = \
+  $(ZLIB_LIBS) \
+  $(MOZ_COMPONENT_LIBS) \
+  $(NULL)
+
+include $(topsrcdir)/config/rules.mk
Index: src/application/AppComponents.mm
===================================================================
RCS file: /cvsroot/mozilla/camino/src/application/AppComponents.mm,v
retrieving revision 1.18
diff -u -8 -r1.18 AppComponents.mm
--- src/application/AppComponents.mm	3 Oct 2007 12:27:07 -0000	1.18
+++ src/application/AppComponents.mm	29 Jan 2009 03:50:41 -0000
@@ -41,16 +41,17 @@
 #import "SecurityDialogs.h"
 #import "CocoaPromptService.h"
 #import "KeychainService.h"
 #import "nsDownloadListener.h"
 #import "ProgressDlgController.h"
 #import "nsAboutBookmarks.h"
 #import "CHStringBundleOverride.h"
 #import "ContentDispatchChooser.h"
+#import "SafeBrowsingAboutModule.h"
 
 #include "nsIGenericFactory.h"
 
 #include "nsSimpleGlobalHistory.h"
 
 // for some bizarre reason this is in nsDocShellCID.h
 #define NS_GLOBALHISTORY2_CONTRACTID \
     "@mozilla.org/browser/global-history;2"
@@ -263,16 +264,22 @@
     CHStringBundleOverrideConstructor
   },
   {
     "Content Dispatcher Service",
     NS_CONTENTDISPATCHCHOOSER_CID,
     NS_CONTENTDISPATCHCHOOSER_CONTRACTID,
     ContentDispatchChooserConstructor
   },
+  {
+    "Safe Browsing Blocked Module",
+    CH_SAFEBROWSING_ABOUT_MODULE_CID,
+    NS_ABOUT_MODULE_CONTRACTID_PREFIX "safebrowsingblocked",
+    CHSafeBrowsingAboutModule::CreateSafeBrowsingAboutModule,
+  },
 };
 
 
 const nsModuleComponentInfo* GetAppComponents ( unsigned int * outNumComponents )
 {
   *outNumComponents = sizeof(gAppComponents) / sizeof(nsModuleComponentInfo);
   return gAppComponents;
 }
Index: src/application/MainController.mm
===================================================================
RCS file: /cvsroot/mozilla/camino/src/application/MainController.mm,v
retrieving revision 1.279
diff -u -8 -r1.279 MainController.mm
--- src/application/MainController.mm	27 Jan 2009 04:33:11 -0000	1.279
+++ src/application/MainController.mm	29 Jan 2009 03:50:44 -0000
@@ -73,16 +73,17 @@
 #import "CertificatesWindowController.h"
 #import "PageInfoWindowController.h"
 #import "PreferenceManager.h"
 #import "SiteIconProvider.h"
 #import "SessionManager.h"
 #import "CHPermissionManager.h"
 #import "CmXULAppInfo.h"
 #import "AddSearchProviderHandler.h"
+#import "SafeBrowsingListManager.h"
 
 #include "nsCOMPtr.h"
 #include "nsEmbedAPI.h"
 #include "nsString.h"
 #include "nsStaticComponents.h"
 
 #include "nsIWebBrowserChrome.h"
 #include "nsIServiceManager.h"
@@ -117,16 +118,17 @@
 - (void)updateBookmarkMenuStateIncludingBookmarks:(BOOL)includeBookmarks;
 - (void)adjustTextEncodingMenu;
 - (void)windowLayeringDidChange:(NSNotification*)inNotification;
 - (void)bookmarkLoadingCompleted:(NSNotification*)inNotification;
 - (void)dockMenuBookmarkFolderChanged:(NSNotification*)inNotification;
 - (void)showCertificatesNotification:(NSNotification*)inNotification;
 - (void)openPanelDidEnd:(NSOpenPanel*)inOpenPanel returnCode:(int)inReturnCode contextInfo:(void*)inContextInfo;
 - (void)loadApplicationPage:(NSString*)pageURL;
+- (void)setUpSafeBrowsing;
 
 @end
 
 #pragma mark -
 
 @implementation MainController
 
 - (id)init
@@ -328,16 +330,17 @@
 }
 
 - (void)applicationDidFinishLaunching:(NSNotification*)aNotification
 {
   [self ensureInitializationCompleted];
 
   [self checkForProblemAddOns];
   [self prelaunchHelperApps];
+  [self setUpSafeBrowsing];
 
   // open a new browser window if we don't already have one or we have a specific
   // start URL we need to show
   NSWindow* browserWindow = [self frontmostBrowserWindow];
   if (!browserWindow || mStartURL)
     [self newWindow:self];
 
   // delay the default browser check to give the first page time to load
@@ -675,16 +678,24 @@
 {
   // the bookmarks menus get built lazily (by BookmarkMenu)
   [mBookmarksMenu setBookmarkFolder:[[BookmarkManager sharedBookmarkManager] bookmarkMenuFolder]];
 
   // dock bookmarks
   [self updateDockMenuBookmarkFolder];
 }
 
+- (void)setUpSafeBrowsing
+{
+  SafeBrowsingListManager *safeBrowsingService = [SafeBrowsingListManager sharedInstance];
+  [safeBrowsingService registerListWithName:@"goog-phish-shavar" type:eSafeBrowsingPhishingListType];
+  [safeBrowsingService registerListWithName:@"goog-malware-shavar" type:eSafeBrowsingMalwareListType];
+  [safeBrowsingService enableUpdateCheckingAccordingToPrefs];
+}
+
 #pragma mark -
 #pragma mark Window Accesssors
 
 - (NSArray*)browserWindows
 {
   NSEnumerator* windowEnum = [[NSApp orderedWindows] objectEnumerator];
   NSMutableArray* windowArray = [NSMutableArray array];
 
Index: src/browser/BrowserWindowController.mm
===================================================================
RCS file: /cvsroot/mozilla/camino/src/browser/BrowserWindowController.mm,v
retrieving revision 1.395
diff -u -8 -r1.395 BrowserWindowController.mm
--- src/browser/BrowserWindowController.mm	28 Jan 2009 21:35:52 -0000	1.395
+++ src/browser/BrowserWindowController.mm	29 Jan 2009 03:50:51 -0000
@@ -5129,16 +5129,32 @@
     [mSearchBar setEditable:NO];
   }
   else {
     [mURLBar setEditable:YES];
     [mSearchBar setEditable:YES];
   }
 }
 
+- (void)runAwayFromSafeBrowsingBlockedSite
+{
+  if ([[mBrowserView browserView] canGoBack])
+    [self back:self];
+  else
+    [self home:self];
+}
+
+- (void)showSafeBrowsingInformation
+{
+  NSString *blockingInformationURL = 
+    [[PreferenceManager sharedInstance] getStringPref:kGeckoPrefSafeBrowsingInformationURL 
+                                          withSuccess:NULL];
+  [self loadURL:blockingInformationURL referrer:nil focusContent:YES allowPopups:NO];  
+}
+
 @end
 
 #pragma mark -
 
 @implementation ThrobberHandler
 
 -(id)initWithToolbarItem:(NSToolbarItem*)inButton images:(NSArray*)inImages
 {
Index: src/browser/BrowserWrapper.h
===================================================================
RCS file: /cvsroot/mozilla/camino/src/browser/BrowserWrapper.h,v
retrieving revision 1.65
diff -u -8 -r1.65 BrowserWrapper.h
--- src/browser/BrowserWrapper.h	16 Dec 2008 03:00:57 -0000	1.65
+++ src/browser/BrowserWrapper.h	29 Jan 2009 03:50:52 -0000
@@ -77,16 +77,20 @@
 - (void)blacklistPopupsFromURL:(NSString*)inURL;
 
 - (void)addCertificateOverrideForSite:(NSString*)url;
 
 - (BOOL)userChangedLocationField;
 
 - (void)contentViewChangedTo:(NSView*)inView forURL:(NSString*)inURL;
 
+// Called when the user clicks buttons on the about:safebrowsingblocked error page.
+- (void)runAwayFromSafeBrowsingBlockedSite;
+- (void)showSafeBrowsingInformation;
+
 @end
 
 //
 // The BrowserWrapper requests UI to be created via this delegate. Unlike the
 // |BrowserUIDelegate|, this delegate is always present even when in a 
 // background tab.
 //
 @protocol BrowserUICreationDelegate
Index: src/browser/BrowserWrapper.mm
===================================================================
RCS file: /cvsroot/mozilla/camino/src/browser/BrowserWrapper.mm,v
retrieving revision 1.149
diff -u -8 -r1.149 BrowserWrapper.mm
--- src/browser/BrowserWrapper.mm	16 Dec 2008 03:00:58 -0000	1.149
+++ src/browser/BrowserWrapper.mm	29 Jan 2009 03:50:54 -0000
@@ -1047,18 +1047,36 @@
 
   [self performCommandForXULElementWithID:elementID onPage:documentURI];
 }
 
 // The pageURI is supplied because it might differ from -[self currentURI], particularly
 // if the command was sent from an error page overlay.
 - (void)performCommandForXULElementWithID:(NSString*)elementIdentifier onPage:(NSString*)pageURI
 {
-  if ([elementIdentifier isEqualToString:@"exceptionDialogButton"])
+  if ([elementIdentifier isEqualToString:@"exceptionDialogButton"]) {
     [mDelegate addCertificateOverrideForSite:[self currentURI]];
+  }
+  else if ([pageURI hasPrefix:@"about:safebrowsingblocked"]) {
+    if ([elementIdentifier isEqualToString:@"getMeOutButton"]) {
+      [mDelegate runAwayFromSafeBrowsingBlockedSite];
+    }
+    else if ([elementIdentifier isEqualToString:@"ignoreWarningButton"]) {
+      [self loadURI:[self currentURI] 
+           referrer:nil 
+              flags:NSLoadFlagsBypassClassifier 
+       focusContent:YES 
+        allowPopups:NO];
+    }
+    else if ([elementIdentifier isEqualToString:@"whyBlockedButton"]) {
+      // Note: pageURI can be examined for e=phishingBlocked or e=malwareBlocked
+      // to customize the blocking info location for each case...
+      [mDelegate showSafeBrowsingInformation];
+    }
+  }
 }
 
 - (BOOL)performKeyEquivalent:(NSEvent*)theEvent
 {
   // Catch Command-back/forward, and map them to history back/forward unless
   // there is a text area or plugin focused in the Gecko view.
   if ((([theEvent modifierFlags] & NSDeviceIndependentModifierFlagsMask) ==
        (NSCommandKeyMask | NSNumericPadKeyMask | NSFunctionKeyMask)) &&
Index: src/embedding/CHBrowserView.h
===================================================================
RCS file: /cvsroot/mozilla/camino/src/embedding/CHBrowserView.h,v
retrieving revision 1.60
diff -u -8 -r1.60 CHBrowserView.h
--- src/embedding/CHBrowserView.h	16 Dec 2008 03:00:59 -0000	1.60
+++ src/embedding/CHBrowserView.h	29 Jan 2009 03:50:54 -0000
@@ -151,17 +151,18 @@
 
 @end
 
 enum {
   NSLoadFlagsNone                   = 0x0000,
   NSLoadFlagsDontPutInHistory       = 0x0010,
   NSLoadFlagsReplaceHistoryEntry    = 0x0020,
   NSLoadFlagsBypassCacheAndProxy    = 0x0040,
-  NSLoadFlagsAllowThirdPartyFixup   = 0x2000
+  NSLoadFlagsAllowThirdPartyFixup   = 0x2000,
+  NSLoadFlagsBypassClassifier       = 0x10000
 }; 
 
 enum {
   NSStopLoadNetwork   = 0x01,
   NSStopLoadContent   = 0x02,
   NSStopLoadAll       = 0x03  
 };
 
Index: src/embedding/CHBrowserView.mm
===================================================================
RCS file: /cvsroot/mozilla/camino/src/embedding/CHBrowserView.mm,v
retrieving revision 1.114
diff -u -8 -r1.114 CHBrowserView.mm
--- src/embedding/CHBrowserView.mm	22 Jan 2009 19:36:56 -0000	1.114
+++ src/embedding/CHBrowserView.mm	29 Jan 2009 03:50:57 -0000
@@ -430,16 +430,19 @@
   }
   if (flags & NSLoadFlagsBypassCacheAndProxy) {
     navFlags |= nsIWebNavigation::LOAD_FLAGS_BYPASS_CACHE | 
                 nsIWebNavigation::LOAD_FLAGS_BYPASS_PROXY;
   }
   if (flags & NSLoadFlagsAllowThirdPartyFixup) {
     navFlags |= nsIWebNavigation::LOAD_FLAGS_ALLOW_THIRD_PARTY_FIXUP;
   }
+  if (flags & NSLoadFlagsBypassClassifier) {
+    navFlags |= nsIWebNavigation::LOAD_FLAGS_BYPASS_CLASSIFIER;
+  }
 
   nsresult rv = nav->LoadURI(specStr.get(), navFlags, referrerURI, nsnull, nsnull);
   if (NS_FAILED(rv)) {
     // XXX need to throw
   }
 }
 
 - (void)reload:(unsigned int)flags
Index: src/preferences/GeckoPrefConstants.h
===================================================================
RCS file: /cvsroot/mozilla/camino/src/preferences/GeckoPrefConstants.h,v
retrieving revision 1.4
diff -u -8 -r1.4 GeckoPrefConstants.h
--- src/preferences/GeckoPrefConstants.h	2 Jan 2009 19:24:25 -0000	1.4
+++ src/preferences/GeckoPrefConstants.h	29 Jan 2009 03:50:57 -0000
@@ -308,9 +308,22 @@
 extern const char* const kGeckoPrefUserAgentLocale;                    // string
 
 // A user override for the automatically-determined kGeckoPrefUserAgentLocale
 extern const char* const kGeckoPrefUserAgentLocaleOverride;            // string
 
 // An extra suffix for the user agent identifying the multilingual build
 extern const char* const kGeckoPrefUserAgentMultiLangAddition;         // string
 
+#pragma mark Safe Browsing
+
+extern NSString* const kGeckoPrefSafeBrowsingDataProviderName;          // string
+extern NSString* const kGeckoPrefSafeBrowsingDataProviderUpdateURL;     // string
+extern NSString* const kGeckoPrefSafeBrowsingDataProviderKeyURL;        // string
+extern NSString* const kGeckoPrefSafeBrowsingDataProviderReportURL;     // string
+extern NSString* const kGeckoPrefSafeBrowsingDataProviderGetHashURL;    // string
+
+extern const char* const kGeckoPrefSafeBrowsingInformationURL;          // string
+extern const char* const kGeckoPrefSafeBrowsingPhishingCheckingEnabled; // bool
+extern const char* const kGeckoPrefSafeBrowsingMalwareCheckingEnabled;  // bool
+extern const char* const kGeckoPrefSafeBrowsingDataProvider;            // int
+
 #pragma GCC visibility pop
Index: src/preferences/GeckoPrefConstants.mm
===================================================================
RCS file: /cvsroot/mozilla/camino/src/preferences/GeckoPrefConstants.mm,v
retrieving revision 1.4
diff -u -8 -r1.4 GeckoPrefConstants.mm
--- src/preferences/GeckoPrefConstants.mm	2 Jan 2009 19:24:25 -0000	1.4
+++ src/preferences/GeckoPrefConstants.mm	29 Jan 2009 03:50:57 -0000
@@ -195,16 +195,29 @@
 
 #pragma mark User Agent
 
 const char* const kGeckoPrefUserAgentAppVersion = "general.useragent.vendorSub";
 const char* const kGeckoPrefUserAgentLocale = "general.useragent.locale";
 const char* const kGeckoPrefUserAgentLocaleOverride = "camino.useragent.locale";
 const char* const kGeckoPrefUserAgentMultiLangAddition = "general.useragent.extra.multilang";
 
+#pragma mark Safe Browsing
+
+NSString* const kGeckoPrefSafeBrowsingDataProviderName = @"browser.safebrowsing.provider.%i.name";
+NSString* const kGeckoPrefSafeBrowsingDataProviderUpdateURL = @"browser.safebrowsing.provider.%i.updateURL";
+NSString* const kGeckoPrefSafeBrowsingDataProviderKeyURL = @"browser.safebrowsing.provider.%i.keyURL";
+NSString* const kGeckoPrefSafeBrowsingDataProviderReportURL = @"browser.safebrowsing.provider.%i.reportURL";
+NSString* const kGeckoPrefSafeBrowsingDataProviderGetHashURL = @"browser.safebrowsing.provider.%i.gethashURL";
+
+const char* const kGeckoPrefSafeBrowsingInformationURL = "browser.safebrowsing.warning.infoURL";
+const char* const kGeckoPrefSafeBrowsingPhishingCheckingEnabled = "browser.safebrowsing.enabled";
+const char* const kGeckoPrefSafeBrowsingMalwareCheckingEnabled = "browser.safebrowsing.malware.enabled";
+const char* const kGeckoPrefSafeBrowsingDataProvider = "browser.safebrowsing.dataProvider";
+
 #pragma mark -
 #pragma mark Values
 
 // kGeckoPrefExternalLoadBehavior values
 const int kExternalLoadOpensNewWindow = 0;
 const int kExternalLoadOpensNewTab    = 1;
 const int kExternalLoadReusesWindow   = 2;
 
Index: src/safebrowsing/SafeBrowsingAboutModule.h
===================================================================
RCS file: src/safebrowsing/SafeBrowsingAboutModule.h
diff -N src/safebrowsing/SafeBrowsingAboutModule.h
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ src/safebrowsing/SafeBrowsingAboutModule.h	29 Jan 2009 03:50:58 -0000
@@ -0,0 +1,65 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Camino code.
+ *
+ * The Initial Developer of the Original Code is
+ * Sean Murphy.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Sean Murphy <murph@seanmurph.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#ifndef CHSafeBrowsingAboutModule_h__
+#define CHSafeBrowsingAboutModule_h__
+
+#include "nsIAboutModule.h"
+
+//
+// CHSafeBrowsingAboutModule
+//
+// An nsIAboutModule for the "about:safebrowsingblocked" error page.
+//
+class CHSafeBrowsingAboutModule : public nsIAboutModule
+{
+ public:
+  NS_DECL_ISUPPORTS
+  NS_DECL_NSIABOUTMODULE
+
+  CHSafeBrowsingAboutModule() {}
+  virtual ~CHSafeBrowsingAboutModule() {}
+
+  static NS_METHOD CreateSafeBrowsingAboutModule(nsISupports *aOuter, REFNSIID aIID, void **aResult);    
+};
+
+/* EDF643A9-8B38-472C-92A0-B6 3B EF B3 07 69 */
+#define CH_SAFEBROWSING_ABOUT_MODULE_CID \
+{ 0xEDF643A9, 0xB38, 0x472C, \
+{ 0x92, 0xA0, 0xB6, 0x3B, 0xEF, 0xB3, 0x07, 0x69}}
+
+#endif // CHSafeBrowsingAboutModule_h__
Index: src/safebrowsing/SafeBrowsingAboutModule.mm
===================================================================
RCS file: src/safebrowsing/SafeBrowsingAboutModule.mm
diff -N src/safebrowsing/SafeBrowsingAboutModule.mm
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ src/safebrowsing/SafeBrowsingAboutModule.mm	29 Jan 2009 03:50:58 -0000
@@ -0,0 +1,115 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Camino code.
+ *
+ * The Initial Developer of the Original Code is
+ * Sean Murphy.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Sean Murphy <murph@seanmurph.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#import <Cocoa/Cocoa.h>
+#include "SafeBrowsingAboutModule.h"
+
+#include "nsCOMPtr.h"
+#include "nsIChannel.h"
+#include "nsIIOService.h"
+#include "nsIServiceManager.h"
+#include "nsNetCID.h"
+#include "nsString.h"
+#include "nsIScriptSecurityManager.h"
+#include "nsIPrincipal.h"
+
+#define BLOCKED_PAGE_CHROME_URL "chrome://global/locale/safebrowsing/blockedSite.xhtml"
+
+NS_IMPL_ISUPPORTS1(CHSafeBrowsingAboutModule, nsIAboutModule)
+
+NS_IMETHODIMP
+CHSafeBrowsingAboutModule::NewChannel(nsIURI *aURI, nsIChannel **result)
+{
+  NS_ENSURE_ARG_POINTER(aURI);
+  NS_ASSERTION(result, "must not be null");
+
+  nsresult rv;
+
+  nsCOMPtr<nsIIOService> ioService = do_GetService(NS_IOSERVICE_CONTRACTID, &rv);
+  if (NS_FAILED(rv))
+    return rv;
+
+  nsCAutoString blockedSitePageURL;
+  blockedSitePageURL.AssignLiteral(BLOCKED_PAGE_CHROME_URL);
+
+  nsCOMPtr<nsIChannel> blockedSiteChannel;
+  rv = ioService->NewChannel(blockedSitePageURL, "UTF8", aURI, getter_AddRefs(blockedSiteChannel));
+  if (NS_FAILED(rv))
+    return rv;
+
+  blockedSiteChannel->SetOriginalURI(aURI);
+
+  nsCOMPtr<nsIScriptSecurityManager> securityManager = 
+    do_GetService(NS_SCRIPTSECURITYMANAGER_CONTRACTID, &rv);
+  if (NS_FAILED(rv))
+    return rv;
+
+  nsCOMPtr<nsIPrincipal> principal;
+  rv = securityManager->GetCodebasePrincipal(aURI, getter_AddRefs(principal));
+  if (NS_FAILED(rv))
+    return rv;
+
+  rv = blockedSiteChannel->SetOwner(principal);
+  if (NS_FAILED(rv))
+    return rv;
+
+  *result = blockedSiteChannel;
+  NS_ADDREF(*result);
+  return NS_OK;
+}
+
+NS_IMETHODIMP
+CHSafeBrowsingAboutModule::GetURIFlags(nsIURI *aURI, PRUint32 *result)
+{
+  // Since bad sites can cause this page to appear (e.g. by having an iframe pointing to 
+  // another blacklisted site), we should allow URI_SAFE_FOR_UNTRUSTED_CONTENT.
+
+  *result = nsIAboutModule::ALLOW_SCRIPT | nsIAboutModule::URI_SAFE_FOR_UNTRUSTED_CONTENT;
+  return NS_OK;
+}
+
+NS_METHOD
+CHSafeBrowsingAboutModule::CreateSafeBrowsingAboutModule(nsISupports *aOuter, REFNSIID aIID, void **aResult)
+{
+  CHSafeBrowsingAboutModule *aboutModule = new CHSafeBrowsingAboutModule();
+  if (aboutModule == nsnull)
+    return NS_ERROR_OUT_OF_MEMORY;
+  NS_ADDREF(aboutModule);
+  nsresult rv = aboutModule->QueryInterface(aIID, aResult);
+  NS_RELEASE(aboutModule);
+  return rv;
+}
Index: src/safebrowsing/SafeBrowsingListManager.h
===================================================================
RCS file: src/safebrowsing/SafeBrowsingListManager.h
diff -N src/safebrowsing/SafeBrowsingListManager.h
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ src/safebrowsing/SafeBrowsingListManager.h	29 Jan 2009 03:50:58 -0000
@@ -0,0 +1,119 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Camino code.
+ *
+ * The Initial Developer of the Original Code is
+ * Sean Murphy.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Sean Murphy <murph@seanmurph.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#import <Cocoa/Cocoa.h>
+
+class nsIUrlListManager;
+
+// Used to specify a type of list which can be obtained from the data provider.
+typedef enum {
+  eSafeBrowsingPhishingListType = (1 << 0),
+  eSafeBrowsingMalwareListType  = (1 << 1),
+  eSafeBrowsingAnyListType      = 0xFFFFFFFF
+} ESafeBrowsingListType;
+
+// A bit mask specifying a combination of |ESafeBrowsingListType| values.
+typedef int SafeBrowsingListTypesMask;
+
+#pragma mark -
+
+//
+// SafeBrowsingList
+//
+// Simple data object used by the SafeBrowsingListManager 
+// to represent a data provider list.
+//
+@interface SafeBrowsingList : NSObject
+{
+ @private
+  NSString              *mName;
+  ESafeBrowsingListType  mType;
+}
+
++ (id)listWithName:(NSString *)aName type:(ESafeBrowsingListType)aType;
+- (id)initWithName:(NSString *)aName type:(ESafeBrowsingListType)aType;
+
+- (NSString *)name;
+- (void)setName:(NSString *)aName;
+- (ESafeBrowsingListType)type;
+- (void)setType:(ESafeBrowsingListType)aListType;
+
+@end
+
+#pragma mark -
+
+//
+// SafeBrowsingListManager
+//
+// A shared object offering control over the maintenance and update process of the
+// local database of safe browsing information, which is populated from lists made 
+// available by remote data providers. Data provider properties are stored in Gecko's
+// preferences.
+//
+//
+@interface SafeBrowsingListManager : NSObject
+{
+ @private
+  nsIUrlListManager *mListManager;               // strong
+  NSMutableArray    *mRegisteredLists;           // strong; An array of SafeBrowsingList objects.
+}
+
++ (SafeBrowsingListManager *)sharedInstance;
+
+// The SafeBrowsingListManager will determine which list types to enable updates on based
+// on current preference values.
+- (void)enableUpdateCheckingAccordingToPrefs;
+
+// |listTypesMask| should contain |ESafeBrowsingListType| values combined with the C bitwise
+// OR operator.
+- (void)enableUpdateCheckingForListTypes:(SafeBrowsingListTypesMask)aListTypesMask;
+- (void)disableUpdateCheckingForListTypes:(SafeBrowsingListTypesMask)aListTypesMask;
+- (void)disableAllUpdateChecking;
+
+// Calling this method with |eSafeBrowsingAnyListType| will return YES if update checking
+// is enabled for at least one list type.
+- (BOOL)updatesAreEnabledInPrefsForListType:(ESafeBrowsingListType)aListType;
+
+// Registered lists are fetched from the data provider during each update cycle.
+- (void)registerListWithName:(NSString *)aListName type:(ESafeBrowsingListType)aListType;
+- (void)unregisterListWithName:(NSString *)aListName;
+
+// While update checks are performed periodically on enabled lists, this method forces a manual
+// check to take place immediately.
+- (void)checkForUpdates;
+
+@end
Index: src/safebrowsing/SafeBrowsingListManager.mm
===================================================================
RCS file: src/safebrowsing/SafeBrowsingListManager.mm
diff -N src/safebrowsing/SafeBrowsingListManager.mm
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ src/safebrowsing/SafeBrowsingListManager.mm	29 Jan 2009 03:50:59 -0000
@@ -0,0 +1,438 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Camino code.
+ *
+ * The Initial Developer of the Original Code is
+ * Sean Murphy.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Sean Murphy <murph@seanmurph.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#import "SafeBrowsingListManager.h"
+#import "PreferenceManager.h"
+#import "GeckoPrefConstants.h"
+#import "CmXULAppInfo.h"
+#import "NSString+Gecko.h"
+#import "NSString+Utils.h"
+#import "CHBrowserService.h"
+
+#include "nsIUrlClassifierDBService.h"
+#include "nsIUrlListManager.h"
+#include "nsCOMPtr.h"
+#include "nsIServiceManager.h"
+#include "nsString.h"
+
+@implementation SafeBrowsingList
+
++ (id)listWithName:(NSString *)aName type:(ESafeBrowsingListType)aType
+{
+  return [[[self alloc] initWithName:aName type:aType] autorelease];
+}
+
+- (id)initWithName:(NSString *)aName type:(ESafeBrowsingListType)aType
+{
+  if ((self = [super init])) {
+    [self setName:aName];
+    [self setType:aType];
+  }
+  return self;
+}
+
+- (void)dealloc
+{
+  [self setName:nil];
+  [super dealloc];
+}
+
+- (NSString *)name
+{
+  return [[mName retain] autorelease]; 
+}
+
+- (void)setName:(NSString *)aName
+{
+  if (mName != aName) {
+    [mName release];
+    mName = [aName copy];
+  }
+}
+
+- (ESafeBrowsingListType)type
+{
+  return mType;
+}
+
+- (void)setType:(ESafeBrowsingListType)aListType
+{
+  mType = aListType;
+}
+
+@end
+
+#pragma mark -
+
+@interface SafeBrowsingListManager (Private)
+
+- (void)setInitialDataProviderValuesFromPreferences;
+- (void)getDataProviderURLPref:(nsACString&)outPrefValue forKey:(NSString *)aKeyTemplate usingProviderID:(int)aProviderID;
+- (void)registerObservationOfSafeBrowsingPreferences;
+- (void)establishSecureKeyWithDataProvider;
+- (void)reRegisterAllLists;
+- (void)setUpdatesAreEnabled:(BOOL)aShouldEnableUpdates forListTypes:(SafeBrowsingListTypesMask)aListTypesToChange;
+- (int)preferredDataProviderIdentifier;
+
+@end
+
+#pragma mark -
+
+@implementation SafeBrowsingListManager
+
++ (SafeBrowsingListManager *)sharedInstance
+{
+  static SafeBrowsingListManager *sharedSafeBrowsingService = nil;
+  if (!sharedSafeBrowsingService)
+    sharedSafeBrowsingService = [[SafeBrowsingListManager alloc] init];
+
+  return sharedSafeBrowsingService;
+}
+
+- (id)init
+{
+  self = [super init];
+  if (self) {
+    nsresult rv;
+    nsCOMPtr<nsIUrlListManager> listManager = do_GetService("@mozilla.org/url-classifier/listmanager;1", &rv);
+    if (NS_FAILED(rv)) {
+      NSLog(@"Error initializing SafeBrowsingListManager: Failed to get the '@mozilla.org/url-classifier/listmanager' service");
+      [self release];
+      return nil;
+    }
+    mListManager = listManager;
+    NS_IF_ADDREF(mListManager);
+
+    mRegisteredLists = [[NSMutableArray alloc] init];
+
+    // Register for xpcom shutdown so we know if the list manager goes away.
+    [[NSNotificationCenter defaultCenter] addObserver:self
+                                             selector:@selector(xpcomShutdown:)
+                                                 name:XPCOMShutDownNotificationName
+                                               object:nil];
+
+    [self registerObservationOfSafeBrowsingPreferences];
+    [self setInitialDataProviderValuesFromPreferences];
+  }
+  return self;
+}
+
+- (void)dealloc
+{
+  NS_IF_RELEASE(mListManager);
+
+  [[NSNotificationCenter defaultCenter] removeObserver:self];
+  [[PreferenceManager sharedInstance] removeObserver:self];
+
+  [mRegisteredLists release];
+  [super dealloc];
+}
+
+- (void)xpcomShutdown:(NSNotification *)notification
+{
+  // This nulls out the pointer
+  NS_IF_RELEASE(mListManager);
+}
+
+#pragma mark -
+
+- (void)registerObservationOfSafeBrowsingPreferences
+{
+  [[NSNotificationCenter defaultCenter] addObserver:self 
+                                           selector:@selector(safeBrowsingPrefChanged:) 
+                                               name:kPrefChangedNotificationName 
+                                             object:self];
+
+  [[PreferenceManager sharedInstance] addObserver:self 
+                                          forPref:kGeckoPrefSafeBrowsingPhishingCheckingEnabled];
+  [[PreferenceManager sharedInstance] addObserver:self 
+                                          forPref:kGeckoPrefSafeBrowsingMalwareCheckingEnabled];                                          
+  [[PreferenceManager sharedInstance] addObserver:self 
+                                          forPref:kGeckoPrefSafeBrowsingDataProvider];  
+}
+
+// Important: A side-effect of setting these initial provider values is that the
+// underlying nsIUrlListManager will drop knowledge of any lists it is managing.
+// Call |reRegisterAllLists| to re-register them with the nsIUrlListManager.
+- (void)setInitialDataProviderValuesFromPreferences
+{
+  if (!mListManager) 
+    return;
+
+  int providerID = [self preferredDataProviderIdentifier];
+
+  nsCAutoString updateURL;
+  [self getDataProviderURLPref:updateURL
+                        forKey:kGeckoPrefSafeBrowsingDataProviderUpdateURL 
+               usingProviderID:providerID];
+  mListManager->SetUpdateUrl(updateURL);
+
+  nsCAutoString getHashURL;
+  [self getDataProviderURLPref:getHashURL 
+                        forKey:kGeckoPrefSafeBrowsingDataProviderGetHashURL 
+               usingProviderID:providerID];
+  mListManager->SetGethashUrl(getHashURL);
+}
+
+// Initializes a secure MAC with the data provider, which is used to decrypt list data. 
+// This value is not applied in |setInitialDataProviderValuesFromPreferences| because communication 
+// with the provider's server is required to set it, making it preferable to do so only when
+// safe browsing is enabled by the user. This method will not clear any registered lists.
+- (void)establishSecureKeyWithDataProvider
+{
+  nsCAutoString keyURL;
+  [self getDataProviderURLPref:keyURL
+                        forKey:kGeckoPrefSafeBrowsingDataProviderKeyURL
+               usingProviderID:[self preferredDataProviderIdentifier]];
+  mListManager->SetKeyUrl(keyURL);
+}
+
+- (void)getDataProviderURLPref:(nsACString&)outPrefValue
+                        forKey:(NSString *)keyTemplate
+               usingProviderID:(int)providerID
+{
+  // Insert the providerID into the preference key template.
+  NSString *prefKeyForProvider = [NSString stringWithFormat:keyTemplate,
+                                                            providerID];
+  NSString *urlPrefTemplate = [[PreferenceManager sharedInstance] getStringPref:[prefKeyForProvider UTF8String]
+                                                                    withSuccess:NULL];
+  // Fill in certain URL parameter tokens with values.
+  NSMutableString *urlPref = [[urlPrefTemplate mutableCopy] autorelease];
+  [urlPref replaceOccurrencesOfString:@"{moz:client}" 
+                           withString:[XULAppInfo name]
+                              options:NULL
+                                range:NSMakeRange(0, [urlPref length])];
+
+  [urlPref replaceOccurrencesOfString:@"{moz:version}"
+                           withString:[XULAppInfo version] 
+                              options:NULL 
+                                range:NSMakeRange(0, [urlPref length])];
+
+  outPrefValue.Assign([urlPref UTF8String]);
+}
+
+- (int)preferredDataProviderIdentifier
+{
+  PreferenceManager *prefManager = [PreferenceManager sharedInstance];
+  BOOL prefFetchSuccess = NO;
+  int providerID = [prefManager getIntPref:kGeckoPrefSafeBrowsingDataProvider 
+                               withSuccess:&prefFetchSuccess];
+  if (!prefFetchSuccess)
+    providerID = 0;
+
+  return providerID;
+}
+
+#pragma mark -
+
+- (BOOL)updatesAreEnabledInPrefsForListType:(ESafeBrowsingListType)aListType
+{
+  PreferenceManager *prefManager = [PreferenceManager sharedInstance];
+
+  switch (aListType) {
+    case eSafeBrowsingPhishingListType:
+      return [prefManager getBooleanPref:kGeckoPrefSafeBrowsingPhishingCheckingEnabled 
+                             withSuccess:NULL];
+    case eSafeBrowsingMalwareListType:
+      return [prefManager getBooleanPref:kGeckoPrefSafeBrowsingMalwareCheckingEnabled 
+                             withSuccess:NULL];
+    case eSafeBrowsingAnyListType:
+      return ([self updatesAreEnabledInPrefsForListType:eSafeBrowsingMalwareListType] ||
+              [self updatesAreEnabledInPrefsForListType:eSafeBrowsingPhishingListType]);
+    default:
+      return NO;
+  }
+}
+
+- (void)enableUpdateCheckingAccordingToPrefs
+{
+  SafeBrowsingListTypesMask enabledListTypes = 0;
+
+  if ([self updatesAreEnabledInPrefsForListType:eSafeBrowsingPhishingListType])
+    enabledListTypes |= eSafeBrowsingPhishingListType;
+  if ([self updatesAreEnabledInPrefsForListType:eSafeBrowsingMalwareListType])
+    enabledListTypes |= eSafeBrowsingMalwareListType;
+
+  [self enableUpdateCheckingForListTypes:enabledListTypes];
+}
+
+- (void)enableUpdateCheckingForListTypes:(SafeBrowsingListTypesMask)aListTypesMask
+{
+  // Only set the key URL when updates will be enabled.
+  [self establishSecureKeyWithDataProvider];
+  [self setUpdatesAreEnabled:YES forListTypes:aListTypesMask];
+}
+
+- (void)disableUpdateCheckingForListTypes:(SafeBrowsingListTypesMask)aListTypesMask
+{
+  [self setUpdatesAreEnabled:NO forListTypes:aListTypesMask];
+}
+
+- (void)disableAllUpdateChecking
+{
+  [self setUpdatesAreEnabled:NO forListTypes:eSafeBrowsingAnyListType];
+}
+
+- (void)checkForUpdates
+{
+  if (!mListManager) 
+    return;
+
+  mListManager->CheckForUpdates();
+}
+
+#pragma mark -
+
+- (void)registerListWithName:(NSString *)aListName type:(ESafeBrowsingListType)aListType
+{
+  if (!mListManager)
+    return;
+
+  if ([aListName length] < 0 || !aListType)
+    return;
+
+  // Ensure we aren't already managing this list already. (Names are unique within
+  // a given data provider, so we don't need to check both name and type).
+  NSEnumerator *registeredListEnum = [mRegisteredLists objectEnumerator];
+  SafeBrowsingList *currentList = nil;
+  while ((currentList = [registeredListEnum nextObject])) {
+    if ([aListName isEqualToString:[currentList name]])
+      return;
+  }
+
+  nsCAutoString listName;
+  listName.Assign([aListName UTF8String]);
+  PRBool registerSuccess = PR_FALSE;
+  mListManager->RegisterTable(listName, PR_FALSE, &registerSuccess);
+  if (!registerSuccess) {
+    NSLog(@"Warning: SafeBrowsingListManager failed to register list: %@", aListName);
+    return;
+  }
+
+  SafeBrowsingList *newList = [SafeBrowsingList listWithName:aListName type:aListType];
+  [mRegisteredLists addObject:newList];
+}
+
+- (void)unregisterListWithName:(NSString *)aListName
+{
+  if (!mListManager) 
+    return;
+
+  // Enumerate a copy, since we'll be removing an object from the array.
+  NSArray *registeredListsCopy = [[mRegisteredLists copy] autorelease];
+  NSEnumerator *registeredListEnum = [registeredListsCopy objectEnumerator];
+  SafeBrowsingList *currentList = nil;
+  while ((currentList = [registeredListEnum nextObject])) {
+    if ([[currentList name] isEqualToString:aListName]) {
+      [mRegisteredLists removeObject:currentList];
+
+      // There's no API to actually unregister the table with the list manager, 
+      // so just disable its updates. Updates will never be enabled until it is
+      // re-registered with us again.
+      nsCAutoString listName;
+      listName.Assign([aListName UTF8String]);
+      mListManager->DisableUpdate(listName);
+      return;
+    }
+  }
+  NSLog(@"Warning: SafeBrowsingListManager failure to unregister; not managing a list named: %@", aListName); 
+}
+
+#pragma mark -
+
+- (void)setUpdatesAreEnabled:(BOOL)aShouldEnableUpdates
+                forListTypes:(SafeBrowsingListTypesMask)aListTypesToChange
+{
+  if (!mListManager) 
+    return;
+
+  NSEnumerator *registeredListEnum = [mRegisteredLists objectEnumerator];
+  SafeBrowsingList *currentList = nil;
+  while ((currentList = [registeredListEnum nextObject])) {
+    if (aListTypesToChange & [currentList type]) {
+      nsCAutoString listName;
+      listName.Assign([[currentList name] UTF8String]);
+      if (aShouldEnableUpdates)
+        mListManager->EnableUpdate(listName);
+      else
+        mListManager->DisableUpdate(listName);
+    }
+  }
+}
+
+// Registers lists we are in charge of with the underlying nsIUrlListManager again.
+- (void)reRegisterAllLists
+{
+  if (!mListManager) 
+    return;
+
+  NSEnumerator *registeredListEnum = [mRegisteredLists objectEnumerator];
+  SafeBrowsingList *currentList = nil;
+  while ((currentList = [registeredListEnum nextObject])) {
+    nsCAutoString listName;
+    listName.Assign([[currentList name] UTF8String]);
+    PRBool registerSuccess = PR_FALSE;
+    mListManager->RegisterTable(listName, PR_FALSE, &registerSuccess);
+    if (!registerSuccess)
+      NSLog(@"Warning: SafeBrowsingListManager failed to re-register list: %@", [currentList name]);
+  }
+}
+
+#pragma mark -
+
+static const int kStringComparisonEqual = 0;
+
+- (void)safeBrowsingPrefChanged:(NSNotification *)notification
+{
+  const char *changedPrefKey = [[[notification userInfo] objectForKey:kPrefChangedPrefNameUserInfoKey] UTF8String];
+
+  if (strcmp(changedPrefKey, kGeckoPrefSafeBrowsingPhishingCheckingEnabled) == kStringComparisonEqual) {
+    [self setUpdatesAreEnabled:[self updatesAreEnabledInPrefsForListType:eSafeBrowsingPhishingListType]
+                  forListTypes:eSafeBrowsingPhishingListType];
+  }
+  else if (strcmp(changedPrefKey, kGeckoPrefSafeBrowsingMalwareCheckingEnabled) == kStringComparisonEqual) {
+    [self setUpdatesAreEnabled:[self updatesAreEnabledInPrefsForListType:eSafeBrowsingMalwareListType]
+                  forListTypes:eSafeBrowsingMalwareListType];
+  }
+  else if (strcmp(changedPrefKey, kGeckoPrefSafeBrowsingDataProvider) == kStringComparisonEqual) {
+    [self setInitialDataProviderValuesFromPreferences];
+    [self reRegisterAllLists];
+    [self enableUpdateCheckingAccordingToPrefs];
+  }
+}
+
+@end
