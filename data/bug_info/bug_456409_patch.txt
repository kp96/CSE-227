From: timeless@mozdev.org

Bug 456409 GetSlotWithMechanism leaks slot list element in several path
Handle OOM relating to PK11_GetFirstSafe/PK11_FreeSlotListElement

diff --git a/security/manager/ssl/src/nsKeygenHandler.cpp b/security/manager/ssl/src/nsKeygenHandler.cpp
--- a/security/manager/ssl/src/nsKeygenHandler.cpp
+++ b/security/manager/ssl/src/nsKeygenHandler.cpp
@@ -441,6 +441,7 @@ GetSlotWithMechanism(PRUint32 aMechanism
                 i++;
             else {
                 // OOM. adjust numSlots so we don't free unallocated memory. 
+                PK11_FreeSlotListElement(slotList, slotElement);
                 numSlots = i;
                 rv = NS_ERROR_OUT_OF_MEMORY;
                 goto loser;
@@ -477,6 +478,7 @@ GetSlotWithMechanism(PRUint32 aMechanism
         while (slotElement) {
             if (tokenStr.Equals(NS_ConvertUTF8toUTF16(PK11_GetTokenName(slotElement->slot)))) {
                 *aSlot = slotElement->slot;
+                PK11_FreeSlotListElement(slotList, slotElement);
                 break;
             }
             slotElement = PK11_GetNextSafe(slotList, slotElement, PR_FALSE);
diff --git a/security/manager/ssl/src/nsPK11TokenDB.cpp b/security/manager/ssl/src/nsPK11TokenDB.cpp
--- a/security/manager/ssl/src/nsPK11TokenDB.cpp
+++ b/security/manager/ssl/src/nsPK11TokenDB.cpp
@@ -514,12 +514,12 @@ done:
 NS_IMETHODIMP nsPK11TokenDB::ListTokens(nsIEnumerator* *_retval)
 {
   nsNSSShutDownPreventionLock locker;
-  nsresult rv = NS_OK;
   nsCOMPtr<nsISupportsArray> array;
   PK11SlotList *list = 0;
   PK11SlotListElement *le;
 
-  rv = NS_NewISupportsArray(getter_AddRefs(array));
+  *_retval = nsnull;
+  nsresult rv = NS_NewISupportsArray(getter_AddRefs(array));
   if (NS_FAILED(rv)) { goto done; }
 
   /* List all tokens, creating PK11Token objects and putting them
@@ -530,8 +530,15 @@ NS_IMETHODIMP nsPK11TokenDB::ListTokens(
 
   for (le = PK11_GetFirstSafe(list); le; le = PK11_GetNextSafe(list, le, PR_FALSE)) {
     nsCOMPtr<nsIPK11Token> token = new nsPK11Token(le->slot);
+    rv = token
+      ? array->AppendElement(token)
+      : NS_ERROR_OUT_OF_MEMORY;
 
-    array->AppendElement(token);
+    if (NS_FAILED(rv)) {
+      PK11_FreeSlotListElement(list, le);
+      rv = NS_ERROR_OUT_OF_MEMORY;
+      goto done;
+    }
   }
 
   rv = array->Enumerate(_retval);
