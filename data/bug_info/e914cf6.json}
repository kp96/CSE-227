{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Base914cf6\""},"diff":[{"chunks":[{"content":"@@ -213,6 +213,7 @@ Gdiplus.h","changes":[{"type":"normal","normal":true,"ln1":213,"ln2":213,"content":" gdk/gdkevents.h"},{"type":"normal","normal":true,"ln1":214,"ln2":214,"content":" gdk/gdk.h"},{"type":"normal","normal":true,"ln1":215,"ln2":215,"content":" gdk/gdkkeysyms.h"},{"type":"add","add":true,"ln":216,"content":"+gdk/gdkpango.h"},{"type":"normal","normal":true,"ln1":216,"ln2":217,"content":" gdk/gdkprivate.h"},{"type":"normal","normal":true,"ln1":217,"ln2":218,"content":" gdk/gdkregion.h"},{"type":"normal","normal":true,"ln1":218,"ln2":219,"content":" gdk/gdkwindow.h"}],"oldStart":213,"oldLines":6,"newStart":213,"newLines":7},{"content":"@@ -505,6 +506,7 @@ PALM_CMN.H","changes":[{"type":"normal","normal":true,"ln1":505,"ln2":506,"content":" pango-engine.h"},{"type":"normal","normal":true,"ln1":506,"ln2":507,"content":" pango-glyph.h"},{"type":"normal","normal":true,"ln1":507,"ln2":508,"content":" pango-modules.h"},{"type":"add","add":true,"ln":509,"content":"+pango/pangocairo.h"},{"type":"normal","normal":true,"ln1":508,"ln2":510,"content":" pango/pangofc-decoder.h"},{"type":"normal","normal":true,"ln1":509,"ln2":511,"content":" pango/pangofc-font.h"},{"type":"normal","normal":true,"ln1":510,"ln2":512,"content":" pango/pangofc-fontmap.h"}],"oldStart":505,"oldLines":6,"newStart":506,"newLines":7},{"content":"@@ -513,6 +515,7 @@ pango/pango-fontmap.h","changes":[{"type":"normal","normal":true,"ln1":513,"ln2":515,"content":" pango/pango.h"},{"type":"normal","normal":true,"ln1":514,"ln2":516,"content":" pango/pangoxft.h"},{"type":"normal","normal":true,"ln1":515,"ln2":517,"content":" pango/pangox.h"},{"type":"add","add":true,"ln":518,"content":"+pango/pango-utils.h"},{"type":"normal","normal":true,"ln1":516,"ln2":519,"content":" pango-types.h"},{"type":"normal","normal":true,"ln1":517,"ln2":520,"content":" pascal.h"},{"type":"normal","normal":true,"ln1":518,"ln2":521,"content":" Patches.h"}],"oldStart":513,"oldLines":6,"newStart":515,"newLines":7}],"deletions":0,"additions":3,"from":"config/system-headers","to":"config/system-headers","index":["c40e1dc..b195469","100644"]},{"chunks":[{"content":"@@ -116,7 +116,8 @@ PERL_VERSION=5.006","changes":[{"type":"normal","normal":true,"ln1":116,"ln2":116,"content":" LIBART_VERSION=2.3.4"},{"type":"normal","normal":true,"ln1":117,"ln2":117,"content":" CAIRO_VERSION=1.4.2"},{"type":"normal","normal":true,"ln1":118,"ln2":118,"content":" GLITZ_VERSION=0.4.0"},{"type":"del","del":true,"ln":119,"content":"-GTK2_VERSION=1.3.7"},{"type":"add","add":true,"ln":119,"content":"+PANGO_VERSION=1.10.0"},{"type":"add","add":true,"ln":120,"content":"+GTK2_VERSION=1.8.0"},{"type":"normal","normal":true,"ln1":120,"ln2":121,"content":" MAKE_VERSION=3.78"},{"type":"normal","normal":true,"ln1":121,"ln2":122,"content":" WINDRES_VERSION=2.14.90"},{"type":"normal","normal":true,"ln1":122,"ln2":123,"content":" W32API_VERSION=3.8"}],"oldStart":116,"oldLines":7,"newStart":116,"newLines":8},{"content":"@@ -4567,7 +4568,7 @@ fi","changes":[{"type":"normal","normal":true,"ln1":4567,"ln2":4568,"content":" if test \"$COMPILE_ENVIRONMENT\"; then"},{"type":"normal","normal":true,"ln1":4568,"ln2":4569,"content":" if test \"$MOZ_ENABLE_GTK2\""},{"type":"normal","normal":true,"ln1":4569,"ln2":4570,"content":" then"},{"type":"del","del":true,"ln":4570,"content":"-    PKG_CHECK_MODULES(MOZ_GTK2, gtk+-2.0 >= 1.3.7 gdk-x11-2.0 glib-2.0 gobject-2.0)"},{"type":"add","add":true,"ln":4571,"content":"+    PKG_CHECK_MODULES(MOZ_GTK2, gtk+-2.0 >= $GTK2_VERSION gdk-x11-2.0 glib-2.0 gobject-2.0)"},{"type":"normal","normal":true,"ln1":4571,"ln2":4572,"content":" fi"},{"type":"normal","normal":true,"ln1":4572,"ln2":4573,"content":" fi # COMPILE_ENVIRONMENT"},{"type":"normal","normal":true,"ln1":4573,"ln2":4574,"content":" "}],"oldStart":4567,"oldLines":7,"newStart":4568,"newLines":7},{"content":"@@ -4782,7 +4783,7 @@ if test \"$MOZ_ENABLE_XFT\"","changes":[{"type":"normal","normal":true,"ln1":4782,"ln2":4783,"content":" then"},{"type":"normal","normal":true,"ln1":4783,"ln2":4784,"content":"     AC_DEFINE(MOZ_ENABLE_XFT)"},{"type":"normal","normal":true,"ln1":4784,"ln2":4785,"content":"     PKG_CHECK_MODULES(MOZ_XFT, xft)"},{"type":"del","del":true,"ln":4785,"content":"-    PKG_CHECK_MODULES(_PANGOCHK, pango >= 1.1.0)"},{"type":"add","add":true,"ln":4786,"content":"+    PKG_CHECK_MODULES(_PANGOCHK, pango >= $PANGO_VERSION)"},{"type":"normal","normal":true,"ln1":4786,"ln2":4787,"content":" fi"},{"type":"normal","normal":true,"ln1":4787,"ln2":4788,"content":" "},{"type":"normal","normal":true,"ln1":4788,"ln2":4789,"content":" AC_SUBST(MOZ_ENABLE_XFT)"}],"oldStart":4782,"oldLines":7,"newStart":4783,"newLines":7},{"content":"@@ -4799,12 +4800,7 @@ MOZ_ARG_ENABLE_BOOL(pango,","changes":[{"type":"normal","normal":true,"ln1":4799,"ln2":4800,"content":" "},{"type":"normal","normal":true,"ln1":4800,"ln2":4801,"content":" if test \"$MOZ_ENABLE_PANGO\" && test -z \"$MOZ_ENABLE_CAIRO_GFX\""},{"type":"normal","normal":true,"ln1":4801,"ln2":4802,"content":" then"},{"type":"del","del":true,"ln":4802,"content":"-    AC_DEFINE(MOZ_ENABLE_PANGO)"},{"type":"del","del":true,"ln":4803,"content":"-    PKG_CHECK_MODULES(MOZ_PANGO, pangoxft >= 1.6.0)"},{"type":"del","del":true,"ln":4804,"content":"-"},{"type":"del","del":true,"ln":4805,"content":"-    AC_SUBST(MOZ_ENABLE_PANGO)"},{"type":"del","del":true,"ln":4806,"content":"-    AC_SUBST(MOZ_PANGO_CFLAGS)"},{"type":"del","del":true,"ln":4807,"content":"-    AC_SUBST(MOZ_PANGO_LIBS)"},{"type":"add","add":true,"ln":4803,"content":"+    AC_MSG_ERROR([Cairo gfx is required for Pango font rendering])"},{"type":"normal","normal":true,"ln1":4808,"ln2":4804,"content":" fi"},{"type":"normal","normal":true,"ln1":4809,"ln2":4805,"content":" "},{"type":"normal","normal":true,"ln1":4810,"ln2":4806,"content":" if test \"$MOZ_ENABLE_GTK2\" && test \"$MOZ_ENABLE_CAIRO_GFX\""}],"oldStart":4799,"oldLines":12,"newStart":4800,"newLines":7},{"content":"@@ -4820,13 +4816,7 @@ fi","changes":[{"type":"normal","normal":true,"ln1":4820,"ln2":4816,"content":" if test \"$MOZ_ENABLE_PANGO\" && test \"$MOZ_ENABLE_CAIRO_GFX\""},{"type":"normal","normal":true,"ln1":4821,"ln2":4817,"content":" then"},{"type":"normal","normal":true,"ln1":4822,"ln2":4818,"content":"     AC_DEFINE(MOZ_ENABLE_PANGO)"},{"type":"del","del":true,"ln":4823,"content":"-    dnl PKG_CHECK_MODULES(MOZ_PANGO, pango >= 1.10.0 pangocairo >= 1.10.0)"},{"type":"del","del":true,"ln":4824,"content":"-    if test \"$MOZ_X11\"; then"},{"type":"del","del":true,"ln":4825,"content":"-        PKG_CHECK_MODULES(MOZ_PANGO, pango >= 1.6.0 pangoft2 >= 1.6.0 pangoxft >= 1.6.0)"},{"type":"del","del":true,"ln":4826,"content":"-    else"},{"type":"del","del":true,"ln":4827,"content":"-        PKG_CHECK_MODULES(MOZ_PANGO, pango >= 1.6.0 pangoft2 >= 1.6.0)"},{"type":"del","del":true,"ln":4828,"content":"-    fi"},{"type":"del","del":true,"ln":4829,"content":"-"},{"type":"add","add":true,"ln":4819,"content":"+    PKG_CHECK_MODULES(MOZ_PANGO, pango >= $PANGO_VERSION pangocairo >= $PANGO_VERSION pangoft2 >= $PANGO_VERSION)"},{"type":"normal","normal":true,"ln1":4830,"ln2":4820,"content":"     AC_SUBST(MOZ_ENABLE_PANGO)"},{"type":"normal","normal":true,"ln1":4831,"ln2":4821,"content":"     AC_SUBST(MOZ_PANGO_CFLAGS)"},{"type":"normal","normal":true,"ln1":4832,"ln2":4822,"content":"     AC_SUBST(MOZ_PANGO_LIBS)"}],"oldStart":4820,"oldLines":13,"newStart":4816,"newLines":7}],"deletions":16,"additions":6,"from":"configure.in","to":"configure.in","index":["0d410f7..5c52f67","100644"]},{"chunks":[{"content":"@@ -44,14 +44,15 @@","changes":[{"type":"normal","normal":true,"ln1":44,"ln2":44,"content":" #include \"gfxFont.h\""},{"type":"normal","normal":true,"ln1":45,"ln2":45,"content":" "},{"type":"normal","normal":true,"ln1":46,"ln2":46,"content":" #include <pango/pango.h>"},{"type":"del","del":true,"ln":47,"content":"-#include <X11/Xft/Xft.h>"},{"type":"normal","normal":true,"ln1":48,"ln2":47,"content":" "},{"type":"del","del":true,"ln":49,"content":"-// Control when we use Xft directly, bypassing Pango"},{"type":"del","del":true,"ln":50,"content":"-// Enable this to use Xft to glyph-convert 8bit-only textruns, but use Pango"},{"type":"add","add":true,"ln":48,"content":"+// Control when we bypass Pango"},{"type":"add","add":true,"ln":49,"content":"+// Enable this to use FreeType to glyph-convert 8bit-only textruns, but use Pango"},{"type":"normal","normal":true,"ln1":51,"ln2":50,"content":" // to shape any textruns with non-8bit characters"},{"type":"del","del":true,"ln":52,"content":"-#define ENABLE_XFT_FAST_PATH_8BIT"},{"type":"del","del":true,"ln":53,"content":"-// Enable this to use Xft to glyph-convert all textruns"},{"type":"del","del":true,"ln":54,"content":"-// #define ENABLE_XFT_FAST_PATH_ALWAYS"},{"type":"add","add":true,"ln":51,"content":"+// XXX"},{"type":"add","add":true,"ln":52,"content":"+#define ENABLE_FAST_PATH_8BIT"},{"type":"add","add":true,"ln":53,"content":"+// Enable this to bypass Pango shaping for all textruns.  Don't expect"},{"type":"add","add":true,"ln":54,"content":"+// anything other than simple Latin work though!"},{"type":"add","add":true,"ln":55,"content":"+//#define ENABLE_FAST_PATH_ALWAYS"},{"type":"normal","normal":true,"ln1":55,"ln2":56,"content":" "},{"type":"normal","normal":true,"ln1":56,"ln2":57,"content":" #include \"nsDataHashtable.h\""},{"type":"normal","normal":true,"ln1":57,"ln2":58,"content":" #include \"nsClassHashtable.h\""}],"oldStart":44,"oldLines":14,"newStart":44,"newLines":15},{"content":"@@ -70,17 +71,15 @@ public:","changes":[{"type":"normal","normal":true,"ln1":70,"ln2":71,"content":" "},{"type":"normal","normal":true,"ln1":71,"ln2":72,"content":"     virtual const gfxFont::Metrics& GetMetrics();"},{"type":"normal","normal":true,"ln1":72,"ln2":73,"content":" "},{"type":"del","del":true,"ln":73,"content":"-    PangoFontDescription *GetPangoFontDescription() { RealizeFont(); return mPangoFontDesc; }"},{"type":"del","del":true,"ln":74,"content":"-    PangoContext *GetPangoContext() { RealizeFont(); return mPangoCtx; }"},{"type":"add","add":true,"ln":74,"content":"+    PangoFontDescription *GetPangoFontDescription() { if (!mPangoFontDesc) RealizeFont(); return mPangoFontDesc; }"},{"type":"add","add":true,"ln":75,"content":"+    PangoContext *GetPangoContext() { if (!mPangoFontDesc) RealizeFont(); return mPangoCtx; }"},{"type":"normal","normal":true,"ln1":75,"ln2":76,"content":" "},{"type":"normal","normal":true,"ln1":76,"ln2":77,"content":"     void GetMozLang(nsACString &aMozLang);"},{"type":"normal","normal":true,"ln1":77,"ln2":78,"content":"     void GetActualFontFamily(nsACString &aFamily);"},{"type":"normal","normal":true,"ln1":78,"ln2":79,"content":" "},{"type":"del","del":true,"ln":79,"content":"-    XftFont *GetXftFont () { RealizeXftFont (); return mXftFont; }"},{"type":"del","del":true,"ln":80,"content":"-    PangoFont *GetPangoFont() { RealizePangoFont(); return mPangoFont; }"},{"type":"del","del":true,"ln":81,"content":"-    gfxFloat GetAdjustedSize() { RealizeFont(); return mAdjustedSize; }"},{"type":"add","add":true,"ln":80,"content":"+    PangoFont *GetPangoFont() { if (!mPangoFont) RealizePangoFont(); return mPangoFont; }"},{"type":"add","add":true,"ln":81,"content":"+    gfxFloat GetAdjustedSize() { if (!mPangoFontDesc) RealizeFont(); return mAdjustedSize; }"},{"type":"normal","normal":true,"ln1":82,"ln2":82,"content":" "},{"type":"del","del":true,"ln":83,"content":"-    PRBool HasGlyph(const PRUint32 aChar);"},{"type":"normal","normal":true,"ln1":84,"ln2":83,"content":"     PRUint32 GetGlyph(const PRUint32 aChar);"},{"type":"normal","normal":true,"ln1":85,"ln2":84,"content":" "},{"type":"normal","normal":true,"ln1":86,"ln2":85,"content":"     virtual nsString GetUniqueName();"}],"oldStart":70,"oldLines":17,"newStart":71,"newLines":15},{"content":"@@ -95,9 +94,7 @@ protected:","changes":[{"type":"normal","normal":true,"ln1":95,"ln2":94,"content":"     PangoFontDescription *mPangoFontDesc;"},{"type":"normal","normal":true,"ln1":96,"ln2":95,"content":"     PangoContext *mPangoCtx;"},{"type":"normal","normal":true,"ln1":97,"ln2":96,"content":" "},{"type":"del","del":true,"ln":98,"content":"-    XftFont *mXftFont;"},{"type":"normal","normal":true,"ln1":99,"ln2":97,"content":"     PangoFont *mPangoFont;"},{"type":"del","del":true,"ln":100,"content":"-    PangoFont *mGlyphTestingFont;"},{"type":"normal","normal":true,"ln1":101,"ln2":98,"content":"     cairo_scaled_font_t *mCairoFont;"},{"type":"normal","normal":true,"ln1":102,"ln2":99,"content":" "},{"type":"normal","normal":true,"ln1":103,"ln2":100,"content":"     PRBool   mHasMetrics;"}],"oldStart":95,"oldLines":9,"newStart":94,"newLines":7},{"content":"@@ -106,7 +103,6 @@ protected:","changes":[{"type":"normal","normal":true,"ln1":106,"ln2":103,"content":"     gfxFloat mAdjustedSize;"},{"type":"normal","normal":true,"ln1":107,"ln2":104,"content":" "},{"type":"normal","normal":true,"ln1":108,"ln2":105,"content":"     void RealizeFont(PRBool force = PR_FALSE);"},{"type":"del","del":true,"ln":109,"content":"-    void RealizeXftFont(PRBool force = PR_FALSE);"},{"type":"normal","normal":true,"ln1":110,"ln2":106,"content":"     void RealizePangoFont(PRBool aForce = PR_FALSE);"},{"type":"normal","normal":true,"ln1":111,"ln2":107,"content":"     void GetCharSize(const char aChar, gfxSize& aInkSize, gfxSize& aLogSize,"},{"type":"normal","normal":true,"ln1":112,"ln2":108,"content":"                      PRUint32 *aGlyphID = nsnull);"}],"oldStart":106,"oldLines":7,"newStart":103,"newLines":6},{"content":"@@ -124,7 +120,7 @@ public:","changes":[{"type":"normal","normal":true,"ln1":124,"ln2":120,"content":" "},{"type":"normal","normal":true,"ln1":125,"ln2":121,"content":"     virtual gfxFontGroup *Copy(const gfxFontStyle *aStyle);"},{"type":"normal","normal":true,"ln1":126,"ln2":122,"content":" "},{"type":"del","del":true,"ln":127,"content":"-    // Create and initialize a textrun using Pango (or Xft)"},{"type":"add","add":true,"ln":123,"content":"+    // Create and initialize a textrun using Pango"},{"type":"normal","normal":true,"ln1":128,"ln2":124,"content":"     virtual gfxTextRun *MakeTextRun(const PRUnichar *aString, PRUint32 aLength,"},{"type":"normal","normal":true,"ln1":129,"ln2":125,"content":"                                     const Parameters *aParams, PRUint32 aFlags);"},{"type":"normal","normal":true,"ln1":130,"ln2":126,"content":"     virtual gfxTextRun *MakeTextRun(const PRUint8 *aString, PRUint32 aLength,"}],"oldStart":124,"oldLines":7,"newStart":120,"newLines":7},{"content":"@@ -146,8 +142,8 @@ protected:","changes":[{"type":"normal","normal":true,"ln1":146,"ln2":142,"content":"      * but stored in UTF16 format)"},{"type":"normal","normal":true,"ln1":147,"ln2":143,"content":"      */"},{"type":"normal","normal":true,"ln1":148,"ln2":144,"content":"     void InitTextRun(gfxTextRun *aTextRun, const gchar *aUTF8Text,"},{"type":"del","del":true,"ln":149,"content":"-                     PRUint32 aUTF8Length, PRUint32 aUTF8HeaderLength,"},{"type":"del","del":true,"ln":150,"content":"-                     PRBool aTake8BitPath);"},{"type":"add","add":true,"ln":145,"content":"+                     PRUint32 aUTF8Length, PRBool aTake8BitPath);"},{"type":"add","add":true,"ln":146,"content":"+"},{"type":"normal","normal":true,"ln1":151,"ln2":147,"content":"     // Returns NS_ERROR_FAILURE if there's a missing glyph"},{"type":"normal","normal":true,"ln1":152,"ln2":148,"content":"     nsresult SetGlyphs(gfxTextRun *aTextRun, gfxPangoFont *aFont,"},{"type":"normal","normal":true,"ln1":153,"ln2":149,"content":"                        const gchar *aUTF8, PRUint32 aUTF8Length,"}],"oldStart":146,"oldLines":8,"newStart":142,"newLines":8},{"content":"@@ -158,11 +154,11 @@ protected:","changes":[{"type":"normal","normal":true,"ln1":158,"ln2":154,"content":"                               const gchar *aUTF8, PRUint32 aUTF8Length,"},{"type":"normal","normal":true,"ln1":159,"ln2":155,"content":"                               PRUint32 *aUTF16Offset);"},{"type":"normal","normal":true,"ln1":160,"ln2":156,"content":"     void CreateGlyphRunsItemizing(gfxTextRun *aTextRun,"},{"type":"del","del":true,"ln":161,"content":"-                                  const gchar *aUTF8, PRUint32 aUTF8Length,"},{"type":"del","del":true,"ln":162,"content":"-                                  PRUint32 aUTF8HeaderLength);"},{"type":"del","del":true,"ln":163,"content":"-#if defined(ENABLE_XFT_FAST_PATH_8BIT) || defined(ENABLE_XFT_FAST_PATH_ALWAYS)"},{"type":"del","del":true,"ln":164,"content":"-    void CreateGlyphRunsXft(gfxTextRun *aTextRun,"},{"type":"del","del":true,"ln":165,"content":"-                            const gchar *aUTF8, PRUint32 aUTF8Length);"},{"type":"add","add":true,"ln":157,"content":"+                                  const gchar *aUTF8, PRUint32 aUTF8Length);"},{"type":"add","add":true,"ln":158,"content":"+#if defined(ENABLE_FAST_PATH_8BIT) || defined(ENABLE_FAST_PATH_ALWAYS)"},{"type":"add","add":true,"ln":159,"content":"+    PRBool CanTakeFastPath(PRUint32 aFlags);"},{"type":"add","add":true,"ln":160,"content":"+    void CreateGlyphRunsFast(gfxTextRun *aTextRun,"},{"type":"add","add":true,"ln":161,"content":"+                             const gchar *aUTF8, PRUint32 aUTF8Length);"},{"type":"normal","normal":true,"ln1":166,"ln2":162,"content":" #endif"},{"type":"normal","normal":true,"ln1":167,"ln2":163,"content":" "},{"type":"normal","normal":true,"ln1":168,"ln2":164,"content":"     static PRBool FontCallback (const nsAString& fontName,"}],"oldStart":158,"oldLines":11,"newStart":154,"newLines":11},{"content":"@@ -212,30 +208,4 @@ private:","changes":[{"type":"normal","normal":true,"ln1":212,"ln2":208,"content":"     nsClassHashtable<nsUint32HashKey,  gfxPangoFontWrapper> mPangoFonts;"},{"type":"normal","normal":true,"ln1":213,"ln2":209,"content":" };"},{"type":"normal","normal":true,"ln1":214,"ln2":210,"content":" "},{"type":"del","del":true,"ln":215,"content":"-// XXX we should remove this class, because this class is used only in |HasGlyph| of gfxPangoFont."},{"type":"del","del":true,"ln":216,"content":"-// But it can use fontconfig directly after bug 366664."},{"type":"del","del":true,"ln":217,"content":"-class gfxPangoFontNameMap"},{"type":"del","del":true,"ln":218,"content":"-{"},{"type":"del","del":true,"ln":219,"content":"-public:"},{"type":"del","del":true,"ln":220,"content":"-    gfxPangoFontNameMap();"},{"type":"del","del":true,"ln":221,"content":"-    ~gfxPangoFontNameMap();"},{"type":"del","del":true,"ln":222,"content":"-"},{"type":"del","del":true,"ln":223,"content":"-    static gfxPangoFontNameMap* GetPangoFontNameMap() {"},{"type":"del","del":true,"ln":224,"content":"-        if (!sPangoFontNameMap)"},{"type":"del","del":true,"ln":225,"content":"-            sPangoFontNameMap = new gfxPangoFontNameMap();"},{"type":"del","del":true,"ln":226,"content":"-        return sPangoFontNameMap;"},{"type":"del","del":true,"ln":227,"content":"-    }"},{"type":"del","del":true,"ln":228,"content":"-    static void Shutdown() {"},{"type":"del","del":true,"ln":229,"content":"-        if (sPangoFontNameMap)"},{"type":"del","del":true,"ln":230,"content":"-            delete sPangoFontNameMap;"},{"type":"del","del":true,"ln":231,"content":"-        sPangoFontNameMap = nsnull;"},{"type":"del","del":true,"ln":232,"content":"-    }"},{"type":"del","del":true,"ln":233,"content":"-"},{"type":"del","del":true,"ln":234,"content":"-    void Put(const nsACString &aName, PangoFont *aPangoFont);"},{"type":"del","del":true,"ln":235,"content":"-    PangoFont* Get(const nsACString &aName);"},{"type":"del","del":true,"ln":236,"content":"-"},{"type":"del","del":true,"ln":237,"content":"-private:"},{"type":"del","del":true,"ln":238,"content":"-    static gfxPangoFontNameMap *sPangoFontNameMap;"},{"type":"del","del":true,"ln":239,"content":"-    nsClassHashtable<nsCStringHashKey, gfxPangoFontWrapper> mPangoFonts;"},{"type":"del","del":true,"ln":240,"content":"-};"},{"type":"normal","normal":true,"ln1":241,"ln2":211,"content":" #endif /* GFX_PANGOFONTS_H */"}],"oldStart":212,"oldLines":30,"newStart":208,"newLines":4}],"deletions":49,"additions":19,"from":"gfx/thebes/public/gfxPangoFonts.h","to":"gfx/thebes/public/gfxPangoFonts.h","index":["a90ff13..f0a63d7","100644"]},{"chunks":[{"content":"@@ -79,7 +79,7 @@ public:","changes":[{"type":"normal","normal":true,"ln1":79,"ln2":79,"content":"         if (sDPI == -1) {"},{"type":"normal","normal":true,"ln1":80,"ln2":80,"content":"             InitDPI();"},{"type":"normal","normal":true,"ln1":81,"ln2":81,"content":"         }"},{"type":"del","del":true,"ln":82,"content":"-        NS_ASSERTION(sDPI != 0, \"Something is wrong\");"},{"type":"add","add":true,"ln":82,"content":"+        NS_ASSERTION(sDPI > 0, \"Something is wrong\");"},{"type":"normal","normal":true,"ln1":83,"ln2":83,"content":"         return sDPI;"},{"type":"normal","normal":true,"ln1":84,"ln2":84,"content":"     }"},{"type":"normal","normal":true,"ln1":85,"ln2":85,"content":" "}],"oldStart":79,"oldLines":7,"newStart":79,"newLines":7}],"deletions":1,"additions":1,"from":"gfx/thebes/public/gfxPlatformGtk.h","to":"gfx/thebes/public/gfxPlatformGtk.h","index":["0177304..4c7eafd","100644"]},{"chunks":[{"content":"@@ -40,6 +40,7 @@","changes":[{"type":"normal","normal":true,"ln1":40,"ln2":40,"content":" #include \"cairo-xlib.h\""},{"type":"normal","normal":true,"ln1":41,"ln2":41,"content":" #include <stdlib.h>"},{"type":"normal","normal":true,"ln1":42,"ln2":42,"content":" "},{"type":"add","add":true,"ln":43,"content":"+#include <stdint.h>"},{"type":"normal","normal":true,"ln1":43,"ln2":44,"content":" #if   HAVE_STDINT_H"},{"type":"normal","normal":true,"ln1":44,"ln2":45,"content":" #include <stdint.h>"},{"type":"normal","normal":true,"ln1":45,"ln2":46,"content":" #elif HAVE_INTTYPES_H"}],"oldStart":40,"oldLines":6,"newStart":40,"newLines":7}],"deletions":0,"additions":1,"from":"gfx/thebes/src/cairo-xlib-utils.c","to":"gfx/thebes/src/cairo-xlib-utils.c","index":["69cccf2..a7d9333","100644"]},{"chunks":[{"content":"@@ -21,6 +21,7 @@","changes":[{"type":"normal","normal":true,"ln1":21,"ln2":21,"content":"  * Contributor(s):"},{"type":"normal","normal":true,"ln1":22,"ln2":22,"content":"  *   Vladimir Vukicevic <vladimir@mozilla.com>"},{"type":"normal","normal":true,"ln1":23,"ln2":23,"content":"  *   Masayuki Nakano <masayuki@d-toybox.com>"},{"type":"add","add":true,"ln":24,"content":"+ *   Behdad Esfahbod <behdad@gnome.org>"},{"type":"normal","normal":true,"ln1":24,"ln2":25,"content":"  *"},{"type":"normal","normal":true,"ln1":25,"ln2":26,"content":"  * based on nsFontMetricsPango.cpp by"},{"type":"normal","normal":true,"ln1":26,"ln2":27,"content":"  *   Christopher Blizzard <blizzard@mozilla.org>"}],"oldStart":21,"oldLines":6,"newStart":21,"newLines":7},{"content":"@@ -39,11 +40,6 @@","changes":[{"type":"normal","normal":true,"ln1":39,"ln2":40,"content":"  *"},{"type":"normal","normal":true,"ln1":40,"ln2":41,"content":"  * ***** END LICENSE BLOCK ***** */"},{"type":"normal","normal":true,"ln1":41,"ln2":42,"content":" "},{"type":"del","del":true,"ln":42,"content":"-#ifdef XP_BEOS"},{"type":"del","del":true,"ln":43,"content":"-#define THEBES_USE_PANGO_CAIRO"},{"type":"del","del":true,"ln":44,"content":"-#endif"},{"type":"del","del":true,"ln":45,"content":"-"},{"type":"del","del":true,"ln":46,"content":"-#define PANGO_ENABLE_ENGINE"},{"type":"normal","normal":true,"ln1":47,"ln2":43,"content":" #define PANGO_ENABLE_BACKEND"},{"type":"normal","normal":true,"ln1":48,"ln2":44,"content":" "},{"type":"normal","normal":true,"ln1":49,"ln2":45,"content":" #include \"prtypes.h\""}],"oldStart":39,"oldLines":11,"newStart":40,"newLines":6},{"content":"@@ -62,45 +58,38 @@","changes":[{"type":"normal","normal":true,"ln1":62,"ln2":58,"content":" #include \"nsPromiseFlatString.h\""},{"type":"normal","normal":true,"ln1":63,"ln2":59,"content":" "},{"type":"normal","normal":true,"ln1":64,"ln2":60,"content":" #include \"gfxContext.h\""},{"type":"add","add":true,"ln":61,"content":"+#include \"gfxPlatformGtk.h\""},{"type":"normal","normal":true,"ln1":65,"ln2":62,"content":" #include \"gfxPangoFonts.h\""},{"type":"normal","normal":true,"ln1":66,"ln2":63,"content":" "},{"type":"normal","normal":true,"ln1":67,"ln2":64,"content":" #include \"nsCRT.h\""},{"type":"normal","normal":true,"ln1":68,"ln2":65,"content":" "},{"type":"del","del":true,"ln":69,"content":"-#include \"cairo.h\""},{"type":"del","del":true,"ln":70,"content":"-"},{"type":"del","del":true,"ln":71,"content":"-#ifndef THEBES_USE_PANGO_CAIRO"},{"type":"del","del":true,"ln":72,"content":"-#include <gdk/gdk.h>"},{"type":"del","del":true,"ln":73,"content":"-#include <gdk/gdkx.h>"},{"type":"del","del":true,"ln":74,"content":"-#include <gdk/gdkpango.h>"},{"type":"del","del":true,"ln":75,"content":"-"},{"type":"del","del":true,"ln":76,"content":"-"},{"type":"normal","normal":true,"ln1":77,"ln2":66,"content":" #include <freetype/tttables.h>"},{"type":"del","del":true,"ln":78,"content":"-#include <fontconfig/fontconfig.h>"},{"type":"normal","normal":true,"ln1":79,"ln2":67,"content":" "},{"type":"del","del":true,"ln":80,"content":"-#include <pango/pango-font.h>"},{"type":"del","del":true,"ln":81,"content":"-#include <pango/pangoxft.h>"},{"type":"del","del":true,"ln":82,"content":"-"},{"type":"del","del":true,"ln":83,"content":"-#include \"cairo-ft.h\""},{"type":"del","del":true,"ln":84,"content":"-"},{"type":"del","del":true,"ln":85,"content":"-#include \"gfxPlatformGtk.h\""},{"type":"del","del":true,"ln":86,"content":"-"},{"type":"del","del":true,"ln":87,"content":"-#else // THEBES_USE_PANGO_CAIRO"},{"type":"add","add":true,"ln":68,"content":"+#include <cairo.h>"},{"type":"add","add":true,"ln":69,"content":"+#include <cairo-ft.h>"},{"type":"normal","normal":true,"ln1":88,"ln2":70,"content":" "},{"type":"add","add":true,"ln":71,"content":"+#include <pango/pango.h>"},{"type":"add","add":true,"ln":72,"content":"+#include <pango/pango-utils.h>"},{"type":"normal","normal":true,"ln1":89,"ln2":73,"content":" #include <pango/pangocairo.h>"},{"type":"add","add":true,"ln":74,"content":"+#include <pango/pangofc-fontmap.h>"},{"type":"normal","normal":true,"ln1":90,"ln2":75,"content":" "},{"type":"del","del":true,"ln":91,"content":"-#endif // THEBES_USE_PANGO_CAIRO"},{"type":"add","add":true,"ln":76,"content":"+#include <gdk/gdkpango.h>"},{"type":"normal","normal":true,"ln1":92,"ln2":77,"content":" "},{"type":"normal","normal":true,"ln1":93,"ln2":78,"content":" #include <math.h>"},{"type":"normal","normal":true,"ln1":94,"ln2":79,"content":" "},{"type":"normal","normal":true,"ln1":95,"ln2":80,"content":" #define FLOAT_PANGO_SCALE ((gfxFloat)PANGO_SCALE)"},{"type":"normal","normal":true,"ln1":96,"ln2":81,"content":" "},{"type":"del","del":true,"ln":97,"content":"-#define IS_MISSING_GLYPH(g) (((g) & 0x10000000) || (g) == 0x0FFFFFFF)"},{"type":"add","add":true,"ln":82,"content":"+#ifndef PANGO_GLYPH_UNKNOWN_FLAG"},{"type":"add","add":true,"ln":83,"content":"+#define PANGO_GLYPH_UNKNOWN_FLAG ((PangoGlyph)0x10000000)"},{"type":"add","add":true,"ln":84,"content":"+#endif"},{"type":"add","add":true,"ln":85,"content":"+#ifndef PANGO_GLYPH_EMPTY"},{"type":"add","add":true,"ln":86,"content":"+#define PANGO_GLYPH_EMPTY           ((PangoGlyph)0)"},{"type":"add","add":true,"ln":87,"content":"+#endif"},{"type":"add","add":true,"ln":88,"content":"+#define IS_MISSING_GLYPH(g) (((g) & PANGO_GLYPH_UNKNOWN_FLAG) || (g) == PANGO_GLYPH_EMPTY)"},{"type":"normal","normal":true,"ln1":98,"ln2":89,"content":" "},{"type":"normal","normal":true,"ln1":99,"ln2":90,"content":" static PangoLanguage *GetPangoLanguage(const nsACString& aLangGroup);"},{"type":"del","del":true,"ln":100,"content":"-static void GetMozLanguage(const PangoLanguage *aLang, nsACString &aMozLang);"},{"type":"normal","normal":true,"ln1":101,"ln2":91,"content":" "},{"type":"normal","normal":true,"ln1":102,"ln2":92,"content":" /* static */ gfxPangoFontCache* gfxPangoFontCache::sPangoFontCache = nsnull;"},{"type":"del","del":true,"ln":103,"content":"-/* static */ gfxPangoFontNameMap* gfxPangoFontNameMap::sPangoFontNameMap = nsnull;"},{"type":"normal","normal":true,"ln1":104,"ln2":93,"content":" "},{"type":"normal","normal":true,"ln1":105,"ln2":94,"content":" /**"},{"type":"normal","normal":true,"ln1":106,"ln2":95,"content":"  ** gfxPangoFontGroup"}],"oldStart":62,"oldLines":45,"newStart":58,"newLines":38},{"content":"@@ -166,6 +155,7 @@ gfxPangoFontGroup::gfxPangoFontGroup (const nsAString& families,","changes":[{"type":"normal","normal":true,"ln1":166,"ln2":155,"content":" "},{"type":"normal","normal":true,"ln1":167,"ln2":156,"content":"     // XXX If there are no actual fonts, we should use dummy family."},{"type":"normal","normal":true,"ln1":168,"ln2":157,"content":"     // Pango will resolve from this."},{"type":"add","add":true,"ln":158,"content":"+    // behdad: yep, looks good."},{"type":"normal","normal":true,"ln1":169,"ln2":159,"content":"     if (familyArray.Count() == 0) {"},{"type":"normal","normal":true,"ln1":170,"ln2":160,"content":"         // printf(\"%s(%s)\\n\", NS_ConvertUTF16toUTF8(families).get(),"},{"type":"normal","normal":true,"ln1":171,"ln2":161,"content":"         //                    aStyle->langGroup.get());"}],"oldStart":166,"oldLines":6,"newStart":155,"newLines":7},{"content":"@@ -194,82 +184,12 @@ gfxPangoFontGroup::Copy(const gfxFontStyle *aStyle)","changes":[{"type":"normal","normal":true,"ln1":194,"ln2":184,"content":"  ** gfxPangoFont"},{"type":"normal","normal":true,"ln1":195,"ln2":185,"content":"  **/"},{"type":"normal","normal":true,"ln1":196,"ln2":186,"content":" "},{"type":"del","del":true,"ln":197,"content":"-// Glue to avoid build/runtime dependencies on Pango > 1.6,"},{"type":"del","del":true,"ln":198,"content":"-// because we like living in 1999"},{"type":"del","del":true,"ln":199,"content":"-"},{"type":"del","del":true,"ln":200,"content":"-#ifndef THEBES_USE_PANGO_CAIRO"},{"type":"del","del":true,"ln":201,"content":"-static void"},{"type":"del","del":true,"ln":202,"content":"-(* PTR_pango_font_description_set_absolute_size)(PangoFontDescription*, double)"},{"type":"del","del":true,"ln":203,"content":"-    = nsnull;"},{"type":"del","del":true,"ln":204,"content":"-"},{"type":"del","del":true,"ln":205,"content":"-static void InitPangoLib()"},{"type":"del","del":true,"ln":206,"content":"-{"},{"type":"del","del":true,"ln":207,"content":"-    static PRBool initialized = PR_FALSE;"},{"type":"del","del":true,"ln":208,"content":"-    if (initialized)"},{"type":"del","del":true,"ln":209,"content":"-        return;"},{"type":"del","del":true,"ln":210,"content":"-    initialized = PR_TRUE;"},{"type":"del","del":true,"ln":211,"content":"-"},{"type":"del","del":true,"ln":212,"content":"-    g_type_init();"},{"type":"del","del":true,"ln":213,"content":"-"},{"type":"del","del":true,"ln":214,"content":"-    PRLibrary *pangoLib = nsnull;"},{"type":"del","del":true,"ln":215,"content":"-    PTR_pango_font_description_set_absolute_size ="},{"type":"del","del":true,"ln":216,"content":"-        (void (*)(PangoFontDescription*, double))"},{"type":"del","del":true,"ln":217,"content":"-        PR_FindFunctionSymbolAndLibrary(\"pango_font_description_set_absolute_size\","},{"type":"del","del":true,"ln":218,"content":"-                                        &pangoLib);"},{"type":"del","del":true,"ln":219,"content":"-    if (pangoLib)"},{"type":"del","del":true,"ln":220,"content":"-        PR_UnloadLibrary(pangoLib);"},{"type":"del","del":true,"ln":221,"content":"-"},{"type":"del","del":true,"ln":222,"content":"-    PRLibrary *xftLib = nsnull;"},{"type":"del","del":true,"ln":223,"content":"-    int *xft_max_freetype_files_ptr = nsnull;"},{"type":"del","del":true,"ln":224,"content":"-    xft_max_freetype_files_ptr = (int*) PR_FindSymbolAndLibrary(\"XftMaxFreeTypeFiles\", &xftLib);"},{"type":"del","del":true,"ln":225,"content":"-    if (xft_max_freetype_files_ptr && *xft_max_freetype_files_ptr < 50)"},{"type":"del","del":true,"ln":226,"content":"-        *xft_max_freetype_files_ptr = 50;"},{"type":"del","del":true,"ln":227,"content":"-    if (xftLib)"},{"type":"del","del":true,"ln":228,"content":"-        PR_UnloadLibrary(xftLib);"},{"type":"del","del":true,"ln":229,"content":"-}"},{"type":"del","del":true,"ln":230,"content":"-"},{"type":"del","del":true,"ln":231,"content":"-static void"},{"type":"del","del":true,"ln":232,"content":"-ShutdownPangoLib()"},{"type":"del","del":true,"ln":233,"content":"-{"},{"type":"del","del":true,"ln":234,"content":"-}"},{"type":"del","del":true,"ln":235,"content":"-"},{"type":"del","del":true,"ln":236,"content":"-static void"},{"type":"del","del":true,"ln":237,"content":"-MOZ_pango_font_description_set_absolute_size(PangoFontDescription *desc,"},{"type":"del","del":true,"ln":238,"content":"-                                             double size)"},{"type":"del","del":true,"ln":239,"content":"-{"},{"type":"del","del":true,"ln":240,"content":"-    if (PTR_pango_font_description_set_absolute_size) {"},{"type":"del","del":true,"ln":241,"content":"-        PTR_pango_font_description_set_absolute_size(desc, size);"},{"type":"del","del":true,"ln":242,"content":"-    } else {"},{"type":"del","del":true,"ln":243,"content":"-        pango_font_description_set_size(desc,"},{"type":"del","del":true,"ln":244,"content":"-                                        (gint)(size * 72.0 /"},{"type":"del","del":true,"ln":245,"content":"-                                               gfxPlatformGtk::DPI()));"},{"type":"del","del":true,"ln":246,"content":"-    }"},{"type":"del","del":true,"ln":247,"content":"-}"},{"type":"del","del":true,"ln":248,"content":"-#else"},{"type":"del","del":true,"ln":249,"content":"-static inline void InitPangoLib()"},{"type":"del","del":true,"ln":250,"content":"-{"},{"type":"del","del":true,"ln":251,"content":"-}"},{"type":"del","del":true,"ln":252,"content":"-"},{"type":"del","del":true,"ln":253,"content":"-static inline void ShutdownPangoLib()"},{"type":"del","del":true,"ln":254,"content":"-{"},{"type":"del","del":true,"ln":255,"content":"-}"},{"type":"del","del":true,"ln":256,"content":"-"},{"type":"del","del":true,"ln":257,"content":"-static inline void"},{"type":"del","del":true,"ln":258,"content":"-MOZ_pango_font_description_set_absolute_size(PangoFontDescription *desc, double size)"},{"type":"del","del":true,"ln":259,"content":"-{"},{"type":"del","del":true,"ln":260,"content":"-    pango_font_description_set_absolute_size(desc, size);"},{"type":"del","del":true,"ln":261,"content":"-}"},{"type":"del","del":true,"ln":262,"content":"-#endif"},{"type":"del","del":true,"ln":263,"content":"-"},{"type":"normal","normal":true,"ln1":264,"ln2":187,"content":" gfxPangoFont::gfxPangoFont(const nsAString &aName,"},{"type":"normal","normal":true,"ln1":265,"ln2":188,"content":"                            const gfxFontStyle *aFontStyle)"},{"type":"normal","normal":true,"ln1":266,"ln2":189,"content":"     : gfxFont(aName, aFontStyle),"},{"type":"del","del":true,"ln":267,"content":"-    mPangoFontDesc(nsnull), mPangoCtx(nsnull),"},{"type":"del","del":true,"ln":268,"content":"-    mXftFont(nsnull), mPangoFont(nsnull), mGlyphTestingFont(nsnull),"},{"type":"del","del":true,"ln":269,"content":"-    mCairoFont(nsnull), mHasMetrics(PR_FALSE),"},{"type":"del","del":true,"ln":270,"content":"-    mAdjustedSize(0)"},{"type":"add","add":true,"ln":190,"content":"+    mPangoFontDesc(nsnull), mPangoCtx(nsnull), mPangoFont(nsnull),"},{"type":"add","add":true,"ln":191,"content":"+    mCairoFont(nsnull), mHasMetrics(PR_FALSE), mAdjustedSize(0)"},{"type":"normal","normal":true,"ln1":271,"ln2":192,"content":" {"},{"type":"del","del":true,"ln":272,"content":"-    InitPangoLib();"},{"type":"normal","normal":true,"ln1":273,"ln2":193,"content":" }"},{"type":"normal","normal":true,"ln1":274,"ln2":194,"content":" "},{"type":"normal","normal":true,"ln1":275,"ln2":195,"content":" gfxPangoFont::~gfxPangoFont()"}],"oldStart":194,"oldLines":82,"newStart":184,"newLines":12},{"content":"@@ -280,9 +200,6 @@ gfxPangoFont::~gfxPangoFont()","changes":[{"type":"normal","normal":true,"ln1":280,"ln2":200,"content":"     if (mPangoFont)"},{"type":"normal","normal":true,"ln1":281,"ln2":201,"content":"         g_object_unref(mPangoFont);"},{"type":"normal","normal":true,"ln1":282,"ln2":202,"content":" "},{"type":"del","del":true,"ln":283,"content":"-    if (mGlyphTestingFont)"},{"type":"del","del":true,"ln":284,"content":"-        g_object_unref(mGlyphTestingFont);"},{"type":"del","del":true,"ln":285,"content":"-"},{"type":"normal","normal":true,"ln1":286,"ln2":203,"content":"     if (mPangoFontDesc)"},{"type":"normal","normal":true,"ln1":287,"ln2":204,"content":"         pango_font_description_free(mPangoFontDesc);"},{"type":"normal","normal":true,"ln1":288,"ln2":205,"content":" "}],"oldStart":280,"oldLines":9,"newStart":200,"newLines":6},{"content":"@@ -293,9 +210,12 @@ gfxPangoFont::~gfxPangoFont()","changes":[{"type":"normal","normal":true,"ln1":293,"ln2":210,"content":" /* static */ void"},{"type":"normal","normal":true,"ln1":294,"ln2":211,"content":" gfxPangoFont::Shutdown()"},{"type":"normal","normal":true,"ln1":295,"ln2":212,"content":" {"},{"type":"del","del":true,"ln":296,"content":"-    ShutdownPangoLib();"},{"type":"normal","normal":true,"ln1":297,"ln2":213,"content":"     gfxPangoFontCache::Shutdown();"},{"type":"del","del":true,"ln":298,"content":"-    gfxPangoFontNameMap::Shutdown();"},{"type":"add","add":true,"ln":214,"content":"+"},{"type":"add","add":true,"ln":215,"content":"+    PangoFontMap *fontmap = pango_cairo_font_map_get_default ();"},{"type":"add","add":true,"ln":216,"content":"+    if (PANGO_IS_FC_FONT_MAP (fontmap))"},{"type":"add","add":true,"ln":217,"content":"+\tpango_fc_font_map_shutdown (PANGO_FC_FONT_MAP (fontmap));"},{"type":"add","add":true,"ln":218,"content":"+"},{"type":"normal","normal":true,"ln1":299,"ln2":219,"content":" }"},{"type":"normal","normal":true,"ln1":300,"ln2":220,"content":" "},{"type":"normal","normal":true,"ln1":301,"ln2":221,"content":" static PangoStyle"}],"oldStart":293,"oldLines":9,"newStart":210,"newLines":12},{"content":"@@ -375,28 +295,24 @@ gfxPangoFont::RealizeFont(PRBool force)","changes":[{"type":"normal","normal":true,"ln1":375,"ln2":295,"content":"     if (mPangoFont) {"},{"type":"normal","normal":true,"ln1":376,"ln2":296,"content":"         g_object_unref(mPangoFont);"},{"type":"normal","normal":true,"ln1":377,"ln2":297,"content":"         mPangoFont = nsnull;"},{"type":"del","del":true,"ln":378,"content":"-        mXftFont = nsnull;"},{"type":"del","del":true,"ln":379,"content":"-        // XXX we don't need to reset mGlyphTestingFont"},{"type":"normal","normal":true,"ln1":380,"ln2":298,"content":"     }"},{"type":"normal","normal":true,"ln1":381,"ln2":299,"content":" "},{"type":"normal","normal":true,"ln1":382,"ln2":300,"content":"     mPangoFontDesc = pango_font_description_new();"},{"type":"normal","normal":true,"ln1":383,"ln2":301,"content":" "},{"type":"normal","normal":true,"ln1":384,"ln2":302,"content":"     pango_font_description_set_family(mPangoFontDesc, NS_ConvertUTF16toUTF8(mName).get());"},{"type":"normal","normal":true,"ln1":385,"ln2":303,"content":"     gfxFloat size = mAdjustedSize ? mAdjustedSize : GetStyle()->size;"},{"type":"del","del":true,"ln":386,"content":"-    MOZ_pango_font_description_set_absolute_size(mPangoFontDesc, size * PANGO_SCALE);"},{"type":"add","add":true,"ln":304,"content":"+    pango_font_description_set_absolute_size(mPangoFontDesc, size * PANGO_SCALE);"},{"type":"normal","normal":true,"ln1":387,"ln2":305,"content":"     pango_font_description_set_style(mPangoFontDesc, ThebesStyleToPangoStyle(GetStyle()));"},{"type":"normal","normal":true,"ln1":388,"ln2":306,"content":"     pango_font_description_set_weight(mPangoFontDesc, ThebesStyleToPangoWeight(GetStyle()));"},{"type":"normal","normal":true,"ln1":389,"ln2":307,"content":" "},{"type":"normal","normal":true,"ln1":390,"ln2":308,"content":"     //printf (\"%s, %f, %d, %d\\n\", NS_ConvertUTF16toUTF8(mName).get(), GetStyle()->size, ThebesStyleToPangoStyle(GetStyle()), ThebesStyleToPangoWeight(GetStyle()));"},{"type":"del","del":true,"ln":391,"content":"-#ifndef THEBES_USE_PANGO_CAIRO"},{"type":"del","del":true,"ln":392,"content":"-    mPangoCtx = pango_xft_get_context(GDK_DISPLAY(), 0);"},{"type":"del","del":true,"ln":393,"content":"-    gdk_pango_context_set_colormap(mPangoCtx, gdk_rgb_get_cmap());"},{"type":"del","del":true,"ln":394,"content":"-#else"},{"type":"del","del":true,"ln":395,"content":"-    mPangoCtx = pango_cairo_font_map_create_context(PANGO_CAIRO_FONT_MAP(pango_cairo_font_map_get_default()));"},{"type":"del","del":true,"ln":396,"content":"-#endif"},{"type":"add","add":true,"ln":309,"content":"+    mPangoCtx = gdk_pango_context_get ();"},{"type":"normal","normal":true,"ln1":397,"ln2":310,"content":" "},{"type":"del","del":true,"ln":398,"content":"-    if (!GetStyle()->langGroup.IsEmpty())"},{"type":"del","del":true,"ln":399,"content":"-        pango_context_set_language(mPangoCtx, GetPangoLanguage(GetStyle()->langGroup));"},{"type":"add","add":true,"ln":311,"content":"+    if (!GetStyle()->langGroup.IsEmpty()) {"},{"type":"add","add":true,"ln":312,"content":"+        PangoLanguage *lang = GetPangoLanguage(GetStyle()->langGroup);"},{"type":"add","add":true,"ln":313,"content":"+        if (lang)"},{"type":"add","add":true,"ln":314,"content":"+            pango_context_set_language(mPangoCtx, lang);"},{"type":"add","add":true,"ln":315,"content":"+    }"},{"type":"normal","normal":true,"ln1":400,"ln2":316,"content":" "},{"type":"normal","normal":true,"ln1":401,"ln2":317,"content":"     pango_context_set_font_description(mPangoCtx, mPangoFontDesc);"},{"type":"normal","normal":true,"ln1":402,"ln2":318,"content":" "}],"oldStart":375,"oldLines":28,"newStart":295,"newLines":24},{"content":"@@ -417,20 +333,6 @@ gfxPangoFont::RealizeFont(PRBool force)","changes":[{"type":"normal","normal":true,"ln1":417,"ln2":333,"content":" }"},{"type":"normal","normal":true,"ln1":418,"ln2":334,"content":" "},{"type":"normal","normal":true,"ln1":419,"ln2":335,"content":" void"},{"type":"del","del":true,"ln":420,"content":"-gfxPangoFont::RealizeXftFont(PRBool force)"},{"type":"del","del":true,"ln":421,"content":"-{"},{"type":"del","del":true,"ln":422,"content":"-    // already realized?"},{"type":"del","del":true,"ln":423,"content":"-    if (!force && mXftFont)"},{"type":"del","del":true,"ln":424,"content":"-        return;"},{"type":"del","del":true,"ln":425,"content":"-    if (GDK_DISPLAY() == 0) {"},{"type":"del","del":true,"ln":426,"content":"-        mXftFont = nsnull;"},{"type":"del","del":true,"ln":427,"content":"-        return;"},{"type":"del","del":true,"ln":428,"content":"-    }"},{"type":"del","del":true,"ln":429,"content":"-"},{"type":"del","del":true,"ln":430,"content":"-    mXftFont = pango_xft_font_get_font(GetPangoFont());"},{"type":"del","del":true,"ln":431,"content":"-}"},{"type":"del","del":true,"ln":432,"content":"-"},{"type":"del","del":true,"ln":433,"content":"-void"},{"type":"normal","normal":true,"ln1":434,"ln2":336,"content":" gfxPangoFont::RealizePangoFont(PRBool aForce)"},{"type":"normal","normal":true,"ln1":435,"ln2":337,"content":" {"},{"type":"normal","normal":true,"ln1":436,"ln2":338,"content":"     if (!aForce && mPangoFont)"}],"oldStart":417,"oldLines":20,"newStart":333,"newLines":6},{"content":"@@ -438,7 +340,6 @@ gfxPangoFont::RealizePangoFont(PRBool aForce)","changes":[{"type":"normal","normal":true,"ln1":438,"ln2":340,"content":"     if (mPangoFont) {"},{"type":"normal","normal":true,"ln1":439,"ln2":341,"content":"         g_object_unref(mPangoFont);"},{"type":"normal","normal":true,"ln1":440,"ln2":342,"content":"         mPangoFont = nsnull;"},{"type":"del","del":true,"ln":441,"content":"-        mXftFont = nsnull;"},{"type":"normal","normal":true,"ln1":442,"ln2":343,"content":"     }"},{"type":"normal","normal":true,"ln1":443,"ln2":344,"content":"     RealizeFont();"},{"type":"normal","normal":true,"ln1":444,"ln2":345,"content":"     gfxPangoFontCache *cache = gfxPangoFontCache::GetPangoFontCache();"}],"oldStart":438,"oldLines":7,"newStart":340,"newLines":6},{"content":"@@ -451,19 +352,6 @@ gfxPangoFont::RealizePangoFont(PRBool aForce)","changes":[{"type":"normal","normal":true,"ln1":451,"ln2":352,"content":"     if (!mPangoFont)"},{"type":"normal","normal":true,"ln1":452,"ln2":353,"content":"         return; // Error"},{"type":"normal","normal":true,"ln1":453,"ln2":354,"content":"     cache->Put(mPangoFontDesc, mPangoFont);"},{"type":"del","del":true,"ln":454,"content":"-"},{"type":"del","del":true,"ln":455,"content":"-    if (mGlyphTestingFont)"},{"type":"del","del":true,"ln":456,"content":"-        return;"},{"type":"del","del":true,"ln":457,"content":"-"},{"type":"del","del":true,"ln":458,"content":"-    // Append this to font name map"},{"type":"del","del":true,"ln":459,"content":"-    gfxPangoFontNameMap *fontNameMap = gfxPangoFontNameMap::GetPangoFontNameMap();"},{"type":"del","del":true,"ln":460,"content":"-    if (!fontNameMap)"},{"type":"del","del":true,"ln":461,"content":"-        return; // Error"},{"type":"del","del":true,"ln":462,"content":"-    NS_ConvertUTF16toUTF8 name(mName);"},{"type":"del","del":true,"ln":463,"content":"-    mGlyphTestingFont = fontNameMap->Get(name);"},{"type":"del","del":true,"ln":464,"content":"-    if (mGlyphTestingFont)"},{"type":"del","del":true,"ln":465,"content":"-        return;"},{"type":"del","del":true,"ln":466,"content":"-    fontNameMap->Put(name, mPangoFont);"},{"type":"normal","normal":true,"ln1":467,"ln2":355,"content":" }"},{"type":"normal","normal":true,"ln1":468,"ln2":356,"content":" "},{"type":"normal","normal":true,"ln1":469,"ln2":357,"content":" void"}],"oldStart":451,"oldLines":19,"newStart":352,"newLines":6},{"content":"@@ -520,89 +408,6 @@ gfxPangoFont::GetMetrics()","changes":[{"type":"normal","normal":true,"ln1":520,"ln2":408,"content":"     if (mHasMetrics)"},{"type":"normal","normal":true,"ln1":521,"ln2":409,"content":"         return mMetrics;"},{"type":"normal","normal":true,"ln1":522,"ln2":410,"content":" "},{"type":"del","del":true,"ln":523,"content":"-#ifndef THEBES_USE_PANGO_CAIRO"},{"type":"del","del":true,"ln":524,"content":"-    float val;"},{"type":"del","del":true,"ln":525,"content":"-"},{"type":"del","del":true,"ln":526,"content":"-    XftFont *xftFont = GetXftFont(); // RealizeFont is called here."},{"type":"del","del":true,"ln":527,"content":"-    if (!xftFont)"},{"type":"del","del":true,"ln":528,"content":"-        return mMetrics;        // XXX error"},{"type":"del","del":true,"ln":529,"content":"-"},{"type":"del","del":true,"ln":530,"content":"-    FT_Face face = XftLockFace(xftFont);"},{"type":"del","del":true,"ln":531,"content":"-    if (!face)"},{"type":"del","del":true,"ln":532,"content":"-        return mMetrics;        // XXX error"},{"type":"del","del":true,"ln":533,"content":"-"},{"type":"del","del":true,"ln":534,"content":"-    int size;"},{"type":"del","del":true,"ln":535,"content":"-    PangoFcFont *fcfont = PANGO_FC_FONT(mPangoFont);"},{"type":"del","del":true,"ln":536,"content":"-    if (FcPatternGetInteger(fcfont->font_pattern, FC_PIXEL_SIZE, 0, &size) != FcResultMatch)"},{"type":"del","del":true,"ln":537,"content":"-        size = 12;"},{"type":"del","del":true,"ln":538,"content":"-    mMetrics.emHeight = PR_MAX(1, size);"},{"type":"del","del":true,"ln":539,"content":"-"},{"type":"del","del":true,"ln":540,"content":"-    mMetrics.maxAscent = xftFont->ascent;"},{"type":"del","del":true,"ln":541,"content":"-    mMetrics.maxDescent = xftFont->descent;"},{"type":"del","del":true,"ln":542,"content":"-"},{"type":"del","del":true,"ln":543,"content":"-    double lineHeight = mMetrics.maxAscent + mMetrics.maxDescent;"},{"type":"del","del":true,"ln":544,"content":"-"},{"type":"del","del":true,"ln":545,"content":"-    if (lineHeight > mMetrics.emHeight)"},{"type":"del","del":true,"ln":546,"content":"-        mMetrics.internalLeading = lineHeight - mMetrics.emHeight;"},{"type":"del","del":true,"ln":547,"content":"-    else"},{"type":"del","del":true,"ln":548,"content":"-        mMetrics.internalLeading = 0;"},{"type":"del","del":true,"ln":549,"content":"-    mMetrics.externalLeading = 0;"},{"type":"del","del":true,"ln":550,"content":"-"},{"type":"del","del":true,"ln":551,"content":"-    mMetrics.maxHeight = lineHeight;"},{"type":"del","del":true,"ln":552,"content":"-    mMetrics.emAscent = mMetrics.maxAscent * mMetrics.emHeight / lineHeight;"},{"type":"del","del":true,"ln":553,"content":"-    mMetrics.emDescent = mMetrics.emHeight - mMetrics.emAscent;"},{"type":"del","del":true,"ln":554,"content":"-    mMetrics.maxAdvance = xftFont->max_advance_width;"},{"type":"del","del":true,"ln":555,"content":"-"},{"type":"del","del":true,"ln":556,"content":"-    gfxSize isz, lsz;"},{"type":"del","del":true,"ln":557,"content":"-    GetCharSize(' ', isz, lsz, &mSpaceGlyph);"},{"type":"del","del":true,"ln":558,"content":"-    mMetrics.spaceWidth = lsz.width;"},{"type":"del","del":true,"ln":559,"content":"-"},{"type":"del","del":true,"ln":560,"content":"-    // XXX do some FcCharSetHasChar work here to make sure"},{"type":"del","del":true,"ln":561,"content":"-    // we have an \"x\""},{"type":"del","del":true,"ln":562,"content":"-    GetCharSize('x', isz, lsz);"},{"type":"del","del":true,"ln":563,"content":"-    mMetrics.xHeight = isz.height;"},{"type":"del","del":true,"ln":564,"content":"-    mMetrics.aveCharWidth = isz.width;"},{"type":"del","del":true,"ln":565,"content":"-"},{"type":"del","del":true,"ln":566,"content":"-    val = CONVERT_DESIGN_UNITS_TO_PIXELS(face->underline_position,"},{"type":"del","del":true,"ln":567,"content":"-                                         face->size->metrics.y_scale);"},{"type":"del","del":true,"ln":568,"content":"-    if (!val)"},{"type":"del","del":true,"ln":569,"content":"-        val = - PR_MAX(1, floor(0.1 * xftFont->height + 0.5));"},{"type":"del","del":true,"ln":570,"content":"-"},{"type":"del","del":true,"ln":571,"content":"-    mMetrics.underlineOffset = val;"},{"type":"del","del":true,"ln":572,"content":"-"},{"type":"del","del":true,"ln":573,"content":"-    val = CONVERT_DESIGN_UNITS_TO_PIXELS(face->underline_thickness,"},{"type":"del","del":true,"ln":574,"content":"-                                         face->size->metrics.y_scale);"},{"type":"del","del":true,"ln":575,"content":"-    if (!val)"},{"type":"del","del":true,"ln":576,"content":"-        val = floor(0.05 * xftFont->height + 0.5);"},{"type":"del","del":true,"ln":577,"content":"-"},{"type":"del","del":true,"ln":578,"content":"-    mMetrics.underlineSize = PR_MAX(1, val);"},{"type":"del","del":true,"ln":579,"content":"-"},{"type":"del","del":true,"ln":580,"content":"-    TT_OS2 *os2 = (TT_OS2 *) FT_Get_Sfnt_Table(face, ft_sfnt_os2);"},{"type":"del","del":true,"ln":581,"content":"-"},{"type":"del","del":true,"ln":582,"content":"-    if (os2 && os2->ySuperscriptYOffset) {"},{"type":"del","del":true,"ln":583,"content":"-        val = CONVERT_DESIGN_UNITS_TO_PIXELS(os2->ySuperscriptYOffset,"},{"type":"del","del":true,"ln":584,"content":"-                                             face->size->metrics.y_scale);"},{"type":"del","del":true,"ln":585,"content":"-        mMetrics.superscriptOffset = PR_MAX(1, val);"},{"type":"del","del":true,"ln":586,"content":"-    } else {"},{"type":"del","del":true,"ln":587,"content":"-        mMetrics.superscriptOffset = mMetrics.xHeight;"},{"type":"del","del":true,"ln":588,"content":"-    }"},{"type":"del","del":true,"ln":589,"content":"-"},{"type":"del","del":true,"ln":590,"content":"-    // mSubscriptOffset"},{"type":"del","del":true,"ln":591,"content":"-    if (os2 && os2->ySubscriptYOffset) {"},{"type":"del","del":true,"ln":592,"content":"-        val = CONVERT_DESIGN_UNITS_TO_PIXELS(os2->ySubscriptYOffset,"},{"type":"del","del":true,"ln":593,"content":"-                                             face->size->metrics.y_scale);"},{"type":"del","del":true,"ln":594,"content":"-        // some fonts have the incorrect sign. "},{"type":"del","del":true,"ln":595,"content":"-        val = (val < 0) ? -val : val;"},{"type":"del","del":true,"ln":596,"content":"-        mMetrics.subscriptOffset = PR_MAX(1, val);"},{"type":"del","del":true,"ln":597,"content":"-    } else {"},{"type":"del","del":true,"ln":598,"content":"-        mMetrics.subscriptOffset = mMetrics.xHeight;"},{"type":"del","del":true,"ln":599,"content":"-    }"},{"type":"del","del":true,"ln":600,"content":"-"},{"type":"del","del":true,"ln":601,"content":"-    mMetrics.strikeoutOffset = mMetrics.xHeight / 2.0;"},{"type":"del","del":true,"ln":602,"content":"-    mMetrics.strikeoutSize = mMetrics.underlineSize;"},{"type":"del","del":true,"ln":603,"content":"-"},{"type":"del","del":true,"ln":604,"content":"-    XftUnlockFace(xftFont);"},{"type":"del","del":true,"ln":605,"content":"-#else"},{"type":"normal","normal":true,"ln1":606,"ln2":411,"content":"     /* pango_cairo case; try to get all the metrics from pango itself */"},{"type":"normal","normal":true,"ln1":607,"ln2":412,"content":"     PangoFont *font = GetPangoFont(); // RealizeFont is called here."},{"type":"normal","normal":true,"ln1":608,"ln2":413,"content":" "}],"oldStart":520,"oldLines":89,"newStart":408,"newLines":6},{"content":"@@ -627,7 +432,8 @@ gfxPangoFont::GetMetrics()","changes":[{"type":"normal","normal":true,"ln1":627,"ln2":432,"content":"     mMetrics.emAscent = mMetrics.maxAscent * mMetrics.emHeight / lineHeight;"},{"type":"normal","normal":true,"ln1":628,"ln2":433,"content":"     mMetrics.emDescent = mMetrics.emHeight - mMetrics.emAscent;"},{"type":"normal","normal":true,"ln1":629,"ln2":434,"content":" "},{"type":"del","del":true,"ln":630,"content":"-    mMetrics.maxAdvance = pango_font_metrics_get_approximate_char_width(pfm) / FLOAT_PANGO_SCALE; // XXX"},{"type":"add","add":true,"ln":435,"content":"+    // XXX should we move this down, get max-advance from FT_Face?"},{"type":"add","add":true,"ln":436,"content":"+    mMetrics.maxAdvance = pango_font_metrics_get_approximate_char_width(pfm) / FLOAT_PANGO_SCALE;"},{"type":"normal","normal":true,"ln1":631,"ln2":437,"content":" "},{"type":"normal","normal":true,"ln1":632,"ln2":438,"content":"     gfxSize isz, lsz;"},{"type":"normal","normal":true,"ln1":633,"ln2":439,"content":"     GetCharSize(' ', isz, lsz, &mSpaceGlyph);"}],"oldStart":627,"oldLines":7,"newStart":432,"newLines":8},{"content":"@@ -643,14 +449,43 @@ gfxPangoFont::GetMetrics()","changes":[{"type":"normal","normal":true,"ln1":643,"ln2":449,"content":"     mMetrics.strikeoutOffset = pango_font_metrics_get_strikethrough_position(pfm) / FLOAT_PANGO_SCALE;"},{"type":"normal","normal":true,"ln1":644,"ln2":450,"content":"     mMetrics.strikeoutSize = pango_font_metrics_get_strikethrough_thickness(pfm) / FLOAT_PANGO_SCALE;"},{"type":"normal","normal":true,"ln1":645,"ln2":451,"content":" "},{"type":"del","del":true,"ln":646,"content":"-    // these are specified by the so-called OS2 SFNT info, but"},{"type":"del","del":true,"ln":647,"content":"-    // pango doesn't expose this to us.  This really sucks,"},{"type":"del","del":true,"ln":648,"content":"-    // so we just assume it's the xHeight"},{"type":"del","del":true,"ln":649,"content":"-    mMetrics.superscriptOffset = mMetrics.xHeight;"},{"type":"del","del":true,"ln":650,"content":"-    mMetrics.subscriptOffset = mMetrics.xHeight;"},{"type":"add","add":true,"ln":452,"content":"+    FT_Face face = NULL;"},{"type":"add","add":true,"ln":453,"content":"+    if (PANGO_IS_FC_FONT (font))"},{"type":"add","add":true,"ln":454,"content":"+      face = pango_fc_font_lock_face (PANGO_FC_FONT (font));"},{"type":"add","add":true,"ln":455,"content":"+"},{"type":"add","add":true,"ln":456,"content":"+    if (face) {"},{"type":"add","add":true,"ln":457,"content":"+"},{"type":"add","add":true,"ln":458,"content":"+\tfloat val;"},{"type":"add","add":true,"ln":459,"content":"+"},{"type":"add","add":true,"ln":460,"content":"+        TT_OS2 *os2 = (TT_OS2 *) FT_Get_Sfnt_Table(face, ft_sfnt_os2);"},{"type":"add","add":true,"ln":461,"content":"+    "},{"type":"add","add":true,"ln":462,"content":"+        if (os2 && os2->ySuperscriptYOffset) {"},{"type":"add","add":true,"ln":463,"content":"+            val = CONVERT_DESIGN_UNITS_TO_PIXELS(os2->ySuperscriptYOffset,"},{"type":"add","add":true,"ln":464,"content":"+                                                 face->size->metrics.y_scale);"},{"type":"add","add":true,"ln":465,"content":"+            mMetrics.superscriptOffset = PR_MAX(1, val);"},{"type":"add","add":true,"ln":466,"content":"+        } else {"},{"type":"add","add":true,"ln":467,"content":"+            mMetrics.superscriptOffset = mMetrics.xHeight;"},{"type":"add","add":true,"ln":468,"content":"+        }"},{"type":"add","add":true,"ln":469,"content":"+    "},{"type":"add","add":true,"ln":470,"content":"+        // mSubscriptOffset"},{"type":"add","add":true,"ln":471,"content":"+        if (os2 && os2->ySubscriptYOffset) {"},{"type":"add","add":true,"ln":472,"content":"+            val = CONVERT_DESIGN_UNITS_TO_PIXELS(os2->ySubscriptYOffset,"},{"type":"add","add":true,"ln":473,"content":"+                                                 face->size->metrics.y_scale);"},{"type":"add","add":true,"ln":474,"content":"+            // some fonts have the incorrect sign. "},{"type":"add","add":true,"ln":475,"content":"+            val = (val < 0) ? -val : val;"},{"type":"add","add":true,"ln":476,"content":"+            mMetrics.subscriptOffset = PR_MAX(1, val);"},{"type":"add","add":true,"ln":477,"content":"+        } else {"},{"type":"add","add":true,"ln":478,"content":"+            mMetrics.subscriptOffset = mMetrics.xHeight;"},{"type":"add","add":true,"ln":479,"content":"+        }"},{"type":"add","add":true,"ln":480,"content":"+"},{"type":"add","add":true,"ln":481,"content":"+    } else {"},{"type":"add","add":true,"ln":482,"content":"+"},{"type":"add","add":true,"ln":483,"content":"+\tmMetrics.superscriptOffset = mMetrics.xHeight;"},{"type":"add","add":true,"ln":484,"content":"+\tmMetrics.subscriptOffset = mMetrics.xHeight;"},{"type":"add","add":true,"ln":485,"content":"+    }"},{"type":"add","add":true,"ln":486,"content":"+"},{"type":"normal","normal":true,"ln1":651,"ln2":487,"content":" "},{"type":"normal","normal":true,"ln1":652,"ln2":488,"content":"     pango_font_metrics_unref (pfm);"},{"type":"del","del":true,"ln":653,"content":"-#endif"},{"type":"normal","normal":true,"ln1":654,"ln2":489,"content":" "},{"type":"normal","normal":true,"ln1":655,"ln2":490,"content":" #if 0"},{"type":"normal","normal":true,"ln1":656,"ln2":491,"content":"     fprintf (stderr, \"Font: %s\\n\", NS_ConvertUTF16toUTF8(mName).get());"}],"oldStart":643,"oldLines":14,"newStart":449,"newLines":43},{"content":"@@ -665,66 +500,13 @@ gfxPangoFont::GetMetrics()","changes":[{"type":"normal","normal":true,"ln1":665,"ln2":500,"content":"     return mMetrics;"},{"type":"normal","normal":true,"ln1":666,"ln2":501,"content":" }"},{"type":"normal","normal":true,"ln1":667,"ln2":502,"content":" "},{"type":"del","del":true,"ln":668,"content":"-// XXX we should replace this to |pango_is_zero_width| after we don't support pre pango 1.10"},{"type":"del","del":true,"ln":669,"content":"-static PRBool MOZ_pango_is_zero_width(PRUint32 aChar)"},{"type":"del","del":true,"ln":670,"content":"-{"},{"type":"del","del":true,"ln":671,"content":"-    if (aChar == 0x00AD)"},{"type":"del","del":true,"ln":672,"content":"-        return PR_TRUE;"},{"type":"del","del":true,"ln":673,"content":"-    if (aChar < 0x200B)"},{"type":"del","del":true,"ln":674,"content":"-        return PR_FALSE;"},{"type":"del","del":true,"ln":675,"content":"-    if (aChar <= 0x200F || aChar == 0x2028)"},{"type":"del","del":true,"ln":676,"content":"-        return PR_TRUE;"},{"type":"del","del":true,"ln":677,"content":"-    if (aChar < 0x202A)"},{"type":"del","del":true,"ln":678,"content":"-        return PR_FALSE;"},{"type":"del","del":true,"ln":679,"content":"-    if (aChar <= 0x202E)"},{"type":"del","del":true,"ln":680,"content":"-        return PR_TRUE;"},{"type":"del","del":true,"ln":681,"content":"-    if (aChar < 0x2060)"},{"type":"del","del":true,"ln":682,"content":"-        return PR_FALSE;"},{"type":"del","del":true,"ln":683,"content":"-    if (aChar <= 0x2063 || aChar == 0xFEFF)"},{"type":"del","del":true,"ln":684,"content":"-        return PR_TRUE;"},{"type":"del","del":true,"ln":685,"content":"-    return PR_FALSE;"},{"type":"del","del":true,"ln":686,"content":"-}"},{"type":"del","del":true,"ln":687,"content":"-PRBool"},{"type":"del","del":true,"ln":688,"content":"-gfxPangoFont::HasGlyph(PRUint32 aChar)"},{"type":"del","del":true,"ln":689,"content":"-{"},{"type":"del","del":true,"ln":690,"content":"-    // Ensure that null character should be missing."},{"type":"del","del":true,"ln":691,"content":"-    if (aChar == 0)"},{"type":"del","del":true,"ln":692,"content":"-        return PR_FALSE;"},{"type":"del","del":true,"ln":693,"content":"-"},{"type":"del","del":true,"ln":694,"content":"-    if (MOZ_pango_is_zero_width(aChar))"},{"type":"del","del":true,"ln":695,"content":"-        return PR_TRUE;"},{"type":"del","del":true,"ln":696,"content":"-"},{"type":"del","del":true,"ln":697,"content":"-    PangoFont *font = nsnull;"},{"type":"del","del":true,"ln":698,"content":"-    if (mPangoFont)"},{"type":"del","del":true,"ln":699,"content":"-        font = mPangoFont;"},{"type":"del","del":true,"ln":700,"content":"-    else if (mGlyphTestingFont)"},{"type":"del","del":true,"ln":701,"content":"-        font = mGlyphTestingFont;"},{"type":"del","del":true,"ln":702,"content":"-    else {"},{"type":"del","del":true,"ln":703,"content":"-        gfxPangoFontNameMap *fontNameMap = gfxPangoFontNameMap::GetPangoFontNameMap();"},{"type":"del","del":true,"ln":704,"content":"-        NS_ENSURE_TRUE(fontNameMap, PR_FALSE);"},{"type":"del","del":true,"ln":705,"content":"-        // XXX in a prinsiple, we need to add weight and style for the key."},{"type":"del","del":true,"ln":706,"content":"-        // But this method should be independent from pango for the performance."},{"type":"del","del":true,"ln":707,"content":"-        // For the temporary, the name is enough for the key. The members of"},{"type":"del","del":true,"ln":708,"content":"-        // a font-family should have same glyphs."},{"type":"del","del":true,"ln":709,"content":"-        NS_ConvertUTF16toUTF8 name(mName);"},{"type":"del","del":true,"ln":710,"content":"-        mGlyphTestingFont = fontNameMap->Get(name);"},{"type":"del","del":true,"ln":711,"content":"-        if (!mGlyphTestingFont) {"},{"type":"del","del":true,"ln":712,"content":"-            font = GetPangoFont();"},{"type":"del","del":true,"ln":713,"content":"-            NS_ENSURE_TRUE(font, PR_FALSE);"},{"type":"del","del":true,"ln":714,"content":"-        } else"},{"type":"del","del":true,"ln":715,"content":"-            font = mGlyphTestingFont;"},{"type":"del","del":true,"ln":716,"content":"-    }"},{"type":"del","del":true,"ln":717,"content":"-    return pango_fc_font_has_char(PANGO_FC_FONT(font), aChar) ? PR_TRUE : PR_FALSE;"},{"type":"del","del":true,"ln":718,"content":"-}"},{"type":"del","del":true,"ln":719,"content":"-"},{"type":"normal","normal":true,"ln1":720,"ln2":503,"content":" PRUint32"},{"type":"normal","normal":true,"ln1":721,"ln2":504,"content":" gfxPangoFont::GetGlyph(const PRUint32 aChar)"},{"type":"normal","normal":true,"ln1":722,"ln2":505,"content":" {"},{"type":"normal","normal":true,"ln1":723,"ln2":506,"content":"     // Ensure that null character should be missing."},{"type":"normal","normal":true,"ln1":724,"ln2":507,"content":"     if (aChar == 0)"},{"type":"normal","normal":true,"ln1":725,"ln2":508,"content":"         return 0;"},{"type":"del","del":true,"ln":726,"content":"-    RealizePangoFont();"},{"type":"del","del":true,"ln":727,"content":"-    return pango_fc_font_get_glyph(PANGO_FC_FONT(mPangoFont), aChar);"},{"type":"add","add":true,"ln":509,"content":"+    return pango_fc_font_get_glyph(PANGO_FC_FONT(GetPangoFont()), aChar);"},{"type":"normal","normal":true,"ln1":728,"ln2":510,"content":" }"},{"type":"normal","normal":true,"ln1":729,"ln2":511,"content":" "},{"type":"normal","normal":true,"ln1":730,"ln2":512,"content":" nsString"}],"oldStart":665,"oldLines":66,"newStart":500,"newLines":13},{"content":"@@ -732,16 +514,9 @@ gfxPangoFont::GetUniqueName()","changes":[{"type":"normal","normal":true,"ln1":732,"ln2":514,"content":" {"},{"type":"normal","normal":true,"ln1":733,"ln2":515,"content":"     PangoFont *font = GetPangoFont();"},{"type":"normal","normal":true,"ln1":734,"ln2":516,"content":"     PangoFontDescription *desc = pango_font_describe(font);"},{"type":"add","add":true,"ln":517,"content":"+    pango_font_description_unset_fields (desc, PANGO_FONT_MASK_SIZE);"},{"type":"normal","normal":true,"ln1":735,"ln2":518,"content":"     char *str = pango_font_description_to_string(desc);"},{"type":"del","del":true,"ln":736,"content":"-"},{"type":"del","del":true,"ln":737,"content":"-    // chop off the trailing size, e.g. \"Albany AMT 15.359375\" -> \"Albany AMT\""},{"type":"del","del":true,"ln":738,"content":"-    PRUint32 end = strlen(str);"},{"type":"del","del":true,"ln":739,"content":"-    while (end > 0) {"},{"type":"del","del":true,"ln":740,"content":"-        --end;"},{"type":"del","del":true,"ln":741,"content":"-        if (str[end] == ' ')"},{"type":"del","del":true,"ln":742,"content":"-            break;"},{"type":"del","del":true,"ln":743,"content":"-    }"},{"type":"del","del":true,"ln":744,"content":"-    str[end] = 0;"},{"type":"add","add":true,"ln":519,"content":"+    pango_font_description_free (desc);"},{"type":"normal","normal":true,"ln1":745,"ln2":520,"content":" "},{"type":"normal","normal":true,"ln1":746,"ln2":521,"content":"     nsString result;"},{"type":"normal","normal":true,"ln1":747,"ln2":522,"content":"     CopyUTF8toUTF16(str, result);"}],"oldStart":732,"oldLines":16,"newStart":514,"newLines":9},{"content":"@@ -749,32 +524,6 @@ gfxPangoFont::GetUniqueName()","changes":[{"type":"normal","normal":true,"ln1":749,"ln2":524,"content":"     return result;"},{"type":"normal","normal":true,"ln1":750,"ln2":525,"content":" }"},{"type":"normal","normal":true,"ln1":751,"ln2":526,"content":" "},{"type":"del","del":true,"ln":752,"content":"-static const char *sCJKLangGroup[] = {"},{"type":"del","del":true,"ln":753,"content":"-    \"ja\","},{"type":"del","del":true,"ln":754,"content":"-    \"ko\","},{"type":"del","del":true,"ln":755,"content":"-    \"zh-CN\","},{"type":"del","del":true,"ln":756,"content":"-    \"zh-HK\","},{"type":"del","del":true,"ln":757,"content":"-    \"zh-TW\""},{"type":"del","del":true,"ln":758,"content":"-};"},{"type":"del","del":true,"ln":759,"content":"-"},{"type":"del","del":true,"ln":760,"content":"-#define COUNT_OF_CJK_LANG_GROUP 5"},{"type":"del","del":true,"ln":761,"content":"-#define CJK_LANG_JA    sCJKLangGroup[0]"},{"type":"del","del":true,"ln":762,"content":"-#define CJK_LANG_KO    sCJKLangGroup[1]"},{"type":"del","del":true,"ln":763,"content":"-#define CJK_LANG_ZH_CN sCJKLangGroup[2]"},{"type":"del","del":true,"ln":764,"content":"-#define CJK_LANG_ZH_HK sCJKLangGroup[3]"},{"type":"del","del":true,"ln":765,"content":"-#define CJK_LANG_ZH_TW sCJKLangGroup[4]"},{"type":"del","del":true,"ln":766,"content":"-"},{"type":"del","del":true,"ln":767,"content":"-static PRInt32"},{"type":"del","del":true,"ln":768,"content":"-GetCJKLangGroupIndex(const char *aLangGroup)"},{"type":"del","del":true,"ln":769,"content":"-{"},{"type":"del","del":true,"ln":770,"content":"-    PRInt32 i;"},{"type":"del","del":true,"ln":771,"content":"-    for (i = 0; i < COUNT_OF_CJK_LANG_GROUP; i++) {"},{"type":"del","del":true,"ln":772,"content":"-        if (!PL_strcasecmp(aLangGroup, sCJKLangGroup[i]))"},{"type":"del","del":true,"ln":773,"content":"-            return i;"},{"type":"del","del":true,"ln":774,"content":"-    }"},{"type":"del","del":true,"ln":775,"content":"-    return -1;"},{"type":"del","del":true,"ln":776,"content":"-}"},{"type":"del","del":true,"ln":777,"content":"-"},{"type":"normal","normal":true,"ln1":778,"ln2":527,"content":" /**"},{"type":"normal","normal":true,"ln1":779,"ln2":528,"content":"  ** gfxTextRun"},{"type":"normal","normal":true,"ln1":780,"ln2":529,"content":"  * "}],"oldStart":749,"oldLines":32,"newStart":524,"newLines":6},{"content":"@@ -788,19 +537,6 @@ GetCJKLangGroupIndex(const char *aLangGroup)","changes":[{"type":"normal","normal":true,"ln1":788,"ln2":537,"content":"  * "},{"type":"normal","normal":true,"ln1":789,"ln2":538,"content":"  **/"},{"type":"normal","normal":true,"ln1":790,"ln2":539,"content":" "},{"type":"del","del":true,"ln":791,"content":"-/**"},{"type":"del","del":true,"ln":792,"content":"- * We use this to append an LTR or RTL Override character to the start of the"},{"type":"del","del":true,"ln":793,"content":"- * string. This forces Pango to honour our direction even if there are neutral characters"},{"type":"del","del":true,"ln":794,"content":"- * in the string."},{"type":"del","del":true,"ln":795,"content":"- */"},{"type":"del","del":true,"ln":796,"content":"-static PRInt32 AppendDirectionalIndicatorUTF8(PRBool aIsRTL, nsACString& aString)"},{"type":"del","del":true,"ln":797,"content":"-{"},{"type":"del","del":true,"ln":798,"content":"-    static const PRUnichar overrides[2][2] ="},{"type":"del","del":true,"ln":799,"content":"-      { { 0x202d, 0 }, { 0x202e, 0 }}; // LRO, RLO"},{"type":"del","del":true,"ln":800,"content":"-    AppendUTF16toUTF8(overrides[aIsRTL], aString);"},{"type":"del","del":true,"ln":801,"content":"-    return 3; // both overrides map to 3 bytes in UTF8"},{"type":"del","del":true,"ln":802,"content":"-}"},{"type":"del","del":true,"ln":803,"content":"-"},{"type":"normal","normal":true,"ln1":804,"ln2":540,"content":" gfxTextRun *"},{"type":"normal","normal":true,"ln1":805,"ln2":541,"content":" gfxPangoFontGroup::MakeTextRun(const PRUint8 *aString, PRUint32 aLength,"},{"type":"normal","normal":true,"ln1":806,"ln2":542,"content":"                                const Parameters *aParams, PRUint32 aFlags)"}],"oldStart":788,"oldLines":19,"newStart":537,"newLines":6},{"content":"@@ -812,35 +548,33 @@ gfxPangoFontGroup::MakeTextRun(const PRUint8 *aString, PRUint32 aLength,","changes":[{"type":"normal","normal":true,"ln1":812,"ln2":548,"content":" "},{"type":"normal","normal":true,"ln1":813,"ln2":549,"content":"     PRBool isRTL = run->IsRightToLeft();"},{"type":"normal","normal":true,"ln1":814,"ln2":550,"content":"     if ((aFlags & TEXT_IS_ASCII) && !isRTL) {"},{"type":"del","del":true,"ln":815,"content":"-        // We don't need to send an override character here, the characters must be all"},{"type":"del","del":true,"ln":816,"content":"-        // LTR"},{"type":"normal","normal":true,"ln1":817,"ln2":551,"content":"         const gchar *utf8Chars = reinterpret_cast<const gchar*>(aString);"},{"type":"del","del":true,"ln":818,"content":"-        InitTextRun(run, utf8Chars, aLength, 0, PR_TRUE);"},{"type":"add","add":true,"ln":552,"content":"+        InitTextRun(run, utf8Chars, aLength, PR_TRUE);"},{"type":"normal","normal":true,"ln1":819,"ln2":553,"content":"     } else {"},{"type":"add","add":true,"ln":554,"content":"+        // this is really gross..."},{"type":"normal","normal":true,"ln1":820,"ln2":555,"content":"         const char *chars = reinterpret_cast<const char*>(aString);"},{"type":"del","del":true,"ln":821,"content":"-        // XXX this could be more efficient."},{"type":"del","del":true,"ln":822,"content":"-        // Although chars in not necessarily ASCII (as it may point to the low"},{"type":"del","del":true,"ln":823,"content":"-        // bytes of any UCS-2 characters < 256), NS_ConvertASCIItoUTF16 seems"},{"type":"del","del":true,"ln":824,"content":"-        // to DTRT."},{"type":"normal","normal":true,"ln1":825,"ln2":556,"content":"         NS_ConvertASCIItoUTF16 unicodeString(chars, aLength);"},{"type":"del","del":true,"ln":826,"content":"-        nsCAutoString utf8;"},{"type":"del","del":true,"ln":827,"content":"-        PRInt32 headerLen = AppendDirectionalIndicatorUTF8(isRTL, utf8);"},{"type":"del","del":true,"ln":828,"content":"-        AppendUTF16toUTF8(unicodeString, utf8);"},{"type":"del","del":true,"ln":829,"content":"-        InitTextRun(run, utf8.get(), utf8.Length(), headerLen, PR_TRUE);"},{"type":"add","add":true,"ln":557,"content":"+        NS_ConvertUTF16toUTF8 utf8String(unicodeString);"},{"type":"add","add":true,"ln":558,"content":"+        InitTextRun(run, utf8String.get(), utf8String.Length(), PR_TRUE);"},{"type":"normal","normal":true,"ln1":830,"ln2":559,"content":"     }"},{"type":"normal","normal":true,"ln1":831,"ln2":560,"content":"     run->FetchGlyphExtents(aParams->mContext);"},{"type":"normal","normal":true,"ln1":832,"ln2":561,"content":"     return run;"},{"type":"normal","normal":true,"ln1":833,"ln2":562,"content":" }"},{"type":"normal","normal":true,"ln1":834,"ln2":563,"content":" "},{"type":"del","del":true,"ln":835,"content":"-static PRBool"},{"type":"del","del":true,"ln":836,"content":"-CanTakeFastPath(PRUint32 aFlags)"},{"type":"add","add":true,"ln":564,"content":"+#if defined(ENABLE_FAST_PATH_8BIT)"},{"type":"add","add":true,"ln":565,"content":"+PRBool"},{"type":"add","add":true,"ln":566,"content":"+gfxPangoFontGroup::CanTakeFastPath(PRUint32 aFlags)"},{"type":"normal","normal":true,"ln1":837,"ln2":567,"content":" {"},{"type":"add","add":true,"ln":568,"content":"+    if (!PANGO_IS_FC_FONT (GetFontAt(0)->GetPangoFont ()))"},{"type":"add","add":true,"ln":569,"content":"+        return FALSE;"},{"type":"add","add":true,"ln":570,"content":"+"},{"type":"normal","normal":true,"ln1":838,"ln2":571,"content":"     // Can take fast path only if OPTIMIZE_SPEED is set and IS_RTL isn't"},{"type":"normal","normal":true,"ln1":839,"ln2":572,"content":"     // We need to always use Pango for RTL text, in case glyph mirroring is required"},{"type":"normal","normal":true,"ln1":840,"ln2":573,"content":"     return (aFlags &"},{"type":"normal","normal":true,"ln1":841,"ln2":574,"content":"             (gfxTextRunFactory::TEXT_OPTIMIZE_SPEED | gfxTextRunFactory::TEXT_IS_RTL)) =="},{"type":"normal","normal":true,"ln1":842,"ln2":575,"content":"         gfxTextRunFactory::TEXT_OPTIMIZE_SPEED;"},{"type":"normal","normal":true,"ln1":843,"ln2":576,"content":" }"},{"type":"add","add":true,"ln":577,"content":"+#endif"},{"type":"normal","normal":true,"ln1":844,"ln2":578,"content":" "},{"type":"normal","normal":true,"ln1":845,"ln2":579,"content":" gfxTextRun *"},{"type":"normal","normal":true,"ln1":846,"ln2":580,"content":" gfxPangoFontGroup::MakeTextRun(const PRUnichar *aString, PRUint32 aLength,"}],"oldStart":812,"oldLines":35,"newStart":548,"newLines":33},{"content":"@@ -852,11 +586,10 @@ gfxPangoFontGroup::MakeTextRun(const PRUnichar *aString, PRUint32 aLength,","changes":[{"type":"normal","normal":true,"ln1":852,"ln2":586,"content":" "},{"type":"normal","normal":true,"ln1":853,"ln2":587,"content":"     run->RecordSurrogates(aString);"},{"type":"normal","normal":true,"ln1":854,"ln2":588,"content":" "},{"type":"del","del":true,"ln":855,"content":"-    nsCAutoString utf8;"},{"type":"del","del":true,"ln":856,"content":"-    PRInt32 headerLen = AppendDirectionalIndicatorUTF8(run->IsRightToLeft(), utf8);"},{"type":"del","del":true,"ln":857,"content":"-    AppendUTF16toUTF8(Substring(aString, aString + aLength), utf8);"},{"type":"add","add":true,"ln":589,"content":"+    NS_ConvertUTF16toUTF8 utf8(aString, aLength);"},{"type":"normal","normal":true,"ln1":858,"ln2":590,"content":"     PRBool is8Bit = PR_FALSE;"},{"type":"del","del":true,"ln":859,"content":"-#if defined(ENABLE_XFT_FAST_PATH_8BIT)"},{"type":"add","add":true,"ln":591,"content":"+"},{"type":"add","add":true,"ln":592,"content":"+#if defined(ENABLE_FAST_PATH_8BIT)"},{"type":"normal","normal":true,"ln1":860,"ln2":593,"content":"     if (CanTakeFastPath(aFlags)) {"},{"type":"normal","normal":true,"ln1":861,"ln2":594,"content":"         PRUint32 allBits = 0;"},{"type":"normal","normal":true,"ln1":862,"ln2":595,"content":"         PRUint32 i;"}],"oldStart":852,"oldLines":11,"newStart":586,"newLines":10},{"content":"@@ -866,22 +599,21 @@ gfxPangoFontGroup::MakeTextRun(const PRUnichar *aString, PRUint32 aLength,","changes":[{"type":"normal","normal":true,"ln1":866,"ln2":599,"content":"         is8Bit = (allBits & 0xFF00) == 0;"},{"type":"normal","normal":true,"ln1":867,"ln2":600,"content":"     }"},{"type":"normal","normal":true,"ln1":868,"ln2":601,"content":" #endif"},{"type":"del","del":true,"ln":869,"content":"-    InitTextRun(run, utf8.get(), utf8.Length(), headerLen, is8Bit);"},{"type":"add","add":true,"ln":602,"content":"+    InitTextRun(run, utf8.get(), utf8.Length(), is8Bit);"},{"type":"normal","normal":true,"ln1":870,"ln2":603,"content":"     run->FetchGlyphExtents(aParams->mContext);"},{"type":"normal","normal":true,"ln1":871,"ln2":604,"content":"     return run;"},{"type":"normal","normal":true,"ln1":872,"ln2":605,"content":" }"},{"type":"normal","normal":true,"ln1":873,"ln2":606,"content":" "},{"type":"normal","normal":true,"ln1":874,"ln2":607,"content":" void"},{"type":"normal","normal":true,"ln1":875,"ln2":608,"content":" gfxPangoFontGroup::InitTextRun(gfxTextRun *aTextRun, const gchar *aUTF8Text,"},{"type":"del","del":true,"ln":876,"content":"-                               PRUint32 aUTF8Length, PRUint32 aUTF8HeaderLength,"},{"type":"del","del":true,"ln":877,"content":"-                               PRBool aTake8BitPath)"},{"type":"add","add":true,"ln":609,"content":"+                               PRUint32 aUTF8Length, PRBool aTake8BitPath)"},{"type":"normal","normal":true,"ln1":878,"ln2":610,"content":" {"},{"type":"del","del":true,"ln":879,"content":"-#if defined(ENABLE_XFT_FAST_PATH_ALWAYS)"},{"type":"del","del":true,"ln":880,"content":"-    CreateGlyphRunsXft(aTextRun, aUTF8Text + aUTF8HeaderLength, aUTF8Length - aUTF8HeaderLength);"},{"type":"add","add":true,"ln":611,"content":"+#if defined(ENABLE_FAST_PATH_ALWAYS)"},{"type":"add","add":true,"ln":612,"content":"+    CreateGlyphRunsFast(aTextRun, aUTF8Text, aUTF8Length);"},{"type":"normal","normal":true,"ln1":881,"ln2":613,"content":" #else"},{"type":"del","del":true,"ln":882,"content":"-#if defined(ENABLE_XFT_FAST_PATH_8BIT)"},{"type":"add","add":true,"ln":614,"content":"+#if defined(ENABLE_FAST_PATH_8BIT)"},{"type":"normal","normal":true,"ln1":883,"ln2":615,"content":"     if (aTake8BitPath && CanTakeFastPath(aTextRun->GetFlags())) {"},{"type":"del","del":true,"ln":884,"content":"-        CreateGlyphRunsXft(aTextRun, aUTF8Text + aUTF8HeaderLength, aUTF8Length - aUTF8HeaderLength);"},{"type":"add","add":true,"ln":616,"content":"+        CreateGlyphRunsFast(aTextRun, aUTF8Text, aUTF8Length);"},{"type":"normal","normal":true,"ln1":885,"ln2":617,"content":"         return;"},{"type":"normal","normal":true,"ln1":886,"ln2":618,"content":"     }"},{"type":"normal","normal":true,"ln1":887,"ln2":619,"content":" #endif"}],"oldStart":866,"oldLines":22,"newStart":599,"newLines":21},{"content":"@@ -890,13 +622,20 @@ gfxPangoFontGroup::InitTextRun(gfxTextRun *aTextRun, const gchar *aUTF8Text,","changes":[{"type":"normal","normal":true,"ln1":890,"ln2":622,"content":"                                (aTextRun->IsRightToLeft()"},{"type":"normal","normal":true,"ln1":891,"ln2":623,"content":"                                   ? PANGO_DIRECTION_RTL : PANGO_DIRECTION_LTR));"},{"type":"normal","normal":true,"ln1":892,"ln2":624,"content":" "},{"type":"del","del":true,"ln":893,"content":"-    CreateGlyphRunsItemizing(aTextRun, aUTF8Text, aUTF8Length, aUTF8HeaderLength);"},{"type":"add","add":true,"ln":625,"content":"+    CreateGlyphRunsItemizing(aTextRun, aUTF8Text, aUTF8Length);"},{"type":"normal","normal":true,"ln1":894,"ln2":626,"content":" #endif"},{"type":"normal","normal":true,"ln1":895,"ln2":627,"content":" }"},{"type":"normal","normal":true,"ln1":896,"ln2":628,"content":" "},{"type":"normal","normal":true,"ln1":897,"ln2":629,"content":" static cairo_scaled_font_t*"},{"type":"normal","normal":true,"ln1":898,"ln2":630,"content":" CreateScaledFont(cairo_t *aCR, cairo_matrix_t *aCTM, PangoFont *aPangoFont)"},{"type":"normal","normal":true,"ln1":899,"ln2":631,"content":" {"},{"type":"add","add":true,"ln":632,"content":"+#if 0"},{"type":"add","add":true,"ln":633,"content":"+//XXX enalbe this #if defined(PANGO_VERSION_CHECK) && PANGO_VERSION_CHECK(1,17,5)"},{"type":"add","add":true,"ln":634,"content":"+    // Lets just use pango_cairo_font_get_scaled_font() for now.  it's only"},{"type":"add","add":true,"ln":635,"content":"+    // available in pango 1.17.x though :("},{"type":"add","add":true,"ln":636,"content":"+    return cairo_scaled_font_reference (pango_cairo_font_get_scaled_font (PANGO_CAIRO_FONT (aPangoFont)));"},{"type":"add","add":true,"ln":637,"content":"+#else"},{"type":"add","add":true,"ln":638,"content":"+"},{"type":"normal","normal":true,"ln1":900,"ln2":639,"content":"     // XXX is this safe really? We should probably check the font type or something."},{"type":"normal","normal":true,"ln1":901,"ln2":640,"content":"     // XXX does this really create the same font that Pango used for measurement?"},{"type":"normal","normal":true,"ln1":902,"ln2":641,"content":"     // We probably need to work harder here. We should pay particular attention"}],"oldStart":890,"oldLines":13,"newStart":622,"newLines":20},{"content":"@@ -915,6 +654,7 @@ CreateScaledFont(cairo_t *aCR, cairo_matrix_t *aCTM, PangoFont *aPangoFont)","changes":[{"type":"normal","normal":true,"ln1":915,"ln2":654,"content":"     cairo_font_options_destroy(fontOptions);"},{"type":"normal","normal":true,"ln1":916,"ln2":655,"content":"     cairo_font_face_destroy(face);"},{"type":"normal","normal":true,"ln1":917,"ln2":656,"content":"     return scaledFont;"},{"type":"add","add":true,"ln":657,"content":"+#endif"},{"type":"normal","normal":true,"ln1":918,"ln2":658,"content":" }"},{"type":"normal","normal":true,"ln1":919,"ln2":659,"content":" "},{"type":"normal","normal":true,"ln1":920,"ln2":660,"content":" PRBool"}],"oldStart":915,"oldLines":6,"newStart":654,"newLines":7},{"content":"@@ -954,6 +694,8 @@ SetupClusterBoundaries(gfxTextRun* aTextRun, const gchar *aUTF8, PRUint32 aUTF8L","changes":[{"type":"normal","normal":true,"ln1":954,"ln2":694,"content":"     if (aTextRun->GetFlags() & gfxTextRunFactory::TEXT_IS_8BIT) {"},{"type":"normal","normal":true,"ln1":955,"ln2":695,"content":"         // 8-bit text doesn't have clusters."},{"type":"normal","normal":true,"ln1":956,"ln2":696,"content":"         // XXX is this true in all languages???"},{"type":"add","add":true,"ln":697,"content":"+\t// behdad: don't think so.  Czech for example IIRC has a"},{"type":"add","add":true,"ln":698,"content":"+\t// 'ch' grapheme."},{"type":"normal","normal":true,"ln1":957,"ln2":699,"content":"         return;"},{"type":"normal","normal":true,"ln1":958,"ln2":700,"content":"     }"},{"type":"normal","normal":true,"ln1":959,"ln2":701,"content":" "}],"oldStart":954,"oldLines":6,"newStart":694,"newLines":8},{"content":"@@ -1183,8 +925,9 @@ gfxPangoFontGroup::SetGlyphs(gfxTextRun *aTextRun, gfxPangoFont *aFont,","changes":[{"type":"normal","normal":true,"ln1":1183,"ln2":925,"content":"             gunichar ch = g_utf8_get_char(clusterUTF8);"},{"type":"normal","normal":true,"ln1":1184,"ln2":926,"content":"             do { // Does pango ever provide more than one glyph in the cluster"},{"type":"normal","normal":true,"ln1":1185,"ln2":927,"content":"                  // if there is a missing glyph?"},{"type":"add","add":true,"ln":928,"content":"+\t\t // behdad: yes"},{"type":"normal","normal":true,"ln1":1186,"ln2":929,"content":"                 if (IS_MISSING_GLYPH(glyphs[glyphIndex].glyph)) {"},{"type":"del","del":true,"ln":1187,"content":"-                    if (MOZ_pango_is_zero_width(ch)) {"},{"type":"add","add":true,"ln":930,"content":"+                    if (pango_is_zero_width(ch)) {"},{"type":"normal","normal":true,"ln1":1188,"ln2":931,"content":"                         // the zero width characters returns empty glyph ID at shaping,"},{"type":"normal","normal":true,"ln1":1189,"ln2":932,"content":"                         // we should override it if the font has the character."},{"type":"normal","normal":true,"ln1":1190,"ln2":933,"content":"                         glyphs[glyphIndex].glyph = aFont->GetGlyph(' ');"}],"oldStart":1183,"oldLines":8,"newStart":925,"newLines":9},{"content":"@@ -1244,15 +987,15 @@ gfxPangoFontGroup::SetMissingGlyphs(gfxTextRun *aTextRun,","changes":[{"type":"normal","normal":true,"ln1":1244,"ln2":987,"content":"     return NS_OK;"},{"type":"normal","normal":true,"ln1":1245,"ln2":988,"content":" }"},{"type":"normal","normal":true,"ln1":1246,"ln2":989,"content":" "},{"type":"del","del":true,"ln":1247,"content":"-#if defined(ENABLE_XFT_FAST_PATH_8BIT) || defined(ENABLE_XFT_FAST_PATH_ALWAYS)"},{"type":"add","add":true,"ln":990,"content":"+#if defined(ENABLE_FAST_PATH_8BIT) || defined(ENABLE_FAST_PATH_ALWAYS)"},{"type":"normal","normal":true,"ln1":1248,"ln2":991,"content":" void"},{"type":"del","del":true,"ln":1249,"content":"-gfxPangoFontGroup::CreateGlyphRunsXft(gfxTextRun *aTextRun,"},{"type":"del","del":true,"ln":1250,"content":"-                                      const gchar *aUTF8, PRUint32 aUTF8Length)"},{"type":"add","add":true,"ln":992,"content":"+gfxPangoFontGroup::CreateGlyphRunsFast(gfxTextRun *aTextRun,"},{"type":"add","add":true,"ln":993,"content":"+                                       const gchar *aUTF8, PRUint32 aUTF8Length)"},{"type":"normal","normal":true,"ln1":1251,"ln2":994,"content":" {"},{"type":"normal","normal":true,"ln1":1252,"ln2":995,"content":"     const gchar *p = aUTF8;"},{"type":"del","del":true,"ln":1253,"content":"-    Display *dpy = GDK_DISPLAY();"},{"type":"normal","normal":true,"ln1":1254,"ln2":996,"content":"     gfxPangoFont *font = GetFontAt(0);"},{"type":"del","del":true,"ln":1255,"content":"-    XftFont *xfont = font->GetXftFont();"},{"type":"add","add":true,"ln":997,"content":"+    PangoFont *pangofont = font->GetPangoFont();"},{"type":"add","add":true,"ln":998,"content":"+    PangoFcFont *fcfont = PANGO_FC_FONT (pangofont);"},{"type":"normal","normal":true,"ln1":1256,"ln2":999,"content":"     PRUint32 utf16Offset = 0;"},{"type":"normal","normal":true,"ln1":1257,"ln2":1000,"content":"     gfxTextRun::CompressedGlyph g;"},{"type":"normal","normal":true,"ln1":1258,"ln2":1001,"content":"     const PRUint32 appUnitsPerDevUnit = aTextRun->GetAppUnitsPerDevUnit();"}],"oldStart":1244,"oldLines":15,"newStart":987,"newLines":15},{"content":"@@ -1273,14 +1016,11 @@ gfxPangoFontGroup::CreateGlyphRunsXft(gfxTextRun *aTextRun,","changes":[{"type":"normal","normal":true,"ln1":1273,"ln2":1016,"content":"             aTextRun->SetMissingGlyph(utf16Offset, 0);"},{"type":"normal","normal":true,"ln1":1274,"ln2":1017,"content":"         } else {"},{"type":"normal","normal":true,"ln1":1275,"ln2":1018,"content":"             NS_ASSERTION(!IsInvalidChar(ch), \"Invalid char detected\");"},{"type":"del","del":true,"ln":1276,"content":"-            FT_UInt glyph = XftCharIndex(dpy, xfont, ch);"},{"type":"del","del":true,"ln":1277,"content":"-            XGlyphInfo info;"},{"type":"del","del":true,"ln":1278,"content":"-            XftGlyphExtents(dpy, xfont, &glyph, 1, &info);"},{"type":"del","del":true,"ln":1279,"content":"-            if (info.yOff > 0) {"},{"type":"del","del":true,"ln":1280,"content":"-                NS_WARNING(\"vertical offsets not supported\");"},{"type":"del","del":true,"ln":1281,"content":"-            }"},{"type":"add","add":true,"ln":1019,"content":"+            FT_UInt glyph = pango_fc_font_get_glyph (fcfont, ch);"},{"type":"add","add":true,"ln":1020,"content":"+            PangoRectangle rect;"},{"type":"add","add":true,"ln":1021,"content":"+            pango_font_get_glyph_extents (pangofont, glyph, NULL, &rect);"},{"type":"normal","normal":true,"ln1":1282,"ln2":1022,"content":" "},{"type":"del","del":true,"ln":1283,"content":"-            PRInt32 advance = info.xOff*appUnitsPerDevUnit;"},{"type":"add","add":true,"ln":1023,"content":"+            PRInt32 advance = PANGO_PIXELS (rect.width * appUnitsPerDevUnit);"},{"type":"normal","normal":true,"ln1":1284,"ln2":1024,"content":"             if (advance >= 0 &&"},{"type":"normal","normal":true,"ln1":1285,"ln2":1025,"content":"                 gfxTextRun::CompressedGlyph::IsSimpleAdvance(advance) &&"},{"type":"normal","normal":true,"ln1":1286,"ln2":1026,"content":"                 gfxTextRun::CompressedGlyph::IsSimpleGlyphID(glyph)) {"}],"oldStart":1273,"oldLines":14,"newStart":1016,"newLines":11},{"content":"@@ -1314,320 +1054,93 @@ gfxPangoFontGroup::CreateGlyphRunsXft(gfxTextRun *aTextRun,","changes":[{"type":"normal","normal":true,"ln1":1314,"ln2":1054,"content":" }"},{"type":"normal","normal":true,"ln1":1315,"ln2":1055,"content":" #endif"},{"type":"normal","normal":true,"ln1":1316,"ln2":1056,"content":" "},{"type":"del","del":true,"ln":1317,"content":"-class FontSelector"},{"type":"add","add":true,"ln":1057,"content":"+void "},{"type":"add","add":true,"ln":1058,"content":"+gfxPangoFontGroup::CreateGlyphRunsItemizing(gfxTextRun *aTextRun,"},{"type":"add","add":true,"ln":1059,"content":"+                                            const gchar *aUTF8, PRUint32 aUTF8Length)"},{"type":"normal","normal":true,"ln1":1318,"ln2":1060,"content":" {"},{"type":"del","del":true,"ln":1319,"content":"-public:"},{"type":"del","del":true,"ln":1320,"content":"-    FontSelector(const gchar *aString, PRInt32 aLength,"},{"type":"del","del":true,"ln":1321,"content":"-                 gfxPangoFontGroup *aGroup, gfxTextRun *aTextRun,"},{"type":"del","del":true,"ln":1322,"content":"-                 PangoItem *aItem, PRUint32 aUTF16Offset, PRPackedBool aIsRTL) :"},{"type":"del","del":true,"ln":1323,"content":"-        mItem(aItem),"},{"type":"del","del":true,"ln":1324,"content":"-        mGroup(aGroup), mTextRun(aTextRun), mString(aString),"},{"type":"del","del":true,"ln":1325,"content":"-        mFontIndex(0), mLength(aLength), mUTF16Offset(aUTF16Offset),"},{"type":"del","del":true,"ln":1326,"content":"-        mTriedPrefFonts(0), mTriedOtherFonts(0), mIsRTL(aIsRTL)"},{"type":"del","del":true,"ln":1327,"content":"-    {"},{"type":"del","del":true,"ln":1328,"content":"-        for (PRUint32 i = 0; i < mGroup->FontListLength(); ++i)"},{"type":"del","del":true,"ln":1329,"content":"-            mFonts.AppendElement(mGroup->GetFontAt(i));"},{"type":"del","del":true,"ln":1330,"content":"-        mSpaceWidth = NS_lround(mGroup->GetFontAt(0)->GetMetrics().spaceWidth * FLOAT_PANGO_SCALE);"},{"type":"del","del":true,"ln":1331,"content":"-    }"},{"type":"del","del":true,"ln":1332,"content":"-    "},{"type":"del","del":true,"ln":1333,"content":"-    nsresult Run()"},{"type":"del","del":true,"ln":1334,"content":"-    {"},{"type":"del","del":true,"ln":1335,"content":"-        return InitSegments(mString, mLength);"},{"type":"del","del":true,"ln":1336,"content":"-    }"},{"type":"normal","normal":true,"ln1":1337,"ln2":1061,"content":" "},{"type":"del","del":true,"ln":1338,"content":"-    PRUint32 GetUTF16Offset() { return mUTF16Offset; }"},{"type":"add","add":true,"ln":1062,"content":"+    PangoContext *context = gdk_pango_context_get ();"},{"type":"normal","normal":true,"ln1":1339,"ln2":1063,"content":" "},{"type":"del","del":true,"ln":1340,"content":"-    static PRBool ExistsFont(FontSelector *aFs,"},{"type":"del","del":true,"ln":1341,"content":"-                             const nsAString &aName) {"},{"type":"del","del":true,"ln":1342,"content":"-        PRUint32 len = aFs->mFonts.Length();"},{"type":"del","del":true,"ln":1343,"content":"-        for (PRUint32 i = 0; i < len; ++i) {"},{"type":"del","del":true,"ln":1344,"content":"-            if (aName.Equals(aFs->mFonts[i]->GetName()))"},{"type":"del","del":true,"ln":1345,"content":"-                return PR_TRUE;"},{"type":"del","del":true,"ln":1346,"content":"-        }"},{"type":"del","del":true,"ln":1347,"content":"-        return PR_FALSE;"},{"type":"del","del":true,"ln":1348,"content":"-    }"},{"type":"del","del":true,"ln":1349,"content":"-"},{"type":"del","del":true,"ln":1350,"content":"-    static PRBool AddFontCallback(const nsAString &aName,"},{"type":"del","del":true,"ln":1351,"content":"-                                  const nsACString &aGenericName,"},{"type":"del","del":true,"ln":1352,"content":"-                                  void *closure) {"},{"type":"del","del":true,"ln":1353,"content":"-        if (aName.IsEmpty())"},{"type":"del","del":true,"ln":1354,"content":"-            return PR_TRUE;"},{"type":"del","del":true,"ln":1355,"content":"-"},{"type":"del","del":true,"ln":1356,"content":"-        FontSelector *fs = static_cast<FontSelector*>(closure);"},{"type":"del","del":true,"ln":1357,"content":"-"},{"type":"del","del":true,"ln":1358,"content":"-        // XXX do something better than this to remove dups"},{"type":"del","del":true,"ln":1359,"content":"-        if (ExistsFont(fs, aName))"},{"type":"del","del":true,"ln":1360,"content":"-            return PR_TRUE;"},{"type":"add","add":true,"ln":1064,"content":"+    PangoFontDescription *fontDesc = pango_font_description_new();"},{"type":"normal","normal":true,"ln1":1361,"ln2":1065,"content":" "},{"type":"del","del":true,"ln":1362,"content":"-        nsRefPtr<gfxPangoFont> font = GetOrMakeFont(aName, fs->mGroup->GetStyle());"},{"type":"del","del":true,"ln":1363,"content":"-        if (font) {"},{"type":"del","del":true,"ln":1364,"content":"-            fs->mFonts.AppendElement(font);"},{"type":"del","del":true,"ln":1365,"content":"-        }"},{"type":"add","add":true,"ln":1066,"content":"+    // these should be FontEntries or something similar rather than gfxPangoFonts..."},{"type":"add","add":true,"ln":1067,"content":"+    nsString fontList;"},{"type":"normal","normal":true,"ln1":1366,"ln2":1068,"content":" "},{"type":"del","del":true,"ln":1367,"content":"-        return PR_TRUE;"},{"type":"add","add":true,"ln":1069,"content":"+    for (PRUint32 i = 0; i < mFonts.Length(); i++) {"},{"type":"add","add":true,"ln":1070,"content":"+        fontList.Append(mFonts[i]->GetName());"},{"type":"add","add":true,"ln":1071,"content":"+        fontList.Append(NS_LITERAL_STRING(\", \"));"},{"type":"normal","normal":true,"ln1":1368,"ln2":1072,"content":"     }"},{"type":"normal","normal":true,"ln1":1369,"ln2":1073,"content":" "},{"type":"del","del":true,"ln":1370,"content":"-private:"},{"type":"del","del":true,"ln":1371,"content":"-    PangoItem *mItem;"},{"type":"add","add":true,"ln":1074,"content":"+    PangoLanguage *lang = GetPangoLanguage(GetStyle()->langGroup);"},{"type":"normal","normal":true,"ln1":1372,"ln2":1075,"content":" "},{"type":"del","del":true,"ln":1373,"content":"-    nsTArray< nsRefPtr<gfxPangoFont> > mFonts;"},{"type":"add","add":true,"ln":1076,"content":"+    pango_font_description_set_family(fontDesc, NS_ConvertUTF16toUTF8(fontList).get());"},{"type":"add","add":true,"ln":1077,"content":"+    pango_font_description_set_absolute_size(fontDesc, GetStyle()->size * PANGO_SCALE);"},{"type":"add","add":true,"ln":1078,"content":"+    pango_font_description_set_style(fontDesc, ThebesStyleToPangoStyle(GetStyle()));"},{"type":"add","add":true,"ln":1079,"content":"+    pango_font_description_set_weight(fontDesc, ThebesStyleToPangoWeight(GetStyle()));"},{"type":"normal","normal":true,"ln1":1374,"ln2":1080,"content":" "},{"type":"del","del":true,"ln":1375,"content":"-    gfxPangoFontGroup *mGroup;"},{"type":"del","del":true,"ln":1376,"content":"-    gfxTextRun   *mTextRun;"},{"type":"del","del":true,"ln":1377,"content":"-    const char        *mString; // UTF-8"},{"type":"del","del":true,"ln":1378,"content":"-    PRUint32           mFontIndex;"},{"type":"del","del":true,"ln":1379,"content":"-    PRInt32            mLength;"},{"type":"del","del":true,"ln":1380,"content":"-    PRUint32           mUTF16Offset;"},{"type":"del","del":true,"ln":1381,"content":"-    PRUint32           mSpaceWidth;"},{"type":"add","add":true,"ln":1081,"content":"+    pango_context_set_font_description(context, fontDesc);"},{"type":"normal","normal":true,"ln1":1382,"ln2":1082,"content":" "},{"type":"del","del":true,"ln":1383,"content":"-    PRPackedBool mTriedPrefFonts;"},{"type":"del","del":true,"ln":1384,"content":"-    PRPackedBool mTriedOtherFonts;"},{"type":"del","del":true,"ln":1385,"content":"-    PRPackedBool mIsRTL;"},{"type":"add","add":true,"ln":1083,"content":"+    // we should set this to null if we don't have a text language from the page..."},{"type":"add","add":true,"ln":1084,"content":"+    // except that we almost always have something..."},{"type":"add","add":true,"ln":1085,"content":"+    pango_context_set_language(context, lang);"},{"type":"normal","normal":true,"ln1":1386,"ln2":1086,"content":" "},{"type":"del","del":true,"ln":1387,"content":"-    nsresult InitSegments(const gchar *aUTF8, PRUint32 aLength) {"},{"type":"del","del":true,"ln":1388,"content":"-        if (aLength == 0)"},{"type":"del","del":true,"ln":1389,"content":"-            return NS_OK;"},{"type":"del","del":true,"ln":1390,"content":"-        const gchar *start = aUTF8;"},{"type":"del","del":true,"ln":1391,"content":"-        const gchar *last = start + aLength;"},{"type":"add","add":true,"ln":1087,"content":"+    PangoDirection dir = aTextRun->IsRightToLeft() ? PANGO_DIRECTION_RTL : PANGO_DIRECTION_LTR;"},{"type":"add","add":true,"ln":1088,"content":"+    GList *items = pango_itemize_with_base_dir(context, dir, aUTF8, 0, aUTF8Length, nsnull, nsnull);"},{"type":"normal","normal":true,"ln1":1392,"ln2":1089,"content":" "},{"type":"del","del":true,"ln":1393,"content":"-RetryNextFont:"},{"type":"del","del":true,"ln":1394,"content":"-        nsRefPtr<gfxPangoFont> font = GetNextFont();"},{"type":"del","del":true,"ln":1395,"content":"-"},{"type":"del","del":true,"ln":1396,"content":"-        // If we cannot found the font that has the current character glyph,"},{"type":"del","del":true,"ln":1397,"content":"-        // we should return default font's missing data."},{"type":"del","del":true,"ln":1398,"content":"-        if (!font)"},{"type":"del","del":true,"ln":1399,"content":"-            return AppendMissingSegment(start, last - start);"},{"type":"del","del":true,"ln":1400,"content":"-"},{"type":"del","del":true,"ln":1401,"content":"-        nsresult rv;"},{"type":"del","del":true,"ln":1402,"content":"-        for (const gchar *c = start; c < last;) {"},{"type":"del","del":true,"ln":1403,"content":"-            // find the first missing glyph"},{"type":"del","del":true,"ln":1404,"content":"-            gunichar u = g_utf8_get_char(c);"},{"type":"del","del":true,"ln":1405,"content":"-            if (font->HasGlyph(PRUint32(u))) {"},{"type":"del","del":true,"ln":1406,"content":"-                c = g_utf8_next_char(c);"},{"type":"del","del":true,"ln":1407,"content":"-                continue;"},{"type":"del","del":true,"ln":1408,"content":"-            }"},{"type":"del","del":true,"ln":1409,"content":"-"},{"type":"del","del":true,"ln":1410,"content":"-            // find the next point that can be renderd with current font"},{"type":"del","del":true,"ln":1411,"content":"-            const gchar *missingStart = c;"},{"type":"del","del":true,"ln":1412,"content":"-            const gchar *next;"},{"type":"del","del":true,"ln":1413,"content":"-            for (next = g_utf8_next_char(missingStart); next < last; next = g_utf8_next_char(next)) {"},{"type":"del","del":true,"ln":1414,"content":"-                u = g_utf8_get_char(next);"},{"type":"del","del":true,"ln":1415,"content":"-                if (font->HasGlyph(PRUint32(u)))"},{"type":"del","del":true,"ln":1416,"content":"-                    break;"},{"type":"del","del":true,"ln":1417,"content":"-            }"},{"type":"del","del":true,"ln":1418,"content":"-"},{"type":"del","del":true,"ln":1419,"content":"-            // current font has 0 glyphs for current segment, try with next font"},{"type":"del","del":true,"ln":1420,"content":"-            if (missingStart == start && next == last)"},{"type":"del","del":true,"ln":1421,"content":"-                goto RetryNextFont;"},{"type":"del","del":true,"ln":1422,"content":"-"},{"type":"del","del":true,"ln":1423,"content":"-            // create the segment for found glyphs"},{"type":"del","del":true,"ln":1424,"content":"-            rv = AppendSegment(font, start, missingStart - start);"},{"type":"del","del":true,"ln":1425,"content":"-            NS_ENSURE_SUCCESS(rv, rv);"},{"type":"add","add":true,"ln":1090,"content":"+    PRUint32 utf16Offset = 0;"},{"type":"add","add":true,"ln":1091,"content":"+    PRBool isRTL = aTextRun->IsRightToLeft();"},{"type":"add","add":true,"ln":1092,"content":"+    GList *pos = items;"},{"type":"add","add":true,"ln":1093,"content":"+    for (; pos && pos->data; pos = pos->next) {"},{"type":"add","add":true,"ln":1094,"content":"+        PangoItem *item = (PangoItem *)pos->data;"},{"type":"add","add":true,"ln":1095,"content":"+        NS_ASSERTION(isRTL == item->analysis.level % 2, \"RTL assumption mismatch\");"},{"type":"normal","normal":true,"ln1":1426,"ln2":1096,"content":" "},{"type":"del","del":true,"ln":1427,"content":"-            // init the missing glyphs with remains fonts."},{"type":"del","del":true,"ln":1428,"content":"-            PRUint32 fontIndex = mFontIndex;"},{"type":"del","del":true,"ln":1429,"content":"-            rv = InitSegments(missingStart, next - missingStart);"},{"type":"del","del":true,"ln":1430,"content":"-            mFontIndex = fontIndex;"},{"type":"del","del":true,"ln":1431,"content":"-            NS_ENSURE_SUCCESS(rv, rv);"},{"type":"add","add":true,"ln":1097,"content":"+        PRUint32 offset = item->offset;"},{"type":"add","add":true,"ln":1098,"content":"+        PRUint32 length = item->length;"},{"type":"normal","normal":true,"ln1":1432,"ln2":1099,"content":" "},{"type":"del","del":true,"ln":1433,"content":"-            start = c = next;"},{"type":"del","del":true,"ln":1434,"content":"-        }"},{"type":"add","add":true,"ln":1100,"content":"+        // need to append glyph runs here."},{"type":"add","add":true,"ln":1101,"content":"+        PangoGlyphString *glyphString = pango_glyph_string_new();"},{"type":"add","add":true,"ln":1102,"content":"+        if (!glyphString)"},{"type":"add","add":true,"ln":1103,"content":"+            return; // OOM"},{"type":"normal","normal":true,"ln1":1435,"ln2":1104,"content":" "},{"type":"del","del":true,"ln":1436,"content":"-        rv = AppendSegment(font, start, last - start);"},{"type":"del","del":true,"ln":1437,"content":"-        NS_ENSURE_SUCCESS(rv, rv);"},{"type":"del","del":true,"ln":1438,"content":"-        return NS_OK;"},{"type":"del","del":true,"ln":1439,"content":"-    }"},{"type":"add","add":true,"ln":1105,"content":"+        pango_shape(aUTF8 + offset, length, &item->analysis, glyphString);"},{"type":"normal","normal":true,"ln1":1440,"ln2":1106,"content":" "},{"type":"del","del":true,"ln":1441,"content":"-    nsresult AppendSegment(gfxPangoFont* aFont, const gchar *aUTF8, PRUint32 aLength) {"},{"type":"del","del":true,"ln":1442,"content":"-        if (aLength == 0)"},{"type":"del","del":true,"ln":1443,"content":"-            return NS_OK;"},{"type":"add","add":true,"ln":1107,"content":"+        /* look up the gfxPangoFont from the PangoFont */"},{"type":"add","add":true,"ln":1108,"content":"+        // XXX we need a function to do this.. until then do this"},{"type":"add","add":true,"ln":1109,"content":"+        // behdad: use g_object_[sg]et_qdata() for it."},{"type":"add","add":true,"ln":1110,"content":"+        PangoFontDescription *d = pango_font_describe(item->analysis.font);"},{"type":"add","add":true,"ln":1111,"content":"+        nsRefPtr<gfxPangoFont> font = GetOrMakeFont(NS_ConvertUTF8toUTF16(pango_font_description_get_family(d)), GetStyle());"},{"type":"normal","normal":true,"ln1":1444,"ln2":1112,"content":" "},{"type":"del","del":true,"ln":1445,"content":"-        PangoFont* pf = aFont->GetPangoFont();"},{"type":"add","add":true,"ln":1113,"content":"+        //printf(\"Using %s\\n\", pango_font_description_get_family(d));"},{"type":"normal","normal":true,"ln1":1446,"ln2":1114,"content":" "},{"type":"del","del":true,"ln":1447,"content":"-        PangoGlyphString *glyphString = pango_glyph_string_new();"},{"type":"del","del":true,"ln":1448,"content":"-        if (!glyphString)"},{"type":"del","del":true,"ln":1449,"content":"-            return NS_ERROR_OUT_OF_MEMORY;"},{"type":"del","del":true,"ln":1450,"content":"-        PangoFont *tmpFont = mItem->analysis.font;"},{"type":"del","del":true,"ln":1451,"content":"-        mItem->analysis.font = pf;"},{"type":"del","del":true,"ln":1452,"content":"-        pango_shape(aUTF8, aLength, &mItem->analysis, glyphString);"},{"type":"del","del":true,"ln":1453,"content":"-        mItem->analysis.font = tmpFont;"},{"type":"add","add":true,"ln":1115,"content":"+        pango_font_description_free(d);"},{"type":"add","add":true,"ln":1116,"content":"+        SetupClusterBoundaries(aTextRun, aUTF8 + offset, length, utf16Offset, &item->analysis);"},{"type":"normal","normal":true,"ln1":1454,"ln2":1117,"content":" "},{"type":"del","del":true,"ln":1455,"content":"-        nsresult rv = mTextRun->AddGlyphRun(aFont, mUTF16Offset);"},{"type":"add","add":true,"ln":1118,"content":"+        nsresult rv = aTextRun->AddGlyphRun(font, utf16Offset, PR_TRUE);"},{"type":"normal","normal":true,"ln1":1456,"ln2":1119,"content":"         if (NS_FAILED(rv)) {"},{"type":"normal","normal":true,"ln1":1457,"ln2":1120,"content":"             NS_ERROR(\"AddGlyphRun Failed\");"},{"type":"normal","normal":true,"ln1":1458,"ln2":1121,"content":"             pango_glyph_string_free(glyphString);"},{"type":"del","del":true,"ln":1459,"content":"-            return rv;"},{"type":"add","add":true,"ln":1122,"content":"+            return;"},{"type":"normal","normal":true,"ln1":1460,"ln2":1123,"content":"         }"},{"type":"del","del":true,"ln":1461,"content":"-        PRUint32 utf16Offset = mUTF16Offset;"},{"type":"del","del":true,"ln":1462,"content":"-        rv = mGroup->SetGlyphs(mTextRun, aFont, aUTF8, aLength,"},{"type":"del","del":true,"ln":1463,"content":"-                               &utf16Offset, glyphString, mSpaceWidth, PR_FALSE);"},{"type":"del","del":true,"ln":1464,"content":"-        pango_glyph_string_free(glyphString);"},{"type":"del","del":true,"ln":1465,"content":"-        NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":1466,"ln2":1124,"content":" "},{"type":"del","del":true,"ln":1467,"content":"-        mUTF16Offset = utf16Offset;"},{"type":"del","del":true,"ln":1468,"content":"-        return NS_OK;"},{"type":"del","del":true,"ln":1469,"content":"-    }"},{"type":"del","del":true,"ln":1470,"content":"-"},{"type":"del","del":true,"ln":1471,"content":"-    nsresult AppendMissingSegment(const gchar *aUTF8, PRUint32 aLength) {"},{"type":"del","del":true,"ln":1472,"content":"-        if (aLength == 0)"},{"type":"del","del":true,"ln":1473,"content":"-            return NS_OK;"},{"type":"add","add":true,"ln":1125,"content":"+        PRUint32 spaceWidth = NS_lround(font->GetMetrics().spaceWidth * FLOAT_PANGO_SCALE);"},{"type":"normal","normal":true,"ln1":1474,"ln2":1126,"content":" "},{"type":"del","del":true,"ln":1475,"content":"-        nsresult rv = mTextRun->AddGlyphRun(mFonts[0], mUTF16Offset);"},{"type":"del","del":true,"ln":1476,"content":"-        NS_ENSURE_SUCCESS(rv, rv);"},{"type":"del","del":true,"ln":1477,"content":"-        PRUint32 utf16Offset = mUTF16Offset;"},{"type":"del","del":true,"ln":1478,"content":"-        rv = mGroup->SetMissingGlyphs(mTextRun, aUTF8, aLength, &utf16Offset);"},{"type":"del","del":true,"ln":1479,"content":"-        NS_ENSURE_SUCCESS(rv, rv);"},{"type":"del","del":true,"ln":1480,"content":"-"},{"type":"del","del":true,"ln":1481,"content":"-        mUTF16Offset = utf16Offset;"},{"type":"del","del":true,"ln":1482,"content":"-        return NS_OK;"},{"type":"del","del":true,"ln":1483,"content":"-    }"},{"type":"add","add":true,"ln":1127,"content":"+        rv = SetGlyphs(aTextRun, font, aUTF8 + offset, length, &utf16Offset, glyphString, spaceWidth, PR_FALSE);"},{"type":"normal","normal":true,"ln1":1484,"ln2":1128,"content":" "},{"type":"del","del":true,"ln":1485,"content":"-    gfxPangoFont *GetNextFont() {"},{"type":"del","del":true,"ln":1486,"content":"-TRY_AGAIN_HOPE_FOR_THE_BEST_2:"},{"type":"del","del":true,"ln":1487,"content":"-        if (mFontIndex < mFonts.Length()) {"},{"type":"del","del":true,"ln":1488,"content":"-            return mFonts[mFontIndex++];"},{"type":"del","del":true,"ln":1489,"content":"-        } else if (!mTriedPrefFonts) {"},{"type":"del","del":true,"ln":1490,"content":"-            mTriedPrefFonts = PR_TRUE;"},{"type":"del","del":true,"ln":1491,"content":"-            nsCAutoString mozLang;"},{"type":"del","del":true,"ln":1492,"content":"-            GetMozLanguage(mItem->analysis.language, mozLang);"},{"type":"del","del":true,"ln":1493,"content":"-            if (!mozLang.IsEmpty()) {"},{"type":"del","del":true,"ln":1494,"content":"-                PRInt32 index = GetCJKLangGroupIndex(mozLang.get());"},{"type":"del","del":true,"ln":1495,"content":"-                if (index >= 0)"},{"type":"del","del":true,"ln":1496,"content":"-                    AppendCJKPrefFonts();"},{"type":"del","del":true,"ln":1497,"content":"-                else"},{"type":"del","del":true,"ln":1498,"content":"-                    AppendPrefFonts(mozLang.get());"},{"type":"del","del":true,"ln":1499,"content":"-            } else {"},{"type":"del","del":true,"ln":1500,"content":"-                NS_ConvertUTF8toUTF16 str(mString);"},{"type":"del","del":true,"ln":1501,"content":"-                PRBool appenedCJKFonts = PR_FALSE;"},{"type":"del","del":true,"ln":1502,"content":"-                for (PRUint32 i = 0; i < str.Length(); ++i) {"},{"type":"del","del":true,"ln":1503,"content":"-                    const PRUnichar ch = str[i];"},{"type":"del","del":true,"ln":1504,"content":"-                    PRUint32 unicodeRange = FindCharUnicodeRange(ch);"},{"type":"del","del":true,"ln":1505,"content":"-"},{"type":"del","del":true,"ln":1506,"content":"-                    /* special case CJK */"},{"type":"del","del":true,"ln":1507,"content":"-                    if (unicodeRange == kRangeSetCJK) {"},{"type":"del","del":true,"ln":1508,"content":"-                        if (!appenedCJKFonts) {"},{"type":"del","del":true,"ln":1509,"content":"-                            appenedCJKFonts = PR_TRUE;"},{"type":"del","del":true,"ln":1510,"content":"-                            AppendCJKPrefFonts();"},{"type":"del","del":true,"ln":1511,"content":"-                        }"},{"type":"del","del":true,"ln":1512,"content":"-                    } else {"},{"type":"del","del":true,"ln":1513,"content":"-                        const char *langGroup ="},{"type":"del","del":true,"ln":1514,"content":"-                            LangGroupFromUnicodeRange(unicodeRange);"},{"type":"del","del":true,"ln":1515,"content":"-                        if (langGroup)"},{"type":"del","del":true,"ln":1516,"content":"-                            AppendPrefFonts(langGroup);"},{"type":"del","del":true,"ln":1517,"content":"-                    }"},{"type":"del","del":true,"ln":1518,"content":"-                }"},{"type":"del","del":true,"ln":1519,"content":"-            }"},{"type":"del","del":true,"ln":1520,"content":"-            goto TRY_AGAIN_HOPE_FOR_THE_BEST_2;"},{"type":"del","del":true,"ln":1521,"content":"-        } else if (!mTriedOtherFonts) {"},{"type":"del","del":true,"ln":1522,"content":"-            mTriedOtherFonts = PR_TRUE;"},{"type":"del","del":true,"ln":1523,"content":"-            // XXX we should try by all system fonts"},{"type":"del","del":true,"ln":1524,"content":"-            goto TRY_AGAIN_HOPE_FOR_THE_BEST_2;"},{"type":"del","del":true,"ln":1525,"content":"-        }"},{"type":"del","del":true,"ln":1526,"content":"-        return nsnull;"},{"type":"add","add":true,"ln":1129,"content":"+        pango_glyph_string_free(glyphString);"},{"type":"normal","normal":true,"ln1":1527,"ln2":1130,"content":"     }"},{"type":"normal","normal":true,"ln1":1528,"ln2":1131,"content":" "},{"type":"del","del":true,"ln":1529,"content":"-    void AppendPrefFonts(const char *aLangGroup) {"},{"type":"del","del":true,"ln":1530,"content":"-        NS_ASSERTION(aLangGroup, \"aLangGroup is null\");"},{"type":"del","del":true,"ln":1531,"content":"-        gfxPlatform *platform = gfxPlatform::GetPlatform();"},{"type":"del","del":true,"ln":1532,"content":"-        nsString fonts;"},{"type":"del","del":true,"ln":1533,"content":"-        platform->GetPrefFonts(aLangGroup, fonts);"},{"type":"del","del":true,"ln":1534,"content":"-        if (fonts.IsEmpty())"},{"type":"del","del":true,"ln":1535,"content":"-            return;"},{"type":"del","del":true,"ln":1536,"content":"-        gfxFontGroup::ForEachFont(fonts, nsDependentCString(aLangGroup),"},{"type":"del","del":true,"ln":1537,"content":"-                                  FontSelector::AddFontCallback, this);"},{"type":"del","del":true,"ln":1538,"content":"-        return;"},{"type":"del","del":true,"ln":1539,"content":"-   }"},{"type":"del","del":true,"ln":1540,"content":"-"},{"type":"del","del":true,"ln":1541,"content":"-   void AppendCJKPrefFonts() {"},{"type":"del","del":true,"ln":1542,"content":"-       nsCOMPtr<nsIPrefService> prefs ="},{"type":"del","del":true,"ln":1543,"content":"-           do_GetService(NS_PREFSERVICE_CONTRACTID);"},{"type":"del","del":true,"ln":1544,"content":"-       if (!prefs)"},{"type":"del","del":true,"ln":1545,"content":"-           return;"},{"type":"del","del":true,"ln":1546,"content":"-"},{"type":"del","del":true,"ln":1547,"content":"-       nsCOMPtr<nsIPrefBranch> prefBranch;"},{"type":"del","del":true,"ln":1548,"content":"-       prefs->GetBranch(0, getter_AddRefs(prefBranch));"},{"type":"del","del":true,"ln":1549,"content":"-       if (!prefBranch)"},{"type":"del","del":true,"ln":1550,"content":"-           return;"},{"type":"del","del":true,"ln":1551,"content":"-"},{"type":"del","del":true,"ln":1552,"content":"-       // Add the accept languages."},{"type":"del","del":true,"ln":1553,"content":"-       nsXPIDLCString list;"},{"type":"del","del":true,"ln":1554,"content":"-       nsresult rv = prefBranch->GetCharPref(\"intl.accept_languages\","},{"type":"del","del":true,"ln":1555,"content":"-                                             getter_Copies(list));"},{"type":"del","del":true,"ln":1556,"content":"-       if (NS_SUCCEEDED(rv) && !list.IsEmpty()) {"},{"type":"del","del":true,"ln":1557,"content":"-           const char kComma = ',';"},{"type":"del","del":true,"ln":1558,"content":"-           const char *p, *p_end;"},{"type":"del","del":true,"ln":1559,"content":"-           list.BeginReading(p);"},{"type":"del","del":true,"ln":1560,"content":"-           list.EndReading(p_end);"},{"type":"del","del":true,"ln":1561,"content":"-           while (p < p_end) {"},{"type":"del","del":true,"ln":1562,"content":"-               while (nsCRT::IsAsciiSpace(*p)) {"},{"type":"del","del":true,"ln":1563,"content":"-                   if (++p == p_end)"},{"type":"del","del":true,"ln":1564,"content":"-                       break;"},{"type":"del","del":true,"ln":1565,"content":"-               }"},{"type":"del","del":true,"ln":1566,"content":"-               if (p == p_end)"},{"type":"del","del":true,"ln":1567,"content":"-                   break;"},{"type":"del","del":true,"ln":1568,"content":"-               const char *start = p;"},{"type":"del","del":true,"ln":1569,"content":"-               while (++p != p_end && *p != kComma)"},{"type":"del","del":true,"ln":1570,"content":"-                   /* nothing */ ;"},{"type":"del","del":true,"ln":1571,"content":"-               nsCAutoString lang(Substring(start, p));"},{"type":"del","del":true,"ln":1572,"content":"-               lang.CompressWhitespace(PR_FALSE, PR_TRUE);"},{"type":"del","del":true,"ln":1573,"content":"-               PRInt32 index = GetCJKLangGroupIndex(lang.get());"},{"type":"del","del":true,"ln":1574,"content":"-               if (index >= 0)"},{"type":"del","del":true,"ln":1575,"content":"-                   AppendPrefFonts(sCJKLangGroup[index]);"},{"type":"del","del":true,"ln":1576,"content":"-               p++;"},{"type":"del","del":true,"ln":1577,"content":"-           }"},{"type":"del","del":true,"ln":1578,"content":"-       }"},{"type":"del","del":true,"ln":1579,"content":"-"},{"type":"del","del":true,"ln":1580,"content":"-       // XXX I think that we should append system locale here if it is CJK."},{"type":"del","del":true,"ln":1581,"content":"-"},{"type":"del","del":true,"ln":1582,"content":"-       // last resort..."},{"type":"del","del":true,"ln":1583,"content":"-       AppendPrefFonts(CJK_LANG_JA);"},{"type":"del","del":true,"ln":1584,"content":"-       AppendPrefFonts(CJK_LANG_KO);"},{"type":"del","del":true,"ln":1585,"content":"-       AppendPrefFonts(CJK_LANG_ZH_CN);"},{"type":"del","del":true,"ln":1586,"content":"-       AppendPrefFonts(CJK_LANG_ZH_HK);"},{"type":"del","del":true,"ln":1587,"content":"-       AppendPrefFonts(CJK_LANG_ZH_TW);"},{"type":"del","del":true,"ln":1588,"content":"-    }"},{"type":"del","del":true,"ln":1589,"content":"-};"},{"type":"add","add":true,"ln":1132,"content":"+    if (items)"},{"type":"add","add":true,"ln":1133,"content":"+        g_list_free(items);"},{"type":"normal","normal":true,"ln1":1590,"ln2":1134,"content":" "},{"type":"del","del":true,"ln":1591,"content":"-void "},{"type":"del","del":true,"ln":1592,"content":"-gfxPangoFontGroup::CreateGlyphRunsItemizing(gfxTextRun *aTextRun,"},{"type":"del","del":true,"ln":1593,"content":"-                                            const gchar *aUTF8, PRUint32 aUTF8Length,"},{"type":"del","del":true,"ln":1594,"content":"-                                            PRUint32 aUTF8HeaderLen)"},{"type":"del","del":true,"ln":1595,"content":"-{"},{"type":"del","del":true,"ln":1596,"content":"-    GList *items = pango_itemize(GetFontAt(0)->GetPangoContext(), aUTF8, 0,"},{"type":"del","del":true,"ln":1597,"content":"-                                 aUTF8Length, nsnull, nsnull);"},{"type":"del","del":true,"ln":1598,"content":"-    "},{"type":"del","del":true,"ln":1599,"content":"-    PRUint32 utf16Offset = 0;"},{"type":"del","del":true,"ln":1600,"content":"-    PRBool isRTL = aTextRun->IsRightToLeft();"},{"type":"del","del":true,"ln":1601,"content":"-    GList *pos = items;"},{"type":"del","del":true,"ln":1602,"content":"-    for (; pos && pos->data; pos = pos->next) {"},{"type":"del","del":true,"ln":1603,"content":"-        PangoItem *item = (PangoItem *)pos->data;"},{"type":"del","del":true,"ln":1604,"content":"-        NS_ASSERTION(isRTL == item->analysis.level % 2, \"RTL assumption mismatch\");"},{"type":"add","add":true,"ln":1135,"content":"+    pango_font_description_free(fontDesc);"},{"type":"normal","normal":true,"ln1":1605,"ln2":1136,"content":" "},{"type":"del","del":true,"ln":1606,"content":"-        PRUint32 offset = item->offset;"},{"type":"del","del":true,"ln":1607,"content":"-        PRUint32 length = item->length;"},{"type":"del","del":true,"ln":1608,"content":"-        if (offset < aUTF8HeaderLen) {"},{"type":"del","del":true,"ln":1609,"content":"-            if (offset + length <= aUTF8HeaderLen) {"},{"type":"del","del":true,"ln":1610,"content":"-                pango_item_free(item);"},{"type":"del","del":true,"ln":1611,"content":"-                continue;"},{"type":"del","del":true,"ln":1612,"content":"-            }"},{"type":"del","del":true,"ln":1613,"content":"-            length -= aUTF8HeaderLen - offset;"},{"type":"del","del":true,"ln":1614,"content":"-            offset = aUTF8HeaderLen;"},{"type":"del","del":true,"ln":1615,"content":"-        }"},{"type":"del","del":true,"ln":1616,"content":"-        "},{"type":"del","del":true,"ln":1617,"content":"-        SetupClusterBoundaries(aTextRun, aUTF8 + offset, length, utf16Offset, &item->analysis);"},{"type":"del","del":true,"ln":1618,"content":"-        FontSelector fs(aUTF8 + offset, length, this, aTextRun, item, utf16Offset, isRTL);"},{"type":"del","del":true,"ln":1619,"content":"-        fs.Run(); // appends GlyphRuns"},{"type":"del","del":true,"ln":1620,"content":"-        utf16Offset = fs.GetUTF16Offset();"},{"type":"del","del":true,"ln":1621,"content":"-        pango_item_free(item);"},{"type":"del","del":true,"ln":1622,"content":"-    }"},{"type":"add","add":true,"ln":1137,"content":"+    g_object_unref(context);"},{"type":"normal","normal":true,"ln1":1623,"ln2":1138,"content":" "},{"type":"del","del":true,"ln":1624,"content":"-    NS_ASSERTION(utf16Offset == aTextRun->GetLength(),"},{"type":"del","del":true,"ln":1625,"content":"-                 \"Didn't resolve all characters\");"},{"type":"del","del":true,"ln":1626,"content":"-  "},{"type":"del","del":true,"ln":1627,"content":"-    if (items)"},{"type":"del","del":true,"ln":1628,"content":"-        g_list_free(items);"},{"type":"add","add":true,"ln":1139,"content":"+    aTextRun->SortGlyphRuns();"},{"type":"normal","normal":true,"ln1":1629,"ln2":1140,"content":" }"},{"type":"normal","normal":true,"ln1":1630,"ln2":1141,"content":" "},{"type":"add","add":true,"ln":1142,"content":"+"},{"type":"add","add":true,"ln":1143,"content":"+"},{"type":"normal","normal":true,"ln1":1631,"ln2":1144,"content":" /**"},{"type":"normal","normal":true,"ln1":1632,"ln2":1145,"content":"  ** language group helpers"},{"type":"normal","normal":true,"ln1":1633,"ln2":1146,"content":"  **/"}],"oldStart":1314,"oldLines":320,"newStart":1054,"newLines":93},{"content":"@@ -1696,7 +1209,7 @@ GetPangoLanguage(const nsACString& cname)","changes":[{"type":"normal","normal":true,"ln1":1696,"ln2":1209,"content":"     else if (langGroup->PangoLang) "},{"type":"normal","normal":true,"ln1":1697,"ln2":1210,"content":"         return pango_language_from_string(langGroup->PangoLang);"},{"type":"normal","normal":true,"ln1":1698,"ln2":1211,"content":" "},{"type":"del","del":true,"ln":1699,"content":"-    return pango_language_from_string(\"en\");"},{"type":"add","add":true,"ln":1212,"content":"+    return nsnull;"},{"type":"normal","normal":true,"ln1":1700,"ln2":1213,"content":" }"},{"type":"normal","normal":true,"ln1":1701,"ln2":1214,"content":" "},{"type":"normal","normal":true,"ln1":1702,"ln2":1215,"content":" // See pango-script-lang-table.h in pango."}],"oldStart":1696,"oldLines":7,"newStart":1209,"newLines":7},{"content":"@@ -1880,38 +1393,7 @@ static const MozPangoLangGroup PangoAllLangGroup[] = {","changes":[{"type":"normal","normal":true,"ln1":1880,"ln2":1393,"content":"     { \"x-western\",      \"zu\"    },"},{"type":"normal","normal":true,"ln1":1881,"ln2":1394,"content":" };"},{"type":"normal","normal":true,"ln1":1882,"ln2":1395,"content":" "},{"type":"del","del":true,"ln":1883,"content":"-#define NUM_PANGO_ALL_LANG_GROUPS (sizeof (PangoAllLangGroup) / \\"},{"type":"del","del":true,"ln":1884,"content":"-                                   sizeof (PangoAllLangGroup[0]))"},{"type":"del","del":true,"ln":1885,"content":"-"},{"type":"del","del":true,"ln":1886,"content":"-/* static */"},{"type":"del","del":true,"ln":1887,"content":"-void"},{"type":"del","del":true,"ln":1888,"content":"-GetMozLanguage(const PangoLanguage *aLang, nsACString &aMozLang)"},{"type":"del","del":true,"ln":1889,"content":"-{"},{"type":"del","del":true,"ln":1890,"content":"-    aMozLang.Truncate();"},{"type":"del","del":true,"ln":1891,"content":"-    if (!aLang)"},{"type":"del","del":true,"ln":1892,"content":"-        return;"},{"type":"del","del":true,"ln":1893,"content":"-"},{"type":"del","del":true,"ln":1894,"content":"-    nsCAutoString lang(pango_language_to_string(aLang));"},{"type":"del","del":true,"ln":1895,"content":"-    if (lang.IsEmpty() || lang.Equals(\"xx\"))"},{"type":"del","del":true,"ln":1896,"content":"-        return;"},{"type":"del","del":true,"ln":1897,"content":"-"},{"type":"del","del":true,"ln":1898,"content":"-    while (1) {"},{"type":"del","del":true,"ln":1899,"content":"-        for (PRUint32 i = 0; i < NUM_PANGO_ALL_LANG_GROUPS; ++i) {"},{"type":"del","del":true,"ln":1900,"content":"-            if (lang.Equals(PangoAllLangGroup[i].PangoLang)) {"},{"type":"del","del":true,"ln":1901,"content":"-                if (PangoAllLangGroup[i].mozLangGroup)"},{"type":"del","del":true,"ln":1902,"content":"-                    aMozLang.Assign(PangoAllLangGroup[i].mozLangGroup);"},{"type":"del","del":true,"ln":1903,"content":"-                return;"},{"type":"del","del":true,"ln":1904,"content":"-            }"},{"type":"del","del":true,"ln":1905,"content":"-        }"},{"type":"del","del":true,"ln":1906,"content":"-"},{"type":"del","del":true,"ln":1907,"content":"-        PRInt32 hyphen = lang.FindChar('-');"},{"type":"del","del":true,"ln":1908,"content":"-        if (hyphen != kNotFound) {"},{"type":"del","del":true,"ln":1909,"content":"-            lang.Cut(hyphen, lang.Length());"},{"type":"del","del":true,"ln":1910,"content":"-            continue;"},{"type":"del","del":true,"ln":1911,"content":"-        }"},{"type":"del","del":true,"ln":1912,"content":"-        break;"},{"type":"del","del":true,"ln":1913,"content":"-    }"},{"type":"del","del":true,"ln":1914,"content":"-}"},{"type":"add","add":true,"ln":1396,"content":"+#define NUM_PANGO_ALL_LANG_GROUPS (G_N_ELEMENTS (PangoAllLangGroup))"},{"type":"normal","normal":true,"ln1":1915,"ln2":1397,"content":" "},{"type":"normal","normal":true,"ln1":1916,"ln2":1398,"content":" gfxPangoFontCache::gfxPangoFontCache()"},{"type":"normal","normal":true,"ln1":1917,"ln2":1399,"content":" {"}],"oldStart":1880,"oldLines":38,"newStart":1393,"newLines":7},{"content":"@@ -1945,39 +1427,3 @@ gfxPangoFontCache::Get(const PangoFontDescription *aFontDesc)","changes":[{"type":"normal","normal":true,"ln1":1945,"ln2":1427,"content":"     g_object_ref(font);"},{"type":"normal","normal":true,"ln1":1946,"ln2":1428,"content":"     return font;"},{"type":"normal","normal":true,"ln1":1947,"ln2":1429,"content":" }"},{"type":"del","del":true,"ln":1948,"content":"-"},{"type":"del","del":true,"ln":1949,"content":"-gfxPangoFontNameMap::gfxPangoFontNameMap()"},{"type":"del","del":true,"ln":1950,"content":"-{"},{"type":"del","del":true,"ln":1951,"content":"-    mPangoFonts.Init(100);"},{"type":"del","del":true,"ln":1952,"content":"-}"},{"type":"del","del":true,"ln":1953,"content":"-"},{"type":"del","del":true,"ln":1954,"content":"-gfxPangoFontNameMap::~gfxPangoFontNameMap()"},{"type":"del","del":true,"ln":1955,"content":"-{"},{"type":"del","del":true,"ln":1956,"content":"-}"},{"type":"del","del":true,"ln":1957,"content":"-"},{"type":"del","del":true,"ln":1958,"content":"-void"},{"type":"del","del":true,"ln":1959,"content":"-gfxPangoFontNameMap::Put(const nsACString &aName, PangoFont *aPangoFont)"},{"type":"del","del":true,"ln":1960,"content":"-{"},{"type":"del","del":true,"ln":1961,"content":"-    nsCAutoString key(aName);"},{"type":"del","del":true,"ln":1962,"content":"-    ToLowerCase(key);"},{"type":"del","del":true,"ln":1963,"content":"-    gfxPangoFontWrapper *value;"},{"type":"del","del":true,"ln":1964,"content":"-    if (!mPangoFonts.Get(key, &value)) {"},{"type":"del","del":true,"ln":1965,"content":"-        value = new gfxPangoFontWrapper(aPangoFont);"},{"type":"del","del":true,"ln":1966,"content":"-        if (!value)"},{"type":"del","del":true,"ln":1967,"content":"-            return;"},{"type":"del","del":true,"ln":1968,"content":"-        mPangoFonts.Put(key, value);"},{"type":"del","del":true,"ln":1969,"content":"-    }"},{"type":"del","del":true,"ln":1970,"content":"-}"},{"type":"del","del":true,"ln":1971,"content":"-"},{"type":"del","del":true,"ln":1972,"content":"-PangoFont*"},{"type":"del","del":true,"ln":1973,"content":"-gfxPangoFontNameMap::Get(const nsACString &aName)"},{"type":"del","del":true,"ln":1974,"content":"-{"},{"type":"del","del":true,"ln":1975,"content":"-    nsCAutoString key(aName);"},{"type":"del","del":true,"ln":1976,"content":"-    ToLowerCase(key);"},{"type":"del","del":true,"ln":1977,"content":"-    gfxPangoFontWrapper *value;"},{"type":"del","del":true,"ln":1978,"content":"-    if (!mPangoFonts.Get(key, &value))"},{"type":"del","del":true,"ln":1979,"content":"-        return nsnull;"},{"type":"del","del":true,"ln":1980,"content":"-    PangoFont *font = value->Get();"},{"type":"del","del":true,"ln":1981,"content":"-    g_object_ref(font);"},{"type":"del","del":true,"ln":1982,"content":"-    return font;"},{"type":"del","del":true,"ln":1983,"content":"-}"}],"oldStart":1945,"oldLines":39,"newStart":1427,"newLines":3}],"deletions":722,"additions":168,"from":"gfx/thebes/src/gfxPangoFonts.cpp","to":"gfx/thebes/src/gfxPangoFonts.cpp","index":["1696cd1..cf7b7e4","100644"]},{"chunks":[{"content":"@@ -60,12 +60,6 @@","changes":[{"type":"normal","normal":true,"ln1":60,"ln2":60,"content":" "},{"type":"normal","normal":true,"ln1":61,"ln2":61,"content":" #include <fontconfig/fontconfig.h>"},{"type":"normal","normal":true,"ln1":62,"ln2":62,"content":" "},{"type":"del","del":true,"ln":63,"content":"-#ifndef THEBES_USE_PANGO_CAIRO"},{"type":"del","del":true,"ln":64,"content":"-#include <pango/pangoxft.h>"},{"type":"del","del":true,"ln":65,"content":"-#endif // THEBES_USE_PANGO_CAIRO"},{"type":"del","del":true,"ln":66,"content":"-"},{"type":"del","del":true,"ln":67,"content":"-#include <pango/pango-font.h>"},{"type":"del","del":true,"ln":68,"content":"-"},{"type":"normal","normal":true,"ln1":69,"ln2":63,"content":" #include \"nsMathUtils.h\""},{"type":"normal","normal":true,"ln1":70,"ln2":64,"content":" "},{"type":"normal","normal":true,"ln1":71,"ln2":65,"content":" #include \"lcms.h\""}],"oldStart":60,"oldLines":12,"newStart":60,"newLines":6},{"content":"@@ -89,6 +83,8 @@ gfxPlatformGtk::gfxPlatformGtk()","changes":[{"type":"normal","normal":true,"ln1":89,"ln2":83,"content":" #endif"},{"type":"normal","normal":true,"ln1":90,"ln2":84,"content":"     if (!sFontconfigUtils)"},{"type":"normal","normal":true,"ln1":91,"ln2":85,"content":"         sFontconfigUtils = gfxFontconfigUtils::GetFontconfigUtils();"},{"type":"add","add":true,"ln":86,"content":"+"},{"type":"add","add":true,"ln":87,"content":"+    InitDPI();"},{"type":"normal","normal":true,"ln1":92,"ln2":88,"content":" }"},{"type":"normal","normal":true,"ln1":93,"ln2":89,"content":" "},{"type":"normal","normal":true,"ln1":94,"ln2":90,"content":" gfxPlatformGtk::~gfxPlatformGtk()"}],"oldStart":89,"oldLines":6,"newStart":83,"newLines":8},{"content":"@@ -98,10 +94,6 @@ gfxPlatformGtk::~gfxPlatformGtk()","changes":[{"type":"normal","normal":true,"ln1":98,"ln2":94,"content":" "},{"type":"normal","normal":true,"ln1":99,"ln2":95,"content":"     gfxPangoFont::Shutdown();"},{"type":"normal","normal":true,"ln1":100,"ln2":96,"content":" "},{"type":"del","del":true,"ln":101,"content":"-#ifndef THEBES_USE_PANGO_CAIRO"},{"type":"del","del":true,"ln":102,"content":"-    pango_xft_shutdown_display(GDK_DISPLAY(), 0);"},{"type":"del","del":true,"ln":103,"content":"-#endif"},{"type":"del","del":true,"ln":104,"content":"-"},{"type":"normal","normal":true,"ln1":105,"ln2":97,"content":" #if 0"},{"type":"normal","normal":true,"ln1":106,"ln2":98,"content":"     // It would be nice to do this (although it might need to be after"},{"type":"normal","normal":true,"ln1":107,"ln2":99,"content":"     // the cairo shutdown that happens in ~gfxPlatform).  It even looks"}],"oldStart":98,"oldLines":10,"newStart":94,"newLines":6},{"content":"@@ -278,93 +270,17 @@ gfxPlatformGtk::CreateFontGroup(const nsAString &aFamilies,","changes":[{"type":"normal","normal":true,"ln1":278,"ln2":270,"content":"     return new gfxPangoFontGroup(aFamilies, aStyle);"},{"type":"normal","normal":true,"ln1":279,"ln2":271,"content":" }"},{"type":"normal","normal":true,"ln1":280,"ln2":272,"content":" "},{"type":"del","del":true,"ln":281,"content":"-static PRInt32"},{"type":"del","del":true,"ln":282,"content":"-GetXftDPI()"},{"type":"del","del":true,"ln":283,"content":"-{"},{"type":"del","del":true,"ln":284,"content":"-  char *val = XGetDefault(GDK_DISPLAY(), \"Xft\", \"dpi\");"},{"type":"del","del":true,"ln":285,"content":"-  if (val) {"},{"type":"del","del":true,"ln":286,"content":"-    char *e;"},{"type":"del","del":true,"ln":287,"content":"-    double d = strtod(val, &e);"},{"type":"del","del":true,"ln":288,"content":"-"},{"type":"del","del":true,"ln":289,"content":"-    if (e != val)"},{"type":"del","del":true,"ln":290,"content":"-      return NS_lround(d);"},{"type":"del","del":true,"ln":291,"content":"-  }"},{"type":"del","del":true,"ln":292,"content":"-"},{"type":"del","del":true,"ln":293,"content":"-  return -1;"},{"type":"del","del":true,"ln":294,"content":"-}"},{"type":"del","del":true,"ln":295,"content":"-"},{"type":"del","del":true,"ln":296,"content":"-static PRInt32"},{"type":"del","del":true,"ln":297,"content":"-GetDPIFromPangoFont()"},{"type":"del","del":true,"ln":298,"content":"-{"},{"type":"del","del":true,"ln":299,"content":"-#ifndef THEBES_USE_PANGO_CAIRO"},{"type":"del","del":true,"ln":300,"content":"-    PangoContext* ctx = pango_xft_get_context(GDK_DISPLAY(), 0);"},{"type":"del","del":true,"ln":301,"content":"-    gdk_pango_context_set_colormap(ctx, gdk_rgb_get_cmap());"},{"type":"del","del":true,"ln":302,"content":"-#else"},{"type":"del","del":true,"ln":303,"content":"-    PangoContext* ctx ="},{"type":"del","del":true,"ln":304,"content":"-        pango_cairo_font_map_create_context("},{"type":"del","del":true,"ln":305,"content":"-          PANGO_CAIRO_FONT_MAP(pango_cairo_font_map_get_default()));"},{"type":"del","del":true,"ln":306,"content":"-#endif"},{"type":"del","del":true,"ln":307,"content":"-"},{"type":"del","del":true,"ln":308,"content":"-    if (!ctx) {"},{"type":"del","del":true,"ln":309,"content":"-        return 0;"},{"type":"del","del":true,"ln":310,"content":"-    }"},{"type":"del","del":true,"ln":311,"content":"-"},{"type":"del","del":true,"ln":312,"content":"-    double dblDPI = 0.0f;"},{"type":"del","del":true,"ln":313,"content":"-    GList *items = nsnull;"},{"type":"del","del":true,"ln":314,"content":"-    PangoItem *item = nsnull;"},{"type":"del","del":true,"ln":315,"content":"-    PangoFcFont *fcfont = nsnull;"},{"type":"del","del":true,"ln":316,"content":"-    "},{"type":"del","del":true,"ln":317,"content":"-    PangoAttrList *al = pango_attr_list_new();"},{"type":"del","del":true,"ln":318,"content":"-"},{"type":"del","del":true,"ln":319,"content":"-    if (!al) {"},{"type":"del","del":true,"ln":320,"content":"-        goto cleanup;"},{"type":"del","del":true,"ln":321,"content":"-    }"},{"type":"del","del":true,"ln":322,"content":"-"},{"type":"del","del":true,"ln":323,"content":"-    // Just using the string \"a\" because we need _some_ text."},{"type":"del","del":true,"ln":324,"content":"-    items = pango_itemize(ctx, \"a\", 0, 1, al, NULL);"},{"type":"del","del":true,"ln":325,"content":"-"},{"type":"del","del":true,"ln":326,"content":"-    if (!items) {"},{"type":"del","del":true,"ln":327,"content":"-        goto cleanup;"},{"type":"del","del":true,"ln":328,"content":"-    }"},{"type":"del","del":true,"ln":329,"content":"-"},{"type":"del","del":true,"ln":330,"content":"-    item = (PangoItem*)items->data;"},{"type":"del","del":true,"ln":331,"content":"-"},{"type":"del","del":true,"ln":332,"content":"-    if (!item) {"},{"type":"del","del":true,"ln":333,"content":"-        goto cleanup;"},{"type":"del","del":true,"ln":334,"content":"-    }"},{"type":"del","del":true,"ln":335,"content":"-"},{"type":"del","del":true,"ln":336,"content":"-    fcfont = PANGO_FC_FONT(item->analysis.font);"},{"type":"del","del":true,"ln":337,"content":"-"},{"type":"del","del":true,"ln":338,"content":"-    if (!fcfont) {"},{"type":"del","del":true,"ln":339,"content":"-        goto cleanup;"},{"type":"del","del":true,"ln":340,"content":"-    }"},{"type":"del","del":true,"ln":341,"content":"-"},{"type":"del","del":true,"ln":342,"content":"-    FcPatternGetDouble(fcfont->font_pattern, FC_DPI, 0, &dblDPI);"},{"type":"del","del":true,"ln":343,"content":"-"},{"type":"del","del":true,"ln":344,"content":"- cleanup:   "},{"type":"del","del":true,"ln":345,"content":"-    if (al)"},{"type":"del","del":true,"ln":346,"content":"-        pango_attr_list_unref(al);"},{"type":"del","del":true,"ln":347,"content":"-    if (item)"},{"type":"del","del":true,"ln":348,"content":"-        pango_item_free(item);"},{"type":"del","del":true,"ln":349,"content":"-    if (items)"},{"type":"del","del":true,"ln":350,"content":"-        g_list_free(items);"},{"type":"del","del":true,"ln":351,"content":"-    if (ctx)"},{"type":"del","del":true,"ln":352,"content":"-        g_object_unref(ctx);"},{"type":"del","del":true,"ln":353,"content":"-"},{"type":"del","del":true,"ln":354,"content":"-    return NS_lround(dblDPI);"},{"type":"del","del":true,"ln":355,"content":"-}"},{"type":"del","del":true,"ln":356,"content":"-"},{"type":"normal","normal":true,"ln1":357,"ln2":273,"content":" /* static */"},{"type":"normal","normal":true,"ln1":358,"ln2":274,"content":" void"},{"type":"normal","normal":true,"ln1":359,"ln2":275,"content":" gfxPlatformGtk::InitDPI()"},{"type":"normal","normal":true,"ln1":360,"ln2":276,"content":" {"},{"type":"del","del":true,"ln":361,"content":"-    sDPI = GetXftDPI();"},{"type":"add","add":true,"ln":277,"content":"+    PangoContext *context = gdk_pango_context_get ();"},{"type":"add","add":true,"ln":278,"content":"+    sDPI = pango_cairo_context_get_resolution (context);"},{"type":"add","add":true,"ln":279,"content":"+    g_object_unref (context);"},{"type":"add","add":true,"ln":280,"content":"+"},{"type":"normal","normal":true,"ln1":362,"ln2":281,"content":"     if (sDPI <= 0) {"},{"type":"del","del":true,"ln":363,"content":"-        sDPI = GetDPIFromPangoFont();"},{"type":"del","del":true,"ln":364,"content":"-        if (sDPI <= 0) {"},{"type":"del","del":true,"ln":365,"content":"-            // Fall back to something sane"},{"type":"del","del":true,"ln":366,"content":"-            sDPI = 96;"},{"type":"del","del":true,"ln":367,"content":"-        }"},{"type":"add","add":true,"ln":282,"content":"+\t// Fall back to something sane"},{"type":"add","add":true,"ln":283,"content":"+\tsDPI = 96;"},{"type":"normal","normal":true,"ln1":368,"ln2":284,"content":"     }"},{"type":"normal","normal":true,"ln1":369,"ln2":285,"content":" }"},{"type":"normal","normal":true,"ln1":370,"ln2":286,"content":" "}],"oldStart":278,"oldLines":93,"newStart":270,"newLines":17}],"deletions":92,"additions":8,"from":"gfx/thebes/src/gfxPlatformGtk.cpp","to":"gfx/thebes/src/gfxPlatformGtk.cpp","index":["4d5f4e0..826f997","100644"]}]}