{"bug_id":233108,"commitHash":"866556a","commit_info":{"sha":"866556a2b03b19e51314a20f519a839064d58a7e","commit":{"author":{"name":"bzbarsky%mit.edu","email":"bzbarsky%mit.edu","date":"2005-11-02T07:42:13Z"},"committer":{"name":"bzbarsky%mit.edu","email":"bzbarsky%mit.edu","date":"2005-11-02T07:42:13Z"},"message":"Add a version of CheckLoadURI that takes a source principal instead of a source\nURI.  Update a bunch of callers to use it.  Bug 233108, r=caillon, sr=dveditz","tree":{"sha":"99bc593a42558154676e016dcba6b49d5406d5e1","url":"https://api.github.com/repos/mozilla/gecko-dev/git/trees/99bc593a42558154676e016dcba6b49d5406d5e1"},"url":"https://api.github.com/repos/mozilla/gecko-dev/git/commits/866556a2b03b19e51314a20f519a839064d58a7e","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/mozilla/gecko-dev/commits/866556a2b03b19e51314a20f519a839064d58a7e","html_url":"https://github.com/mozilla/gecko-dev/commit/866556a2b03b19e51314a20f519a839064d58a7e","comments_url":"https://api.github.com/repos/mozilla/gecko-dev/commits/866556a2b03b19e51314a20f519a839064d58a7e/comments","author":null,"committer":null,"parents":[{"sha":"798474738c80d95f98a710ca4651651e4ec56ddf","url":"https://api.github.com/repos/mozilla/gecko-dev/commits/798474738c80d95f98a710ca4651651e4ec56ddf","html_url":"https://github.com/mozilla/gecko-dev/commit/798474738c80d95f98a710ca4651651e4ec56ddf"}],"stats":{"total":41,"additions":26,"deletions":15},"files":[{"sha":"fd6646741dccc0c0054ab3c1e2e2653f7c853c24","filename":"content/xslt/public/nsIDocumentTransformer.h","status":"modified","additions":2,"deletions":1,"changes":3,"blob_url":"https://github.com/mozilla/gecko-dev/blob/866556a2b03b19e51314a20f519a839064d58a7e/content/xslt/public/nsIDocumentTransformer.h","raw_url":"https://github.com/mozilla/gecko-dev/raw/866556a2b03b19e51314a20f519a839064d58a7e/content/xslt/public/nsIDocumentTransformer.h","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/content/xslt/public/nsIDocumentTransformer.h?ref=866556a2b03b19e51314a20f519a839064d58a7e","patch":"@@ -44,6 +44,7 @@ class nsIDOMDocument;\n class nsIDOMNode;\n class nsILoadGroup;\n class nsIURI;\n+class nsIPrincipal;\n \n #define NS_ITRANSFORMOBSERVER_IID \\\n   {0xcce88481, 0x6eb3, 0x11d6, \\\n@@ -74,7 +75,7 @@ class nsIDocumentTransformer : public nsISupports\n \n   NS_IMETHOD SetTransformObserver(nsITransformObserver* aObserver) = 0;\n   NS_IMETHOD LoadStyleSheet(nsIURI* aUri, nsILoadGroup* aLoadGroup,\n-                            nsIURI* aReferrerUri) = 0;\n+                            nsIPrincipal* aCallerPrincipal) = 0;\n   NS_IMETHOD SetSourceContentModel(nsIDOMNode* aSource) = 0;\n   NS_IMETHOD CancelLoads() = 0;\n };"},{"sha":"b714eee289ad4ea076884929befe148e94dd420c","filename":"content/xslt/src/xslt/txMozillaStylesheetCompiler.cpp","status":"modified","additions":17,"deletions":10,"changes":27,"blob_url":"https://github.com/mozilla/gecko-dev/blob/866556a2b03b19e51314a20f519a839064d58a7e/content/xslt/src/xslt/txMozillaStylesheetCompiler.cpp","raw_url":"https://github.com/mozilla/gecko-dev/raw/866556a2b03b19e51314a20f519a839064d58a7e/content/xslt/src/xslt/txMozillaStylesheetCompiler.cpp","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/content/xslt/src/xslt/txMozillaStylesheetCompiler.cpp?ref=866556a2b03b19e51314a20f519a839064d58a7e","patch":"@@ -55,6 +55,7 @@\n #include \"nsIStreamConverterService.h\"\n #include \"nsISyncLoadDOMService.h\"\n #include \"nsIURI.h\"\n+#include \"nsIPrincipal.h\"\n #include \"nsIWindowWatcher.h\"\n #include \"nsIXMLContentSink.h\"\n #include \"nsMimeTypes.h\"\n@@ -423,7 +424,7 @@ class txCompileObserver : public txACompileObserver\n     TX_DECL_ACOMPILEOBSERVER;\n \n     nsresult startLoad(nsIURI* aUri, txStylesheetCompiler* aCompiler,\n-                       nsIURI* aReferrerUri);\n+                       nsIPrincipal* aCallerPrincipal);\n \n protected:\n     nsAutoRefCnt mRefCnt;\n@@ -492,19 +493,25 @@ txCompileObserver::onDoneCompiling(txStylesheetCompiler* aCompiler,\n \n nsresult\n txCompileObserver::startLoad(nsIURI* aUri, txStylesheetCompiler* aCompiler,\n-                             nsIURI* aReferrerUri)\n+                             nsIPrincipal* aCallerPrincipal)\n {\n     nsresult rv;\n-    if (aReferrerUri) {\n+    nsCOMPtr<nsIURI> referrerURI;\n+    \n+    if (aCallerPrincipal) {\n         nsCOMPtr<nsIScriptSecurityManager> securityManager = \n             do_GetService(NS_SCRIPTSECURITYMANAGER_CONTRACTID, &rv);\n         NS_ENSURE_SUCCESS(rv, rv);\n \n-        rv = securityManager->CheckLoadURI(aReferrerUri, aUri,\n-                                           nsIScriptSecurityManager::STANDARD);\n+        rv = securityManager->\n+            CheckLoadURIWithPrincipal(aCallerPrincipal, aUri,\n+                                      nsIScriptSecurityManager::STANDARD);\n         NS_ENSURE_SUCCESS(rv, rv);\n \n-        rv = securityManager->CheckSameOriginURI(aReferrerUri, aUri);\n+        aCallerPrincipal->GetURI(getter_AddRefs(referrerURI));\n+        NS_ASSERTION(referrerURI, \"Caller principal must have a URI!\");\n+        \n+        rv = securityManager->CheckSameOriginURI(referrerURI, aUri);\n         NS_ENSURE_SUCCESS(rv, rv);\n     }\n \n@@ -520,8 +527,8 @@ txCompileObserver::startLoad(nsIURI* aUri, txStylesheetCompiler* aCompiler,\n                                       NS_LITERAL_CSTRING(\"text/xml,application/xml,application/xhtml+xml,*/*;q=0.1\"),\n                                       PR_FALSE);\n \n-        if (aReferrerUri) {\n-            httpChannel->SetReferrer(aReferrerUri);\n+        if (referrerURI) {\n+            httpChannel->SetReferrer(referrerURI);\n         }\n     }\n \n@@ -542,7 +549,7 @@ txCompileObserver::startLoad(nsIURI* aUri, txStylesheetCompiler* aCompiler,\n \n nsresult\n TX_LoadSheet(nsIURI* aUri, txMozillaXSLTProcessor* aProcessor,\n-             nsILoadGroup* aLoadGroup, nsIURI* aReferrerUri)\n+             nsILoadGroup* aLoadGroup, nsIPrincipal* aCallerPrincipal)\n {\n     nsCAutoString uri;\n     aUri->GetSpec(uri);\n@@ -556,7 +563,7 @@ TX_LoadSheet(nsIURI* aUri, txMozillaXSLTProcessor* aProcessor,\n         new txStylesheetCompiler(NS_ConvertUTF8toUCS2(uri), observer);\n     NS_ENSURE_TRUE(compiler, NS_ERROR_OUT_OF_MEMORY);\n \n-    return observer->startLoad(aUri, compiler, aReferrerUri);\n+    return observer->startLoad(aUri, compiler, aCallerPrincipal);\n }\n \n /**"},{"sha":"f85e231af00f942da04dbb1f3be52e7b9f1b4b12","filename":"content/xslt/src/xslt/txMozillaXSLTProcessor.cpp","status":"modified","additions":3,"deletions":2,"changes":5,"blob_url":"https://github.com/mozilla/gecko-dev/blob/866556a2b03b19e51314a20f519a839064d58a7e/content/xslt/src/xslt/txMozillaXSLTProcessor.cpp","raw_url":"https://github.com/mozilla/gecko-dev/raw/866556a2b03b19e51314a20f519a839064d58a7e/content/xslt/src/xslt/txMozillaXSLTProcessor.cpp","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/content/xslt/src/xslt/txMozillaXSLTProcessor.cpp?ref=866556a2b03b19e51314a20f519a839064d58a7e","patch":"@@ -60,6 +60,7 @@\n #include \"XMLUtils.h\"\n #include \"txUnknownHandler.h\"\n #include \"txXSLTProcessor.h\"\n+#include \"nsIPrincipal.h\"\n \n static NS_DEFINE_CID(kXMLDocumentCID, NS_XMLDOCUMENT_CID);\n \n@@ -642,9 +643,9 @@ txMozillaXSLTProcessor::Reset()\n \n NS_IMETHODIMP\n txMozillaXSLTProcessor::LoadStyleSheet(nsIURI* aUri, nsILoadGroup* aLoadGroup,\n-                                       nsIURI* aReferrerUri)\n+                                       nsIPrincipal* aCallerPrincipal)\n {\n-    nsresult rv = TX_LoadSheet(aUri, this, aLoadGroup, aReferrerUri);\n+    nsresult rv = TX_LoadSheet(aUri, this, aLoadGroup, aCallerPrincipal);\n     if (NS_FAILED(rv) && mObserver) {\n         // This is most likely a network or security error, just\n         // use the uri as context."},{"sha":"75727efb3765fa2ef3b184162b6f75037fa6851c","filename":"content/xslt/src/xslt/txMozillaXSLTProcessor.h","status":"modified","additions":4,"deletions":2,"changes":6,"blob_url":"https://github.com/mozilla/gecko-dev/blob/866556a2b03b19e51314a20f519a839064d58a7e/content/xslt/src/xslt/txMozillaXSLTProcessor.h","raw_url":"https://github.com/mozilla/gecko-dev/raw/866556a2b03b19e51314a20f519a839064d58a7e/content/xslt/src/xslt/txMozillaXSLTProcessor.h","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/content/xslt/src/xslt/txMozillaXSLTProcessor.h?ref=866556a2b03b19e51314a20f519a839064d58a7e","patch":"@@ -56,6 +56,7 @@\n class nsIURI;\n class nsIXMLContentSink;\n class nsIDOMNode;\n+class nsIPrincipal;\n \n /* bacd8ad0-552f-11d3-a9f7-000064657374 */\n #define TRANSFORMIIX_XSLT_PROCESSOR_CID   \\\n@@ -138,7 +139,7 @@ class txMozillaXSLTProcessor : public nsIXSLTProcessor,\n     // nsIDocumentTransformer interface\n     NS_IMETHOD SetTransformObserver(nsITransformObserver* aObserver);\n     NS_IMETHOD LoadStyleSheet(nsIURI* aUri, nsILoadGroup* aLoadGroup,\n-                              nsIURI* aReferrerUri);\n+                              nsIPrincipal* aCallerPrincipal);\n     NS_IMETHOD SetSourceContentModel(nsIDOMNode* aSource);\n     NS_IMETHOD CancelLoads() {return NS_OK;};\n \n@@ -167,7 +168,8 @@ class txMozillaXSLTProcessor : public nsIXSLTProcessor,\n };\n \n extern nsresult TX_LoadSheet(nsIURI* aUri, txMozillaXSLTProcessor* aProcessor,\n-                             nsILoadGroup* aLoadGroup, nsIURI* aReferrerUri);\n+                             nsILoadGroup* aLoadGroup,\n+                             nsIPrincipal* aCallerPrincipal);\n \n extern nsresult TX_CompileStylesheet(nsIDOMNode* aNode,\n                                      txStylesheet** aStylesheet);"}]},"blames":["4ececefa","8f0893d8","4e24f4bf","8f0893d8","ae636cdb","4ececefa","8f0893d8","4e24f4bf","a6f55e5a","8d45a638","8f0893d8","bd2cecba","4ececefa"]}