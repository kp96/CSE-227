{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas60f796a\""},"diff":[{"chunks":[{"content":"@@ -23,7 +23,7 @@","changes":[{"type":"normal","normal":true,"ln1":23,"ln2":23,"content":"  *  Joe Hewitt     <hewitt@netscape.com>   (Set Background)"},{"type":"normal","normal":true,"ln1":24,"ln2":24,"content":"  *  Blake Ross     <blake@cs.stanford.edu> (Desktop Color, DDE support)"},{"type":"normal","normal":true,"ln1":25,"ln2":25,"content":"  *  Jungshik Shin  <jshin@mailaps.org>     (I18N)"},{"type":"del","del":true,"ln":26,"content":"- *  Robert Strong  <robert.bugzilla@gmail.com>  (Long paths, DDE)"},{"type":"add","add":true,"ln":26,"content":"+ *  Robert Strong  <robert.bugzilla@gmail.com>"},{"type":"normal","normal":true,"ln1":27,"ln2":27,"content":"  *  Asaf Romano    <mano@mozilla.com>"},{"type":"normal","normal":true,"ln1":28,"ln2":28,"content":"  *  Ryan Jones     <sciguyryan@gmail.com>"},{"type":"normal","normal":true,"ln1":29,"ln2":29,"content":"  *"}],"oldStart":23,"oldLines":7,"newStart":23,"newLines":7},{"content":"@@ -60,6 +60,7 @@","changes":[{"type":"normal","normal":true,"ln1":60,"ln2":60,"content":" #include \"nsBrowserCompsCID.h\""},{"type":"normal","normal":true,"ln1":61,"ln2":61,"content":" #include \"nsDirectoryServiceUtils.h\""},{"type":"normal","normal":true,"ln1":62,"ln2":62,"content":" #include \"nsAppDirectoryServiceDefs.h\""},{"type":"add","add":true,"ln":63,"content":"+#include \"nsDirectoryServiceDefs.h\""},{"type":"normal","normal":true,"ln1":63,"ln2":64,"content":" #include \"nsIWindowsRegKey.h\""},{"type":"normal","normal":true,"ln1":64,"ln2":65,"content":" #include \"nsUnicharUtils.h\""},{"type":"normal","normal":true,"ln1":65,"ln2":66,"content":" "}],"oldStart":60,"oldLines":6,"newStart":60,"newLines":7},{"content":"@@ -82,63 +83,18 @@","changes":[{"type":"normal","normal":true,"ln1":82,"ln2":83,"content":" NS_IMPL_ISUPPORTS2(nsWindowsShellService, nsIWindowsShellService, nsIShellService)"},{"type":"normal","normal":true,"ln1":83,"ln2":84,"content":" "},{"type":"normal","normal":true,"ln1":84,"ln2":85,"content":" static nsresult"},{"type":"del","del":true,"ln":85,"content":"-OpenUserKeyForReading(HKEY aStartKey, const nsAString& aKeyName, HKEY* aKey)"},{"type":"add","add":true,"ln":86,"content":"+OpenKeyForReading(HKEY aKeyRoot, const nsAString& aKeyName, HKEY* aKey)"},{"type":"normal","normal":true,"ln1":86,"ln2":87,"content":" {"},{"type":"normal","normal":true,"ln1":87,"ln2":88,"content":"   const nsString &flatName = PromiseFlatString(aKeyName);"},{"type":"normal","normal":true,"ln1":88,"ln2":89,"content":" "},{"type":"del","del":true,"ln":89,"content":"-  DWORD res = ::RegOpenKeyExW(aStartKey, flatName.get(), 0, KEY_READ, aKey);"},{"type":"add","add":true,"ln":90,"content":"+  DWORD res = ::RegOpenKeyExW(aKeyRoot, flatName.get(), 0, KEY_READ, aKey);"},{"type":"normal","normal":true,"ln1":90,"ln2":91,"content":"   switch (res) {"},{"type":"normal","normal":true,"ln1":91,"ln2":92,"content":"   case ERROR_SUCCESS:"},{"type":"normal","normal":true,"ln1":92,"ln2":93,"content":"     break;"},{"type":"normal","normal":true,"ln1":93,"ln2":94,"content":"   case ERROR_ACCESS_DENIED:"},{"type":"normal","normal":true,"ln1":94,"ln2":95,"content":"     return NS_ERROR_FILE_ACCESS_DENIED;"},{"type":"normal","normal":true,"ln1":95,"ln2":96,"content":"   case ERROR_FILE_NOT_FOUND:"},{"type":"del","del":true,"ln":96,"content":"-    if (aStartKey == HKEY_LOCAL_MACHINE) {"},{"type":"del","del":true,"ln":97,"content":"-      // prevent infinite recursion on the second pass through here if "},{"type":"del","del":true,"ln":98,"content":"-      // ::RegOpenKeyEx fails in the all-users case. "},{"type":"del","del":true,"ln":99,"content":"-      return NS_ERROR_NOT_AVAILABLE;"},{"type":"del","del":true,"ln":100,"content":"-    }"},{"type":"del","del":true,"ln":101,"content":"-    return OpenUserKeyForReading(HKEY_LOCAL_MACHINE, aKeyName, aKey);"},{"type":"del","del":true,"ln":102,"content":"-  }"},{"type":"del","del":true,"ln":103,"content":"-"},{"type":"del","del":true,"ln":104,"content":"-  return NS_OK;"},{"type":"del","del":true,"ln":105,"content":"-}"},{"type":"del","del":true,"ln":106,"content":"-"},{"type":"del","del":true,"ln":107,"content":"-// Sets the default browser registry keys for Windows versions prior to Vista."},{"type":"del","del":true,"ln":108,"content":"-// Try to open / create the key in HKLM and if that fails try to do the same"},{"type":"del","del":true,"ln":109,"content":"-// in HKCU. Though this is not strictly the behavior I would expect it is the"},{"type":"del","del":true,"ln":110,"content":"-// same behavior that IE has when setting the default browser previous to Vista."},{"type":"del","del":true,"ln":111,"content":"-static nsresult"},{"type":"del","del":true,"ln":112,"content":"-OpenKeyForWriting(HKEY aStartKey, const nsAString& aKeyName, HKEY* aKey,"},{"type":"del","del":true,"ln":113,"content":"-                  PRBool aHKLMOnly)"},{"type":"del","del":true,"ln":114,"content":"-{"},{"type":"del","del":true,"ln":115,"content":"-  const nsString &flatName = PromiseFlatString(aKeyName);"},{"type":"del","del":true,"ln":116,"content":"-"},{"type":"del","del":true,"ln":117,"content":"-  DWORD dwDisp = 0;"},{"type":"del","del":true,"ln":118,"content":"-  DWORD res = ::RegCreateKeyExW(aStartKey, flatName.get(), 0, NULL,"},{"type":"del","del":true,"ln":119,"content":"-                                0, KEY_READ | KEY_WRITE, NULL, aKey,"},{"type":"del","del":true,"ln":120,"content":"-                                &dwDisp);"},{"type":"del","del":true,"ln":121,"content":"-  switch (res) {"},{"type":"del","del":true,"ln":122,"content":"-  case ERROR_SUCCESS:"},{"type":"del","del":true,"ln":123,"content":"-    break;"},{"type":"del","del":true,"ln":124,"content":"-  case ERROR_ACCESS_DENIED:"},{"type":"del","del":true,"ln":125,"content":"-    if (aHKLMOnly || aStartKey == HKEY_CURRENT_USER)"},{"type":"del","del":true,"ln":126,"content":"-      return NS_ERROR_FILE_ACCESS_DENIED;"},{"type":"del","del":true,"ln":127,"content":"-    // fallback to HKCU immediately on access denied since we won't be able"},{"type":"del","del":true,"ln":128,"content":"-    // to create the key."},{"type":"del","del":true,"ln":129,"content":"-    return OpenKeyForWriting(HKEY_CURRENT_USER, aKeyName, aKey, aHKLMOnly);"},{"type":"del","del":true,"ln":130,"content":"-  case ERROR_FILE_NOT_FOUND:"},{"type":"del","del":true,"ln":131,"content":"-    res = ::RegCreateKeyExW(aStartKey, flatName.get(), 0, NULL,"},{"type":"del","del":true,"ln":132,"content":"-                            0, KEY_READ | KEY_WRITE, NULL, aKey,"},{"type":"del","del":true,"ln":133,"content":"-                            NULL);"},{"type":"del","del":true,"ln":134,"content":"-    if (res != ERROR_SUCCESS) {"},{"type":"del","del":true,"ln":135,"content":"-      if (aHKLMOnly || aStartKey == HKEY_CURRENT_USER) {"},{"type":"del","del":true,"ln":136,"content":"-        // prevent infinite recursion on the second pass through here if "},{"type":"del","del":true,"ln":137,"content":"-        // ::RegCreateKey fails in the current user case."},{"type":"del","del":true,"ln":138,"content":"-        return NS_ERROR_FILE_ACCESS_DENIED;"},{"type":"del","del":true,"ln":139,"content":"-      }"},{"type":"del","del":true,"ln":140,"content":"-      return OpenKeyForWriting(HKEY_CURRENT_USER, aKeyName, aKey, aHKLMOnly);"},{"type":"del","del":true,"ln":141,"content":"-    }"},{"type":"add","add":true,"ln":97,"content":"+    return NS_ERROR_NOT_AVAILABLE;"},{"type":"normal","normal":true,"ln1":142,"ln2":98,"content":"   }"},{"type":"normal","normal":true,"ln1":143,"ln2":99,"content":" "},{"type":"normal","normal":true,"ln1":144,"ln2":100,"content":"   return NS_OK;"}],"oldStart":82,"oldLines":63,"newStart":83,"newLines":18},{"content":"@@ -147,6 +103,9 @@ OpenKeyForWriting(HKEY aStartKey, const nsAString& aKeyName, HKEY* aKey,","changes":[{"type":"normal","normal":true,"ln1":147,"ln2":103,"content":" ///////////////////////////////////////////////////////////////////////////////"},{"type":"normal","normal":true,"ln1":148,"ln2":104,"content":" // Default Browser Registry Settings"},{"type":"normal","normal":true,"ln1":149,"ln2":105,"content":" //"},{"type":"add","add":true,"ln":106,"content":"+// The setting of these values are made by an external binary since writing"},{"type":"add","add":true,"ln":107,"content":"+// these values may require elevation."},{"type":"add","add":true,"ln":108,"content":"+//"},{"type":"normal","normal":true,"ln1":150,"ln2":109,"content":" // - File Extension Mappings"},{"type":"normal","normal":true,"ln1":151,"ln2":110,"content":" //   -----------------------"},{"type":"normal","normal":true,"ln1":152,"ln2":111,"content":" //   The following file extensions:"}],"oldStart":147,"oldLines":6,"newStart":103,"newLines":9},{"content":"@@ -214,9 +173,6 @@ typedef enum {","changes":[{"type":"normal","normal":true,"ln1":214,"ln2":173,"content":"   NO_SUBSTITUTION           = 0x00,"},{"type":"normal","normal":true,"ln1":215,"ln2":174,"content":"   APP_PATH_SUBSTITUTION     = 0x01,"},{"type":"normal","normal":true,"ln1":216,"ln2":175,"content":"   EXE_NAME_SUBSTITUTION     = 0x02,"},{"type":"del","del":true,"ln":217,"content":"-  UNINST_PATH_SUBSTITUTION  = 0x04,"},{"type":"del","del":true,"ln":218,"content":"-  HKLM_ONLY                 = 0x08,"},{"type":"del","del":true,"ln":219,"content":"-  NON_ESSENTIAL             = 0x10"},{"type":"normal","normal":true,"ln1":220,"ln2":176,"content":" } SettingFlags;"},{"type":"normal","normal":true,"ln1":221,"ln2":177,"content":" "},{"type":"normal","normal":true,"ln1":222,"ln2":178,"content":" typedef struct {"}],"oldStart":214,"oldLines":9,"newStart":173,"newLines":6},{"content":"@@ -228,17 +184,8 @@ typedef struct {","changes":[{"type":"normal","normal":true,"ln1":228,"ln2":184,"content":" } SETTING;"},{"type":"normal","normal":true,"ln1":229,"ln2":185,"content":" "},{"type":"normal","normal":true,"ln1":230,"ln2":186,"content":" #define APP_REG_NAME L\"Firefox\""},{"type":"del","del":true,"ln":231,"content":"-#define SMI \"SOFTWARE\\\\Clients\\\\StartMenuInternet\\\\\""},{"type":"del","del":true,"ln":232,"content":"-#define CLS \"SOFTWARE\\\\Classes\\\\\""},{"type":"normal","normal":true,"ln1":233,"ln2":187,"content":" #define DI \"\\\\DefaultIcon\""},{"type":"del","del":true,"ln":234,"content":"-#define II \"\\\\InstallInfo\""},{"type":"normal","normal":true,"ln1":235,"ln2":188,"content":" #define SOP \"\\\\shell\\\\open\\\\command\""},{"type":"del","del":true,"ln":236,"content":"-#define DDE \"\\\\shell\\\\open\\\\ddeexec\\\\\""},{"type":"del","del":true,"ln":237,"content":"-#define DDE_NAME \"Firefox\" // This must be kept in sync with ID_DDE_APPLICATION_NAME as defined in splash.rc"},{"type":"del","del":true,"ln":238,"content":"-#define DDE_COMMAND \"\\\"%1\\\",,0,0,,,,\""},{"type":"del","del":true,"ln":239,"content":"-// For the InstallInfo HideIconsCommand, ShowIconsCommand, and ReinstallCommand"},{"type":"del","del":true,"ln":240,"content":"-// registry keys. This must be kept in sync with the uninstaller."},{"type":"del","del":true,"ln":241,"content":"-#define UNINSTALL_EXE \"\\\\uninstall\\\\helper.exe\""},{"type":"normal","normal":true,"ln1":242,"ln2":189,"content":" "},{"type":"normal","normal":true,"ln1":243,"ln2":190,"content":" #define CLS_HTML \"FirefoxHTML\""},{"type":"normal","normal":true,"ln1":244,"ln2":191,"content":" #define CLS_URL \"FirefoxURL\""}],"oldStart":228,"oldLines":17,"newStart":184,"newLines":8},{"content":"@@ -248,93 +195,24 @@ typedef struct {","changes":[{"type":"normal","normal":true,"ln1":248,"ln2":195,"content":" #define MAKE_KEY_NAME1(PREFIX, MID) \\"},{"type":"normal","normal":true,"ln1":249,"ln2":196,"content":"   PREFIX MID"},{"type":"normal","normal":true,"ln1":250,"ln2":197,"content":" "},{"type":"del","del":true,"ln":251,"content":"-#define MAKE_KEY_NAME2(PREFIX, MID, SUFFIX) \\"},{"type":"del","del":true,"ln":252,"content":"-  PREFIX MID SUFFIX"},{"type":"del","del":true,"ln":253,"content":"-"},{"type":"del","del":true,"ln":254,"content":"-#define MAKE_KEY_NAME3(PREFIX, MID, MID2, SUFFIX) \\"},{"type":"del","del":true,"ln":255,"content":"-  PREFIX MID MID2 SUFFIX"},{"type":"del","del":true,"ln":256,"content":"-"},{"type":"del","del":true,"ln":257,"content":"-// The DefaultIcon registry key value should never be used (e.g. NON_ESSENTIAL)"},{"type":"del","del":true,"ln":258,"content":"-// when checking if Firefox is the default browser since other applications"},{"type":"del","del":true,"ln":259,"content":"-// (e.g. MS Office) may modify the DefaultIcon registry key value to add Icon"},{"type":"del","del":true,"ln":260,"content":"-// Handlers."},{"type":"add","add":true,"ln":198,"content":"+// The DefaultIcon registry key value should never be used when checking if"},{"type":"add","add":true,"ln":199,"content":"+// Firefox is the default browser since other applications (e.g. MS Office) may"},{"type":"add","add":true,"ln":200,"content":"+// modify the DefaultIcon registry key value to add Icon Handlers."},{"type":"normal","normal":true,"ln1":261,"ln2":201,"content":" // see http://msdn2.microsoft.com/en-us/library/aa969357.aspx for more info."},{"type":"normal","normal":true,"ln1":262,"ln2":202,"content":" static SETTING gSettings[] = {"},{"type":"del","del":true,"ln":263,"content":"-  // File Extension Aliases"},{"type":"del","del":true,"ln":264,"content":"-  { MAKE_KEY_NAME1(CLS, \".htm\"),    \"\", CLS_HTML, NO_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":265,"content":"-  { MAKE_KEY_NAME1(CLS, \".html\"),   \"\", CLS_HTML, NO_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":266,"content":"-  { MAKE_KEY_NAME1(CLS, \".shtml\"),  \"\", CLS_HTML, NO_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":267,"content":"-  { MAKE_KEY_NAME1(CLS, \".xht\"),    \"\", CLS_HTML, NO_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":268,"content":"-  { MAKE_KEY_NAME1(CLS, \".xhtml\"),  \"\", CLS_HTML, NO_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":269,"content":"-"},{"type":"normal","normal":true,"ln1":270,"ln2":203,"content":"   // File Extension Class - as of 1.8.1.2 the value for VAL_OPEN is also checked"},{"type":"normal","normal":true,"ln1":271,"ln2":204,"content":"   // for CLS_HTML since Firefox should also own opeing local files when set as"},{"type":"normal","normal":true,"ln1":272,"ln2":205,"content":"   // the default browser."},{"type":"del","del":true,"ln":273,"content":"-  { MAKE_KEY_NAME2(CLS, CLS_HTML, DI),  \"\", VAL_FILE_ICON, APP_PATH_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":274,"content":"-  { MAKE_KEY_NAME2(CLS, CLS_HTML, SOP), \"\", VAL_OPEN, APP_PATH_SUBSTITUTION },"},{"type":"add","add":true,"ln":206,"content":"+  { MAKE_KEY_NAME1(CLS_HTML, SOP), \"\", VAL_OPEN, APP_PATH_SUBSTITUTION },"},{"type":"normal","normal":true,"ln1":275,"ln2":207,"content":" "},{"type":"normal","normal":true,"ln1":276,"ln2":208,"content":"   // Protocol Handler Class - for Vista and above"},{"type":"del","del":true,"ln":277,"content":"-  { MAKE_KEY_NAME2(CLS, CLS_URL, DI),  \"\", VAL_FILE_ICON, APP_PATH_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":278,"content":"-  { MAKE_KEY_NAME2(CLS, CLS_URL, SOP), \"\", VAL_OPEN, APP_PATH_SUBSTITUTION },"},{"type":"add","add":true,"ln":209,"content":"+  { MAKE_KEY_NAME1(CLS_URL, SOP), \"\", VAL_OPEN, APP_PATH_SUBSTITUTION },"},{"type":"normal","normal":true,"ln1":279,"ln2":210,"content":" "},{"type":"normal","normal":true,"ln1":280,"ln2":211,"content":"   // Protocol Handlers"},{"type":"del","del":true,"ln":281,"content":"-  { MAKE_KEY_NAME2(CLS, \"HTTP\", DI),    \"\", VAL_FILE_ICON, APP_PATH_SUBSTITUTION },"},{"type":"del","del":true,"ln":282,"content":"-  { MAKE_KEY_NAME2(CLS, \"HTTP\", SOP),   \"\", VAL_OPEN, APP_PATH_SUBSTITUTION },"},{"type":"del","del":true,"ln":283,"content":"-  { MAKE_KEY_NAME2(CLS, \"HTTPS\", DI),   \"\", VAL_FILE_ICON, APP_PATH_SUBSTITUTION },"},{"type":"del","del":true,"ln":284,"content":"-  { MAKE_KEY_NAME2(CLS, \"HTTPS\", SOP),  \"\", VAL_OPEN, APP_PATH_SUBSTITUTION },"},{"type":"del","del":true,"ln":285,"content":"-  { MAKE_KEY_NAME2(CLS, \"FTP\", DI),     \"\", VAL_FILE_ICON, APP_PATH_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":286,"content":"-  { MAKE_KEY_NAME2(CLS, \"FTP\", SOP),    \"\", VAL_OPEN, APP_PATH_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":287,"content":"-"},{"type":"del","del":true,"ln":288,"content":"-  // DDE settings"},{"type":"del","del":true,"ln":289,"content":"-  { MAKE_KEY_NAME2(CLS, CLS_HTML, DDE), \"\", DDE_COMMAND, NO_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":290,"content":"-  { MAKE_KEY_NAME3(CLS, CLS_HTML, DDE, \"Application\"), \"\", DDE_NAME, NO_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":291,"content":"-  { MAKE_KEY_NAME3(CLS, CLS_HTML, DDE, \"Topic\"), \"\", \"WWW_OpenURL\", NO_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":292,"content":"-  { MAKE_KEY_NAME2(CLS, CLS_URL, DDE), \"\", DDE_COMMAND, NO_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":293,"content":"-  { MAKE_KEY_NAME3(CLS, CLS_URL, DDE, \"Application\"), \"\", DDE_NAME, NO_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":294,"content":"-  { MAKE_KEY_NAME3(CLS, CLS_URL, DDE, \"Topic\"), \"\", \"WWW_OpenURL\", NO_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":295,"content":"-  { MAKE_KEY_NAME2(CLS, \"HTTP\", DDE), \"\", DDE_COMMAND, NO_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":296,"content":"-  { MAKE_KEY_NAME3(CLS, \"HTTP\", DDE, \"Application\"), \"\", DDE_NAME, NO_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":297,"content":"-  { MAKE_KEY_NAME3(CLS, \"HTTP\", DDE, \"Topic\"), \"\", \"WWW_OpenURL\", NO_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":298,"content":"-  { MAKE_KEY_NAME2(CLS, \"HTTPS\", DDE), \"\", DDE_COMMAND, NO_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":299,"content":"-  { MAKE_KEY_NAME3(CLS, \"HTTPS\", DDE, \"Application\"), \"\", DDE_NAME, NO_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":300,"content":"-  { MAKE_KEY_NAME3(CLS, \"HTTPS\", DDE, \"Topic\"), \"\", \"WWW_OpenURL\", NO_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":301,"content":"-  { MAKE_KEY_NAME2(CLS, \"FTP\", DDE), \"\", DDE_COMMAND, NO_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":302,"content":"-  { MAKE_KEY_NAME3(CLS, \"FTP\", DDE, \"Application\"), \"\", DDE_NAME, NO_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":303,"content":"-  { MAKE_KEY_NAME3(CLS, \"FTP\", DDE, \"Topic\"), \"\", \"WWW_OpenURL\", NO_SUBSTITUTION | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":304,"content":"-"},{"type":"del","del":true,"ln":305,"content":"-  // Windows XP Start Menu"},{"type":"del","del":true,"ln":306,"content":"-  { MAKE_KEY_NAME2(SMI, \"%APPEXE%\", DI),  "},{"type":"del","del":true,"ln":307,"content":"-    \"\", "},{"type":"del","del":true,"ln":308,"content":"-    \"%APPPATH%,0\", "},{"type":"del","del":true,"ln":309,"content":"-    APP_PATH_SUBSTITUTION | EXE_NAME_SUBSTITUTION | HKLM_ONLY | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":310,"content":"-  { MAKE_KEY_NAME2(SMI, \"%APPEXE%\", II),"},{"type":"del","del":true,"ln":311,"content":"-    \"HideIconsCommand\","},{"type":"del","del":true,"ln":312,"content":"-    \"\\\"%UNINSTPATH%\\\" /HideShortcuts\","},{"type":"del","del":true,"ln":313,"content":"-    UNINST_PATH_SUBSTITUTION | EXE_NAME_SUBSTITUTION | HKLM_ONLY | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":314,"content":"-  { MAKE_KEY_NAME2(SMI, \"%APPEXE%\", II),"},{"type":"del","del":true,"ln":315,"content":"-    \"ReinstallCommand\","},{"type":"del","del":true,"ln":316,"content":"-    \"\\\"%UNINSTPATH%\\\" /SetAsDefaultAppGlobal\","},{"type":"del","del":true,"ln":317,"content":"-    UNINST_PATH_SUBSTITUTION | EXE_NAME_SUBSTITUTION | HKLM_ONLY | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":318,"content":"-  { MAKE_KEY_NAME2(SMI, \"%APPEXE%\", II),"},{"type":"del","del":true,"ln":319,"content":"-    \"ShowIconsCommand\","},{"type":"del","del":true,"ln":320,"content":"-    \"\\\"%UNINSTPATH%\\\" /ShowShortcuts\","},{"type":"del","del":true,"ln":321,"content":"-    UNINST_PATH_SUBSTITUTION | EXE_NAME_SUBSTITUTION | HKLM_ONLY | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":322,"content":"-  { MAKE_KEY_NAME2(SMI, \"%APPEXE%\", SOP), "},{"type":"del","del":true,"ln":323,"content":"-    \"\", "},{"type":"del","del":true,"ln":324,"content":"-    \"%APPPATH%\",   "},{"type":"del","del":true,"ln":325,"content":"-    APP_PATH_SUBSTITUTION | EXE_NAME_SUBSTITUTION | HKLM_ONLY | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":326,"content":"-  { MAKE_KEY_NAME1(SMI, \"%APPEXE%\\\\shell\\\\properties\\\\command\"),"},{"type":"del","del":true,"ln":327,"content":"-    \"\", "},{"type":"del","del":true,"ln":328,"content":"-    \"\\\"%APPPATH%\\\" -preferences\","},{"type":"del","del":true,"ln":329,"content":"-    APP_PATH_SUBSTITUTION | EXE_NAME_SUBSTITUTION | HKLM_ONLY | NON_ESSENTIAL },"},{"type":"del","del":true,"ln":330,"content":"-  { MAKE_KEY_NAME1(SMI, \"%APPEXE%\\\\shell\\\\safemode\\\\command\"),"},{"type":"del","del":true,"ln":331,"content":"-    \"\", "},{"type":"del","del":true,"ln":332,"content":"-    \"\\\"%APPPATH%\\\" -safe-mode\","},{"type":"del","del":true,"ln":333,"content":"-    APP_PATH_SUBSTITUTION | EXE_NAME_SUBSTITUTION | HKLM_ONLY | NON_ESSENTIAL }"},{"type":"del","del":true,"ln":334,"content":"-"},{"type":"del","del":true,"ln":335,"content":"-  // These values must be set by hand, since they contain localized strings."},{"type":"del","del":true,"ln":336,"content":"-  //     firefox.exe\\shell\\properties        (default)   REG_SZ  Firefox &Options"},{"type":"del","del":true,"ln":337,"content":"-  //     firefox.exe\\shell\\safemode          (default)   REG_SZ  Firefox &Safe Mode"},{"type":"add","add":true,"ln":212,"content":"+  { MAKE_KEY_NAME1(\"HTTP\", DI),    \"\", VAL_FILE_ICON, APP_PATH_SUBSTITUTION },"},{"type":"add","add":true,"ln":213,"content":"+  { MAKE_KEY_NAME1(\"HTTP\", SOP),   \"\", VAL_OPEN, APP_PATH_SUBSTITUTION },"},{"type":"add","add":true,"ln":214,"content":"+  { MAKE_KEY_NAME1(\"HTTPS\", DI),   \"\", VAL_FILE_ICON, APP_PATH_SUBSTITUTION },"},{"type":"add","add":true,"ln":215,"content":"+  { MAKE_KEY_NAME1(\"HTTPS\", SOP),  \"\", VAL_OPEN, APP_PATH_SUBSTITUTION }"},{"type":"normal","normal":true,"ln1":338,"ln2":216,"content":" };"},{"type":"normal","normal":true,"ln1":339,"ln2":217,"content":" "},{"type":"normal","normal":true,"ln1":340,"ln2":218,"content":" "}],"oldStart":248,"oldLines":93,"newStart":195,"newLines":24},{"content":"@@ -411,39 +289,15 @@ nsWindowsShellService::IsDefaultBrowserVista(PRBool aStartupCheck, PRBool* aIsDe","changes":[{"type":"normal","normal":true,"ln1":411,"ln2":289,"content":"   return PR_FALSE;"},{"type":"normal","normal":true,"ln1":412,"ln2":290,"content":" }"},{"type":"normal","normal":true,"ln1":413,"ln2":291,"content":" "},{"type":"del","del":true,"ln":414,"content":"-PRBool"},{"type":"del","del":true,"ln":415,"content":"-nsWindowsShellService::SetDefaultBrowserVista()"},{"type":"del","del":true,"ln":416,"content":"-{"},{"type":"del","del":true,"ln":417,"content":"-  IApplicationAssociationRegistration* pAAR;"},{"type":"del","del":true,"ln":418,"content":"-  "},{"type":"del","del":true,"ln":419,"content":"-  HRESULT hr = CoCreateInstance(CLSID_ApplicationAssociationReg,"},{"type":"del","del":true,"ln":420,"content":"-                                NULL,"},{"type":"del","del":true,"ln":421,"content":"-                                CLSCTX_INPROC,"},{"type":"del","del":true,"ln":422,"content":"-                                IID_IApplicationAssociationReg,"},{"type":"del","del":true,"ln":423,"content":"-                                (void**)&pAAR);"},{"type":"del","del":true,"ln":424,"content":"-  "},{"type":"del","del":true,"ln":425,"content":"-  if (SUCCEEDED(hr)) {"},{"type":"del","del":true,"ln":426,"content":"-    hr = pAAR->SetAppAsDefaultAll(APP_REG_NAME);"},{"type":"del","del":true,"ln":427,"content":"-    "},{"type":"del","del":true,"ln":428,"content":"-    pAAR->Release();"},{"type":"del","del":true,"ln":429,"content":"-    return PR_TRUE;"},{"type":"del","del":true,"ln":430,"content":"-  }"},{"type":"del","del":true,"ln":431,"content":"-  "},{"type":"del","del":true,"ln":432,"content":"-  return PR_FALSE;"},{"type":"del","del":true,"ln":433,"content":"-}"},{"type":"del","del":true,"ln":434,"content":"-"},{"type":"normal","normal":true,"ln1":435,"ln2":292,"content":" NS_IMETHODIMP"},{"type":"normal","normal":true,"ln1":436,"ln2":293,"content":" nsWindowsShellService::IsDefaultBrowser(PRBool aStartupCheck,"},{"type":"normal","normal":true,"ln1":437,"ln2":294,"content":"                                         PRBool* aIsDefaultBrowser)"},{"type":"normal","normal":true,"ln1":438,"ln2":295,"content":" {"},{"type":"del","del":true,"ln":439,"content":"-  // To support side by side installs on Vista we also need to check if the"},{"type":"del","del":true,"ln":440,"content":"-  // FirefoxHTML and FirefoxURL registry keys in HKLM / HKCU point to our"},{"type":"del","del":true,"ln":441,"content":"-  // install location. If the HKLM keys point to this install location we have"},{"type":"del","del":true,"ln":442,"content":"-  // to verify that the keys don't exist in HKCU and remove them if the app is"},{"type":"del","del":true,"ln":443,"content":"-  // then set as default. If the HKLM keys don't point to this install location"},{"type":"del","del":true,"ln":444,"content":"-  // then we have to add these keys in HKCU to over-ride the HKLM keys."},{"type":"del","del":true,"ln":445,"content":"-  if (IsDefaultBrowserVista(aStartupCheck, aIsDefaultBrowser))"},{"type":"del","del":true,"ln":446,"content":"-    return NS_OK;"},{"type":"add","add":true,"ln":296,"content":"+  // If this is the first browser window, maintain internal state that we've"},{"type":"add","add":true,"ln":297,"content":"+  // checked this session (so that subsequent window opens don't show the "},{"type":"add","add":true,"ln":298,"content":"+  // default browser dialog)."},{"type":"add","add":true,"ln":299,"content":"+  if (aStartupCheck)"},{"type":"add","add":true,"ln":300,"content":"+    mCheckedThisSession = PR_TRUE;"},{"type":"normal","normal":true,"ln1":447,"ln2":301,"content":" "},{"type":"normal","normal":true,"ln1":448,"ln2":302,"content":"   SETTING* settings;"},{"type":"normal","normal":true,"ln1":449,"ln2":303,"content":"   SETTING* end = gSettings + sizeof(gSettings)/sizeof(SETTING);"}],"oldStart":411,"oldLines":39,"newStart":289,"newLines":15},{"content":"@@ -478,9 +332,6 @@ nsWindowsShellService::IsDefaultBrowser(PRBool aStartupCheck,","changes":[{"type":"normal","normal":true,"ln1":478,"ln2":332,"content":" "},{"type":"normal","normal":true,"ln1":479,"ln2":333,"content":"   PRUnichar currValue[MAX_BUF];"},{"type":"normal","normal":true,"ln1":480,"ln2":334,"content":"   for (settings = gSettings; settings < end; ++settings) {"},{"type":"del","del":true,"ln":481,"content":"-    if (settings->flags & NON_ESSENTIAL)"},{"type":"del","del":true,"ln":482,"content":"-      continue; // This is not a registry key that determines whether"},{"type":"del","del":true,"ln":483,"content":"-                // or not we consider Firefox the \"Default Browser.\""},{"type":"normal","normal":true,"ln1":484,"ln2":335,"content":"     NS_ConvertUTF8toUTF16 dataLongPath(settings->valueData);"},{"type":"normal","normal":true,"ln1":485,"ln2":336,"content":"     NS_ConvertUTF8toUTF16 dataShortPath(settings->valueData);"},{"type":"normal","normal":true,"ln1":486,"ln2":337,"content":"     NS_ConvertUTF8toUTF16 key(settings->keyName);"}],"oldStart":478,"oldLines":9,"newStart":332,"newLines":6},{"content":"@@ -502,7 +353,7 @@ nsWindowsShellService::IsDefaultBrowser(PRBool aStartupCheck,","changes":[{"type":"normal","normal":true,"ln1":502,"ln2":353,"content":" "},{"type":"normal","normal":true,"ln1":503,"ln2":354,"content":"     ::ZeroMemory(currValue, sizeof(currValue));"},{"type":"normal","normal":true,"ln1":504,"ln2":355,"content":"     HKEY theKey;"},{"type":"del","del":true,"ln":505,"content":"-    rv = OpenUserKeyForReading(HKEY_CURRENT_USER, key, &theKey);"},{"type":"add","add":true,"ln":356,"content":"+    rv = OpenKeyForReading(HKEY_CLASSES_ROOT, key, &theKey);"},{"type":"normal","normal":true,"ln1":506,"ln2":357,"content":"     if (NS_SUCCEEDED(rv)) {"},{"type":"normal","normal":true,"ln1":507,"ln2":358,"content":"       DWORD len = sizeof currValue;"},{"type":"normal","normal":true,"ln1":508,"ln2":359,"content":"       DWORD res = ::RegQueryValueExW(theKey, PromiseFlatString(value).get(),"}],"oldStart":502,"oldLines":7,"newStart":353,"newLines":7},{"content":"@@ -514,250 +365,60 @@ nsWindowsShellService::IsDefaultBrowser(PRBool aStartupCheck,","changes":[{"type":"normal","normal":true,"ln1":514,"ln2":365,"content":"           !dataShortPath.Equals(currValue, CaseInsensitiveCompare)) {"},{"type":"normal","normal":true,"ln1":515,"ln2":366,"content":"         // Key wasn't set, or was set to something else (something else became the default browser)"},{"type":"normal","normal":true,"ln1":516,"ln2":367,"content":"         *aIsDefaultBrowser = PR_FALSE;"},{"type":"del","del":true,"ln":517,"content":"-        break;"},{"type":"add","add":true,"ln":368,"content":"+        return NS_OK;"},{"type":"normal","normal":true,"ln1":518,"ln2":369,"content":"       }"},{"type":"normal","normal":true,"ln1":519,"ln2":370,"content":"     }"},{"type":"normal","normal":true,"ln1":520,"ln2":371,"content":"   }"},{"type":"normal","normal":true,"ln1":521,"ln2":372,"content":" "},{"type":"del","del":true,"ln":522,"content":"-  // If this is the first browser window, maintain internal state that we've"},{"type":"del","del":true,"ln":523,"content":"-  // checked this session (so that subsequent window opens don't show the "},{"type":"del","del":true,"ln":524,"content":"-  // default browser dialog)."},{"type":"del","del":true,"ln":525,"content":"-  if (aStartupCheck)"},{"type":"del","del":true,"ln":526,"content":"-    mCheckedThisSession = PR_TRUE;"},{"type":"add","add":true,"ln":373,"content":"+  // Only check if Firefox is the default browser on Vista if the previous"},{"type":"add","add":true,"ln":374,"content":"+  // checks show that Firefox is the default browser."},{"type":"add","add":true,"ln":375,"content":"+  if (aIsDefaultBrowser)"},{"type":"add","add":true,"ln":376,"content":"+    IsDefaultBrowserVista(aStartupCheck, aIsDefaultBrowser);"},{"type":"normal","normal":true,"ln1":527,"ln2":377,"content":" "},{"type":"normal","normal":true,"ln1":528,"ln2":378,"content":"   return NS_OK;"},{"type":"normal","normal":true,"ln1":529,"ln2":379,"content":" }"},{"type":"normal","normal":true,"ln1":530,"ln2":380,"content":" "},{"type":"del","del":true,"ln":531,"content":"-DWORD"},{"type":"del","del":true,"ln":532,"content":"-nsWindowsShellService::DeleteRegKeyDefaultValue(HKEY baseKey,"},{"type":"del","del":true,"ln":533,"content":"-                                                const nsString& keyName)"},{"type":"del","del":true,"ln":534,"content":"-{"},{"type":"del","del":true,"ln":535,"content":"-  HKEY key;"},{"type":"del","del":true,"ln":536,"content":"-  DWORD res = ::RegOpenKeyExW(baseKey, keyName.get(),"},{"type":"del","del":true,"ln":537,"content":"-                              0, KEY_WRITE, &key);"},{"type":"del","del":true,"ln":538,"content":"-  if (res == ERROR_SUCCESS) {"},{"type":"del","del":true,"ln":539,"content":"-    res = ::RegDeleteValueW(key, EmptyString().get());"},{"type":"del","del":true,"ln":540,"content":"-    ::RegCloseKey(key);"},{"type":"del","del":true,"ln":541,"content":"-  }"},{"type":"del","del":true,"ln":542,"content":"-"},{"type":"del","del":true,"ln":543,"content":"-  return res;"},{"type":"del","del":true,"ln":544,"content":"-}"},{"type":"del","del":true,"ln":545,"content":"-"},{"type":"normal","normal":true,"ln1":546,"ln2":381,"content":" NS_IMETHODIMP"},{"type":"normal","normal":true,"ln1":547,"ln2":382,"content":" nsWindowsShellService::SetDefaultBrowser(PRBool aClaimAllTypes, PRBool aForAllUsers)"},{"type":"normal","normal":true,"ln1":548,"ln2":383,"content":" {"},{"type":"del","del":true,"ln":549,"content":"-  // Delete the protocol and file handlers under HKCU if they exist. This way"},{"type":"del","del":true,"ln":550,"content":"-  // the HKCU registry is cleaned up when HKLM is writeable or if it isn't"},{"type":"del","del":true,"ln":551,"content":"-  // the values will then be added under HKCU."},{"type":"del","del":true,"ln":552,"content":"-  (void)DeleteRegKey(HKEY_CURRENT_USER,"},{"type":"del","del":true,"ln":553,"content":"-    NS_LITERAL_STRING(\"Software\\\\Classes\\\\http\\\\shell\\\\open\"));"},{"type":"del","del":true,"ln":554,"content":"-  (void)DeleteRegKey(HKEY_CURRENT_USER,"},{"type":"del","del":true,"ln":555,"content":"-    NS_LITERAL_STRING(\"Software\\\\Classes\\\\http\\\\DefaultIcon\"));"},{"type":"del","del":true,"ln":556,"content":"-  (void)DeleteRegKey(HKEY_CURRENT_USER,"},{"type":"del","del":true,"ln":557,"content":"-    NS_LITERAL_STRING(\"Software\\\\Classes\\\\https\\\\shell\\\\open\"));"},{"type":"del","del":true,"ln":558,"content":"-  (void)DeleteRegKey(HKEY_CURRENT_USER,"},{"type":"del","del":true,"ln":559,"content":"-     NS_LITERAL_STRING(\"Software\\\\Classes\\\\https\\\\DefaultIcon\"));"},{"type":"del","del":true,"ln":560,"content":"-  (void)DeleteRegKey(HKEY_CURRENT_USER,"},{"type":"del","del":true,"ln":561,"content":"-   NS_LITERAL_STRING(\"Software\\\\Classes\\\\ftp\\\\shell\\\\open\"));"},{"type":"del","del":true,"ln":562,"content":"-  (void)DeleteRegKey(HKEY_CURRENT_USER,"},{"type":"del","del":true,"ln":563,"content":"-     NS_LITERAL_STRING(\"Software\\\\Classes\\\\ftp\\\\DefaultIcon\"));"},{"type":"del","del":true,"ln":564,"content":"-  (void)DeleteRegKey(HKEY_CURRENT_USER,"},{"type":"del","del":true,"ln":565,"content":"-     NS_LITERAL_STRING(\"Software\\\\Classes\\\\FirefoxURL\"));"},{"type":"del","del":true,"ln":566,"content":"-  (void)DeleteRegKey(HKEY_CURRENT_USER,"},{"type":"del","del":true,"ln":567,"content":"-     NS_LITERAL_STRING(\"Software\\\\Classes\\\\FirefoxHTML\"));"},{"type":"del","del":true,"ln":568,"content":"-"},{"type":"del","del":true,"ln":569,"content":"-  (void)DeleteRegKeyDefaultValue(HKEY_CURRENT_USER,"},{"type":"del","del":true,"ln":570,"content":"-     NS_LITERAL_STRING(\"Software\\\\Classes\\\\.htm\"));"},{"type":"del","del":true,"ln":571,"content":"-  (void)DeleteRegKeyDefaultValue(HKEY_CURRENT_USER,"},{"type":"del","del":true,"ln":572,"content":"-     NS_LITERAL_STRING(\"Software\\\\Classes\\\\.html\"));"},{"type":"del","del":true,"ln":573,"content":"-  (void)DeleteRegKeyDefaultValue(HKEY_CURRENT_USER,"},{"type":"del","del":true,"ln":574,"content":"-     NS_LITERAL_STRING(\"Software\\\\Classes\\\\.shtml\"));"},{"type":"del","del":true,"ln":575,"content":"-  (void)DeleteRegKeyDefaultValue(HKEY_CURRENT_USER,"},{"type":"del","del":true,"ln":576,"content":"-     NS_LITERAL_STRING(\"Software\\\\Classes\\\\.xht\"));"},{"type":"del","del":true,"ln":577,"content":"-  (void)DeleteRegKeyDefaultValue(HKEY_CURRENT_USER,"},{"type":"del","del":true,"ln":578,"content":"-     NS_LITERAL_STRING(\"Software\\\\Classes\\\\.xhtml\"));"},{"type":"del","del":true,"ln":579,"content":"-"},{"type":"del","del":true,"ln":580,"content":"-  if (!aForAllUsers && SetDefaultBrowserVista())"},{"type":"del","del":true,"ln":581,"content":"-    return NS_OK;"},{"type":"del","del":true,"ln":582,"content":"-"},{"type":"del","del":true,"ln":583,"content":"-  SETTING* settings;"},{"type":"del","del":true,"ln":584,"content":"-  SETTING* end = gSettings + sizeof(gSettings)/sizeof(SETTING);"},{"type":"del","del":true,"ln":585,"content":"-"},{"type":"del","del":true,"ln":586,"content":"-  PRUnichar exePath[MAX_BUF];"},{"type":"del","del":true,"ln":587,"content":"-  if (!::GetModuleFileNameW(0, exePath, MAX_BUF))"},{"type":"del","del":true,"ln":588,"content":"-    return NS_ERROR_FAILURE;"},{"type":"del","del":true,"ln":589,"content":"-"},{"type":"del","del":true,"ln":590,"content":"-  nsAutoString appLongPath(exePath);"},{"type":"del","del":true,"ln":591,"content":"-"},{"type":"del","del":true,"ln":592,"content":"-  nsCOMPtr<nsILocalFile> lf;"},{"type":"del","del":true,"ln":593,"content":"-  nsresult rv = NS_NewLocalFile(nsDependentString(exePath), PR_TRUE,"},{"type":"del","del":true,"ln":594,"content":"-                                getter_AddRefs(lf));"},{"type":"del","del":true,"ln":595,"content":"-  if (NS_FAILED(rv))"},{"type":"del","del":true,"ln":596,"content":"-    return rv;"},{"type":"del","del":true,"ln":597,"content":"-"},{"type":"del","del":true,"ln":598,"content":"-  nsAutoString exeName;"},{"type":"del","del":true,"ln":599,"content":"-  rv = lf->GetLeafName(exeName);"},{"type":"del","del":true,"ln":600,"content":"-  if (NS_FAILED(rv))"},{"type":"del","del":true,"ln":601,"content":"-    return rv;"},{"type":"del","del":true,"ln":602,"content":"-  ToUpperCase(exeName);"},{"type":"del","del":true,"ln":603,"content":"-"},{"type":"del","del":true,"ln":604,"content":"-  nsCOMPtr<nsIFile> appDir;"},{"type":"del","del":true,"ln":605,"content":"-  rv = lf->GetParent(getter_AddRefs(appDir));"},{"type":"del","del":true,"ln":606,"content":"-  if (NS_FAILED(rv))"},{"type":"del","del":true,"ln":607,"content":"-    return rv;"},{"type":"del","del":true,"ln":608,"content":"-"},{"type":"del","del":true,"ln":609,"content":"-  nsAutoString uninstLongPath;"},{"type":"del","del":true,"ln":610,"content":"-  appDir->GetPath(uninstLongPath);"},{"type":"del","del":true,"ln":611,"content":"-  uninstLongPath.AppendLiteral(UNINSTALL_EXE);"},{"type":"del","del":true,"ln":612,"content":"-"},{"type":"del","del":true,"ln":613,"content":"-  for (settings = gSettings; settings < end; ++settings) {"},{"type":"del","del":true,"ln":614,"content":"-    NS_ConvertUTF8toUTF16 dataLongPath(settings->valueData);"},{"type":"del","del":true,"ln":615,"content":"-    NS_ConvertUTF8toUTF16 key(settings->keyName);"},{"type":"del","del":true,"ln":616,"content":"-    NS_ConvertUTF8toUTF16 value(settings->valueName);"},{"type":"del","del":true,"ln":617,"content":"-    if (settings->flags & APP_PATH_SUBSTITUTION) {"},{"type":"del","del":true,"ln":618,"content":"-      PRInt32 offset = dataLongPath.Find(\"%APPPATH%\");"},{"type":"del","del":true,"ln":619,"content":"-      dataLongPath.Replace(offset, 9, appLongPath);"},{"type":"del","del":true,"ln":620,"content":"-    }"},{"type":"del","del":true,"ln":621,"content":"-    if (settings->flags & UNINST_PATH_SUBSTITUTION) {"},{"type":"del","del":true,"ln":622,"content":"-      PRInt32 offset = dataLongPath.Find(\"%UNINSTPATH%\");"},{"type":"del","del":true,"ln":623,"content":"-      dataLongPath.Replace(offset, 12, uninstLongPath);"},{"type":"del","del":true,"ln":624,"content":"-    }"},{"type":"del","del":true,"ln":625,"content":"-    if (settings->flags & EXE_NAME_SUBSTITUTION) {"},{"type":"del","del":true,"ln":626,"content":"-      PRInt32 offset = key.Find(\"%APPEXE%\");"},{"type":"del","del":true,"ln":627,"content":"-      key.Replace(offset, 8, exeName);"},{"type":"del","del":true,"ln":628,"content":"-    }"},{"type":"del","del":true,"ln":629,"content":"-"},{"type":"del","del":true,"ln":630,"content":"-    SetRegKey(key, value, dataLongPath,"},{"type":"del","del":true,"ln":631,"content":"-              (settings->flags & HKLM_ONLY));"},{"type":"del","del":true,"ln":632,"content":"-  }"},{"type":"del","del":true,"ln":633,"content":"-"},{"type":"del","del":true,"ln":634,"content":"-  // Select the Default Browser for the Windows XP Start Menu"},{"type":"del","del":true,"ln":635,"content":"-  SetRegKey(NS_LITERAL_STRING(SMI), EmptyString(), exeName, PR_TRUE);"},{"type":"add","add":true,"ln":384,"content":"+  nsresult rv;"},{"type":"add","add":true,"ln":385,"content":"+  nsCOMPtr<nsIProperties> directoryService = "},{"type":"add","add":true,"ln":386,"content":"+    do_GetService(NS_DIRECTORY_SERVICE_CONTRACTID, &rv);"},{"type":"add","add":true,"ln":387,"content":"+  NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":636,"ln2":388,"content":" "},{"type":"del","del":true,"ln":637,"content":"-  nsCOMPtr<nsIStringBundleService>"},{"type":"del","del":true,"ln":638,"content":"-    bundleService(do_GetService(\"@mozilla.org/intl/stringbundle;1\"));"},{"type":"del","del":true,"ln":639,"content":"-  if (!bundleService)"},{"type":"del","del":true,"ln":640,"content":"-    return NS_ERROR_FAILURE;"},{"type":"add","add":true,"ln":389,"content":"+  nsCOMPtr<nsILocalFile> appHelper;"},{"type":"add","add":true,"ln":390,"content":"+  rv = directoryService->Get(NS_XPCOM_CURRENT_PROCESS_DIR, NS_GET_IID(nsILocalFile), getter_AddRefs(appHelper));"},{"type":"add","add":true,"ln":391,"content":"+  NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":641,"ln2":392,"content":" "},{"type":"del","del":true,"ln":642,"content":"-  nsCOMPtr<nsIStringBundle> bundle, brandBundle;"},{"type":"del","del":true,"ln":643,"content":"-  rv = bundleService->CreateBundle(SHELLSERVICE_PROPERTIES, getter_AddRefs(bundle));"},{"type":"add","add":true,"ln":393,"content":"+  rv = appHelper->AppendNative(NS_LITERAL_CSTRING(\"uninstall\"));"},{"type":"normal","normal":true,"ln1":644,"ln2":394,"content":"   NS_ENSURE_SUCCESS(rv, rv);"},{"type":"del","del":true,"ln":645,"content":"-  rv = bundleService->CreateBundle(BRAND_PROPERTIES, getter_AddRefs(brandBundle));"},{"type":"add","add":true,"ln":395,"content":"+"},{"type":"add","add":true,"ln":396,"content":"+  rv = appHelper->AppendNative(NS_LITERAL_CSTRING(\"helper.exe\"));"},{"type":"normal","normal":true,"ln1":646,"ln2":397,"content":"   NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":647,"ln2":398,"content":" "},{"type":"del","del":true,"ln":648,"content":"-  // Create the Start Menu item if it doesn't exist"},{"type":"del","del":true,"ln":649,"content":"-  nsString brandFullName;"},{"type":"del","del":true,"ln":650,"content":"-  brandBundle->GetStringFromName(NS_LITERAL_STRING(\"brandFullName\").get(),"},{"type":"del","del":true,"ln":651,"content":"-                                 getter_Copies(brandFullName));"},{"type":"del","del":true,"ln":652,"content":"-"},{"type":"del","del":true,"ln":653,"content":"-  nsAutoString key1(NS_LITERAL_STRING(SMI));"},{"type":"del","del":true,"ln":654,"content":"-  key1.Append(exeName);"},{"type":"del","del":true,"ln":655,"content":"-  key1.AppendLiteral(\"\\\\\");"},{"type":"del","del":true,"ln":656,"content":"-  SetRegKey(key1, EmptyString(), brandFullName, PR_TRUE);"},{"type":"del","del":true,"ln":657,"content":"-"},{"type":"del","del":true,"ln":658,"content":"-  // Set the Options and Safe Mode start menu context menu item labels"},{"type":"del","del":true,"ln":659,"content":"-  nsAutoString optionsKey(NS_LITERAL_STRING(SMI));"},{"type":"del","del":true,"ln":660,"content":"-  optionsKey.Append(exeName);"},{"type":"del","del":true,"ln":661,"content":"-  optionsKey.AppendLiteral(\"\\\\shell\\\\properties\");"},{"type":"del","del":true,"ln":662,"content":"-"},{"type":"del","del":true,"ln":663,"content":"-  nsAutoString safeModeKey(NS_LITERAL_STRING(SMI));"},{"type":"del","del":true,"ln":664,"content":"-  safeModeKey.Append(exeName);"},{"type":"del","del":true,"ln":665,"content":"-  safeModeKey.AppendLiteral(\"\\\\shell\\\\safemode\");"},{"type":"del","del":true,"ln":666,"content":"-"},{"type":"del","del":true,"ln":667,"content":"-  nsString brandShortName;"},{"type":"del","del":true,"ln":668,"content":"-  brandBundle->GetStringFromName(NS_LITERAL_STRING(\"brandShortName\").get(),"},{"type":"del","del":true,"ln":669,"content":"-                                 getter_Copies(brandShortName));"},{"type":"del","del":true,"ln":670,"content":"-"},{"type":"del","del":true,"ln":671,"content":"-  const PRUnichar* brandNameStrings[] = { brandShortName.get() };"},{"type":"del","del":true,"ln":672,"content":"-"},{"type":"del","del":true,"ln":673,"content":"-  // Set the Options menu item"},{"type":"del","del":true,"ln":674,"content":"-  nsString optionsTitle;"},{"type":"del","del":true,"ln":675,"content":"-  bundle->FormatStringFromName(NS_LITERAL_STRING(\"optionsLabel\").get(),"},{"type":"del","del":true,"ln":676,"content":"-                               brandNameStrings, 1,"},{"type":"del","del":true,"ln":677,"content":"-                               getter_Copies(optionsTitle));"},{"type":"del","del":true,"ln":678,"content":"-  // Set the Safe Mode menu item"},{"type":"del","del":true,"ln":679,"content":"-  nsString safeModeTitle;"},{"type":"del","del":true,"ln":680,"content":"-  bundle->FormatStringFromName(NS_LITERAL_STRING(\"safeModeLabel\").get(),"},{"type":"del","del":true,"ln":681,"content":"-                               brandNameStrings, 1,"},{"type":"del","del":true,"ln":682,"content":"-                               getter_Copies(safeModeTitle));"},{"type":"del","del":true,"ln":683,"content":"-"},{"type":"del","del":true,"ln":684,"content":"-  // Set the registry keys"},{"type":"del","del":true,"ln":685,"content":"-  SetRegKey(optionsKey, EmptyString(), optionsTitle, PR_TRUE);"},{"type":"del","del":true,"ln":686,"content":"-  SetRegKey(safeModeKey, EmptyString(), safeModeTitle, PR_TRUE);"},{"type":"del","del":true,"ln":687,"content":"-"},{"type":"del","del":true,"ln":688,"content":"-  // Refresh the Shell"},{"type":"del","del":true,"ln":689,"content":"-  SHChangeNotify(SHCNE_ASSOCCHANGED, SHCNF_IDLIST, 0, 0);"},{"type":"del","del":true,"ln":690,"content":"-  return NS_OK;"},{"type":"del","del":true,"ln":691,"content":"-}"},{"type":"add","add":true,"ln":399,"content":"+  nsCAutoString appHelperPath;"},{"type":"add","add":true,"ln":400,"content":"+  rv = appHelper->GetNativePath(appHelperPath);"},{"type":"add","add":true,"ln":401,"content":"+  NS_ENSURE_SUCCESS(rv, rv);"},{"type":"normal","normal":true,"ln1":692,"ln2":402,"content":" "},{"type":"del","del":true,"ln":693,"content":"-// Utility function to delete a registry subkey."},{"type":"del","del":true,"ln":694,"content":"-DWORD"},{"type":"del","del":true,"ln":695,"content":"-nsWindowsShellService::DeleteRegKey(HKEY baseKey, const nsString& keyName)"},{"type":"del","del":true,"ln":696,"content":"-{"},{"type":"del","del":true,"ln":697,"content":"-  // Make sure input subkey isn't null."},{"type":"del","del":true,"ln":698,"content":"-  if (keyName.IsEmpty())"},{"type":"del","del":true,"ln":699,"content":"-    return ERROR_BADKEY;"},{"type":"del","del":true,"ln":700,"content":"-"},{"type":"del","del":true,"ln":701,"content":"-  const nsString &flatName = PromiseFlatString(keyName);"},{"type":"del","del":true,"ln":702,"content":"-"},{"type":"del","del":true,"ln":703,"content":"-  // Open subkey."},{"type":"del","del":true,"ln":704,"content":"-  HKEY key;"},{"type":"del","del":true,"ln":705,"content":"-  DWORD res = ::RegOpenKeyExW(baseKey, flatName.get(), 0,"},{"type":"del","del":true,"ln":706,"content":"-                              KEY_ENUMERATE_SUB_KEYS | DELETE, &key);"},{"type":"del","del":true,"ln":707,"content":"-  // Continue till we get an error or are done."},{"type":"del","del":true,"ln":708,"content":"-  while (res == ERROR_SUCCESS) {"},{"type":"del","del":true,"ln":709,"content":"-    PRUnichar subkeyName[MAX_PATH];"},{"type":"del","del":true,"ln":710,"content":"-    DWORD len = sizeof subkeyName;"},{"type":"del","del":true,"ln":711,"content":"-    // Get first subkey name.  Note that we always get the"},{"type":"del","del":true,"ln":712,"content":"-    // first one, then delete it.  So we need to get"},{"type":"del","del":true,"ln":713,"content":"-    // the first one next time, also."},{"type":"del","del":true,"ln":714,"content":"-    res = ::RegEnumKeyExW(key, 0, subkeyName, &len, NULL, NULL,"},{"type":"del","del":true,"ln":715,"content":"-                          NULL, NULL);"},{"type":"del","del":true,"ln":716,"content":"-    if (res == ERROR_NO_MORE_ITEMS) {"},{"type":"del","del":true,"ln":717,"content":"-      // No more subkeys.  Delete the main one."},{"type":"del","del":true,"ln":718,"content":"-      res = ::RegDeleteKeyW(baseKey, flatName.get());"},{"type":"del","del":true,"ln":719,"content":"-      break;"},{"type":"del","del":true,"ln":720,"content":"-    }"},{"type":"del","del":true,"ln":721,"content":"-    // If we find another subkey, delete it, recursively."},{"type":"del","del":true,"ln":722,"content":"-    if (res == ERROR_SUCCESS)"},{"type":"del","del":true,"ln":723,"content":"-      res = DeleteRegKey(key, nsDependentString(subkeyName));"},{"type":"add","add":true,"ln":403,"content":"+  if (aForAllUsers) {"},{"type":"add","add":true,"ln":404,"content":"+    appHelperPath.AppendLiteral(\" /SetAsDefaultAppGlobal\");"},{"type":"add","add":true,"ln":405,"content":"+  } else {"},{"type":"add","add":true,"ln":406,"content":"+    appHelperPath.AppendLiteral(\" /SetAsDefaultAppUser\");"},{"type":"normal","normal":true,"ln1":724,"ln2":407,"content":"   }"},{"type":"del","del":true,"ln":725,"content":"-  "},{"type":"del","del":true,"ln":726,"content":"-  // Close the key we opened."},{"type":"del","del":true,"ln":727,"content":"-  ::RegCloseKey(key);"},{"type":"del","del":true,"ln":728,"content":"-  return res;"},{"type":"del","del":true,"ln":729,"content":"-}"},{"type":"normal","normal":true,"ln1":730,"ln2":408,"content":" "},{"type":"del","del":true,"ln":731,"content":"-void"},{"type":"del","del":true,"ln":732,"content":"-nsWindowsShellService::SetRegKey(const nsString& aKeyName,"},{"type":"del","del":true,"ln":733,"content":"-                                 const nsString& aValueName,"},{"type":"del","del":true,"ln":734,"content":"-                                 const nsString& aValue, PRBool aHKLMOnly)"},{"type":"del","del":true,"ln":735,"content":"-{"},{"type":"del","del":true,"ln":736,"content":"-  PRUnichar buf[MAX_BUF];"},{"type":"del","del":true,"ln":737,"content":"-  DWORD len = sizeof buf;"},{"type":"add","add":true,"ln":409,"content":"+  STARTUPINFO si = {sizeof(si), 0};"},{"type":"add","add":true,"ln":410,"content":"+  PROCESS_INFORMATION pi = {0};"},{"type":"normal","normal":true,"ln1":738,"ln2":411,"content":" "},{"type":"del","del":true,"ln":739,"content":"-  HKEY theKey;"},{"type":"del","del":true,"ln":740,"content":"-  nsresult rv = OpenKeyForWriting(HKEY_LOCAL_MACHINE, aKeyName, &theKey,"},{"type":"del","del":true,"ln":741,"content":"-                                  aHKLMOnly);"},{"type":"del","del":true,"ln":742,"content":"-  if (NS_FAILED(rv))"},{"type":"del","del":true,"ln":743,"content":"-    return;"},{"type":"del","del":true,"ln":744,"content":"-"},{"type":"del","del":true,"ln":745,"content":"-  // Get the old value"},{"type":"del","del":true,"ln":746,"content":"-  DWORD res = ::RegQueryValueExW(theKey, PromiseFlatString(aValueName).get(),"},{"type":"del","del":true,"ln":747,"content":"-                                 NULL, NULL, (LPBYTE)buf, &len);"},{"type":"add","add":true,"ln":412,"content":"+  BOOL ok = CreateProcess(NULL, (LPSTR)appHelperPath.get(), NULL, NULL,"},{"type":"add","add":true,"ln":413,"content":"+                          FALSE, 0, NULL, NULL, &si, &pi);"},{"type":"normal","normal":true,"ln1":748,"ln2":414,"content":" "},{"type":"del","del":true,"ln":749,"content":"-  // Set the new value"},{"type":"del","del":true,"ln":750,"content":"-  nsAutoString current(buf);"},{"type":"del","del":true,"ln":751,"content":"-  if (REG_FAILED(res) || !current.Equals(aValue)) {"},{"type":"del","del":true,"ln":752,"content":"-    const nsString &flatValue = PromiseFlatString(aValue);"},{"type":"add","add":true,"ln":415,"content":"+  if (!ok)"},{"type":"add","add":true,"ln":416,"content":"+    return NS_ERROR_FAILURE;"},{"type":"normal","normal":true,"ln1":753,"ln2":417,"content":" "},{"type":"del","del":true,"ln":754,"content":"-    ::RegSetValueExW(theKey, PromiseFlatString(aValueName).get(),"},{"type":"del","del":true,"ln":755,"content":"-                     0, REG_SZ, (const BYTE *)flatValue.get(),"},{"type":"del","del":true,"ln":756,"content":"-                     (flatValue.Length() + 1) * sizeof(PRUnichar));"},{"type":"del","del":true,"ln":757,"content":"-  }"},{"type":"add","add":true,"ln":418,"content":"+  CloseHandle(pi.hProcess);"},{"type":"add","add":true,"ln":419,"content":"+  CloseHandle(pi.hThread);"},{"type":"normal","normal":true,"ln1":758,"ln2":420,"content":" "},{"type":"del","del":true,"ln":759,"content":"-  // Close the key we opened."},{"type":"del","del":true,"ln":760,"content":"-  ::RegCloseKey(theKey);"},{"type":"add","add":true,"ln":421,"content":"+  return NS_OK;"},{"type":"normal","normal":true,"ln1":761,"ln2":422,"content":" }"},{"type":"normal","normal":true,"ln1":762,"ln2":423,"content":" "},{"type":"normal","normal":true,"ln1":763,"ln2":424,"content":" NS_IMETHODIMP"}],"oldStart":514,"oldLines":250,"newStart":365,"newLines":60},{"content":"@@ -1007,13 +668,10 @@ nsWindowsShellService::OpenApplication(PRInt32 aApplication)","changes":[{"type":"normal","normal":true,"ln1":1007,"ln2":668,"content":"   //             \\Client Subkey Name\\shell\\open\\command\\ "},{"type":"normal","normal":true,"ln1":1008,"ln2":669,"content":"   //             \\Client Subkey Name\\shell\\open\\command\\(default) = path to exe"},{"type":"normal","normal":true,"ln1":1009,"ln2":670,"content":"   //"},{"type":"del","del":true,"ln":1010,"content":"-  nsAutoString clientKey;"},{"type":"del","del":true,"ln":1011,"content":"-  clientKey.AssignLiteral(\"SOFTWARE\\\\Clients\\\\\");"},{"type":"del","del":true,"ln":1012,"content":"-  clientKey.Append(application);"},{"type":"normal","normal":true,"ln1":1013,"ln2":671,"content":" "},{"type":"normal","normal":true,"ln1":1014,"ln2":672,"content":"   // Find the default application for this class."},{"type":"normal","normal":true,"ln1":1015,"ln2":673,"content":"   HKEY theKey;"},{"type":"del","del":true,"ln":1016,"content":"-  nsresult rv = OpenUserKeyForReading(HKEY_CURRENT_USER, clientKey, &theKey);"},{"type":"add","add":true,"ln":674,"content":"+  nsresult rv = OpenKeyForReading(HKEY_CLASSES_ROOT, application, &theKey);"},{"type":"normal","normal":true,"ln1":1017,"ln2":675,"content":"   if (NS_FAILED(rv))"},{"type":"normal","normal":true,"ln1":1018,"ln2":676,"content":"     return rv;"},{"type":"normal","normal":true,"ln1":1019,"ln2":677,"content":" "}],"oldStart":1007,"oldLines":13,"newStart":668,"newLines":10},{"content":"@@ -1029,11 +687,11 @@ nsWindowsShellService::OpenApplication(PRInt32 aApplication)","changes":[{"type":"normal","normal":true,"ln1":1029,"ln2":687,"content":"   ::RegCloseKey(theKey);"},{"type":"normal","normal":true,"ln1":1030,"ln2":688,"content":" "},{"type":"normal","normal":true,"ln1":1031,"ln2":689,"content":"   // Find the \"open\" command"},{"type":"del","del":true,"ln":1032,"content":"-  clientKey.AppendLiteral(\"\\\\\");"},{"type":"del","del":true,"ln":1033,"content":"-  clientKey.Append(buf);"},{"type":"del","del":true,"ln":1034,"content":"-  clientKey.AppendLiteral(\"\\\\shell\\\\open\\\\command\");"},{"type":"add","add":true,"ln":690,"content":"+  application.AppendLiteral(\"\\\\\");"},{"type":"add","add":true,"ln":691,"content":"+  application.Append(buf);"},{"type":"add","add":true,"ln":692,"content":"+  application.AppendLiteral(\"\\\\shell\\\\open\\\\command\");"},{"type":"normal","normal":true,"ln1":1035,"ln2":693,"content":" "},{"type":"del","del":true,"ln":1036,"content":"-  rv = OpenUserKeyForReading(HKEY_CURRENT_USER, clientKey, &theKey);"},{"type":"add","add":true,"ln":694,"content":"+  rv = OpenKeyForReading(HKEY_CLASSES_ROOT, application, &theKey);"},{"type":"normal","normal":true,"ln1":1037,"ln2":695,"content":"   if (NS_FAILED(rv))"},{"type":"normal","normal":true,"ln1":1038,"ln2":696,"content":"     return rv;"},{"type":"normal","normal":true,"ln1":1039,"ln2":697,"content":" "}],"oldStart":1029,"oldLines":11,"newStart":687,"newLines":11}],"deletions":401,"additions":59,"from":"browser/components/shell/src/nsWindowsShellService.cpp","to":"browser/components/shell/src/nsWindowsShellService.cpp","index":["c4b6c95..c7cd9fd","100644"]},{"chunks":[{"content":"@@ -35,7 +35,9 @@","changes":[{"type":"normal","normal":true,"ln1":35,"ln2":35,"content":" # ***** END LICENSE BLOCK *****"},{"type":"normal","normal":true,"ln1":36,"ln2":36,"content":" "},{"type":"normal","normal":true,"ln1":37,"ln2":37,"content":" # Required Plugins:"},{"type":"del","del":true,"ln":38,"content":"-# ShellLink    http://nsis.sourceforge.net/ShellLink_plug-in"},{"type":"add","add":true,"ln":38,"content":"+# SetVistaDefaultApp http://nsis.sourceforge.net/SetVistaDefaultApp_plug-in"},{"type":"add","add":true,"ln":39,"content":"+# ShellLink          http://nsis.sourceforge.net/ShellLink_plug-in"},{"type":"add","add":true,"ln":40,"content":"+# UAC                http://nsis.sourceforge.net/UAC_plug-in"},{"type":"normal","normal":true,"ln1":39,"ln2":41,"content":" "},{"type":"normal","normal":true,"ln1":40,"ln2":42,"content":" ; Set verbosity to 3 (e.g. no script) to lessen the noise in the build logs"},{"type":"normal","normal":true,"ln1":41,"ln2":43,"content":" !verbose 3"}],"oldStart":35,"oldLines":7,"newStart":35,"newLines":9},{"content":"@@ -54,6 +56,9 @@ CRCCheck on","changes":[{"type":"normal","normal":true,"ln1":54,"ln2":56,"content":" !system 'echo ; > shortcuts.ini'"},{"type":"normal","normal":true,"ln1":55,"ln2":57,"content":" !system 'echo ; > summary.ini'"},{"type":"normal","normal":true,"ln1":56,"ln2":58,"content":" "},{"type":"add","add":true,"ln":59,"content":"+; USE_UAC_PLUGIN is temporary until Thunderbird has been updated to use the UAC plugin"},{"type":"add","add":true,"ln":60,"content":"+!define USE_UAC_PLUGIN"},{"type":"add","add":true,"ln":61,"content":"+"},{"type":"normal","normal":true,"ln1":57,"ln2":62,"content":" Var TmpVal"},{"type":"normal","normal":true,"ln1":58,"ln2":63,"content":" Var StartMenuDir"},{"type":"normal","normal":true,"ln1":59,"ln2":64,"content":" Var InstallType"}],"oldStart":54,"oldLines":6,"newStart":56,"newLines":9},{"content":"@@ -75,16 +80,17 @@ Var AddDesktopSC","changes":[{"type":"normal","normal":true,"ln1":75,"ln2":80,"content":" ; available."},{"type":"normal","normal":true,"ln1":76,"ln2":81,"content":" !include /NONFATAL WinVer.nsh"},{"type":"normal","normal":true,"ln1":77,"ln2":82,"content":" !ifdef ___WINVER__NSH___"},{"type":"del","del":true,"ln":78,"content":"-  RequestExecutionLevel admin"},{"type":"add","add":true,"ln":83,"content":"+  RequestExecutionLevel user"},{"type":"normal","normal":true,"ln1":79,"ln2":84,"content":" !else"},{"type":"normal","normal":true,"ln1":80,"ln2":85,"content":"   !warning \"Installer will be created without Vista compatibility.$\\n            \\"},{"type":"normal","normal":true,"ln1":81,"ln2":86,"content":"             Upgrade your NSIS installation to at least version 2.22 to resolve.\""},{"type":"normal","normal":true,"ln1":82,"ln2":87,"content":" !endif"},{"type":"normal","normal":true,"ln1":83,"ln2":88,"content":" "},{"type":"add","add":true,"ln":89,"content":"+!insertmacro GetOptions"},{"type":"add","add":true,"ln":90,"content":"+!insertmacro GetParameters"},{"type":"add","add":true,"ln":91,"content":"+!insertmacro GetSize"},{"type":"normal","normal":true,"ln1":84,"ln2":92,"content":" !insertmacro StrFilter"},{"type":"del","del":true,"ln":85,"content":"-!insertmacro WordFind"},{"type":"normal","normal":true,"ln1":86,"ln2":93,"content":" !insertmacro WordReplace"},{"type":"del","del":true,"ln":87,"content":"-!insertmacro GetSize"},{"type":"normal","normal":true,"ln1":88,"ln2":94,"content":" "},{"type":"normal","normal":true,"ln1":89,"ln2":95,"content":" ; NSIS provided macros that we have overridden"},{"type":"normal","normal":true,"ln1":90,"ln2":96,"content":" !include overrides.nsh"}],"oldStart":75,"oldLines":16,"newStart":80,"newLines":17},{"content":"@@ -103,10 +109,13 @@ VIAddVersionKey \"FileDescription\" \"${BrandShortName} Installer\"","changes":[{"type":"normal","normal":true,"ln1":103,"ln2":109,"content":" ; Must be inserted before other macros that use logging"},{"type":"normal","normal":true,"ln1":104,"ln2":110,"content":" !insertmacro _LoggingCommon"},{"type":"normal","normal":true,"ln1":105,"ln2":111,"content":" "},{"type":"del","del":true,"ln":106,"content":"-!insertmacro AddHandlerValues"},{"type":"add","add":true,"ln":112,"content":"+!insertmacro AddDDEHandlerValues"},{"type":"normal","normal":true,"ln1":107,"ln2":113,"content":" !insertmacro CloseApp"},{"type":"normal","normal":true,"ln1":108,"ln2":114,"content":" !insertmacro CreateRegKey"},{"type":"add","add":true,"ln":115,"content":"+!insertmacro GetPathFromString"},{"type":"add","add":true,"ln":116,"content":"+!insertmacro IsHandlerForInstallDir"},{"type":"normal","normal":true,"ln1":109,"ln2":117,"content":" !insertmacro ManualCloseAppPrompt"},{"type":"add","add":true,"ln":118,"content":"+!insertmacro RegCleanAppHandler"},{"type":"normal","normal":true,"ln1":110,"ln2":119,"content":" !insertmacro RegCleanMain"},{"type":"normal","normal":true,"ln1":111,"ln2":120,"content":" !insertmacro RegCleanUninstall"},{"type":"normal","normal":true,"ln1":112,"ln2":121,"content":" !insertmacro WriteRegStr2"}],"oldStart":103,"oldLines":10,"newStart":109,"newLines":13},{"content":"@@ -365,29 +374,25 @@ Section \"-Application\" APP_IDX","changes":[{"type":"normal","normal":true,"ln1":365,"ln2":374,"content":"     StrCpy $AddDesktopSC \"1\""},{"type":"normal","normal":true,"ln1":366,"ln2":375,"content":"   ${EndIf}"},{"type":"normal","normal":true,"ln1":367,"ln2":376,"content":" "},{"type":"del","del":true,"ln":368,"content":"-  ; Remove registry entries for non-existent apps and for apps that point to our"},{"type":"del","del":true,"ln":369,"content":"-  ; install location in the Software\\Mozilla key and uninstall registry entries"},{"type":"del","del":true,"ln":370,"content":"-  ; that point to our install location for both HKCU and HKLM."},{"type":"add","add":true,"ln":377,"content":"+  ${LogHeader} \"Adding Registry Entries\""},{"type":"normal","normal":true,"ln1":371,"ln2":378,"content":"   SetShellVarContext current  ; Set SHCTX to HKCU"},{"type":"normal","normal":true,"ln1":372,"ln2":379,"content":"   ${RegCleanMain} \"Software\\Mozilla\""},{"type":"normal","normal":true,"ln1":373,"ln2":380,"content":"   ${RegCleanUninstall}"},{"type":"normal","normal":true,"ln1":374,"ln2":381,"content":" "},{"type":"del","del":true,"ln":375,"content":"-  SetShellVarContext all  ; Set SHCTX to HKLM"},{"type":"del","del":true,"ln":376,"content":"-  ${RegCleanMain} \"Software\\Mozilla\""},{"type":"del","del":true,"ln":377,"content":"-  ${RegCleanUninstall}"},{"type":"del","del":true,"ln":378,"content":"-"},{"type":"del","del":true,"ln":379,"content":"-  ${LogHeader} \"Adding Registry Entries\""},{"type":"normal","normal":true,"ln1":380,"ln2":382,"content":"   ClearErrors"},{"type":"normal","normal":true,"ln1":381,"ln2":383,"content":"   WriteRegStr HKLM \"Software\\Mozilla\\InstallerTest\" \"InstallerTest\" \"Test\""},{"type":"normal","normal":true,"ln1":382,"ln2":384,"content":"   ${If} ${Errors}"},{"type":"del","del":true,"ln":383,"content":"-    SetShellVarContext current  ; Set SHCTX to HKCU"},{"type":"normal","normal":true,"ln1":384,"ln2":385,"content":"     StrCpy $TmpVal \"HKCU\" ; used primarily for logging"},{"type":"normal","normal":true,"ln1":385,"ln2":386,"content":"   ${Else}"},{"type":"normal","normal":true,"ln1":386,"ln2":387,"content":"     SetShellVarContext all  ; Set SHCTX to HKLM"},{"type":"normal","normal":true,"ln1":387,"ln2":388,"content":"     DeleteRegKey HKLM \"Software\\Mozilla\\InstallerTest\""},{"type":"normal","normal":true,"ln1":388,"ln2":389,"content":"     StrCpy $TmpVal \"HKLM\" ; used primarily for logging"},{"type":"add","add":true,"ln":390,"content":"+    ${RegCleanMain} \"Software\\Mozilla\""},{"type":"add","add":true,"ln":391,"content":"+    ${RegCleanUninstall}"},{"type":"normal","normal":true,"ln1":389,"ln2":392,"content":"   ${EndIf}"},{"type":"normal","normal":true,"ln1":390,"ln2":393,"content":" "},{"type":"add","add":true,"ln":394,"content":"+  ${RemoveDeprecatedKeys}"},{"type":"add","add":true,"ln":395,"content":"+"},{"type":"normal","normal":true,"ln1":391,"ln2":396,"content":"   ; The previous installer adds several regsitry values to both HKLM and HKCU."},{"type":"normal","normal":true,"ln1":392,"ln2":397,"content":"   ; We now try to add to HKLM and if that fails to HKCU"},{"type":"normal","normal":true,"ln1":393,"ln2":398,"content":" "}],"oldStart":365,"oldLines":29,"newStart":374,"newLines":25},{"content":"@@ -404,6 +409,18 @@ Section \"-Application\" APP_IDX","changes":[{"type":"normal","normal":true,"ln1":404,"ln2":409,"content":"   ${WriteRegDWORD2} $TmpVal \"$0\" \"Create Start Menu Shortcut\" $AddStartMenuSC 0"},{"type":"normal","normal":true,"ln1":405,"ln2":410,"content":" "},{"type":"normal","normal":true,"ln1":406,"ln2":411,"content":"   ${FixClassKeys}"},{"type":"add","add":true,"ln":412,"content":"+  ${UpdateProtocolHandlers}"},{"type":"add","add":true,"ln":413,"content":"+"},{"type":"add","add":true,"ln":414,"content":"+  ; On install always add the FirefoxHTML and FirefoxURL keys."},{"type":"add","add":true,"ln":415,"content":"+  ; An empty string is used for the 5th param because FirefoxHTML is not a"},{"type":"add","add":true,"ln":416,"content":"+  ; protocol handler."},{"type":"add","add":true,"ln":417,"content":"+  ${AddDDEHandlerValues} \"FirefoxHTML\" \"$2\" \"$8,1\" \"${AppRegName} Document\" \"\" \\"},{"type":"add","add":true,"ln":418,"content":"+                         \"${DDEApplication}\" \"$3\" \"WWW_OpenURL\""},{"type":"add","add":true,"ln":419,"content":"+"},{"type":"add","add":true,"ln":420,"content":"+  ${AddDDEHandlerValues} \"FirefoxURL\" \"$2\" \"$8,1\" \"${AppRegName} URL\" \"true\" \\"},{"type":"add","add":true,"ln":421,"content":"+                         \"${DDEApplication}\" \"$3\" \"WWW_OpenURL\""},{"type":"add","add":true,"ln":422,"content":"+"},{"type":"add","add":true,"ln":423,"content":"+  ${FixShellIconHandler}"},{"type":"normal","normal":true,"ln1":407,"ln2":424,"content":" "},{"type":"normal","normal":true,"ln1":408,"ln2":425,"content":"   ; The following keys should only be set if we can write to HKLM"},{"type":"normal","normal":true,"ln1":409,"ln2":426,"content":"   ${If} $TmpVal == \"HKLM\""}],"oldStart":404,"oldLines":6,"newStart":409,"newLines":18},{"content":"@@ -415,10 +432,10 @@ Section \"-Application\" APP_IDX","changes":[{"type":"normal","normal":true,"ln1":415,"ln2":432,"content":" "},{"type":"normal","normal":true,"ln1":416,"ln2":433,"content":"     ; If we are writing to HKLM and create the quick launch and the desktop"},{"type":"normal","normal":true,"ln1":417,"ln2":434,"content":"     ; shortcuts set IconsVisible to 1 otherwise to 0."},{"type":"add","add":true,"ln":435,"content":"+    ${StrFilter} \"${FileMainEXE}\" \"+\" \"\" \"\" $R9"},{"type":"add","add":true,"ln":436,"content":"+    StrCpy $0 \"Software\\Clients\\StartMenuInternet\\$R9\\InstallInfo\""},{"type":"normal","normal":true,"ln1":418,"ln2":437,"content":"     ${If} $AddQuickLaunchSC == 1"},{"type":"normal","normal":true,"ln1":419,"ln2":438,"content":"     ${OrIf} $AddDesktopSC == 1"},{"type":"del","del":true,"ln":420,"content":"-      ${StrFilter} \"${FileMainEXE}\" \"+\" \"\" \"\" $R9"},{"type":"del","del":true,"ln":421,"content":"-      StrCpy $0 \"Software\\Clients\\StartMenuInternet\\$R9\\InstallInfo\""},{"type":"normal","normal":true,"ln1":422,"ln2":439,"content":"       WriteRegDWORD HKLM \"$0\" \"IconsVisible\" 1"},{"type":"normal","normal":true,"ln1":423,"ln2":440,"content":"     ${Else}"},{"type":"normal","normal":true,"ln1":424,"ln2":441,"content":"       WriteRegDWORD HKLM \"$0\" \"IconsVisible\" 0"}],"oldStart":415,"oldLines":10,"newStart":432,"newLines":10},{"content":"@@ -595,10 +612,32 @@ Function CopyFile","changes":[{"type":"normal","normal":true,"ln1":595,"ln2":612,"content":" FunctionEnd"},{"type":"normal","normal":true,"ln1":596,"ln2":613,"content":" "},{"type":"normal","normal":true,"ln1":597,"ln2":614,"content":" Function LaunchApp"},{"type":"add","add":true,"ln":615,"content":"+  ${GetParameters} $0"},{"type":"add","add":true,"ln":616,"content":"+  ${If} $0 != \"\""},{"type":"add","add":true,"ln":617,"content":"+    ClearErrors"},{"type":"add","add":true,"ln":618,"content":"+    ${GetOptions} \"$0\" \"/UAC:\" $1"},{"type":"add","add":true,"ln":619,"content":"+    ${Unless} ${Errors}"},{"type":"add","add":true,"ln":620,"content":"+      GetFunctionAddress $0 LaunchAppFromElevatedProcess"},{"type":"add","add":true,"ln":621,"content":"+      UAC::ExecCodeSegment $0"},{"type":"add","add":true,"ln":622,"content":"+      Quit"},{"type":"add","add":true,"ln":623,"content":"+    ${EndUnless}"},{"type":"add","add":true,"ln":624,"content":"+  ${EndIf}"},{"type":"add","add":true,"ln":625,"content":"+"},{"type":"normal","normal":true,"ln1":598,"ln2":626,"content":"   ${ManualCloseAppPrompt} \"${WindowClass}\" \"$(WARN_MANUALLY_CLOSE_APP_LAUNCH)\""},{"type":"normal","normal":true,"ln1":599,"ln2":627,"content":"   Exec \"$INSTDIR\\${FileMainEXE}\""},{"type":"normal","normal":true,"ln1":600,"ln2":628,"content":" FunctionEnd"},{"type":"normal","normal":true,"ln1":601,"ln2":629,"content":" "},{"type":"add","add":true,"ln":630,"content":"+Function LaunchAppFromElevatedProcess"},{"type":"add","add":true,"ln":631,"content":"+  ${ManualCloseAppPrompt} \"${WindowClass}\" \"$(WARN_MANUALLY_CLOSE_APP_LAUNCH)\""},{"type":"add","add":true,"ln":632,"content":"+"},{"type":"add","add":true,"ln":633,"content":"+  ; Find the installation directory when launching using GetFunctionAddress"},{"type":"add","add":true,"ln":634,"content":"+  ; from an elevated installer since $INSTDIR will not be set in this installer"},{"type":"add","add":true,"ln":635,"content":"+  ${StrFilter} \"${FileMainEXE}\" \"+\" \"\" \"\" $R9"},{"type":"add","add":true,"ln":636,"content":"+  ReadRegStr $0 HKLM \"Software\\Clients\\StartMenuInternet\\$R9\\DefaultIcon\" \"\""},{"type":"add","add":true,"ln":637,"content":"+  ${GetPathFromString} \"$0\" $0"},{"type":"add","add":true,"ln":638,"content":"+  Exec \"$0\""},{"type":"add","add":true,"ln":639,"content":"+FunctionEnd"},{"type":"add","add":true,"ln":640,"content":"+"},{"type":"normal","normal":true,"ln1":602,"ln2":641,"content":" ################################################################################"},{"type":"normal","normal":true,"ln1":603,"ln2":642,"content":" # Language"},{"type":"normal","normal":true,"ln1":604,"ln2":643,"content":" "}],"oldStart":595,"oldLines":10,"newStart":612,"newLines":32},{"content":"@@ -746,3 +785,11 @@ Function .onInit","changes":[{"type":"normal","normal":true,"ln1":746,"ln2":785,"content":"     SectionSetText ${DOMI_IDX} \"\""},{"type":"normal","normal":true,"ln1":747,"ln2":786,"content":"   ${EndIf}"},{"type":"normal","normal":true,"ln1":748,"ln2":787,"content":" FunctionEnd"},{"type":"add","add":true,"ln":788,"content":"+"},{"type":"add","add":true,"ln":789,"content":"+Function .OnInstFailed"},{"type":"add","add":true,"ln":790,"content":"+  UAC::Unload"},{"type":"add","add":true,"ln":791,"content":"+FunctionEnd"},{"type":"add","add":true,"ln":792,"content":"+"},{"type":"add","add":true,"ln":793,"content":"+Function .OnInstSuccess"},{"type":"add","add":true,"ln":794,"content":"+  UAC::Unload"},{"type":"add","add":true,"ln":795,"content":"+FunctionEnd"}],"oldStart":746,"oldLines":3,"newStart":785,"newLines":11}],"deletions":16,"additions":63,"from":"browser/installer/windows/nsis/installer.nsi","to":"browser/installer/windows/nsis/installer.nsi","index":["c175bfd..00bcf09","100755"]},{"chunks":[{"content":"@@ -35,26 +35,34 @@","changes":[{"type":"normal","normal":true,"ln1":35,"ln2":35,"content":" # ***** END LICENSE BLOCK *****"},{"type":"normal","normal":true,"ln1":36,"ln2":36,"content":" "},{"type":"normal","normal":true,"ln1":37,"ln2":37,"content":" !macro PostUpdate"},{"type":"del","del":true,"ln":38,"content":"-  SetShellVarContext all"},{"type":"del","del":true,"ln":39,"content":"-  ${SetStartMenuInternet}"},{"type":"del","del":true,"ln":40,"content":"-"},{"type":"normal","normal":true,"ln1":41,"ln2":38,"content":"   ; Remove registry entries for non-existent apps and for apps that point to our"},{"type":"normal","normal":true,"ln1":42,"ln2":39,"content":"   ; install location in the Software\\Mozilla key and uninstall registry entries"},{"type":"normal","normal":true,"ln1":43,"ln2":40,"content":"   ; that point to our install location for both HKCU and HKLM."},{"type":"del","del":true,"ln":44,"content":"-  SetShellVarContext current  ; Set SHCTX to HKCU"},{"type":"add","add":true,"ln":41,"content":"+  SetShellVarContext current  ; Set SHCTX to the current user (e.g. HKCU)"},{"type":"normal","normal":true,"ln1":45,"ln2":42,"content":"   ${RegCleanMain} \"Software\\Mozilla\""},{"type":"normal","normal":true,"ln1":46,"ln2":43,"content":"   ${RegCleanUninstall}"},{"type":"normal","normal":true,"ln1":47,"ln2":44,"content":" "},{"type":"del","del":true,"ln":48,"content":"-  SetShellVarContext all  ; Set SHCTX to HKLM"},{"type":"del","del":true,"ln":49,"content":"-  ${RegCleanMain} \"Software\\Mozilla\""},{"type":"del","del":true,"ln":50,"content":"-  ${RegCleanUninstall}"},{"type":"add","add":true,"ln":45,"content":"+  ClearErrors"},{"type":"add","add":true,"ln":46,"content":"+  WriteRegStr HKLM \"Software\\Mozilla\\InstallerTest\" \"InstallerTest\" \"Test\""},{"type":"add","add":true,"ln":47,"content":"+  ${If} ${Errors}"},{"type":"add","add":true,"ln":48,"content":"+    StrCpy $TmpVal \"HKCU\" ; used primarily for logging"},{"type":"add","add":true,"ln":49,"content":"+  ${Else}"},{"type":"add","add":true,"ln":50,"content":"+    SetShellVarContext all    ; Set SHCTX to all users (e.g. HKLM)"},{"type":"add","add":true,"ln":51,"content":"+    DeleteRegKey HKLM \"Software\\Mozilla\\InstallerTest\""},{"type":"add","add":true,"ln":52,"content":"+    StrCpy $TmpVal \"HKLM\" ; used primarily for logging"},{"type":"add","add":true,"ln":53,"content":"+    ${RegCleanMain} \"Software\\Mozilla\""},{"type":"add","add":true,"ln":54,"content":"+    ${RegCleanUninstall}"},{"type":"add","add":true,"ln":55,"content":"+    ${SetStartMenuInternet}"},{"type":"add","add":true,"ln":56,"content":"+    ${FixShellIconHandler}"},{"type":"add","add":true,"ln":57,"content":"+    ${SetUninstallKeys}"},{"type":"add","add":true,"ln":58,"content":"+  ${EndIf}"},{"type":"add","add":true,"ln":59,"content":"+"},{"type":"add","add":true,"ln":60,"content":"+  ${RemoveDeprecatedKeys}"},{"type":"normal","normal":true,"ln1":51,"ln2":61,"content":" "},{"type":"normal","normal":true,"ln1":52,"ln2":62,"content":"   ; Add Software\\Mozilla\\ registry entries"},{"type":"normal","normal":true,"ln1":53,"ln2":63,"content":"   ${SetAppKeys}"},{"type":"del","del":true,"ln":54,"content":"-"},{"type":"del","del":true,"ln":55,"content":"-  ${SetUninstallKeys}"},{"type":"del","del":true,"ln":56,"content":"-"},{"type":"normal","normal":true,"ln1":57,"ln2":64,"content":"   ${FixClassKeys}"},{"type":"add","add":true,"ln":65,"content":"+  ${UpdateProtocolHandlers}"},{"type":"normal","normal":true,"ln1":58,"ln2":66,"content":" "},{"type":"normal","normal":true,"ln1":59,"ln2":67,"content":"   ; Remove files that may be left behind by the application in the"},{"type":"normal","normal":true,"ln1":60,"ln2":68,"content":"   ; VirtualStore directory."}],"oldStart":35,"oldLines":26,"newStart":35,"newLines":34},{"content":"@@ -68,24 +76,74 @@","changes":[{"type":"normal","normal":true,"ln1":68,"ln2":76,"content":" !define PostUpdate \"!insertmacro PostUpdate\""},{"type":"normal","normal":true,"ln1":69,"ln2":77,"content":" "},{"type":"normal","normal":true,"ln1":70,"ln2":78,"content":" !macro SetAsDefaultAppUser"},{"type":"del","del":true,"ln":71,"content":"-  SetShellVarContext current"},{"type":"add","add":true,"ln":79,"content":"+  ; It is only possible to set this installation of the application as the"},{"type":"add","add":true,"ln":80,"content":"+  ; StartMenuInternet handler if it was added to the HKLM StartMenuInternet"},{"type":"add","add":true,"ln":81,"content":"+  ; registry keys."},{"type":"add","add":true,"ln":82,"content":"+  ; http://support.microsoft.com/kb/297878"},{"type":"add","add":true,"ln":83,"content":"+"},{"type":"add","add":true,"ln":84,"content":"+  ${StrFilter} \"${FileMainEXE}\" \"+\" \"\" \"\" $R9"},{"type":"add","add":true,"ln":85,"content":"+  ClearErrors"},{"type":"add","add":true,"ln":86,"content":"+  ReadRegStr $0 HKLM \"Software\\Clients\\StartMenuInternet\\$R9\\DefaultIcon\" \"\""},{"type":"add","add":true,"ln":87,"content":"+  IfErrors updateclientkeys +1"},{"type":"add","add":true,"ln":88,"content":"+  ${GetPathFromString} \"$0\" $0"},{"type":"add","add":true,"ln":89,"content":"+  ${GetParent} \"$0\" $0"},{"type":"add","add":true,"ln":90,"content":"+  IfFileExists \"$0\" +1 updateclientkeys"},{"type":"add","add":true,"ln":91,"content":"+  ${GetLongPath} \"$0\" $0"},{"type":"add","add":true,"ln":92,"content":"+  StrCmp \"$0\" \"$INSTDIR\" setdefaultuser +1"},{"type":"add","add":true,"ln":93,"content":"+"},{"type":"add","add":true,"ln":94,"content":"+  updateclientkeys:"},{"type":"add","add":true,"ln":95,"content":"+  ; Calls after ElevateUAC won't be made if the user can elevate. They"},{"type":"add","add":true,"ln":96,"content":"+  ; will be made in the new elevated process if the user allows elevation."},{"type":"add","add":true,"ln":97,"content":"+  ${ElevateUAC}"},{"type":"add","add":true,"ln":98,"content":"+"},{"type":"add","add":true,"ln":99,"content":"+  ${SetStartMenuInternet}"},{"type":"add","add":true,"ln":100,"content":"+"},{"type":"add","add":true,"ln":101,"content":"+  setdefaultuser:"},{"type":"add","add":true,"ln":102,"content":"+  SetShellVarContext all  ; Set SHCTX to all users (e.g. HKLM)"},{"type":"add","add":true,"ln":103,"content":"+  ${FixShellIconHandler}"},{"type":"add","add":true,"ln":104,"content":"+  WriteRegStr HKCU \"Software\\Clients\\StartMenuInternet\" \"\" \"$R9\""},{"type":"add","add":true,"ln":105,"content":"+"},{"type":"add","add":true,"ln":106,"content":"+!ifdef ___WINVER__NSH___"},{"type":"add","add":true,"ln":107,"content":"+  ${If} ${AtLeastWinVista}"},{"type":"add","add":true,"ln":108,"content":"+    ClearErrors"},{"type":"add","add":true,"ln":109,"content":"+    ReadRegStr $0 HKLM \"Software\\RegisteredApplications\" \"${AppRegName}\""},{"type":"add","add":true,"ln":110,"content":"+    ; Only register as the handler on Vista if the app registry name exists"},{"type":"add","add":true,"ln":111,"content":"+    ; under the RegisteredApplications registry key."},{"type":"add","add":true,"ln":112,"content":"+    ${Unless} ${Errors}"},{"type":"add","add":true,"ln":113,"content":"+      SetVistaDefaultApp::SetAsDefault \"${AppRegName}\""},{"type":"add","add":true,"ln":114,"content":"+    ${EndUnless}"},{"type":"add","add":true,"ln":115,"content":"+  ${EndIf}"},{"type":"add","add":true,"ln":116,"content":"+!endif"},{"type":"add","add":true,"ln":117,"content":"+"},{"type":"add","add":true,"ln":118,"content":"+  ${RemoveDeprecatedKeys}"},{"type":"add","add":true,"ln":119,"content":"+"},{"type":"add","add":true,"ln":120,"content":"+  SetShellVarContext current  ; Set SHCTX to the current user (e.g. HKCU)"},{"type":"normal","normal":true,"ln1":72,"ln2":121,"content":"   ${SetHandlers}"},{"type":"normal","normal":true,"ln1":73,"ln2":122,"content":" !macroend"},{"type":"normal","normal":true,"ln1":74,"ln2":123,"content":" !define SetAsDefaultAppUser \"!insertmacro SetAsDefaultAppUser\""},{"type":"normal","normal":true,"ln1":75,"ln2":124,"content":" "},{"type":"normal","normal":true,"ln1":76,"ln2":125,"content":" !macro SetAsDefaultAppGlobal"},{"type":"del","del":true,"ln":77,"content":"-  SetShellVarContext all"},{"type":"add","add":true,"ln":126,"content":"+  ${RemoveDeprecatedKeys}"},{"type":"add","add":true,"ln":127,"content":"+"},{"type":"add","add":true,"ln":128,"content":"+  SetShellVarContext all      ; Set SHCTX to all users (e.g. HKLM)"},{"type":"normal","normal":true,"ln1":78,"ln2":129,"content":"   ${SetHandlers}"},{"type":"normal","normal":true,"ln1":79,"ln2":130,"content":"   ${SetStartMenuInternet}"},{"type":"del","del":true,"ln":80,"content":"-  WriteRegStr HKLM \"Software\\Clients\\StartMenuInternet\" \"\" \"$R9\""},{"type":"add","add":true,"ln":131,"content":"+  ${FixShellIconHandler}"},{"type":"normal","normal":true,"ln1":81,"ln2":132,"content":"   ${ShowShortcuts}"},{"type":"add","add":true,"ln":133,"content":"+  ${StrFilter} \"${FileMainEXE}\" \"+\" \"\" \"\" $R9"},{"type":"add","add":true,"ln":134,"content":"+  WriteRegStr HKLM \"Software\\Clients\\StartMenuInternet\" \"\" \"$R9\""},{"type":"normal","normal":true,"ln1":82,"ln2":135,"content":" !macroend"},{"type":"normal","normal":true,"ln1":83,"ln2":136,"content":" !define SetAsDefaultAppGlobal \"!insertmacro SetAsDefaultAppGlobal\""},{"type":"normal","normal":true,"ln1":84,"ln2":137,"content":" "},{"type":"add","add":true,"ln":138,"content":"+!macro FixReg"},{"type":"add","add":true,"ln":139,"content":"+  ${SetAsDefaultAppUser}"},{"type":"add","add":true,"ln":140,"content":"+!macroend"},{"type":"add","add":true,"ln":141,"content":"+!define FixReg \"!insertmacro FixReg\""},{"type":"add","add":true,"ln":142,"content":"+"},{"type":"normal","normal":true,"ln1":85,"ln2":143,"content":" !macro HideShortcuts"},{"type":"normal","normal":true,"ln1":86,"ln2":144,"content":"   ${StrFilter} \"${FileMainEXE}\" \"+\" \"\" \"\" $0"},{"type":"normal","normal":true,"ln1":87,"ln2":145,"content":"   StrCpy $R1 \"Software\\Clients\\StartMenuInternet\\$0\\InstallInfo\""},{"type":"del","del":true,"ln":88,"content":"-  WriteRegDWORD HKLM $R1 \"IconsVisible\" 0"},{"type":"add","add":true,"ln":146,"content":"+  WriteRegDWORD HKLM \"$R1\" \"IconsVisible\" 0"},{"type":"normal","normal":true,"ln1":89,"ln2":147,"content":"   SetShellVarContext all  ; Set $DESKTOP to All Users"},{"type":"normal","normal":true,"ln1":90,"ln2":148,"content":"   ${Unless} ${FileExists} \"$DESKTOP\\${BrandFullName}.lnk\""},{"type":"normal","normal":true,"ln1":91,"ln2":149,"content":"     SetShellVarContext current  ; Set $DESKTOP to the current user's desktop"}],"oldStart":68,"oldLines":24,"newStart":76,"newLines":74},{"content":"@@ -122,7 +180,7 @@","changes":[{"type":"normal","normal":true,"ln1":122,"ln2":180,"content":" !macro ShowShortcuts"},{"type":"normal","normal":true,"ln1":123,"ln2":181,"content":"   ${StrFilter} \"${FileMainEXE}\" \"+\" \"\" \"\" $0"},{"type":"normal","normal":true,"ln1":124,"ln2":182,"content":"   StrCpy $R1 \"Software\\Clients\\StartMenuInternet\\$0\\InstallInfo\""},{"type":"del","del":true,"ln":125,"content":"-  WriteRegDWORD HKLM $R1 \"IconsVisible\" 1"},{"type":"add","add":true,"ln":183,"content":"+  WriteRegDWORD HKLM \"$R1\" \"IconsVisible\" 1"},{"type":"normal","normal":true,"ln1":126,"ln2":184,"content":"   SetShellVarContext all  ; Set $DESKTOP to All Users"},{"type":"normal","normal":true,"ln1":127,"ln2":185,"content":"   ${Unless} ${FileExists} \"$DESKTOP\\${BrandFullName}.lnk\""},{"type":"normal","normal":true,"ln1":128,"ln2":186,"content":"     CreateShortCut \"$DESKTOP\\${BrandFullName}.lnk\" \"$INSTDIR\\${FileMainEXE}\" \"\" \"$INSTDIR\\${FileMainEXE}\" 0"}],"oldStart":122,"oldLines":7,"newStart":180,"newLines":7},{"content":"@@ -143,38 +201,70 @@","changes":[{"type":"normal","normal":true,"ln1":143,"ln2":201,"content":" !define ShowShortcuts \"!insertmacro ShowShortcuts\""},{"type":"normal","normal":true,"ln1":144,"ln2":202,"content":" "},{"type":"normal","normal":true,"ln1":145,"ln2":203,"content":" !macro SetHandlers"},{"type":"del","del":true,"ln":146,"content":"-  GetFullPathName $8 \"$INSTDIR\\${FileMainEXE}\""},{"type":"add","add":true,"ln":204,"content":"+  ${GetLongPath} \"$INSTDIR\\${FileMainEXE}\" $8"},{"type":"normal","normal":true,"ln1":147,"ln2":205,"content":" "},{"type":"normal","normal":true,"ln1":148,"ln2":206,"content":"   StrCpy $0 \"SOFTWARE\\Classes\""},{"type":"normal","normal":true,"ln1":149,"ln2":207,"content":"   StrCpy $2 \"$\\\"$8$\\\" -requestPending -osint -url $\\\"%1$\\\"\""},{"type":"normal","normal":true,"ln1":150,"ln2":208,"content":" "},{"type":"normal","normal":true,"ln1":151,"ln2":209,"content":"   ; Associate the file handlers with FirefoxHTML"},{"type":"del","del":true,"ln":152,"content":"-  WriteRegStr SHCTX \"$0\\.htm\"   \"\" \"FirefoxHTML\""},{"type":"del","del":true,"ln":153,"content":"-  WriteRegStr SHCTX \"$0\\.html\"  \"\" \"FirefoxHTML\""},{"type":"del","del":true,"ln":154,"content":"-  WriteRegStr SHCTX \"$0\\.shtml\" \"\" \"FirefoxHTML\""},{"type":"del","del":true,"ln":155,"content":"-  WriteRegStr SHCTX \"$0\\.xht\"   \"\" \"FirefoxHTML\""},{"type":"del","del":true,"ln":156,"content":"-  WriteRegStr SHCTX \"$0\\.xhtml\" \"\" \"FirefoxHTML\""},{"type":"add","add":true,"ln":210,"content":"+  ReadRegStr $6 HKCR \".htm\" \"\""},{"type":"add","add":true,"ln":211,"content":"+  ${If} \"$6\" != \"FirefoxHTML\""},{"type":"add","add":true,"ln":212,"content":"+    WriteRegStr SHCTX \"$0\\.htm\"   \"\" \"FirefoxHTML\""},{"type":"add","add":true,"ln":213,"content":"+  ${EndIf}"},{"type":"add","add":true,"ln":214,"content":"+"},{"type":"add","add":true,"ln":215,"content":"+  ReadRegStr $6 HKCR \".html\" \"\""},{"type":"add","add":true,"ln":216,"content":"+  ${If} \"$6\" != \"FirefoxHTML\""},{"type":"add","add":true,"ln":217,"content":"+    WriteRegStr SHCTX \"$0\\.html\"  \"\" \"FirefoxHTML\""},{"type":"add","add":true,"ln":218,"content":"+  ${EndIf}"},{"type":"add","add":true,"ln":219,"content":"+"},{"type":"add","add":true,"ln":220,"content":"+  ReadRegStr $6 HKCR \".shtml\" \"\""},{"type":"add","add":true,"ln":221,"content":"+  ${If} \"$6\" != \"FirefoxHTML\""},{"type":"add","add":true,"ln":222,"content":"+    WriteRegStr SHCTX \"$0\\.shtml\" \"\" \"FirefoxHTML\""},{"type":"add","add":true,"ln":223,"content":"+  ${EndIf}"},{"type":"add","add":true,"ln":224,"content":"+"},{"type":"add","add":true,"ln":225,"content":"+  ReadRegStr $6 HKCR \".hht\" \"\""},{"type":"add","add":true,"ln":226,"content":"+  ${If} \"$6\" != \"FirefoxHTML\""},{"type":"add","add":true,"ln":227,"content":"+    WriteRegStr SHCTX \"$0\\.xht\"   \"\" \"FirefoxHTML\""},{"type":"add","add":true,"ln":228,"content":"+  ${EndIf}"},{"type":"add","add":true,"ln":229,"content":"+"},{"type":"add","add":true,"ln":230,"content":"+  ReadRegStr $6 HKCR \".xhtml\" \"\""},{"type":"add","add":true,"ln":231,"content":"+  ${If} \"$6\" != \"FirefoxHTML\""},{"type":"add","add":true,"ln":232,"content":"+    WriteRegStr SHCTX \"$0\\.xhtml\" \"\" \"FirefoxHTML\""},{"type":"add","add":true,"ln":233,"content":"+  ${EndIf}"},{"type":"add","add":true,"ln":234,"content":"+"},{"type":"add","add":true,"ln":235,"content":"+  StrCpy $3 \"$\\\"%1$\\\",,0,0,,,,\""},{"type":"normal","normal":true,"ln1":157,"ln2":236,"content":" "},{"type":"normal","normal":true,"ln1":158,"ln2":237,"content":"   ; An empty string is used for the 5th param because FirefoxHTML is not a"},{"type":"normal","normal":true,"ln1":159,"ln2":238,"content":"   ; protocol handler"},{"type":"del","del":true,"ln":160,"content":"-  ${AddHandlerValues} \"$0\\FirefoxHTML\" \"$2\" \"$8,1\" \"${AppRegName} Document\" \"\" \"true\""},{"type":"add","add":true,"ln":239,"content":"+  ${AddDDEHandlerValues} \"FirefoxHTML\" \"$2\" \"$8,1\" \"${AppRegName} Document\" \"\" \\"},{"type":"add","add":true,"ln":240,"content":"+                         \"${DDEApplication}\" \"$3\" \"WWW_OpenURL\""},{"type":"normal","normal":true,"ln1":161,"ln2":241,"content":" "},{"type":"del","del":true,"ln":162,"content":"-  ${AddHandlerValues} \"$0\\FirefoxURL\" \"$2\" \"$8,1\" \"${AppRegName} URL\" \"true\" \"true\""},{"type":"add","add":true,"ln":242,"content":"+  ${AddDDEHandlerValues} \"FirefoxURL\" \"$2\" \"$8,1\" \"${AppRegName} URL\" \"true\" \\"},{"type":"add","add":true,"ln":243,"content":"+                         \"${DDEApplication}\" \"$3\" \"WWW_OpenURL\""},{"type":"normal","normal":true,"ln1":163,"ln2":244,"content":" "},{"type":"normal","normal":true,"ln1":164,"ln2":245,"content":"   ; An empty string is used for the 4th & 5th params because the following"},{"type":"del","del":true,"ln":165,"content":"-  ; protocol handlers already have a display name and additional keys required"},{"type":"del","del":true,"ln":166,"content":"-  ; for a protocol handler."},{"type":"del","del":true,"ln":167,"content":"-  ${AddHandlerValues} \"$0\\ftp\" \"$2\" \"$8,1\" \"\" \"\" \"true\""},{"type":"del","del":true,"ln":168,"content":"-  ${AddHandlerValues} \"$0\\http\" \"$2\" \"$8,1\" \"\" \"\" \"true\""},{"type":"del","del":true,"ln":169,"content":"-  ${AddHandlerValues} \"$0\\https\" \"$2\" \"$8,1\" \"\" \"\" \"true\""},{"type":"add","add":true,"ln":246,"content":"+  ; protocol handlers already have a display name and the additional keys"},{"type":"add","add":true,"ln":247,"content":"+  ; required for a protocol handler."},{"type":"add","add":true,"ln":248,"content":"+  ${AddDDEHandlerValues} \"ftp\" \"$2\" \"$8,1\" \"\" \"\" \\"},{"type":"add","add":true,"ln":249,"content":"+                         \"${DDEApplication}\" \"$3\" \"WWW_OpenURL\""},{"type":"add","add":true,"ln":250,"content":"+  ${AddDDEHandlerValues} \"http\" \"$2\" \"$8,1\" \"\" \"\" \\"},{"type":"add","add":true,"ln":251,"content":"+                         \"${DDEApplication}\" \"$3\" \"WWW_OpenURL\""},{"type":"add","add":true,"ln":252,"content":"+  ${AddDDEHandlerValues} \"https\" \"$2\" \"$8,1\" \"\" \"\" \\"},{"type":"add","add":true,"ln":253,"content":"+                         \"${DDEApplication}\" \"$3\" \"WWW_OpenURL\""},{"type":"normal","normal":true,"ln1":170,"ln2":254,"content":" !macroend"},{"type":"normal","normal":true,"ln1":171,"ln2":255,"content":" !define SetHandlers \"!insertmacro SetHandlers\""},{"type":"normal","normal":true,"ln1":172,"ln2":256,"content":" "},{"type":"del","del":true,"ln":173,"content":"-; XXXrstrong - there are several values that will be overwritten by and"},{"type":"del","del":true,"ln":174,"content":"-; overwrite other installs of the same application."},{"type":"add","add":true,"ln":257,"content":"+; The values for StartMenuInternet are only valid under HKLM and there can only"},{"type":"add","add":true,"ln":258,"content":"+; be one installation registerred under StartMenuInternet per application since"},{"type":"add","add":true,"ln":259,"content":"+; the key name is derived from the main application executable."},{"type":"add","add":true,"ln":260,"content":"+; http://support.microsoft.com/kb/297878"},{"type":"add","add":true,"ln":261,"content":"+;"},{"type":"add","add":true,"ln":262,"content":"+; Note: we might be able to get away with using the full path to the"},{"type":"add","add":true,"ln":263,"content":"+; application executable for the key name in order to support multiple"},{"type":"add","add":true,"ln":264,"content":"+; installations."},{"type":"normal","normal":true,"ln1":175,"ln2":265,"content":" !macro SetStartMenuInternet"},{"type":"del","del":true,"ln":176,"content":"-  GetFullPathName $8 \"$INSTDIR\\${FileMainEXE}\""},{"type":"del","del":true,"ln":177,"content":"-  GetFullPathName $7 \"$INSTDIR\\uninstall\\helper.exe\""},{"type":"add","add":true,"ln":266,"content":"+  ${GetLongPath} \"$INSTDIR\\${FileMainEXE}\" $8"},{"type":"add","add":true,"ln":267,"content":"+  ${GetLongPath} \"$INSTDIR\\uninstall\\helper.exe\" $7"},{"type":"normal","normal":true,"ln1":178,"ln2":268,"content":" "},{"type":"normal","normal":true,"ln1":179,"ln2":269,"content":"   ${StrFilter} \"${FileMainEXE}\" \"+\" \"\" \"\" $R9"},{"type":"normal","normal":true,"ln1":180,"ln2":270,"content":" "}],"oldStart":143,"oldLines":38,"newStart":201,"newLines":70},{"content":"@@ -190,6 +280,18 @@","changes":[{"type":"normal","normal":true,"ln1":190,"ln2":280,"content":"   WriteRegStr HKLM \"$0\\InstallInfo\" \"ShowIconsCommand\" \"$\\\"$7$\\\" /ShowShortcuts\""},{"type":"normal","normal":true,"ln1":191,"ln2":281,"content":"   WriteRegStr HKLM \"$0\\InstallInfo\" \"ReinstallCommand\" \"$\\\"$7$\\\" /SetAsDefaultAppGlobal\""},{"type":"normal","normal":true,"ln1":192,"ln2":282,"content":" "},{"type":"add","add":true,"ln":283,"content":"+  ClearErrors"},{"type":"add","add":true,"ln":284,"content":"+  ReadRegDWORD $1 HKLM \"$0\\InstallInfo\" \"IconsVisible\""},{"type":"add","add":true,"ln":285,"content":"+  ; If the IconsVisible name vale pair doesn't exist add it otherwise the"},{"type":"add","add":true,"ln":286,"content":"+  ; application won't be displayed in Set Program Access and Defaults."},{"type":"add","add":true,"ln":287,"content":"+  ${If} ${Errors}"},{"type":"add","add":true,"ln":288,"content":"+    ${If} ${FileExists} \"$QUICKLAUNCH\\${BrandFullName}.lnk\""},{"type":"add","add":true,"ln":289,"content":"+      WriteRegDWORD HKLM \"$0\\InstallInfo\" \"IconsVisible\" 1"},{"type":"add","add":true,"ln":290,"content":"+    ${Else}"},{"type":"add","add":true,"ln":291,"content":"+      WriteRegDWORD HKLM \"$0\\InstallInfo\" \"IconsVisible\" 0"},{"type":"add","add":true,"ln":292,"content":"+    ${EndIf}"},{"type":"add","add":true,"ln":293,"content":"+  ${EndIf}"},{"type":"add","add":true,"ln":294,"content":"+"},{"type":"normal","normal":true,"ln1":193,"ln2":295,"content":"   WriteRegStr HKLM \"$0\\shell\\open\\command\" \"\" \"$8\""},{"type":"normal","normal":true,"ln1":194,"ln2":296,"content":" "},{"type":"normal","normal":true,"ln1":195,"ln2":297,"content":"   WriteRegStr HKLM \"$0\\shell\\properties\" \"\" \"$(CONTEXT_OPTIONS)\""}],"oldStart":190,"oldLines":6,"newStart":280,"newLines":18},{"content":"@@ -215,28 +317,19 @@","changes":[{"type":"normal","normal":true,"ln1":215,"ln2":317,"content":"   WriteRegStr HKLM \"$0\\Capabilities\\URLAssociations\" \"http\"   \"FirefoxURL\""},{"type":"normal","normal":true,"ln1":216,"ln2":318,"content":"   WriteRegStr HKLM \"$0\\Capabilities\\URLAssociations\" \"https\"  \"FirefoxURL\""},{"type":"normal","normal":true,"ln1":217,"ln2":319,"content":" "},{"type":"del","del":true,"ln":218,"content":"-  ; Delete gopher from Capabilities\\URLAssociations if it is present."},{"type":"del","del":true,"ln":219,"content":"-  ClearErrors"},{"type":"del","del":true,"ln":220,"content":"-  ReadRegStr $2 HKLM \"$0\\Capabilities\\URLAssociations\" \"gopher\""},{"type":"del","del":true,"ln":221,"content":"-  ${Unless} ${Errors}"},{"type":"del","del":true,"ln":222,"content":"-    DeleteRegValue HKLM \"$0\\Capabilities\\URLAssociations\" \"gopher\""},{"type":"del","del":true,"ln":223,"content":"-  ${EndUnless}"},{"type":"del","del":true,"ln":224,"content":"-"},{"type":"del","del":true,"ln":225,"content":"-  ; Delete gopher from the user's UrlAssociations if it points to FirefoxURL."},{"type":"del","del":true,"ln":226,"content":"-  ReadRegStr $2 HKCU \"Software\\Microsoft\\Windows\\Shell\\Associations\\UrlAssociations\\gopher\\UserChoice\" \"Progid\""},{"type":"del","del":true,"ln":227,"content":"-  ${If} $2 == \"FirefoxURL\""},{"type":"del","del":true,"ln":228,"content":"-    DeleteRegKey HKCU \"Software\\Microsoft\\Windows\\Shell\\Associations\\UrlAssociations\\gopher\""},{"type":"del","del":true,"ln":229,"content":"-  ${EndIf}"},{"type":"del","del":true,"ln":230,"content":"-"},{"type":"normal","normal":true,"ln1":231,"ln2":320,"content":"   ; Vista Registered Application"},{"type":"normal","normal":true,"ln1":232,"ln2":321,"content":"   WriteRegStr HKLM \"Software\\RegisteredApplications\" \"${AppRegName}\" \"$0\\Capabilities\""},{"type":"add","add":true,"ln":322,"content":"+!macroend"},{"type":"add","add":true,"ln":323,"content":"+!define SetStartMenuInternet \"!insertmacro SetStartMenuInternet\""},{"type":"normal","normal":true,"ln1":233,"ln2":324,"content":" "},{"type":"add","add":true,"ln":325,"content":"+!macro FixShellIconHandler"},{"type":"normal","normal":true,"ln1":234,"ln2":326,"content":"   ; The IconHandler reference for FirefoxHTML can end up in an inconsistent"},{"type":"normal","normal":true,"ln1":235,"ln2":327,"content":"   ; state due to changes not being detected by the IconHandler for side by side"},{"type":"normal","normal":true,"ln1":236,"ln2":328,"content":"   ; installs. The symptoms can be either an incorrect icon or no icon being"},{"type":"normal","normal":true,"ln1":237,"ln2":329,"content":"   ; displayed for files associated with Firefox. By setting it here it will"},{"type":"normal","normal":true,"ln1":238,"ln2":330,"content":"   ; always reference the install referenced in the"},{"type":"normal","normal":true,"ln1":239,"ln2":331,"content":"   ; HKLM\\Software\\Classes\\FirefoxHTML registry key."},{"type":"add","add":true,"ln":332,"content":"+  ${GetLongPath} \"$INSTDIR\\${FileMainEXE}\" $8"},{"type":"normal","normal":true,"ln1":240,"ln2":333,"content":"   ClearErrors"},{"type":"normal","normal":true,"ln1":241,"ln2":334,"content":"   ReadRegStr $2 HKLM \"Software\\Classes\\FirefoxHTML\\ShellEx\\IconHandler\" \"\""},{"type":"normal","normal":true,"ln1":242,"ln2":335,"content":"   ${Unless} ${Errors}"}],"oldStart":215,"oldLines":28,"newStart":317,"newLines":19},{"content":"@@ -247,12 +340,13 @@","changes":[{"type":"normal","normal":true,"ln1":247,"ln2":340,"content":"     ${EndUnless}"},{"type":"normal","normal":true,"ln1":248,"ln2":341,"content":"   ${EndUnless}"},{"type":"normal","normal":true,"ln1":249,"ln2":342,"content":" !macroend"},{"type":"del","del":true,"ln":250,"content":"-!define SetStartMenuInternet \"!insertmacro SetStartMenuInternet\""},{"type":"add","add":true,"ln":343,"content":"+!define FixShellIconHandler \"!insertmacro FixShellIconHandler\""},{"type":"normal","normal":true,"ln1":251,"ln2":344,"content":" "},{"type":"normal","normal":true,"ln1":252,"ln2":345,"content":" !macro SetAppKeys"},{"type":"add","add":true,"ln":346,"content":"+  ${GetLongPath} \"$INSTDIR\" $8"},{"type":"normal","normal":true,"ln1":253,"ln2":347,"content":"   StrCpy $0 \"Software\\Mozilla\\${BrandFullNameInternal}\\${AppVersion} (${AB_CD})\\Main\""},{"type":"del","del":true,"ln":254,"content":"-  ${WriteRegStr2} $TmpVal \"$0\" \"Install Directory\" \"$INSTDIR\" 0"},{"type":"del","del":true,"ln":255,"content":"-  ${WriteRegStr2} $TmpVal \"$0\" \"PathToExe\" \"$INSTDIR\\${FileMainEXE}\" 0"},{"type":"add","add":true,"ln":348,"content":"+  ${WriteRegStr2} $TmpVal \"$0\" \"Install Directory\" \"$8\" 0"},{"type":"add","add":true,"ln":349,"content":"+  ${WriteRegStr2} $TmpVal \"$0\" \"PathToExe\" \"$8\\${FileMainEXE}\" 0"},{"type":"normal","normal":true,"ln1":256,"ln2":350,"content":"   ${WriteRegStr2} $TmpVal \"$0\" \"Program Folder Path\" \"$SMPROGRAMS\\$StartMenuDir\" 0"},{"type":"normal","normal":true,"ln1":257,"ln2":351,"content":" "},{"type":"normal","normal":true,"ln1":258,"ln2":352,"content":"   SetShellVarContext all  ; Set $DESKTOP to All Users"}],"oldStart":247,"oldLines":12,"newStart":340,"newLines":13},{"content":"@@ -266,8 +360,8 @@","changes":[{"type":"normal","normal":true,"ln1":266,"ln2":360,"content":"     ${If} $1 == \"\""},{"type":"normal","normal":true,"ln1":267,"ln2":361,"content":"       ShellLink::GetShortCutTarget \"$DESKTOP\\${BrandFullName}.lnk\""},{"type":"normal","normal":true,"ln1":268,"ln2":362,"content":"       Pop $1"},{"type":"del","del":true,"ln":269,"content":"-      ; Needs to handle short paths"},{"type":"del","del":true,"ln":270,"content":"-      ${If} $1 == \"$INSTDIR\\${FileMainEXE}\""},{"type":"add","add":true,"ln":363,"content":"+      ${GetLongPath} \"$1\" $1"},{"type":"add","add":true,"ln":364,"content":"+      ${If} \"$1\" == \"$8\\${FileMainEXE}\""},{"type":"normal","normal":true,"ln1":271,"ln2":365,"content":"         ${WriteRegDWORD2} $TmpVal \"$0\" \"Create Desktop Shortcut\" 1 0"},{"type":"normal","normal":true,"ln1":272,"ln2":366,"content":"       ${Else}"},{"type":"normal","normal":true,"ln1":273,"ln2":367,"content":"         ${WriteRegDWORD2} $TmpVal \"$0\" \"Create Desktop Shortcut\" 0 0"}],"oldStart":266,"oldLines":8,"newStart":360,"newLines":8},{"content":"@@ -278,9 +372,9 @@","changes":[{"type":"normal","normal":true,"ln1":278,"ln2":372,"content":"   ; XXXrstrong - need a cleaner way to prevent unsetting SHCTX from HKLM when"},{"type":"normal","normal":true,"ln1":279,"ln2":373,"content":"   ; trying to find the desktop shortcut."},{"type":"normal","normal":true,"ln1":280,"ln2":374,"content":"   ${If} $TmpVal == \"HKCU\""},{"type":"del","del":true,"ln":281,"content":"-    SetShellVarContext current"},{"type":"add","add":true,"ln":375,"content":"+    SetShellVarContext current ; Set SHCTX to the current user (e.g. HKCU)"},{"type":"normal","normal":true,"ln1":282,"ln2":376,"content":"   ${Else}"},{"type":"del","del":true,"ln":283,"content":"-    SetShellVarContext all"},{"type":"add","add":true,"ln":377,"content":"+    SetShellVarContext all     ; Set SHCTX to all users (e.g. HKLM)"},{"type":"normal","normal":true,"ln1":284,"ln2":378,"content":"   ${EndIf}"},{"type":"normal","normal":true,"ln1":285,"ln2":379,"content":" "},{"type":"normal","normal":true,"ln1":286,"ln2":380,"content":"   ${If} ${FileExists} \"$QUICKLAUNCH\\${BrandFullName}.lnk\""}],"oldStart":278,"oldLines":9,"newStart":372,"newLines":9},{"content":"@@ -289,8 +383,8 @@","changes":[{"type":"normal","normal":true,"ln1":289,"ln2":383,"content":"     ${If} $1 == \"\""},{"type":"normal","normal":true,"ln1":290,"ln2":384,"content":"       ShellLink::GetShortCutTarget \"$QUICKLAUNCH\\${BrandFullName}.lnk\""},{"type":"normal","normal":true,"ln1":291,"ln2":385,"content":"       Pop $1"},{"type":"del","del":true,"ln":292,"content":"-      ; Needs to handle short paths"},{"type":"del","del":true,"ln":293,"content":"-      ${If} $1 == \"$INSTDIR\\${FileMainEXE}\""},{"type":"add","add":true,"ln":386,"content":"+      ${GetLongPath} \"$1\" $1"},{"type":"add","add":true,"ln":387,"content":"+      ${If} $1 == \"$8\\${FileMainEXE}\""},{"type":"normal","normal":true,"ln1":294,"ln2":388,"content":"         ${WriteRegDWORD2} $TmpVal \"$0\" \"Create Quick Launch Shortcut\" 1 0"},{"type":"normal","normal":true,"ln1":295,"ln2":389,"content":"       ${Else}"},{"type":"normal","normal":true,"ln1":296,"ln2":390,"content":"         ${WriteRegDWORD2} $TmpVal \"$0\" \"Create Quick Launch Shortcut\" 0 0"}],"oldStart":289,"oldLines":8,"newStart":383,"newLines":8},{"content":"@@ -301,18 +395,18 @@","changes":[{"type":"normal","normal":true,"ln1":301,"ln2":395,"content":"   ; set in the installer and should also be set here for software update."},{"type":"normal","normal":true,"ln1":302,"ln2":396,"content":" "},{"type":"normal","normal":true,"ln1":303,"ln2":397,"content":"   StrCpy $0 \"Software\\Mozilla\\${BrandFullNameInternal}\\${AppVersion} (${AB_CD})\\Uninstall\""},{"type":"del","del":true,"ln":304,"content":"-  ${WriteRegStr2} $TmpVal \"$0\" \"Uninstall Log Folder\" \"$INSTDIR\\uninstall\" 0"},{"type":"add","add":true,"ln":398,"content":"+  ${WriteRegStr2} $TmpVal \"$0\" \"Uninstall Log Folder\" \"$8\\uninstall\" 0"},{"type":"normal","normal":true,"ln1":305,"ln2":399,"content":"   ${WriteRegStr2} $TmpVal \"$0\" \"Description\" \"${BrandFullNameInternal} (${AppVersion})\" 0"},{"type":"normal","normal":true,"ln1":306,"ln2":400,"content":" "},{"type":"normal","normal":true,"ln1":307,"ln2":401,"content":"   StrCpy $0 \"Software\\Mozilla\\${BrandFullNameInternal}\\${AppVersion} (${AB_CD})\""},{"type":"normal","normal":true,"ln1":308,"ln2":402,"content":"   ${WriteRegStr2} $TmpVal  \"$0\" \"\" \"${AppVersion} (${AB_CD})\" 0"},{"type":"normal","normal":true,"ln1":309,"ln2":403,"content":" "},{"type":"normal","normal":true,"ln1":310,"ln2":404,"content":"   StrCpy $0 \"Software\\Mozilla\\${BrandFullNameInternal} ${AppVersion}\\bin\""},{"type":"del","del":true,"ln":311,"content":"-  ${WriteRegStr2} $TmpVal \"$0\" \"PathToExe\" \"$INSTDIR\\${FileMainEXE}\" 0"},{"type":"add","add":true,"ln":405,"content":"+  ${WriteRegStr2} $TmpVal \"$0\" \"PathToExe\" \"$8\\${FileMainEXE}\" 0"},{"type":"normal","normal":true,"ln1":312,"ln2":406,"content":" "},{"type":"normal","normal":true,"ln1":313,"ln2":407,"content":"   StrCpy $0 \"Software\\Mozilla\\${BrandFullNameInternal} ${AppVersion}\\extensions\""},{"type":"del","del":true,"ln":314,"content":"-  ${WriteRegStr2} $TmpVal \"$0\" \"Components\" \"$INSTDIR\\components\" 0"},{"type":"del","del":true,"ln":315,"content":"-  ${WriteRegStr2} $TmpVal \"$0\" \"Plugins\" \"$INSTDIR\\plugins\" 0"},{"type":"add","add":true,"ln":408,"content":"+  ${WriteRegStr2} $TmpVal \"$0\" \"Components\" \"$8\\components\" 0"},{"type":"add","add":true,"ln":409,"content":"+  ${WriteRegStr2} $TmpVal \"$0\" \"Plugins\" \"$8\\plugins\" 0"},{"type":"normal","normal":true,"ln1":316,"ln2":410,"content":" "},{"type":"normal","normal":true,"ln1":317,"ln2":411,"content":"   StrCpy $0 \"Software\\Mozilla\\${BrandFullNameInternal} ${AppVersion}\""},{"type":"normal","normal":true,"ln1":318,"ln2":412,"content":"   ${WriteRegStr2} $TmpVal \"$0\" \"GeckoVer\" \"${GREVersion}\" 0"}],"oldStart":301,"oldLines":18,"newStart":395,"newLines":18},{"content":"@@ -324,18 +418,17 @@","changes":[{"type":"normal","normal":true,"ln1":324,"ln2":418,"content":" !define SetAppKeys \"!insertmacro SetAppKeys\""},{"type":"normal","normal":true,"ln1":325,"ln2":419,"content":" "},{"type":"normal","normal":true,"ln1":326,"ln2":420,"content":" !macro SetUninstallKeys"},{"type":"del","del":true,"ln":327,"content":"-  ; Write the uninstall registry keys"},{"type":"normal","normal":true,"ln1":328,"ln2":421,"content":"   StrCpy $0 \"Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\${BrandFullNameInternal} (${AppVersion})\""},{"type":"del","del":true,"ln":329,"content":"-  GetFullPathName $8 \"$INSTDIR\\${FileMainEXE}\""},{"type":"del","del":true,"ln":330,"content":"-  GetFullPathName $7 \"$INSTDIR\\uninstall\\helper.exe\""},{"type":"add","add":true,"ln":422,"content":"+  ${GetLongPath} \"$INSTDIR\" $8"},{"type":"normal","normal":true,"ln1":331,"ln2":423,"content":" "},{"type":"add","add":true,"ln":424,"content":"+  ; Write the uninstall registry keys"},{"type":"normal","normal":true,"ln1":332,"ln2":425,"content":"   ${WriteRegStr2} $TmpVal \"$0\" \"Comments\" \"${BrandFullNameInternal}\" 0"},{"type":"del","del":true,"ln":333,"content":"-  ${WriteRegStr2} $TmpVal \"$0\" \"DisplayIcon\" \"$8,0\" 0"},{"type":"add","add":true,"ln":426,"content":"+  ${WriteRegStr2} $TmpVal \"$0\" \"DisplayIcon\" \"$8\\${FileMainEXE},0\" 0"},{"type":"normal","normal":true,"ln1":334,"ln2":427,"content":"   ${WriteRegStr2} $TmpVal \"$0\" \"DisplayName\" \"${BrandFullNameInternal} (${AppVersion})\" 0"},{"type":"normal","normal":true,"ln1":335,"ln2":428,"content":"   ${WriteRegStr2} $TmpVal \"$0\" \"DisplayVersion\" \"${AppVersion} (${AB_CD})\" 0"},{"type":"del","del":true,"ln":336,"content":"-  ${WriteRegStr2} $TmpVal \"$0\" \"InstallLocation\" \"$INSTDIR\" 0"},{"type":"add","add":true,"ln":429,"content":"+  ${WriteRegStr2} $TmpVal \"$0\" \"InstallLocation\" \"$8\" 0"},{"type":"normal","normal":true,"ln1":337,"ln2":430,"content":"   ${WriteRegStr2} $TmpVal \"$0\" \"Publisher\" \"Mozilla\" 0"},{"type":"del","del":true,"ln":338,"content":"-  ${WriteRegStr2} $TmpVal \"$0\" \"UninstallString\" \"$7\" 0"},{"type":"add","add":true,"ln":431,"content":"+  ${WriteRegStr2} $TmpVal \"$0\" \"UninstallString\" \"$8\\uninstall\\helper.exe\" 0"},{"type":"normal","normal":true,"ln1":339,"ln2":432,"content":"   ${WriteRegStr2} $TmpVal \"$0\" \"URLInfoAbout\" \"${URLInfoAbout}\" 0"},{"type":"normal","normal":true,"ln1":340,"ln2":433,"content":"   ${WriteRegStr2} $TmpVal \"$0\" \"URLUpdateInfo\" \"${URLUpdateInfo}\" 0"},{"type":"normal","normal":true,"ln1":341,"ln2":434,"content":"   ${WriteRegDWORD2} $TmpVal \"$0\" \"NoModify\" 1 0"}],"oldStart":324,"oldLines":18,"newStart":418,"newLines":17},{"content":"@@ -344,96 +437,110 @@","changes":[{"type":"normal","normal":true,"ln1":344,"ln2":437,"content":" !define SetUninstallKeys \"!insertmacro SetUninstallKeys\""},{"type":"normal","normal":true,"ln1":345,"ln2":438,"content":" "},{"type":"normal","normal":true,"ln1":346,"ln2":439,"content":" !macro FixClassKeys"},{"type":"del","del":true,"ln":347,"content":"-  StrCpy $0 \"SOFTWARE\\Classes\""},{"type":"add","add":true,"ln":440,"content":"+  StrCpy $1 \"SOFTWARE\\Classes\""},{"type":"normal","normal":true,"ln1":348,"ln2":441,"content":" "},{"type":"normal","normal":true,"ln1":349,"ln2":442,"content":"   ; File handler keys and name value pairs that may need to be created during"},{"type":"normal","normal":true,"ln1":350,"ln2":443,"content":"   ; install or upgrade."},{"type":"del","del":true,"ln":351,"content":"-  ReadRegStr $2 SHCTX \"$0\\.shtml\" \"Content Type\""},{"type":"del","del":true,"ln":352,"content":"-  ${If} $2 == \"\""},{"type":"del","del":true,"ln":353,"content":"-    StrCpy $2 \"$0\\.shtml\""},{"type":"del","del":true,"ln":354,"content":"-    ${WriteRegStr2} $TmpVal \"$0\\.shtml\" \"\" \"shtmlfile\" 0"},{"type":"del","del":true,"ln":355,"content":"-    ${WriteRegStr2} $TmpVal \"$0\\.shtml\" \"Content Type\" \"text/html\" 0"},{"type":"del","del":true,"ln":356,"content":"-    ${WriteRegStr2} $TmpVal \"$0\\.shtml\" \"PerceivedType\" \"text\" 0"},{"type":"add","add":true,"ln":444,"content":"+  ReadRegStr $0 HKCR \".shtml\" \"Content Type\""},{"type":"add","add":true,"ln":445,"content":"+  ${If} \"$0\" == \"\""},{"type":"add","add":true,"ln":446,"content":"+    StrCpy $0 \"$1\\.shtml\""},{"type":"add","add":true,"ln":447,"content":"+    ${WriteRegStr2} $TmpVal \"$1\\.shtml\" \"\" \"shtmlfile\" 0"},{"type":"add","add":true,"ln":448,"content":"+    ${WriteRegStr2} $TmpVal \"$1\\.shtml\" \"Content Type\" \"text/html\" 0"},{"type":"add","add":true,"ln":449,"content":"+    ${WriteRegStr2} $TmpVal \"$1\\.shtml\" \"PerceivedType\" \"text\" 0"},{"type":"normal","normal":true,"ln1":357,"ln2":450,"content":"   ${EndIf}"},{"type":"normal","normal":true,"ln1":358,"ln2":451,"content":" "},{"type":"del","del":true,"ln":359,"content":"-  ReadRegStr $2 SHCTX \"$0\\.xht\" \"Content Type\""},{"type":"del","del":true,"ln":360,"content":"-  ${If} $2 == \"\""},{"type":"del","del":true,"ln":361,"content":"-    ${WriteRegStr2} $TmpVal \"$0\\.xht\" \"\" \"xhtfile\" 0"},{"type":"del","del":true,"ln":362,"content":"-    ${WriteRegStr2} $TmpVal \"$0\\.xht\" \"Content Type\" \"application/xhtml+xml\" 0"},{"type":"add","add":true,"ln":452,"content":"+  ReadRegStr $0 HKCR \".xht\" \"Content Type\""},{"type":"add","add":true,"ln":453,"content":"+  ${If} \"$0\" == \"\""},{"type":"add","add":true,"ln":454,"content":"+    ${WriteRegStr2} $TmpVal \"$1\\.xht\" \"\" \"xhtfile\" 0"},{"type":"add","add":true,"ln":455,"content":"+    ${WriteRegStr2} $TmpVal \"$1\\.xht\" \"Content Type\" \"application/xhtml+xml\" 0"},{"type":"normal","normal":true,"ln1":363,"ln2":456,"content":"   ${EndIf}"},{"type":"normal","normal":true,"ln1":364,"ln2":457,"content":" "},{"type":"del","del":true,"ln":365,"content":"-  ReadRegStr $2 SHCTX \"$0\\.xhtml\" \"Content Type\""},{"type":"del","del":true,"ln":366,"content":"-  ${If} $2 == \"\""},{"type":"del","del":true,"ln":367,"content":"-    ${WriteRegStr2} $TmpVal \"$0\\.xhtml\" \"\" \"xhtmlfile\" 0"},{"type":"del","del":true,"ln":368,"content":"-    ${WriteRegStr2} $TmpVal \"$0\\.xhtml\" \"Content Type\" \"application/xhtml+xml\" 0"},{"type":"add","add":true,"ln":458,"content":"+  ReadRegStr $0 HKCR \".xhtml\" \"Content Type\""},{"type":"add","add":true,"ln":459,"content":"+  ${If} \"$0\" == \"\""},{"type":"add","add":true,"ln":460,"content":"+    ${WriteRegStr2} $TmpVal \"$1\\.xhtml\" \"\" \"xhtmlfile\" 0"},{"type":"add","add":true,"ln":461,"content":"+    ${WriteRegStr2} $TmpVal \"$1\\.xhtml\" \"Content Type\" \"application/xhtml+xml\" 0"},{"type":"normal","normal":true,"ln1":369,"ln2":462,"content":"   ${EndIf}"},{"type":"add","add":true,"ln":463,"content":"+!macroend"},{"type":"add","add":true,"ln":464,"content":"+!define FixClassKeys \"!insertmacro FixClassKeys\""},{"type":"normal","normal":true,"ln1":370,"ln2":465,"content":" "},{"type":"del","del":true,"ln":371,"content":"-  ; Protocol handler keys and name value pairs that may need to be updated during"},{"type":"del","del":true,"ln":372,"content":"-  ; install or upgrade."},{"type":"add","add":true,"ln":466,"content":"+; Updates protocol handlers if their registry open command value is for this"},{"type":"add","add":true,"ln":467,"content":"+; install location"},{"type":"add","add":true,"ln":468,"content":"+!macro UpdateProtocolHandlers"},{"type":"add","add":true,"ln":469,"content":"+  ; Store the command to open the app with an url in a register for easy access."},{"type":"add","add":true,"ln":470,"content":"+  ${GetLongPath} \"$INSTDIR\\${FileMainEXE}\" $8"},{"type":"add","add":true,"ln":471,"content":"+  StrCpy $2 \"$\\\"$8$\\\" -requestPending -osint -url $\\\"%1$\\\"\""},{"type":"add","add":true,"ln":472,"content":"+  StrCpy $3 \"$\\\"%1$\\\",,0,0,,,,\""},{"type":"normal","normal":true,"ln1":373,"ln2":473,"content":" "},{"type":"del","del":true,"ln":374,"content":"-  ; Bug 301073 Comment #9 makes it so Firefox no longer supports launching"},{"type":"del","del":true,"ln":375,"content":"-  ; chrome urls from the shell so remove it during install or update if the"},{"type":"del","del":true,"ln":376,"content":"-  ; DefaultIcon is from firefox.exe."},{"type":"del","del":true,"ln":377,"content":"-  ReadRegStr $2 SHCTX \"$0\\chrome\\DefaultIcon\" \"\""},{"type":"add","add":true,"ln":474,"content":"+  ; Only set the file and protocol handlers if the existing one under HKCR is"},{"type":"add","add":true,"ln":475,"content":"+  ; for this install location."},{"type":"normal","normal":true,"ln1":378,"ln2":476,"content":" "},{"type":"del","del":true,"ln":379,"content":"-  ClearErrors"},{"type":"del","del":true,"ln":380,"content":"-  ${WordFind} \"$2\" \"${FileMainEXE}\" \"E+1{\" $R1"},{"type":"add","add":true,"ln":477,"content":"+  ${IsHandlerForInstallDir} \"FirefoxHTML\" $R9"},{"type":"add","add":true,"ln":478,"content":"+  ${If} \"$R9\" == \"true\""},{"type":"add","add":true,"ln":479,"content":"+    ; An empty string is used for the 5th param because FirefoxHTML is not a"},{"type":"add","add":true,"ln":480,"content":"+    ; protocol handler."},{"type":"add","add":true,"ln":481,"content":"+    ${AddDDEHandlerValues} \"FirefoxHTML\" \"$2\" \"$8,1\" \"${AppRegName} Document\" \"\" \\"},{"type":"add","add":true,"ln":482,"content":"+                           \"${DDEApplication}\" \"$3\" \"WWW_OpenURL\""},{"type":"add","add":true,"ln":483,"content":"+  ${EndIf}"},{"type":"normal","normal":true,"ln1":381,"ln2":484,"content":" "},{"type":"del","del":true,"ln":382,"content":"-  ${Unless} ${Errors}"},{"type":"del","del":true,"ln":383,"content":"-    DeleteRegKey SHCTX \"$0\\chrome\""},{"type":"del","del":true,"ln":384,"content":"-  ${EndUnless}"},{"type":"add","add":true,"ln":485,"content":"+  ${IsHandlerForInstallDir} \"FirefoxURL\" $R9"},{"type":"add","add":true,"ln":486,"content":"+  ${If} \"$R9\" == \"true\""},{"type":"add","add":true,"ln":487,"content":"+    ${AddDDEHandlerValues} \"FirefoxURL\" \"$2\" \"$8,1\" \"${AppRegName} URL\" \"true\" \\"},{"type":"add","add":true,"ln":488,"content":"+                           \"${DDEApplication}\" \"$3\" \"WWW_OpenURL\""},{"type":"add","add":true,"ln":489,"content":"+  ${EndIf}"},{"type":"normal","normal":true,"ln1":385,"ln2":490,"content":" "},{"type":"del","del":true,"ln":386,"content":"-  ; Remove support for launching gopher urls from the shell during install or"},{"type":"del","del":true,"ln":387,"content":"-  ; update if the DefaultIcon is from firefox.exe."},{"type":"del","del":true,"ln":388,"content":"-  ReadRegStr $2 SHCTX \"$0\\gopher\\DefaultIcon\" \"\""},{"type":"del","del":true,"ln":389,"content":"-  ClearErrors"},{"type":"del","del":true,"ln":390,"content":"-  ${WordFind} \"$2\" \"${FileMainEXE}\" \"E+1{\" $R1"},{"type":"del","del":true,"ln":391,"content":"-  ${Unless} ${Errors}"},{"type":"del","del":true,"ln":392,"content":"-    DeleteRegKey SHCTX \"$0\\gopher\""},{"type":"del","del":true,"ln":393,"content":"-  ${EndUnless}"},{"type":"add","add":true,"ln":491,"content":"+  ${IsHandlerForInstallDir} \"ftp\" $R9"},{"type":"add","add":true,"ln":492,"content":"+  ${If} \"$R9\" == \"true\""},{"type":"add","add":true,"ln":493,"content":"+    ${AddDDEHandlerValues} \"ftp\" \"$2\" \"$8,1\" \"\" \"\" \\"},{"type":"add","add":true,"ln":494,"content":"+                           \"${DDEApplication}\" \"$3\" \"WWW_OpenURL\""},{"type":"add","add":true,"ln":495,"content":"+  ${EndIf}"},{"type":"normal","normal":true,"ln1":394,"ln2":496,"content":" "},{"type":"del","del":true,"ln":395,"content":"-  ; Store the command to open the app with an url in a register for easy access."},{"type":"del","del":true,"ln":396,"content":"-  GetFullPathName $8 \"$INSTDIR\\${FileMainEXE}\""},{"type":"del","del":true,"ln":397,"content":"-  StrCpy $1 \"$\\\"$8$\\\" -requestPending -osint -url $\\\"%1$\\\"\""},{"type":"add","add":true,"ln":497,"content":"+  ${IsHandlerForInstallDir} \"http\" $R9"},{"type":"add","add":true,"ln":498,"content":"+  ${If} \"$R9\" == \"true\""},{"type":"add","add":true,"ln":499,"content":"+    ${AddDDEHandlerValues} \"http\" \"$2\" \"$8,1\" \"\" \"\" \\"},{"type":"add","add":true,"ln":500,"content":"+                           \"${DDEApplication}\" \"$3\" \"WWW_OpenURL\""},{"type":"add","add":true,"ln":501,"content":"+  ${EndIf}"},{"type":"normal","normal":true,"ln1":398,"ln2":502,"content":" "},{"type":"del","del":true,"ln":399,"content":"-  ; Always set the file and protocol handlers since they may specify a"},{"type":"del","del":true,"ln":400,"content":"-  ; different path and the path is used by Vista when setting associations."},{"type":"del","del":true,"ln":401,"content":"-  ${AddHandlerValues} \"$0\\FirefoxURL\" \"$1\" \"$8,1\" \"${AppRegName} URL\" \"true\" \"true\""},{"type":"add","add":true,"ln":503,"content":"+  ${IsHandlerForInstallDir} \"https\" $R9"},{"type":"add","add":true,"ln":504,"content":"+  ${If} \"$R9\" == \"true\""},{"type":"add","add":true,"ln":505,"content":"+    ${AddDDEHandlerValues} \"https\" \"$2\" \"$8,1\" \"\" \"\" \\"},{"type":"add","add":true,"ln":506,"content":"+                           \"${DDEApplication}\" \"$3\" \"WWW_OpenURL\""},{"type":"add","add":true,"ln":507,"content":"+  ${EndIf}"},{"type":"add","add":true,"ln":508,"content":"+!macroend"},{"type":"add","add":true,"ln":509,"content":"+!define UpdateProtocolHandlers \"!insertmacro UpdateProtocolHandlers\""},{"type":"normal","normal":true,"ln1":402,"ln2":510,"content":" "},{"type":"del","del":true,"ln":403,"content":"-  ; An empty string is used for the 5th param because FirefoxHTML is not a"},{"type":"del","del":true,"ln":404,"content":"-  ; protocol handler"},{"type":"del","del":true,"ln":405,"content":"-  ${AddHandlerValues} \"$0\\FirefoxHTML\" \"$1\" \"$8,1\" \"${AppRegName} Document\" \"\" \"true\""},{"type":"add","add":true,"ln":511,"content":"+!macro RemoveDeprecatedKeys"},{"type":"add","add":true,"ln":512,"content":"+  StrCpy $0 \"SOFTWARE\\Classes\""},{"type":"add","add":true,"ln":513,"content":"+  ; Remove support for launching gopher urls from the shell during install or"},{"type":"add","add":true,"ln":514,"content":"+  ; update if the DefaultIcon is from firefox.exe."},{"type":"add","add":true,"ln":515,"content":"+  ${RegCleanAppHandler} \"gopher\""},{"type":"normal","normal":true,"ln1":406,"ln2":516,"content":" "},{"type":"del","del":true,"ln":407,"content":"-  ReadRegStr $2 SHCTX \"$0\\http\\shell\\open\\command\" \"\""},{"type":"del","del":true,"ln":408,"content":"-  ClearErrors"},{"type":"del","del":true,"ln":409,"content":"-  ${WordFind} \"$2\" \"${FileMainEXE}\" \"E+1{\" $R1"},{"type":"del","del":true,"ln":410,"content":"-  ${Unless} ${Errors}"},{"type":"del","del":true,"ln":411,"content":"-    ${AddHandlerValues} \"$0\\http\" \"$1\" \"$8,1\" \"\" \"\" \"true\""},{"type":"del","del":true,"ln":412,"content":"-  ${EndUnless}"},{"type":"add","add":true,"ln":517,"content":"+  ; Remove support for launching chrome urls from the shell during install or"},{"type":"add","add":true,"ln":518,"content":"+  ; update if the DefaultIcon is from firefox.exe (Bug 301073)."},{"type":"add","add":true,"ln":519,"content":"+  ${RegCleanAppHandler} \"chrome\""},{"type":"normal","normal":true,"ln1":413,"ln2":520,"content":" "},{"type":"del","del":true,"ln":414,"content":"-  ReadRegStr $2 SHCTX \"$0\\https\\shell\\open\\command\" \"\""},{"type":"del","del":true,"ln":415,"content":"-  ClearErrors"},{"type":"del","del":true,"ln":416,"content":"-  ${WordFind} \"$2\" \"${FileMainEXE}\" \"E+1{\" $R1"},{"type":"del","del":true,"ln":417,"content":"-  ${Unless} ${Errors}"},{"type":"del","del":true,"ln":418,"content":"-    ${AddHandlerValues} \"$0\\https\" \"$1\" \"$8,1\" \"\" \"\" \"true\""},{"type":"del","del":true,"ln":419,"content":"-  ${EndUnless}"},{"type":"add","add":true,"ln":521,"content":"+  ; Remove protocol handler registry keys added by the MS shim"},{"type":"add","add":true,"ln":522,"content":"+  DeleteRegKey HKLM \"Software\\Classes\\Firefox.URL\""},{"type":"add","add":true,"ln":523,"content":"+  DeleteRegKey HKCU \"Software\\Classes\\Firefox.URL\""},{"type":"normal","normal":true,"ln1":420,"ln2":524,"content":" "},{"type":"del","del":true,"ln":421,"content":"-  ReadRegStr $2 SHCTX \"$0\\ftp\\shell\\open\\command\" \"\""},{"type":"del","del":true,"ln":422,"content":"-  ClearErrors"},{"type":"del","del":true,"ln":423,"content":"-  ${WordFind} \"$2\" \"${FileMainEXE}\" \"E+1{\" $R1"},{"type":"del","del":true,"ln":424,"content":"-  ${Unless} ${Errors}"},{"type":"del","del":true,"ln":425,"content":"-    ${AddHandlerValues} \"$0\\ftp\" \"$1\" \"$8,1\" \"\" \"\" \"true\""},{"type":"del","del":true,"ln":426,"content":"-  ${EndUnless}"},{"type":"add","add":true,"ln":525,"content":"+  ; Remove the app compatibility registry key"},{"type":"add","add":true,"ln":526,"content":"+  StrCpy $0 \"Software\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\Layers\""},{"type":"add","add":true,"ln":527,"content":"+  DeleteRegValue HKLM \"$0\" \"$INSTDIR\\${FileMainEXE}\""},{"type":"add","add":true,"ln":528,"content":"+  DeleteRegValue HKCU \"$0\" \"$INSTDIR\\${FileMainEXE}\""},{"type":"normal","normal":true,"ln1":427,"ln2":529,"content":" "},{"type":"del","del":true,"ln":428,"content":"-  ; Remove the gopher key if the DefaultIcon is from firefox.exe."},{"type":"del","del":true,"ln":429,"content":"-  ReadRegStr $2 SHCTX \"$0\\gopher\\DefaultIcon\" \"\""},{"type":"add","add":true,"ln":530,"content":"+  ; Delete gopher from Capabilities\\URLAssociations if it is present."},{"type":"add","add":true,"ln":531,"content":"+  ${StrFilter} \"${FileMainEXE}\" \"+\" \"\" \"\" $R9"},{"type":"add","add":true,"ln":532,"content":"+  StrCpy $0 \"Software\\Clients\\StartMenuInternet\\$R9\""},{"type":"normal","normal":true,"ln1":430,"ln2":533,"content":"   ClearErrors"},{"type":"del","del":true,"ln":431,"content":"-  ${WordFind} \"$2\" \"${FileMainEXE}\" \"E+1{\" $R1"},{"type":"add","add":true,"ln":534,"content":"+  ReadRegStr $2 HKLM \"$0\\Capabilities\\URLAssociations\" \"gopher\""},{"type":"normal","normal":true,"ln1":432,"ln2":535,"content":"   ${Unless} ${Errors}"},{"type":"del","del":true,"ln":433,"content":"-    DeleteRegKey SHCTX \"$0\\gopher\""},{"type":"add","add":true,"ln":536,"content":"+    DeleteRegValue HKLM \"$0\\Capabilities\\URLAssociations\" \"gopher\""},{"type":"normal","normal":true,"ln1":434,"ln2":537,"content":"   ${EndUnless}"},{"type":"normal","normal":true,"ln1":435,"ln2":538,"content":" "},{"type":"del","del":true,"ln":436,"content":"-  ; Remove protocol handler registry keys added by the MS shim"},{"type":"del","del":true,"ln":437,"content":"-  DeleteRegKey HKLM \"Software\\Classes\\Firefox.URL\""},{"type":"add","add":true,"ln":539,"content":"+  ; Delete gopher from the user's UrlAssociations if it points to FirefoxURL."},{"type":"add","add":true,"ln":540,"content":"+  StrCpy $0 \"Software\\Microsoft\\Windows\\Shell\\Associations\\UrlAssociations\\gopher\""},{"type":"add","add":true,"ln":541,"content":"+  ReadRegStr $2 HKCU \"$0\\UserChoice\" \"Progid\""},{"type":"add","add":true,"ln":542,"content":"+  ${If} $2 == \"FirefoxURL\""},{"type":"add","add":true,"ln":543,"content":"+    DeleteRegKey HKCU \"$0\""},{"type":"add","add":true,"ln":544,"content":"+  ${EndIf}"},{"type":"normal","normal":true,"ln1":438,"ln2":545,"content":" !macroend"},{"type":"del","del":true,"ln":439,"content":"-!define FixClassKeys \"!insertmacro FixClassKeys\""},{"type":"add","add":true,"ln":546,"content":"+!define RemoveDeprecatedKeys \"!insertmacro RemoveDeprecatedKeys\""}],"oldStart":344,"oldLines":96,"newStart":437,"newLines":110}],"deletions":132,"additions":239,"from":"browser/installer/windows/nsis/shared.nsh","to":"browser/installer/windows/nsis/shared.nsh","index":["ef3f689..41d81d8","100755"]},{"chunks":[{"content":"@@ -35,7 +35,9 @@","changes":[{"type":"normal","normal":true,"ln1":35,"ln2":35,"content":" # ***** END LICENSE BLOCK *****"},{"type":"normal","normal":true,"ln1":36,"ln2":36,"content":" "},{"type":"normal","normal":true,"ln1":37,"ln2":37,"content":" # Required Plugins:"},{"type":"del","del":true,"ln":38,"content":"-# ShellLink plugin http://nsis.sourceforge.net/ShellLink_plug-in"},{"type":"add","add":true,"ln":38,"content":"+# SetVistaDefaultApp http://nsis.sourceforge.net/SetVistaDefaultApp_plug-in"},{"type":"add","add":true,"ln":39,"content":"+# ShellLink          http://nsis.sourceforge.net/ShellLink_plug-in"},{"type":"add","add":true,"ln":40,"content":"+# UAC                http://nsis.sourceforge.net/UAC_plug-in"},{"type":"normal","normal":true,"ln1":39,"ln2":41,"content":" "},{"type":"normal","normal":true,"ln1":40,"ln2":42,"content":" ; Set verbosity to 3 (e.g. no script) to lessen the noise in the build logs"},{"type":"normal","normal":true,"ln1":41,"ln2":43,"content":" !verbose 3"}],"oldStart":35,"oldLines":7,"newStart":35,"newLines":9},{"content":"@@ -48,6 +50,9 @@ CRCCheck on","changes":[{"type":"normal","normal":true,"ln1":48,"ln2":50,"content":" "},{"type":"normal","normal":true,"ln1":49,"ln2":51,"content":" !addplugindir ./"},{"type":"normal","normal":true,"ln1":50,"ln2":52,"content":" "},{"type":"add","add":true,"ln":53,"content":"+; USE_UAC_PLUGIN is temporary until Thunderbird has been updated to use the UAC plugin"},{"type":"add","add":true,"ln":54,"content":"+!define USE_UAC_PLUGIN"},{"type":"add","add":true,"ln":55,"content":"+"},{"type":"normal","normal":true,"ln1":51,"ln2":56,"content":" ; prevents compiling of the reg write logging."},{"type":"normal","normal":true,"ln1":52,"ln2":57,"content":" !define NO_LOG"},{"type":"normal","normal":true,"ln1":53,"ln2":58,"content":" "}],"oldStart":48,"oldLines":6,"newStart":50,"newLines":9},{"content":"@@ -67,14 +72,13 @@ Var TmpVal","changes":[{"type":"normal","normal":true,"ln1":67,"ln2":72,"content":" ; available."},{"type":"normal","normal":true,"ln1":68,"ln2":73,"content":" !include /NONFATAL WinVer.nsh"},{"type":"normal","normal":true,"ln1":69,"ln2":74,"content":" !ifdef ___WINVER__NSH___"},{"type":"del","del":true,"ln":70,"content":"-  RequestExecutionLevel admin"},{"type":"add","add":true,"ln":75,"content":"+  RequestExecutionLevel user"},{"type":"normal","normal":true,"ln1":71,"ln2":76,"content":" !else"},{"type":"normal","normal":true,"ln1":72,"ln2":77,"content":"   !warning \"Uninstaller will be created without Vista compatibility.$\\n            \\"},{"type":"normal","normal":true,"ln1":73,"ln2":78,"content":"             Upgrade your NSIS installation to at least version 2.22 to resolve.\""},{"type":"normal","normal":true,"ln1":74,"ln2":79,"content":" !endif"},{"type":"normal","normal":true,"ln1":75,"ln2":80,"content":" "},{"type":"normal","normal":true,"ln1":76,"ln2":81,"content":" !insertmacro StrFilter"},{"type":"del","del":true,"ln":77,"content":"-!insertmacro WordFind"},{"type":"normal","normal":true,"ln1":78,"ln2":82,"content":" !insertmacro WordReplace"},{"type":"normal","normal":true,"ln1":79,"ln2":83,"content":" "},{"type":"normal","normal":true,"ln1":80,"ln2":84,"content":" !insertmacro un.GetParent"}],"oldStart":67,"oldLines":14,"newStart":72,"newLines":13},{"content":"@@ -92,9 +96,12 @@ Var TmpVal","changes":[{"type":"normal","normal":true,"ln1":92,"ln2":96,"content":" ; post update cleanup."},{"type":"normal","normal":true,"ln1":93,"ln2":97,"content":" VIAddVersionKey \"FileDescription\" \"${BrandShortName} Helper\""},{"type":"normal","normal":true,"ln1":94,"ln2":98,"content":" "},{"type":"del","del":true,"ln":95,"content":"-!insertmacro AddHandlerValues"},{"type":"add","add":true,"ln":99,"content":"+!insertmacro AddDDEHandlerValues"},{"type":"normal","normal":true,"ln1":96,"ln2":100,"content":" !insertmacro CleanVirtualStore"},{"type":"normal","normal":true,"ln1":97,"ln2":101,"content":" !insertmacro GetLongPath"},{"type":"add","add":true,"ln":102,"content":"+!insertmacro GetPathFromString"},{"type":"add","add":true,"ln":103,"content":"+!insertmacro IsHandlerForInstallDir"},{"type":"add","add":true,"ln":104,"content":"+!insertmacro RegCleanAppHandler"},{"type":"normal","normal":true,"ln1":98,"ln2":105,"content":" !insertmacro RegCleanMain"},{"type":"normal","normal":true,"ln1":99,"ln2":106,"content":" !insertmacro RegCleanUninstall"},{"type":"normal","normal":true,"ln1":100,"ln2":107,"content":" !insertmacro WriteRegDWORD2"}],"oldStart":92,"oldLines":9,"newStart":96,"newLines":12},{"content":"@@ -105,8 +112,11 @@ VIAddVersionKey \"FileDescription\" \"${BrandShortName} Helper\"","changes":[{"type":"normal","normal":true,"ln1":105,"ln2":112,"content":" !insertmacro un.GetSecondInstallPath"},{"type":"normal","normal":true,"ln1":106,"ln2":113,"content":" !insertmacro un.ManualCloseAppPrompt"},{"type":"normal","normal":true,"ln1":107,"ln2":114,"content":" !insertmacro un.ParseUninstallLog"},{"type":"add","add":true,"ln":115,"content":"+!insertmacro un.RegCleanAppHandler"},{"type":"add","add":true,"ln":116,"content":"+!insertmacro un.RegCleanFileHandler"},{"type":"normal","normal":true,"ln1":108,"ln2":117,"content":" !insertmacro un.RegCleanMain"},{"type":"normal","normal":true,"ln1":109,"ln2":118,"content":" !insertmacro un.RegCleanUninstall"},{"type":"add","add":true,"ln":119,"content":"+!insertmacro un.RegCleanProtocolHandler"},{"type":"normal","normal":true,"ln1":110,"ln2":120,"content":" !insertmacro un.RemoveQuotesFromPath"},{"type":"normal","normal":true,"ln1":111,"ln2":121,"content":" "},{"type":"normal","normal":true,"ln1":112,"ln2":122,"content":" !include shared.nsh"}],"oldStart":105,"oldLines":8,"newStart":112,"newLines":11},{"content":"@@ -152,13 +162,13 @@ ShowUnInstDetails nevershow","changes":[{"type":"normal","normal":true,"ln1":152,"ln2":162,"content":" !insertmacro MUI_UNPAGE_INSTFILES"},{"type":"normal","normal":true,"ln1":153,"ln2":163,"content":" "},{"type":"normal","normal":true,"ln1":154,"ln2":164,"content":" ; Finish Page"},{"type":"del","del":true,"ln":155,"content":"-!define MUI_PAGE_CUSTOMFUNCTION_PRE un.preFinish"},{"type":"del","del":true,"ln":156,"content":"-!define MUI_FINISHPAGE_SHOWREADME_NOTCHECKED"},{"type":"del","del":true,"ln":157,"content":"-!define MUI_FINISHPAGE_SHOWREADME \"\""},{"type":"normal","normal":true,"ln1":158,"ln2":165,"content":" "},{"type":"del","del":true,"ln":159,"content":"-; Setup the survey controls, functions, etc. except when the application has"},{"type":"add","add":true,"ln":166,"content":"+; Don't setup the survey controls, functions, etc. when the application has"},{"type":"normal","normal":true,"ln1":160,"ln2":167,"content":" ; defined NO_UNINSTALL_SURVEY"},{"type":"normal","normal":true,"ln1":161,"ln2":168,"content":" !ifndef NO_UNINSTALL_SURVEY"},{"type":"add","add":true,"ln":169,"content":"+!define MUI_PAGE_CUSTOMFUNCTION_PRE un.preFinish"},{"type":"add","add":true,"ln":170,"content":"+!define MUI_FINISHPAGE_SHOWREADME_NOTCHECKED"},{"type":"add","add":true,"ln":171,"content":"+!define MUI_FINISHPAGE_SHOWREADME \"\""},{"type":"normal","normal":true,"ln1":162,"ln2":172,"content":" !define MUI_FINISHPAGE_SHOWREADME_TEXT $(SURVEY_TEXT)"},{"type":"normal","normal":true,"ln1":163,"ln2":173,"content":" !define MUI_FINISHPAGE_SHOWREADME_FUNCTION un.Survey"},{"type":"normal","normal":true,"ln1":164,"ln2":174,"content":" !endif"}],"oldStart":152,"oldLines":13,"newStart":162,"newLines":13},{"content":"@@ -191,16 +201,39 @@ Section \"Uninstall\"","changes":[{"type":"normal","normal":true,"ln1":191,"ln2":201,"content":"     ClearErrors"},{"type":"normal","normal":true,"ln1":192,"ln2":202,"content":"   ${EndIf}"},{"type":"normal","normal":true,"ln1":193,"ln2":203,"content":" "},{"type":"del","del":true,"ln":194,"content":"-  ; Remove registry entries for non-existent apps and for apps that point to our"},{"type":"del","del":true,"ln":195,"content":"-  ; install location in the Software\\Mozilla key and uninstall registry entries"},{"type":"del","del":true,"ln":196,"content":"-  ; that point to our install location for both HKCU and HKLM."},{"type":"del","del":true,"ln":197,"content":"-  SetShellVarContext current  ; Sets SHCTX to HKCU"},{"type":"add","add":true,"ln":204,"content":"+  SetShellVarContext current  ; Set SHCTX to HKCU"},{"type":"normal","normal":true,"ln1":198,"ln2":205,"content":"   ${un.RegCleanMain} \"Software\\Mozilla\""},{"type":"normal","normal":true,"ln1":199,"ln2":206,"content":"   ${un.RegCleanUninstall}"},{"type":"normal","normal":true,"ln1":200,"ln2":207,"content":" "},{"type":"del","del":true,"ln":201,"content":"-  SetShellVarContext all  ; Sets SHCTX to HKLM"},{"type":"del","del":true,"ln":202,"content":"-  ${un.RegCleanMain} \"Software\\Mozilla\""},{"type":"del","del":true,"ln":203,"content":"-  ${un.RegCleanUninstall}"},{"type":"add","add":true,"ln":208,"content":"+  ClearErrors"},{"type":"add","add":true,"ln":209,"content":"+  WriteRegStr HKLM \"Software\\Mozilla\\InstallerTest\" \"InstallerTest\" \"Test\""},{"type":"add","add":true,"ln":210,"content":"+  ${If} ${Errors}"},{"type":"add","add":true,"ln":211,"content":"+    StrCpy $TmpVal \"HKCU\" ; used primarily for logging"},{"type":"add","add":true,"ln":212,"content":"+  ${Else}"},{"type":"add","add":true,"ln":213,"content":"+    SetShellVarContext all  ; Set SHCTX to HKLM"},{"type":"add","add":true,"ln":214,"content":"+    DeleteRegKey HKLM \"Software\\Mozilla\\InstallerTest\""},{"type":"add","add":true,"ln":215,"content":"+    StrCpy $TmpVal \"HKLM\" ; used primarily for logging"},{"type":"add","add":true,"ln":216,"content":"+    ${un.RegCleanMain} \"Software\\Mozilla\""},{"type":"add","add":true,"ln":217,"content":"+    ${un.RegCleanUninstall}"},{"type":"add","add":true,"ln":218,"content":"+  ${EndIf}"},{"type":"add","add":true,"ln":219,"content":"+"},{"type":"add","add":true,"ln":220,"content":"+  ${un.RegCleanAppHandler} \"FirefoxURL\""},{"type":"add","add":true,"ln":221,"content":"+  ${un.RegCleanAppHandler} \"FirefoxHTML\""},{"type":"add","add":true,"ln":222,"content":"+  ${un.RegCleanProtocolHandler} \"ftp\""},{"type":"add","add":true,"ln":223,"content":"+  ${un.RegCleanProtocolHandler} \"http\""},{"type":"add","add":true,"ln":224,"content":"+  ${un.RegCleanProtocolHandler} \"https\""},{"type":"add","add":true,"ln":225,"content":"+"},{"type":"add","add":true,"ln":226,"content":"+  ClearErrors"},{"type":"add","add":true,"ln":227,"content":"+  ReadRegStr $R9 HKCR \"FirefoxHTML\" \"\""},{"type":"add","add":true,"ln":228,"content":"+  ; Don't clean up the file handlers if the FirefoxHTML key still exists since"},{"type":"add","add":true,"ln":229,"content":"+  ; there should be a second installation that may be the default file handler"},{"type":"add","add":true,"ln":230,"content":"+  ${If} ${Errors}"},{"type":"add","add":true,"ln":231,"content":"+    ${un.RegCleanFileHandler}  \".htm\"   \"FirefoxHTML\""},{"type":"add","add":true,"ln":232,"content":"+    ${un.RegCleanFileHandler}  \".html\"  \"FirefoxHTML\""},{"type":"add","add":true,"ln":233,"content":"+    ${un.RegCleanFileHandler}  \".shtml\" \"FirefoxHTML\""},{"type":"add","add":true,"ln":234,"content":"+    ${un.RegCleanFileHandler}  \".xht\"   \"FirefoxHTML\""},{"type":"add","add":true,"ln":235,"content":"+    ${un.RegCleanFileHandler}  \".xhtml\" \"FirefoxHTML\""},{"type":"add","add":true,"ln":236,"content":"+  ${EndIf}"},{"type":"normal","normal":true,"ln1":204,"ln2":237,"content":" "},{"type":"normal","normal":true,"ln1":205,"ln2":238,"content":"   SetShellVarContext all  ; Set SHCTX to HKLM"},{"type":"normal","normal":true,"ln1":206,"ln2":239,"content":"   ${un.GetSecondInstallPath} \"Software\\Mozilla\" $R9"}],"oldStart":191,"oldLines":16,"newStart":201,"newLines":39},{"content":"@@ -222,9 +255,6 @@ Section \"Uninstall\"","changes":[{"type":"normal","normal":true,"ln1":222,"ln2":255,"content":"   ; default browser. Now the key is always updated on install but it is only"},{"type":"normal","normal":true,"ln1":223,"ln2":256,"content":"   ; removed if it refers to this install location."},{"type":"normal","normal":true,"ln1":224,"ln2":257,"content":"   ${If} \"$INSTDIR\" == \"$R1\""},{"type":"del","del":true,"ln":225,"content":"-    ; XXXrstrong - if there is another installation of the same app ideally we"},{"type":"del","del":true,"ln":226,"content":"-    ; would just modify these values. The GetSecondInstallPath macro could be"},{"type":"del","del":true,"ln":227,"content":"-    ; made to provide enough information to do this."},{"type":"normal","normal":true,"ln1":228,"ln2":258,"content":"     DeleteRegKey HKLM \"Software\\Clients\\StartMenuInternet\\${FileMainEXE}\""},{"type":"normal","normal":true,"ln1":229,"ln2":259,"content":"     DeleteRegValue HKLM \"Software\\RegisteredApplications\" \"${AppRegName}\""},{"type":"normal","normal":true,"ln1":230,"ln2":260,"content":"   ${EndIf}"}],"oldStart":222,"oldLines":9,"newStart":255,"newLines":6},{"content":"@@ -236,8 +266,9 @@ Section \"Uninstall\"","changes":[{"type":"normal","normal":true,"ln1":236,"ln2":266,"content":"     StrCpy $0 \"Software\\Microsoft\\MediaPlayer\\ShimInclusionList\\${FileMainEXE}\""},{"type":"normal","normal":true,"ln1":237,"ln2":267,"content":"     DeleteRegKey HKLM \"$0\""},{"type":"normal","normal":true,"ln1":238,"ln2":268,"content":"     DeleteRegKey HKCU \"$0\""},{"type":"del","del":true,"ln":239,"content":"-    StrCpy $0 \"MIME\\Database\\Content Type\\application/x-xpinstall;app=firefox\""},{"type":"del","del":true,"ln":240,"content":"-    DeleteRegKey HKCR \"$0\""},{"type":"add","add":true,"ln":269,"content":"+    StrCpy $0 \"Software\\Classes\\MIME\\Database\\Content Type\\application/x-xpinstall;app=firefox\""},{"type":"add","add":true,"ln":270,"content":"+    DeleteRegKey HKLM \"$0\""},{"type":"add","add":true,"ln":271,"content":"+    DeleteRegKey HKCU \"$0\""},{"type":"normal","normal":true,"ln1":241,"ln2":272,"content":"   ${Else}"},{"type":"normal","normal":true,"ln1":242,"ln2":273,"content":"     ReadRegStr $R1 HKLM \"$0\" \"\""},{"type":"normal","normal":true,"ln1":243,"ln2":274,"content":"     ${un.RemoveQuotesFromPath} \"$R1\" $R1"}],"oldStart":236,"oldLines":8,"newStart":266,"newLines":9},{"content":"@@ -300,7 +331,7 @@ SectionEnd","changes":[{"type":"normal","normal":true,"ln1":300,"ln2":331,"content":" ################################################################################"},{"type":"normal","normal":true,"ln1":301,"ln2":332,"content":" # Helper Functions"},{"type":"normal","normal":true,"ln1":302,"ln2":333,"content":" "},{"type":"del","del":true,"ln":303,"content":"-; Setup the survey controls, functions, etc. except when the application has"},{"type":"add","add":true,"ln":334,"content":"+; Don't setup the survey controls, functions, etc. when the application has"},{"type":"normal","normal":true,"ln1":304,"ln2":335,"content":" ; defined NO_UNINSTALL_SURVEY"},{"type":"normal","normal":true,"ln1":305,"ln2":336,"content":" !ifndef NO_UNINSTALL_SURVEY"},{"type":"normal","normal":true,"ln1":306,"ln2":337,"content":" Function un.Survey"}],"oldStart":300,"oldLines":7,"newStart":331,"newLines":7},{"content":"@@ -340,12 +371,10 @@ Function un.leaveConfirm","changes":[{"type":"normal","normal":true,"ln1":340,"ln2":371,"content":"   ${EndIf}"},{"type":"normal","normal":true,"ln1":341,"ln2":372,"content":" FunctionEnd"},{"type":"normal","normal":true,"ln1":342,"ln2":373,"content":" "},{"type":"add","add":true,"ln":374,"content":"+!ifndef NO_UNINSTALL_SURVEY"},{"type":"normal","normal":true,"ln1":343,"ln2":375,"content":" Function un.preFinish"},{"type":"normal","normal":true,"ln1":344,"ln2":376,"content":"   ; Do not modify the finish page if there is a reboot pending"},{"type":"normal","normal":true,"ln1":345,"ln2":377,"content":"   ${Unless} ${RebootFlag}"},{"type":"del","del":true,"ln":346,"content":"-!ifdef NO_UNINSTALL_SURVEY"},{"type":"del","del":true,"ln":347,"content":"-    !insertmacro MUI_INSTALLOPTIONS_WRITE \"ioSpecial.ini\" \"settings\" \"NumFields\" \"3\""},{"type":"del","del":true,"ln":348,"content":"-!else"},{"type":"normal","normal":true,"ln1":349,"ln2":378,"content":"     ; Setup the survey controls, functions, etc."},{"type":"normal","normal":true,"ln1":350,"ln2":379,"content":"     StrCpy $TmpVal \"SOFTWARE\\Microsoft\\IE Setup\\Setup\""},{"type":"normal","normal":true,"ln1":351,"ln2":380,"content":"     ClearErrors"}],"oldStart":340,"oldLines":12,"newStart":371,"newLines":10},{"content":"@@ -369,12 +398,13 @@ Function un.preFinish","changes":[{"type":"normal","normal":true,"ln1":369,"ln2":398,"content":"         !insertmacro MUI_INSTALLOPTIONS_WRITE \"ioSpecial.ini\" \"settings\" \"cancelenabled\" \"0\""},{"type":"normal","normal":true,"ln1":370,"ln2":399,"content":"       ${EndIf}"},{"type":"normal","normal":true,"ln1":371,"ln2":400,"content":"     ${EndIf}"},{"type":"del","del":true,"ln":372,"content":"-!endif"},{"type":"normal","normal":true,"ln1":373,"ln2":401,"content":"   ${EndUnless}"},{"type":"normal","normal":true,"ln1":374,"ln2":402,"content":" FunctionEnd"},{"type":"add","add":true,"ln":403,"content":"+!endif"},{"type":"normal","normal":true,"ln1":375,"ln2":404,"content":" "},{"type":"normal","normal":true,"ln1":376,"ln2":405,"content":" ################################################################################"},{"type":"normal","normal":true,"ln1":377,"ln2":406,"content":" # Initialization Functions"},{"type":"add","add":true,"ln":407,"content":"+"},{"type":"normal","normal":true,"ln1":378,"ln2":408,"content":" Function .onInit"},{"type":"normal","normal":true,"ln1":379,"ln2":409,"content":"   ${UninstallOnInitCommon}"},{"type":"normal","normal":true,"ln1":380,"ln2":410,"content":" FunctionEnd"}],"oldStart":369,"oldLines":12,"newStart":398,"newLines":13}],"deletions":25,"additions":55,"from":"browser/installer/windows/nsis/uninstaller.nsi","to":"browser/installer/windows/nsis/uninstaller.nsi","index":["e790fda..4f819ac","100755"]},{"chunks":[],"deletions":0,"additions":0,"from":"other-licenses/7zstub/firefox/7zSD.sfx","to":"other-licenses/7zstub/firefox/7zSD.sfx","index":["8dff92b..65a7ede","100644"]},{"chunks":[],"deletions":0,"additions":0,"from":"/dev/null","to":"toolkit/mozapps/installer/windows/nsis/SetVistaDefaultApp.dll","new":true,"index":["0000000..5735e0a"]},{"chunks":[],"deletions":0,"additions":0,"from":"/dev/null","to":"toolkit/mozapps/installer/windows/nsis/UAC.dll","new":true,"index":["0000000..ff93bfb"]},{"chunks":[{"content":"@@ -1260,6 +1260,7 @@","changes":[{"type":"normal","normal":true,"ln1":1260,"ln2":1260,"content":" "},{"type":"normal","normal":true,"ln1":1261,"ln2":1261,"content":" /**"},{"type":"normal","normal":true,"ln1":1262,"ln2":1262,"content":"  * Writes common registry values for a handler using SHCTX."},{"type":"add","add":true,"ln":1263,"content":"+ *"},{"type":"normal","normal":true,"ln1":1263,"ln2":1264,"content":"  * @param   _KEY"},{"type":"normal","normal":true,"ln1":1264,"ln2":1265,"content":"  *          The subkey in relation to the key root."},{"type":"normal","normal":true,"ln1":1265,"ln2":1266,"content":"  * @param   _VALOPEN"}],"oldStart":1260,"oldLines":6,"newStart":1260,"newLines":7},{"content":"@@ -1397,6 +1398,162 @@","changes":[{"type":"normal","normal":true,"ln1":1397,"ln2":1398,"content":"   !endif"},{"type":"normal","normal":true,"ln1":1398,"ln2":1399,"content":" !macroend"},{"type":"normal","normal":true,"ln1":1399,"ln2":1400,"content":" "},{"type":"add","add":true,"ln":1401,"content":"+/**"},{"type":"add","add":true,"ln":1402,"content":"+ * Writes common registry values for a handler that uses DDE using SHCTX."},{"type":"add","add":true,"ln":1403,"content":"+ *"},{"type":"add","add":true,"ln":1404,"content":"+ * @param   _KEY"},{"type":"add","add":true,"ln":1405,"content":"+ *          The key name in relation to the HKCR root. SOFTWARE\\Classes is"},{"type":"add","add":true,"ln":1406,"content":"+ *          prefixed to this value when using SHCTX."},{"type":"add","add":true,"ln":1407,"content":"+ * @param   _VALOPEN"},{"type":"add","add":true,"ln":1408,"content":"+ *          The path and args to launch the application."},{"type":"add","add":true,"ln":1409,"content":"+ * @param   _VALICON"},{"type":"add","add":true,"ln":1410,"content":"+ *          The path to an exe that contains an icon and the icon resource id."},{"type":"add","add":true,"ln":1411,"content":"+ * @param   _DISPNAME"},{"type":"add","add":true,"ln":1412,"content":"+ *          The display name for the handler. If emtpy no value will be set."},{"type":"add","add":true,"ln":1413,"content":"+ * @param   _ISPROTOCOL"},{"type":"add","add":true,"ln":1414,"content":"+ *          Sets protocol handler specific registry values when \"true\"."},{"type":"add","add":true,"ln":1415,"content":"+ * @param   _DDE_APPNAME"},{"type":"add","add":true,"ln":1416,"content":"+ *          Sets DDE specific registry values when not an empty string."},{"type":"add","add":true,"ln":1417,"content":"+ *"},{"type":"add","add":true,"ln":1418,"content":"+ * $R0 = storage for SOFTWARE\\Classes"},{"type":"add","add":true,"ln":1419,"content":"+ * $R1 = string value of the current registry key path."},{"type":"add","add":true,"ln":1420,"content":"+ * $R2 = _KEY"},{"type":"add","add":true,"ln":1421,"content":"+ * $R3 = _VALOPEN"},{"type":"add","add":true,"ln":1422,"content":"+ * $R4 = _VALICON"},{"type":"add","add":true,"ln":1423,"content":"+ * $R5 = _DISPNAME"},{"type":"add","add":true,"ln":1424,"content":"+ * $R6 = _ISPROTOCOL"},{"type":"add","add":true,"ln":1425,"content":"+ * $R7 = _DDE_APPNAME"},{"type":"add","add":true,"ln":1426,"content":"+ * $R8 = _DDE_DEFAULT"},{"type":"add","add":true,"ln":1427,"content":"+ * $R9 = _DDE_TOPIC"},{"type":"add","add":true,"ln":1428,"content":"+ */"},{"type":"add","add":true,"ln":1429,"content":"+!macro AddDDEHandlerValues"},{"type":"add","add":true,"ln":1430,"content":"+"},{"type":"add","add":true,"ln":1431,"content":"+  !ifndef ${_MOZFUNC_UN}AddDDEHandlerValues"},{"type":"add","add":true,"ln":1432,"content":"+    !verbose push"},{"type":"add","add":true,"ln":1433,"content":"+    !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":1434,"content":"+    !define ${_MOZFUNC_UN}AddDDEHandlerValues \"!insertmacro ${_MOZFUNC_UN}AddDDEHandlerValuesCall\""},{"type":"add","add":true,"ln":1435,"content":"+"},{"type":"add","add":true,"ln":1436,"content":"+    Function ${_MOZFUNC_UN}AddDDEHandlerValues"},{"type":"add","add":true,"ln":1437,"content":"+      Exch $R9"},{"type":"add","add":true,"ln":1438,"content":"+      Exch 1"},{"type":"add","add":true,"ln":1439,"content":"+      Exch $R8"},{"type":"add","add":true,"ln":1440,"content":"+      Exch 2"},{"type":"add","add":true,"ln":1441,"content":"+      Exch $R7"},{"type":"add","add":true,"ln":1442,"content":"+      Exch 3"},{"type":"add","add":true,"ln":1443,"content":"+      Exch $R6"},{"type":"add","add":true,"ln":1444,"content":"+      Exch 4"},{"type":"add","add":true,"ln":1445,"content":"+      Exch $R5"},{"type":"add","add":true,"ln":1446,"content":"+      Exch 5"},{"type":"add","add":true,"ln":1447,"content":"+      Exch $R4"},{"type":"add","add":true,"ln":1448,"content":"+      Exch 6"},{"type":"add","add":true,"ln":1449,"content":"+      Exch $R3"},{"type":"add","add":true,"ln":1450,"content":"+      Exch 7"},{"type":"add","add":true,"ln":1451,"content":"+      Exch $R2"},{"type":"add","add":true,"ln":1452,"content":"+      Push $R1"},{"type":"add","add":true,"ln":1453,"content":"+      Push $R0"},{"type":"add","add":true,"ln":1454,"content":"+"},{"type":"add","add":true,"ln":1455,"content":"+      StrCpy $R0 \"SOFTWARE\\Classes\""},{"type":"add","add":true,"ln":1456,"content":"+      StrCmp \"$R5\" \"\" +6 +1"},{"type":"add","add":true,"ln":1457,"content":"+      ReadRegStr $R1 SHCTX \"$R2\" \"FriendlyTypeName\""},{"type":"add","add":true,"ln":1458,"content":"+"},{"type":"add","add":true,"ln":1459,"content":"+      StrCmp \"$R1\" \"\" +1 +3"},{"type":"add","add":true,"ln":1460,"content":"+      WriteRegStr SHCTX \"$R0\\$R2\" \"\" \"$R5\""},{"type":"add","add":true,"ln":1461,"content":"+      WriteRegStr SHCTX \"$R0\\$R2\" \"FriendlyTypeName\" \"$R5\""},{"type":"add","add":true,"ln":1462,"content":"+"},{"type":"add","add":true,"ln":1463,"content":"+      StrCmp \"$R6\" \"true\" +1 +8"},{"type":"add","add":true,"ln":1464,"content":"+      WriteRegStr SHCTX \"$R0\\$R2\" \"URL Protocol\" \"\""},{"type":"add","add":true,"ln":1465,"content":"+      StrCpy $R1 \"\""},{"type":"add","add":true,"ln":1466,"content":"+      ClearErrors"},{"type":"add","add":true,"ln":1467,"content":"+      ReadRegDWord $R1 SHCTX \"$R0\\$R2\" \"EditFlags\""},{"type":"add","add":true,"ln":1468,"content":"+      StrCmp $R1 \"\" +1 +3  ; Only add EditFlags if a value doesn't exist"},{"type":"add","add":true,"ln":1469,"content":"+      DeleteRegValue SHCTX \"$R0\\$R2\" \"EditFlags\""},{"type":"add","add":true,"ln":1470,"content":"+      WriteRegDWord SHCTX \"$R0\\$R2\" \"EditFlags\" 0x00000002"},{"type":"add","add":true,"ln":1471,"content":"+      "},{"type":"add","add":true,"ln":1472,"content":"+      StrCmp \"$R4\" \"\" +2 +1"},{"type":"add","add":true,"ln":1473,"content":"+      WriteRegStr SHCTX \"$R0\\$R2\\DefaultIcon\" \"\" \"$R4\""},{"type":"add","add":true,"ln":1474,"content":"+"},{"type":"add","add":true,"ln":1475,"content":"+      WriteRegStr SHCTX \"$R0\\$R2\\shell\\open\\command\" \"\" \"$R3\""},{"type":"add","add":true,"ln":1476,"content":"+"},{"type":"add","add":true,"ln":1477,"content":"+      WriteRegStr SHCTX \"$R0\\$R2\\shell\\open\\ddeexec\" \"\" \"$R8\""},{"type":"add","add":true,"ln":1478,"content":"+      WriteRegStr SHCTX \"$R0\\$R2\\shell\\open\\ddeexec\" \"NoActivateHandler\" \"\""},{"type":"add","add":true,"ln":1479,"content":"+      WriteRegStr SHCTX \"$R0\\$R2\\shell\\open\\ddeexec\\Application\" \"\" \"$R7\""},{"type":"add","add":true,"ln":1480,"content":"+      WriteRegStr SHCTX \"$R0\\$R2\\shell\\open\\ddeexec\\Topic\" \"\" \"$R9\""},{"type":"add","add":true,"ln":1481,"content":"+"},{"type":"add","add":true,"ln":1482,"content":"+      ; The ifexec key may have been added by another application so try to"},{"type":"add","add":true,"ln":1483,"content":"+      ; delete it to prevent it from breaking this app's shell integration."},{"type":"add","add":true,"ln":1484,"content":"+      ; Also, IE 6 and below doesn't remove this key when it sets itself as the"},{"type":"add","add":true,"ln":1485,"content":"+      ; default handler and if this key exists IE's shell integration breaks."},{"type":"add","add":true,"ln":1486,"content":"+      DeleteRegKey HKLM \"$R0\\$R2\\shell\\open\\ddeexec\\ifexec\""},{"type":"add","add":true,"ln":1487,"content":"+      DeleteRegKey HKCU \"$R0\\$R2\\shell\\open\\ddeexec\\ifexec\""},{"type":"add","add":true,"ln":1488,"content":"+      ClearErrors"},{"type":"add","add":true,"ln":1489,"content":"+"},{"type":"add","add":true,"ln":1490,"content":"+      Pop $R0"},{"type":"add","add":true,"ln":1491,"content":"+      Pop $R1"},{"type":"add","add":true,"ln":1492,"content":"+      Exch $R2"},{"type":"add","add":true,"ln":1493,"content":"+      Exch 7"},{"type":"add","add":true,"ln":1494,"content":"+      Exch $R3"},{"type":"add","add":true,"ln":1495,"content":"+      Exch 6"},{"type":"add","add":true,"ln":1496,"content":"+      Exch $R4"},{"type":"add","add":true,"ln":1497,"content":"+      Exch 5"},{"type":"add","add":true,"ln":1498,"content":"+      Exch $R5"},{"type":"add","add":true,"ln":1499,"content":"+      Exch 4"},{"type":"add","add":true,"ln":1500,"content":"+      Exch $R6"},{"type":"add","add":true,"ln":1501,"content":"+      Exch 3"},{"type":"add","add":true,"ln":1502,"content":"+      Exch $R7"},{"type":"add","add":true,"ln":1503,"content":"+      Exch 2"},{"type":"add","add":true,"ln":1504,"content":"+      Exch $R8"},{"type":"add","add":true,"ln":1505,"content":"+      Exch 1"},{"type":"add","add":true,"ln":1506,"content":"+      Exch $R9"},{"type":"add","add":true,"ln":1507,"content":"+    FunctionEnd"},{"type":"add","add":true,"ln":1508,"content":"+"},{"type":"add","add":true,"ln":1509,"content":"+    !verbose pop"},{"type":"add","add":true,"ln":1510,"content":"+  !endif"},{"type":"add","add":true,"ln":1511,"content":"+!macroend"},{"type":"add","add":true,"ln":1512,"content":"+"},{"type":"add","add":true,"ln":1513,"content":"+!macro AddDDEHandlerValuesCall _KEY _VALOPEN _VALICON _DISPNAME _ISPROTOCOL _DDE_APPNAME _DDE_DEFAULT _DDE_TOPIC"},{"type":"add","add":true,"ln":1514,"content":"+  !verbose push"},{"type":"add","add":true,"ln":1515,"content":"+  !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":1516,"content":"+  Push \"${_KEY}\""},{"type":"add","add":true,"ln":1517,"content":"+  Push \"${_VALOPEN}\""},{"type":"add","add":true,"ln":1518,"content":"+  Push \"${_VALICON}\""},{"type":"add","add":true,"ln":1519,"content":"+  Push \"${_DISPNAME}\""},{"type":"add","add":true,"ln":1520,"content":"+  Push \"${_ISPROTOCOL}\""},{"type":"add","add":true,"ln":1521,"content":"+  Push \"${_DDE_APPNAME}\""},{"type":"add","add":true,"ln":1522,"content":"+  Push \"${_DDE_DEFAULT}\""},{"type":"add","add":true,"ln":1523,"content":"+  Push \"${_DDE_TOPIC}\""},{"type":"add","add":true,"ln":1524,"content":"+  Call AddDDEHandlerValues"},{"type":"add","add":true,"ln":1525,"content":"+  !verbose pop"},{"type":"add","add":true,"ln":1526,"content":"+!macroend"},{"type":"add","add":true,"ln":1527,"content":"+"},{"type":"add","add":true,"ln":1528,"content":"+!macro un.AddDDEHandlerValuesCall _KEY _VALOPEN _VALICON _DISPNAME _ISPROTOCOL _DDE_APPNAME _DDE_DEFAULT _DDE_TOPIC"},{"type":"add","add":true,"ln":1529,"content":"+  !verbose push"},{"type":"add","add":true,"ln":1530,"content":"+  !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":1531,"content":"+  Push \"${_KEY}\""},{"type":"add","add":true,"ln":1532,"content":"+  Push \"${_VALOPEN}\""},{"type":"add","add":true,"ln":1533,"content":"+  Push \"${_VALICON}\""},{"type":"add","add":true,"ln":1534,"content":"+  Push \"${_DISPNAME}\""},{"type":"add","add":true,"ln":1535,"content":"+  Push \"${_ISPROTOCOL}\""},{"type":"add","add":true,"ln":1536,"content":"+  Push \"${_DDE_APPNAME}\""},{"type":"add","add":true,"ln":1537,"content":"+  Push \"${_DDE_DEFAULT}\""},{"type":"add","add":true,"ln":1538,"content":"+  Push \"${_DDE_TOPIC}\""},{"type":"add","add":true,"ln":1539,"content":"+  Call un.AddDDEHandlerValues"},{"type":"add","add":true,"ln":1540,"content":"+  !verbose pop"},{"type":"add","add":true,"ln":1541,"content":"+!macroend"},{"type":"add","add":true,"ln":1542,"content":"+"},{"type":"add","add":true,"ln":1543,"content":"+!macro un.AddDDEHandlerValues"},{"type":"add","add":true,"ln":1544,"content":"+  !ifndef un.AddDDEHandlerValues"},{"type":"add","add":true,"ln":1545,"content":"+    !verbose push"},{"type":"add","add":true,"ln":1546,"content":"+    !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":1547,"content":"+    !undef _MOZFUNC_UN"},{"type":"add","add":true,"ln":1548,"content":"+    !define _MOZFUNC_UN \"un.\""},{"type":"add","add":true,"ln":1549,"content":"+"},{"type":"add","add":true,"ln":1550,"content":"+    !insertmacro AddDDEHandlerValues"},{"type":"add","add":true,"ln":1551,"content":"+"},{"type":"add","add":true,"ln":1552,"content":"+    !undef _MOZFUNC_UN"},{"type":"add","add":true,"ln":1553,"content":"+    !define _MOZFUNC_UN"},{"type":"add","add":true,"ln":1554,"content":"+    !verbose pop"},{"type":"add","add":true,"ln":1555,"content":"+  !endif"},{"type":"add","add":true,"ln":1556,"content":"+!macroend"},{"type":"normal","normal":true,"ln1":1400,"ln2":1557,"content":" "},{"type":"normal","normal":true,"ln1":1401,"ln2":1558,"content":" ################################################################################"},{"type":"normal","normal":true,"ln1":1402,"ln2":1559,"content":" # Macros for retrieving existing install paths"}],"oldStart":1397,"oldLines":6,"newStart":1398,"newLines":162},{"content":"@@ -2447,6 +2604,356 @@","changes":[{"type":"normal","normal":true,"ln1":2447,"ln2":2604,"content":" !macroend"},{"type":"normal","normal":true,"ln1":2448,"ln2":2605,"content":" "},{"type":"normal","normal":true,"ln1":2449,"ln2":2606,"content":" /**"},{"type":"add","add":true,"ln":2607,"content":"+ * Removes an application specific handler registry key under Software\\Classes"},{"type":"add","add":true,"ln":2608,"content":"+ * for both HKCU and HKLM when its open command refers to this install"},{"type":"add","add":true,"ln":2609,"content":"+ * location or the install location doesn't exist."},{"type":"add","add":true,"ln":2610,"content":"+ *"},{"type":"add","add":true,"ln":2611,"content":"+ * @param   _HANDLER_NAME"},{"type":"add","add":true,"ln":2612,"content":"+ *          The registry name for the handler."},{"type":"add","add":true,"ln":2613,"content":"+ *"},{"type":"add","add":true,"ln":2614,"content":"+ * $R7 = stores the long path to the $INSTDIR"},{"type":"add","add":true,"ln":2615,"content":"+ * $R8 = stores the path to the open command's parent directory"},{"type":"add","add":true,"ln":2616,"content":"+ * $R9 = _HANDLER_NAME"},{"type":"add","add":true,"ln":2617,"content":"+ */"},{"type":"add","add":true,"ln":2618,"content":"+!macro RegCleanAppHandler"},{"type":"add","add":true,"ln":2619,"content":"+"},{"type":"add","add":true,"ln":2620,"content":"+  !ifndef ${_MOZFUNC_UN}RegCleanAppHandler"},{"type":"add","add":true,"ln":2621,"content":"+    !define _MOZFUNC_UN_TMP ${_MOZFUNC_UN}"},{"type":"add","add":true,"ln":2622,"content":"+    !insertmacro ${_MOZFUNC_UN_TMP}GetLongPath"},{"type":"add","add":true,"ln":2623,"content":"+    !insertmacro ${_MOZFUNC_UN_TMP}GetParent"},{"type":"add","add":true,"ln":2624,"content":"+    !insertmacro ${_MOZFUNC_UN_TMP}GetPathFromString"},{"type":"add","add":true,"ln":2625,"content":"+    !undef _MOZFUNC_UN"},{"type":"add","add":true,"ln":2626,"content":"+    !define _MOZFUNC_UN ${_MOZFUNC_UN_TMP}"},{"type":"add","add":true,"ln":2627,"content":"+    !undef _MOZFUNC_UN_TMP"},{"type":"add","add":true,"ln":2628,"content":"+"},{"type":"add","add":true,"ln":2629,"content":"+    !verbose push"},{"type":"add","add":true,"ln":2630,"content":"+    !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":2631,"content":"+    !define ${_MOZFUNC_UN}RegCleanAppHandler \"!insertmacro ${_MOZFUNC_UN}RegCleanAppHandlerCall\""},{"type":"add","add":true,"ln":2632,"content":"+"},{"type":"add","add":true,"ln":2633,"content":"+    Function ${_MOZFUNC_UN}RegCleanAppHandler"},{"type":"add","add":true,"ln":2634,"content":"+      Exch $R9"},{"type":"add","add":true,"ln":2635,"content":"+      Push $R8"},{"type":"add","add":true,"ln":2636,"content":"+      Push $R7"},{"type":"add","add":true,"ln":2637,"content":"+"},{"type":"add","add":true,"ln":2638,"content":"+      ClearErrors"},{"type":"add","add":true,"ln":2639,"content":"+      ReadRegStr $R8 HKCU \"Software\\Classes\\$R9\\shell\\open\\command\" \"\""},{"type":"add","add":true,"ln":2640,"content":"+      IfErrors next +1"},{"type":"add","add":true,"ln":2641,"content":"+      ${${_MOZFUNC_UN}GetPathFromString} \"$R8\" $R8"},{"type":"add","add":true,"ln":2642,"content":"+      ${${_MOZFUNC_UN}GetParent} \"$R8\" $R8"},{"type":"add","add":true,"ln":2643,"content":"+      IfFileExists \"$R8\" +3 +1"},{"type":"add","add":true,"ln":2644,"content":"+      DeleteRegKey HKCU \"Software\\Classes\\$R9\""},{"type":"add","add":true,"ln":2645,"content":"+      GoTo next"},{"type":"add","add":true,"ln":2646,"content":"+"},{"type":"add","add":true,"ln":2647,"content":"+      ${${_MOZFUNC_UN}GetLongPath} \"$R8\" $R8"},{"type":"add","add":true,"ln":2648,"content":"+      ${${_MOZFUNC_UN}GetLongPath} \"$INSTDIR\" $R7"},{"type":"add","add":true,"ln":2649,"content":"+      StrCmp \"$R7\" \"$R8\" +1 next"},{"type":"add","add":true,"ln":2650,"content":"+      DeleteRegKey HKCU \"Software\\Classes\\$R9\""},{"type":"add","add":true,"ln":2651,"content":"+"},{"type":"add","add":true,"ln":2652,"content":"+      next:"},{"type":"add","add":true,"ln":2653,"content":"+      ReadRegStr $R8 HKLM \"Software\\Classes\\$R9\\shell\\open\\command\" \"\""},{"type":"add","add":true,"ln":2654,"content":"+      IfErrors end"},{"type":"add","add":true,"ln":2655,"content":"+      ${${_MOZFUNC_UN}GetPathFromString} \"$R8\" $R8"},{"type":"add","add":true,"ln":2656,"content":"+      ${${_MOZFUNC_UN}GetParent} \"$R8\" $R8"},{"type":"add","add":true,"ln":2657,"content":"+      IfFileExists \"$R8\" +3 +1"},{"type":"add","add":true,"ln":2658,"content":"+      DeleteRegKey HKLM \"Software\\Classes\\$R9\""},{"type":"add","add":true,"ln":2659,"content":"+      GoTo end"},{"type":"add","add":true,"ln":2660,"content":"+"},{"type":"add","add":true,"ln":2661,"content":"+      ${${_MOZFUNC_UN}GetLongPath} \"$R8\" $R8"},{"type":"add","add":true,"ln":2662,"content":"+      ${${_MOZFUNC_UN}GetLongPath} \"$INSTDIR\" $R7"},{"type":"add","add":true,"ln":2663,"content":"+      StrCmp \"$R7\" \"$R8\" +1 end"},{"type":"add","add":true,"ln":2664,"content":"+      DeleteRegKey HKLM \"Software\\Classes\\$R9\""},{"type":"add","add":true,"ln":2665,"content":"+"},{"type":"add","add":true,"ln":2666,"content":"+      end:"},{"type":"add","add":true,"ln":2667,"content":"+"},{"type":"add","add":true,"ln":2668,"content":"+      Pop $R7"},{"type":"add","add":true,"ln":2669,"content":"+      Pop $R8"},{"type":"add","add":true,"ln":2670,"content":"+      Exch $R9"},{"type":"add","add":true,"ln":2671,"content":"+    FunctionEnd"},{"type":"add","add":true,"ln":2672,"content":"+"},{"type":"add","add":true,"ln":2673,"content":"+    !verbose pop"},{"type":"add","add":true,"ln":2674,"content":"+  !endif"},{"type":"add","add":true,"ln":2675,"content":"+!macroend"},{"type":"add","add":true,"ln":2676,"content":"+"},{"type":"add","add":true,"ln":2677,"content":"+!macro RegCleanAppHandlerCall _HANDLER_NAME"},{"type":"add","add":true,"ln":2678,"content":"+  !verbose push"},{"type":"add","add":true,"ln":2679,"content":"+  !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":2680,"content":"+  Push \"${_HANDLER_NAME}\""},{"type":"add","add":true,"ln":2681,"content":"+  Call RegCleanAppHandler"},{"type":"add","add":true,"ln":2682,"content":"+  !verbose pop"},{"type":"add","add":true,"ln":2683,"content":"+!macroend"},{"type":"add","add":true,"ln":2684,"content":"+"},{"type":"add","add":true,"ln":2685,"content":"+!macro un.RegCleanAppHandlerCall _HANDLER_NAME"},{"type":"add","add":true,"ln":2686,"content":"+  !verbose push"},{"type":"add","add":true,"ln":2687,"content":"+  !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":2688,"content":"+  Push \"${_HANDLER_NAME}\""},{"type":"add","add":true,"ln":2689,"content":"+  Call un.RegCleanAppHandler"},{"type":"add","add":true,"ln":2690,"content":"+  !verbose pop"},{"type":"add","add":true,"ln":2691,"content":"+!macroend"},{"type":"add","add":true,"ln":2692,"content":"+"},{"type":"add","add":true,"ln":2693,"content":"+!macro un.RegCleanAppHandler"},{"type":"add","add":true,"ln":2694,"content":"+  !ifndef un.RegCleanAppHandler"},{"type":"add","add":true,"ln":2695,"content":"+    !verbose push"},{"type":"add","add":true,"ln":2696,"content":"+    !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":2697,"content":"+    !undef _MOZFUNC_UN"},{"type":"add","add":true,"ln":2698,"content":"+    !define _MOZFUNC_UN \"un.\""},{"type":"add","add":true,"ln":2699,"content":"+"},{"type":"add","add":true,"ln":2700,"content":"+    !insertmacro RegCleanAppHandler"},{"type":"add","add":true,"ln":2701,"content":"+"},{"type":"add","add":true,"ln":2702,"content":"+    !undef _MOZFUNC_UN"},{"type":"add","add":true,"ln":2703,"content":"+    !define _MOZFUNC_UN"},{"type":"add","add":true,"ln":2704,"content":"+    !verbose pop"},{"type":"add","add":true,"ln":2705,"content":"+  !endif"},{"type":"add","add":true,"ln":2706,"content":"+!macroend"},{"type":"add","add":true,"ln":2707,"content":"+"},{"type":"add","add":true,"ln":2708,"content":"+/**"},{"type":"add","add":true,"ln":2709,"content":"+ * Cleans up the registry for a protocol handler when its open command"},{"type":"add","add":true,"ln":2710,"content":"+ * refers to this install location. For HKCU the registry key is deleted"},{"type":"add","add":true,"ln":2711,"content":"+ * and for HKLM the values set by the application are deleted."},{"type":"add","add":true,"ln":2712,"content":"+ *"},{"type":"add","add":true,"ln":2713,"content":"+ * @param   _HANDLER_NAME"},{"type":"add","add":true,"ln":2714,"content":"+ *          The registry name for the handler."},{"type":"add","add":true,"ln":2715,"content":"+ *"},{"type":"add","add":true,"ln":2716,"content":"+ * $R7 = stores the long path to $INSTDIR"},{"type":"add","add":true,"ln":2717,"content":"+ * $R8 = stores the the long path to the open command's parent directory"},{"type":"add","add":true,"ln":2718,"content":"+ * $R9 = _HANDLER_NAME"},{"type":"add","add":true,"ln":2719,"content":"+ */"},{"type":"add","add":true,"ln":2720,"content":"+!macro un.RegCleanProtocolHandler"},{"type":"add","add":true,"ln":2721,"content":"+"},{"type":"add","add":true,"ln":2722,"content":"+  !ifndef un.RegCleanProtocolHandler"},{"type":"add","add":true,"ln":2723,"content":"+    !insertmacro un.GetLongPath"},{"type":"add","add":true,"ln":2724,"content":"+    !insertmacro un.GetParent"},{"type":"add","add":true,"ln":2725,"content":"+    !insertmacro un.GetPathFromString"},{"type":"add","add":true,"ln":2726,"content":"+"},{"type":"add","add":true,"ln":2727,"content":"+    !verbose push"},{"type":"add","add":true,"ln":2728,"content":"+    !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":2729,"content":"+    !define un.RegCleanProtocolHandler \"!insertmacro un.RegCleanProtocolHandlerCall\""},{"type":"add","add":true,"ln":2730,"content":"+"},{"type":"add","add":true,"ln":2731,"content":"+    Function un.RegCleanProtocolHandler"},{"type":"add","add":true,"ln":2732,"content":"+      Exch $R9"},{"type":"add","add":true,"ln":2733,"content":"+      Push $R8"},{"type":"add","add":true,"ln":2734,"content":"+      Push $R7"},{"type":"add","add":true,"ln":2735,"content":"+"},{"type":"add","add":true,"ln":2736,"content":"+      ReadRegStr $R8 HKCU \"Software\\Classes\\$R9\\shell\\open\\command\" \"\""},{"type":"add","add":true,"ln":2737,"content":"+      ${un.GetLongPath} \"$INSTDIR\" $R7"},{"type":"add","add":true,"ln":2738,"content":"+"},{"type":"add","add":true,"ln":2739,"content":"+      StrCmp \"$R8\" \"\" next +1"},{"type":"add","add":true,"ln":2740,"content":"+      ${un.GetPathFromString} \"$R8\" $R8"},{"type":"add","add":true,"ln":2741,"content":"+      ${un.GetParent} \"$R8\" $R8"},{"type":"add","add":true,"ln":2742,"content":"+      ${un.GetLongPath} \"$R8\" $R8"},{"type":"add","add":true,"ln":2743,"content":"+      StrCmp \"$R7\" \"$R8\" +1 next"},{"type":"add","add":true,"ln":2744,"content":"+      DeleteRegKey HKCU \"Software\\Classes\\$R9\""},{"type":"add","add":true,"ln":2745,"content":"+"},{"type":"add","add":true,"ln":2746,"content":"+      next:"},{"type":"add","add":true,"ln":2747,"content":"+      ReadRegStr $R8 HKLM \"Software\\Classes\\$R9\\shell\\open\\command\" \"\""},{"type":"add","add":true,"ln":2748,"content":"+      StrCmp \"$R8\" \"\" end +1"},{"type":"add","add":true,"ln":2749,"content":"+      ${un.GetLongPath} \"$INSTDIR\" $R7"},{"type":"add","add":true,"ln":2750,"content":"+      ${un.GetPathFromString} \"$R8\" $R8"},{"type":"add","add":true,"ln":2751,"content":"+      ${un.GetParent} \"$R8\" $R8"},{"type":"add","add":true,"ln":2752,"content":"+      ${un.GetLongPath} \"$R8\" $R8"},{"type":"add","add":true,"ln":2753,"content":"+      StrCmp \"$R7\" \"$R8\" +1 end"},{"type":"add","add":true,"ln":2754,"content":"+      DeleteRegValue HKLM \"Software\\Classes\\$R9\\DefaultIcon\" \"\""},{"type":"add","add":true,"ln":2755,"content":"+      DeleteRegValue HKLM \"Software\\Classes\\$R9\\shell\\open\" \"\""},{"type":"add","add":true,"ln":2756,"content":"+      DeleteRegValue HKLM \"Software\\Classes\\$R9\\shell\\ddeexec\" \"\""},{"type":"add","add":true,"ln":2757,"content":"+      DeleteRegValue HKLM \"Software\\Classes\\$R9\\shell\\ddeexec\\Application\" \"\""},{"type":"add","add":true,"ln":2758,"content":"+      DeleteRegValue HKLM \"Software\\Classes\\$R9\\shell\\ddeexec\\Topic\" \"\""},{"type":"add","add":true,"ln":2759,"content":"+"},{"type":"add","add":true,"ln":2760,"content":"+      end:"},{"type":"add","add":true,"ln":2761,"content":"+"},{"type":"add","add":true,"ln":2762,"content":"+      Pop $R7"},{"type":"add","add":true,"ln":2763,"content":"+      Pop $R8"},{"type":"add","add":true,"ln":2764,"content":"+      Exch $R9"},{"type":"add","add":true,"ln":2765,"content":"+    FunctionEnd"},{"type":"add","add":true,"ln":2766,"content":"+"},{"type":"add","add":true,"ln":2767,"content":"+    !verbose pop"},{"type":"add","add":true,"ln":2768,"content":"+  !endif"},{"type":"add","add":true,"ln":2769,"content":"+!macroend"},{"type":"add","add":true,"ln":2770,"content":"+"},{"type":"add","add":true,"ln":2771,"content":"+!macro un.RegCleanProtocolHandlerCall _HANDLER_NAME"},{"type":"add","add":true,"ln":2772,"content":"+  !verbose push"},{"type":"add","add":true,"ln":2773,"content":"+  !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":2774,"content":"+  Push \"${_HANDLER_NAME}\""},{"type":"add","add":true,"ln":2775,"content":"+  Call un.RegCleanProtocolHandler"},{"type":"add","add":true,"ln":2776,"content":"+  !verbose pop"},{"type":"add","add":true,"ln":2777,"content":"+!macroend"},{"type":"add","add":true,"ln":2778,"content":"+"},{"type":"add","add":true,"ln":2779,"content":"+/**"},{"type":"add","add":true,"ln":2780,"content":"+ * Cleans up the registry for a file handler when the passed in value equals"},{"type":"add","add":true,"ln":2781,"content":"+ * the default value for the file handler. For HKCU the registry key is deleted"},{"type":"add","add":true,"ln":2782,"content":"+ * and for HKLM the default value is deleted."},{"type":"add","add":true,"ln":2783,"content":"+ *"},{"type":"add","add":true,"ln":2784,"content":"+ * @param   _HANDLER_NAME"},{"type":"add","add":true,"ln":2785,"content":"+ *          The registry name for the handler."},{"type":"add","add":true,"ln":2786,"content":"+ * @param   _DEFAULT_VALUE"},{"type":"add","add":true,"ln":2787,"content":"+ *          The value to check for against the handler's default value."},{"type":"add","add":true,"ln":2788,"content":"+ *"},{"type":"add","add":true,"ln":2789,"content":"+ * $R6 = stores the long path to $INSTDIR"},{"type":"add","add":true,"ln":2790,"content":"+ * $R7 = _DEFAULT_VALUE"},{"type":"add","add":true,"ln":2791,"content":"+ * $R9 = _HANDLER_NAME"},{"type":"add","add":true,"ln":2792,"content":"+ */"},{"type":"add","add":true,"ln":2793,"content":"+!macro RegCleanFileHandler"},{"type":"add","add":true,"ln":2794,"content":"+"},{"type":"add","add":true,"ln":2795,"content":"+  !ifndef ${_MOZFUNC_UN}RegCleanFileHandler"},{"type":"add","add":true,"ln":2796,"content":"+    !define _MOZFUNC_UN_TMP ${_MOZFUNC_UN}"},{"type":"add","add":true,"ln":2797,"content":"+    !insertmacro ${_MOZFUNC_UN_TMP}GetLongPath"},{"type":"add","add":true,"ln":2798,"content":"+    !insertmacro ${_MOZFUNC_UN_TMP}GetParent"},{"type":"add","add":true,"ln":2799,"content":"+    !insertmacro ${_MOZFUNC_UN_TMP}GetPathFromString"},{"type":"add","add":true,"ln":2800,"content":"+    !undef _MOZFUNC_UN"},{"type":"add","add":true,"ln":2801,"content":"+    !define _MOZFUNC_UN ${_MOZFUNC_UN_TMP}"},{"type":"add","add":true,"ln":2802,"content":"+    !undef _MOZFUNC_UN_TMP"},{"type":"add","add":true,"ln":2803,"content":"+"},{"type":"add","add":true,"ln":2804,"content":"+    !verbose push"},{"type":"add","add":true,"ln":2805,"content":"+    !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":2806,"content":"+    !define ${_MOZFUNC_UN}RegCleanFileHandler \"!insertmacro ${_MOZFUNC_UN}RegCleanFileHandlerCall\""},{"type":"add","add":true,"ln":2807,"content":"+"},{"type":"add","add":true,"ln":2808,"content":"+    Function ${_MOZFUNC_UN}RegCleanFileHandler"},{"type":"add","add":true,"ln":2809,"content":"+      Exch $R9"},{"type":"add","add":true,"ln":2810,"content":"+      Exch 1"},{"type":"add","add":true,"ln":2811,"content":"+      Exch $R8"},{"type":"add","add":true,"ln":2812,"content":"+      Push $R7"},{"type":"add","add":true,"ln":2813,"content":"+"},{"type":"add","add":true,"ln":2814,"content":"+      ReadRegStr $R7 HKCU \"Software\\Classes\\$R9\" \"\""},{"type":"add","add":true,"ln":2815,"content":"+      StrCmp \"$R7\" \"$R8\" +1 +2"},{"type":"add","add":true,"ln":2816,"content":"+      DeleteRegKey HKCU \"Software\\Classes\\$R9\""},{"type":"add","add":true,"ln":2817,"content":"+"},{"type":"add","add":true,"ln":2818,"content":"+      ReadRegStr $R7 HKLM \"Software\\Classes\\$R9\" \"\""},{"type":"add","add":true,"ln":2819,"content":"+      StrCmp \"$R7\" \"$R8\" +1 +2"},{"type":"add","add":true,"ln":2820,"content":"+      DeleteRegValue HKLM \"Software\\Classes\\$R9\" \"\""},{"type":"add","add":true,"ln":2821,"content":"+"},{"type":"add","add":true,"ln":2822,"content":"+      ClearErrors"},{"type":"add","add":true,"ln":2823,"content":"+"},{"type":"add","add":true,"ln":2824,"content":"+      Pop $R7"},{"type":"add","add":true,"ln":2825,"content":"+      Exch $R8"},{"type":"add","add":true,"ln":2826,"content":"+      Exch 1"},{"type":"add","add":true,"ln":2827,"content":"+      Exch $R9"},{"type":"add","add":true,"ln":2828,"content":"+    FunctionEnd"},{"type":"add","add":true,"ln":2829,"content":"+"},{"type":"add","add":true,"ln":2830,"content":"+    !verbose pop"},{"type":"add","add":true,"ln":2831,"content":"+  !endif"},{"type":"add","add":true,"ln":2832,"content":"+!macroend"},{"type":"add","add":true,"ln":2833,"content":"+"},{"type":"add","add":true,"ln":2834,"content":"+!macro RegCleanFileHandlerCall _HANDLER_NAME _DEFAULT_VALUE"},{"type":"add","add":true,"ln":2835,"content":"+  !verbose push"},{"type":"add","add":true,"ln":2836,"content":"+  !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":2837,"content":"+  Push \"${_DEFAULT_VALUE}\""},{"type":"add","add":true,"ln":2838,"content":"+  Push \"${_HANDLER_NAME}\""},{"type":"add","add":true,"ln":2839,"content":"+  Call RegCleanFileHandler"},{"type":"add","add":true,"ln":2840,"content":"+  !verbose pop"},{"type":"add","add":true,"ln":2841,"content":"+!macroend"},{"type":"add","add":true,"ln":2842,"content":"+"},{"type":"add","add":true,"ln":2843,"content":"+!macro un.RegCleanFileHandlerCall _HANDLER_NAME _DEFAULT_VALUE"},{"type":"add","add":true,"ln":2844,"content":"+  !verbose push"},{"type":"add","add":true,"ln":2845,"content":"+  !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":2846,"content":"+  Push \"${_DEFAULT_VALUE}\""},{"type":"add","add":true,"ln":2847,"content":"+  Push \"${_HANDLER_NAME}\""},{"type":"add","add":true,"ln":2848,"content":"+  Call un.RegCleanFileHandler"},{"type":"add","add":true,"ln":2849,"content":"+  !verbose pop"},{"type":"add","add":true,"ln":2850,"content":"+!macroend"},{"type":"add","add":true,"ln":2851,"content":"+"},{"type":"add","add":true,"ln":2852,"content":"+!macro un.RegCleanFileHandler"},{"type":"add","add":true,"ln":2853,"content":"+  !ifndef un.RegCleanFileHandler"},{"type":"add","add":true,"ln":2854,"content":"+    !verbose push"},{"type":"add","add":true,"ln":2855,"content":"+    !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":2856,"content":"+    !undef _MOZFUNC_UN"},{"type":"add","add":true,"ln":2857,"content":"+    !define _MOZFUNC_UN \"un.\""},{"type":"add","add":true,"ln":2858,"content":"+"},{"type":"add","add":true,"ln":2859,"content":"+    !insertmacro RegCleanFileHandler"},{"type":"add","add":true,"ln":2860,"content":"+"},{"type":"add","add":true,"ln":2861,"content":"+    !undef _MOZFUNC_UN"},{"type":"add","add":true,"ln":2862,"content":"+    !define _MOZFUNC_UN"},{"type":"add","add":true,"ln":2863,"content":"+    !verbose pop"},{"type":"add","add":true,"ln":2864,"content":"+  !endif"},{"type":"add","add":true,"ln":2865,"content":"+!macroend"},{"type":"add","add":true,"ln":2866,"content":"+"},{"type":"add","add":true,"ln":2867,"content":"+/**"},{"type":"add","add":true,"ln":2868,"content":"+ * Checks if a handler's open command points to this installation directory."},{"type":"add","add":true,"ln":2869,"content":"+ *"},{"type":"add","add":true,"ln":2870,"content":"+ * @param   _HANDLER_NAME"},{"type":"add","add":true,"ln":2871,"content":"+ *          The registry name for the handler."},{"type":"add","add":true,"ln":2872,"content":"+ * @param   _RESULT"},{"type":"add","add":true,"ln":2873,"content":"+ *          true if it is the handler's open command points to this"},{"type":"add","add":true,"ln":2874,"content":"+ *          installation directory and false if it does not."},{"type":"add","add":true,"ln":2875,"content":"+ *"},{"type":"add","add":true,"ln":2876,"content":"+ * $R7 = stores the value of the open command and the path macros return values"},{"type":"add","add":true,"ln":2877,"content":"+ * $R8 = stores the handler's registry key name"},{"type":"add","add":true,"ln":2878,"content":"+ * $R9 = _DEFAULT_VALUE and _RESULT"},{"type":"add","add":true,"ln":2879,"content":"+ */"},{"type":"add","add":true,"ln":2880,"content":"+!macro IsHandlerForInstallDir"},{"type":"add","add":true,"ln":2881,"content":"+"},{"type":"add","add":true,"ln":2882,"content":"+  !ifndef ${_MOZFUNC_UN}IsHandlerForInstallDir"},{"type":"add","add":true,"ln":2883,"content":"+    !define _MOZFUNC_UN_TMP ${_MOZFUNC_UN}"},{"type":"add","add":true,"ln":2884,"content":"+    !insertmacro ${_MOZFUNC_UN_TMP}GetLongPath"},{"type":"add","add":true,"ln":2885,"content":"+    !insertmacro ${_MOZFUNC_UN_TMP}GetParent"},{"type":"add","add":true,"ln":2886,"content":"+    !insertmacro ${_MOZFUNC_UN_TMP}GetPathFromString"},{"type":"add","add":true,"ln":2887,"content":"+    !undef _MOZFUNC_UN"},{"type":"add","add":true,"ln":2888,"content":"+    !define _MOZFUNC_UN ${_MOZFUNC_UN_TMP}"},{"type":"add","add":true,"ln":2889,"content":"+    !undef _MOZFUNC_UN_TMP"},{"type":"add","add":true,"ln":2890,"content":"+"},{"type":"add","add":true,"ln":2891,"content":"+    !verbose push"},{"type":"add","add":true,"ln":2892,"content":"+    !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":2893,"content":"+    !define ${_MOZFUNC_UN}IsHandlerForInstallDir \"!insertmacro ${_MOZFUNC_UN}IsHandlerForInstallDirCall\""},{"type":"add","add":true,"ln":2894,"content":"+"},{"type":"add","add":true,"ln":2895,"content":"+    Function ${_MOZFUNC_UN}IsHandlerForInstallDir"},{"type":"add","add":true,"ln":2896,"content":"+      Exch $R9"},{"type":"add","add":true,"ln":2897,"content":"+      Push $R8"},{"type":"add","add":true,"ln":2898,"content":"+      Push $R7"},{"type":"add","add":true,"ln":2899,"content":"+"},{"type":"add","add":true,"ln":2900,"content":"+      StrCpy $R8 \"$R9\""},{"type":"add","add":true,"ln":2901,"content":"+      StrCpy $R9 \"false\""},{"type":"add","add":true,"ln":2902,"content":"+      ReadRegStr $R7 HKCR \"$R8\\shell\\open\\command\" \"\""},{"type":"add","add":true,"ln":2903,"content":"+      StrCmp \"$R7\" \"\" end"},{"type":"add","add":true,"ln":2904,"content":"+"},{"type":"add","add":true,"ln":2905,"content":"+      ${GetPathFromString} \"$R7\" $R7"},{"type":"add","add":true,"ln":2906,"content":"+      ${GetParent} \"$R7\" $R7"},{"type":"add","add":true,"ln":2907,"content":"+      ${GetLongPath} \"$R7\" $R7"},{"type":"add","add":true,"ln":2908,"content":"+      StrCmp \"$R7\" \"$INSTDIR\" +1 end"},{"type":"add","add":true,"ln":2909,"content":"+      StrCpy $R9 \"true\""},{"type":"add","add":true,"ln":2910,"content":"+"},{"type":"add","add":true,"ln":2911,"content":"+      end:"},{"type":"add","add":true,"ln":2912,"content":"+      ClearErrors"},{"type":"add","add":true,"ln":2913,"content":"+"},{"type":"add","add":true,"ln":2914,"content":"+      Pop $R7"},{"type":"add","add":true,"ln":2915,"content":"+      Pop $R8"},{"type":"add","add":true,"ln":2916,"content":"+      Exch $R9"},{"type":"add","add":true,"ln":2917,"content":"+    FunctionEnd"},{"type":"add","add":true,"ln":2918,"content":"+"},{"type":"add","add":true,"ln":2919,"content":"+    !verbose pop"},{"type":"add","add":true,"ln":2920,"content":"+  !endif"},{"type":"add","add":true,"ln":2921,"content":"+!macroend"},{"type":"add","add":true,"ln":2922,"content":"+"},{"type":"add","add":true,"ln":2923,"content":"+!macro IsHandlerForInstallDirCall _HANDLER_NAME _RESULT"},{"type":"add","add":true,"ln":2924,"content":"+  !verbose push"},{"type":"add","add":true,"ln":2925,"content":"+  !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":2926,"content":"+  Push \"${_HANDLER_NAME}\""},{"type":"add","add":true,"ln":2927,"content":"+  Call IsHandlerForInstallDir"},{"type":"add","add":true,"ln":2928,"content":"+  Pop \"${_RESULT}\""},{"type":"add","add":true,"ln":2929,"content":"+  !verbose pop"},{"type":"add","add":true,"ln":2930,"content":"+!macroend"},{"type":"add","add":true,"ln":2931,"content":"+"},{"type":"add","add":true,"ln":2932,"content":"+!macro un.IsHandlerForInstallDirCall _HANDLER_NAME _RESULT"},{"type":"add","add":true,"ln":2933,"content":"+  !verbose push"},{"type":"add","add":true,"ln":2934,"content":"+  !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":2935,"content":"+  Push \"${_HANDLER_NAME}\""},{"type":"add","add":true,"ln":2936,"content":"+  Call un.IsHandlerForInstallDir"},{"type":"add","add":true,"ln":2937,"content":"+  Pop \"${_RESULT}\""},{"type":"add","add":true,"ln":2938,"content":"+  !verbose pop"},{"type":"add","add":true,"ln":2939,"content":"+!macroend"},{"type":"add","add":true,"ln":2940,"content":"+"},{"type":"add","add":true,"ln":2941,"content":"+!macro un.IsHandlerForInstallDir"},{"type":"add","add":true,"ln":2942,"content":"+  !ifndef un.IsHandlerForInstallDir"},{"type":"add","add":true,"ln":2943,"content":"+    !verbose push"},{"type":"add","add":true,"ln":2944,"content":"+    !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":2945,"content":"+    !undef _MOZFUNC_UN"},{"type":"add","add":true,"ln":2946,"content":"+    !define _MOZFUNC_UN \"un.\""},{"type":"add","add":true,"ln":2947,"content":"+"},{"type":"add","add":true,"ln":2948,"content":"+    !insertmacro IsHandlerForInstallDir"},{"type":"add","add":true,"ln":2949,"content":"+"},{"type":"add","add":true,"ln":2950,"content":"+    !undef _MOZFUNC_UN"},{"type":"add","add":true,"ln":2951,"content":"+    !define _MOZFUNC_UN"},{"type":"add","add":true,"ln":2952,"content":"+    !verbose pop"},{"type":"add","add":true,"ln":2953,"content":"+  !endif"},{"type":"add","add":true,"ln":2954,"content":"+!macroend"},{"type":"add","add":true,"ln":2955,"content":"+"},{"type":"add","add":true,"ln":2956,"content":"+/**"},{"type":"normal","normal":true,"ln1":2450,"ln2":2957,"content":"  * If present removes the VirtualStore directory for this installation. Uses the"},{"type":"normal","normal":true,"ln1":2451,"ln2":2958,"content":"  * program files directory path and the current install location to determine"},{"type":"normal","normal":true,"ln1":2452,"ln2":2959,"content":"  * the sub-directory in the VirtualStore directory."}],"oldStart":2447,"oldLines":6,"newStart":2604,"newLines":356},{"content":"@@ -2858,6 +3365,7 @@","changes":[{"type":"normal","normal":true,"ln1":2858,"ln2":3365,"content":"       Push $R2"},{"type":"normal","normal":true,"ln1":2859,"ln2":3366,"content":"       Push $R1"},{"type":"normal","normal":true,"ln1":2860,"ln2":3367,"content":"       Push $R0"},{"type":"add","add":true,"ln":3368,"content":"+      Push $TmpVal"},{"type":"normal","normal":true,"ln1":2861,"ln2":3369,"content":" "},{"type":"normal","normal":true,"ln1":2862,"ln2":3370,"content":"       IfFileExists \"$INSTDIR\\uninstall\\uninstall.log\" +1 end"},{"type":"normal","normal":true,"ln1":2863,"ln2":3371,"content":" "}],"oldStart":2858,"oldLines":6,"newStart":3365,"newLines":7},{"content":"@@ -2879,6 +3387,7 @@","changes":[{"type":"normal","normal":true,"ln1":2879,"ln2":3387,"content":" "},{"type":"normal","normal":true,"ln1":2880,"ln2":3388,"content":"       end:"},{"type":"normal","normal":true,"ln1":2881,"ln2":3389,"content":" "},{"type":"add","add":true,"ln":3390,"content":"+      Pop $TmpVal"},{"type":"normal","normal":true,"ln1":2882,"ln2":3391,"content":"       Pop $R0"},{"type":"normal","normal":true,"ln1":2883,"ln2":3392,"content":"       Pop $R1"},{"type":"normal","normal":true,"ln1":2884,"ln2":3393,"content":"       Pop $R2"}],"oldStart":2879,"oldLines":6,"newStart":3387,"newLines":7},{"content":"@@ -3063,6 +3572,7 @@","changes":[{"type":"normal","normal":true,"ln1":3063,"ln2":3572,"content":"     !insertmacro GetOptions"},{"type":"normal","normal":true,"ln1":3064,"ln2":3573,"content":"     !insertmacro GetParameters"},{"type":"normal","normal":true,"ln1":3065,"ln2":3574,"content":"     !insertmacro GetSize"},{"type":"add","add":true,"ln":3575,"content":"+    !insertmacro ElevateUAC"},{"type":"normal","normal":true,"ln1":3066,"ln2":3576,"content":" "},{"type":"normal","normal":true,"ln1":3067,"ln2":3577,"content":"     !verbose push"},{"type":"normal","normal":true,"ln1":3068,"ln2":3578,"content":"     !verbose ${_MOZFUNC_VERBOSE}"}],"oldStart":3063,"oldLines":6,"newStart":3572,"newLines":7},{"content":"@@ -3083,6 +3593,10 @@","changes":[{"type":"normal","normal":true,"ln1":3083,"ln2":3593,"content":"       !endif"},{"type":"normal","normal":true,"ln1":3084,"ln2":3594,"content":" "},{"type":"normal","normal":true,"ln1":3085,"ln2":3595,"content":"       ${GetParameters} $R8"},{"type":"add","add":true,"ln":3596,"content":"+"},{"type":"add","add":true,"ln":3597,"content":"+      ; Require elevation if the user can elevate"},{"type":"add","add":true,"ln":3598,"content":"+      ${ElevateUAC}"},{"type":"add","add":true,"ln":3599,"content":"+"},{"type":"normal","normal":true,"ln1":3086,"ln2":3600,"content":"       ${If} $R8 != \"\""},{"type":"normal","normal":true,"ln1":3087,"ln2":3601,"content":"         ClearErrors"},{"type":"normal","normal":true,"ln1":3088,"ln2":3602,"content":"         ${GetOptions} \"$R8\" \"-ms\" $R7"}],"oldStart":3083,"oldLines":6,"newStart":3593,"newLines":10},{"content":"@@ -3230,6 +3744,7 @@","changes":[{"type":"normal","normal":true,"ln1":3230,"ln2":3744,"content":"     !insertmacro GetOptions"},{"type":"normal","normal":true,"ln1":3231,"ln2":3745,"content":"     !insertmacro GetParameters"},{"type":"normal","normal":true,"ln1":3232,"ln2":3746,"content":"     !insertmacro UpdateUninstallLog"},{"type":"add","add":true,"ln":3747,"content":"+    !insertmacro ElevateUAC"},{"type":"normal","normal":true,"ln1":3233,"ln2":3748,"content":" "},{"type":"normal","normal":true,"ln1":3234,"ln2":3749,"content":"     !verbose push"},{"type":"normal","normal":true,"ln1":3235,"ln2":3750,"content":"     !verbose ${_MOZFUNC_VERBOSE}"}],"oldStart":3230,"oldLines":6,"newStart":3744,"newLines":7},{"content":"@@ -3246,42 +3761,60 @@","changes":[{"type":"normal","normal":true,"ln1":3246,"ln2":3761,"content":" "},{"type":"normal","normal":true,"ln1":3247,"ln2":3762,"content":"       StrCmp \"$R0\" \"\" continue +1"},{"type":"normal","normal":true,"ln1":3248,"ln2":3763,"content":" "},{"type":"del","del":true,"ln":3249,"content":"-      StrCmp \"$R0\" \"/HideShortcuts\" +1 showshortcuts"},{"type":"add","add":true,"ln":3764,"content":"+      ; Require elevation if the user can elevate"},{"type":"add","add":true,"ln":3765,"content":"+      ClearErrors"},{"type":"add","add":true,"ln":3766,"content":"+      ${GetOptions} \"$R0\" \"/HideShortcuts\" $R2"},{"type":"add","add":true,"ln":3767,"content":"+      IfErrors showshortcuts +1"},{"type":"add","add":true,"ln":3768,"content":"+      ${ElevateUAC}"},{"type":"normal","normal":true,"ln1":3250,"ln2":3769,"content":"       ${HideShortcuts}"},{"type":"normal","normal":true,"ln1":3251,"ln2":3770,"content":"       StrCpy $R1 \"true\""},{"type":"normal","normal":true,"ln1":3252,"ln2":3771,"content":"       StrCmp \"$R1\" \"true\" continue"},{"type":"normal","normal":true,"ln1":3253,"ln2":3772,"content":" "},{"type":"add","add":true,"ln":3773,"content":"+      ; Require elevation if the user can elevate"},{"type":"normal","normal":true,"ln1":3254,"ln2":3774,"content":"       showshortcuts:"},{"type":"del","del":true,"ln":3255,"content":"-      StrCmp \"$R0\" \"/ShowShortcuts\" +1 defaultappuser"},{"type":"add","add":true,"ln":3775,"content":"+      ClearErrors"},{"type":"add","add":true,"ln":3776,"content":"+      ${GetOptions} \"$R0\" \"/ShowShortcuts\" $R2"},{"type":"add","add":true,"ln":3777,"content":"+      IfErrors defaultappuser +1"},{"type":"add","add":true,"ln":3778,"content":"+      ${ElevateUAC}"},{"type":"normal","normal":true,"ln1":3256,"ln2":3779,"content":"       ${ShowShortcuts}"},{"type":"normal","normal":true,"ln1":3257,"ln2":3780,"content":"       StrCpy $R1 \"true\""},{"type":"normal","normal":true,"ln1":3258,"ln2":3781,"content":"       GoTo continue"},{"type":"normal","normal":true,"ln1":3259,"ln2":3782,"content":" "},{"type":"add","add":true,"ln":3783,"content":"+      ; Require elevation if the the StartMenuInternet registry keys require"},{"type":"add","add":true,"ln":3784,"content":"+      ; updating and the user can elevate"},{"type":"normal","normal":true,"ln1":3260,"ln2":3785,"content":"       defaultappuser:"},{"type":"del","del":true,"ln":3261,"content":"-      StrCmp \"$R0\" \"/SetAsDefaultAppUser\" +1 defaultappglobal"},{"type":"add","add":true,"ln":3786,"content":"+      ClearErrors"},{"type":"add","add":true,"ln":3787,"content":"+      ${GetOptions} \"$R0\" \"/SetAsDefaultAppUser\" $R2"},{"type":"add","add":true,"ln":3788,"content":"+      IfErrors defaultappglobal +1"},{"type":"normal","normal":true,"ln1":3262,"ln2":3789,"content":"       ${SetAsDefaultAppUser}"},{"type":"normal","normal":true,"ln1":3263,"ln2":3790,"content":"       StrCpy $R1 \"true\""},{"type":"normal","normal":true,"ln1":3264,"ln2":3791,"content":"       GoTo continue"},{"type":"normal","normal":true,"ln1":3265,"ln2":3792,"content":" "},{"type":"add","add":true,"ln":3793,"content":"+      ; Require elevation if the user can elevate"},{"type":"normal","normal":true,"ln1":3266,"ln2":3794,"content":"       defaultappglobal:"},{"type":"del","del":true,"ln":3267,"content":"-      StrCmp \"$R0\" \"/SetAsDefaultAppGlobal\" +1 postupdate"},{"type":"add","add":true,"ln":3795,"content":"+      ClearErrors"},{"type":"add","add":true,"ln":3796,"content":"+      ${GetOptions} \"$R0\" \"/SetAsDefaultAppGlobal\" $R2"},{"type":"add","add":true,"ln":3797,"content":"+      IfErrors postupdate +1"},{"type":"add","add":true,"ln":3798,"content":"+      ${ElevateUAC}"},{"type":"normal","normal":true,"ln1":3268,"ln2":3799,"content":"       ${SetAsDefaultAppGlobal}"},{"type":"normal","normal":true,"ln1":3269,"ln2":3800,"content":"       StrCpy $R1 \"true\""},{"type":"normal","normal":true,"ln1":3270,"ln2":3801,"content":"       GoTo continue"},{"type":"normal","normal":true,"ln1":3271,"ln2":3802,"content":" "},{"type":"add","add":true,"ln":3803,"content":"+      ; Do not attempt to elevate. The application launching this executable is"},{"type":"add","add":true,"ln":3804,"content":"+      ; responsible for elevation if it is required."},{"type":"normal","normal":true,"ln1":3272,"ln2":3805,"content":"       postupdate:"},{"type":"normal","normal":true,"ln1":3273,"ln2":3806,"content":"       ${WordReplace} \"$R0\" \"$\\\"\" \"\" \"+\" $R0"},{"type":"normal","normal":true,"ln1":3274,"ln2":3807,"content":"       ClearErrors"},{"type":"normal","normal":true,"ln1":3275,"ln2":3808,"content":"       ${GetOptions} \"$R0\" \"/PostUpdate\" $R2"},{"type":"add","add":true,"ln":3809,"content":"+      StrCpy $R1 \"true\""},{"type":"normal","normal":true,"ln1":3276,"ln2":3810,"content":"       IfErrors continue +1"},{"type":"add","add":true,"ln":3811,"content":"+      ; If the uninstall.log does not exist don't perform post update"},{"type":"add","add":true,"ln":3812,"content":"+      ; operations. This prevents updating the registry for zip builds."},{"type":"add","add":true,"ln":3813,"content":"+      IfFileExists \"$EXEDIR\\uninstall.log\" +1 continue"},{"type":"normal","normal":true,"ln1":3277,"ln2":3814,"content":"       ${PostUpdate}"},{"type":"normal","normal":true,"ln1":3278,"ln2":3815,"content":"       ClearErrors"},{"type":"normal","normal":true,"ln1":3279,"ln2":3816,"content":"       ${GetOptions} \"$R0\" \"/UninstallLog=\" $R2"},{"type":"del","del":true,"ln":3280,"content":"-      IfErrors +1 +4"},{"type":"del","del":true,"ln":3281,"content":"-      ${UpdateUninstallLog}"},{"type":"del","del":true,"ln":3282,"content":"-      StrCpy $R1 \"true\""},{"type":"del","del":true,"ln":3283,"content":"-      GoTo continue"},{"type":"del","del":true,"ln":3284,"content":"-"},{"type":"add","add":true,"ln":3817,"content":"+      IfErrors updateuninstalllog +1"},{"type":"normal","normal":true,"ln1":3285,"ln2":3818,"content":"       StrCmp \"$R2\" \"\" continue +1"},{"type":"normal","normal":true,"ln1":3286,"ln2":3819,"content":"       GetFullPathName $R3 \"$R2\""},{"type":"normal","normal":true,"ln1":3287,"ln2":3820,"content":"       IfFileExists \"$R3\" +1 continue"}],"oldStart":3246,"oldLines":42,"newStart":3761,"newLines":60},{"content":"@@ -3291,14 +3824,27 @@","changes":[{"type":"normal","normal":true,"ln1":3291,"ln2":3824,"content":"       ${GetParent} \"$R3\" $R4"},{"type":"normal","normal":true,"ln1":3292,"ln2":3825,"content":"       Delete \"$R3\""},{"type":"normal","normal":true,"ln1":3293,"ln2":3826,"content":"       RmDir \"$R4\""},{"type":"del","del":true,"ln":3294,"content":"-      StrCpy $R1 \"true\""},{"type":"add","add":true,"ln":3827,"content":"+      GoTo continue"},{"type":"normal","normal":true,"ln1":3295,"ln2":3828,"content":" "},{"type":"add","add":true,"ln":3829,"content":"+      ; Do not attempt to elevate. The application launching this executable is"},{"type":"add","add":true,"ln":3830,"content":"+      ; responsible for elevation if it is required."},{"type":"add","add":true,"ln":3831,"content":"+      updateuninstalllog:"},{"type":"add","add":true,"ln":3832,"content":"+      ${UpdateUninstallLog}"},{"type":"add","add":true,"ln":3833,"content":"+      StrCpy $R1 \"true\""},{"type":"add","add":true,"ln":3834,"content":"+      "},{"type":"normal","normal":true,"ln1":3296,"ln2":3835,"content":"       continue:"},{"type":"del","del":true,"ln":3297,"content":"-"},{"type":"normal","normal":true,"ln1":3298,"ln2":3836,"content":"       StrCmp $R1 \"true\" +1 +3"},{"type":"normal","normal":true,"ln1":3299,"ln2":3837,"content":"       System::Call \"shell32::SHChangeNotify(i, i, i, i) v (0x08000000, 0, 0, 0)\""},{"type":"normal","normal":true,"ln1":3300,"ln2":3838,"content":"       Quit"},{"type":"normal","normal":true,"ln1":3301,"ln2":3839,"content":" "},{"type":"add","add":true,"ln":3840,"content":"+      ; If the uninstall.log does not exist don't perform uninstall"},{"type":"add","add":true,"ln":3841,"content":"+      ; operations. This prevents running the uninstaller for zip builds."},{"type":"add","add":true,"ln":3842,"content":"+      IfFileExists \"$EXEDIR\\uninstall.log\" +2 +1"},{"type":"add","add":true,"ln":3843,"content":"+      Quit"},{"type":"add","add":true,"ln":3844,"content":"+"},{"type":"add","add":true,"ln":3845,"content":"+      ; Require elevation if the user can elevate"},{"type":"add","add":true,"ln":3846,"content":"+      ${ElevateUAC}"},{"type":"add","add":true,"ln":3847,"content":"+"},{"type":"normal","normal":true,"ln1":3302,"ln2":3848,"content":"       ; If we made it this far then this installer is being used as an uninstaller."},{"type":"normal","normal":true,"ln1":3303,"ln2":3849,"content":"       WriteUninstaller \"$EXEDIR\\uninstaller.exe\""},{"type":"normal","normal":true,"ln1":3304,"ln2":3850,"content":" "}],"oldStart":3291,"oldLines":14,"newStart":3824,"newLines":27},{"content":"@@ -3506,7 +4052,6 @@","changes":[{"type":"normal","normal":true,"ln1":3506,"ln2":4052,"content":" "},{"type":"normal","normal":true,"ln1":3507,"ln2":4053,"content":"       ; Remove the files and directories in the removed-files.log"},{"type":"normal","normal":true,"ln1":3508,"ln2":4054,"content":"       ${ParseRemovedFilesLog}"},{"type":"del","del":true,"ln":3509,"content":"- "},{"type":"normal","normal":true,"ln1":3510,"ln2":4055,"content":"     FunctionEnd"},{"type":"normal","normal":true,"ln1":3511,"ln2":4056,"content":" "},{"type":"normal","normal":true,"ln1":3512,"ln2":4057,"content":"     !verbose pop"}],"oldStart":3506,"oldLines":7,"newStart":4052,"newLines":6},{"content":"@@ -3555,6 +4100,98 @@","changes":[{"type":"normal","normal":true,"ln1":3555,"ln2":4100,"content":" "},{"type":"normal","normal":true,"ln1":3556,"ln2":4101,"content":" "},{"type":"normal","normal":true,"ln1":3557,"ln2":4102,"content":" ################################################################################"},{"type":"add","add":true,"ln":4103,"content":"+# UAC Related Macros"},{"type":"add","add":true,"ln":4104,"content":"+"},{"type":"add","add":true,"ln":4105,"content":"+/**"},{"type":"add","add":true,"ln":4106,"content":"+ * Provides UAC elevation support for Vista and above (requires the UAC plugin)."},{"type":"add","add":true,"ln":4107,"content":"+ *"},{"type":"add","add":true,"ln":4108,"content":"+ * $0 = return values from calls to the UAC plugin (always uses $0)"},{"type":"add","add":true,"ln":4109,"content":"+ * $R9 = return values from GetParameters and GetOptions macros"},{"type":"add","add":true,"ln":4110,"content":"+ */"},{"type":"add","add":true,"ln":4111,"content":"+!macro ElevateUAC"},{"type":"add","add":true,"ln":4112,"content":"+"},{"type":"add","add":true,"ln":4113,"content":"+  !ifndef ${_MOZFUNC_UN}ElevateUAC"},{"type":"add","add":true,"ln":4114,"content":"+    !verbose push"},{"type":"add","add":true,"ln":4115,"content":"+    !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":4116,"content":"+    !define ${_MOZFUNC_UN}ElevateUAC \"!insertmacro ${_MOZFUNC_UN}ElevateUACCall\""},{"type":"add","add":true,"ln":4117,"content":"+"},{"type":"add","add":true,"ln":4118,"content":"+    Function ${_MOZFUNC_UN}ElevateUAC"},{"type":"add","add":true,"ln":4119,"content":"+      Push $R9"},{"type":"add","add":true,"ln":4120,"content":"+      Push $0"},{"type":"add","add":true,"ln":4121,"content":"+"},{"type":"add","add":true,"ln":4122,"content":"+; USE_UAC_PLUGIN is temporary until Thunderbird has been updated to use the UAC plugin"},{"type":"add","add":true,"ln":4123,"content":"+!ifdef USE_UAC_PLUGIN"},{"type":"add","add":true,"ln":4124,"content":"+      !ifdef ___WINVER__NSH___"},{"type":"add","add":true,"ln":4125,"content":"+        ${If} ${AtLeastWinVista}"},{"type":"add","add":true,"ln":4126,"content":"+          UAC::IsAdmin"},{"type":"add","add":true,"ln":4127,"content":"+          ; If the user is not an admin already"},{"type":"add","add":true,"ln":4128,"content":"+          ${If} \"$0\" != \"1\""},{"type":"add","add":true,"ln":4129,"content":"+            UAC::SupportsUAC"},{"type":"add","add":true,"ln":4130,"content":"+            ; If the system supports UAC"},{"type":"add","add":true,"ln":4131,"content":"+            ${If} \"$0\" == \"1\""},{"type":"add","add":true,"ln":4132,"content":"+              UAC::GetElevationType"},{"type":"add","add":true,"ln":4133,"content":"+              ; If the user account has a split token"},{"type":"add","add":true,"ln":4134,"content":"+              ${If} \"$0\" == \"3\""},{"type":"add","add":true,"ln":4135,"content":"+                UAC::RunElevated "},{"type":"add","add":true,"ln":4136,"content":"+                Quit"},{"type":"add","add":true,"ln":4137,"content":"+              ${EndIf}"},{"type":"add","add":true,"ln":4138,"content":"+            ${EndIf}"},{"type":"add","add":true,"ln":4139,"content":"+          ${Else}"},{"type":"add","add":true,"ln":4140,"content":"+            ${GetParameters} $R9"},{"type":"add","add":true,"ln":4141,"content":"+            ${If} $R9 != \"\""},{"type":"add","add":true,"ln":4142,"content":"+              ClearErrors"},{"type":"add","add":true,"ln":4143,"content":"+              ${GetOptions} \"$R9\" \"/UAC:\" $0"},{"type":"add","add":true,"ln":4144,"content":"+              ; If the command line contains /UAC then we need to initialize"},{"type":"add","add":true,"ln":4145,"content":"+              ; the UAC plugin to use UAC::ExecCodeSegment to execute code in"},{"type":"add","add":true,"ln":4146,"content":"+              ; the non-elevated context."},{"type":"add","add":true,"ln":4147,"content":"+              ${Unless} ${Errors}"},{"type":"add","add":true,"ln":4148,"content":"+                UAC::RunElevated "},{"type":"add","add":true,"ln":4149,"content":"+              ${EndUnless}"},{"type":"add","add":true,"ln":4150,"content":"+            ${EndIf}"},{"type":"add","add":true,"ln":4151,"content":"+          ${EndIf}"},{"type":"add","add":true,"ln":4152,"content":"+        ${EndIf}"},{"type":"add","add":true,"ln":4153,"content":"+      !endif"},{"type":"add","add":true,"ln":4154,"content":"+!endif"},{"type":"add","add":true,"ln":4155,"content":"+"},{"type":"add","add":true,"ln":4156,"content":"+      Pop $0"},{"type":"add","add":true,"ln":4157,"content":"+      Pop $R9"},{"type":"add","add":true,"ln":4158,"content":"+    FunctionEnd"},{"type":"add","add":true,"ln":4159,"content":"+"},{"type":"add","add":true,"ln":4160,"content":"+    !verbose pop"},{"type":"add","add":true,"ln":4161,"content":"+  !endif"},{"type":"add","add":true,"ln":4162,"content":"+!macroend"},{"type":"add","add":true,"ln":4163,"content":"+"},{"type":"add","add":true,"ln":4164,"content":"+!macro ElevateUACCall"},{"type":"add","add":true,"ln":4165,"content":"+  !verbose push"},{"type":"add","add":true,"ln":4166,"content":"+  !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":4167,"content":"+  Call ElevateUAC"},{"type":"add","add":true,"ln":4168,"content":"+  !verbose pop"},{"type":"add","add":true,"ln":4169,"content":"+!macroend"},{"type":"add","add":true,"ln":4170,"content":"+"},{"type":"add","add":true,"ln":4171,"content":"+!macro un.ElevateUACCall"},{"type":"add","add":true,"ln":4172,"content":"+  !verbose push"},{"type":"add","add":true,"ln":4173,"content":"+  !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":4174,"content":"+  Call un.ElevateUAC"},{"type":"add","add":true,"ln":4175,"content":"+  !verbose pop"},{"type":"add","add":true,"ln":4176,"content":"+!macroend"},{"type":"add","add":true,"ln":4177,"content":"+"},{"type":"add","add":true,"ln":4178,"content":"+!macro un.ElevateUAC"},{"type":"add","add":true,"ln":4179,"content":"+  !ifndef un.ElevateUAC"},{"type":"add","add":true,"ln":4180,"content":"+    !verbose push"},{"type":"add","add":true,"ln":4181,"content":"+    !verbose ${_MOZFUNC_VERBOSE}"},{"type":"add","add":true,"ln":4182,"content":"+    !undef _MOZFUNC_UN"},{"type":"add","add":true,"ln":4183,"content":"+    !define _MOZFUNC_UN \"un.\""},{"type":"add","add":true,"ln":4184,"content":"+"},{"type":"add","add":true,"ln":4185,"content":"+    !insertmacro ElevateUAC"},{"type":"add","add":true,"ln":4186,"content":"+"},{"type":"add","add":true,"ln":4187,"content":"+    !undef _MOZFUNC_UN"},{"type":"add","add":true,"ln":4188,"content":"+    !define _MOZFUNC_UN"},{"type":"add","add":true,"ln":4189,"content":"+    !verbose pop"},{"type":"add","add":true,"ln":4190,"content":"+  !endif"},{"type":"add","add":true,"ln":4191,"content":"+!macroend"},{"type":"add","add":true,"ln":4192,"content":"+"},{"type":"add","add":true,"ln":4193,"content":"+"},{"type":"add","add":true,"ln":4194,"content":"+################################################################################"},{"type":"normal","normal":true,"ln1":3558,"ln2":4195,"content":" # Macros for logging"},{"type":"normal","normal":true,"ln1":3559,"ln2":4196,"content":" #"},{"type":"normal","normal":true,"ln1":3560,"ln2":4197,"content":" # Since these are used by other macros they should be inserted first. All of"}],"oldStart":3555,"oldLines":6,"newStart":4100,"newLines":98}],"deletions":12,"additions":649,"from":"toolkit/mozapps/installer/windows/nsis/common.nsh","to":"toolkit/mozapps/installer/windows/nsis/common.nsh","index":["64b004a..8e4a7be","100755"]},{"chunks":[{"content":"@@ -49,7 +49,9 @@ TOOLKIT_NSIS_FILES = \\","changes":[{"type":"normal","normal":true,"ln1":49,"ln2":49,"content":" \tlocales.nsi \\"},{"type":"normal","normal":true,"ln1":50,"ln2":50,"content":" \tnsProcess.dll \\"},{"type":"normal","normal":true,"ln1":51,"ln2":51,"content":" \toverrides.nsh \\"},{"type":"add","add":true,"ln":52,"content":"+\tSetVistaDefaultApp.dll \\"},{"type":"normal","normal":true,"ln1":52,"ln2":53,"content":" \tShellLink.dll \\"},{"type":"add","add":true,"ln":54,"content":"+\tUAC.dll \\"},{"type":"normal","normal":true,"ln1":53,"ln2":55,"content":" \tversion.nsh \\"},{"type":"normal","normal":true,"ln1":54,"ln2":56,"content":" \t$(NULL)"},{"type":"normal","normal":true,"ln1":55,"ln2":57,"content":" "}],"oldStart":49,"oldLines":7,"newStart":49,"newLines":9}],"deletions":0,"additions":2,"from":"toolkit/mozapps/installer/windows/nsis/makensis.mk","to":"toolkit/mozapps/installer/windows/nsis/makensis.mk","index":["53f783a..a94dd0f","100755"]},{"chunks":[{"content":"@@ -701,22 +701,6 @@ nsXULAppInfo::LaunchAppHelperWithArgs(int aArgc, char **aArgv)","changes":[{"type":"normal","normal":true,"ln1":701,"ln2":701,"content":" }"},{"type":"normal","normal":true,"ln1":702,"ln2":702,"content":" "},{"type":"normal","normal":true,"ln1":703,"ln2":703,"content":" NS_IMETHODIMP"},{"type":"del","del":true,"ln":704,"content":"-nsXULAppInfo::FixReg()"},{"type":"del","del":true,"ln":705,"content":"-{"},{"type":"del","del":true,"ln":706,"content":"-  int resetRegArgc = 2;"},{"type":"del","del":true,"ln":707,"content":"-  char **resetRegArgv = (char**) malloc(sizeof(char*) * (resetRegArgc + 1));"},{"type":"del","del":true,"ln":708,"content":"-  if (!resetRegArgv)"},{"type":"del","del":true,"ln":709,"content":"-    return NS_ERROR_OUT_OF_MEMORY;"},{"type":"del","del":true,"ln":710,"content":"-"},{"type":"del","del":true,"ln":711,"content":"-  resetRegArgv[0] = \"argv0ignoredbywinlaunchchild\";"},{"type":"del","del":true,"ln":712,"content":"-  resetRegArgv[1] = \"/fixreg\";"},{"type":"del","del":true,"ln":713,"content":"-  resetRegArgv[2] = nsnull;"},{"type":"del","del":true,"ln":714,"content":"-  nsresult rv = LaunchAppHelperWithArgs(resetRegArgc, resetRegArgv);"},{"type":"del","del":true,"ln":715,"content":"-  free(resetRegArgv);"},{"type":"del","del":true,"ln":716,"content":"-  return rv;"},{"type":"del","del":true,"ln":717,"content":"-}"},{"type":"del","del":true,"ln":718,"content":"-"},{"type":"del","del":true,"ln":719,"content":"-NS_IMETHODIMP"},{"type":"normal","normal":true,"ln1":720,"ln2":704,"content":" nsXULAppInfo::PostUpdate(nsILocalFile *aLogFile)"},{"type":"normal","normal":true,"ln1":721,"ln2":705,"content":" {"},{"type":"normal","normal":true,"ln1":722,"ln2":706,"content":"   nsresult rv;"}],"oldStart":701,"oldLines":22,"newStart":701,"newLines":6}],"deletions":16,"additions":0,"from":"toolkit/xre/nsAppRunner.cpp","to":"toolkit/xre/nsAppRunner.cpp","index":["64aa963..622b4a7","100644"]},{"chunks":[{"content":"@@ -46,10 +46,9 @@","changes":[{"type":"normal","normal":true,"ln1":46,"ln2":46,"content":" "},{"type":"normal","normal":true,"ln1":47,"ln2":47,"content":" interface nsILocalFile;"},{"type":"normal","normal":true,"ln1":48,"ln2":48,"content":" "},{"type":"del","del":true,"ln":49,"content":"-[scriptable, uuid(b0fb682a-8287-4b0f-b628-65bb206c073f)]"},{"type":"add","add":true,"ln":49,"content":"+[scriptable, uuid(2bd9ec66-05eb-4f63-8825-a83ccf00fc7f)]"},{"type":"normal","normal":true,"ln1":50,"ln2":50,"content":" interface nsIWinAppHelper : nsISupports"},{"type":"normal","normal":true,"ln1":51,"ln2":51,"content":" {"},{"type":"normal","normal":true,"ln1":52,"ln2":52,"content":"   void postUpdate(in nsILocalFile logFile);"},{"type":"del","del":true,"ln":53,"content":"-  void fixReg();"},{"type":"normal","normal":true,"ln1":54,"ln2":53,"content":"   readonly attribute boolean userCanElevate;"},{"type":"normal","normal":true,"ln1":55,"ln2":54,"content":" };"}],"oldStart":46,"oldLines":10,"newStart":46,"newLines":9}],"deletions":2,"additions":1,"from":"toolkit/xre/nsIWinAppHelper.idl","to":"toolkit/xre/nsIWinAppHelper.idl","index":["a1d2c38..5e9b29f","100644"]}]}