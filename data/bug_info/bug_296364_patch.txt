Index: security/manager/ssl/src/nsCrypto.cpp
===================================================================
RCS file: /home/bzbarsky/mozilla/cvs-mirror/mozilla/security/manager/ssl/src/nsCrypto.cpp,v
retrieving revision 1.53
diff -u -p -d -1 -2 -r1.53 nsCrypto.cpp
--- security/manager/ssl/src/nsCrypto.cpp	2 Jun 2005 02:46:34 -0000	1.53
+++ security/manager/ssl/src/nsCrypto.cpp	2 Jun 2005 09:50:32 -0000
@@ -353,48 +353,48 @@ cryptojs_GetFunctionObjectPrincipal(JSCo
 static nsresult
 cryptojs_GetFramePrincipal(JSContext *cx, JSStackFrame *fp,
                            nsIPrincipal **principal)
 {
   JSObject *obj = JS_GetFrameFunctionObject(cx, fp);
   if (!obj) {
     JSScript *script = JS_GetFrameScript(cx, fp);
     return cryptojs_GetScriptPrincipal(cx, script, principal);
   }
   return cryptojs_GetFunctionObjectPrincipal(cx, obj, principal);
 }
 
-nsIPrincipal*
+already_AddRefed<nsIPrincipal>
 nsCrypto::GetScriptPrincipal(JSContext *cx)
 {
   JSStackFrame *fp = nsnull;
   nsIPrincipal *principal=nsnull;
 
   for (fp = JS_FrameIterator(cx, &fp); fp; fp = JS_FrameIterator(cx, &fp)) {
     cryptojs_GetFramePrincipal(cx, fp, &principal);
     if (principal != nsnull) {
       break;
     }
   }
 
   if (principal)
     return principal;
 
   nsIScriptContext *scriptContext = GetScriptContextFromJSContext(cx);
 
   if (scriptContext)
   {
     nsCOMPtr<nsIScriptObjectPrincipal> globalData =
       do_QueryInterface(scriptContext->GetGlobalObject());
     NS_ENSURE_TRUE(globalData, nsnull);
-    principal = globalData->GetPrincipal();
+    NS_IF_ADDREF(principal = globalData->GetPrincipal());
   }
 
   return principal;
 }
 
 //A quick function to let us know if the key we're trying to generate
 //can be escrowed.
 static PRBool
 ns_can_escrow(nsKeyGenType keyGenType)
 {
   /* For now, we only escrow rsa-encryption keys. */
   return (PRBool)(keyGenType == rsaEnc);
Index: security/manager/ssl/src/nsCrypto.h
===================================================================
RCS file: /home/bzbarsky/mozilla/cvs-mirror/mozilla/security/manager/ssl/src/nsCrypto.h,v
retrieving revision 1.9
diff -u -p -d -1 -2 -r1.9 nsCrypto.h
--- security/manager/ssl/src/nsCrypto.h	2 Jun 2005 01:17:17 -0000	1.9
+++ security/manager/ssl/src/nsCrypto.h	2 Jun 2005 09:50:44 -0000
@@ -83,25 +83,25 @@ private:
 
 class nsCrypto: public nsIDOMCrypto
 {
 public:
   nsCrypto();
   virtual ~nsCrypto();
   nsresult init();
   
   NS_DECL_ISUPPORTS
   NS_DECL_NSIDOMCRYPTO
 
 private:
-  static nsIPrincipal* GetScriptPrincipal(JSContext *cx);
+  static already_AddRefed<nsIPrincipal> GetScriptPrincipal(JSContext *cx);
 
   PRBool mEnableSmartCardEvents;
 };
 
 class nsPkcs11 : public nsIDOMPkcs11
 {
 public:
   nsPkcs11();
   virtual ~nsPkcs11();
 
   NS_DECL_ISUPPORTS
   NS_DECL_NSIDOMPKCS11
