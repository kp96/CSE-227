Index: caps/include/nsScriptSecurityManager.h
===================================================================
RCS file: /cvsroot/mozilla/caps/include/nsScriptSecurityManager.h,v
retrieving revision 1.90
diff -u -8 -p -r1.90 nsScriptSecurityManager.h
--- caps/include/nsScriptSecurityManager.h	29 Jun 2005 16:29:49 -0000	1.90
+++ caps/include/nsScriptSecurityManager.h	17 Jul 2005 20:35:10 -0000
@@ -18,16 +18,17 @@
  * Netscape Communications Corporation.
  * Portions created by the Initial Developer are Copyright (C) 1998-2000
  * the Initial Developer. All Rights Reserved.
  *
  * Contributor(s):
  *   Norris Boyd  <nboyd@atg.com>
  *   Mitch Stoltz <mstoltz@netscape.com>
  *   Christopher A. Aillon <christopher@aillon.com>
+ *   Giorgio Maone <g.maone@informaction.com>
  *
  * Alternatively, the contents of this file may be used under the terms of
  * either of the GNU General Public License Version 2 or later (the "GPL"),
  * or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
  * in which case the provisions of the GPL or the LGPL are applicable instead
  * of those above. If you wish to allow use of your version of this file only
  * under the terms of either the GPL or the LGPL, and not to allow others to
  * use your version of this file under the terms of the MPL, indicate your
@@ -74,16 +75,17 @@ struct ClassPolicy;
 #define DEBUG_CAPS_LookupPolicy
 #define DEBUG_CAPS_CheckComponentPermissions
 #endif
 
 #if 0
 #define DEBUG_CAPS_CanCreateWrapper
 #define DEBUG_CAPS_CanCreateInstance
 #define DEBUG_CAPS_CanGetService
+#define DEBUG_CAPS_DomainPolicyLifeCycle
 #endif
 
 /////////////////////
 // PrincipalKey //
 /////////////////////
 
 class PrincipalKey : public PLDHashEntryHdr
 {
@@ -285,18 +287,19 @@ public:
 
         return PL_DHashTableInit(this, &domainPolicyOps, nsnull,
                                  sizeof(ClassPolicy), 16);
     }
 
     ~DomainPolicy()
     {
         PL_DHashTableFinish(this);
-
+        NS_ASSERTION(mRefCount == 0, "Wrong refcount in DomainPolicy dtor");
 #ifdef DEBUG_CAPS_DomainPolicyLifeCycle
+        printf("DomainPolicy deleted with mRefCount = %d\n", mRefCount);
         --sObjects;
         _printPopulationInfo();
 #endif
 
     }
 
     void Hold()
     {
Index: caps/include/nsPrincipal.h
===================================================================
RCS file: /cvsroot/mozilla/caps/include/nsPrincipal.h,v
retrieving revision 1.15
diff -u -8 -p -r1.15 nsPrincipal.h
--- caps/include/nsPrincipal.h	29 Jun 2005 16:29:49 -0000	1.15
+++ caps/include/nsPrincipal.h	17 Jul 2005 20:35:11 -0000
@@ -16,16 +16,17 @@
  *
  * The Initial Developer of the Original Code is
  * Netscape Communications Corporation.
  * Portions created by the Initial Developer are Copyright (C) 2003
  * the Initial Developer. All Rights Reserved.
  *
  * Contributor(s):
  *   Christopher A. Aillon <christopher@aillon.com>
+ *   Giorgio Maone <g.maone@informaction.com>
  *
  * Alternatively, the contents of this file may be used under the terms of
  * either the GNU General Public License Version 2 or later (the "GPL"), or
  * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
  * in which case the provisions of the GPL or the LGPL are applicable instead
  * of those above. If you wish to allow use of your version of this file only
  * under the terms of either the GPL or the LGPL, and not to allow others to
  * use your version of this file under the terms of the MPL, indicate your
Index: caps/src/nsScriptSecurityManager.cpp
===================================================================
RCS file: /cvsroot/mozilla/caps/src/nsScriptSecurityManager.cpp,v
retrieving revision 1.264
diff -u -8 -p -r1.264 nsScriptSecurityManager.cpp
--- caps/src/nsScriptSecurityManager.cpp	14 Jul 2005 17:46:55 -0000	1.264
+++ caps/src/nsScriptSecurityManager.cpp	17 Jul 2005 20:35:22 -0000
@@ -19,16 +19,17 @@
  * Portions created by the Initial Developer are Copyright (C) 1998-2000
  * the Initial Developer. All Rights Reserved.
  *
  * Contributor(s):
  *   Norris Boyd
  *   Mitch Stoltz
  *   Steve Morse
  *   Christopher A. Aillon
+ *   Giorgio Maone
  *
  * Alternatively, the contents of this file may be used under the terms of
  * either of the GNU General Public License Version 2 or later (the "GPL"),
  * or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
  * in which case the provisions of the GPL or the LGPL are applicable instead
  * of those above. If you wish to allow use of your version of this file only
  * under the terms of either the GPL or the LGPL, and not to allow others to
  * use your version of this file under the terms of the MPL, indicate your
@@ -2886,17 +2887,18 @@ nsresult nsScriptSecurityManager::Init()
 
 static nsScriptSecurityManager *gScriptSecMan = nsnull;
 
 jsval nsScriptSecurityManager::sEnabledID   = JSVAL_VOID;
 
 nsScriptSecurityManager::~nsScriptSecurityManager(void)
 {
     delete mOriginToPolicyMap;
-    delete mDefaultPolicy;
+    if(mDefaultPolicy)
+        mDefaultPolicy->Drop();
     delete mCapabilities;
     gScriptSecMan = nsnull;
 }
 
 void
 nsScriptSecurityManager::Shutdown()
 {
     if (sRuntime) {
@@ -2975,18 +2977,20 @@ nsScriptSecurityManager::InitPolicies()
     delete mOriginToPolicyMap;
     
     //-- Marks all the survivor DomainPolicy objects (those cached
     //-- by nsPrincipal objects) as invalid: they will be released
     //-- on first nsPrincipal::GetSecurityPolicy() attempt.
     DomainPolicy::InvalidateAll();
     
     //-- Release old default policy
-    if(mDefaultPolicy)
+    if(mDefaultPolicy) {
         mDefaultPolicy->Drop();
+        mDefaultPolicy = nsnull;
+    }
     
     //-- Initialize a new mOriginToPolicyMap
     mOriginToPolicyMap =
       new nsObjectHashtable(nsnull, nsnull, DeleteDomainEntry, nsnull);
     if (!mOriginToPolicyMap)
         return NS_ERROR_OUT_OF_MEMORY;
 
     //-- Create, refcount and initialize a new default policy 
Index: caps/src/nsPrincipal.cpp
===================================================================
RCS file: /cvsroot/mozilla/caps/src/nsPrincipal.cpp,v
retrieving revision 1.34
diff -u -8 -p -r1.34 nsPrincipal.cpp
--- caps/src/nsPrincipal.cpp	8 Jul 2005 23:26:35 -0000	1.34
+++ caps/src/nsPrincipal.cpp	17 Jul 2005 20:35:24 -0000
@@ -16,16 +16,17 @@
  *
  * The Initial Developer of the Original Code is
  * Netscape Communications Corporation.
  * Portions created by the Initial Developer are Copyright (C) 2003
  * the Initial Developer. All Rights Reserved.
  *
  * Contributor(s):
  *   Christopher A. Aillon <christopher@aillon.com>
+ *   Giorgio Maone <g.maone@informaction.com>
  *
  * Alternatively, the contents of this file may be used under the terms of
  * either the GNU General Public License Version 2 or later (the "GPL"), or
  * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
  * in which case the provisions of the GPL or the LGPL are applicable instead
  * of those above. If you wish to allow use of your version of this file only
  * under the terms of either the GPL or the LGPL, and not to allow others to
  * use your version of this file under the terms of the MPL, indicate your
