{"bug_id":177237,"commitHash":"f83e342","commit_info":{"sha":"f83e342a155703dc5e53a183c0ce96424a6eeb43","commit":{"author":{"name":"bzbarsky%mit.edu","email":"bzbarsky%mit.edu","date":"2002-11-05T03:45:28Z"},"committer":{"name":"bzbarsky%mit.edu","email":"bzbarsky%mit.edu","date":"2002-11-05T03:45:28Z"},"message":"CheckLoadURI should use document uri, not base uri.  Bug 177237,\nr=mstoltz, sr=jst, a=blizzard","tree":{"sha":"890a4078b2c4f0d86b4fa2c661d96e7e034d00c1","url":"https://api.github.com/repos/mozilla/gecko-dev/git/trees/890a4078b2c4f0d86b4fa2c661d96e7e034d00c1"},"url":"https://api.github.com/repos/mozilla/gecko-dev/git/commits/f83e342a155703dc5e53a183c0ce96424a6eeb43","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/mozilla/gecko-dev/commits/f83e342a155703dc5e53a183c0ce96424a6eeb43","html_url":"https://github.com/mozilla/gecko-dev/commit/f83e342a155703dc5e53a183c0ce96424a6eeb43","comments_url":"https://api.github.com/repos/mozilla/gecko-dev/commits/f83e342a155703dc5e53a183c0ce96424a6eeb43/comments","author":null,"committer":null,"parents":[{"sha":"7dc47b626da9682faa147859cc106418f4277897","url":"https://api.github.com/repos/mozilla/gecko-dev/commits/7dc47b626da9682faa147859cc106418f4277897","html_url":"https://github.com/mozilla/gecko-dev/commit/7dc47b626da9682faa147859cc106418f4277897"}],"stats":{"total":33,"additions":20,"deletions":13},"files":[{"sha":"2bead8b3139b1f1887b686fa4ba7d81ce78f2097","filename":"content/base/src/nsScriptLoader.cpp","status":"modified","additions":6,"deletions":1,"changes":7,"blob_url":"https://github.com/mozilla/gecko-dev/blob/f83e342a155703dc5e53a183c0ce96424a6eeb43/content/base/src/nsScriptLoader.cpp","raw_url":"https://github.com/mozilla/gecko-dev/raw/f83e342a155703dc5e53a183c0ce96424a6eeb43/content/base/src/nsScriptLoader.cpp","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/content/base/src/nsScriptLoader.cpp?ref=f83e342a155703dc5e53a183c0ce96424a6eeb43","patch":"@@ -341,7 +341,12 @@ nsScriptLoader::ProcessScriptElement(nsIDOMHTMLScriptElement *aElement,\n     if (NS_FAILED(rv)) {\n       return FireErrorNotification(rv, aElement, aObserver);\n     }\n-    rv = securityManager->CheckLoadURI(baseURI, scriptURI, \n+    nsCOMPtr<nsIURI> docURI;\n+    mDocument->GetDocumentURL(getter_AddRefs(docURI));\n+    if (!docURI) {\n+      return FireErrorNotification(NS_ERROR_UNEXPECTED, aElement, aObserver);\n+    }\n+    rv = securityManager->CheckLoadURI(docURI, scriptURI, \n                                        nsIScriptSecurityManager::ALLOW_CHROME);\n     if (NS_FAILED(rv)) {\n       return FireErrorNotification(rv, aElement, aObserver);"},{"sha":"c0cc17ea0eef5590e9be1c12ffc6a86f476cdbdf","filename":"content/html/content/src/nsHTMLFormElement.cpp","status":"modified","additions":10,"deletions":6,"changes":16,"blob_url":"https://github.com/mozilla/gecko-dev/blob/f83e342a155703dc5e53a183c0ce96424a6eeb43/content/html/content/src/nsHTMLFormElement.cpp","raw_url":"https://github.com/mozilla/gecko-dev/raw/f83e342a155703dc5e53a183c0ce96424a6eeb43/content/html/content/src/nsHTMLFormElement.cpp","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/content/html/content/src/nsHTMLFormElement.cpp?ref=f83e342a155703dc5e53a183c0ce96424a6eeb43","patch":"@@ -1054,10 +1054,10 @@ nsHTMLFormElement::GetActionURL(nsIURI** aActionURL)\n   }\n \n   // Get base URL\n-  nsCOMPtr<nsIURI> docURL;\n-  GetBaseURL(*getter_AddRefs(docURL));\n-  NS_ASSERTION(docURL, \"No Base URL found in Form Submit!\\n\");\n-  if (!docURL) {\n+  nsCOMPtr<nsIURI> baseURL;\n+  GetBaseURL(*getter_AddRefs(baseURL));\n+  NS_ASSERTION(baseURL, \"No Base URL found in Form Submit!\\n\");\n+  if (!baseURL) {\n     return NS_OK; // No base URL -> exit early, see Bug 30721\n   }\n \n@@ -1077,10 +1077,10 @@ nsHTMLFormElement::GetActionURL(nsIURI** aActionURL)\n       return NS_OK;\n     }\n \n-    rv = docURL->Clone(getter_AddRefs(actionURL));\n+    rv = baseURL->Clone(getter_AddRefs(actionURL));\n     NS_ENSURE_SUCCESS(rv, rv);\n   } else {\n-    rv = NS_NewURI(getter_AddRefs(actionURL), action, nsnull, docURL);\n+    rv = NS_NewURI(getter_AddRefs(actionURL), action, nsnull, baseURL);\n     NS_ENSURE_SUCCESS(rv, rv);\n   }\n \n@@ -1095,6 +1095,10 @@ nsHTMLFormElement::GetActionURL(nsIURI** aActionURL)\n     do_GetService(NS_SCRIPTSECURITYMANAGER_CONTRACTID, &rv);\n   NS_ENSURE_SUCCESS(rv, rv);\n \n+  nsCOMPtr<nsIURI> docURL;\n+  mDocument->GetDocumentURL(getter_AddRefs(docURL));\n+  NS_ENSURE_TRUE(docURL, NS_ERROR_UNEXPECTED);\n+  \n   rv = securityManager->CheckLoadURI(docURL, actionURL,\n                                      nsIScriptSecurityManager::STANDARD);\n   NS_ENSURE_SUCCESS(rv, rv);"},{"sha":"679b3b6d18acf23bdd28fa613b6ccef9eff45bf6","filename":"content/html/style/src/nsCSSLoader.cpp","status":"modified","additions":2,"deletions":3,"changes":5,"blob_url":"https://github.com/mozilla/gecko-dev/blob/f83e342a155703dc5e53a183c0ce96424a6eeb43/content/html/style/src/nsCSSLoader.cpp","raw_url":"https://github.com/mozilla/gecko-dev/raw/f83e342a155703dc5e53a183c0ce96424a6eeb43/content/html/style/src/nsCSSLoader.cpp","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/content/html/style/src/nsCSSLoader.cpp?ref=f83e342a155703dc5e53a183c0ce96424a6eeb43","patch":"@@ -1707,11 +1707,10 @@ CSSLoaderImpl::LoadStyleLink(nsIContent* aElement,\n   nsCOMPtr<nsIScriptSecurityManager> secMan = \n            do_GetService(NS_SCRIPTSECURITYMANAGER_CONTRACTID, &rv);\n   if (NS_FAILED(rv)) return rv;\n-  nsIURI* docURI;\n-  rv = mDocument->GetBaseURL(docURI);\n+  nsCOMPtr<nsIURI> docURI;\n+  rv = mDocument->GetDocumentURL(getter_AddRefs(docURI));\n   if (NS_FAILED(rv) || !docURI) return NS_ERROR_FAILURE;\n   rv = secMan->CheckLoadURI(docURI, aURL, nsIScriptSecurityManager::ALLOW_CHROME);\n-  NS_IF_RELEASE(docURI);\n   if (NS_FAILED(rv)) return rv;\n \n   // XXX need to add code to cancel any pending sheets for element"},{"sha":"679b3b6d18acf23bdd28fa613b6ccef9eff45bf6","filename":"layout/style/nsCSSLoader.cpp","status":"modified","additions":2,"deletions":3,"changes":5,"blob_url":"https://github.com/mozilla/gecko-dev/blob/f83e342a155703dc5e53a183c0ce96424a6eeb43/layout/style/nsCSSLoader.cpp","raw_url":"https://github.com/mozilla/gecko-dev/raw/f83e342a155703dc5e53a183c0ce96424a6eeb43/layout/style/nsCSSLoader.cpp","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/layout/style/nsCSSLoader.cpp?ref=f83e342a155703dc5e53a183c0ce96424a6eeb43","patch":"@@ -1707,11 +1707,10 @@ CSSLoaderImpl::LoadStyleLink(nsIContent* aElement,\n   nsCOMPtr<nsIScriptSecurityManager> secMan = \n            do_GetService(NS_SCRIPTSECURITYMANAGER_CONTRACTID, &rv);\n   if (NS_FAILED(rv)) return rv;\n-  nsIURI* docURI;\n-  rv = mDocument->GetBaseURL(docURI);\n+  nsCOMPtr<nsIURI> docURI;\n+  rv = mDocument->GetDocumentURL(getter_AddRefs(docURI));\n   if (NS_FAILED(rv) || !docURI) return NS_ERROR_FAILURE;\n   rv = secMan->CheckLoadURI(docURI, aURL, nsIScriptSecurityManager::ALLOW_CHROME);\n-  NS_IF_RELEASE(docURI);\n   if (NS_FAILED(rv)) return rv;\n \n   // XXX need to add code to cancel any pending sheets for element"}]},"blames":["db688702","f495d0cc","20f5c3c7","87f3c44c","0b7d088e","20f5c3c7","87f3c44c","0b7d088e"]}