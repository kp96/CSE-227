From: Boris Zbarsky <bzbarsky@mit.edu>
Bug 479943.  Pass in the right owner for link clicks and form submissions and stop inheriting from the document.  r=dveditz, sr=jst

diff --git a/docshell/base/nsDocShell.cpp b/docshell/base/nsDocShell.cpp
--- a/docshell/base/nsDocShell.cpp
+++ b/docshell/base/nsDocShell.cpp
@@ -6884,18 +6884,18 @@ nsDocShell::InternalLoad(nsIURI * aURI,
     // callers want something interesting to happen with the about:blank
     // principal in this case, they should pass an owner in.
     //
     {
         PRBool inherits;
         // One more twist: Don't inherit the owner for external loads.
         if (aLoadType != LOAD_NORMAL_EXTERNAL && !owner &&
             (aFlags & INTERNAL_LOAD_FLAGS_INHERIT_OWNER) &&
-            ((NS_SUCCEEDED(URIInheritsSecurityContext(aURI, &inherits)) &&
-              inherits) || URIIsLocalFile(aURI))) {
+            NS_SUCCEEDED(URIInheritsSecurityContext(aURI, &inherits)) &&
+            inherits) {
 
             // Don't allow loads that would inherit our security context
             // if this document came from an unsafe channel.
             nsCOMPtr<nsIDocShellTreeItem> treeItem = this;
             do {
                 nsCOMPtr<nsIDocShell> itemDocShell =
                     do_QueryInterface(treeItem);
                 PRBool isUnsafe;
diff --git a/docshell/base/nsWebShell.cpp b/docshell/base/nsWebShell.cpp
--- a/docshell/base/nsWebShell.cpp
+++ b/docshell/base/nsWebShell.cpp
@@ -873,18 +873,18 @@ nsWebShell::OnLinkClickSync(nsIContent *
   nsAutoString typeHint;
   nsCOMPtr<nsIDOMHTMLAnchorElement> anchor(do_QueryInterface(aContent));
   if (anchor) {
     anchor->GetType(typeHint);
   }
   
   rv = InternalLoad(aURI,               // New URI
                     referer,            // Referer URI
-                    nsnull,             // No onwer
-                    INTERNAL_LOAD_FLAGS_INHERIT_OWNER, // Inherit owner from document
+                    aContent->NodePrincipal(), // Owner is our node's principal
+                    INTERNAL_LOAD_FLAGS_NONE,
                     target.get(),       // Window target
                     NS_LossyConvertUTF16toASCII(typeHint).get(),
                     aPostDataStream,    // Post data stream
                     aHeadersDataStream, // Headers stream
                     LOAD_LINK,          // Load type
                     nsnull,             // No SHEntry
                     PR_TRUE,            // first party site
                     aDocShell,          // DocShell out-param
