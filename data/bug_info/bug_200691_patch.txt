Index: nsXBLService.cpp
===================================================================
RCS file: /m/pub/mozilla/content/xbl/src/nsXBLService.cpp,v
retrieving revision 1.170
diff -u -r1.170 nsXBLService.cpp
--- nsXBLService.cpp	18 Apr 2003 08:44:25 -0000	1.170
+++ nsXBLService.cpp	1 May 2003 00:33:31 -0000
@@ -86,6 +86,7 @@
 #include "nsIDocumentObserver.h"
 #include "nsIFrameManager.h"
 #include "nsStyleContext.h"
+#include "nsIScriptSecurityManager.h"
 
 #ifdef MOZ_XUL
 #include "nsIXULPrototypeCache.h"
@@ -578,7 +579,28 @@
       }
     }
   }
-
+
+  // Security check - remote pages can't load local bindings, except from chrome
+  nsCOMPtr<nsIURI> docURI;
+  rv = document->GetDocumentURL(getter_AddRefs(docURI));
+  NS_ENSURE_SUCCESS(rv, rv); //XXX can a document have no URI here?
+  PRBool isChrome = PR_FALSE;
+  rv = docURI->SchemeIs("chrome", &isChrome);
+
+  if (NS_FAILED(rv) || !isChrome) {
+    nsCOMPtr<nsIURI> bindingURI;
+    rv = NS_NewURI(getter_AddRefs(bindingURI), aURL);
+    NS_ENSURE_SUCCESS(rv, rv);
+
+    nsCOMPtr<nsIScriptSecurityManager> secMan(
+      do_GetService(NS_SCRIPTSECURITYMANAGER_CONTRACTID, &rv));
+    NS_ENSURE_SUCCESS(rv, rv);
+
+    rv = secMan->CheckLoadURI(docURI, bindingURI,
+                              nsIScriptSecurityManager::ALLOW_CHROME);
+    if (NS_FAILED(rv))
+      return rv;
+  }
   nsCOMPtr<nsIXBLBinding> newBinding;
   nsCAutoString url; url.AssignWithConversion(aURL);
   if (NS_FAILED(rv = GetBinding(aContent, url, getter_AddRefs(newBinding)))) {
