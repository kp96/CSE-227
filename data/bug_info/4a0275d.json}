{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas4a0275d\""},"diff":[{"chunks":[{"content":"@@ -110,8 +110,7 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":110,"ln2":110,"content":"   // DAVCollection object"},{"type":"normal","normal":true,"ln1":111,"ln2":111,"content":"   _dav: null,"},{"type":"normal","normal":true,"ln1":112,"ln2":112,"content":" "},{"type":"del","del":true,"ln":113,"content":"-  // Last synced tree"},{"type":"del","del":true,"ln":114,"content":"-  // FIXME: this should be serialized to disk"},{"type":"add","add":true,"ln":113,"content":"+  // Last synced tree and version"},{"type":"normal","normal":true,"ln1":115,"ln2":114,"content":"   _snapshot: {},"},{"type":"normal","normal":true,"ln1":116,"ln2":115,"content":"   _snapshotVersion: 0,"},{"type":"normal","normal":true,"ln1":117,"ln2":116,"content":" "}],"oldStart":110,"oldLines":8,"newStart":110,"newLines":7},{"content":"@@ -263,7 +262,7 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":263,"ln2":262,"content":"   },"},{"type":"normal","normal":true,"ln1":264,"ln2":263,"content":" "},{"type":"normal","normal":true,"ln1":265,"ln2":264,"content":"   _nodeParentsInt: function BSS__nodeParentsInt(guid, tree, parents) {"},{"type":"del","del":true,"ln":266,"content":"-    if (tree[guid] && tree[guid].parentGuid == null)"},{"type":"add","add":true,"ln":265,"content":"+    if (!tree[guid] || !tree[guid].parentGuid)"},{"type":"normal","normal":true,"ln1":267,"ln2":266,"content":"       return parents;"},{"type":"normal","normal":true,"ln1":268,"ln2":267,"content":"     parents.push(tree[guid].parentGuid);"},{"type":"normal","normal":true,"ln1":269,"ln2":268,"content":"     return this._nodeParentsInt(tree[guid].parentGuid, tree, parents);"}],"oldStart":263,"oldLines":7,"newStart":262,"newLines":7},{"content":"@@ -317,7 +316,6 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":317,"ln2":316,"content":"       return true;"},{"type":"normal","normal":true,"ln1":318,"ln2":317,"content":"     if ((a.guid == b.guid) && !this._deepEquals(a, b))"},{"type":"normal","normal":true,"ln1":319,"ln2":318,"content":"       return true;"},{"type":"del","del":true,"ln":320,"content":"-// FIXME - how else can two commands conflict?"},{"type":"normal","normal":true,"ln1":321,"ln2":319,"content":"     return false;"},{"type":"normal","normal":true,"ln1":322,"ln2":320,"content":"   },"},{"type":"normal","normal":true,"ln1":323,"ln2":321,"content":" "}],"oldStart":317,"oldLines":7,"newStart":316,"newLines":6},{"content":"@@ -608,13 +606,16 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":608,"ln2":606,"content":"       case \"uri\":"},{"type":"normal","normal":true,"ln1":609,"ln2":607,"content":"         this._bms.changeBookmarkURI(itemId, makeURI(command.data.uri));"},{"type":"normal","normal":true,"ln1":610,"ln2":608,"content":"         break;"},{"type":"del","del":true,"ln":611,"content":"-      case \"index\": // FIXME: what if we do this one before parentGuid ? that'd be wrong"},{"type":"add","add":true,"ln":609,"content":"+      case \"index\":"},{"type":"normal","normal":true,"ln1":612,"ln2":610,"content":"         this._bms.moveItem(itemId, this._bms.getFolderIdForItem(itemId),"},{"type":"normal","normal":true,"ln1":613,"ln2":611,"content":"                            command.data.index);"},{"type":"normal","normal":true,"ln1":614,"ln2":612,"content":"         break;"},{"type":"normal","normal":true,"ln1":615,"ln2":613,"content":"       case \"parentGuid\":"},{"type":"add","add":true,"ln":614,"content":"+        let index = -1;"},{"type":"add","add":true,"ln":615,"content":"+        if (command.data.index && command.data.index >= 0)"},{"type":"add","add":true,"ln":616,"content":"+          index = command.data.index;"},{"type":"normal","normal":true,"ln1":616,"ln2":617,"content":"         this._bms.moveItem("},{"type":"del","del":true,"ln":617,"content":"-          itemId, this._bms.getItemIdForGUID(command.data.parentGuid), -1);"},{"type":"add","add":true,"ln":618,"content":"+          itemId, this._bms.getItemIdForGUID(command.data.parentGuid), index);"},{"type":"normal","normal":true,"ln1":618,"ln2":619,"content":"         break;"},{"type":"normal","normal":true,"ln1":619,"ln2":620,"content":"       default:"},{"type":"normal","normal":true,"ln1":620,"ln2":621,"content":"         this.notice(\"Warning: Can't change item property: \" + key);"}],"oldStart":608,"oldLines":13,"newStart":606,"newLines":16},{"content":"@@ -791,9 +792,15 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":791,"ln2":792,"content":"                                                   this._wrapNode(localBookmarks));"},{"type":"normal","normal":true,"ln1":792,"ln2":793,"content":"         this._snapshotVersion = server['version'];"},{"type":"normal","normal":true,"ln1":793,"ln2":794,"content":"         this._applyCommands(clientChanges);"},{"type":"del","del":true,"ln":794,"content":"-        // FIXME: should wrapNode to a separate variable and make sure"},{"type":"del","del":true,"ln":795,"content":"-        // that snapshot -> that is an empty diff."},{"type":"del","del":true,"ln":796,"content":"-        this._snapshot = this._wrapNode(localBookmarks);"},{"type":"add","add":true,"ln":795,"content":"+"},{"type":"add","add":true,"ln":796,"content":"+        let newSnapshot = this._wrapNode(localBookmarks);"},{"type":"add","add":true,"ln":797,"content":"+        let diff = this._detectUpdates(this._snapshot, newSnapshot);"},{"type":"add","add":true,"ln":798,"content":"+        if (diff.length != 0) {"},{"type":"add","add":true,"ln":799,"content":"+          this.notice(\"Error: commands did not apply correctly.  Diff:\\n\" +"},{"type":"add","add":true,"ln":800,"content":"+                      uneval(diff));"},{"type":"add","add":true,"ln":801,"content":"+          this._snapshot = this._wrapNode(localBookmarks);"},{"type":"add","add":true,"ln":802,"content":"+          // FIXME: What else can we do?"},{"type":"add","add":true,"ln":803,"content":"+        }"},{"type":"normal","normal":true,"ln1":797,"ln2":804,"content":"         this._saveSnapshot();"},{"type":"normal","normal":true,"ln1":798,"ln2":805,"content":"       }"},{"type":"normal","normal":true,"ln1":799,"ln2":806,"content":" "}],"oldStart":791,"oldLines":9,"newStart":792,"newLines":15},{"content":"@@ -810,7 +817,8 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":810,"ln2":817,"content":"           this.notice(\"Successfully updated deltas on server\");"},{"type":"normal","normal":true,"ln1":811,"ln2":818,"content":"           this._saveSnapshot();"},{"type":"normal","normal":true,"ln1":812,"ln2":819,"content":"         } else {"},{"type":"del","del":true,"ln":813,"content":"-          // FIXME: revert snapshot here?"},{"type":"add","add":true,"ln":820,"content":"+          // FIXME: revert snapshot here? - can't, we already applied"},{"type":"add","add":true,"ln":821,"content":"+          // updates locally! - need to save and retry"},{"type":"normal","normal":true,"ln1":814,"ln2":822,"content":"           this.notice(\"Error: could not update deltas on server\");"},{"type":"normal","normal":true,"ln1":815,"ln2":823,"content":"         }"},{"type":"normal","normal":true,"ln1":816,"ln2":824,"content":"       }"}],"oldStart":810,"oldLines":7,"newStart":817,"newLines":8},{"content":"@@ -857,6 +865,7 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":857,"ln2":865,"content":"       var tmp = eval(uneval(this._snapshot)); // fixme hack hack hack"},{"type":"normal","normal":true,"ln1":858,"ln2":866,"content":" "},{"type":"normal","normal":true,"ln1":859,"ln2":867,"content":"       // FIXME: debug here for conditional below..."},{"type":"add","add":true,"ln":868,"content":"+      /*"},{"type":"normal","normal":true,"ln1":860,"ln2":869,"content":"       this.notice(\"[sync bowels] local version: \" + this._snapshotVersion);"},{"type":"normal","normal":true,"ln1":861,"ln2":870,"content":"       for (var z in ret.deltas) {"},{"type":"normal","normal":true,"ln1":862,"ln2":871,"content":"         this.notice(\"[sync bowels] remote version: \" + z);"}],"oldStart":857,"oldLines":6,"newStart":865,"newLines":7},{"content":"@@ -866,6 +875,7 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":866,"ln2":875,"content":"         this.notice(\"-> is true\");"},{"type":"normal","normal":true,"ln1":867,"ln2":876,"content":"       else"},{"type":"normal","normal":true,"ln1":868,"ln2":877,"content":"         this.notice(\"-> is false\");"},{"type":"add","add":true,"ln":878,"content":"+      */"},{"type":"normal","normal":true,"ln1":869,"ln2":879,"content":" "},{"type":"normal","normal":true,"ln1":870,"ln2":880,"content":"       if (ret.deltas[this._snapshotVersion + 1]) {"},{"type":"normal","normal":true,"ln1":871,"ln2":881,"content":"         // Merge the matching deltas into one, find highest version"}],"oldStart":866,"oldLines":6,"newStart":875,"newLines":7},{"content":"@@ -877,10 +887,10 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":877,"ln2":887,"content":"             ret.version = v;"},{"type":"normal","normal":true,"ln1":878,"ln2":888,"content":"         }"},{"type":"normal","normal":true,"ln1":879,"ln2":889,"content":"         keys = keys.sort();"},{"type":"del","del":true,"ln":880,"content":"-        this.notice(\"TMP: \" + uneval(tmp));"},{"type":"add","add":true,"ln":890,"content":"+        //this.notice(\"TMP: \" + uneval(tmp));"},{"type":"normal","normal":true,"ln1":881,"ln2":891,"content":"         for (var i = 0; i < keys.length; i++) {"},{"type":"normal","normal":true,"ln1":882,"ln2":892,"content":"           tmp = this._applyCommandsToObj(ret.deltas[keys[i]], tmp);"},{"type":"del","del":true,"ln":883,"content":"-          this.notice(\"TMP: \" + uneval(tmp));"},{"type":"add","add":true,"ln":893,"content":"+          //this.notice(\"TMP: \" + uneval(tmp));"},{"type":"normal","normal":true,"ln1":884,"ln2":894,"content":"         }"},{"type":"normal","normal":true,"ln1":885,"ln2":895,"content":"         ret.status = 1;"},{"type":"normal","normal":true,"ln1":886,"ln2":896,"content":"         ret[\"updates\"] = this._detectUpdates(this._snapshot, tmp);"}],"oldStart":877,"oldLines":10,"newStart":887,"newLines":10}],"deletions":12,"additions":22,"from":"services/sync/nsBookmarksSyncService.js","to":"services/sync/nsBookmarksSyncService.js","index":["e5c6cf7..463d366","100644"]}]}