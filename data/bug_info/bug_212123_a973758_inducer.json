{"bug_id":212123,"commitHash":"a973758","commit_info":{"sha":"a9737587bb878da4dfd769fcdab723ea07b13644","commit":{"author":{"name":"roc+%cs.cmu.edu","email":"roc+%cs.cmu.edu","date":"2005-03-09T00:41:56Z"},"committer":{"name":"roc+%cs.cmu.edu","email":"roc+%cs.cmu.edu","date":"2005-03-09T00:41:56Z"},"message":"Bug 212123. Fix temp file creation in nsFileSpec. r+sr=darin,a=dveditz","tree":{"sha":"bd6b37652929333b044674a317736c98bf64c08d","url":"https://api.github.com/repos/mozilla/gecko-dev/git/trees/bd6b37652929333b044674a317736c98bf64c08d"},"url":"https://api.github.com/repos/mozilla/gecko-dev/git/commits/a9737587bb878da4dfd769fcdab723ea07b13644","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/mozilla/gecko-dev/commits/a9737587bb878da4dfd769fcdab723ea07b13644","html_url":"https://github.com/mozilla/gecko-dev/commit/a9737587bb878da4dfd769fcdab723ea07b13644","comments_url":"https://api.github.com/repos/mozilla/gecko-dev/commits/a9737587bb878da4dfd769fcdab723ea07b13644/comments","author":null,"committer":null,"parents":[{"sha":"76e83267c4ffc2241a463ab99473e875ac71ef44","url":"https://api.github.com/repos/mozilla/gecko-dev/commits/76e83267c4ffc2241a463ab99473e875ac71ef44","html_url":"https://github.com/mozilla/gecko-dev/commit/76e83267c4ffc2241a463ab99473e875ac71ef44"}],"stats":{"total":23,"additions":16,"deletions":7},"files":[{"sha":"68d6e5e8c1ab9fb61228442448401c11182dc994","filename":"xpcom/obsolete/nsFileSpec.cpp","status":"modified","additions":11,"deletions":3,"changes":14,"blob_url":"https://github.com/mozilla/gecko-dev/blob/a9737587bb878da4dfd769fcdab723ea07b13644/xpcom/obsolete/nsFileSpec.cpp","raw_url":"https://github.com/mozilla/gecko-dev/raw/a9737587bb878da4dfd769fcdab723ea07b13644/xpcom/obsolete/nsFileSpec.cpp","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/xpcom/obsolete/nsFileSpec.cpp?ref=a9737587bb878da4dfd769fcdab723ea07b13644","patch":"@@ -49,6 +49,7 @@\n #include \"nsCOMPtr.h\"\n #include \"nsIServiceManager.h\"\n #include \"nsILocalFile.h\"\n+#include \"nsIFileStream.h\"\n \n #include <string.h>\n #include <stdio.h>\n@@ -909,8 +910,11 @@ void nsFileSpec::MakeUnique(const char* inSuggestedLeafName)\n void nsFileSpec::MakeUnique()\n //----------------------------------------------------------------------------------------\n {\n-    if (!Exists())\n-        return;\n+    nsCOMPtr<nsISupports> file;\n+    nsresult rv = NS_NewIOFileStream(getter_AddRefs(file), *this, \n+                                     PR_WRONLY | PR_CREATE_FILE | PR_EXCL | PR_TRUNCATE, 0600);\n+    if (NS_SUCCEEDED(rv))\n+        return; // the stream will be closed automatically\n \n     char* leafName = GetLeafName();\n     if (!leafName)\n@@ -927,12 +931,16 @@ void nsFileSpec::MakeUnique()\n         = nsFileSpecHelpers::kMaxCoreLeafNameLength - strlen(suffix) - 1;\n     if ((int)strlen(leafName) > (int)kMaxRootLength)\n         leafName[kMaxRootLength] = '\\0';\n-    for (short indx = 1; indx < 1000 && Exists(); indx++)\n+    for (short indx = 1; indx < 1000; indx++)\n     {\n         // start with \"Picture-1.jpg\" after \"Picture.jpg\" exists\n         char newName[nsFileSpecHelpers::kMaxFilenameLength + 1];\n         sprintf(newName, \"%s-%d%s\", leafName, indx, suffix);\n         SetLeafName(newName);\n+        rv = NS_NewIOFileStream(getter_AddRefs(file), *this, \n+                                PR_WRONLY | PR_CREATE_FILE | PR_EXCL | PR_TRUNCATE, 0600);\n+        if (NS_SUCCEEDED(rv))\n+            break;\n     }\n     if (*suffix)\n         nsCRT::free(suffix);"},{"sha":"6d86aac99a27b235eba946d0107cdec901a4ac5c","filename":"xpcom/obsolete/nsFileSpec.h","status":"modified","additions":5,"deletions":4,"changes":9,"blob_url":"https://github.com/mozilla/gecko-dev/blob/a9737587bb878da4dfd769fcdab723ea07b13644/xpcom/obsolete/nsFileSpec.h","raw_url":"https://github.com/mozilla/gecko-dev/raw/a9737587bb878da4dfd769fcdab723ea07b13644/xpcom/obsolete/nsFileSpec.h","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/xpcom/obsolete/nsFileSpec.h?ref=a9737587bb878da4dfd769fcdab723ea07b13644","patch":"@@ -460,10 +460,6 @@ class NS_COM_OBSOLETE nsFileSpec\n         void                    operator += (const char* inRelativeUnixPath);\n \n \n-        void                    MakeUnique();\n-        void                    MakeUnique(const char* inSuggestedLeafName);\n-    \n-                               \n         PRBool                  IsDirectory() const;          // More stringent than Exists()                               \n         PRBool                  IsFile() const;               // More stringent than Exists()\n         PRBool                  Exists() const;\n@@ -476,6 +472,11 @@ class NS_COM_OBSOLETE nsFileSpec\n     // Creation and deletion of objects.  These can modify the disk.\n     //--------------------------------------------------\n \n+    // For security reasons, these create the file.\n+        void                    MakeUnique();\n+        void                    MakeUnique(const char* inSuggestedLeafName);\n+    \n+                               \n                                 // Called for the spec of an alias.  Modifies the spec to\n                                 // point to the original.  Sets mError.\n         nsresult                ResolveSymlink(PRBool& wasSymlink);"}]},"blames":["89bcfadd","89bcfadd"]}