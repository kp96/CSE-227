# HG changeset patch
# User Gavin Sharp <gavin@gavinsharp.com>
# Date 1279834459 14400
# Node ID 480458511b15206d16f9c5f88e96bddd399b17c1
# Parent  01c3815b6d545b84cd671c36e41bb906e8323462
Bug 581176: Allow disabling BadCertListener's "built-in cert" checking for redirects

diff --git a/toolkit/mozapps/shared/CertUtils.jsm b/toolkit/mozapps/shared/CertUtils.jsm
--- a/toolkit/mozapps/shared/CertUtils.jsm
+++ b/toolkit/mozapps/shared/CertUtils.jsm
@@ -73,22 +73,26 @@ function isBuiltinToken(tokenName) {
   return tokenName == "Builtin Object Token";
 }
 
 /**
  * This class implements nsIBadCertListener.  Its job is to prevent "bad cert"
  * security dialogs from being shown to the user.  It is better to simply fail
  * if the certificate is bad. See bug 304286.
  */
-function BadCertHandler() {
+function BadCertHandler(aAllowNonBuiltInCerts) {
+  this.allowNonBuiltInCerts = aAllowNonBuiltInCerts;
 }
 BadCertHandler.prototype = {
 
   // nsIChannelEventSink
   onChannelRedirect: function(oldChannel, newChannel, flags) {
+    if (this.allowNonBuiltInCerts)
+      return;
+
     // make sure the certificate of the old channel checks out before we follow
     // a redirect from it.  See bug 340198.
     // Don't call checkCert for internal redirects. See bug 569648.
     if (!(flags & Components.interfaces.nsIChannelEventSink.REDIRECT_INTERNAL))
       checkCert(oldChannel);
   },
 
   // Suppress any certificate errors
