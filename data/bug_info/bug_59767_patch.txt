Index: Makefile.in
===================================================================
RCS file: /m/pub/mozilla/modules/plugin/base/src/Makefile.in,v
retrieving revision 1.88
diff -u -r1.88 Makefile.in
--- Makefile.in	8 Mar 2003 05:56:50 -0000	1.88
+++ Makefile.in	1 Apr 2003 01:40:06 -0000
@@ -58,6 +58,7 @@
 		  windowwatcher \
 		  imglib2 \
 		  layout \
+		  js \
 		  $(NULL)
 # for xlib port
 REQUIRES	+= xlibxtbin xlibrgb
Index: nsPluginHostImpl.cpp
===================================================================
RCS file: /m/pub/mozilla/modules/plugin/base/src/nsPluginHostImpl.cpp,v
retrieving revision 1.469
diff -u -r1.469 nsPluginHostImpl.cpp
--- nsPluginHostImpl.cpp	25 Mar 2003 14:55:35 -0000	1.469
+++ nsPluginHostImpl.cpp	1 Apr 2003 01:40:07 -0000
@@ -49,6 +49,7 @@
 #include "nsIPlugin.h"
 #ifdef OJI
 #include "nsIJVMPlugin.h"
+#include "nsIJVMPluginInstance.h"
 #include "nsIJVMManager.h"
 #endif
 #include "nsIPluginStreamListener.h"
@@ -159,6 +160,7 @@
 #include "nsISupportsArray.h"
 #include "nsIDocShell.h"
 #include "nsPluginNativeWindow.h"
+#include "nsIScriptSecurityManager.h"
 
 #if defined(XP_MAC) && TARGET_CARBON
 #include "nsIClassicPluginFactory.h"
@@ -2885,7 +2887,7 @@
   nsresult          rv;
 
   // we can only send a stream back to the plugin (as specified by a 
-  // null target) if we also have a nsIPluginStreamListener to talk to also
+  // null target) if we also have a nsIPluginStreamListener to talk to
   if(target == nsnull && streamListener == nsnull)
    return NS_ERROR_ILLEGAL_VALUE;
 
@@ -2893,6 +2895,16 @@
 
   if (NS_SUCCEEDED(rv))
   {
+    // if this is a Java plugin calling, we need to do a security check
+    nsresult rv2;
+    nsCOMPtr<nsIJVMPluginInstance> javaInstance(do_QueryInterface(instance, &rv2));
+    
+    if (NS_SUCCEEDED(rv2))
+        rv = DoURLLoadSecurityCheck(instance, url);
+  }
+  
+  if (NS_SUCCEEDED(rv))
+  {
     if (nsnull != target)
     {
       nsCOMPtr<nsIPluginInstancePeer> peer;
@@ -2948,6 +2960,17 @@
    return NS_ERROR_ILLEGAL_VALUE;
   
   nsCOMPtr<nsIPluginInstance> instance = do_QueryInterface(pluginInst, &rv);
+
+  if (NS_SUCCEEDED(rv))
+  {
+    // if this is a Java plugin calling, we need to do a security check
+    nsresult rv2;
+    nsCOMPtr<nsIJVMPluginInstance> javaInstance(do_QueryInterface(instance, &rv2));
+    
+    if (NS_SUCCEEDED(rv2))
+        rv = DoURLLoadSecurityCheck(instance, url);
+  }
+
   if (NS_SUCCEEDED(rv))
   {
       char *dataToPost;
@@ -5696,6 +5719,56 @@
     NS_RELEASE(listenerPeer);
   }
   return rv;
+}
+
+nsresult
+nsPluginHostImpl::DoURLLoadSecurityCheck(nsIPluginInstance *aInstance,
+                                         const char* aURL)
+{
+  nsresult rv;
+
+  if (!aURL || *aURL == '\0')
+    return NS_OK;
+
+  // get the URL of the document that loaded the plugin
+  nsCOMPtr<nsIDocument> doc;
+  nsCOMPtr<nsIPluginInstancePeer> peer;
+  nsCOMPtr<nsIURI> sourceURL;
+  rv = aInstance->GetPeer(getter_AddRefs(peer));
+  if (NS_FAILED(rv) || !peer)
+    return NS_ERROR_FAILURE;
+
+  nsCOMPtr<nsPIPluginInstancePeer> privpeer(do_QueryInterface(peer));
+  nsCOMPtr<nsIPluginInstanceOwner> owner;
+  rv = privpeer->GetOwner(getter_AddRefs(owner));
+  if (!owner)
+    return NS_ERROR_FAILURE;
+
+  rv = owner->GetDocument(getter_AddRefs(doc));
+  if (!doc)
+    return NS_ERROR_FAILURE;
+
+  rv = doc->GetDocumentURL(getter_AddRefs(sourceURL));
+  if (!sourceURL)
+    return NS_ERROR_FAILURE;
+
+  // Create an absolute URL for the target in case the target is relative
+  nsCOMPtr<nsIURI> docBaseURL;
+  doc->GetBaseURL(*getter_AddRefs(docBaseURL));
+
+  nsCOMPtr<nsIURI> targetURL;
+  rv = NS_NewURI(getter_AddRefs(targetURL), aURL, docBaseURL);
+
+  if (!targetURL)
+    return NS_ERROR_FAILURE;
+
+  nsCOMPtr<nsIScriptSecurityManager> secMan(
+    do_GetService(NS_SCRIPTSECURITYMANAGER_CONTRACTID, &rv));
+  if (NS_FAILED(rv))
+    return rv;
+
+  return secMan->CheckLoadURI(sourceURL, targetURL, nsIScriptSecurityManager::STANDARD);
+
 }
 
 
Index: nsPluginHostImpl.h
===================================================================
RCS file: /m/pub/mozilla/modules/plugin/base/src/nsPluginHostImpl.h,v
retrieving revision 1.91
diff -u -r1.91 nsPluginHostImpl.h
--- nsPluginHostImpl.h	15 Mar 2003 01:03:44 -0000	1.91
+++ nsPluginHostImpl.h	1 Apr 2003 01:40:07 -0000
@@ -392,6 +392,10 @@
                      const char *aHeadersData = nsnull, 
                      PRUint32 aHeadersDataLen = 0);
 
+  nsresult
+  DoURLLoadSecurityCheck(nsIPluginInstance *aInstance,
+                         const char* aURL);
+
   NS_IMETHOD
   AddHeadersToChannel(const char *aHeadersData, PRUint32 aHeadersDataLen, 
                       nsIChannel *aGenericChannel);
