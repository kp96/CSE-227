{"bug_id":315166,"commitHash":"bd9182d","commit_info":{"sha":"bd9182dfa8836c1f7dea54166369c2c9944749c6","commit":{"author":{"name":"gavin%gavinsharp.com","email":"gavin%gavinsharp.com","date":"2006-02-05T19:42:23Z"},"committer":{"name":"gavin%gavinsharp.com","email":"gavin%gavinsharp.com","date":"2006-02-05T19:42:23Z"},"message":"Bug 315166: make the text-link binding be more careful about which protocols it allows, r=mconnor","tree":{"sha":"b2af78d85f3579f0c19d064ebc427839aaa9dfcc","url":"https://api.github.com/repos/mozilla/gecko-dev/git/trees/b2af78d85f3579f0c19d064ebc427839aaa9dfcc"},"url":"https://api.github.com/repos/mozilla/gecko-dev/git/commits/bd9182dfa8836c1f7dea54166369c2c9944749c6","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/mozilla/gecko-dev/commits/bd9182dfa8836c1f7dea54166369c2c9944749c6","html_url":"https://github.com/mozilla/gecko-dev/commit/bd9182dfa8836c1f7dea54166369c2c9944749c6","comments_url":"https://api.github.com/repos/mozilla/gecko-dev/commits/bd9182dfa8836c1f7dea54166369c2c9944749c6/comments","author":null,"committer":null,"parents":[{"sha":"3ceefe127dffb7e35bcb78971368f58b5596aa4d","url":"https://api.github.com/repos/mozilla/gecko-dev/commits/3ceefe127dffb7e35bcb78971368f58b5596aa4d","html_url":"https://github.com/mozilla/gecko-dev/commit/3ceefe127dffb7e35bcb78971368f58b5596aa4d"}],"stats":{"total":105,"additions":74,"deletions":31},"files":[{"sha":"81bf0ef7917d5cb1fad4fde7e29ecf389e25c60d","filename":"toolkit/content/widgets/autocomplete.xml","status":"modified","additions":22,"deletions":1,"changes":23,"blob_url":"https://github.com/mozilla/gecko-dev/blob/bd9182dfa8836c1f7dea54166369c2c9944749c6/toolkit/content/widgets/autocomplete.xml","raw_url":"https://github.com/mozilla/gecko-dev/raw/bd9182dfa8836c1f7dea54166369c2c9944749c6/toolkit/content/widgets/autocomplete.xml","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/toolkit/content/widgets/autocomplete.xml?ref=bd9182dfa8836c1f7dea54166369c2c9944749c6","patch":"@@ -333,9 +333,11 @@\n \n       <method name=\"showHistoryPopup\">\n         <body><![CDATA[\n+#ifndef MOZILLA_1_8_BRANCH\n           // This is an autocomplete widget, but we want the rollup event\n           // to be consumed, as if we were a menulist.\n           this.popup.popupBoxObject.setConsumeRollupEvent(Components.interfaces.nsIPopupBoxObject.ROLLUP_CONSUME);\n+#endif\n \n           this.maxRows = 14;\n           this.attachController();\n@@ -726,7 +728,16 @@\n           controller.handleEnter();\n         ]]></body>\n       </method>\n-      \n+#ifdef MOZILLA_1_8_BRANCH\n+\n+      <method name=\"clearOpenProperty\">\n+        <parameter name=\"aPopupNode\"/>\n+        <body><![CDATA[\n+          aPopupNode.mPopupOpen = false;\n+        ]]></body>\n+      </method>\n+#endif\n+\n     </implementation>\n \n     <handlers>\n@@ -735,7 +746,11 @@\n       </handler>\n \n       <handler event=\"popuphiding\">\n+#ifdef MOZILLA_1_8_BRANCH\n+        setTimeout(this.clearOpenProperty, 0, this);\n+#else\n         this.mPopupOpen = false;\n+#endif\n         this.mInput.maxRows = 6;\n       </handler>\n     </handlers>\n@@ -819,7 +834,13 @@\n       <method name=\"showPopup\">\n         <body><![CDATA[\n           var textbox = document.getBindingParent(this);\n+#ifdef MOZILLA_1_8_BRANCH\n+          if (!textbox.popup.mPopupOpen) { \n+            textbox.showHistoryPopup();\n+          }\n+#else\n           textbox.showHistoryPopup();\n+#endif\n         ]]></body>\n       </method>\n     </implementation>"},{"sha":"653970bbc24cd81deeab7bdeccbc9f8cf6d24afd","filename":"toolkit/content/widgets/text.xml","status":"modified","additions":52,"deletions":30,"changes":82,"blob_url":"https://github.com/mozilla/gecko-dev/blob/bd9182dfa8836c1f7dea54166369c2c9944749c6/toolkit/content/widgets/text.xml","raw_url":"https://github.com/mozilla/gecko-dev/raw/bd9182dfa8836c1f7dea54166369c2c9944749c6/toolkit/content/widgets/text.xml","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/toolkit/content/widgets/text.xml?ref=bd9182dfa8836c1f7dea54166369c2c9944749c6","patch":"@@ -291,52 +291,74 @@\n       </property>\n       <property name=\"href\" onget=\"return this.getAttribute('href');\"\n                             onset=\"this.setAttribute('href', val); return val;\" />\n-      <method name=\"open\">    \n+      <method name=\"open\">\n         <parameter name=\"aEvent\"/>\n         <body>\n         <![CDATA[\n-          if (this.disabled || aEvent.getPreventDefault())\n+          var href = this.href;\n+          if (!href || this.disabled || aEvent.getPreventDefault())\n             return;\n-          var href = this.getAttribute('href');\n-\r\n-          if (href)\n-          {\n+\n+          var uri = null;\n+          try {\n+            const nsISSM = Components.interfaces.nsIScriptSecurityManager;\n+            const secMan =\n+                     Components.classes[\"@mozilla.org/scriptsecuritymanager;1\"]\n+                               .getService(nsISSM);\n+\n+            const ioService =\n+                     Components.classes[\"@mozilla.org/network/io-service;1\"]\n+                               .getService(Components.interfaces.nsIIOService);\n+\n+            uri = ioService.newURI(href, null, null);\n+            var safeURI = ioService.newURI(\"about:blank\", null, null);\n+\n             try {\n-              var uri = Components.classes[\"@mozilla.org/network/io-service;1\"]\n-                                  .getService(Components.interfaces.nsIIOService)\n-                                  .newURI(href, null, null);\n-\n-              var protocolSvc = Components.classes[\"@mozilla.org/uriloader/external-protocol-service;1\"]\n-                                          .getService(Components.interfaces.nsIExternalProtocolService);\n-              // if the scheme is not an exposed protocol, then opening this link should \n-              // be deferred to the system's external protocol handler\n-              if (!protocolSvc.isExposedProtocol(uri.scheme))\n-              {\n-                protocolSvc.loadUrl(uri);\n-                aEvent.preventDefault()\n-                return;\n-              }\n+              secMan.checkLoadURI(safeURI, uri, nsISSM.DISALLOW_SCRIPT_OR_DATA)\n+            } catch (ex) {\n+              var msg = \"Error: Cannot open a \" + uri.scheme + \": link using \\\n+                         the text-link binding.\";\n+              Components.utils.reportError(msg);\n+              return;\n             }\n-            catch (ex) {}\n-          \n-            // otherwise, fall back to opening the anchor directly\n-            var win = window;\n-            if (window instanceof Components.interfaces.nsIDOMChromeWindow) {\n-              while (win.opener && !win.opener.closed) \n-                win = win.opener;\n+\n+            const cID = \"@mozilla.org/uriloader/external-protocol-service;1\";\n+            const nsIEPS = Components.interfaces.nsIExternalProtocolService;\n+            var protocolSvc = Components.classes[contractID]\n+                                        .getService(nsIEPS);\n+\n+            // if the scheme is not an exposed protocol, then opening this link\n+            // should be deferred to the system's external protocol handler\n+            if (!protocolSvc.isExposedProtocol(uri.scheme)) {\n+              protocolSvc.loadUrl(uri);\n+              aEvent.preventDefault()\n+              return;\n             }\n-            win.open(href);\n \n-            aEvent.preventDefault();\n+          } catch (ex) {}\n+\n+          // otherwise, fall back to opening the anchor directly\n+          var win = window;\n+          if (window instanceof Components.interfaces.nsIDOMChromeWindow) {\n+            while (win.opener && !win.opener.closed)\n+              win = win.opener;\n           }\n+\n+          if (uri)\n+            win.open(uri.spec);\n+          else\n+            win.open(href);\n+\n+          aEvent.preventDefault();\n+\n         ]]>\n         </body>\n       </method>\n     </implementation>\n \n     <handlers>\n       <handler event=\"click\" phase=\"capturing\" button=\"0\" action=\"this.open(event)\"/>\n-      <handler event=\"keypress\" preventdefault=\"true\" keycode=\"VK_ENTER\" action=\"this.click()\" />\n+      <handler event=\"keypress\" preventdefault=\"true\" keycode=\"VK_ENTER\"  action=\"this.click()\" />\n       <handler event=\"keypress\" preventdefault=\"true\" keycode=\"VK_RETURN\" action=\"this.click()\" />\n     </handlers>\n   </binding>"}]},"blames":["ecf5b015","6f179597","4056e69c","2039ce29","ec03b500","2208504d","37412e5b"]}