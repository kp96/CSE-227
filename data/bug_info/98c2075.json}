{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas98c2075\""},"diff":[{"chunks":[{"content":"@@ -110,10 +110,24 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":110,"ln2":110,"content":"   // DAVCollection object"},{"type":"normal","normal":true,"ln1":111,"ln2":111,"content":"   _dav: null,"},{"type":"normal","normal":true,"ln1":112,"ln2":112,"content":" "},{"type":"del","del":true,"ln":113,"content":"-  // Last synced tree and version"},{"type":"add","add":true,"ln":113,"content":"+  // Last synced tree, version, and GUID (to detect if the store has"},{"type":"add","add":true,"ln":114,"content":"+  // been completely replaced and invalidate the snapshot)"},{"type":"normal","normal":true,"ln1":114,"ln2":115,"content":"   _snapshot: {},"},{"type":"normal","normal":true,"ln1":115,"ln2":116,"content":"   _snapshotVersion: 0,"},{"type":"normal","normal":true,"ln1":116,"ln2":117,"content":" "},{"type":"add","add":true,"ln":118,"content":"+  __snapshotGuid: null,"},{"type":"add","add":true,"ln":119,"content":"+  get _snapshotGuid() {"},{"type":"add","add":true,"ln":120,"content":"+    if (!this.__snapshotGuid) {"},{"type":"add","add":true,"ln":121,"content":"+      let uuidgen = Cc[\"@mozilla.org/uuid-generator;1\"]."},{"type":"add","add":true,"ln":122,"content":"+        getService(Ci.nsIUUIDGenerator);"},{"type":"add","add":true,"ln":123,"content":"+      this.__snapshotGuid = uuidgen.generateUUID().toString().replace(/[{}]/g, '');"},{"type":"add","add":true,"ln":124,"content":"+    }"},{"type":"add","add":true,"ln":125,"content":"+    return this.__snapshotGuid;"},{"type":"add","add":true,"ln":126,"content":"+  },"},{"type":"add","add":true,"ln":127,"content":"+  set _snapshotGuid(guid) {"},{"type":"add","add":true,"ln":128,"content":"+    this.__snapshotGuid = guid;"},{"type":"add","add":true,"ln":129,"content":"+  },"},{"type":"add","add":true,"ln":130,"content":"+"},{"type":"normal","normal":true,"ln1":117,"ln2":131,"content":"   get currentUser() {"},{"type":"normal","normal":true,"ln1":118,"ln2":132,"content":"     return this._dav.currentUser;"},{"type":"normal","normal":true,"ln1":119,"ln2":133,"content":"   },"}],"oldStart":110,"oldLines":10,"newStart":110,"newLines":24},{"content":"@@ -172,7 +186,9 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":172,"ln2":186,"content":"     let flags = MODE_WRONLY | MODE_CREATE | MODE_TRUNCATE;"},{"type":"normal","normal":true,"ln1":173,"ln2":187,"content":"     fos.init(file, flags, PERMS_FILE, 0);"},{"type":"normal","normal":true,"ln1":174,"ln2":188,"content":" "},{"type":"del","del":true,"ln":175,"content":"-    let out = {version: this._snapshotVersion, snapshot: this._snapshot};"},{"type":"add","add":true,"ln":189,"content":"+    let out = {version: this._snapshotVersion,"},{"type":"add","add":true,"ln":190,"content":"+               guid: this._snapshotGuid,"},{"type":"add","add":true,"ln":191,"content":"+               snapshot: this._snapshot};"},{"type":"normal","normal":true,"ln1":176,"ln2":192,"content":"     out = uneval(out);"},{"type":"normal","normal":true,"ln1":177,"ln2":193,"content":"     fos.write(out, out.length);"},{"type":"normal","normal":true,"ln1":178,"ln2":194,"content":"     fos.close();"}],"oldStart":172,"oldLines":7,"newStart":186,"newLines":9},{"content":"@@ -202,9 +218,10 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":202,"ln2":218,"content":"     fis.close();"},{"type":"normal","normal":true,"ln1":203,"ln2":219,"content":"     json = eval(json);"},{"type":"normal","normal":true,"ln1":204,"ln2":220,"content":" "},{"type":"del","del":true,"ln":205,"content":"-    if (json.snapshot && json.version) {"},{"type":"add","add":true,"ln":221,"content":"+    if (json && json.snapshot && json.version && json.guid) {"},{"type":"normal","normal":true,"ln1":206,"ln2":222,"content":"       this._snapshot = json.snapshot;"},{"type":"normal","normal":true,"ln1":207,"ln2":223,"content":"       this._snapshotVersion = json.version;"},{"type":"add","add":true,"ln":224,"content":"+      this._snapshotGuid = json.guid;"},{"type":"normal","normal":true,"ln1":208,"ln2":225,"content":"     }"},{"type":"normal","normal":true,"ln1":209,"ln2":226,"content":"   },"},{"type":"normal","normal":true,"ln1":210,"ln2":227,"content":" "}],"oldStart":202,"oldLines":9,"newStart":218,"newLines":10},{"content":"@@ -699,8 +716,9 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":699,"ln2":716,"content":" "},{"type":"normal","normal":true,"ln1":700,"ln2":717,"content":"       this.notice(\"Server status: \" + server.status);"},{"type":"normal","normal":true,"ln1":701,"ln2":718,"content":"       this.notice(\"Server version: \" + server.version);"},{"type":"del","del":true,"ln":702,"content":"-      this.notice(\"Server version type: \" + typeof server.version);"},{"type":"add","add":true,"ln":719,"content":"+      this.notice(\"Server guid: \" + server.guid);"},{"type":"normal","normal":true,"ln1":703,"ln2":720,"content":"       this.notice(\"Local snapshot version: \" + this._snapshotVersion);"},{"type":"add","add":true,"ln":721,"content":"+      this.notice(\"Local snapshot guid: \" + this._snapshotGuid);"},{"type":"normal","normal":true,"ln1":704,"ln2":722,"content":" "},{"type":"normal","normal":true,"ln1":705,"ln2":723,"content":"       for (version in server.deltas) {"},{"type":"normal","normal":true,"ln1":706,"ln2":724,"content":"         this.notice(\"Server delta \" + version + \":\\n\" +"}],"oldStart":699,"oldLines":8,"newStart":716,"newLines":9},{"content":"@@ -717,6 +735,13 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":717,"ln2":735,"content":"         return;"},{"type":"normal","normal":true,"ln1":718,"ln2":736,"content":"       }"},{"type":"normal","normal":true,"ln1":719,"ln2":737,"content":" "},{"type":"add","add":true,"ln":738,"content":"+      if (this._snapshotGuid != server.guid) {"},{"type":"add","add":true,"ln":739,"content":"+        this.notice(\"Snapshot GUIDs differ, local snapshot is not valid\");"},{"type":"add","add":true,"ln":740,"content":"+        this._snapshot = {};"},{"type":"add","add":true,"ln":741,"content":"+        this._snapshotVersion = -1;"},{"type":"add","add":true,"ln":742,"content":"+        this._snapshotGuid = server.guid;"},{"type":"add","add":true,"ln":743,"content":"+      }"},{"type":"add","add":true,"ln":744,"content":"+"},{"type":"normal","normal":true,"ln1":720,"ln2":745,"content":"       // 2) Generate local deltas from snapshot -> current client status"},{"type":"normal","normal":true,"ln1":721,"ln2":746,"content":" "},{"type":"normal","normal":true,"ln1":722,"ln2":747,"content":"       let localUpdates = this._detectUpdates(this._snapshot, localJson);"}],"oldStart":717,"oldLines":6,"newStart":735,"newLines":13},{"content":"@@ -799,7 +824,9 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":799,"ln2":824,"content":"         this._snapshot = this._getBookmarks();"},{"type":"normal","normal":true,"ln1":800,"ln2":825,"content":"         this._snapshotVersion = server['version'] + 1;"},{"type":"normal","normal":true,"ln1":801,"ln2":826,"content":"         server['deltas']['version ' + this._snapshotVersion] = serverChanges;"},{"type":"del","del":true,"ln":802,"content":"-        this._dav.PUT(\"bookmarks.delta\", uneval(server['deltas']), handlers);"},{"type":"add","add":true,"ln":827,"content":"+"},{"type":"add","add":true,"ln":828,"content":"+        let out = {guid: this._snapshotGuid, deltas: server['deltas']};"},{"type":"add","add":true,"ln":829,"content":"+        this._dav.PUT(\"bookmarks.delta\", uneval(out), handlers);"},{"type":"normal","normal":true,"ln1":803,"ln2":830,"content":"         data = yield;"},{"type":"normal","normal":true,"ln1":804,"ln2":831,"content":" "},{"type":"normal","normal":true,"ln1":805,"ln2":832,"content":"         if (data.target.status >= 200 || data.target.status < 300) {"}],"oldStart":799,"oldLines":7,"newStart":824,"newLines":9},{"content":"@@ -830,6 +857,9 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":830,"ln2":857,"content":"    *      2: ok, initial sync"},{"type":"normal","normal":true,"ln1":831,"ln2":858,"content":"    *   version:"},{"type":"normal","normal":true,"ln1":832,"ln2":859,"content":"    *     the latest version on the server"},{"type":"add","add":true,"ln":860,"content":"+   *   guid:"},{"type":"add","add":true,"ln":861,"content":"+   *     the guid that was created when the first snapshot was uploaded"},{"type":"add","add":true,"ln":862,"content":"+   *     (will only change if the server store is completely wiped)"},{"type":"normal","normal":true,"ln1":833,"ln2":863,"content":"    *   deltas:"},{"type":"normal","normal":true,"ln1":834,"ln2":864,"content":"    *     the individual deltas on the server"},{"type":"normal","normal":true,"ln1":835,"ln2":865,"content":"    *   updates:"}],"oldStart":830,"oldLines":6,"newStart":857,"newLines":9},{"content":"@@ -840,7 +870,8 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":840,"ln2":870,"content":"     var generator = yield;"},{"type":"normal","normal":true,"ln1":841,"ln2":871,"content":"     var handlers = this._handlersForGenerator(generator);"},{"type":"normal","normal":true,"ln1":842,"ln2":872,"content":" "},{"type":"del","del":true,"ln":843,"content":"-    var ret = {status: -1, version: -1, deltas: null, updates: null};"},{"type":"add","add":true,"ln":873,"content":"+    var ret = {status: -1, version: -1,"},{"type":"add","add":true,"ln":874,"content":"+      guid: null, deltas: null, updates: null};"},{"type":"normal","normal":true,"ln1":844,"ln2":875,"content":" "},{"type":"normal","normal":true,"ln1":845,"ln2":876,"content":"     this.notice(\"Getting bookmarks delta from server\");"},{"type":"normal","normal":true,"ln1":846,"ln2":877,"content":"     this._dav.GET(\"bookmarks.delta\", handlers);"}],"oldStart":840,"oldLines":7,"newStart":870,"newLines":8},{"content":"@@ -850,7 +881,9 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":850,"ln2":881,"content":"     case 200:"},{"type":"normal","normal":true,"ln1":851,"ln2":882,"content":"       this.notice(\"Got bookmarks delta from server\");"},{"type":"normal","normal":true,"ln1":852,"ln2":883,"content":" "},{"type":"del","del":true,"ln":853,"content":"-      ret.deltas = eval(data.target.responseText);"},{"type":"add","add":true,"ln":884,"content":"+      let resp = eval(data.target.responseText);"},{"type":"add","add":true,"ln":885,"content":"+      ret.guid = resp.guid;"},{"type":"add","add":true,"ln":886,"content":"+      ret.deltas = resp.deltas;"},{"type":"normal","normal":true,"ln1":854,"ln2":887,"content":" "},{"type":"normal","normal":true,"ln1":855,"ln2":888,"content":"       let next = \"version \" + (this._snapshotVersion + 1);"},{"type":"normal","normal":true,"ln1":856,"ln2":889,"content":"       let cur = \"version \" + this._snapshotVersion;"}],"oldStart":850,"oldLines":7,"newStart":881,"newLines":9},{"content":"@@ -858,7 +891,7 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":858,"ln2":891,"content":"       if (next in ret.deltas) {"},{"type":"normal","normal":true,"ln1":859,"ln2":892,"content":"         // Merge the matching deltas into one, find highest version"},{"type":"normal","normal":true,"ln1":860,"ln2":893,"content":"         let keys = [];"},{"type":"del","del":true,"ln":861,"content":"-        for (var vstr in ret.deltas) {"},{"type":"add","add":true,"ln":894,"content":"+        for (let vstr in ret.deltas) {"},{"type":"normal","normal":true,"ln1":862,"ln2":895,"content":"           let v = parseInt(vstr.replace(/^version /, ''));"},{"type":"normal","normal":true,"ln1":863,"ln2":896,"content":"           if (v > this._snapshotVersion)"},{"type":"normal","normal":true,"ln1":864,"ln2":897,"content":"             keys.push(vstr);"}],"oldStart":858,"oldLines":7,"newStart":891,"newLines":7},{"content":"@@ -898,7 +931,7 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":898,"ln2":931,"content":" "},{"type":"normal","normal":true,"ln1":899,"ln2":932,"content":"         // fixme: this is duplicated from above, need to do some refactoring"},{"type":"normal","normal":true,"ln1":900,"ln2":933,"content":"         let keys = [];"},{"type":"del","del":true,"ln":901,"content":"-        for (var vstr in ret.deltas) {"},{"type":"add","add":true,"ln":934,"content":"+        for (let vstr in ret.deltas) {"},{"type":"normal","normal":true,"ln1":902,"ln2":935,"content":"           let v = parseInt(vstr.replace(/^version /, ''));"},{"type":"normal","normal":true,"ln1":903,"ln2":936,"content":"           if (v > this._snapshotVersion)"},{"type":"normal","normal":true,"ln1":904,"ln2":937,"content":"             keys.push(vstr);"}],"oldStart":898,"oldLines":7,"newStart":931,"newLines":7},{"content":"@@ -916,8 +949,9 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":916,"ln2":949,"content":"         ret.status = data.status;"},{"type":"normal","normal":true,"ln1":917,"ln2":950,"content":"         ret.updates = this._detectUpdates(this._snapshot, tmp);"},{"type":"normal","normal":true,"ln1":918,"ln2":951,"content":"         ret.version = data.version;"},{"type":"add","add":true,"ln":952,"content":"+        ret.guid = data.guid;"},{"type":"normal","normal":true,"ln1":919,"ln2":953,"content":" "},{"type":"del","del":true,"ln":920,"content":"-        for (var vstr in ret.deltas) {"},{"type":"add","add":true,"ln":954,"content":"+        for (let vstr in ret.deltas) {"},{"type":"normal","normal":true,"ln1":921,"ln2":955,"content":"           let v = parseInt(vstr.replace(/^version /, ''));"},{"type":"normal","normal":true,"ln1":922,"ln2":956,"content":"           if (v > ret.version)"},{"type":"normal","normal":true,"ln1":923,"ln2":957,"content":"             ret.version = v;"}],"oldStart":916,"oldLines":8,"newStart":949,"newLines":9},{"content":"@@ -950,7 +984,7 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":950,"ln2":984,"content":"     let generator = yield;"},{"type":"normal","normal":true,"ln1":951,"ln2":985,"content":"     let handlers = this._handlersForGenerator(generator);"},{"type":"normal","normal":true,"ln1":952,"ln2":986,"content":" "},{"type":"del","del":true,"ln":953,"content":"-    var ret = {status: -1, version: -1, updates: null};"},{"type":"add","add":true,"ln":987,"content":"+    var ret = {status: -1, version: -1, guid: null, updates: null};"},{"type":"normal","normal":true,"ln1":954,"ln2":988,"content":" "},{"type":"normal","normal":true,"ln1":955,"ln2":989,"content":"     this._dav.GET(\"bookmarks.json\", handlers);"},{"type":"normal","normal":true,"ln1":956,"ln2":990,"content":"     data = yield;"}],"oldStart":950,"oldLines":7,"newStart":984,"newLines":7},{"content":"@@ -962,6 +996,7 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":962,"ln2":996,"content":"       ret.status = 1;"},{"type":"normal","normal":true,"ln1":963,"ln2":997,"content":"       ret.updates = this._detectUpdates(this._snapshot, tmp.snapshot);"},{"type":"normal","normal":true,"ln1":964,"ln2":998,"content":"       ret.version = tmp.version;"},{"type":"add","add":true,"ln":999,"content":"+      ret.guid = tmp.guid;"},{"type":"normal","normal":true,"ln1":965,"ln2":1000,"content":"       if (typeof ret.version != \"number\")"},{"type":"normal","normal":true,"ln1":966,"ln2":1001,"content":"         this.notice(\"Error: version is not a number!  Full server response text:\\n\" +"},{"type":"normal","normal":true,"ln1":967,"ln2":1002,"content":"                     data.target.responseText);"}],"oldStart":962,"oldLines":6,"newStart":996,"newLines":7},{"content":"@@ -971,7 +1006,10 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":971,"ln2":1006,"content":" "},{"type":"normal","normal":true,"ln1":972,"ln2":1007,"content":"       this._snapshot = localJson;"},{"type":"normal","normal":true,"ln1":973,"ln2":1008,"content":"       this._snapshotVersion = 1;"},{"type":"del","del":true,"ln":974,"content":"-      this._dav.PUT(\"bookmarks.json\", uneval({version: 1, snapshot: this._snapshot}), handlers);"},{"type":"add","add":true,"ln":1009,"content":"+      this._dav.PUT(\"bookmarks.json\", uneval({version: 1,"},{"type":"add","add":true,"ln":1010,"content":"+                                              guid: this._snapshotGuid,"},{"type":"add","add":true,"ln":1011,"content":"+                                              snapshot: this._snapshot}),"},{"type":"add","add":true,"ln":1012,"content":"+                    handlers);"},{"type":"normal","normal":true,"ln1":975,"ln2":1013,"content":"       data = yield;"},{"type":"normal","normal":true,"ln1":976,"ln2":1014,"content":" "},{"type":"normal","normal":true,"ln1":977,"ln2":1015,"content":"       if (data.target.status >= 200 || data.target.status < 300) {"}],"oldStart":971,"oldLines":7,"newStart":1006,"newLines":10}],"deletions":12,"additions":50,"from":"services/sync/nsBookmarksSyncService.js","to":"services/sync/nsBookmarksSyncService.js","index":["7a771b9..51206cc","100644"]}]}