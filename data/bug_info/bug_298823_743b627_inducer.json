{"bug_id":298823,"commitHash":"743b627","commit_info":{"sha":"743b6278784d0f79afd7cce1201a646ca2603afa","commit":{"author":{"name":"gavin%gavinsharp.com","email":"gavin%gavinsharp.com","date":"2005-08-17T16:55:00Z"},"committer":{"name":"gavin%gavinsharp.com","email":"gavin%gavinsharp.com","date":"2005-08-17T16:55:00Z"},"message":"Bug 298823: JAR URIs (and other types missing the host part) are not properly handled by nsScriptSecurityManager::LookupPolicy(), patch by Giorgio Maone <g.maone@informaction.com>, r=caillon, sr=dveditz","tree":{"sha":"cffb6a34c8fb9bfb57cf4863352614a9d3444cde","url":"https://api.github.com/repos/mozilla/gecko-dev/git/trees/cffb6a34c8fb9bfb57cf4863352614a9d3444cde"},"url":"https://api.github.com/repos/mozilla/gecko-dev/git/commits/743b6278784d0f79afd7cce1201a646ca2603afa","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/mozilla/gecko-dev/commits/743b6278784d0f79afd7cce1201a646ca2603afa","html_url":"https://github.com/mozilla/gecko-dev/commit/743b6278784d0f79afd7cce1201a646ca2603afa","comments_url":"https://api.github.com/repos/mozilla/gecko-dev/commits/743b6278784d0f79afd7cce1201a646ca2603afa/comments","author":null,"committer":null,"parents":[{"sha":"ee62d3bd199bc49bf9025e6836225330e1fdfdc8","url":"https://api.github.com/repos/mozilla/gecko-dev/commits/ee62d3bd199bc49bf9025e6836225330e1fdfdc8","html_url":"https://github.com/mozilla/gecko-dev/commit/ee62d3bd199bc49bf9025e6836225330e1fdfdc8"}],"stats":{"total":27,"additions":19,"deletions":8},"files":[{"sha":"5cf62cd3a6be862b8e3f3d2c8f159cadd84ad3f4","filename":"caps/src/nsScriptSecurityManager.cpp","status":"modified","additions":19,"deletions":8,"changes":27,"blob_url":"https://github.com/mozilla/gecko-dev/blob/743b6278784d0f79afd7cce1201a646ca2603afa/caps/src/nsScriptSecurityManager.cpp","raw_url":"https://github.com/mozilla/gecko-dev/raw/743b6278784d0f79afd7cce1201a646ca2603afa/caps/src/nsScriptSecurityManager.cpp","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/caps/src/nsScriptSecurityManager.cpp?ref=743b6278784d0f79afd7cce1201a646ca2603afa","patch":"@@ -949,21 +949,31 @@ nsScriptSecurityManager::LookupPolicy(nsIPrincipal* aPrincipal,\n         if (NS_FAILED(rv = aPrincipal->GetOrigin(getter_Copies(origin))))\n             return rv;\n  \n-        const char *start = origin;\n+        char *start = origin.BeginWriting();\n         const char *nextToLastDot = nsnull;\n         const char *lastDot = nsnull;\n         const char *colon = nsnull;\n-        const char *p = start;\n-        while (*p)\n+        char *p = start;\n+\n+        //-- skip (nested) jar schemes to reach the \"real\" URI\n+        while (*p == 'j' && *(++p) == 'a' && *(++p) == 'r' && *(++p) == ':')\n+            start = ++p;\n+        \n+        //-- search domain (stop at the end of the string or at the 3rd slash)\n+        for (PRUint32 slashes=0; *p; p++)\n         {\n+            if (*p == '/' && ++slashes == 3) \n+            {\n+                *p = '\\0'; // truncate at 3rd slash\n+                break;\n+            }\n             if (*p == '.')\n             {\n                 nextToLastDot = lastDot;\n                 lastDot = p;\n-            }\n-            if (!colon && *p == ':')\n+            } \n+            else if (!colon && *p == ':')\n                 colon = p;\n-            p++;\n         }\n \n         nsCStringKey key(nextToLastDot ? nextToLastDot+1 : start);\n@@ -3126,7 +3136,7 @@ nsScriptSecurityManager::InitPolicies()\n             delete domainPolicy;\n             return NS_ERROR_UNEXPECTED;\n         }\n-\n+        domainPolicy->Hold();\n         //-- Parse list of sites and create an entry in mOriginToPolicyMap for each\n         char* domainStart = domainList.BeginWriting();\n         char* domainCurrent = domainStart;\n@@ -3143,7 +3153,7 @@ nsScriptSecurityManager::InitPolicies()\n                 DomainEntry *newEntry = new DomainEntry(domainStart, domainPolicy);\n                 if (!newEntry)\n                 {\n-                    delete domainPolicy;\n+                    domainPolicy->Drop();\n                     return NS_ERROR_OUT_OF_MEMORY;\n                 }\n #ifdef DEBUG\n@@ -3188,6 +3198,7 @@ nsScriptSecurityManager::InitPolicies()\n         }\n \n         rv = InitDomainPolicy(cx, nameBegin, domainPolicy);\n+        domainPolicy->Drop();\n         if (NS_FAILED(rv))\n             return rv;\n     }"}]},"blames":["66caced6","3f22e806","4756b716","f7460d02","5b4b0169"]}