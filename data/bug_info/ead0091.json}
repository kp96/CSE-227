{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basead0091\""},"diff":[{"chunks":[{"content":"@@ -155,6 +155,8 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":155,"ln2":155,"content":"   },"},{"type":"normal","normal":true,"ln1":156,"ln2":156,"content":" "},{"type":"normal","normal":true,"ln1":157,"ln2":157,"content":"   _saveSnapshot: function BSS__saveSnapshot() {"},{"type":"add","add":true,"ln":158,"content":"+    this.notice(\"Saving snapshot to disk\");"},{"type":"add","add":true,"ln":159,"content":"+"},{"type":"normal","normal":true,"ln1":158,"ln2":160,"content":"     let dirSvc = Cc[\"@mozilla.org/file/directory_service;1\"]."},{"type":"normal","normal":true,"ln1":159,"ln2":161,"content":"       getService(Ci.nsIProperties);"},{"type":"normal","normal":true,"ln1":160,"ln2":162,"content":" "}],"oldStart":155,"oldLines":6,"newStart":155,"newLines":8},{"content":"@@ -329,6 +331,11 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":329,"ln2":331,"content":"     if (a.action != b.action)"},{"type":"normal","normal":true,"ln1":330,"ln2":332,"content":"       return false;"},{"type":"normal","normal":true,"ln1":331,"ln2":333,"content":" "},{"type":"add","add":true,"ln":334,"content":"+    // Items with the same guid do not qualify - they need to be"},{"type":"add","add":true,"ln":335,"content":"+    // processed for edits"},{"type":"add","add":true,"ln":336,"content":"+    if (a.guid == b.guid)"},{"type":"add","add":true,"ln":337,"content":"+      return false;"},{"type":"add","add":true,"ln":338,"content":"+"},{"type":"normal","normal":true,"ln1":332,"ln2":339,"content":"     // this check works because reconcile() fixes up the parent guids"},{"type":"normal","normal":true,"ln1":333,"ln2":340,"content":"     // as it runs, and the command list is sorted by depth"},{"type":"normal","normal":true,"ln1":334,"ln2":341,"content":"     if (a.parentGuid != b.parentGuid)"}],"oldStart":329,"oldLines":6,"newStart":331,"newLines":11},{"content":"@@ -429,6 +436,9 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":429,"ln2":436,"content":"           delete listA[i];"},{"type":"normal","normal":true,"ln1":430,"ln2":437,"content":"           delete listB[j];"},{"type":"normal","normal":true,"ln1":431,"ln2":438,"content":"         } else if (this._commandLike(listA[i], listB[j])) {"},{"type":"add","add":true,"ln":439,"content":"+          // Disregard likeness if the target guid already exists locally"},{"type":"add","add":true,"ln":440,"content":"+          if (this._bms.getItemIdForGUID(listB[j].guid) >= 0)"},{"type":"add","add":true,"ln":441,"content":"+            continue;"},{"type":"normal","normal":true,"ln1":432,"ln2":442,"content":"           this._fixParents(listA, listA[i].guid, listB[j].guid);"},{"type":"normal","normal":true,"ln1":433,"ln2":443,"content":"           listB[j].data = {guid: listB[j].guid};"},{"type":"normal","normal":true,"ln1":434,"ln2":444,"content":"           listB[j].guid = listA[i].guid;"}],"oldStart":429,"oldLines":6,"newStart":436,"newLines":9},{"content":"@@ -629,58 +639,33 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":629,"ln2":639,"content":"       folder = this._bms.bookmarksRoot;"},{"type":"normal","normal":true,"ln1":630,"ln2":640,"content":"     var query = this._hsvc.getNewQuery();"},{"type":"normal","normal":true,"ln1":631,"ln2":641,"content":"     query.setFolders([folder], 1);"},{"type":"del","del":true,"ln":632,"content":"-    return this._hsvc.executeQuery(query, this._hsvc.getNewQueryOptions()).root;"},{"type":"del","del":true,"ln":633,"content":"-  },"},{"type":"del","del":true,"ln":634,"content":"-"},{"type":"del","del":true,"ln":635,"content":"-  // FIXME: these print functions need some love..."},{"type":"del","del":true,"ln":636,"content":"-  _mungeJSON: function BSS__mungeJSON(json) {"},{"type":"del","del":true,"ln":637,"content":"-    json.replace(\":{type\", \":\\n\\t{type\");"},{"type":"del","del":true,"ln":638,"content":"-    json.replace(\", \", \",\\n\\t\");"},{"type":"add","add":true,"ln":642,"content":"+    let root = this._hsvc.executeQuery(query, this._hsvc.getNewQueryOptions()).root;"},{"type":"add","add":true,"ln":643,"content":"+    return this._wrapNode(root);"},{"type":"add","add":true,"ln":644,"content":"+  },"},{"type":"add","add":true,"ln":645,"content":"+"},{"type":"add","add":true,"ln":646,"content":"+  _mungeNodes: function BSS__mungeNodes(nodes) {"},{"type":"add","add":true,"ln":647,"content":"+    let json = uneval(nodes);"},{"type":"add","add":true,"ln":648,"content":"+    json = json.replace(/:{type/g, \":\\n\\t{type\");"},{"type":"add","add":true,"ln":649,"content":"+    json = json.replace(/}, /g, \"},\\n  \");"},{"type":"add","add":true,"ln":650,"content":"+    json = json.replace(/, parentGuid/g, \",\\n\\t parentGuid\");"},{"type":"add","add":true,"ln":651,"content":"+    json = json.replace(/, index/g, \",\\n\\t index\");"},{"type":"add","add":true,"ln":652,"content":"+    json = json.replace(/, title/g, \",\\n\\t title\");"},{"type":"add","add":true,"ln":653,"content":"+    json = json.replace(/, uri/g, \",\\n\\t uri\");"},{"type":"normal","normal":true,"ln1":639,"ln2":654,"content":"     return json;"},{"type":"normal","normal":true,"ln1":640,"ln2":655,"content":"   },"},{"type":"normal","normal":true,"ln1":641,"ln2":656,"content":" "},{"type":"del","del":true,"ln":642,"content":"-  _printNodes: function BSS__printNodes(nodes) {"},{"type":"del","del":true,"ln":643,"content":"-    let nodeList = [];"},{"type":"del","del":true,"ln":644,"content":"-    for (let guid in nodes) {"},{"type":"del","del":true,"ln":645,"content":"-      switch (nodes[guid].type) {"},{"type":"del","del":true,"ln":646,"content":"-      case 0:"},{"type":"del","del":true,"ln":647,"content":"-        nodeList.push(nodes[guid].parentGuid + \" b \" + guid + \"\\n\\t\" +"},{"type":"del","del":true,"ln":648,"content":"-                      nodes[guid].title + nodes[guid].uri);"},{"type":"del","del":true,"ln":649,"content":"-        break;"},{"type":"del","del":true,"ln":650,"content":"-      case 6:"},{"type":"del","del":true,"ln":651,"content":"-        nodeList.push(nodes[guid].parentGuid + \" f \" + guid + \"\\n\\t\" +"},{"type":"del","del":true,"ln":652,"content":"-                      nodes[guid].title);"},{"type":"del","del":true,"ln":653,"content":"-        break;"},{"type":"del","del":true,"ln":654,"content":"-      case 7:"},{"type":"del","del":true,"ln":655,"content":"-        nodeList.push(nodes[guid].parentGuid + \" s \" + guid);"},{"type":"del","del":true,"ln":656,"content":"-        break;"},{"type":"del","del":true,"ln":657,"content":"-      default:"},{"type":"del","del":true,"ln":658,"content":"-        nodeList.push(\"error: unknown item type!\\n\" + uneval(nodes[guid]));"},{"type":"del","del":true,"ln":659,"content":"-        break;"},{"type":"del","del":true,"ln":660,"content":"-      }"},{"type":"del","del":true,"ln":661,"content":"-    }"},{"type":"del","del":true,"ln":662,"content":"-    nodeList.sort();"},{"type":"del","del":true,"ln":663,"content":"-    return nodeList.join(\"\\n\");"},{"type":"add","add":true,"ln":657,"content":"+  _mungeCommands: function BSS__mungeCommands(commands) {"},{"type":"add","add":true,"ln":658,"content":"+    let json = uneval(commands);"},{"type":"add","add":true,"ln":659,"content":"+    json = json.replace(/ {action/g, \"\\n {action\");"},{"type":"add","add":true,"ln":660,"content":"+    //json = json.replace(/, data/g, \",\\n  data\");"},{"type":"add","add":true,"ln":661,"content":"+    return json;"},{"type":"normal","normal":true,"ln1":664,"ln2":662,"content":"   },"},{"type":"normal","normal":true,"ln1":665,"ln2":663,"content":" "},{"type":"del","del":true,"ln":666,"content":"-  _printCommands: function BSS__printCommands(commands) {"},{"type":"del","del":true,"ln":667,"content":"-    let ret = [];"},{"type":"del","del":true,"ln":668,"content":"-    for (let i = 0; i < commands.length; i++) {"},{"type":"del","del":true,"ln":669,"content":"-      switch (commands[i].action) {"},{"type":"del","del":true,"ln":670,"content":"-      case \"create\":"},{"type":"del","del":true,"ln":671,"content":"-        ret.push(\"create\");"},{"type":"del","del":true,"ln":672,"content":"-        break;"},{"type":"del","del":true,"ln":673,"content":"-      case \"edit\":"},{"type":"del","del":true,"ln":674,"content":"-        ret.push();"},{"type":"del","del":true,"ln":675,"content":"-        break;"},{"type":"del","del":true,"ln":676,"content":"-      case \"remove\":"},{"type":"del","del":true,"ln":677,"content":"-        ret.push();"},{"type":"del","del":true,"ln":678,"content":"-        break;"},{"type":"del","del":true,"ln":679,"content":"-      default:"},{"type":"del","del":true,"ln":680,"content":"-        ret.push(\"error: unknown command action!\\n\" + uneval(commands[i]));"},{"type":"del","del":true,"ln":681,"content":"-        break;"},{"type":"del","del":true,"ln":682,"content":"-      }"},{"type":"del","del":true,"ln":683,"content":"-    }"},{"type":"add","add":true,"ln":664,"content":"+  _mungeConflicts: function BSS__mungeConflicts(conflicts) {"},{"type":"add","add":true,"ln":665,"content":"+    let json = uneval(conflicts);"},{"type":"add","add":true,"ln":666,"content":"+    json = json.replace(/ {action/g, \"\\n {action\");"},{"type":"add","add":true,"ln":667,"content":"+    //json = json.replace(/, data/g, \",\\n  data\");"},{"type":"add","add":true,"ln":668,"content":"+    return json;"},{"type":"normal","normal":true,"ln1":684,"ln2":669,"content":"   },"},{"type":"normal","normal":true,"ln1":685,"ln2":670,"content":" "},{"type":"normal","normal":true,"ln1":686,"ln2":671,"content":"   // 1) Fetch server deltas"}],"oldStart":629,"oldLines":58,"newStart":639,"newLines":33},{"content":"@@ -703,9 +688,8 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":703,"ln2":688,"content":"       //var data = yield;"},{"type":"normal","normal":true,"ln1":704,"ln2":689,"content":"       var data;"},{"type":"normal","normal":true,"ln1":705,"ln2":690,"content":" "},{"type":"del","del":true,"ln":706,"content":"-      var localBookmarks = this._getBookmarks();"},{"type":"del","del":true,"ln":707,"content":"-      var localJson = this._wrapNode(localBookmarks);"},{"type":"del","del":true,"ln":708,"content":"-      this.notice(\"local json:\\n\" + this._mungeJSON(uneval(localJson)));"},{"type":"add","add":true,"ln":691,"content":"+      var localJson = this._getBookmarks();"},{"type":"add","add":true,"ln":692,"content":"+      this.notice(\"local json:\\n\" + this._mungeNodes(localJson));"},{"type":"normal","normal":true,"ln1":709,"ln2":693,"content":" "},{"type":"normal","normal":true,"ln1":710,"ln2":694,"content":"       // 1) Fetch server deltas"},{"type":"normal","normal":true,"ln1":711,"ln2":695,"content":"       let gsd_gen = this._getServerData(handlers['complete'], localJson);"}],"oldStart":703,"oldLines":9,"newStart":688,"newLines":8},{"content":"@@ -713,7 +697,16 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":713,"ln2":697,"content":"       gsd_gen.send(gsd_gen);"},{"type":"normal","normal":true,"ln1":714,"ln2":698,"content":"       let server = yield;"},{"type":"normal","normal":true,"ln1":715,"ln2":699,"content":" "},{"type":"del","del":true,"ln":716,"content":"-      this.notice(\"server: \" + uneval(server));"},{"type":"add","add":true,"ln":700,"content":"+      this.notice(\"Server status: \" + server.status);"},{"type":"add","add":true,"ln":701,"content":"+      this.notice(\"Server version: \" + server.version);"},{"type":"add","add":true,"ln":702,"content":"+      this.notice(\"Server version type: \" + typeof server.version);"},{"type":"add","add":true,"ln":703,"content":"+      this.notice(\"Local snapshot version: \" + this._snapshotVersion);"},{"type":"add","add":true,"ln":704,"content":"+"},{"type":"add","add":true,"ln":705,"content":"+      for (version in server.deltas) {"},{"type":"add","add":true,"ln":706,"content":"+        this.notice(\"Server delta \" + version + \":\\n\" +"},{"type":"add","add":true,"ln":707,"content":"+                    this._mungeCommands(server.deltas[version]));"},{"type":"add","add":true,"ln":708,"content":"+      }"},{"type":"add","add":true,"ln":709,"content":"+"},{"type":"normal","normal":true,"ln1":717,"ln2":710,"content":"       if (server['status'] == 2) {"},{"type":"normal","normal":true,"ln1":718,"ln2":711,"content":"         this._os.notifyObservers(null, \"bookmarks-sync:end\", \"\");"},{"type":"normal","normal":true,"ln1":719,"ln2":712,"content":"         this.notice(\"Sync complete\");"}],"oldStart":713,"oldLines":7,"newStart":697,"newLines":16},{"content":"@@ -724,14 +717,10 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":724,"ln2":717,"content":"         return;"},{"type":"normal","normal":true,"ln1":725,"ln2":718,"content":"       }"},{"type":"normal","normal":true,"ln1":726,"ln2":719,"content":" "},{"type":"del","del":true,"ln":727,"content":"-      this.notice(\"Local snapshot version: \" + this._snapshotVersion);"},{"type":"del","del":true,"ln":728,"content":"-      this.notice(\"Latest server version: \" + server['version']);"},{"type":"del","del":true,"ln":729,"content":"-"},{"type":"normal","normal":true,"ln1":730,"ln2":720,"content":"       // 2) Generate local deltas from snapshot -> current client status"},{"type":"normal","normal":true,"ln1":731,"ln2":721,"content":" "},{"type":"del","del":true,"ln":732,"content":"-      this.notice(\"Generating local updates\");"},{"type":"del","del":true,"ln":733,"content":"-      var localUpdates = this._detectUpdates(this._snapshot, localJson);"},{"type":"del","del":true,"ln":734,"content":"-      this.notice(\"updates: \" + uneval(localUpdates));"},{"type":"add","add":true,"ln":722,"content":"+      let localUpdates = this._detectUpdates(this._snapshot, localJson);"},{"type":"add","add":true,"ln":723,"content":"+      this.notice(\"Local updates: \" + this._mungeCommands(localUpdates));"},{"type":"normal","normal":true,"ln1":735,"ln2":724,"content":"       if (!(server['status'] == 1 || localUpdates.length > 0)) {"},{"type":"normal","normal":true,"ln1":736,"ln2":725,"content":"         this._os.notifyObservers(null, \"bookmarks-sync:end\", \"\");"},{"type":"normal","normal":true,"ln1":737,"ln2":726,"content":"         this.notice(\"Sync complete (1): no changes needed on client or server\");"}],"oldStart":724,"oldLines":14,"newStart":717,"newLines":10},{"content":"@@ -740,7 +729,7 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":740,"ln2":729,"content":" \t  "},{"type":"normal","normal":true,"ln1":741,"ln2":730,"content":"       // 3) Reconcile client/server deltas and generate new deltas for them."},{"type":"normal","normal":true,"ln1":742,"ln2":731,"content":" "},{"type":"del","del":true,"ln":743,"content":"-      this.notice(\"Reconciling updates\");"},{"type":"add","add":true,"ln":732,"content":"+      this.notice(\"Reconciling client/server updates\");"},{"type":"normal","normal":true,"ln1":744,"ln2":733,"content":"       let callback = function(retval) { continueGenerator(generator, retval); };"},{"type":"normal","normal":true,"ln1":745,"ln2":734,"content":"       let rec_gen = this._reconcile(callback, [localUpdates, server.updates]);"},{"type":"normal","normal":true,"ln1":746,"ln2":735,"content":"       rec_gen.next(); // must initialize before sending"}],"oldStart":740,"oldLines":7,"newStart":729,"newLines":7},{"content":"@@ -764,17 +753,17 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":764,"ln2":753,"content":"       if (ret.conflicts && ret.conflicts[1])"},{"type":"normal","normal":true,"ln1":765,"ln2":754,"content":"         serverConflicts = ret.conflicts[1];"},{"type":"normal","normal":true,"ln1":766,"ln2":755,"content":" "},{"type":"del","del":true,"ln":767,"content":"-      this.notice(\"Changes for client: \" + uneval(clientChanges));"},{"type":"del","del":true,"ln":768,"content":"-      this.notice(\"Changes for server: \" + uneval(serverChanges));"},{"type":"del","del":true,"ln":769,"content":"-      this.notice(\"Client conflicts: \" + uneval(clientConflicts));"},{"type":"del","del":true,"ln":770,"content":"-      this.notice(\"Server conflicts: \" + uneval(serverConflicts));"},{"type":"add","add":true,"ln":756,"content":"+      this.notice(\"Changes for client: \" + this._mungeCommands(clientChanges));"},{"type":"add","add":true,"ln":757,"content":"+      this.notice(\"Changes for server: \" + this._mungeCommands(serverChanges));"},{"type":"add","add":true,"ln":758,"content":"+      this.notice(\"Client conflicts: \" + this._mungeConflicts(clientConflicts));"},{"type":"add","add":true,"ln":759,"content":"+      this.notice(\"Server conflicts: \" + this._mungeConflicts(serverConflicts));"},{"type":"normal","normal":true,"ln1":771,"ln2":760,"content":" "},{"type":"normal","normal":true,"ln1":772,"ln2":761,"content":"       if (!(clientChanges.length || serverChanges.length ||"},{"type":"normal","normal":true,"ln1":773,"ln2":762,"content":"             clientConflicts.length || serverConflicts.length)) {"},{"type":"normal","normal":true,"ln1":774,"ln2":763,"content":"         this._os.notifyObservers(null, \"bookmarks-sync:end\", \"\");"},{"type":"normal","normal":true,"ln1":775,"ln2":764,"content":"         this.notice(\"Sync complete (2): no changes needed on client or server\");"},{"type":"del","del":true,"ln":776,"content":"-        this._snapshot = this._wrapNode(localBookmarks);"},{"type":"del","del":true,"ln":777,"content":"-        this._snapshotVersion = server['version'];"},{"type":"add","add":true,"ln":765,"content":"+        this._snapshot = localJson;"},{"type":"add","add":true,"ln":766,"content":"+        this._snapshotVersion = server.version;"},{"type":"normal","normal":true,"ln1":778,"ln2":767,"content":"         this._saveSnapshot();"},{"type":"normal","normal":true,"ln1":779,"ln2":768,"content":"         return;"},{"type":"normal","normal":true,"ln1":780,"ln2":769,"content":"       }"}],"oldStart":764,"oldLines":17,"newStart":753,"newLines":17},{"content":"@@ -788,17 +777,17 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":788,"ln2":777,"content":"         this.notice(\"Applying changes locally\");"},{"type":"normal","normal":true,"ln1":789,"ln2":778,"content":"         // Note that we need to need to apply client changes to the"},{"type":"normal","normal":true,"ln1":790,"ln2":779,"content":"         // current tree, not the saved snapshot"},{"type":"del","del":true,"ln":791,"content":"-        this._snapshot = this._applyCommandsToObj(clientChanges,"},{"type":"del","del":true,"ln":792,"content":"-                                                  this._wrapNode(localBookmarks));"},{"type":"add","add":true,"ln":780,"content":"+"},{"type":"add","add":true,"ln":781,"content":"+        this._snapshot = this._applyCommandsToObj(clientChanges, localJson);"},{"type":"normal","normal":true,"ln1":793,"ln2":782,"content":"         this._snapshotVersion = server['version'];"},{"type":"normal","normal":true,"ln1":794,"ln2":783,"content":"         this._applyCommands(clientChanges);"},{"type":"normal","normal":true,"ln1":795,"ln2":784,"content":" "},{"type":"del","del":true,"ln":796,"content":"-        let newSnapshot = this._wrapNode(localBookmarks);"},{"type":"add","add":true,"ln":785,"content":"+        let newSnapshot = this._getBookmarks();"},{"type":"normal","normal":true,"ln1":797,"ln2":786,"content":"         let diff = this._detectUpdates(this._snapshot, newSnapshot);"},{"type":"normal","normal":true,"ln1":798,"ln2":787,"content":"         if (diff.length != 0) {"},{"type":"normal","normal":true,"ln1":799,"ln2":788,"content":"           this.notice(\"Error: commands did not apply correctly.  Diff:\\n\" +"},{"type":"normal","normal":true,"ln1":800,"ln2":789,"content":"                       uneval(diff));"},{"type":"del","del":true,"ln":801,"content":"-          this._snapshot = this._wrapNode(localBookmarks);"},{"type":"add","add":true,"ln":790,"content":"+          this._snapshot = newSnapshot;"},{"type":"normal","normal":true,"ln1":802,"ln2":791,"content":"           // FIXME: What else can we do?"},{"type":"normal","normal":true,"ln1":803,"ln2":792,"content":"         }"},{"type":"normal","normal":true,"ln1":804,"ln2":793,"content":"         this._saveSnapshot();"}],"oldStart":788,"oldLines":17,"newStart":777,"newLines":17},{"content":"@@ -807,9 +796,9 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":807,"ln2":796,"content":"       // 3.2) Append server delta to the delta file and upload"},{"type":"normal","normal":true,"ln1":808,"ln2":797,"content":"       if (serverChanges.length) {"},{"type":"normal","normal":true,"ln1":809,"ln2":798,"content":"         this.notice(\"Uploading changes to server\");"},{"type":"del","del":true,"ln":810,"content":"-        this._snapshot = this._wrapNode(localBookmarks);"},{"type":"add","add":true,"ln":799,"content":"+        this._snapshot = this._getBookmarks();"},{"type":"normal","normal":true,"ln1":811,"ln2":800,"content":"         this._snapshotVersion = server['version'] + 1;"},{"type":"del","del":true,"ln":812,"content":"-        server['deltas'][this._snapshotVersion] = serverChanges;"},{"type":"add","add":true,"ln":801,"content":"+        server['deltas']['version ' + this._snapshotVersion] = serverChanges;"},{"type":"normal","normal":true,"ln1":813,"ln2":802,"content":"         this._dav.PUT(\"bookmarks.delta\", uneval(server['deltas']), handlers);"},{"type":"normal","normal":true,"ln1":814,"ln2":803,"content":"         data = yield;"},{"type":"normal","normal":true,"ln1":815,"ln2":804,"content":" "}],"oldStart":807,"oldLines":9,"newStart":796,"newLines":9},{"content":"@@ -862,40 +851,31 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":862,"ln2":851,"content":"       this.notice(\"Got bookmarks delta from server\");"},{"type":"normal","normal":true,"ln1":863,"ln2":852,"content":" "},{"type":"normal","normal":true,"ln1":864,"ln2":853,"content":"       ret.deltas = eval(data.target.responseText);"},{"type":"del","del":true,"ln":865,"content":"-      var tmp = eval(uneval(this._snapshot)); // fixme hack hack hack"},{"type":"normal","normal":true,"ln1":866,"ln2":854,"content":" "},{"type":"del","del":true,"ln":867,"content":"-      // FIXME: debug here for conditional below..."},{"type":"del","del":true,"ln":868,"content":"-      /*"},{"type":"del","del":true,"ln":869,"content":"-      this.notice(\"[sync bowels] local version: \" + this._snapshotVersion);"},{"type":"del","del":true,"ln":870,"content":"-      for (var z in ret.deltas) {"},{"type":"del","del":true,"ln":871,"content":"-        this.notice(\"[sync bowels] remote version: \" + z);"},{"type":"del","del":true,"ln":872,"content":"-      }"},{"type":"del","del":true,"ln":873,"content":"-      this.notice(\"foo: \" + uneval(ret.deltas[this._snapshotVersion + 1]));"},{"type":"del","del":true,"ln":874,"content":"-      if (ret.deltas[this._snapshotVersion + 1])"},{"type":"del","del":true,"ln":875,"content":"-        this.notice(\"-> is true\");"},{"type":"del","del":true,"ln":876,"content":"-      else"},{"type":"del","del":true,"ln":877,"content":"-        this.notice(\"-> is false\");"},{"type":"del","del":true,"ln":878,"content":"-      */"},{"type":"del","del":true,"ln":879,"content":"-"},{"type":"del","del":true,"ln":880,"content":"-      if (ret.deltas[this._snapshotVersion + 1]) {"},{"type":"add","add":true,"ln":855,"content":"+      let next = \"version \" + (this._snapshotVersion + 1);"},{"type":"add","add":true,"ln":856,"content":"+      let cur = \"version \" + this._snapshotVersion;"},{"type":"add","add":true,"ln":857,"content":"+"},{"type":"add","add":true,"ln":858,"content":"+      if (next in ret.deltas) {"},{"type":"normal","normal":true,"ln1":881,"ln2":859,"content":"         // Merge the matching deltas into one, find highest version"},{"type":"del","del":true,"ln":882,"content":"-        var keys = [];"},{"type":"del","del":true,"ln":883,"content":"-        for (var v in ret.deltas) {"},{"type":"add","add":true,"ln":860,"content":"+        let keys = [];"},{"type":"add","add":true,"ln":861,"content":"+        for (var vstr in ret.deltas) {"},{"type":"add","add":true,"ln":862,"content":"+          let v = parseInt(vstr.replace(/^version /, ''));"},{"type":"normal","normal":true,"ln1":884,"ln2":863,"content":"           if (v > this._snapshotVersion)"},{"type":"del","del":true,"ln":885,"content":"-            keys.push(v);"},{"type":"add","add":true,"ln":864,"content":"+            keys.push(vstr);"},{"type":"normal","normal":true,"ln1":886,"ln2":865,"content":"           if (v > ret.version)"},{"type":"normal","normal":true,"ln1":887,"ln2":866,"content":"             ret.version = v;"},{"type":"normal","normal":true,"ln1":888,"ln2":867,"content":"         }"},{"type":"normal","normal":true,"ln1":889,"ln2":868,"content":"         keys = keys.sort();"},{"type":"del","del":true,"ln":890,"content":"-        //this.notice(\"TMP: \" + uneval(tmp));"},{"type":"add","add":true,"ln":869,"content":"+"},{"type":"add","add":true,"ln":870,"content":"+        let tmp = eval(uneval(this._snapshot)); // fixme hack hack hack"},{"type":"normal","normal":true,"ln1":891,"ln2":871,"content":"         for (var i = 0; i < keys.length; i++) {"},{"type":"normal","normal":true,"ln1":892,"ln2":872,"content":"           tmp = this._applyCommandsToObj(ret.deltas[keys[i]], tmp);"},{"type":"del","del":true,"ln":893,"content":"-          //this.notice(\"TMP: \" + uneval(tmp));"},{"type":"normal","normal":true,"ln1":894,"ln2":873,"content":"         }"},{"type":"add","add":true,"ln":874,"content":"+"},{"type":"normal","normal":true,"ln1":895,"ln2":875,"content":"         ret.status = 1;"},{"type":"del","del":true,"ln":896,"content":"-        ret[\"updates\"] = this._detectUpdates(this._snapshot, tmp);"},{"type":"add","add":true,"ln":876,"content":"+        ret.updates = this._detectUpdates(this._snapshot, tmp);"},{"type":"normal","normal":true,"ln1":897,"ln2":877,"content":" "},{"type":"del","del":true,"ln":898,"content":"-      } else if (ret.deltas[this._snapshotVersion]) {"},{"type":"add","add":true,"ln":878,"content":"+      } else if (cur in ret.deltas) {"},{"type":"normal","normal":true,"ln1":899,"ln2":879,"content":"         this.notice(\"No changes from server\");"},{"type":"normal","normal":true,"ln1":900,"ln2":880,"content":"         ret.status = 0;"},{"type":"normal","normal":true,"ln1":901,"ln2":881,"content":"         ret.version = this._snapshotVersion;"}],"oldStart":862,"oldLines":40,"newStart":851,"newLines":31},{"content":"@@ -916,18 +896,19 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":916,"ln2":896,"content":"               \"New snapshot uploaded, may be inconsistent with deltas!\");"},{"type":"normal","normal":true,"ln1":917,"ln2":897,"content":"         }"},{"type":"normal","normal":true,"ln1":918,"ln2":898,"content":" "},{"type":"del","del":true,"ln":919,"content":"-        var tmp = eval(uneval(this._snapshot)); // fixme hack hack hack"},{"type":"del","del":true,"ln":920,"content":"-        tmp = this._applyCommandsToObj(data.updates, tmp);"},{"type":"del","del":true,"ln":921,"content":"-"},{"type":"normal","normal":true,"ln1":922,"ln2":899,"content":"         // fixme: this is duplicated from above, need to do some refactoring"},{"type":"del","del":true,"ln":923,"content":"-        var keys = [];"},{"type":"del","del":true,"ln":924,"content":"-        for (var v in ret.deltas) {"},{"type":"add","add":true,"ln":900,"content":"+        let keys = [];"},{"type":"add","add":true,"ln":901,"content":"+        for (var vstr in ret.deltas) {"},{"type":"add","add":true,"ln":902,"content":"+          let v = parseInt(vstr.replace(/^version /, ''));"},{"type":"normal","normal":true,"ln1":925,"ln2":903,"content":"           if (v > this._snapshotVersion)"},{"type":"del","del":true,"ln":926,"content":"-            keys.push(v);"},{"type":"add","add":true,"ln":904,"content":"+            keys.push(vstr);"},{"type":"normal","normal":true,"ln1":927,"ln2":905,"content":"           if (v > ret.version)"},{"type":"normal","normal":true,"ln1":928,"ln2":906,"content":"             ret.version = v;"},{"type":"normal","normal":true,"ln1":929,"ln2":907,"content":"         }"},{"type":"normal","normal":true,"ln1":930,"ln2":908,"content":"         keys = keys.sort();"},{"type":"add","add":true,"ln":909,"content":"+"},{"type":"add","add":true,"ln":910,"content":"+        let tmp = eval(uneval(this._snapshot)); // fixme hack hack hack"},{"type":"add","add":true,"ln":911,"content":"+        tmp = this._applyCommandsToObj(data.updates, tmp);"},{"type":"normal","normal":true,"ln1":931,"ln2":912,"content":"         for (var i = 0; i < keys.length; i++) {"},{"type":"normal","normal":true,"ln1":932,"ln2":913,"content":"           tmp = this._applyCommandsToObj(ret.deltas[keys[i]], tmp);"},{"type":"normal","normal":true,"ln1":933,"ln2":914,"content":"         }"}],"oldStart":916,"oldLines":18,"newStart":896,"newLines":19},{"content":"@@ -935,11 +916,18 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":935,"ln2":916,"content":"         ret.status = data.status;"},{"type":"normal","normal":true,"ln1":936,"ln2":917,"content":"         ret.updates = this._detectUpdates(this._snapshot, tmp);"},{"type":"normal","normal":true,"ln1":937,"ln2":918,"content":"         ret.version = data.version;"},{"type":"del","del":true,"ln":938,"content":"-        var keys = [];"},{"type":"del","del":true,"ln":939,"content":"-        for (var v in ret.deltas) {"},{"type":"add","add":true,"ln":919,"content":"+"},{"type":"add","add":true,"ln":920,"content":"+        for (var vstr in ret.deltas) {"},{"type":"add","add":true,"ln":921,"content":"+          let v = parseInt(vstr.replace(/^version /, ''));"},{"type":"normal","normal":true,"ln1":940,"ln2":922,"content":"           if (v > ret.version)"},{"type":"normal","normal":true,"ln1":941,"ln2":923,"content":"             ret.version = v;"},{"type":"normal","normal":true,"ln1":942,"ln2":924,"content":"         }"},{"type":"add","add":true,"ln":925,"content":"+"},{"type":"add","add":true,"ln":926,"content":"+        if (typeof ret.version != \"number\") {"},{"type":"add","add":true,"ln":927,"content":"+          this.notice(\"Error: version is not a number!  Correcting...\");"},{"type":"add","add":true,"ln":928,"content":"+          ret.version = parseInt(ret.version);"},{"type":"add","add":true,"ln":929,"content":"+        }"},{"type":"add","add":true,"ln":930,"content":"+"},{"type":"normal","normal":true,"ln1":943,"ln2":931,"content":"       }"},{"type":"normal","normal":true,"ln1":944,"ln2":932,"content":"       break;"},{"type":"normal","normal":true,"ln1":945,"ln2":933,"content":"     case 404:"}],"oldStart":935,"oldLines":11,"newStart":916,"newLines":18},{"content":"@@ -974,6 +962,9 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":974,"ln2":962,"content":"       ret.status = 1;"},{"type":"normal","normal":true,"ln1":975,"ln2":963,"content":"       ret.updates = this._detectUpdates(this._snapshot, tmp.snapshot);"},{"type":"normal","normal":true,"ln1":976,"ln2":964,"content":"       ret.version = tmp.version;"},{"type":"add","add":true,"ln":965,"content":"+      if (typeof ret.version != \"number\")"},{"type":"add","add":true,"ln":966,"content":"+        this.notice(\"Error: version is not a number!  Full server response text:\\n\" +"},{"type":"add","add":true,"ln":967,"content":"+                    data.target.responseText);"},{"type":"normal","normal":true,"ln1":977,"ln2":968,"content":"       break;"},{"type":"normal","normal":true,"ln1":978,"ln2":969,"content":"     case 404:"},{"type":"normal","normal":true,"ln1":979,"ln2":970,"content":"       this.notice(\"No bookmarks on server.  Starting initial sync to server\");"}],"oldStart":974,"oldLines":6,"newStart":962,"newLines":9},{"content":"@@ -985,6 +976,7 @@ BookmarksSyncService.prototype = {","changes":[{"type":"normal","normal":true,"ln1":985,"ln2":976,"content":" "},{"type":"normal","normal":true,"ln1":986,"ln2":977,"content":"       if (data.target.status >= 200 || data.target.status < 300) {"},{"type":"normal","normal":true,"ln1":987,"ln2":978,"content":"         this.notice(\"Initial sync to server successful\");"},{"type":"add","add":true,"ln":979,"content":"+        this._saveSnapshot();"},{"type":"normal","normal":true,"ln1":988,"ln2":980,"content":"         ret.status = 2;"},{"type":"normal","normal":true,"ln1":989,"ln2":981,"content":"       } else {"},{"type":"normal","normal":true,"ln1":990,"ln2":982,"content":"         this.notice(\"Initial sync to server failed\");"}],"oldStart":985,"oldLines":6,"newStart":976,"newLines":7}],"deletions":100,"additions":92,"from":"services/sync/nsBookmarksSyncService.js","to":"services/sync/nsBookmarksSyncService.js","index":["463d366..7a771b9","100644"]}]}