{"bug_id":104470,"commitHash":"bb88a0e","commit_info":{"sha":"bb88a0eea744958c13724ee3470382eded5076cf","commit":{"author":{"name":"caillon%returnzero.com","email":"caillon%returnzero.com","date":"2002-07-23T23:22:20Z"},"committer":{"name":"caillon%returnzero.com","email":"caillon%returnzero.com","date":"2002-07-23T23:22:20Z"},"message":"Bug 104470 - Popup blocking breaks window.open()s which are targetted to frames or existing named windows\nr=sicking sr=jst a=asa","tree":{"sha":"6317de497174e01c6e3e8f939a2bf097dbe10c77","url":"https://api.github.com/repos/mozilla/gecko-dev/git/trees/6317de497174e01c6e3e8f939a2bf097dbe10c77"},"url":"https://api.github.com/repos/mozilla/gecko-dev/git/commits/bb88a0eea744958c13724ee3470382eded5076cf","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/mozilla/gecko-dev/commits/bb88a0eea744958c13724ee3470382eded5076cf","html_url":"https://github.com/mozilla/gecko-dev/commit/bb88a0eea744958c13724ee3470382eded5076cf","comments_url":"https://api.github.com/repos/mozilla/gecko-dev/commits/bb88a0eea744958c13724ee3470382eded5076cf/comments","author":null,"committer":null,"parents":[{"sha":"b05829e57cbbf7d1df27c028894b5706687de61c","url":"https://api.github.com/repos/mozilla/gecko-dev/commits/b05829e57cbbf7d1df27c028894b5706687de61c","html_url":"https://github.com/mozilla/gecko-dev/commit/b05829e57cbbf7d1df27c028894b5706687de61c"}],"stats":{"total":36,"additions":25,"deletions":11},"files":[{"sha":"e4eca054cf30a7e43c7eda632664daf42b624f17","filename":"dom/src/base/nsGlobalWindow.cpp","status":"modified","additions":25,"deletions":11,"changes":36,"blob_url":"https://github.com/mozilla/gecko-dev/blob/bb88a0eea744958c13724ee3470382eded5076cf/dom/src/base/nsGlobalWindow.cpp","raw_url":"https://github.com/mozilla/gecko-dev/raw/bb88a0eea744958c13724ee3470382eded5076cf/dom/src/base/nsGlobalWindow.cpp","contents_url":"https://api.github.com/repos/mozilla/gecko-dev/contents/dom/src/base/nsGlobalWindow.cpp?ref=bb88a0eea744958c13724ee3470382eded5076cf","patch":"@@ -2878,20 +2878,11 @@ GlobalWindowImpl::Open(const nsAString& aUrl,\n NS_IMETHODIMP\n GlobalWindowImpl::Open(nsIDOMWindow **_retval)\n {\n+  *_retval = nsnull;\n+\n   NS_ENSURE_STATE(sXPConnect);\n   nsresult rv = NS_OK;\n \n-  /* If we're in a commonly abused state (top level script, running a timeout,\n-   * or onload/onunload), and the preference is enabled, block the window.open().\n-   */\n-  if (CheckForAbusePoint()) {\n-#ifdef DEBUG\n-    printf (\"*** Blocking window.open.\\n\");\n-#endif\n-    *_retval = nsnull;\n-    return NS_OK;\n-  }\n-\n   nsCOMPtr<nsIXPCNativeCallContext> ncc;\n \n   rv = sXPConnect->GetCurrentNativeCallContext(getter_AddRefs(ncc));\n@@ -2925,6 +2916,29 @@ GlobalWindowImpl::Open(nsIDOMWindow **_retval)\n     }\n   }\n \n+  /*\n+   * If we're in a commonly abused state (top level script, running a timeout,\n+   * or onload/onunload), and the preference is enabled, prevent window.open().\n+   */\n+  if (CheckForAbusePoint()) {\n+    if (name.IsEmpty()) {\n+      return NS_OK;\n+    }\n+\n+    nsCOMPtr<nsIWindowWatcher> wwatch(do_GetService(sWindowWatcherContractID, &rv));\n+    // If getting a window watcher fails, we'd fail downstream anyway when trying to\n+    // open a new window so just bail here.\n+    NS_ENSURE_SUCCESS(rv, rv);\n+\n+    nsCOMPtr<nsIDOMWindow> namedWindow;\n+    wwatch->GetWindowByName(name.get(), this,\n+                            getter_AddRefs(namedWindow));\n+\n+    if (!namedWindow) {\n+      return NS_OK;\n+    }\n+  }\n+\n   return OpenInternal(url, name, options, PR_FALSE, nsnull, 0, nsnull,\n                       _retval);\n }"}]},"blames":["ea706038","e68f60f6","c6704e14"]}