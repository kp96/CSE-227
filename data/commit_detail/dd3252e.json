{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basdd3252e\""},"diff":"\"dd3252e woo! first sync across profiles works now\\ndiff --git a/services/sync/nsBookmarksSyncService.js b/services/sync/nsBookmarksSyncService.js\\nindex 037b34f..56766cb 100644\\n--- a/services/sync/nsBookmarksSyncService.js\\n+++ b/services/sync/nsBookmarksSyncService.js\\n@@ -322,13 +322,16 @@ BookmarksSyncService.prototype = {\\n \\n     for (let key in command.data) {\\n       switch (key) {\\n+      case \\\"guid\\\":\\n+        this._bms.setItemGUID(itemId, command.data.guid);\\n+        break;\\n       case \\\"title\\\":\\n         this._bms.setItemTitle(itemId, command.data.title);\\n         break;\\n       case \\\"uri\\\":\\n         this._bms.changeBookmarkURI(itemId, makeURI(command.data.uri));\\n         break;\\n-      case \\\"index\\\":\\n+      case \\\"index\\\": // FIXME: what if we do this one before parentGuid ? that'd be wrong\\n         this._bms.moveItem(itemId, this._bms.getFolderIdForItem(itemId),\\n                            command.data.index);\\n         break;\\n@@ -397,6 +400,17 @@ BookmarksSyncService.prototype = {\\n                  depth: parents.length, parents: parents,\\n                  data: b[guid]});\\n     }\\n+    cmds.sort(function(a, b) {\\n+      if (a.depth > b.depth)\\n+        return 1;\\n+      if (a.depth < b.depth)\\n+        return -1;\\n+      if (a.index > b.index)\\n+        return -1;\\n+      if (a.index < b.index)\\n+        return 1;\\n+      return 0; // should never happen, but not a big deal if it does\\n+    });\\n     return cmds;\\n   },\\n \\n@@ -463,16 +477,34 @@ BookmarksSyncService.prototype = {\\n     return true;\\n   },\\n \\n+  _fixParents: function BSS__fixParents(list, oldGuid, newGuid) {\\n+    for (let i = 0; i < list.length; i++) {\\n+      if (!list[i])\\n+        continue;\\n+      if (list[i].parentGuid == oldGuid)\\n+        list[i].parentGuid = newGuid;\\n+      for (let j = 0; j < list[i].parents.length; j++) {\\n+        if (list[i].parents[j] == oldGuid)\\n+          list[i].parents[j] = newGuid;\\n+      }\\n+    }\\n+  },\\n+\\n   _reconcile: function BSS__reconcile(listA, listB) {\\n     let propagations = [[], []];\\n     let conflicts = [[], []];\\n \\n     for (let i = 0; i < listA.length; i++) {\\n       for (let j = 0; j < listB.length; j++) {\\n-        if (this._commandLike(listA[i], listB[j]) ||\\n-            this._deepEquals(listA[i], listB[j])) {\\n+        if (this._deepEquals(listA[i], listB[j])) {\\n           delete listA[i];\\n           delete listB[j];\\n+        } else if (this._commandLike(listA[i], listB[j])) {\\n+          this._fixParents(listA, listA[i].guid, listB[j].guid);\\n+          listB[j].data = {guid: listB[j].guid};\\n+          listB[j].guid = listA[i].guid;\\n+          listB[j].action = \\\"edit\\\";\\n+          delete listA[i];\\n         }\\n       }\\n     }\\n\""}