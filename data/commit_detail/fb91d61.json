{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basfb91d61\""},"diff":"\"fb91d61 Bug 362734 - Crash [@ nsPrintEngine::DocumentReadyForPrinting] with testcase that sets print preview, then reloads the page, patch by Andrew Smith, r=sharparrow1, sr=roc (blocking1.9 bug)\\ndiff --git a/layout/base/nsDocumentViewer.cpp b/layout/base/nsDocumentViewer.cpp\\nindex 90e46c9..f5d5717 100644\\n--- a/layout/base/nsDocumentViewer.cpp\\n+++ b/layout/base/nsDocumentViewer.cpp\\n@@ -1464,6 +1464,14 @@ DocumentViewerImpl::Destroy()\\n \\n #ifdef NS_PRINTING\\n   if (mPrintEngine) {\\n+#ifdef NS_PRINT_PREVIEW\\n+    PRBool doingPrintPreview;\\n+    mPrintEngine->GetDoingPrintPreview(&doingPrintPreview);\\n+    if (doingPrintPreview) {\\n+      mPrintEngine->FinishPrintPreview();\\n+    }\\n+#endif\\n+\\n     mPrintEngine->Destroy();\\n     mPrintEngine = nsnull;\\n   }\\n@@ -3451,13 +3459,6 @@ DocumentViewerImpl::Print(nsIPrintSettings*       aPrintSettings,\\n   return rv;\\n }\\n \\n-/** ---------------------------------------------------\\n- *  See documentation above in the nsIContentViewerfile class definition\\n- *\\t@update 11/01/01 rods\\n- *\\n- *  For a full and detailed understanding of the issues with\\n- *  PrintPreview: See the design spec that is attached to Bug 107562\\n- */\\n NS_IMETHODIMP\\n DocumentViewerImpl::PrintPreview(nsIPrintSettings* aPrintSettings, \\n                                  nsIDOMWindow *aChildDOMWin, \\ndiff --git a/layout/printing/nsPrintEngine.cpp b/layout/printing/nsPrintEngine.cpp\\nindex 20bd62c..32f810b9 100644\\n--- a/layout/printing/nsPrintEngine.cpp\\n+++ b/layout/printing/nsPrintEngine.cpp\\n@@ -712,13 +712,6 @@ nsPrintEngine::Print(nsIPrintSettings*       aPrintSettings,\\n   return CommonPrint(PR_FALSE, aPrintSettings, aWebProgressListener);\\n }\\n \\n-/** ---------------------------------------------------\\n- *  See documentation above in the nsIContentViewerfile class definition\\n- *\\t@update 11/01/01 rods\\n- *\\n- *  For a full and detailed understanding of the issues with\\n- *  PrintPreview: See the design spec that is attached to Bug 107562\\n- */\\n NS_IMETHODIMP\\n nsPrintEngine::PrintPreview(nsIPrintSettings* aPrintSettings, \\n                                  nsIDOMWindow *aChildDOMWin, \\n@@ -2534,6 +2527,9 @@ void nsPrintEngine::SetIsPrinting(PRBool aIsPrinting)\\n   if (mDocViewerPrint) {\\n     mDocViewerPrint->SetIsPrinting(aIsPrinting);\\n   }\\n+  if (mPrt && aIsPrinting) {\\n+    mPrt->mPreparingForPrint = PR_TRUE;\\n+  }\\n }\\n \\n //---------------------------------------------------------------------\\ndiff --git a/layout/printing/nsPrintEngine.h b/layout/printing/nsPrintEngine.h\\nindex 19127bb..a124dc2 100644\\n--- a/layout/printing/nsPrintEngine.h\\n+++ b/layout/printing/nsPrintEngine.h\\n@@ -59,16 +59,6 @@ class nsIPageSequenceFrame;\\n //------------------------------------------------------------------------\\n // nsPrintEngine Class\\n //\\n-// mPreparingForPrint - indicates that we have started Printing but \\n-//   have not gone to the timer to start printing the pages. It gets turned \\n-//   off right before we go to the timer.\\n-//\\n-// mDocWasToBeDestroyed - Gets set when \\\"someone\\\" tries to unload the document\\n-//   while we were prparing to Print. This typically happens if a user starts \\n-//   to print while a page is still loading. If they start printing and pause \\n-//   at the print dialog and then the page comes in, we then abort printing \\n-//   because the document is no longer stable.\\n-// \\n //------------------------------------------------------------------------\\n class nsPrintEngine : public nsIObserver\\n {\\n\""}