{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basc3a4282\""},"diff":"\"c3a4282 Bug 338202 - \\\"Leak in nsInstallExecute::toString (xpinstall/src/nsInstallExecute.cpp)\\\" [p=ehsan.akhgari@gmail.com (Ehsan Akhgari) r=bsmedberg a1.9=bzbarsky]\\ndiff --git a/xpinstall/src/nsInstallExecute.cpp b/xpinstall/src/nsInstallExecute.cpp\\nindex fad9d57..a6e1190 100644\\n--- a/xpinstall/src/nsInstallExecute.cpp\\n+++ b/xpinstall/src/nsInstallExecute.cpp\\n@@ -255,10 +255,13 @@ void nsInstallExecute::Abort()\\n \\n char* nsInstallExecute::toString()\\n {\\n+    if (!mInstall)\\n+        return nsnull;\\n+\\n     char* buffer = new char[1024];\\n     char* rsrcVal = nsnull;\\n \\n-    if (buffer == nsnull || !mInstall)\\n+    if (!buffer)\\n         return nsnull;\\n \\n     // if the FileSpec is NULL, just us the in jar file name.\\ndiff --git a/xpinstall/src/nsInstallFile.cpp b/xpinstall/src/nsInstallFile.cpp\\nindex 1c18663..410afa1 100644\\n--- a/xpinstall/src/nsInstallFile.cpp\\n+++ b/xpinstall/src/nsInstallFile.cpp\\n@@ -334,10 +334,13 @@ void nsInstallFile::Abort()\\n #define RESBUFSIZE 4096\\n char* nsInstallFile::toString()\\n {\\n+    if (!mInstall)\\n+        return nsnull;\\n+\\n     char* buffer  = new char[RESBUFSIZE];\\n     char* rsrcVal = nsnull;\\n \\n-    if (buffer == nsnull || !mInstall)\\n+    if (!buffer)\\n         return nsnull;\\n     else\\n         buffer[0] = '\\\\0';\\ndiff --git a/xpinstall/src/nsInstallFileOpItem.cpp b/xpinstall/src/nsInstallFileOpItem.cpp\\nindex c0f7936..0eb5fe5 100644\\n--- a/xpinstall/src/nsInstallFileOpItem.cpp\\n+++ b/xpinstall/src/nsInstallFileOpItem.cpp\\n@@ -280,6 +280,9 @@ char* nsInstallFileOpItem::toString()\\n   nsCAutoString srcPath;\\n   nsCAutoString dstPath;\\n \\n+  if (!resultCString)\\n+    return nsnull;\\n+\\n     // STRING USE WARNING: perhaps |result| should be an |nsCAutoString| to avoid all this double converting\\n   *resultCString = nsnull;\\n   switch(mCommand)\\ndiff --git a/xpinstall/src/nsInstallLogComment.cpp b/xpinstall/src/nsInstallLogComment.cpp\\nindex 06ff37c..bbeae2c 100644\\n--- a/xpinstall/src/nsInstallLogComment.cpp\\n+++ b/xpinstall/src/nsInstallLogComment.cpp\\n@@ -96,10 +96,13 @@ void nsInstallLogComment::Abort()\\n \\n char* nsInstallLogComment::toString()\\n {\\n+    if (!mInstall)\\n+        return nsnull;\\n+\\n     char* buffer = new char[1024];\\n     char* rsrcVal = nsnull;\\n     \\n-    if (buffer == nsnull || !mInstall)\\n+    if (!buffer)\\n         return nsnull;\\n \\n     rsrcVal = mInstall->GetResourcedString(mFileOpCommand);\\ndiff --git a/xpinstall/src/nsInstallPatch.cpp b/xpinstall/src/nsInstallPatch.cpp\\nindex d86b23b..6186fda 100644\\n--- a/xpinstall/src/nsInstallPatch.cpp\\n+++ b/xpinstall/src/nsInstallPatch.cpp\\n@@ -38,6 +38,7 @@\\n #include \\\"zlib.h\\\"\\n #include \\\"nsCRT.h\\\"\\n #include \\\"prmem.h\\\"\\n+#include \\\"prprf.h\\\"\\n #include \\\"nsXPIDLString.h\\\"\\n #include \\\"nsInstall.h\\\"\\n #include \\\"nsInstallPatch.h\\\"\\n@@ -365,11 +366,14 @@ void nsInstallPatch::Abort()\\n \\n char* nsInstallPatch::toString()\\n {\\n+    if (!mInstall)\\n+        return nsnull;\\n+\\n \\t  char* buffer = new char[1024];\\n     char* rsrcVal = nsnull;\\n \\n-    if (buffer == nsnull || !mInstall)\\n-        return buffer;\\n+    if (!buffer)\\n+        return nsnull;\\n \\n     if (mTargetFile != nsnull)\\n     {\\n@@ -379,7 +383,7 @@ char* nsInstallPatch::toString()\\n         {\\n             nsCAutoString temp;\\n             mTargetFile->GetNativePath(temp);\\n-            sprintf( buffer, rsrcVal, temp.get()); \\n+            PR_snprintf( buffer, 1024, rsrcVal, temp.get()); \\n             nsCRT::free(rsrcVal);\\n         }\\n     }\\ndiff --git a/xpinstall/src/nsInstallUninstall.cpp b/xpinstall/src/nsInstallUninstall.cpp\\nindex 5bdf924..6ad2a47 100644\\n--- a/xpinstall/src/nsInstallUninstall.cpp\\n+++ b/xpinstall/src/nsInstallUninstall.cpp\\n@@ -44,6 +44,7 @@\\n #include \\\"VerReg.h\\\"\\n #include \\\"nsCRT.h\\\"\\n #include \\\"prmem.h\\\"\\n+#include \\\"prprf.h\\\"\\n #include \\\"ScheduledTasks.h\\\"\\n #include \\\"nsReadableUtils.h\\\"\\n #include \\\"nsILocalFile.h\\\"\\n@@ -113,11 +114,14 @@ void nsInstallUninstall::Abort()\\n \\n char* nsInstallUninstall::toString()\\n {\\n+    if (!mInstall)\\n+        return nsnull;\\n+\\n     char* buffer = new char[1024];\\n     char* rsrcVal = nsnull;\\n \\n-    if (buffer == nsnull || !mInstall)\\n-        return buffer;\\n+    if (!buffer)\\n+        return nsnull;\\n     \\n     char* temp = ToNewCString(mUIName);\\n     \\n@@ -127,7 +131,7 @@ char* nsInstallUninstall::toString()\\n \\n         if (rsrcVal)\\n         {\\n-            sprintf( buffer, rsrcVal, temp);\\n+            PR_snprintf( buffer, 1024, rsrcVal, temp);\\n             nsCRT::free(rsrcVal);\\n         }\\n     }\\ndiff --git a/xpinstall/src/nsWinProfileItem.cpp b/xpinstall/src/nsWinProfileItem.cpp\\nindex 2cf1cae..2a91669 100644\\n--- a/xpinstall/src/nsWinProfileItem.cpp\\n+++ b/xpinstall/src/nsWinProfileItem.cpp\\n@@ -90,8 +90,11 @@ char* nsWinProfileItem::toString()\\n   nsString* result = new nsString;\\n   result->AssignLiteral(\\\"Write \\\");\\n \\n-  if (filename == nsnull || result == nsnull)\\n+  if (filename == nsnull || result == nsnull) {\\n+      delete filename;\\n+      delete result;\\n       return nsnull;\\n+  }\\n \\n   result->Append(*filename);\\n   result->AppendLiteral(\\\": [\\\");\\ndiff --git a/xpinstall/src/nsWinRegItem.cpp b/xpinstall/src/nsWinRegItem.cpp\\nindex f1aa6de..b47a7ec 100644\\n--- a/xpinstall/src/nsWinRegItem.cpp\\n+++ b/xpinstall/src/nsWinRegItem.cpp\\n@@ -147,63 +147,52 @@ PRInt32 nsWinRegItem::Complete()\\n \\n char* nsWinRegItem::toString()\\n {\\n-\\tnsString*  keyString     = nsnull;\\n-\\tnsString*  result        = nsnull;\\n+  nsString*  keyString     = nsnull;\\n+  nsAutoString  result;\\n   char*      resultCString = nsnull;\\n \\n-\\tswitch(mCommand)\\n-\\t{\\n+  switch(mCommand)\\n+  {\\n     case NS_WIN_REG_CREATE:\\n       keyString = keystr(mRootkey, mSubkey, nsnull);\\n-      result    = new nsString;\\n-      result->AssignWithConversion(kCRK);\\n+      result.AssignWithConversion(kCRK);\\n       break;\\n \\n     case NS_WIN_REG_DELETE:\\n       keyString = keystr(mRootkey, mSubkey, nsnull);\\n-      result    = new nsString;\\n-      result->AssignWithConversion(kDRK);\\n+      result.AssignWithConversion(kDRK);\\n       break;\\n \\n     case NS_WIN_REG_DELETE_VAL:\\n       keyString = keystr(mRootkey, mSubkey, mName);\\n-      result    = new nsString;\\n-      result->AssignWithConversion(kDRV);\\n+      result.AssignWithConversion(kDRV);\\n      break;\\n \\n     case NS_WIN_REG_SET_VAL_STRING:\\n       keyString = keystr(mRootkey, mSubkey, mName);\\n-      result    = new nsString;\\n-      result->AssignWithConversion(kSRVS);\\n+      result.AssignWithConversion(kSRVS);\\n       break;\\n \\n     case NS_WIN_REG_SET_VAL_NUMBER:\\n       keyString = keystr(mRootkey, mSubkey, mName);\\n-      result    = new nsString;\\n-      result->AssignWithConversion(kSRVN);\\n+      result.AssignWithConversion(kSRVN);\\n       break;\\n \\n     case NS_WIN_REG_SET_VAL:\\n       keyString = keystr(mRootkey, mSubkey, mName);\\n-      result    = new nsString;\\n-      result->AssignWithConversion(kSRV);\\n+      result.AssignWithConversion(kSRV);\\n       break;\\n \\n     default:\\n       keyString = keystr(mRootkey, mSubkey, mName);\\n-      result    = new nsString;\\n-      result->AssignWithConversion(kUNK);\\n+      result.AssignWithConversion(kUNK);\\n       break;\\n-\\t}\\n-    \\n-  if (result)\\n-  {\\n-      result->Append(*keyString);\\n-      resultCString = ToNewCString(*result);\\n   }\\n+    \\n+  result.Append(*keyString);\\n+  resultCString = ToNewCString(result);\\n   \\n   if (keyString) delete keyString;\\n-  if (result)    delete result;\\n   \\n   return resultCString;\\n }\\n\""}