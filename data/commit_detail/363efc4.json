{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas363efc4\""},"diff":"\"363efc4 Fire DOMContentLoaded async from EndLoad.  Bug 344305, r=sicking, sr=jst, a=sicking\\ndiff --git a/content/base/src/nsDocument.cpp b/content/base/src/nsDocument.cpp\\nindex 1c7a452..09861f0 100644\\n--- a/content/base/src/nsDocument.cpp\\n+++ b/content/base/src/nsDocument.cpp\\n@@ -2751,6 +2751,9 @@ GetDocumentFromDocShellTreeItem(nsIDocShellTreeItem *aDocShell,\\n void\\n nsDocument::DispatchContentLoadedEvents()\\n {\\n+  // If you add early returns from this method, make sure you're\\n+  // calling UnblockOnload properly.\\n+  \\n   // Fire a DOM event notifying listeners that this document has been\\n   // loaded (excluding images and other loads initiated by this\\n   // document).\\n@@ -2846,6 +2849,8 @@ nsDocument::DispatchContentLoadedEvents()\\n       tmp->GetSameTypeParent(getter_AddRefs(docShellParent));\\n     }\\n   }\\n+\\n+  UnblockOnload(PR_TRUE);\\n }\\n \\n void\\n@@ -2861,8 +2866,10 @@ nsDocument::EndLoad()\\n   \\n   NS_DOCUMENT_NOTIFY_OBSERVERS(EndLoad, (this));\\n \\n-  DispatchContentLoadedEvents();\\n-  UnblockOnload(PR_TRUE);\\n+  nsRefPtr<nsIRunnable> ev =\\n+    new nsRunnableMethod<nsDocument>(this,\\n+                                     &nsDocument::DispatchContentLoadedEvents);\\n+  NS_DispatchToCurrentThread(ev);\\n }\\n \\n void\\ndiff --git a/content/xul/document/src/nsXULDocument.cpp b/content/xul/document/src/nsXULDocument.cpp\\nindex 81830b9..1b18e2e 100644\\n--- a/content/xul/document/src/nsXULDocument.cpp\\n+++ b/content/xul/document/src/nsXULDocument.cpp\\n@@ -3088,12 +3088,10 @@ nsXULDocument::DoneWalking()\\n \\n         NS_DOCUMENT_NOTIFY_OBSERVERS(EndLoad, (this));\\n \\n+        // DispatchContentLoadedEvents undoes the onload-blocking we\\n+        // did in PrepareToWalk().\\n         DispatchContentLoadedEvents();\\n \\n-        // Undo the onload-blocking we did in PrepareToWalk().  Note that we do\\n-        // the unblocking sync because that's what the old code did.\\n-        UnblockOnload(PR_TRUE);\\n-        \\n         mInitialLayoutComplete = PR_TRUE;\\n \\n         // Walk the set of pending load notifications and notify any observers.\\n\""}