{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basc73c09f\""},"diff":"\"c73c09f Always delete the old content array so that we run destructors.  b=397022  r+sr=bzbarsky  a=roc\\ndiff --git a/layout/style/nsStyleStruct.cpp b/layout/style/nsStyleStruct.cpp\\nindex c98edd1..b903ecb 100644\\n--- a/layout/style/nsStyleStruct.cpp\\n+++ b/layout/style/nsStyleStruct.cpp\\n@@ -1402,17 +1402,20 @@ nsChangeHint nsStyleContent::MaxDifference()\\n \\n nsresult nsStyleContent::AllocateContents(PRUint32 aCount)\\n {\\n-  if (aCount != mContentCount) {\\n-    DELETE_ARRAY_IF(mContents);\\n-    if (aCount) {\\n-      mContents = new nsStyleContentData[aCount];\\n-      if (! mContents) {\\n-        mContentCount = 0;\\n-        return NS_ERROR_OUT_OF_MEMORY;\\n-      }\\n+  // We need to run the destructors of the elements of mContents, so we\\n+  // delete and reallocate even if aCount == mContentCount.  (If\\n+  // nsStyleContentData had its members private and managed their\\n+  // ownership on setting, we wouldn't need this, but that seems\\n+  // unnecessary at this point.)\\n+  DELETE_ARRAY_IF(mContents);\\n+  if (aCount) {\\n+    mContents = new nsStyleContentData[aCount];\\n+    if (! mContents) {\\n+      mContentCount = 0;\\n+      return NS_ERROR_OUT_OF_MEMORY;\\n     }\\n-    mContentCount = aCount;\\n   }\\n+  mContentCount = aCount;\\n   return NS_OK;\\n }\\n \\n\""}