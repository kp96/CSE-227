{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basf28199c\""},"diff":"\"f28199c fix for bug #342900 improve indication that open tab in background opened tab in overflow area. instead of flashing the \\\"all tabs\\\" button, provide a smoother animation. note, this will not work on mac trunk (but it will work on the mac branch) due to bug #346738 (aka #325296), so for now, there is no animation on the mac. r=mconnor\\ndiff --git a/browser/base/content/tabbrowser.xml b/browser/base/content/tabbrowser.xml\\nindex 6230d17..121ab7c 100644\\n--- a/browser/base/content/tabbrowser.xml\\n+++ b/browser/base/content/tabbrowser.xml\\n@@ -2468,14 +2468,28 @@\\n       <xul:arrowscrollbox anonid=\\\"arrowscrollbox\\\" orient=\\\"horizontal\\\" flex=\\\"1\\\" style=\\\"min-width: 1px;\\\" clicktoscroll=\\\"true\\\">\\n         <children includes=\\\"tab\\\"/>\\n       </xul:arrowscrollbox>\\n-      <xul:hbox class=\\\"tabs-alltabs-box\\\" align=\\\"center\\\" pack=\\\"end\\\" \\n-                anonid=\\\"alltabs-box\\\">\\n-        <xul:toolbarbutton class=\\\"tabs-alltabs-button\\\" type=\\\"menu\\\">\\n-          <xul:menupopup class=\\\"tabs-alltabs-popup\\\"\\n-                         anonid=\\\"alltabs-popup\\\" \\n-                         position=\\\"after_end\\\"/>\\n+      <xul:stack align=\\\"center\\\" pack=\\\"end\\\">\\n+        <!-- XXXsspitzer hack\\n+             this extra hbox with position: relative\\n+             is needed to work around two bugs.\\n+             see bugs #346307 and #346035 \\n+        -->\\n+        <xul:hbox style=\\\"position: relative;\\\">\\n+          <xul:hbox flex=\\\"1\\\" class=\\\"tabs-alltabs-box\\\" anonid=\\\"alltabs-box\\\"/>\\n+        </xul:hbox>\\n+        <!-- XXXsspitzer hack\\n+             this extra hbox with position: relative\\n+             is needed to work around two bugs.\\n+             see bugs #346307 and #346035 \\n+        -->\\n+        <xul:hbox style=\\\"position: relative;\\\">\\n+          <xul:toolbarbutton class=\\\"tabs-alltabs-button\\\" type=\\\"menu\\\">\\n+            <xul:menupopup class=\\\"tabs-alltabs-popup\\\"\\n+                           anonid=\\\"alltabs-popup\\\" \\n+                           position=\\\"after_end\\\"/>\\n         </xul:toolbarbutton>\\n-      </xul:hbox>\\n+        </xul:hbox>\\n+      </xul:stack>\\n       <xul:hbox class=\\\"tabs-closebutton-box\\\" align=\\\"center\\\" pack=\\\"end\\\" anonid=\\\"tabstrip-closebutton\\\">\\n         <xul:toolbarbutton class=\\\"close-button tabs-closebutton\\\"/>\\n       </xul:hbox>\\n@@ -2522,9 +2536,9 @@\\n       <destructor>\\n         <![CDATA[\\n           // Release timer to avoid reference cycles.\\n-          if (this.mFlashTimer) {\\n-            this.mFlashTimer.cancel();\\n-            this.mFlashTimer = null;\\n+          if (this._animateTimer) {\\n+            this._animateTimer.cancel();\\n+            this._animateTimer = null;\\n           }\\n         ]]>\\n       </destructor>\\n@@ -2667,17 +2681,37 @@\\n                                                 \\\"anonid\\\", \\\"alltabs-box\\\");\\n       </field>\\n \\n-      <field name=\\\"mFlashTimer\\\">null</field>\\n-      <field name=\\\"mFlashStage\\\">0</field>\\n-      <field name=\\\"mFlashStart\\\">6</field>\\n-      <field name=\\\"mFlashDelay\\\">150</field>\\n+      <field name=\\\"_animateTimer\\\">null</field>\\n+      <field name=\\\"_animateStep\\\">-1</field>\\n+      <field name=\\\"_animateDelay\\\">50</field>\\n+      <field name=\\\"_animatePercents\\\">\\n+\\t[0.50, 0.60, 0.70, 0.80, 0.90,\\n+\\t 1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00,\\n+\\t 1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00,\\n+\\t 1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00,\\n+\\t 0.95, 0.90, 0.85, 0.80, 0.75, 0.70, 0.65, 0.60, 0.55, 0.50,\\n+\\t 0.45, 0.40, 0.35, 0.30, 0.25, 0.20, 0.15, 0.10, 0.05, 0.00]\\n+      </field>\\n+\\n+      <method name=\\\"_stopAnimation\\\">\\n+        <body><![CDATA[\\n+          if (this._animateStep != -1) {\\n+            if (this._animateTimer)\\n+              this._animateTimer.cancel();\\n \\n+            this._animateStep = -1;\\n+            this.mAllTabsBox.style.opacity = 0.0;\\n+          }\\n+        ]]></body>\\n+      </method>\\n+      \\n       <method name=\\\"_notifyBackgroundTab\\\">\\n         <parameter name=\\\"aTab\\\"/>\\n         <body><![CDATA[\\n-          if (this.mFlashStage)\\n+          // if we are already animating, don't do it again\\n+          if (this._animateStep != -1)\\n             return;\\n-\\n+      \\n           var tsbo = this.mTabstrip.scrollBoxObject;\\n           var tsboStart = tsbo.screenX;\\n           var tsboEnd = tsboStart + tsbo.width;\\n@@ -2689,17 +2723,17 @@\\n           // only start the flash timer if the new tab (which was loaded in\\n           // the background) is not completely visible\\n           if (tsboStart > ctboStart || ctboEnd > tsboEnd) {\\n-            this.mFlashStage = this.mFlashStart;\\n+            this._animateStep = 0;\\n \\n-            if (!this.mFlashTimer) \\n-              this.mFlashTimer =\\n+            if (!this._animateTimer) \\n+              this._animateTimer =\\n                 Components.classes[\\\"@mozilla.org/timer;1\\\"]\\n                           .createInstance(Components.interfaces.nsITimer);\\n             else\\n-               this.mFlashTimer.cancel();\\n+               this._animateTimer.cancel();\\n \\n-            this.mFlashTimer.initWithCallback(this,\\n-                         this.mFlashDelay,\\n+            this._animateTimer.initWithCallback(this,\\n+                         this._animateDelay,\\n                          Components.interfaces.nsITimer.TYPE_REPEATING_SLACK);\\n           }\\n         ]]></body>\\n@@ -2711,13 +2745,13 @@\\n           if (!document)\\n             aTimer.cancel();\\n \\n-          this.mFlashStage--;\\n+          var percent = this._animatePercents[this._animateStep];\\n+          this.mAllTabsBox.style.opacity = percent;\\n \\n-          this.mAllTabsBox.setAttribute(\\\"flash\\\",\\n-            (this.mFlashStage % 2) ? \\\"true\\\" : \\\"false\\\");\\n-\\n-          if (!this.mFlashStage)\\n-            aTimer.cancel();\\n+          if (this._animateStep < (this._animatePercents.length - 1))\\n+            this._animateStep++;\\n+          else\\n+            this._stopAnimation();\\n         ]]></body>\\n       </method>\\n     </implementation>\\n@@ -2802,6 +2836,10 @@\\n           var tabcontainer = document.getBindingParent(this);\\n           var tabs = tabcontainer.childNodes;\\n \\n+          // if an animation is in progress and the user\\n+          // clicks on the \\\"all tabs\\\" button, stop the animation\\n+          tabcontainer._stopAnimation();\\n+\\n           for (var i = 0; i < tabs.length; i++) {\\n             var menuItem = document.createElementNS(\\n               \\\"http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul\\\", \\ndiff --git a/browser/themes/pinstripe/browser/tabbrowser/tabbrowserBindings.xml b/browser/themes/pinstripe/browser/tabbrowser/tabbrowserBindings.xml\\nindex 883d692..1e9ab3a 100644\\n--- a/browser/themes/pinstripe/browser/tabbrowser/tabbrowserBindings.xml\\n+++ b/browser/themes/pinstripe/browser/tabbrowser/tabbrowserBindings.xml\\n@@ -62,13 +62,28 @@\\n             <xul:arrowscrollbox anonid=\\\"arrowscrollbox\\\" orient=\\\"horizontal\\\" flex=\\\"1\\\" style=\\\"min-width: 1px;\\\" clicktoscroll=\\\"true\\\">\\n               <children/>\\n             </xul:arrowscrollbox>\\n-            <xul:hbox class=\\\"tabs-alltabs-box\\\" pack=\\\"end\\\" align=\\\"center\\\"\\n-                      anonid=\\\"alltabs-box\\\">\\n-              <xul:toolbarbutton class=\\\"tabs-alltabs-button\\\" type=\\\"menu\\\">\\n-                <xul:menupopup class=\\\"tabs-alltabs-popup\\\"\\n-                  anonid=\\\"alltabs-popup\\\" position=\\\"after_end\\\"/>\\n-              </xul:toolbarbutton>\\n-            </xul:hbox>\\n+            <xul:stack align=\\\"center\\\" pack=\\\"end\\\">\\n+              <!-- XXXsspitzer hack\\n+                   this extra hbox with position: relative\\n+                   is needed to work around two bugs.\\n+                   see bugs #346307 and #346035 \\n+              -->\\n+              <xul:hbox style=\\\"position: relative;\\\">\\n+                <xul:hbox flex=\\\"1\\\" class=\\\"tabs-alltabs-box\\\" \\n+                          anonid=\\\"alltabs-box\\\"/>\\n+              </xul:hbox>\\n+              <!-- XXXsspitzer hack\\n+                   this extra hbox with position: relative\\n+                   is needed to work around two bugs.\\n+                   see bugs #346307 and #346035 \\n+              -->\\n+              <xul:hbox style=\\\"position: relative;\\\">\\n+                <xul:toolbarbutton class=\\\"tabs-alltabs-button\\\" type=\\\"menu\\\">\\n+                  <xul:menupopup class=\\\"tabs-alltabs-popup\\\"\\n+                                 anonid=\\\"alltabs-popup\\\" position=\\\"after_end\\\"/>\\n+                </xul:toolbarbutton>\\n+              </xul:hbox>\\n+            </xul:stack>\\n             <xul:hbox class=\\\"tabs-closebutton-box\\\" align=\\\"center\\\" pack=\\\"end\\\" anonid=\\\"tabstrip-closebutton\\\">\\n               <xul:toolbarbutton class=\\\"close-button tabs-closebutton\\\"/>\\n             </xul:hbox>\\n\""}