{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basdf9ee03\""},"diff":"\"df9ee03 bug 395809. GetTextAtOffset(start-of-line) for end of text should return the last line. r=surkov, a=dsicore\\ndiff --git a/accessible/src/html/nsHyperTextAccessible.cpp b/accessible/src/html/nsHyperTextAccessible.cpp\\nindex dcd40b0..98b2b17 100644\\n--- a/accessible/src/html/nsHyperTextAccessible.cpp\\n+++ b/accessible/src/html/nsHyperTextAccessible.cpp\\n@@ -806,7 +806,16 @@ nsresult nsHyperTextAccessible::GetTextHelper(EGetTextType aType, nsAccessibleTe\\n   if (!startFrame) {\\n     PRInt32 textLength;\\n     GetCharacterCount(&textLength);\\n-    return (aOffset < 0 || aOffset > textLength) ? NS_ERROR_FAILURE : NS_OK;\\n+    if (aBoundaryType == BOUNDARY_LINE_START && aOffset > 0 && aOffset == textLength) {\\n+      // Asking for start of line, while on last character\\n+      nsCOMPtr<nsPIAccessNode> startAccessNode = do_QueryInterface(startAcc);\\n+      if (startAccessNode) {\\n+        startFrame = startAccessNode->GetFrame();\\n+      }\\n+    }\\n+    if (!startFrame) {\\n+      return (aOffset < 0 || aOffset > textLength) ? NS_ERROR_FAILURE : NS_OK;\\n+    }\\n   }\\n \\n   nsSelectionAmount amount;\\n@@ -901,10 +910,14 @@ nsresult nsHyperTextAccessible::GetTextHelper(EGetTextType aType, nsAccessibleTe\\n         // that the first character is in\\n         return GetTextHelper(eGetAfter, aBoundaryType, aOffset, aStartOffset, aEndOffset, aText);\\n       }\\n-      // This happens sometimes when current character at finalStartOffset \\n-      // is an embedded object character representing another hypertext, that\\n-      // the AT really needs to dig into separately\\n-      ++ finalEndOffset;\\n+      PRInt32 textLength;\\n+      GetCharacterCount(&textLength);\\n+      if (finalEndOffset < textLength) {\\n+        // This happens sometimes when current character at finalStartOffset \\n+        // is an embedded object character representing another hypertext, that\\n+        // the AT really needs to dig into separately\\n+        ++ finalEndOffset;\\n+      }\\n     }\\n   }\\n \\n@@ -914,7 +927,8 @@ nsresult nsHyperTextAccessible::GetTextHelper(EGetTextType aType, nsAccessibleTe\\n   NS_ASSERTION((finalStartOffset < aOffset && finalEndOffset >= aOffset) || aType != eGetBefore, \\\"Incorrect results for GetTextHelper\\\");\\n   NS_ASSERTION((finalStartOffset <= aOffset && finalEndOffset > aOffset) || aType == eGetBefore, \\\"Incorrect results for GetTextHelper\\\");\\n \\n-  return GetPosAndText(finalStartOffset, finalEndOffset, &aText) ? NS_OK : NS_ERROR_FAILURE;\\n+  GetPosAndText(finalStartOffset, finalEndOffset, &aText);\\n+  return NS_OK;\\n }\\n \\n /**\\n\""}