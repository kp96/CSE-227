{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Base8f70c5\""},"diff":"\"e8f70c5 Bug 374528  Provide backup and restore functionality for Places bookmarks (for thunder, r=dietrich, a=mconnor)\\ndiff --git a/browser/components/places/content/places.js b/browser/components/places/content/places.js\\nindex 7b50a23..d11fb91 100755\\n--- a/browser/components/places/content/places.js\\n+++ b/browser/components/places/content/places.js\\n@@ -270,7 +270,7 @@ var PlacesOrganizer = {\\n     if (window.fromFile)\\n     this.importFromFile();\\n   },\\n-  \\n+\\n   /**\\n    * Open a file-picker and import the selected file into the bookmarks store\\n    */\\n@@ -307,6 +307,141 @@ var PlacesOrganizer = {\\n     }\\n   },\\n \\n+  /**\\n+   * Populates the restore menu with the dates of the backups available.\\n+   */\\n+  populateRestoreMenu: function PO_populateRestoreMenu() {\\n+    var restorePopup = document.getElementById(\\\"fileRestorePopup\\\");\\n+\\n+    // remove existing menu items\\n+    // last item is the restoreFromFile item\\n+    while (restorePopup.childNodes.length > 1)\\n+      restorePopup.removeChild(restorePopup.firstChild);\\n+\\n+    // get bookmarks backup dir\\n+    var dirSvc = Cc[\\\"@mozilla.org/file/directory_service;1\\\"].\\n+                     getService(Ci.nsIProperties);\\n+    var bookmarksBackupDir = dirSvc.get(\\\"ProfD\\\", Ci.nsIFile);\\n+    bookmarksBackupDir.append(\\\"bookmarkbackups\\\"); \\n+    if (!bookmarksBackupDir.exists())\\n+      return; // no backup files\\n+\\n+    // get list of files\\n+    var fileList = [];\\n+    var files = bookmarksBackupDir.directoryEntries;\\n+    while (files.hasMoreElements()) {\\n+      var f = files.getNext().QueryInterface(Ci.nsIFile);\\n+      if (!f.isHidden() && f.leafName.match(/\\\\.html?$/))\\n+        fileList.push(f);\\n+    }\\n+\\n+    fileList.sort(function PO_fileList_compare(a, b) {\\n+        return b.lastModifiedTime - a.lastModifiedTime;\\n+      });\\n+\\n+    if (fileList.length == 0)\\n+      return;\\n+\\n+    // populate menu\\n+    for (var i = 0; i < fileList.length; i++) {\\n+      var m = restorePopup.insertBefore\\n+        (document.createElement(\\\"menuitem\\\"),\\n+         document.getElementById(\\\"restoreFromFile\\\"));\\n+      var dateStr = fileList[i].leafName.replace(\\\"bookmarks-\\\", \\\"\\\").\\n+        replace(\\\".html\\\", \\\"\\\");\\n+      if (!dateStr.length)\\n+        dateStr = fileList[i].leafName;\\n+      m.setAttribute(\\\"label\\\", dateStr);\\n+      m.setAttribute(\\\"value\\\", fileList[i].leafName);\\n+      m.setAttribute(\\\"oncommand\\\",\\n+                     \\\"PlacesOrganizer.onRestoreMenuItemClick(this);\\\");\\n+    }\\n+    restorePopup.insertBefore(document.createElement(\\\"menuseparator\\\"),\\n+                              document.getElementById(\\\"restoreFromFile\\\"));\\n+  },\\n+\\n+  /**\\n+   * Called when a menuitem is selected from the restore menu.\\n+   */\\n+  onRestoreMenuItemClick: function PO_onRestoreMenuItemClick(aMenuItem) {\\n+    var dirSvc = Cc[\\\"@mozilla.org/file/directory_service;1\\\"].\\n+                     getService(Ci.nsIProperties);\\n+    var bookmarksFile = dirSvc.get(\\\"ProfD\\\", Ci.nsIFile);\\n+    bookmarksFile.append(\\\"bookmarkbackups\\\"); \\n+    bookmarksFile.append(aMenuItem.getAttribute(\\\"value\\\"));\\n+    if (!bookmarksFile.exists())\\n+      return;\\n+\\n+    var prompts = Cc[\\\"@mozilla.org/embedcomp/prompt-service;1\\\"].\\n+      getService(Ci.nsIPromptService);\\n+    if (!prompts.confirm(null,\\n+                         PlacesUtils.getString(\\\"bookmarksRestoreAlertTitle\\\"),\\n+                         PlacesUtils.getString(\\\"bookmarksRestoreAlert\\\")))\\n+      return;\\n+\\n+    var ieSvc = Cc[\\\"@mozilla.org/browser/places/import-export-service;1\\\"].\\n+      getService(Ci.nsIPlacesImportExportService);\\n+    ieSvc.importHTMLFromFile(bookmarksFile, true);\\n+  },\\n+\\n+  /**\\n+   * Backup bookmarks to desktop, auto-generate a filename with a date\\n+   */\\n+  backupBookmarks: function PO_backupBookmarks() {\\n+    var fp = Cc[\\\"@mozilla.org/filepicker;1\\\"].createInstance(Ci.nsIFilePicker);\\n+    fp.init(window, PlacesUtils.getString(\\\"bookmarksBackupTitle\\\"),\\n+            Ci.nsIFilePicker.modeSave);\\n+    fp.appendFilters(Ci.nsIFilePicker.filterHTML);\\n+  \\n+    var dirSvc = Cc[\\\"@mozilla.org/file/directory_service;1\\\"].\\n+      getService(Ci.nsIProperties);\\n+    var backupsDir = dirSvc.get(\\\"Desk\\\", Ci.nsILocalFile);\\n+    fp.displayDirectory = backupsDir;\\n+  \\n+    var dateService = Cc[\\\"@mozilla.org/intl/scriptabledateformat;1\\\"].\\n+      getService(Ci.nsIScriptableDateFormat);\\n+\\n+    var d = new Date();\\n+    var date = dateService.FormatDate(\\\"\\\", dateService.dateFormatShort,\\n+                           d.getFullYear(), d.getMonth(), d.getDate());\\n+    fp.defaultString = PlacesUtils.getFormattedString(\\\"bookmarksBackupFilename\\\",\\n+                                                      [date]);\\n+  \\n+    if (fp.show() != Ci.nsIFilePicker.returnCancel) {\\n+      var ieSvc = Cc[\\\"@mozilla.org/browser/places/import-export-service;1\\\"].\\n+        getService(Ci.nsIPlacesImportExportService);\\n+      ieSvc.exportHTMLToFile(fp.file);\\n+    }\\n+  },\\n+\\n+  /**\\n+   * Called when 'Choose File...' is selected from the Revert menupopup\\n+   * Prompts for a file and reverts bookmarks to those in the file\\n+   */\\n+  restoreFromFile: function PO_restoreFromFile() {\\n+    var prompts = Cc[\\\"@mozilla.org/embedcomp/prompt-service;1\\\"].\\n+      getService(Ci.nsIPromptService);\\n+    if (!prompts.confirm(null, PlacesUtils.getString(\\\"bookmarksRestoreAlertTitle\\\"),\\n+                         PlacesUtils.getString(\\\"bookmarksRestoreAlert\\\")))\\n+      return;\\n+  \\n+    var fp = Cc[\\\"@mozilla.org/filepicker;1\\\"].createInstance(Ci.nsIFilePicker);\\n+    fp.init(window, PlacesUtils.getString(\\\"bookmarksRestoreTitle\\\"),\\n+            Ci.nsIFilePicker.modeOpen);\\n+    fp.appendFilters(Ci.nsIFilePicker.filterHTML);\\n+  \\n+    var dirSvc = Cc[\\\"@mozilla.org/file/directory_service;1\\\"].\\n+      getService(Ci.nsIProperties);\\n+    var backupsDir = dirSvc.get(\\\"Desk\\\", Ci.nsILocalFile);\\n+    fp.displayDirectory = backupsDir;\\n+  \\n+    if (fp.show() != Ci.nsIFilePicker.returnCancel) {\\n+      var ieSvc = Cc[\\\"@mozilla.org/browser/places/import-export-service;1\\\"].\\n+                     getService(Ci.nsIPlacesImportExportService);\\n+      ieSvc.importHTMLFromFile(fp.file, true);\\n+    }\\n+  },\\n+\\n   updateStatusBarForView: function PO_updateStatusBarForView(aView) {\\n     var statusText = \\\"\\\";\\n     var selectedNode = aView.selectedNode;\\ndiff --git a/browser/components/places/content/places.xul b/browser/components/places/content/places.xul\\nindex ddbb777..984ce2f 100755\\n--- a/browser/components/places/content/places.xul\\n+++ b/browser/components/places/content/places.xul\\n@@ -86,6 +86,10 @@\\n              oncommand=\\\"PlacesOrganizer.exportBookmarks();\\\"/>\\n     <command id=\\\"OrganizerCommand_import\\\"\\n              oncommand=\\\"PlacesOrganizer.importBookmarks();\\\"/>\\n+    <command id=\\\"OrganizerCommand_backup\\\"\\n+             oncommand=\\\"PlacesOrganizer.backupBookmarks();\\\"/>\\n+    <command id=\\\"OrganizerCommand_restoreFromFile\\\"\\n+             oncommand=\\\"PlacesOrganizer.restoreFromFile();\\\"/>\\n     <command id=\\\"OrganizerCommand_search:save\\\"\\n              oncommand=\\\"PlacesOrganizer.saveSearch();\\\"/>\\n     <command id=\\\"OrganizerCommand_search:moreCriteria\\\"\\n@@ -188,6 +192,20 @@\\n                     label=\\\"&cmd.export.label;\\\"\\n                     accesskey=\\\"&cmd.export.accesskey;\\\"/>\\n           <menuseparator/>\\n+          <menuitem id=\\\"backupBookmarks\\\"\\n+                    command=\\\"OrganizerCommand_backup\\\"\\n+                    label=\\\"&cmd.backup.label;\\\"\\n+                    accesskey=\\\"&cmd.backup.accesskey;\\\"/>\\n+          <menu id=\\\"fileRestoreMenu\\\" label=\\\"&cmd.restore.label;\\\"\\n+                    accesskey=\\\"&cmd.export.accesskey;\\\">\\n+            <menupopup id=\\\"fileRestorePopup\\\" onpopupshowing=\\\"PlacesOrganizer.populateRestoreMenu();\\\">\\n+              <menuitem id=\\\"restoreFromFile\\\"\\n+                        command=\\\"OrganizerCommand_restoreFromFile\\\"\\n+                        label=\\\"&cmd.restoreFromFile.label;\\\"\\n+                        accesskey=\\\"&cmd.restoreFromFile.accesskey;\\\"/>\\n+            </menupopup>\\n+          </menu>\\n+          <menuseparator/>\\n           <menuitem id=\\\"fileClose\\\"\\n                     key=\\\"placesKey_close\\\" \\n                     label=\\\"&file.close.label;\\\"\\ndiff --git a/browser/locales/en-US/chrome/browser/places/places.dtd b/browser/locales/en-US/chrome/browser/places/places.dtd\\nindex af9294e..3d6e9b0 100644\\n--- a/browser/locales/en-US/chrome/browser/places/places.dtd\\n+++ b/browser/locales/en-US/chrome/browser/places/places.dtd\\n@@ -67,6 +67,18 @@\\n   \\\"Import...\\\">\\n <!ENTITY cmd.import.accesskey\\n   \\\"I\\\">\\n+<!ENTITY cmd.backup.label\\n+  \\\"Backup...\\\">\\n+<!ENTITY cmd.backup.accesskey\\n+  \\\"B\\\">\\n+<!ENTITY cmd.restore.label\\n+  \\\"Restore...\\\">\\n+<!ENTITY cmd.restore.accesskey\\n+  \\\"R\\\">\\n+<!ENTITY cmd.restoreFromFile.label\\n+  \\\"Choose File...\\\">\\n+<!ENTITY cmd.restoreFromFile.accesskey\\n+  \\\"C\\\">\\n <!ENTITY cmd.select_all.label\\n   \\\"Select All\\\">\\n <!ENTITY cmd.select_all.accesskey\\ndiff --git a/browser/locales/en-US/chrome/browser/places/places.properties b/browser/locales/en-US/chrome/browser/places/places.properties\\nindex 4c2dee4..52a7a5b 100644\\n--- a/browser/locales/en-US/chrome/browser/places/places.properties\\n+++ b/browser/locales/en-US/chrome/browser/places/places.properties\\n@@ -20,6 +20,13 @@ bookmarksMenuEmptyFolder=(Empty)\\n bookmarksLivemarkLoading=Live Bookmark loading...\\n bookmarksLivemarkFailed=Live Bookmark feed failed to load.\\n \\n+bookmarksBackupFilename=Bookmarks %1$S.html\\n+bookmarksBackupTitle=Bookmarks backup filename\\n+\\n+bookmarksRestoreAlertTitle=Revert Bookmarks\\n+bookmarksRestoreAlert=This will replace all of your current bookmarks with the backup. Are you sure?\\n+bookmarksRestoreTitle=Select a bookmarks backup\\n+\\n headerTextPrefix1=Showing \\n headerTextPrefix2=Search Results for \\n headerTextPrefix3=Advanced Search\\n\""}