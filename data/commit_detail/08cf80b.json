{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas08cf80b\""},"diff":"\"08cf80b Bug 384854 - Hide certain context menu options (view source, view selection source, etc) when viewing non-text content (images, plugins) p=Ehsan Akhgari <ehsan.akhgari@gmail.com> r=mano\\ndiff --git a/browser/base/content/browser-context.inc b/browser/base/content/browser-context.inc\\nindex 0ec46b2..f2a3394 100644\\n--- a/browser/base/content/browser-context.inc\\n+++ b/browser/base/content/browser-context.inc\\n@@ -20,6 +20,7 @@\\n # the Initial Developer. All Rights Reserved.\\n #\\n # Contributor(s):\\n+#   Ehsan Akhgari <ehsan.akhgari@gmail.com>\\n #\\n # Alternatively, the contents of this file may be used under the terms of\\n # either the GNU General Public License Version 2 or later (the \\\"GPL\\\"), or\\n@@ -204,7 +205,8 @@\\n           <menuseparator/>\\n           <menuitem label=\\\"&viewFrameSourceCmd.label;\\\"\\n                     accesskey=\\\"&viewFrameSourceCmd.accesskey;\\\"\\n-                    oncommand=\\\"gContextMenu.viewFrameSource();\\\"/>\\n+                    oncommand=\\\"gContextMenu.viewFrameSource();\\\"\\n+                    observes=\\\"isFrameImage\\\"/>\\n           <menuitem label=\\\"&viewFrameInfoCmd.label;\\\"\\n                     accesskey=\\\"&viewFrameInfoCmd.accesskey;\\\"\\n                     oncommand=\\\"gContextMenu.viewFrameInfo();\\\"/>\\n@@ -214,15 +216,18 @@\\n       <menuitem id=\\\"context-viewpartialsource-selection\\\"\\n                 label=\\\"&viewPartialSourceForSelectionCmd.label;\\\"\\n                 accesskey=\\\"&viewPartialSourceCmd.accesskey;\\\"\\n-                oncommand=\\\"gContextMenu.viewPartialSource('selection');\\\"/>\\n+                oncommand=\\\"gContextMenu.viewPartialSource('selection');\\\"\\n+                observes=\\\"isImage\\\"/>\\n       <menuitem id=\\\"context-viewpartialsource-mathml\\\"\\n                 label=\\\"&viewPartialSourceForMathMLCmd.label;\\\"\\n                 accesskey=\\\"&viewPartialSourceCmd.accesskey;\\\"\\n-                oncommand=\\\"gContextMenu.viewPartialSource('mathml');\\\"/>\\n+                oncommand=\\\"gContextMenu.viewPartialSource('mathml');\\\"\\n+                observes=\\\"isImage\\\"/>\\n       <menuitem id=\\\"context-viewsource\\\"\\n                 label=\\\"&viewPageSourceCmd.label;\\\"\\n                 accesskey=\\\"&viewPageSourceCmd.accesskey;\\\"\\n-                oncommand=\\\"BrowserViewSourceOfDocument(content.document);\\\"/>\\n+                oncommand=\\\"BrowserViewSourceOfDocument(content.document);\\\"\\n+                observes=\\\"isImage\\\"/>\\n       <menuitem id=\\\"context-viewinfo\\\"\\n                 label=\\\"&viewPageInfoCmd.label;\\\"\\n                 accesskey=\\\"&viewPageInfoCmd.accesskey;\\\"\\ndiff --git a/browser/base/content/browser-sets.inc b/browser/base/content/browser-sets.inc\\nindex 2c4f17c..f8f2985 100644\\n--- a/browser/base/content/browser-sets.inc\\n+++ b/browser/base/content/browser-sets.inc\\n@@ -23,6 +23,7 @@\\n #   Ben Goodger <ben@bengoodger.com> (v2.0)\\n #   Blake Ross <blakeross@telocity.com>\\n #   Shawn Wilsher <me@shawnwilsher.com>\\n+#   Ehsan Akhgari <ehsan.akhgari@gmail.com>\\n #\\n # Alternatively, the contents of this file may be used under the terms of\\n # either the GNU General Public License Version 2 or later (the \\\"GPL\\\"), or\\n@@ -155,6 +156,7 @@\\n                  oncommand=\\\"gPopupBlockerObserver.dontShowMessage();\\\"/>\\n     <broadcaster id=\\\"blockedPopupsSeparator\\\"/>\\n     <broadcaster id=\\\"isImage\\\"/>\\n+    <broadcaster id=\\\"isFrameImage\\\"/>\\n   </broadcasterset>\\n \\n   <keyset id=\\\"mainKeyset\\\">\\ndiff --git a/browser/base/content/browser.js b/browser/base/content/browser.js\\nindex 861226b..0b135b8 100644\\n--- a/browser/base/content/browser.js\\n+++ b/browser/base/content/browser.js\\n@@ -3183,6 +3183,20 @@ var FullScreen =\\n   }\\n };\\n \\n+/**\\n+ * Returns true if |aMimeType| is text-based, false otherwise.\\n+ *\\n+ * @param aMimeType\\n+ *        The MIME type to check.\\n+ */\\n+function mimeTypeIsTextBased(aMimeType)\\n+{\\n+  return /^text\\\\/|\\\\+xml$/.test(aMimeType) ||\\n+         aMimeType == \\\"application/x-javascript\\\" ||\\n+         aMimeType == \\\"application/xml\\\" ||\\n+         aMimeType == \\\"mozilla.application/cached-xul\\\";\\n+}\\n+\\n function nsBrowserStatusHandler()\\n {\\n   this.init();\\n@@ -3281,14 +3295,6 @@ nsBrowserStatusHandler.prototype =\\n     }\\n   },\\n   \\n-  mimeTypeIsTextBased : function(contentType)\\n-  {\\n-    return /^text\\\\/|\\\\+xml$/.test(contentType) ||\\n-           contentType == \\\"application/x-javascript\\\" ||\\n-           contentType == \\\"application/xml\\\" ||\\n-           contentType == \\\"mozilla.application/cached-xul\\\";\\n-  },\\n-\\n   onLinkIconAvailable : function(aBrowser)\\n   {\\n     if (gProxyFavIcon &&\\n@@ -3408,7 +3414,7 @@ nsBrowserStatusHandler.prototype =\\n           this.setDefaultStatus(msg);\\n \\n           // Disable menu entries for images, enable otherwise\\n-          if (content.document && this.mimeTypeIsTextBased(content.document.contentType))\\n+          if (content.document && mimeTypeIsTextBased(content.document.contentType))\\n             this.isImage.removeAttribute('disabled');\\n           else\\n             this.isImage.setAttribute('disabled', 'true');\\n@@ -3487,7 +3493,7 @@ nsBrowserStatusHandler.prototype =\\n     selectedBrowser.lastURI = aLocationURI;\\n \\n     // Disable menu entries for images, enable otherwise\\n-    if (content.document && this.mimeTypeIsTextBased(content.document.contentType))\\n+    if (content.document && mimeTypeIsTextBased(content.document.contentType))\\n       this.isImage.removeAttribute('disabled');\\n     else\\n       this.isImage.setAttribute('disabled', 'true');\\ndiff --git a/browser/base/content/nsContextMenu.js b/browser/base/content/nsContextMenu.js\\nindex 2bcf606..4cd11b7 100644\\n--- a/browser/base/content/nsContextMenu.js\\n+++ b/browser/base/content/nsContextMenu.js\\n@@ -40,6 +40,7 @@\\n #   Michael Ventnor <ventnors_dogs234@yahoo.com.au>\\n #   Simon BÃ¼nzli <zeniko@gmail.com>\\n #   Gijs Kruitbosch <gijskruitbosch@gmail.com>\\n+#   Ehsan Akhgari <ehsan.akhgari@gmail.com>\\n #\\n # Alternatively, the contents of this file may be used under the terms of\\n # either the GNU General Public License Version 2 or later (the \\\"GPL\\\"), or\\n@@ -59,6 +60,7 @@ function nsContextMenu(aXulMenu, aBrowser) {\\n   this.target            = null;\\n   this.browser           = null;\\n   this.menu              = null;\\n+  this.isFrameImage      = false;\\n   this.onTextInput       = false;\\n   this.onKeywordField    = false;\\n   this.onImage           = false;\\n@@ -97,6 +99,8 @@ nsContextMenu.prototype = {\\n     this.menu = aPopup;\\n     this.browser = aBrowser;\\n \\n+    this.isFrameImage = document.getElementById(\\\"isFrameImage\\\");\\n+\\n     // Get contextual info.\\n     this.setTarget(document.popupNode, document.popupRangeParent,\\n                    document.popupRangeOffset);\\n@@ -213,6 +217,14 @@ nsContextMenu.prototype = {\\n     this.showItem(\\\"frame\\\", this.inFrame);\\n     this.showItem(\\\"frame-sep\\\", this.inFrame);\\n \\n+    // Hide menu entries for images, show otherwise\\n+    if (this.inFrame) {\\n+      if (mimeTypeIsTextBased(this.target.ownerDocument.contentType))\\n+        this.isFrameImage.removeAttribute('hidden');\\n+      else\\n+        this.isFrameImage.setAttribute('hidden', 'true');\\n+    }\\n+\\n     // BiDi UI\\n     this.showItem(\\\"context-sep-bidi\\\", top.gBidiUI);\\n     this.showItem(\\\"context-bidi-text-direction-toggle\\\",\\n\""}