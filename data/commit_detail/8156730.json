{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas8156730\""},"diff":"\"8156730 Bug 386163 - 'Set Desktop Background' refactoring: use canvas in all cases, support widescreen previews p=Dao Gottwald <dao@design-noir.de> r=mano, ui-r=mconnor\\ndiff --git a/browser/components/shell/content/setDesktopBackground.js b/browser/components/shell/content/setDesktopBackground.js\\nindex 3cc5017..fedbaef 100644\\n--- a/browser/components/shell/content/setDesktopBackground.js\\n+++ b/browser/components/shell/content/setDesktopBackground.js\\n@@ -21,7 +21,7 @@\\n # Contributor(s):\\n #   Blake Ross <blake@blakeross.com>\\n #   Ben Goodger <ben@mozilla.org>\\n-#   Dao Gottwald <dao@design-noir.de>\\n+#   Dão Gottwald <dao@design-noir.de>\\n #\\n # Alternatively, the contents of this file may be used under the terms of\\n # either the GNU General Public License Version 2 or later (the \\\"GPL\\\"), or\\n@@ -37,79 +37,68 @@\\n #\\n # ***** END LICENSE BLOCK *****\\n \\n-const kXUL_NS           = \\\"http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul\\\";\\n-const kHTML_NS          = \\\"http://www.w3.org/1999/xhtml\\\";\\n-const kIShellService    = Components.interfaces.nsIShellService;\\n-#ifdef XP_MACOSX\\n-const kIMacShellService = Components.interfaces.nsIMacShellService;\\n-#endif\\n+var Ci = Components.interfaces;\\n \\n var gSetBackground = {\\n-  _position         : kIShellService.BACKGROUND_STRETCH,\\n-  _monitor          : null,\\n-  _image            : null,\\n-  _backgroundColor  : 0,\\n-\\n #ifndef XP_MACOSX\\n-  // Converts a color string in the format \\\"#RRGGBB\\\" to an integer.\\n-  _hexStringToLong: function (aString)\\n-  {\\n-    return parseInt(aString.substring(1,3), 16) << 16 | \\n-           parseInt(aString.substring(3,5), 16) << 8 |\\n-           parseInt(aString.substring(5,7), 16);\\n-  },\\n-\\n-  _rgbToHex: function(aR, aG, aB) \\n-  {\\n-    var rHex = aR.toString(16).toUpperCase();\\n-    var gHex = aG.toString(16).toUpperCase();\\n-    var bHex = aB.toString(16).toUpperCase();\\n-\\n-    if (rHex.length == 1) rHex ='0' + rHex;\\n-    if (gHex.length == 1) gHex ='0' + gHex;\\n-    if (bHex.length == 1) bHex ='0' + bHex;\\n-\\n-    return '#' + rHex + gHex + bHex;\\n-  },\\n+  _position        : \\\"\\\",\\n+  _backgroundColor : 0,\\n+#else\\n+  _position        : \\\"STRETCH\\\",\\n #endif\\n+  _screenWidth     : 0,\\n+  _screenHeight    : 0,\\n+  _image           : null,\\n+  _canvas          : null,\\n \\n   get _shell()\\n   {\\n     return Components.classes[\\\"@mozilla.org/browser/shell-service;1\\\"]\\n-                     .getService(Components.interfaces.nsIShellService);\\n+                     .getService(Ci.nsIShellService);\\n   },\\n \\n   load: function ()\\n   {\\n-    this._monitor = document.getElementById(\\\"monitor\\\");\\n+    this._canvas = document.getElementById(\\\"screen\\\");\\n+    this._screenWidth = screen.width;\\n+    this._screenHeight = screen.height;\\n #ifdef XP_MACOSX\\n     document.documentElement.getButton(\\\"accept\\\").hidden = true;\\n #endif\\n-    this.init(window.arguments[0]);\\n+    if (this._screenWidth / this._screenHeight >= 1.6)\\n+      document.getElementById(\\\"monitor\\\").setAttribute(\\\"aspectratio\\\", \\\"16:10\\\");\\n+\\n+    // make sure that the correct dimensions will be used\\n+    setTimeout(function(self) {\\n+      self.init(window.arguments[0]);\\n+    }, 0, this);\\n   },\\n \\n   init: function (aImage)\\n   {\\n     this._image = aImage;\\n \\n+    // set the size of the coordinate space\\n+    this._canvas.width = this._canvas.clientWidth;\\n+    this._canvas.height = this._canvas.clientHeight;\\n+\\n+    var ctx = this._canvas.getContext(\\\"2d\\\");\\n+    ctx.scale(this._canvas.clientWidth / this._screenWidth, this._canvas.clientHeight / this._screenHeight);\\n+\\n #ifndef XP_MACOSX\\n     this._initColor();\\n-    var position = parseInt(document.getElementById(\\\"menuPosition\\\").value);\\n #else\\n     // Make sure to reset the button state in case the user has already\\n-    // set an image as their desktop background. \\n+    // set an image as their desktop background.\\n     var setDesktopBackground = document.getElementById(\\\"setDesktopBackground\\\");\\n     setDesktopBackground.hidden = false;\\n     var bundle = document.getElementById(\\\"backgroundBundle\\\");\\n     setDesktopBackground.label = bundle.getString(\\\"DesktopBackgroundSet\\\");\\n     setDesktopBackground.disabled = false;\\n \\n-    var showDesktopPreferences = document.getElementById(\\\"showDesktopPreferences\\\");\\n-    showDesktopPreferences.hidden = true;\\n-\\n-    var position = kIShellService.BACKGROUND_STRETCH;\\n+    document.getElementById(\\\"showDesktopPreferences\\\").hidden = true;\\n #endif\\n-    this.updatePosition(position);\\n+    this.updatePosition();\\n   },\\n \\n #ifndef XP_MACOSX\\n@@ -128,126 +117,87 @@ var gSetBackground = {\\n     var colorpicker = document.getElementById(\\\"desktopColor\\\");\\n     colorpicker.color = this._backgroundColor;\\n   },\\n-#endif\\n \\n-  observe: function (aSubject, aTopic, aData)\\n+  updateColor: function (aColor)\\n   {\\n-    if (aTopic == \\\"shell:desktop-background-changed\\\") {\\n-      var setDesktopBackground = document.getElementById(\\\"setDesktopBackground\\\");\\n-      setDesktopBackground.hidden = true;\\n-\\n-      var showDesktopPreferences = document.getElementById(\\\"showDesktopPreferences\\\");\\n-      showDesktopPreferences.hidden = false;\\n-\\n-      var os = Components.classes[\\\"@mozilla.org/observer-service;1\\\"]\\n-                         .getService(Components.interfaces.nsIObserverService);\\n-      os.removeObserver(this, \\\"shell:desktop-background-changed\\\");\\n-    }\\n+    this._backgroundColor = aColor;\\n+    this._canvas.style.backgroundColor = aColor;\\n   },\\n \\n-#ifdef XP_MACOSX\\n-  setDesktopBackground: function()\\n+  // Converts a color string in the format \\\"#RRGGBB\\\" to an integer.\\n+  _hexStringToLong: function (aString)\\n   {\\n-    var os = Components.classes[\\\"@mozilla.org/observer-service;1\\\"]\\n-                       .getService(Components.interfaces.nsIObserverService);\\n-    os.addObserver(this, \\\"shell:desktop-background-changed\\\", false);\\n-\\n-    var bundle = document.getElementById(\\\"backgroundBundle\\\");\\n-    var setDesktopBackground = document.getElementById(\\\"setDesktopBackground\\\");\\n-    setDesktopBackground.disabled = true;\\n-    setDesktopBackground.label = bundle.getString(\\\"DesktopBackgroundDownloading\\\");\\n-\\n-    this._shell.setDesktopBackground(this._image, this._position);\\n+    return parseInt(aString.substring(1,3), 16) << 16 |\\n+           parseInt(aString.substring(3,5), 16) << 8 |\\n+           parseInt(aString.substring(5,7), 16);\\n   },\\n-  \\n-  showDesktopPrefs: function()\\n+\\n+  _rgbToHex: function (aR, aG, aB)\\n   {\\n-    this._shell.openApplication(kIMacShellService.APPLICATION_DESKTOP);\\n+    return \\\"#\\\" + [aR, aG, aB].map(function(aInt) aInt.toString(16).replace(/^(.)$/, \\\"0$1\\\"))\\n+                             .join(\\\"\\\").toUpperCase();\\n   },\\n #else\\n-  setDesktopBackground: function () \\n+  observe: function (aSubject, aTopic, aData)\\n   {\\n-    this._shell.setDesktopBackground(this._image, this._position);\\n-    this._shell.desktopBackgroundColor = this._hexStringToLong(this._backgroundColor);\\n-    document.persist(\\\"menuPosition\\\", \\\"value\\\");\\n-  },\\n-#endif\\n+    if (aTopic == \\\"shell:desktop-background-changed\\\") {\\n+      document.getElementById(\\\"setDesktopBackground\\\").hidden = true;\\n+      document.getElementById(\\\"showDesktopPreferences\\\").hidden = false;\\n \\n-  updateColor: function (color)\\n-  {\\n-#ifndef XP_MACOSX\\n-    this._backgroundColor = color;\\n-    this._monitor.style.backgroundColor = color;\\n-#endif\\n-  },\\n-  \\n-  updatePosition: function (aPosition)\\n-  {\\n-    if (this._monitor.hasChildNodes())\\n-      this._monitor.removeChild(this._monitor.firstChild);\\n-      \\n-    this._position = aPosition;\\n-    if (this._position == kIShellService.BACKGROUND_TILE)\\n-      this._tileImage();\\n-    else if (this._position == kIShellService.BACKGROUND_STRETCH)\\n-      this._stretchImage();\\n-    else\\n-      this._centerImage();\\n+      Components.classes[\\\"@mozilla.org/observer-service;1\\\"]\\n+                .getService(Ci.nsIObserverService)\\n+                .removeObserver(this, \\\"shell:desktop-background-changed\\\");\\n+    }\\n   },\\n \\n-  _createImage: function ()\\n+  showDesktopPrefs: function()\\n   {\\n-    const nsIImageLoadingContent = Components.interfaces.nsIImageLoadingContent;\\n-    if (!(this._image instanceof nsIImageLoadingContent))\\n-        return false;\\n-\\n-    var request = this._image.QueryInterface(nsIImageLoadingContent)\\n-                             .getRequest(nsIImageLoadingContent.CURRENT_REQUEST);\\n-    if (!request)\\n-      return false;\\n-\\n-    var imgURI = this._image.currentURI;\\n-    if (imgURI.schemeIs(\\\"javascript\\\"))\\n-      return false;\\n-\\n-    var img = document.createElementNS(kXUL_NS, \\\"image\\\");\\n-    img.setAttribute(\\\"src\\\", imgURI.spec);\\n-    return img;\\n+    this._shell.openApplication(Ci.nsIMacShellService.APPLICATION_DESKTOP);\\n   },\\n+#endif\\n \\n-  _stretchImage: function ()\\n+  setDesktopBackground: function ()\\n   {\\n-    var img = this._createImage();\\n-    img.width = this._monitor.boxObject.width;\\n-    img.height = this._monitor.boxObject.height;\\n-    this._monitor.appendChild(img);\\n-  },\\n+#ifndef XP_MACOSX\\n+    document.persist(\\\"menuPosition\\\", \\\"value\\\");\\n+    this._shell.desktopBackgroundColor = this._hexStringToLong(this._backgroundColor);\\n+#else\\n+    Components.classes[\\\"@mozilla.org/observer-service;1\\\"]\\n+              .getService(Ci.nsIObserverService)\\n+              .addObserver(this, \\\"shell:desktop-background-changed\\\", false);\\n \\n-  _tileImage: function ()\\n-  {\\n-    var canvas = document.createElementNS(kHTML_NS, \\\"canvas\\\");\\n-    var width = this._monitor.boxObject.width;\\n-    var height = this._monitor.boxObject.height;\\n-    canvas.width = width;\\n-    canvas.height = height;\\n-\\n-    var ctx = canvas.getContext(\\\"2d\\\");\\n-    ctx.fillStyle = ctx.createPattern(this._image, \\\"repeat\\\");\\n-    ctx.scale(width / screen.width, height / screen.height);\\n-    ctx.fillRect(0, 0, screen.width, screen.height);\\n-\\n-    this._monitor.appendChild(canvas);\\n+    var bundle = document.getElementById(\\\"backgroundBundle\\\");\\n+    var setDesktopBackground = document.getElementById(\\\"setDesktopBackground\\\");\\n+    setDesktopBackground.disabled = true;\\n+    setDesktopBackground.label = bundle.getString(\\\"DesktopBackgroundDownloading\\\");\\n+#endif\\n+    this._shell.setDesktopBackground(this._image,\\n+                                     Ci.nsIShellService[\\\"BACKGROUND_\\\" + this._position]);\\n   },\\n \\n-  _centerImage: function ()\\n+  updatePosition: function ()\\n   {\\n-    var img = this._createImage();\\n-    // Use naturalHeight/Width here so we don't scale an image improperly in\\n-    // the preview window if the image is resized in the browser window.\\n-    var width = this._image.naturalWidth * this._monitor.boxObject.width / screen.width;\\n-    var height = this._image.naturalHeight * this._monitor.boxObject.height / screen.height;\\n-    img.width = Math.floor(width);\\n-    img.height = Math.floor(height);\\n-    this._monitor.appendChild(img);\\n+    var ctx = this._canvas.getContext(\\\"2d\\\");\\n+    ctx.clearRect(0, 0, this._screenWidth, this._screenHeight);\\n+\\n+#ifndef XP_MACOSX\\n+    this._position = document.getElementById(\\\"menuPosition\\\").value;\\n+#endif\\n+\\n+    switch (this._position) {\\n+      case \\\"TILE\\\":\\n+        ctx.save();\\n+        ctx.fillStyle = ctx.createPattern(this._image, \\\"repeat\\\");\\n+        ctx.fillRect(0, 0, this._screenWidth, this._screenHeight);\\n+        ctx.restore();\\n+        break;\\n+      case \\\"STRETCH\\\":\\n+        ctx.drawImage(this._image, 0, 0, this._screenWidth, this._screenHeight);\\n+        break;\\n+      case \\\"CENTER\\\":\\n+        var x = (this._screenWidth - this._image.naturalWidth) / 2;\\n+        var y = (this._screenHeight - this._image.naturalHeight) / 2;\\n+        ctx.drawImage(this._image, x, y);\\n+    }\\n   }\\n };\\ndiff --git a/browser/components/shell/content/setDesktopBackground.xul b/browser/components/shell/content/setDesktopBackground.xul\\nindex f776778..cc96733 100644\\n--- a/browser/components/shell/content/setDesktopBackground.xul\\n+++ b/browser/components/shell/content/setDesktopBackground.xul\\n@@ -23,6 +23,7 @@\\n # Contributor(s):\\n #   Blake Ross <blake@blakeross.com>\\n #   Ben Goodger <ben@mozilla.org>\\n+#   Dão Gottwald <dao@design-noir.de>\\n #\\n # Alternatively, the contents of this file may be used under the terms of\\n # either the GNU General Public License Version 2 or later (the \\\"GPL\\\"), or\\n@@ -47,9 +48,8 @@\\n <?xul-overlay href=\\\"chrome://browser/content/macBrowserOverlay.xul\\\"?>\\n #endif\\n \\n-<dialog xmlns:html=\\\"http://www.w3.org/1999/xhtml\\\"\\n-        xmlns=\\\"http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul\\\"\\n-        id=\\\"aboutDialog\\\"\\n+<dialog xmlns=\\\"http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul\\\"\\n+        xmlns:html=\\\"http://www.w3.org/1999/xhtml\\\"\\n         windowtype=\\\"Shell:SetDesktopBackground\\\"\\n #ifndef XP_MACOSX\\n         buttons=\\\"accept,cancel\\\"\\n@@ -60,27 +60,24 @@\\n         onload=\\\"gSetBackground.load();\\\"\\n         ondialogaccept=\\\"gSetBackground.setDesktopBackground();\\\"\\n         title=\\\"&setDesktopBackground.title;\\\"\\n-        style=\\\"width: 30em;\\\"> \\n-    \\n+        style=\\\"width: 30em;\\\">\\n+\\n     <stringbundle id=\\\"backgroundBundle\\\"\\n                   src=\\\"chrome://browser/locale/shellservice.properties\\\"/>\\n-    <script type=\\\"application/x-javascript\\\"\\n-            src=\\\"chrome://browser/content/utilityOverlay.js\\\"/>\\n-    <script type=\\\"application/x-javascript\\\"\\n-            src=\\\"chrome://browser/content/setDesktopBackground.js\\\"/>\\n-    <script type=\\\"application/x-javascript\\\"\\n-            src=\\\"chrome://global/content/contentAreaUtils.js\\\"/>\\n+    <script type=\\\"application/javascript\\\" src=\\\"chrome://browser/content/utilityOverlay.js\\\"/>\\n+    <script type=\\\"application/javascript\\\" src=\\\"chrome://browser/content/setDesktopBackground.js\\\"/>\\n+    <script type=\\\"application/javascript\\\" src=\\\"chrome://global/content/contentAreaUtils.js\\\"/>\\n \\n #ifndef XP_MACOSX\\n-    <hbox align=\\\"center\\\" id=\\\"foo\\\">\\n+    <hbox align=\\\"center\\\">\\n       <label value=\\\"&position.label;\\\"/>\\n       <menulist id=\\\"menuPosition\\\"\\n                 label=\\\"&position.label;\\\" \\n-                oncommand=\\\"gSetBackground.updatePosition(parseInt(this.value));\\\">\\n+                oncommand=\\\"gSetBackground.updatePosition();\\\">\\n         <menupopup>\\n-          <menuitem label=\\\"&center.label;\\\"  value=\\\"3\\\"/>\\n-          <menuitem label=\\\"&tile.label;\\\"    value=\\\"1\\\"/>\\n-          <menuitem label=\\\"&stretch.label;\\\" value=\\\"2\\\"/>\\n+          <menuitem label=\\\"&center.label;\\\"  value=\\\"CENTER\\\"/>\\n+          <menuitem label=\\\"&tile.label;\\\"    value=\\\"TILE\\\"/>\\n+          <menuitem label=\\\"&stretch.label;\\\" value=\\\"STRETCH\\\"/>\\n         </menupopup>\\n       </menulist>\\n       <spacer flex=\\\"1\\\"/>\\n@@ -93,8 +90,9 @@\\n     <groupbox align=\\\"center\\\">\\n       <caption label=\\\"&preview.label;\\\"/>\\n       <stack>\\n-        <vbox id=\\\"monitor\\\" align=\\\"center\\\" pack=\\\"center\\\"/>\\n-        <image id=\\\"monitorImage\\\"/>\\n+        <!-- if width and height are not present, they default to 300x150 and stretch the stack -->\\n+        <html:canvas id=\\\"screen\\\" width=\\\"1\\\" height=\\\"1\\\"/>\\n+        <image id=\\\"monitor\\\"/>\\n       </stack>\\n     </groupbox>\\n     \\ndiff --git a/browser/themes/pinstripe/browser/jar.mn b/browser/themes/pinstripe/browser/jar.mn\\nindex b9629cf..8a6e1d9 100644\\n--- a/browser/themes/pinstripe/browser/jar.mn\\n+++ b/browser/themes/pinstripe/browser/jar.mn\\n@@ -32,6 +32,7 @@ classic.jar:\\n   skin/classic/browser/feeds/feedIcon16.png                 (feeds/feedIcon16.png)\\n   skin/classic/browser/setDesktopBackground.css\\n   skin/classic/browser/monitor.png\\n+  skin/classic/browser/monitor_16-10.png\\n   skin/classic/browser/places/places.css                    (places/places.css)\\n   skin/classic/browser/places/query.png                     (places/query.png)\\n   skin/classic/browser/places/livemarkItem.png              (places/livemarkItem.png)\\ndiff --git a/browser/themes/pinstripe/browser/monitor.png b/browser/themes/pinstripe/browser/monitor.png\\nindex 2a9f837..ad90e55 100755\\nBinary files a/browser/themes/pinstripe/browser/monitor.png and b/browser/themes/pinstripe/browser/monitor.png differ\\ndiff --git a/browser/themes/pinstripe/browser/monitor_16-10.png b/browser/themes/pinstripe/browser/monitor_16-10.png\\nnew file mode 100644\\nindex 0000000..4195034\\nBinary files /dev/null and b/browser/themes/pinstripe/browser/monitor_16-10.png differ\\ndiff --git a/browser/themes/pinstripe/browser/setDesktopBackground.css b/browser/themes/pinstripe/browser/setDesktopBackground.css\\nindex a20eb75..184871f 100644\\n--- a/browser/themes/pinstripe/browser/setDesktopBackground.css\\n+++ b/browser/themes/pinstripe/browser/setDesktopBackground.css\\n@@ -1,12 +1,14 @@\\n @namespace url(\\\"http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul\\\");\\n+@namespace html url(\\\"http://www.w3.org/1999/xhtml\\\");\\n \\n-#monitor {\\n-  margin: 18px 20px 38px 13px;\\n-  width: 153px;\\n-  height: 114px;\\n-  overflow: hidden;\\n+html|canvas#screen {\\n+  margin: 12px 11px 38px;\\n }\\n \\n-#monitorImage {\\n+#monitor {\\n   list-style-image: url(\\\"chrome://browser/skin/monitor.png\\\");\\n }\\n+\\n+#monitor[aspectratio=\\\"16:10\\\"] {\\n+  list-style-image: url(\\\"chrome://browser/skin/monitor_16-10.png\\\");\\n+}\\ndiff --git a/browser/themes/winstripe/browser/jar.mn b/browser/themes/winstripe/browser/jar.mn\\nindex 1b9135d..3748f3b 100644\\n--- a/browser/themes/winstripe/browser/jar.mn\\n+++ b/browser/themes/winstripe/browser/jar.mn\\n@@ -40,6 +40,7 @@ classic.jar:\\n         skin/classic/browser/Search-provider-mid-bottom.png\\n         skin/classic/browser/setDesktopBackground.css\\n         skin/classic/browser/monitor.png\\n+        skin/classic/browser/monitor_16-10.png\\n         skin/classic/browser/feeds/feedIcon.png                 (feeds/feedIcon.png)\\n         skin/classic/browser/feeds/feedIcon16.png               (feeds/feedIcon16.png)\\n         skin/classic/browser/feeds/subscribe.css                (feeds/subscribe.css)\\ndiff --git a/browser/themes/winstripe/browser/monitor_16-10.png b/browser/themes/winstripe/browser/monitor_16-10.png\\nnew file mode 100644\\nindex 0000000..fb3fdbc\\nBinary files /dev/null and b/browser/themes/winstripe/browser/monitor_16-10.png differ\\ndiff --git a/browser/themes/winstripe/browser/setDesktopBackground.css b/browser/themes/winstripe/browser/setDesktopBackground.css\\nindex 909c659..3964351 100644\\n--- a/browser/themes/winstripe/browser/setDesktopBackground.css\\n+++ b/browser/themes/winstripe/browser/setDesktopBackground.css\\n@@ -1,17 +1,14 @@\\n @namespace url(\\\"http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul\\\");\\n+@namespace html url(\\\"http://www.w3.org/1999/xhtml\\\");\\n \\n-#monitor {\\n+html|canvas#screen {\\n   margin: 12px 11px 32px;\\n-  width: 153px;\\n-  height: 114px;\\n-  overflow: hidden;\\n }\\n \\n-#monitorImage {\\n+#monitor {\\n   list-style-image: url(\\\"chrome://browser/skin/monitor.png\\\");\\n }\\n \\n-#noPreviewAvailable {\\n-  background-color: white !important;\\n-  font-size: 12px !important;\\n+#monitor[aspectratio=\\\"16:10\\\"] {\\n+  list-style-image: url(\\\"chrome://browser/skin/monitor_16-10.png\\\");\\n }\\n\""}