{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basa38685a\""},"diff":"\"a38685a Fix bug 396286.  r+sr+a=roc\\ndiff --git a/layout/base/nsPresShell.cpp b/layout/base/nsPresShell.cpp\\nindex 9ab6fad..e8b3742 100644\\n--- a/layout/base/nsPresShell.cpp\\n+++ b/layout/base/nsPresShell.cpp\\n@@ -4414,14 +4414,34 @@ PresShell::DoFlushPendingNotifications(mozFlushType aType,\\n     // construct frames for content right now that's still waiting to be\\n     // notified on,\\n     mDocument->FlushPendingNotifications(Flush_ContentAndNotify);\\n+\\n+    // Process pending restyles, since any flush of the presshell wants\\n+    // up-to-date style data.\\n     if (!mIsDestroying) {\\n       mFrameConstructor->ProcessPendingRestyles();\\n     }\\n \\n+    // Process whatever XBL constructors those restyles queued up.  This\\n+    // ensures that onload doesn't fire too early and that we won't do extra\\n+    // reflows after those constructors run.\\n     if (!mIsDestroying) {\\n       mDocument->BindingManager()->ProcessAttachedQueue();\\n     }\\n \\n+    // Now those constructors might have posted restyle events.  At the same\\n+    // time, we still need up-to-date style data.  In particular, reflow\\n+    // depends on style being completely up to date.  If it's not, then style\\n+    // context reparenting, which can happen during reflow, might suddenly pick\\n+    // up the new rules and we'll end up with frames whose style doesn't match\\n+    // the frame type.\\n+    if (!mIsDestroying) {\\n+      mFrameConstructor->ProcessPendingRestyles();\\n+    }\\n+\\n+    // There might be more pending constructors now, but we're not going to\\n+    // worry about them.  They can't be triggered during reflow, so we should\\n+    // be good.\\n+    \\n     if (aType >= Flush_Layout && !mIsDestroying) {\\n       mFrameConstructor->RecalcQuotesAndCounters();\\n       ProcessReflowCommands(aInterruptibleReflow);\\ndiff --git a/layout/reftests/bugs/396286-1.html b/layout/reftests/bugs/396286-1.html\\nnew file mode 100644\\nindex 0000000..2a5a7a1\\n--- /dev/null\\n+++ b/layout/reftests/bugs/396286-1.html\\n@@ -0,0 +1,12 @@\\n+<html><head>\\n+<style id=\\\"script\\\">#a::first-line {}</style>\\n+</head>\\n+<body>\\n+<span id=\\\"a\\\" style=\\\"-moz-binding: url(data:text/xml;charset=utf-8,%3Cbindings%20xmlns%3D%22http%3A//www.mozilla.org/xbl%22%3E%0A%3Cbinding%20id%3D%22a%22%3E%0A%3Cimplementation%3E%0A%3Cconstructor%3E%0A%20%20this.style.position%3D%27fixed%27%3B%0A%3C/constructor%3E%0A%3C/implementation%3E%0A%3Ccontent%3E%0A%3Cchildren/%3E%0A%3C/content%3E%0A%3C/binding%3E%0A%3C/bindings%3E);\\\">\\n+  <br>\\n+  <span style=\\\"-moz-binding: url(data:text/xml;charset=utf-8,%3Cbindings%20xmlns%3D%22http%3A//www.mozilla.org/xbl%22%3E%0A%3Cbinding%20id%3D%22a%22%3E%0A%3Ccontent%3E%0A%3Cchildren/%3E%0A%3C/content%3E%0A%3C/binding%3E%0A%3C/bindings%3E);\\\">\\n+    <span style=\\\"position: absolute;-moz-binding: url(data:text/xml;charset=utf-8,%3Cbindings%20xmlns%3D%22http%3A//www.mozilla.org/xbl%22%3E%0A%3Cbinding%20id%3D%22a%22%3E%0A%3Cimplementation%3E%0A%3Cconstructor%3E%0A%20%20this.style.position%3D%27fixed%27%3B%0A%3C/constructor%3E%0A%3C/implementation%3E%0A%3Ccontent%3E%0A%3Cchildren/%3E%0A%3C/content%3E%0A%3C/binding%3E%0A%3C/bindings%3E);\\\"></span>\\n+  </span>\\n+</span>\\n+</body>\\n+</html>\\ndiff --git a/layout/reftests/bugs/reftest.list b/layout/reftests/bugs/reftest.list\\nindex 85471b8..9426b2e 100644\\n--- a/layout/reftests/bugs/reftest.list\\n+++ b/layout/reftests/bugs/reftest.list\\n@@ -379,3 +379,4 @@ random-if(MOZ_WIDGET_TOOLKIT==\\\"cocoa\\\") == 379316-2.html 379316-2-ref.html # bug\\n == 394111-1.html about:blank  # Really an assertion test rather than a rendering test\\n == 394534-1.html 394534-1-ref.html\\n == 394676-1.xhtml 394676-1-ref.xhtml\\n+== 396286-1.html about:blank  # crash test\\n\""}