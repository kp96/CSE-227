{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas4a0892e\""},"diff":"\"4a0892e Make auto-height abs-pos textfields with top and bottom offsets both set use their intrinsic height, per spec.  Bug 385870, r+sr+a=dbaron\\ndiff --git a/layout/forms/nsTextControlFrame.cpp b/layout/forms/nsTextControlFrame.cpp\\nindex 16cc4ab..1b3b62a 100644\\n--- a/layout/forms/nsTextControlFrame.cpp\\n+++ b/layout/forms/nsTextControlFrame.cpp\\n@@ -1719,6 +1719,35 @@ nsTextControlFrame::GetMinWidth(nsIRenderingContext* aRenderingContext)\\n   return result;\\n }\\n \\n+nsSize\\n+nsTextControlFrame::ComputeAutoSize(nsIRenderingContext *aRenderingContext,\\n+                                    nsSize aCBSize, nscoord aAvailableWidth,\\n+                                    nsSize aMargin, nsSize aBorder,\\n+                                    nsSize aPadding, PRBool aShrinkWrap)\\n+{\\n+  nsSize autoSize;\\n+  nsresult rv = CalcIntrinsicSize(aRenderingContext, autoSize);\\n+  if (NS_FAILED(rv)) {\\n+    // What now?\\n+    autoSize.SizeTo(0, 0);\\n+  }\\n+#ifdef DEBUG\\n+  // Note: Ancestor ComputeAutoSize only computes a width if we're auto-width\\n+  else if (GetStylePosition()->mWidth.GetUnit() == eStyleUnit_Auto) {\\n+    nsSize ancestorAutoSize =\\n+      nsStackFrame::ComputeAutoSize(aRenderingContext,\\n+                                    aCBSize, aAvailableWidth,\\n+                                    aMargin, aBorder,\\n+                                    aPadding, aShrinkWrap);\\n+    NS_ASSERTION(ancestorAutoSize.width == autoSize.width,\\n+                 \\\"Incorrect size computed by ComputeAutoSize?\\\");\\n+  }\\n+#endif\\n+  \\n+  return autoSize;\\n+}\\n+\\n+\\n // We inherit our GetPrefWidth from nsBoxFrame\\n \\n NS_IMETHODIMP\\ndiff --git a/layout/forms/nsTextControlFrame.h b/layout/forms/nsTextControlFrame.h\\nindex b466a38..11cbf11 100644\\n--- a/layout/forms/nsTextControlFrame.h\\n+++ b/layout/forms/nsTextControlFrame.h\\n@@ -79,6 +79,10 @@ public:\\n   virtual void Destroy();\\n \\n   virtual nscoord GetMinWidth(nsIRenderingContext* aRenderingContext);\\n+  virtual nsSize ComputeAutoSize(nsIRenderingContext *aRenderingContext,\\n+                                 nsSize aCBSize, nscoord aAvailableWidth,\\n+                                 nsSize aMargin, nsSize aBorder,\\n+                                 nsSize aPadding, PRBool aShrinkWrap);\\n \\n   NS_IMETHOD Reflow(nsPresContext*          aPresContext,\\n                     nsHTMLReflowMetrics&     aDesiredSize,\\ndiff --git a/layout/reftests/bugs/385870-1-ref.html b/layout/reftests/bugs/385870-1-ref.html\\nnew file mode 100644\\nindex 0000000..fcebd34\\n--- /dev/null\\n+++ b/layout/reftests/bugs/385870-1-ref.html\\n@@ -0,0 +1,51 @@\\n+<!DOCTYPE html>\\n+<html>\\n+<head>\\n+<title></title>\\n+<style>\\n+#red {\\n+  position: absolute;\\n+  background-color: blue;\\n+  top: 10px;\\n+  left: 10px;\\n+}\\n+\\n+#green {\\n+  position: absolute;\\n+  background-color: blue;\\n+  top: 10px;\\n+  width: 80px;\\n+  right: 10px;\\n+}\\n+\\n+#blue {\\n+  position: absolute;\\n+  background-color: blue;\\n+  left: 10px;\\n+  height: 80px;\\n+  bottom: 10px;\\n+}\\n+\\n+#yellow {\\n+  position: absolute;\\n+  background-color: blue;\\n+  right: 10px;\\n+  width: 80px;\\n+  height: 80px;\\n+  bottom: 10px;\\n+}\\n+\\n+</style>\\n+<script>\\n+\\n+</script>\\n+</head>\\n+<body>\\n+\\n+<textarea id=red></textarea>\\n+<textarea id=green></textarea>\\n+<textarea id=blue></textarea>\\n+<textarea id=yellow></textarea>\\n+\\n+</body>\\n+</html>\\ndiff --git a/layout/reftests/bugs/385870-1.html b/layout/reftests/bugs/385870-1.html\\nnew file mode 100644\\nindex 0000000..4d292e1\\n--- /dev/null\\n+++ b/layout/reftests/bugs/385870-1.html\\n@@ -0,0 +1,55 @@\\n+<!DOCTYPE html>\\n+<html>\\n+<head>\\n+<title></title>\\n+<style>\\n+#red {\\n+  position: absolute;\\n+  background-color: blue;\\n+  top: 10px;\\n+  left: 10px;\\n+  right: 100px;\\n+  bottom: 100px;\\n+}\\n+\\n+#green {\\n+  position: absolute;\\n+  background-color: blue;\\n+  top: 10px;\\n+  width: 80px;\\n+  right: 10px;\\n+  bottom: 100px;\\n+}\\n+\\n+#blue {\\n+  position: absolute;\\n+  background-color: blue;\\n+  left: 10px;\\n+  height: 80px;\\n+  right: 100px;\\n+  bottom: 10px;\\n+}\\n+\\n+#yellow {\\n+  position: absolute;\\n+  background-color: blue;\\n+  right: 10px;\\n+  width: 80px;\\n+  height: 80px;\\n+  bottom: 10px;\\n+}\\n+\\n+</style>\\n+<script>\\n+\\n+</script>\\n+</head>\\n+<body>\\n+\\n+<textarea id=red></textarea>\\n+<textarea id=green></textarea>\\n+<textarea id=blue></textarea>\\n+<textarea id=yellow></textarea>\\n+\\n+</body>\\n+</html>\\ndiff --git a/layout/reftests/bugs/385870-2-ref.html b/layout/reftests/bugs/385870-2-ref.html\\nnew file mode 100644\\nindex 0000000..eebef38\\n--- /dev/null\\n+++ b/layout/reftests/bugs/385870-2-ref.html\\n@@ -0,0 +1,51 @@\\n+<!DOCTYPE html>\\n+<html>\\n+<head>\\n+<title></title>\\n+<style>\\n+#red {\\n+  position: absolute;\\n+  background-color: blue;\\n+  top: 10px;\\n+  left: 10px;\\n+}\\n+\\n+#green {\\n+  position: absolute;\\n+  background-color: blue;\\n+  top: 10px;\\n+  width: 80px;\\n+  right: 10px;\\n+}\\n+\\n+#blue {\\n+  position: absolute;\\n+  background-color: blue;\\n+  left: 10px;\\n+  height: 80px;\\n+  bottom: 10px;\\n+}\\n+\\n+#yellow {\\n+  position: absolute;\\n+  background-color: blue;\\n+  right: 10px;\\n+  width: 80px;\\n+  height: 80px;\\n+  bottom: 10px;\\n+}\\n+\\n+</style>\\n+<script>\\n+\\n+</script>\\n+</head>\\n+<body>\\n+\\n+<input id=red>\\n+<input id=green>\\n+<input id=blue>\\n+<input id=yellow>\\n+\\n+</body>\\n+</html>\\ndiff --git a/layout/reftests/bugs/385870-2.html b/layout/reftests/bugs/385870-2.html\\nnew file mode 100644\\nindex 0000000..c641abb\\n--- /dev/null\\n+++ b/layout/reftests/bugs/385870-2.html\\n@@ -0,0 +1,55 @@\\n+<!DOCTYPE html>\\n+<html>\\n+<head>\\n+<title></title>\\n+<style>\\n+#red {\\n+  position: absolute;\\n+  background-color: blue;\\n+  top: 10px;\\n+  left: 10px;\\n+  right: 100px;\\n+  bottom: 100px;\\n+}\\n+\\n+#green {\\n+  position: absolute;\\n+  background-color: blue;\\n+  top: 10px;\\n+  width: 80px;\\n+  right: 10px;\\n+  bottom: 100px;\\n+}\\n+\\n+#blue {\\n+  position: absolute;\\n+  background-color: blue;\\n+  left: 10px;\\n+  height: 80px;\\n+  right: 100px;\\n+  bottom: 10px;\\n+}\\n+\\n+#yellow {\\n+  position: absolute;\\n+  background-color: blue;\\n+  right: 10px;\\n+  width: 80px;\\n+  height: 80px;\\n+  bottom: 10px;\\n+}\\n+\\n+</style>\\n+<script>\\n+\\n+</script>\\n+</head>\\n+<body>\\n+\\n+<input id=red>\\n+<input id=green>\\n+<input id=blue>\\n+<input id=yellow>\\n+\\n+</body>\\n+</html>\\ndiff --git a/layout/reftests/bugs/reftest.list b/layout/reftests/bugs/reftest.list\\nindex b57a5b0..ecc6bfa 100644\\n--- a/layout/reftests/bugs/reftest.list\\n+++ b/layout/reftests/bugs/reftest.list\\n@@ -341,6 +341,8 @@ random-if(MOZ_WIDGET_TOOLKIT==\\\"cocoa\\\") == 379316-2.html 379316-2-ref.html # bug\\n == 384576-1.html 384576-1-ref.html\\n == 384762-1.html about:blank\\n == 384876-1.html 384876-1-ref.html\\n+== 385870-1.html 385870-1-ref.html\\n+== 385870-2.html 385870-2-ref.html\\n == 386014-1a.html 386014-1-ref.html\\n == 386014-1b.html 386014-1-ref.html\\n == 386014-1c.html 386014-1-ref.html\\n\""}