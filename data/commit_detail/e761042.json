{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Base761042\""},"diff":"\"e761042 Bug 392780 - \\\"nsNSSCertificateDB::FindCertByDBKey() crashes on invalid input\\\" [p=mozbugzilla@velox.ch (Kaspar Brand) r=rrelyea sr=kaie a1.9=bzbarsky]\\ndiff --git a/security/manager/ssl/src/nsNSSCertificateDB.cpp b/security/manager/ssl/src/nsNSSCertificateDB.cpp\\nindex 3990567..364188c 100644\\n--- a/security/manager/ssl/src/nsNSSCertificateDB.cpp\\n+++ b/security/manager/ssl/src/nsNSSCertificateDB.cpp\\n@@ -143,12 +143,14 @@ nsNSSCertificateDB::FindCertByDBKey(const char *aDBkey, nsISupports *aToken,\\n   unsigned long moduleID,slotID;\\n   *_cert = nsnull; \\n   if (!aDBkey || !*aDBkey)\\n-    return NS_ERROR_FAILURE;\\n+    return NS_ERROR_INVALID_ARG;\\n \\n   dummy = NSSBase64_DecodeBuffer(nsnull, &keyItem, aDBkey,\\n                                  (PRUint32)PL_strlen(aDBkey)); \\n-  if (!dummy)\\n-    return NS_ERROR_FAILURE;\\n+  if (!dummy || keyItem.len < NS_NSS_LONG*4) {\\n+    PR_FREEIF(keyItem.data);\\n+    return NS_ERROR_INVALID_ARG;\\n+  }\\n \\n   CERTCertificate *cert;\\n   // someday maybe we can speed up the search using the moduleID and slotID\\n@@ -158,6 +160,12 @@ nsNSSCertificateDB::FindCertByDBKey(const char *aDBkey, nsISupports *aToken,\\n   // build the issuer/SN structure\\n   issuerSN.serialNumber.len = NS_NSS_GET_LONG(&keyItem.data[NS_NSS_LONG*2]);\\n   issuerSN.derIssuer.len = NS_NSS_GET_LONG(&keyItem.data[NS_NSS_LONG*3]);\\n+  if (issuerSN.serialNumber.len == 0 || issuerSN.derIssuer.len == 0\\n+      || issuerSN.serialNumber.len + issuerSN.derIssuer.len\\n+         != keyItem.len - NS_NSS_LONG*4) {\\n+    PR_FREEIF(keyItem.data);\\n+    return NS_ERROR_INVALID_ARG;\\n+  }\\n   issuerSN.serialNumber.data= &keyItem.data[NS_NSS_LONG*4];\\n   issuerSN.derIssuer.data= &keyItem.data[NS_NSS_LONG*4+\\n                                               issuerSN.serialNumber.len];\\n\""}