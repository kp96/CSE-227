{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas4711491\""},"diff":"\"4711491 Bug 393342: read the download.dir pref as a nsILocalFile instead of just a file path (fixes automatic downloads on Mac), patch by Jim Mathies <jmathies@mozilla.com>, r=me\\ndiff --git a/browser/components/preferences/main.js b/browser/components/preferences/main.js\\nindex 273c84bd..7ba6e91 100644\\n--- a/browser/components/preferences/main.js\\n+++ b/browser/components/preferences/main.js\\n@@ -180,11 +180,11 @@ var gMainPane = {\\n    * browser.download.useDownloadDir - bool\\n    *   True if downloads are saved with no save-as UI shown, false if\\n    *   the user should always be asked where to save a file.\\n-   * browser.download.dir - str path\\n-   *   A local path the user may have selected for downloaded files to be\\n+   * browser.download.dir - local file handle\\n+   *   A local folder the user may have selected for downloaded files to be\\n    *   saved. Migration of other browser settings may also set this path.\\n-   *   This path is enabled when folderList is equals 2.\\n-   * browser.download.lastDir - str path\\n+   *   This folder is enabled when folderList equals 2.\\n+   * browser.download.lastDir - local file handle\\n    *   May contain the last folder path accessed when the user browsed\\n    *   via the file save-as dialog. (see contentAreaUtils.js)\\n    * browser.download.folderList - int\\ndiff --git a/toolkit/components/downloads/src/nsDownloadManager.cpp b/toolkit/components/downloads/src/nsDownloadManager.cpp\\nindex 5c9bbf8..ae96135 100644\\n--- a/toolkit/components/downloads/src/nsDownloadManager.cpp\\n+++ b/toolkit/components/downloads/src/nsDownloadManager.cpp\\n@@ -842,29 +842,20 @@ nsDownloadManager::GetUserDownloadsDirectory(nsILocalFile **aResult)\\n       break;\\n     case 2: // Custom\\n       {\\n-        nsCOMPtr<nsISupportsString> customDirectory;\\n+        nsCOMPtr<nsILocalFile> customDirectory;\\n         prefBranch->GetComplexValue(NS_PREF_DIR, \\n-                                    NS_GET_IID(nsISupportsString),\\n+                                    NS_GET_IID(nsILocalFile),\\n                                     getter_AddRefs(customDirectory));\\n         if (customDirectory) {\\n-          nsCOMPtr<nsILocalFile> aFile = \\n-            do_CreateInstance(\\\"@mozilla.org/file/local;1\\\", &rv);\\n-          NS_ENSURE_SUCCESS(rv, rv);\\n-          nsAutoString dir;\\n-          customDirectory->GetData(dir);\\n-          rv = aFile->InitWithNativePath(NS_ConvertUTF16toUTF8(dir));\\n-          NS_ENSURE_SUCCESS(rv, rv);\\n-          aFile->Exists(&bRes);\\n+          customDirectory->Exists(&bRes);\\n           if (bRes) {\\n-            NS_ADDREF(*aResult = aFile);\\n+            NS_ADDREF(*aResult = customDirectory);\\n             return NS_OK;\\n           }\\n-          rv = aFile->Create(nsIFile::DIRECTORY_TYPE, 755);\\n+          rv = customDirectory->Create(nsIFile::DIRECTORY_TYPE, 755);\\n           NS_ENSURE_SUCCESS(rv, rv);\\n-          if (bRes) {\\n-            NS_ADDREF(*aResult = aFile);\\n-            return NS_OK;\\n-          }\\n+          NS_ADDREF(*aResult = customDirectory);\\n+          return NS_OK;\\n         }\\n         rv = GetDefaultDownloadsDirectory(aResult); // refup\\n         NS_ENSURE_SUCCESS(rv, rv);\\n\""}