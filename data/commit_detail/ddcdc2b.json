{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basddcdc2b\""},"diff":"\"ddcdc2b Make maxlength not affect initial values or scripted sets.  Bug 345267, r+sr=mats, a=dbaron\\ndiff --git a/layout/forms/Makefile.in b/layout/forms/Makefile.in\\nindex 38ae2f5..09a601c 100644\\n--- a/layout/forms/Makefile.in\\n+++ b/layout/forms/Makefile.in\\n@@ -42,6 +42,12 @@ VPATH\\t\\t= @srcdir@\\n \\n include $(DEPTH)/config/autoconf.mk\\n \\n+DIRS = $(NULL)\\n+\\n+ifdef MOZ_MOCHITEST\\n+DIRS\\t\\t+= test\\n+endif\\n+\\n MODULE\\t\\t= layout\\n LIBRARY_NAME\\t= gkforms_s\\n LIBXUL_LIBRARY\\t= 1\\ndiff --git a/layout/forms/nsTextControlFrame.cpp b/layout/forms/nsTextControlFrame.cpp\\nindex 1b3b62a..1cb7c88 100644\\n--- a/layout/forms/nsTextControlFrame.cpp\\n+++ b/layout/forms/nsTextControlFrame.cpp\\n@@ -2696,14 +2696,19 @@ nsTextControlFrame::SetValue(const nsAString& aValue)\\n       flags &= ~(nsIPlaintextEditor::eEditorReadonlyMask);\\n       editor->SetFlags(flags);\\n \\n+      // Also don't enforce max-length here\\n+      PRInt32 savedMaxLength;\\n+      plaintextEditor->GetMaxTextLength(&savedMaxLength);\\n+      plaintextEditor->SetMaxTextLength(-1);\\n+\\n       if (currentValue.Length() < 1)\\n         editor->DeleteSelection(nsIEditor::eNone);\\n       else {\\n-        nsCOMPtr<nsIPlaintextEditor> textEditor = do_QueryInterface(editor);\\n-        if (textEditor)\\n-          textEditor->InsertText(currentValue);\\n+        if (plaintextEditor)\\n+          plaintextEditor->InsertText(currentValue);\\n       }\\n \\n+      plaintextEditor->SetMaxTextLength(savedMaxLength);\\n       editor->SetFlags(savedFlags);\\n       if (selPriv)\\n         selPriv->EndBatchChanges();\\ndiff --git a/layout/forms/test/Makefile.in b/layout/forms/test/Makefile.in\\nnew file mode 100644\\nindex 0000000..5fef22c\\n--- /dev/null\\n+++ b/layout/forms/test/Makefile.in\\n@@ -0,0 +1,51 @@\\n+#\\n+# ***** BEGIN LICENSE BLOCK *****\\n+# Version: MPL 1.1/GPL 2.0/LGPL 2.1\\n+#\\n+# The contents of this file are subject to the Mozilla Public License Version\\n+# 1.1 (the \\\"License\\\"); you may not use this file except in compliance with\\n+# the License. You may obtain a copy of the License at\\n+# http://www.mozilla.org/MPL/\\n+#\\n+# Software distributed under the License is distributed on an \\\"AS IS\\\" basis,\\n+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\\n+# for the specific language governing rights and limitations under the\\n+# License.\\n+#\\n+# The Original Code is mozilla.org code.\\n+#\\n+# The Initial Developer of the Original Code is\\n+# Mozilla Foundation.\\n+# Portions created by the Initial Developer are Copyright (C) 2007\\n+# the Initial Developer. All Rights Reserved.\\n+#\\n+# Contributor(s):\\n+#\\n+# Alternatively, the contents of this file may be used under the terms of\\n+# either of the GNU General Public License Version 2 or later (the \\\"GPL\\\"),\\n+# or the GNU Lesser General Public License Version 2.1 or later (the \\\"LGPL\\\"),\\n+# in which case the provisions of the GPL or the LGPL are applicable instead\\n+# of those above. If you wish to allow use of your version of this file only\\n+# under the terms of either the GPL or the LGPL, and not to allow others to\\n+# use your version of this file under the terms of the MPL, indicate your\\n+# decision by deleting the provisions above and replace them with the notice\\n+# and other provisions required by the GPL or the LGPL. If you do not delete\\n+# the provisions above, a recipient may use your version of this file under\\n+# the terms of any one of the MPL, the GPL or the LGPL.\\n+#\\n+# ***** END LICENSE BLOCK *****\\n+\\n+DEPTH\\t\\t= ../../..\\n+topsrcdir\\t= @top_srcdir@\\n+srcdir\\t\\t= @srcdir@\\n+VPATH\\t\\t= @srcdir@\\n+relativesrcdir  = layout/forms/test\\n+\\n+include $(DEPTH)/config/autoconf.mk\\n+include $(topsrcdir)/config/rules.mk\\n+\\n+_TEST_FILES =\\ttest_bug345267.html \\\\\\n+\\t\\t$(NULL)\\n+\\n+libs:: $(_TEST_FILES)\\n+\\t$(INSTALL) $^ $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)\\ndiff --git a/layout/forms/test/test_bug345267.html b/layout/forms/test/test_bug345267.html\\nnew file mode 100644\\nindex 0000000..0e97d93\\n--- /dev/null\\n+++ b/layout/forms/test/test_bug345267.html\\n@@ -0,0 +1,93 @@\\n+<!DOCTYPE HTML>\\n+<html>\\n+<!--\\n+https://bugzilla.mozilla.org/show_bug.cgi?id=345267\\n+-->\\n+<head>\\n+  <title>Test for Bug 345267</title>\\n+  <script type=\\\"text/javascript\\\" src=\\\"/MochiKit/MochiKit.js\\\"></script>\\n+  <script type=\\\"text/javascript\\\" src=\\\"/tests/SimpleTest/SimpleTest.js\\\"></script>\\n+  <script type=\\\"text/javascript\\\" src=\\\"/tests/SimpleTest/EventUtils.js\\\"></script>\\n+  <link rel=\\\"stylesheet\\\" type=\\\"text/css\\\" href=\\\"/tests/SimpleTest/test.css\\\" />\\n+</head>\\n+<body>\\n+<a target=\\\"_blank\\\" href=\\\"https://bugzilla.mozilla.org/show_bug.cgi?id=345267\\\">Mozilla Bug 345267</a>\\n+<p id=\\\"display\\\">\\n+ <input id=\\\"d1\\\" maxlength=\\\"3\\\" value=\\\"abcde\\\">\\n+ <input id=\\\"d2\\\" maxlength=\\\"3\\\">\\n+ <input id=\\\"d3\\\" maxlength=\\\"3\\\">\\n+ <input id=\\\"d4\\\" value=\\\"abcdefghijk\\\">\\n+ <input id=\\\"target\\\" value=\\\"abcdefghijklm\\\" maxlength=\\\"3\\\">\\n+</p>\\n+<div id=\\\"content\\\" style=\\\"display: none\\\">\\n+ <input id=\\\"u1\\\" maxlength=\\\"3\\\" value=\\\"abcdef\\\">\\n+ <input id=\\\"u2\\\" maxlength=\\\"3\\\">\\n+ <input id=\\\"u3\\\" maxlength=\\\"3\\\">\\n+ <input id=\\\"u4\\\" value=\\\"abcdefghijkl\\\">\\n+</div>\\n+<pre id=\\\"test\\\">\\n+<script class=\\\"testbody\\\" type=\\\"text/javascript\\\">\\n+\\n+/** Test for Bug 345267 **/\\n+is($(\\\"d1\\\").value, \\\"abcde\\\",\\n+   \\\"Displayed initial value should not be truncated by maxlength\\\");\\n+is($(\\\"u1\\\").value, \\\"abcdef\\\",\\n+   \\\"Undisplayed initial value should not be truncated by maxlength\\\");\\n+\\n+$(\\\"d2\\\").value = \\\"abcdefg\\\";\\n+is($(\\\"d2\\\").value, \\\"abcdefg\\\",\\n+   \\\"Displayed set value should not be truncated by maxlength\\\");\\n+\\n+$(\\\"u2\\\").value = \\\"abcdefgh\\\";\\n+is($(\\\"u2\\\").value, \\\"abcdefgh\\\",\\n+   \\\"Undisplayed set value should not be truncated by maxlength\\\");\\n+\\n+$(\\\"d3\\\").defaultValue = \\\"abcdefghi\\\";\\n+is($(\\\"d3\\\").value, \\\"abcdefghi\\\",\\n+   \\\"Displayed set defaultValue should not be truncated by maxlength\\\");\\n+\\n+$(\\\"u3\\\").defaultValue = \\\"abcdefghij\\\";\\n+is($(\\\"u3\\\").value, \\\"abcdefghij\\\",\\n+   \\\"Undisplayed set defaultValue should not be truncated by maxlength\\\");\\n+\\n+$(\\\"d4\\\").maxLength = \\\"3\\\";\\n+is($(\\\"d4\\\").value, \\\"abcdefghijk\\\",\\n+   \\\"Displayed: setting maxLength should not truncate existing value\\\");\\n+\\n+$(\\\"u4\\\").maxLength = \\\"3\\\";\\n+is($(\\\"u4\\\").value, \\\"abcdefghijkl\\\",\\n+   \\\"Undisplayed: setting maxLength should not truncate existing value\\\");\\n+\\n+// Now start the editing tests\\n+is($(\\\"target\\\").value, \\\"abcdefghijklm\\\", \\\"Test starting state incorrect\\\");\\n+$(\\\"target\\\").focus();\\n+sendKey(\\\"back_space\\\");\\n+is($(\\\"target\\\").value, \\\"abcdefghijkl\\\", \\\"Should only delete one char\\\");\\n+sendKey(\\\"back_space\\\");\\n+is($(\\\"target\\\").value, \\\"abcdefghijk\\\", \\\"Should only delete one char again\\\");\\n+(function () {\\n+  netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');\\n+  $(\\\"target\\\").controllers.getControllerForCommand('cmd_undo')\\n+                         .doCommand('cmd_undo');\\n+})();\\n+is($(\\\"target\\\").value, \\\"abcdefghijklm\\\",\\n+   \\\"Should be able to undo deletion in the face of maxlength\\\");\\n+sendString(\\\"nopq\\\");\\n+is($(\\\"target\\\").value, \\\"abcdefghijklm\\\",\\n+   \\\"Typing should have no effect when already past maxlength\\\");\\n+\\n+$(\\\"target\\\").value = \\\"\\\";\\n+sendString(\\\"abcde\\\");\\n+is($(\\\"target\\\").value, \\\"abc\\\", \\\"Typing should be limited by maxlength\\\");\\n+\\n+$(\\\"target\\\").value = \\\"\\\";\\n+sendString(\\\"ad\\\");\\n+sendKey(\\\"left\\\");\\n+sendString(\\\"bc\\\")\\n+is($(\\\"target\\\").value, \\\"abd\\\", \\\"Typing should be limited by maxlength again\\\");\\n+\\n+</script>\\n+</pre>\\n+</body>\\n+</html>\\n+\\ndiff --git a/layout/reftests/bugs/345267-1-ref.html b/layout/reftests/bugs/345267-1-ref.html\\nnew file mode 100644\\nindex 0000000..9bb4765\\n--- /dev/null\\n+++ b/layout/reftests/bugs/345267-1-ref.html\\n@@ -0,0 +1,6 @@\\n+<!DOCTYPE html>\\n+<html>\\n+<body>\\n+  <input size=\\\"20\\\" value=\\\"abcde\\\">\\n+</body>\\n+</html>\\ndiff --git a/layout/reftests/bugs/345267-1a.html b/layout/reftests/bugs/345267-1a.html\\nnew file mode 100644\\nindex 0000000..feace49\\n--- /dev/null\\n+++ b/layout/reftests/bugs/345267-1a.html\\n@@ -0,0 +1,6 @@\\n+<!DOCTYPE html>\\n+<html>\\n+<body>\\n+  <input size=\\\"20\\\" maxlength=\\\"2\\\" value=\\\"abcde\\\">\\n+</body>\\n+</html>\\ndiff --git a/layout/reftests/bugs/345267-1b.html b/layout/reftests/bugs/345267-1b.html\\nnew file mode 100644\\nindex 0000000..60726b6\\n--- /dev/null\\n+++ b/layout/reftests/bugs/345267-1b.html\\n@@ -0,0 +1,10 @@\\n+<!DOCTYPE html>\\n+<html>\\n+<body>\\n+  <input size=\\\"20\\\" maxlength=\\\"2\\\">\\n+  <script>\\n+    document.body.offsetWidth;\\n+    document.getElementsByTagName(\\\"input\\\")[0].value = \\\"abcde\\\";\\n+  </script>\\n+</body>\\n+</html>\\ndiff --git a/layout/reftests/bugs/345267-1c.html b/layout/reftests/bugs/345267-1c.html\\nnew file mode 100644\\nindex 0000000..1e78bec\\n--- /dev/null\\n+++ b/layout/reftests/bugs/345267-1c.html\\n@@ -0,0 +1,10 @@\\n+<!DOCTYPE html>\\n+<html>\\n+<body>\\n+  <input size=\\\"20\\\" value=\\\"abcde\\\">\\n+  <script>\\n+    document.body.offsetWidth;\\n+    document.getElementsByTagName(\\\"input\\\")[0].maxLength = \\\"2\\\";\\n+  </script>\\n+</body>\\n+</html>\\ndiff --git a/layout/reftests/bugs/345267-1d.html b/layout/reftests/bugs/345267-1d.html\\nnew file mode 100644\\nindex 0000000..d912035\\n--- /dev/null\\n+++ b/layout/reftests/bugs/345267-1d.html\\n@@ -0,0 +1,10 @@\\n+<!DOCTYPE html>\\n+<html>\\n+<body>\\n+  <input size=\\\"20\\\" maxlength=\\\"2\\\">\\n+  <script>\\n+    document.body.offsetWidth;\\n+    document.getElementsByTagName(\\\"input\\\")[0].setAttribute(\\\"value\\\", \\\"abcde\\\");\\n+  </script>\\n+</body>\\n+</html>\\ndiff --git a/layout/reftests/bugs/reftest.list b/layout/reftests/bugs/reftest.list\\nindex ecc6bfa..d674c20 100644\\n--- a/layout/reftests/bugs/reftest.list\\n+++ b/layout/reftests/bugs/reftest.list\\n@@ -146,6 +146,10 @@ fails-if(MOZ_WIDGET_TOOLKIT==\\\"cocoa\\\") == 336736-1.html 336736-1-ref.html # somet\\n == 339289-1.html 339289-1-ref.html\\n == 341043-1a.html 341043-1-ref.html\\n != 341043-1b.html 341043-1-ref.html\\n+== 345267-1a.html 345267-1-ref.html\\n+== 345267-1b.html 345267-1-ref.html\\n+== 345267-1c.html 345267-1-ref.html\\n+== 345267-1d.html 345267-1-ref.html\\n == 346774-1a.html 346774-1-ref.html\\n == 346774-1b.html 346774-1-ref.html\\n == 346774-1c.html 346774-1-ref.html\\n\""}