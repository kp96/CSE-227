{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas33ffa17\""},"diff":"\"33ffa17 Bug 397225 - Feed preview is borken. r=gavin.\\ndiff --git a/toolkit/content/widgets/menulist.xml b/toolkit/content/widgets/menulist.xml\\nindex a11c247..5fd8a8f 100644\\n--- a/toolkit/content/widgets/menulist.xml\\n+++ b/toolkit/content/widgets/menulist.xml\\n@@ -47,7 +47,7 @@\\n       </handler>\\n     </handlers>\\n \\n-    <implementation implements=\\\"nsIDOMXULMenuListElement, nsIAccessibleProvider\\\">\\n+    <implementation implements=\\\"nsIDOMXULMenuListElement, nsIAccessibleProvider, nsIDOMEventListener\\\">\\n       <constructor>\\n         this.setInitialSelection()\\n       </constructor>\\n@@ -189,10 +189,14 @@\\n \\n             if (oldval) {\\n               oldval.removeAttribute('selected');\\n-              document.removeBroadcastListenerFor(oldval, this, \\\"value\\\");\\n-              document.removeBroadcastListenerFor(oldval, this, \\\"label\\\");\\n-              document.removeBroadcastListenerFor(oldval, this, \\\"image\\\");\\n-              document.removeBroadcastListenerFor(oldval, this, \\\"description\\\");\\n+              if (document instanceof Components.interfaces.nsIDOMXULDocument) {\\n+                document.removeBroadcastListenerFor(oldval, this, \\\"value\\\");\\n+                document.removeBroadcastListenerFor(oldval, this, \\\"label\\\");\\n+                document.removeBroadcastListenerFor(oldval, this, \\\"image\\\");\\n+                document.removeBroadcastListenerFor(oldval, this, \\\"description\\\");\\n+              }\\n+              else\\n+                oldval.removeEventListener(\\\"DOMAttrModified\\\", this, false);\\n             }\\n \\n             this.mSelectedInternal = val;\\n@@ -202,10 +206,16 @@\\n               this.setAttribute('image', val.getAttribute('image'));\\n               this.setAttribute('label', val.getAttribute('label'));\\n               this.setAttribute('description', val.getAttribute('description'));\\n-              document.addBroadcastListenerFor(val, this, \\\"value\\\");\\n-              document.addBroadcastListenerFor(val, this, \\\"label\\\");\\n-              document.addBroadcastListenerFor(val, this, \\\"image\\\");\\n-              document.addBroadcastListenerFor(val, this, \\\"description\\\");\\n+              // DOMAttrModified listeners slow down setAttribute calls within\\n+              // the document, see bug 395496\\n+              if (document instanceof Components.interfaces.nsIDOMXULDocument) {\\n+                document.addBroadcastListenerFor(val, this, \\\"value\\\");\\n+                document.addBroadcastListenerFor(val, this, \\\"label\\\");\\n+                document.addBroadcastListenerFor(val, this, \\\"image\\\");\\n+                document.addBroadcastListenerFor(val, this, \\\"description\\\");\\n+              }\\n+              else\\n+                val.addEventListener(\\\"DOMAttrModified\\\", this, false);\\n             }\\n             else {\\n               this.removeAttribute('value');\\n@@ -227,6 +237,25 @@\\n         </setter>\\n       </property>\\n \\n+      <method name=\\\"handleEvent\\\">\\n+        <parameter name=\\\"aEvent\\\"/>\\n+        <body>\\n+          <![CDATA[\\n+            if (aEvent.type == \\\"DOMAttrModified\\\" &&\\n+                aEvent.target == this.mSelectedInternal) {\\n+              var attrName = aEvent.attrName;\\n+              switch (attrName) {\\n+                case \\\"value\\\":\\n+                case \\\"label\\\":\\n+                case \\\"image\\\":\\n+                case \\\"description\\\":\\n+                  this.setAttribute(attrName, aEvent.newValue);\\n+              }\\n+            }\\n+          ]]>\\n+        </body>\\n+      </method>\\n+\\n       <method name=\\\"getIndexOfItem\\\">\\n         <parameter name=\\\"item\\\"/>\\n         <body>\\n@@ -345,11 +374,14 @@\\n       <destructor>\\n         <![CDATA[\\n           if (this.mSelectedInternal) {\\n-            document.removeBroadcastListenerFor(this.mSelectedInternal, this, \\\"value\\\");\\n-            document.removeBroadcastListenerFor(this.mSelectedInternal, this, \\\"label\\\");\\n-            document.removeBroadcastListenerFor(this.mSelectedInternal, this, \\\"image\\\");\\n-            document.removeBroadcastListenerFor(this.mSelectedInternal, this, \\\"description\\\");\\n-           \\n+            if (document instanceof Components.interfaces.nsIDOMXULDocument) {\\n+              document.removeBroadcastListenerFor(this.mSelectedInternal, this, \\\"value\\\");\\n+              document.removeBroadcastListenerFor(this.mSelectedInternal, this, \\\"label\\\");\\n+              document.removeBroadcastListenerFor(this.mSelectedInternal, this, \\\"image\\\");\\n+              document.removeBroadcastListenerFor(this.mSelectedInternal, this, \\\"description\\\");\\n+            }\\n+            else\\n+              this.mSelectedInternal.removeEventListener(\\\"DOMAttrModified\\\", this, false);\\n           }\\n         ]]>\\n       </destructor>\\n\""}