{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas998d616\""},"diff":"\"998d616 Fixing the remaining part of bug 285438 for Firefox. Do the appropriate security checks when drag n' dropping into Firefox. r=ben@bengoodger.com, sr=dveditz@cruzio.com\\ndiff --git a/browser/base/content/tabbrowser.xml b/browser/base/content/tabbrowser.xml\\nindex e714468..f645afb 100644\\n--- a/browser/base/content/tabbrowser.xml\\n+++ b/browser/base/content/tabbrowser.xml\\n@@ -1384,6 +1384,8 @@\\n                 /^\\\\s*(javascript|data):/.test(url))\\n               return;\\n \\n+            this.dragDropSecurityCheck(aEvent, aDragSession, url);\\n+\\n             var bgLoad = this.mPrefs.getBoolPref(\\\"browser.tabs.loadInBackground\\\");\\n \\n             var tab = null;\\n@@ -1641,6 +1643,40 @@\\n           ]]>\\n         </body>\\n       </method>\\n+\\n+      <method name=\\\"dragDropSecurityCheck\\\">\\n+        <parameter name=\\\"aEvent\\\"/>\\n+        <parameter name=\\\"aDragSession\\\"/>\\n+        <parameter name=\\\"aUrl\\\"/>\\n+        <body>\\n+          <![CDATA[\\n+            // Do a security check for drag n' drop. Make sure the\\n+            // source document can load the dragged link.\\n+            var sourceDoc = aDragSession.sourceDocument;\\n+\\n+            if (sourceDoc) {\\n+              var sourceURI = sourceDoc.documentURI;\\n+\\n+              const nsIScriptSecurityManager =\\n+                Components.interfaces.nsIScriptSecurityManager;\\n+              var secMan =\\n+                Components.classes[\\\"@mozilla.org/scriptsecuritymanager;1\\\"]\\n+                .getService(nsIScriptSecurityManager);\\n+\\n+              try {\\n+                secMan.checkLoadURIStr(sourceURI, aUrl,\\n+                                       nsIScriptSecurityManager.STANDARD);\\n+              } catch (e) {\\n+                // Stop even propagation right here.\\n+                aEvent.stopPropagation();\\n+\\n+                throw \\\"Drop of \\\" + aUrl + \\\" denied.\\\";\\n+              }\\n+            }\\n+          ]]>\\n+        </body>\\n+      </method>\\n+\\n       <field name=\\\"_keyEventHandler\\\" readonly=\\\"true\\\">\\n       <![CDATA[({\\n         tabbrowser: this,\\n\""}