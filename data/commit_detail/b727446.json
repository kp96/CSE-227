{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basb727446\""},"diff":"\"b727446 landing larry on closed tree attempting to add an http fastpath, a=roc\\ndiff --git a/browser/base/content/browser.js b/browser/base/content/browser.js\\nindex 0bb9f26..2116107 100644\\n--- a/browser/base/content/browser.js\\n+++ b/browser/base/content/browser.js\\n@@ -3679,9 +3679,8 @@ nsBrowserStatusHandler.prototype =\\n \\n     var securityUI = gBrowser.securityUI;\\n     this.securityButton.setAttribute(\\\"tooltiptext\\\", securityUI.tooltipText);\\n-    var lockIcon = document.getElementById(\\\"lock-icon\\\");\\n-    if (lockIcon)\\n-      lockIcon.setAttribute(\\\"tooltiptext\\\", securityUI.tooltipText);\\n+    \\n+    getIdentityHandler().checkIdentity(aState);\\n   },\\n \\n   // simulate all change notifications after switching tabs\\n@@ -5567,3 +5566,266 @@ function showToolbars() {\\n   \\n   return false; // Dismiss the notification message\\n }\\n+\\n+/**\\n+ * Utility class to handle manipulations of the identity indicators in the UI\\n+ */\\n+function IdentityHandler() {\\n+  this._identityPopup = document.getElementById(\\\"identity-popup\\\");\\n+  this._identityBox = document.getElementById(\\\"identity-box\\\");\\n+  this._identityPopupContentBox = document.getElementById(\\\"identity-popup-content-box\\\");\\n+  this._identityPopupTitle = document.getElementById(\\\"identity-popup-title\\\");\\n+  this._identityPopupContent = document.getElementById(\\\"identity-popup-content\\\");\\n+  this._identityPopupContentSupp = document.getElementById(\\\"identity-popup-content-supplemental\\\");\\n+  this._identityPopupContentVerif = document.getElementById(\\\"identity-popup-content-verifier\\\");\\n+  this._identityPopupEncLabel = document.getElementById(\\\"identity-popup-encryption-label\\\");\\n+  this._identityIconLabel = document.getElementById(\\\"identity-icon-label\\\");\\n+\\n+  this._stringBundle = document.getElementById(\\\"bundle_browser\\\");\\n+  this._staticStrings = {};\\n+  this._staticStrings[this.IDENTITY_MODE_DOMAIN_VERIFIED] = {\\n+    title: this._stringBundle.getString(\\\"identity.domainverified.title\\\"),\\n+    encryption_label: this._stringBundle.getString(\\\"identity.encrypted\\\")  \\n+  };\\n+  this._staticStrings[this.IDENTITY_MODE_IDENTIFIED] = {\\n+    title: this._stringBundle.getString(\\\"identity.identified.title\\\"),\\n+    encryption_label: this._stringBundle.getString(\\\"identity.encrypted\\\")\\n+  };\\n+  this._staticStrings[this.IDENTITY_MODE_UNKNOWN] = {\\n+    title: this._stringBundle.getString(\\\"identity.unknown.title\\\"),\\n+    encryption_label: this._stringBundle.getString(\\\"identity.unencrypted\\\")  \\n+  };\\n+}\\n+\\n+IdentityHandler.prototype = {\\n+\\n+  // Mode strings used to control CSS display\\n+  IDENTITY_MODE_IDENTIFIED       : \\\"verifiedIdentity\\\", // High-quality identity information\\n+  IDENTITY_MODE_DOMAIN_VERIFIED  : \\\"verifiedDomain\\\",   // Minimal SSL CA-signed domain verification\\n+  IDENTITY_MODE_UNKNOWN          : \\\"unknownIdentity\\\",  // No trusted identity information\\n+\\n+  // Cache the most recently seen SSLStatus and URI to prevent unnecessary updates\\n+  _lastStatus : null,\\n+  _lastURI : null,\\n+\\n+  /**\\n+   * Handler for mouseclicks on the \\\"Tell me more about this website\\\" link text\\n+   * in the \\\"identity-popup\\\" panel.\\n+   */\\n+  handleMoreInfoClick : function(event) {\\n+    if (event.button == 0) {\\n+      displaySecurityInfo();\\n+      event.stopPropagation();\\n+    }   \\n+  },\\n+  \\n+  /**\\n+   * Helper to parse out the important parts of _lastStatus (of the SSL cert in\\n+   * particular) for use in constructing identity UI strings\\n+  */\\n+  getIdentityData : function() {\\n+    var result = {};\\n+    var status = this._lastStatus.QueryInterface(Components.interfaces.nsISSLStatus);\\n+    var cert = status.serverCert;\\n+    \\n+    // Human readable name of Subject\\n+    result.subjectOrg = cert.organization;\\n+    \\n+    // SubjectName fields, broken up for individual access\\n+    if (cert.subjectName) {\\n+      result.subjectNameFields = {};\\n+      cert.subjectName.split(\\\",\\\").forEach(function(v) {\\n+        var field = v.split(\\\"=\\\");\\n+        this[field[0]] = field[1];\\n+      }, result.subjectNameFields);\\n+      \\n+      // Call out city, state, and country specifically\\n+      result.city = result.subjectNameFields.L;\\n+      result.state = result.subjectNameFields.ST;\\n+      result.country = result.subjectNameFields.C;\\n+    }\\n+    \\n+    // Human readable name of Certificate Authority\\n+    result.caOrg =  cert.issuerOrganization || cert.issuerCommonName;\\n+    \\n+    return result;\\n+  },\\n+  \\n+  /**\\n+   * Determine the identity of the page being displayed by examining its SSL cert\\n+   * (if available) and, if necessary, update the UI to reflect this.  Intended to\\n+   * be called by an nsIWebProgressListener.\\n+   *\\n+   * @param nsIWebProgress webProgress\\n+   * @param nsIRequest request\\n+   * @param PRUint32 state\\n+   */\\n+  checkIdentity : function(state) {\\n+    var currentURI = gBrowser.currentURI;\\n+    if (currentURI.schemeIs(\\\"http\\\")) {\\n+      if (!this._lastURI.schemeIs(\\\"http\\\"))\\n+        this.setMode(this.IDENTITY_MODE_UNKNOWN);\\n+      return;\\n+    }\\n+\\n+    var currentStatus = gBrowser.securityUI\\n+                                .QueryInterface(Components.interfaces.nsISSLStatusProvider)\\n+                                .SSLStatus;\\n+    if (currentStatus == this._lastStatus && currentURI == this._lastURI) {\\n+      // No need to update, this is a no-op check\\n+      return;\\n+    }\\n+\\n+    this._lastStatus = currentStatus;\\n+    this._lastURI = currentURI;\\n+    \\n+    if (state & Components.interfaces.nsIWebProgressListener.STATE_IDENTITY_EV_TOPLEVEL)\\n+      this.setMode(this.IDENTITY_MODE_IDENTIFIED);\\n+    else if (state & Components.interfaces.nsIWebProgressListener.STATE_SECURE_HIGH)\\n+      this.setMode(this.IDENTITY_MODE_DOMAIN_VERIFIED);\\n+    else\\n+      this.setMode(this.IDENTITY_MODE_UNKNOWN);\\n+  },\\n+  \\n+  /**\\n+   * Update the UI to reflect the specified mode, which should be one of the\\n+   * IDENTITY_MODE_* constants.\\n+   */\\n+  setMode : function(newMode) {\\n+    document.getElementById(\\\"identity-box\\\").className = newMode;\\n+    this.setIdentityMessages(newMode);\\n+    \\n+    // Update the popup too, if it's open\\n+    if (this._identityPopup.state == \\\"open\\\")\\n+      this.setPopupMessages(newMode);\\n+  },\\n+  \\n+  /**\\n+   * Set up the messages for the primary identity UI based on the specified mode,\\n+   * and the details of the SSL cert, where applicable\\n+   *\\n+   * @param newMode The newly set identity mode.  Should be one of the IDENTITY_MODE_* constants.\\n+   */\\n+  setIdentityMessages : function(newMode) {\\n+    if (newMode == this.IDENTITY_MODE_DOMAIN_VERIFIED) {\\n+      var iData = this.getIdentityData();     \\n+      \\n+      // It would be sort of nice to use the CN= field in the cert, since that's\\n+      // typically what we want here, but thanks to x509 certs being extensible,\\n+      // it's not the only place you have to check, there can be more than one domain,\\n+      // et cetera, ad nauseum.  We know the cert is valid for location.host, so\\n+      // let's just use that, it's what the status bar does too.\\n+      var icon_label = this._lastURI.host; \\n+      var tooltip = this._stringBundle.getFormattedString(\\\"identity.identified.verifier\\\",\\n+                                                          [iData.caOrg]);\\n+    }\\n+    else if (newMode == this.IDENTITY_MODE_IDENTIFIED) {\\n+      // If it's identified, then we can populate the dialog with credentials\\n+      iData = this.getIdentityData();  \\n+      tooltip = this._stringBundle.getFormattedString(\\\"identity.identified.verifier\\\",\\n+                                                      [iData.caOrg]);\\n+      if (iData.country)\\n+        icon_label = this._stringBundle.getFormattedString(\\\"identity.identified.title_with_country\\\",\\n+                                                           [iData.subjectOrg, iData.country]);\\n+      else\\n+        icon_label = iData.subjectOrg;\\n+    }\\n+    else {\\n+      tooltip = this._stringBundle.getString(\\\"identity.unknown.body\\\");\\n+      icon_label = \\\"\\\";\\n+    }\\n+    \\n+    // Push the appropriate strings out to the UI\\n+    this._identityBox.tooltipText = tooltip;\\n+    this._identityIconLabel.value = icon_label;\\n+  },\\n+  \\n+  /**\\n+   * Set up the title and content messages for the identity message popup,\\n+   * based on the specified mode, and the details of the SSL cert, where\\n+   * applicable\\n+   *\\n+   * @param newMode The newly set identity mode.  Should be one of the IDENTITY_MODE_* constants.\\n+   */\\n+  setPopupMessages : function(newMode) {\\n+      \\n+    this._identityPopup.className = newMode;\\n+    this._identityPopupContentBox.className = newMode;\\n+    \\n+    // Set the static strings up front\\n+    this._identityPopupTitle.value = this._staticStrings[newMode].title;\\n+    this._identityPopupEncLabel.textContent = this._staticStrings[newMode].encryption_label;\\n+    \\n+    // Initialize the optional strings to empty values\\n+    var supplemental = \\\"\\\";\\n+    var verifier = \\\"\\\";\\n+      \\n+    if (newMode == this.IDENTITY_MODE_DOMAIN_VERIFIED) {\\n+      var iData = this.getIdentityData();\\n+\\n+      var body = this._lastURI.host;     \\n+      verifier = this._stringBundle.getFormattedString(\\\"identity.identified.verifier\\\",\\n+                                                       [iData.caOrg]);\\n+      supplemental = this._stringBundle.getString(\\\"identity.domainverified.supplemental\\\");\\n+    }\\n+    else if (newMode == this.IDENTITY_MODE_IDENTIFIED) {\\n+      // If it's identified, then we can populate the dialog with credentials\\n+      iData = this.getIdentityData();\\n+\\n+      // Pull the basics out with fallback options in case common\\n+      // (optional) fields are left blank\\n+      body = iData.subjectOrg; \\n+      verifier = this._stringBundle.getFormattedString(\\\"identity.identified.verifier\\\",\\n+                                                       [iData.caOrg]);\\n+\\n+      // Build an appropriate supplemental block out of whatever location data we have\\n+      if (iData.city)\\n+        supplemental += iData.city + \\\"\\\\n\\\";        \\n+      if (iData.state && iData.country)\\n+        supplemental += this._stringBundle.getFormattedString(\\\"identity.identified.state_and_country\\\",\\n+                                                              [iData.state, iData.country]);\\n+      else if (iData.state) // State only\\n+        supplemental += iData.state;\\n+      else if (iData.country) // Country only\\n+        supplemental += iData.country;\\n+    }\\n+    else {\\n+      body = this._stringBundle.getString(\\\"identity.unknown.body\\\");\\n+    }\\n+    \\n+    // Push the appropriate strings out to the UI\\n+    this._identityPopupContent.textContent = body;\\n+    this._identityPopupContentSupp.textContent = supplemental;\\n+    this._identityPopupContentVerif.textContent = verifier;\\n+  },\\n+  \\n+  /**\\n+   * Click handler for the identity-box element in primary chrome.  \\n+   */\\n+  handleIdentityClick : function(event) {\\n+    if (event.button != 0)\\n+      return; // We only want left-clicks\\n+        \\n+    // Make sure that the display:none style we set in xul is removed now that\\n+    // the popup is actually needed\\n+    this._identityPopup.hidden = false;\\n+    \\n+    // Update the popup strings\\n+    this.setPopupMessages(this._identityBox.className);\\n+    \\n+    // Now open the popup, anchored off the primary chrome element\\n+    this._identityPopup.openPopup(this._identityBox, 'after_start');\\n+  }\\n+};\\n+\\n+var gIdentityHandler; \\n+\\n+/**\\n+ * Returns the singleton instance of the identity handler class.  Should always be\\n+ * used instead of referencing the global variable directly or creating new instances\\n+ */\\n+function getIdentityHandler() {\\n+  if (!gIdentityHandler)\\n+    gIdentityHandler = new IdentityHandler();\\n+  return gIdentityHandler;    \\n+}\\ndiff --git a/browser/base/content/browser.xul b/browser/base/content/browser.xul\\nindex 0dd2062..a559acd 100644\\n--- a/browser/base/content/browser.xul\\n+++ b/browser/base/content/browser.xul\\n@@ -28,6 +28,7 @@\\n #   Joe Hewitt <hewitt@netscape.com>\\n #   Pierre Chanial <chanial@noos.fr>\\n #   Dean Tessman <dean_tessman@hotmail.com>\\n+#   Johnathan Nightingale <johnath@mozilla.com>\\n #\\n # Alternatively, the contents of this file may be used under the terms of\\n # either the GNU General Public License Version 2 or later (the \\\"GPL\\\"), or\\n@@ -136,6 +137,34 @@\\n \\n     <popup id=\\\"placesContext\\\"/>\\n \\n+    <!-- Popup for site identity information -->\\n+    <panel id=\\\"identity-popup\\\" position=\\\"after_start\\\" hidden=\\\"true\\\" noautofocus=\\\"true\\\">\\n+      <hbox id=\\\"identity-popup-container\\\" align=\\\"top\\\">\\n+        <image id=\\\"identity-popup-icon\\\"/>\\n+        <vbox id=\\\"identity-popup-content-box\\\">\\n+          <!-- Title Bar -->\\n+          <label id=\\\"identity-popup-title\\\"/>\\n+          <!-- Content area -->\\n+          <description id=\\\"identity-popup-content\\\"/>\\n+          <description id=\\\"identity-popup-content-supplemental\\\"/>\\n+          <description id=\\\"identity-popup-content-verifier\\\"/>\\n+          <hbox id=\\\"identity-popup-encryption\\\" flex=\\\"1\\\">\\n+            <vbox>\\n+              <image id=\\\"identity-popup-encryption-icon\\\"/>\\n+              <spacer flex=\\\"1\\\"/>\\n+            </vbox>\\n+            <description id=\\\"identity-popup-encryption-label\\\" flex=\\\"1\\\"/>\\n+          </hbox>\\n+          <spacer flex=\\\"1\\\"/>\\n+          <!-- Footer link to page info -->\\n+          <label id=\\\"identity-popup-more-info-link\\\"\\n+                 class=\\\"text-link plain\\\"\\n+                 value=\\\"&identity.moreInfoLinkText;\\\"\\n+                 onclick=\\\"getIdentityHandler().handleMoreInfoClick(event);\\\"/>\\n+        </vbox>\\n+      </hbox>\\n+    </panel>\\n+\\n     <tooltip id=\\\"urlTooltip\\\">\\n       <label crop=\\\"center\\\" flex=\\\"1\\\"/>\\n     </tooltip>\\n@@ -231,19 +260,25 @@\\n                    oninput=\\\"gBrowser.userTypedValue = this.value\\\"\\n                    ontextentered=\\\"return handleURLBarCommand(param);\\\"\\n                    ontextreverted=\\\"return handleURLBarRevert();\\\">\\n-            <deck id=\\\"page-proxy-deck\\\" onclick=\\\"PageProxyClickHandler(event);\\\">\\n-              <image id=\\\"page-proxy-button\\\"\\n-                     ondraggesture=\\\"PageProxyDragGesture(event);\\\"\\n-                     tooltiptext=\\\"&proxyIcon.tooltip;\\\"/>\\n-              <image id=\\\"page-proxy-favicon\\\" validate=\\\"never\\\"\\n-                     ondraggesture=\\\"PageProxyDragGesture(event);\\\"\\n-                     onload=\\\"this.parentNode.selectedIndex = 1;\\n-                             event.stopPropagation();\\\"\\n-                     onerror=\\\"gBrowser.addToMissedIconCache(this.src);\\n-                              this.removeAttribute('src');\\n-                              this.parentNode.selectedIndex = 0;\\\"\\n-                     tooltiptext=\\\"&proxyIcon.tooltip;\\\"/>\\n-            </deck>\\n+              <!-- Use onclick instead of normal popup= syntax since the popup\\n+                   code fires onmousedown, and hence eats our favicon drag events -->\\n+              <box id=\\\"identity-box\\\" align=\\\"center\\\" \\n+                   onclick=\\\"getIdentityHandler().handleIdentityClick(event);\\\">\\n+              <deck id=\\\"page-proxy-deck\\\" onclick=\\\"PageProxyClickHandler(event);\\\">\\n+                <image id=\\\"page-proxy-button\\\"\\n+                       ondraggesture=\\\"PageProxyDragGesture(event);\\\"\\n+                       tooltiptext=\\\"&proxyIcon.tooltip;\\\"/>\\n+                <image id=\\\"page-proxy-favicon\\\" validate=\\\"never\\\"\\n+                       ondraggesture=\\\"PageProxyDragGesture(event);\\\"\\n+                       onload=\\\"this.parentNode.selectedIndex = 1;\\n+                               event.stopPropagation();\\\"\\n+                       onerror=\\\"gBrowser.addToMissedIconCache(this.src);\\n+                                this.removeAttribute('src');\\n+                                this.parentNode.selectedIndex = 0;\\\"\\n+                       tooltiptext=\\\"&proxyIcon.tooltip;\\\"/>\\n+              </deck>\\n+              <label id=\\\"identity-icon-label\\\"/>\\n+            </box> \\n             <hbox id=\\\"urlbar-icons\\\">\\n               <button type=\\\"menu\\\"\\n                       style=\\\"-moz-user-focus: none\\\"\\n@@ -256,7 +291,6 @@\\n                            oncommand=\\\"return FeedHandler.subscribeToFeed(null, event);\\\"\\n                            onclick=\\\"checkForMiddleClick(this, event);\\\"/>\\n               </button>\\n-              <image id=\\\"lock-icon\\\" onclick=\\\"if (event.button == 0) displaySecurityInfo(); event.stopPropagation();\\\"/>\\n #ifdef MOZ_SAFE_BROWSING\\n               <image id=\\\"safebrowsing-urlbar-icon\\\" tooltiptext=\\\"&safeb.urlbaricon.tooltip;\\\"\\n                      level=\\\"safe\\\"\\ndiff --git a/browser/base/content/urlbarBindings.xml b/browser/base/content/urlbarBindings.xml\\nindex c576c23..ac0cad8 100644\\n--- a/browser/base/content/urlbarBindings.xml\\n+++ b/browser/base/content/urlbarBindings.xml\\n@@ -46,7 +46,7 @@\\n   <binding id=\\\"urlbar\\\" extends=\\\"chrome://global/content/bindings/autocomplete.xml#autocomplete\\\">\\n     <content sizetopopup=\\\"pref\\\">\\n       <xul:hbox class=\\\"autocomplete-textbox-container\\\" flex=\\\"1\\\">\\n-        <children includes=\\\"image|deck|stack\\\">\\n+        <children includes=\\\"image|deck|stack|box\\\">\\n           <xul:image class=\\\"autocomplete-icon\\\" allowevents=\\\"true\\\"/>\\n         </children>\\n \\ndiff --git a/browser/components/safebrowsing/content/phishing-afterload-displayer.js b/browser/components/safebrowsing/content/phishing-afterload-displayer.js\\nindex a0b3ecf..09aa7d8 100644\\n--- a/browser/components/safebrowsing/content/phishing-afterload-displayer.js\\n+++ b/browser/components/safebrowsing/content/phishing-afterload-displayer.js\\n@@ -208,7 +208,6 @@ PROT_PhishMsgDisplayerBase.prototype.browserSelected = function() {\\n     this.messageShouldShow_ = true;\\n   }\\n \\n-  this.hideLockIcon_();        // Comes back when we are unselected or unloaded\\n   this.addWarningInUrlbar_();  // Goes away when we are unselected or unloaded\\n \\n   // messageShouldShow might be false if the user dismissed the warning, \\n@@ -234,7 +233,6 @@ PROT_PhishMsgDisplayerBase.prototype.explicitShow = function() {\\n  */\\n PROT_PhishMsgDisplayerBase.prototype.browserUnselected = function() {\\n   this.removeWarningInUrlbar_();\\n-  this.unhideLockIcon_();\\n   if (this.messageShowing_)\\n     this.hideMessage_();\\n }\\n@@ -290,7 +288,6 @@ PROT_PhishMsgDisplayerBase.prototype.done = function() {\\n     // If we were started, we must be the current problem, so these things\\n     // must be showing\\n     this.removeWarningInUrlbar_();\\n-    this.unhideLockIcon_();\\n \\n     // Could be though that they've closed the warning dialog\\n     if (this.messageShowing_)\\n@@ -328,28 +325,6 @@ PROT_PhishMsgDisplayerBase.prototype.removeIfExists_ = function(orig,\\n }\\n \\n /**\\n- * We don't want to confuse users if they land on a phishy page that uses\\n- * SSL, so ensure that the lock icon never shows when we're showing our \\n- * warning.\\n- */\\n-PROT_PhishMsgDisplayerBase.prototype.hideLockIcon_ = function() {\\n-  var lockIcon = this.doc_.getElementById(\\\"lock-icon\\\");\\n-  if (!lockIcon)\\n-    return;\\n-  lockIcon.hidden = true;\\n-}\\n-\\n-/**\\n- * Ensure they can see it after our warning is finished.\\n- */\\n-PROT_PhishMsgDisplayerBase.prototype.unhideLockIcon_ = function() {\\n-  var lockIcon = this.doc_.getElementById(\\\"lock-icon\\\");\\n-  if (!lockIcon)\\n-    return;\\n-  lockIcon.hidden = false;\\n-}\\n-\\n-/**\\n  * This method makes our warning icon visible in the location bar. It will\\n  * be removed only when the problematic document is navigated awy from \\n  * (i.e., when done() is called), and not when the warning is dismissed.\\ndiff --git a/browser/locales/en-US/chrome/browser/browser.dtd b/browser/locales/en-US/chrome/browser/browser.dtd\\nindex 436fe64..ab572e4 100644\\n--- a/browser/locales/en-US/chrome/browser/browser.dtd\\n+++ b/browser/locales/en-US/chrome/browser/browser.dtd\\n@@ -350,3 +350,5 @@\\n \\n <!ENTITY editBookmark.done.label                      \\\"Done\\\">\\n <!ENTITY editBookmark.delete.label                    \\\"Delete\\\">\\n+\\n+<!ENTITY identity.moreInfoLinkText \\\"Tell me more about this web site...\\\">\\ndiff --git a/browser/locales/en-US/chrome/browser/browser.properties b/browser/locales/en-US/chrome/browser/browser.properties\\nindex b3a266b..97f1ec0 100644\\n--- a/browser/locales/en-US/chrome/browser/browser.properties\\n+++ b/browser/locales/en-US/chrome/browser/browser.properties\\n@@ -101,3 +101,20 @@ chromelessWindow.accessKey=S\\n # Star button\\n starButtonOn.tooltip=Edit this bookmark\\n starButtonOff.tooltip=Bookmark this page\\n+\\n+# Identity information\\n+identity.domainverified.title=Location Verified\\n+identity.domainverified.body=You are currently visiting:\\n+identity.domainverified.supplemental=Information identifying the owner of this web site may not have been validated.\\n+\\n+identity.identified.title=Identity Verified\\n+identity.identified.body=This web site is owned by:\\n+identity.identified.verifier=Verified by: %S\\n+identity.identified.state_and_country=%S, %S\\n+identity.identified.title_with_country=%S (%S)\\n+\\n+identity.unknown.title=Identity Unknown\\n+identity.unknown.body=This web site does not supply identity information.\\n+\\n+identity.encrypted=Your connection to this web site is encrypted to prevent eavesdropping.\\n+identity.unencrypted=Your connection to this web site is not encrypted.\\ndiff --git a/browser/locales/en-US/chrome/browser/pageInfo.dtd b/browser/locales/en-US/chrome/browser/pageInfo.dtd\\nindex 7542e38..5823458 100644\\n--- a/browser/locales/en-US/chrome/browser/pageInfo.dtd\\n+++ b/browser/locales/en-US/chrome/browser/pageInfo.dtd\\n@@ -112,7 +112,7 @@\\n <!ENTITY  securityView.identity.verifier \\\"Verified by: \\\">\\n \\n <!ENTITY  securityView.privacy.header                   \\\"Privacy &amp; History\\\">\\n-<!ENTITY  securityView.privacy.history                  \\\"Have I visited this website before today?\\\">\\n+<!ENTITY  securityView.privacy.history                  \\\"Have I visited this web site before today?\\\">\\n <!ENTITY  securityView.privacy.cookies                  \\\"Is this web site storing information (cookies) on my computer?\\\">\\n <!ENTITY  securityView.privacy.viewCookies              \\\"View Cookies\\\">\\n <!ENTITY  securityView.privacy.viewCookies.accessKey    \\\"k\\\">\\ndiff --git a/browser/themes/pinstripe/browser/browser.css b/browser/themes/pinstripe/browser/browser.css\\nindex a8f9281..e378cc3 100755\\n--- a/browser/themes/pinstripe/browser/browser.css\\n+++ b/browser/themes/pinstripe/browser/browser.css\\n@@ -827,7 +827,7 @@ toolbar[iconsize=\\\"small\\\"] #paste-button:hover:active {\\n #urlbar {\\n   margin-top: 5px;\\n   margin-bottom: 5px;\\n-  -moz-margin-start: 4px;\\n+  -moz-margin-start: 0px;\\n   -moz-margin-end: 0px;\\n   width: 7em;\\n   min-width: 7em;\\n@@ -879,46 +879,6 @@ toolbar[iconsize=\\\"small\\\"] #paste-button:hover:active {\\n   background: url(\\\"chrome://browser/skin/Secure-background.gif\\\") #FFFED8 repeat-x;\\n }\\n \\n-#urlbar #lock-icon {\\n-  height: 18px;\\n-  margin: -1px;\\n-}\\n-\\n-#urlbar[level=\\\"high\\\"] #lock-icon {\\n-  list-style-image: url(\\\"chrome://browser/skin/Secure.png\\\");\\n-  -moz-image-region: rect(0px, 18px, 18px, 0px);\\n-}\\n-#urlbar[level=\\\"high\\\"] #lock-icon:hover {\\n-  -moz-image-region: rect(18px, 18px, 36px, 0px);\\n-}\\n-#urlbar[level=\\\"high\\\"] #lock-icon:active {\\n-  -moz-image-region: rect(36px, 18px, 54px, 0px);\\n-}\\n-\\n-#urlbar[level=\\\"low\\\"] #lock-icon {\\n-  list-style-image: url(\\\"chrome://browser/skin/Secure.png\\\");\\n-  -moz-image-region: rect(0px, 18px, 18px, 0px);\\n-}\\n-#urlbar[level=\\\"low\\\"] #lock-icon:hover {\\n-  -moz-image-region: rect(18px, 18px, 36px, 0px);\\n-}\\n-#urlbar[level=\\\"low\\\"] #lock-icon:active {\\n-  -moz-image-region: rect(36px, 18px, 54px, 0px);\\n-}\\n-\\n-#urlbar[level=\\\"broken\\\"] #lock-icon {\\n-  list-style-image: url(\\\"chrome://browser/skin/Security-broken.png\\\");\\n-  -moz-image-region: rect(0px, 18px, 18px, 0px);\\n-}\\n-\\n-#urlbar[level=\\\"broken\\\"] #lock-icon:hover {\\n-  -moz-image-region: rect(18px, 18px, 36px, 0px);\\n-}\\n-\\n-#urlbar[level=\\\"broken\\\"] #lock-icon:active {\\n-  -moz-image-region: rect(36px, 18px, 54px, 0px);\\n-}\\n-\\n #urlbar-container {\\n   -moz-padding-end: 5px;\\n }\\n@@ -1703,3 +1663,116 @@ toolbarbutton.bookmark-item[dragover=\\\"true\\\"][open=\\\"true\\\"] {\\n   -moz-border-left-colors: ThreeDLightShadow ThreeDHighlight !important;\\n }\\n \\n+/* ::::: Identity Indicator Styling ::::: */\\n+/* Location bar visuals*/\\n+#identity-box {\\n+  /* Extend our margins out so that our highlight/separator bar covers the\\n+    location bar properly */\\n+  margin: -1px 0 -2px;\\n+  padding: 1px 2px 2px 0;\\n+  border-right: 1px solid #888;\\n+  background-color: white;\\n+  opacity: 0.9;\\n+}\\n+\\n+#identity-box:hover {\\n+  opacity: 1.0;\\n+}\\n+\\n+#identity-box.verifiedIdentity {\\n+  background-color: #BFA;\\n+}\\n+\\n+#urlbar[level=\\\"high\\\"] > #identity-box,\\n+#urlbar[level=\\\"low\\\"] > #identity-box {\\n+  /* urlbar adds padding when security level is set, which we need to\\n+  counteract here so that we still fill the background.  */\\n+  margin: -2px;\\n+  padding: 1px 2px 2px;\\n+}\\n+\\n+#identity-icon-label {\\n+    padding: 2px 2px 1px;\\n+    margin: 0;\\n+    color: black;\\n+    vertical-align: middle;\\n+}\\n+\\n+.unknownIdentity > #identity-icon-label {\\n+    display: none;\\n+}\\n+\\n+/* Popup Icons */\\n+#identity-popup-icon {\\n+    height: 64px;\\n+    width: 64px;\\n+    padding: 0;\\n+    margin: 10px 0 0;\\n+    list-style-image: url(\\\"chrome://browser/skin/identity.png\\\");\\n+    -moz-image-region: rect(0px, 64px, 64px, 0px);\\n+}\\n+\\n+.verifiedDomain > #identity-popup-container > #identity-popup-icon {\\n+    -moz-image-region: rect(64px, 64px, 128px, 0px);\\n+}\\n+\\n+.verifiedIdentity > #identity-popup-container > #identity-popup-icon {\\n+    -moz-image-region: rect(128px, 64px, 192px, 0px);\\n+}\\n+\\n+/* Popup Title */\\n+#identity-popup-title {\\n+    font-size: 120%;\\n+    font-weight: bold;\\n+}\\n+\\n+.verifiedIdentity > #identity-popup-title {\\n+    color: #6A6;\\n+}\\n+\\n+.unknownIdentity > #identity-popup-title {\\n+    color: #999;\\n+}\\n+\\n+.verifiedDomain > #identity-popup-title {\\n+    color: black;\\n+}\\n+\\n+/* Popup Body Text */\\n+#identity-popup-content-box > description,\\n+#identity-popup-encryption-label {\\n+    white-space: -moz-pre-wrap;\\n+    color: black;\\n+    padding-left: 10px;\\n+}\\n+\\n+#identity-popup-content {\\n+    padding-top: 5px;\\n+    margin-bottom: 0;\\n+    max-width: 200px;\\n+}\\n+\\n+.verifiedIdentity > #identity-popup-content,\\n+.verifiedDomain > #identity-popup-content {\\n+   font-size: 140%;\\n+   font-weight: bold;\\n+   max-width: 300px;\\n+}\\n+\\n+#identity-popup-encryption {\\n+  margin: 10px 0;\\n+}\\n+\\n+.verifiedIdentity > #identity-popup-encryption > * > #identity-popup-encryption-icon,\\n+.verifiedDomain > #identity-popup-encryption > * >#identity-popup-encryption-icon {\\n+  list-style-image: url(\\\"chrome://browser/skin/Secure.png\\\");\\n+  -moz-image-region: rect(0px, 18px, 18px, 0px);\\n+}\\n+\\n+/* Popup Bounding Box */\\n+#identity-popup-container {\\n+    background-image: none;\\n+    background-color: white;\\n+    min-width: 280px;\\n+    padding: 10px;\\n+}\\ndiff --git a/browser/themes/pinstripe/browser/jar.mn b/browser/themes/pinstripe/browser/jar.mn\\nindex e6ba6c4..0ccdac4 100644\\n--- a/browser/themes/pinstripe/browser/jar.mn\\n+++ b/browser/themes/pinstripe/browser/jar.mn\\n@@ -10,6 +10,7 @@ classic.jar:\\n   skin/classic/browser/find.png\\n   skin/classic/browser/find-bar-background.png\\n   skin/classic/browser/Go.png\\n+  skin/classic/browser/identity.png\\n   skin/classic/browser/Info.png\\n   skin/classic/browser/page-livemarks.png\\n   skin/classic/browser/livemark-item.png\\ndiff --git a/browser/themes/winstripe/browser/browser.css b/browser/themes/winstripe/browser/browser.css\\nindex c3e012d..6d12299 100644\\n--- a/browser/themes/winstripe/browser/browser.css\\n+++ b/browser/themes/winstripe/browser/browser.css\\n@@ -850,7 +850,7 @@ toolbar[iconsize=\\\"small\\\"] #paste-button:not([disabled=\\\"true\\\"]):hover:active {\\n   margin-bottom: 2px;\\n   margin-top: 2px;\\n   -moz-margin-end: 0px;\\n-  -moz-margin-start: 3px;\\n+  -moz-margin-start: 0px;\\n   width: 7em;\\n   min-width: 7em;\\n \\n@@ -1735,43 +1735,6 @@ toolbar[mode=\\\"text\\\"] > #window-controls > toolbarbutton > .toolbarbutton-text {\\n   color: #000000;\\n }\\n \\n-#urlbar[level=\\\"high\\\"] #lock-icon {\\n-  -moz-image-region: rect(0px, 18px, 18px, 0px);\\n-  list-style-image: url(\\\"chrome://browser/skin/Secure.png\\\");\\n-}\\n-#urlbar[level=\\\"high\\\"] #lock-icon:hover {\\n-  -moz-image-region: rect(18px, 18px, 36px, 0px);\\n-  list-style-image: url(\\\"chrome://browser/skin/Secure.png\\\");\\n-}\\n-#urlbar[level=\\\"high\\\"] #lock-icon:active {\\n-  -moz-image-region: rect(36px, 18px, 54px, 0px);\\n-  list-style-image: url(\\\"chrome://browser/skin/Secure.png\\\");\\n-}\\n-#urlbar[level=\\\"low\\\"] #lock-icon {\\n-  -moz-image-region: rect(0px, 18px, 18px, 0px);\\n-  list-style-image: url(\\\"chrome://browser/skin/Secure.png\\\");\\n-}\\n-#urlbar[level=\\\"low\\\"] #lock-icon:hover {\\n-  -moz-image-region: rect(18px, 18px, 36px, 0px);\\n-  list-style-image: url(\\\"chrome://browser/skin/Secure.png\\\");\\n-}\\n-#urlbar[level=\\\"low\\\"] #lock-icon:active {\\n-  -moz-image-region: rect(36px, 18px, 54px, 0px);\\n-  list-style-image: url(\\\"chrome://browser/skin/Secure.png\\\");\\n-}\\n-#urlbar[level=\\\"broken\\\"] #lock-icon {\\n-  -moz-image-region: rect(0px, 18px, 18px, 0px);\\n-  list-style-image: url(\\\"chrome://browser/skin/Security-broken.png\\\");\\n-}\\n-#urlbar[level=\\\"broken\\\"] #lock-icon:hover {\\n-  -moz-image-region: rect(18px, 18px, 36px, 0px);\\n-  list-style-image: url(\\\"chrome://browser/skin/Security-broken.png\\\");\\n-}\\n-#urlbar[level=\\\"broken\\\"] #lock-icon:active {\\n-  -moz-image-region: rect(36px, 18px, 54px, 0px);\\n-  list-style-image: url(\\\"chrome://browser/skin/Security-broken.png\\\");\\n-}\\n-\\n %ifdef MOZ_WIDGET_GTK2\\n #urlbar > .autocomplete-textbox-container {\\n   -moz-binding: url(chrome://browser/skin/browser.xml#autocomplete-security-wrapper);\\n@@ -1884,3 +1847,105 @@ toolbarbutton.bookmark-item[dragover=\\\"true\\\"][open=\\\"true\\\"] {\\n .bookmark-item[dragover-bottom=\\\"true\\\"] {\\n   -moz-border-bottom-colors: #000000;\\n }\\n+\\n+/* ::::: Identity Indicator Styling ::::: */\\n+/* Location bar visuals*/\\n+#identity-box {\\n+  border-right: 1px solid #888;\\n+  background-color: white;\\n+  opacity: 0.9;\\n+}\\n+\\n+#identity-box:hover {\\n+  opacity: 1.0;\\n+}\\n+\\n+#identity-box.verifiedIdentity {\\n+  background-color: #BFA;\\n+}\\n+\\n+#identity-icon-label {\\n+    padding: 1px 2px 2px;\\n+    margin: 0;\\n+    color: black;\\n+    vertical-align: middle;\\n+}\\n+\\n+.unknownIdentity > #identity-icon-label {\\n+    display: none;\\n+}\\n+\\n+/* Popup Icons */\\n+#identity-popup-icon {\\n+    height: 64px;\\n+    width: 64px;\\n+    padding: 0;\\n+    margin: 10px 0 0;\\n+    list-style-image: url(\\\"chrome://browser/skin/identity.png\\\");\\n+    -moz-image-region: rect(0px, 64px, 64px, 0px);\\n+}\\n+\\n+.verifiedDomain > #identity-popup-container > #identity-popup-icon {\\n+    -moz-image-region: rect(64px, 64px, 128px, 0px);\\n+}\\n+\\n+.verifiedIdentity > #identity-popup-container > #identity-popup-icon {\\n+    -moz-image-region: rect(128px, 64px, 192px, 0px);\\n+}\\n+\\n+/* Popup Title */\\n+#identity-popup-title {\\n+    font-size: 120%;\\n+    font-weight: bold;\\n+}\\n+\\n+.verifiedIdentity > #identity-popup-title {\\n+    color: #6A6;\\n+}\\n+\\n+.unknownIdentity > #identity-popup-title {\\n+    color: #999;\\n+}\\n+\\n+.verifiedDomain > #identity-popup-title {\\n+    color: black;\\n+}\\n+\\n+/* Popup Body Text */\\n+#identity-popup-content-box > description,\\n+#identity-popup-encryption-label {\\n+    white-space: -moz-pre-wrap;\\n+    color: black;\\n+    padding-left: 10px;\\n+}\\n+\\n+#identity-popup-content {\\n+    padding-top: 5px;\\n+    margin-bottom: 0;\\n+    max-width: 200px;\\n+}\\n+\\n+.verifiedIdentity > #identity-popup-content,\\n+.verifiedDomain > #identity-popup-content {\\n+   font-size: 140%;\\n+   font-weight: bold;\\n+   max-width: 300px;\\n+}\\n+\\n+#identity-popup-encryption {\\n+  margin: 10px 0;\\n+}\\n+\\n+.verifiedIdentity > #identity-popup-encryption > * > #identity-popup-encryption-icon,\\n+.verifiedDomain > #identity-popup-encryption > * >#identity-popup-encryption-icon {\\n+  list-style-image: url(\\\"chrome://browser/skin/Secure.png\\\");\\n+  -moz-image-region: rect(0px, 18px, 18px, 0px);\\n+}\\n+\\n+/* Popup Bounding Box */\\n+#identity-popup-container {\\n+    background-image: none;\\n+    background-color: white;\\n+    min-width: 280px;\\n+    padding: 10px;\\n+}\\ndiff --git a/browser/themes/winstripe/browser/jar.mn b/browser/themes/winstripe/browser/jar.mn\\nindex cf9c1bf..e2d1c56 100644\\n--- a/browser/themes/winstripe/browser/jar.mn\\n+++ b/browser/themes/winstripe/browser/jar.mn\\n@@ -6,6 +6,7 @@ classic.jar:\\n         skin/classic/browser/endcap-bkgnd-hover.png\\n *       skin/classic/browser/engineManager.css                  (engineManager.css)\\n         skin/classic/browser/Info.png\\n+        skin/classic/browser/identity.png\\n         skin/classic/browser/pageInfo.css\\n         skin/classic/browser/pageInfo.png\\n         skin/classic/browser/page-livemarks.png\\n\""}