{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas54df6f7\""},"diff":"\"54df6f7 Make sure to store the security info correctly for wyciwyg.  Bug 390168, r+sr=jst\\ndiff --git a/content/html/document/src/nsWyciwygChannel.cpp b/content/html/document/src/nsWyciwygChannel.cpp\\nindex aeff95f..88790ee 100644\\n--- a/content/html/document/src/nsWyciwygChannel.cpp\\n+++ b/content/html/document/src/nsWyciwygChannel.cpp\\n@@ -45,6 +45,7 @@\\n #include \\\"nsContentUtils.h\\\"\\n #include \\\"nsICacheService.h\\\"\\n #include \\\"nsICacheSession.h\\\"\\n+#include \\\"nsIParser.h\\\"\\n \\n \\n PRLogModuleInfo * gWyciwygLog = nsnull;\\n@@ -56,6 +57,8 @@ PRLogModuleInfo * gWyciwygLog = nsnull;\\n nsWyciwygChannel::nsWyciwygChannel()\\n   : mStatus(NS_OK),\\n     mIsPending(PR_FALSE),\\n+    mCharsetSet(PR_FALSE),\\n+    mCharsetSource(kCharsetUninitialized),\\n     mContentLength(-1),\\n     mLoadFlags(LOAD_NORMAL)\\n {\\n@@ -347,6 +350,14 @@ nsWyciwygChannel::WriteToCacheEntry(const nsAString &aData)\\n     mCacheEntry->SetSecurityInfo(mSecurityInfo);\\n   }\\n \\n+  if (mCharsetSet) {\\n+    mCacheEntry->SetMetaDataElement(\\\"charset\\\", mCharset.get());\\n+\\n+    nsCAutoString source;\\n+    source.AppendInt(mCharsetSource);\\n+    mCacheEntry->SetMetaDataElement(\\\"charset-source\\\", source.get());\\n+  }\\n+  \\n   PRUint32 out;\\n   if (!mCacheOutputStream) {\\n     // Get the outputstream from the cache entry.\\n@@ -395,20 +406,10 @@ nsWyciwygChannel::SetCharsetAndSource(PRInt32 aSource,\\n {\\n   NS_ENSURE_ARG(!aCharset.IsEmpty());\\n \\n-  if (!mCacheEntry) {\\n-    nsCAutoString spec;\\n-    nsresult rv = mURI->GetAsciiSpec(spec);\\n-    if (NS_FAILED(rv)) return rv;\\n-    rv = OpenCacheEntry(spec, nsICache::ACCESS_WRITE);\\n-    if (NS_FAILED(rv)) return rv;\\n-  }\\n+  mCharsetSet = PR_TRUE;\\n+  mCharsetSource = aSource;\\n+  mCharset = aCharset;\\n \\n-  mCacheEntry->SetMetaDataElement(\\\"charset\\\",\\n-                                  PromiseFlatCString(aCharset).get());\\n-  nsCAutoString source;\\n-  source.AppendInt(aSource);\\n-  mCacheEntry->SetMetaDataElement(\\\"charset-source\\\", source.get());\\n-  \\n   return NS_OK;\\n }\\n \\ndiff --git a/content/html/document/src/nsWyciwygChannel.h b/content/html/document/src/nsWyciwygChannel.h\\nindex ff34886..af0affc 100644\\n--- a/content/html/document/src/nsWyciwygChannel.h\\n+++ b/content/html/document/src/nsWyciwygChannel.h\\n@@ -85,7 +85,10 @@ protected:\\n     nsresult OpenCacheEntry(const nsACString & aCacheKey, nsCacheAccessMode aWriteAccess, PRBool * aDelayFlag = nsnull);\\n        \\n     nsresult                            mStatus;\\n-    PRBool                              mIsPending;\\n+    PRPackedBool                        mIsPending;\\n+    PRPackedBool                        mCharsetSet;\\n+    PRInt32                             mCharsetSource;\\n+    nsCString                           mCharset;\\n     PRInt32                             mContentLength;\\n     PRUint32                            mLoadFlags;\\n     nsCOMPtr<nsIURI>                    mURI;\\n\""}