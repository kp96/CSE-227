{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas84563e6\""},"diff":"\"84563e6 Bug 327604: Status bar message text persists when switching tabs while page is loading, patch by Simon BÃ¼nzli <zeniko@gmail.com>, r+a=mconnor\\ndiff --git a/browser/base/content/tabbrowser.xml b/browser/base/content/tabbrowser.xml\\nindex ef7f6ea..9797cdd 100644\\n--- a/browser/base/content/tabbrowser.xml\\n+++ b/browser/base/content/tabbrowser.xml\\n@@ -295,6 +295,12 @@\\n             mBlank: aStartsBlank,\\n             mLastURI: null,\\n \\n+            // cache flags for correct status bar update after tab switching\\n+            mStateFlags: 0,\\n+            mStatus: 0,\\n+            mMessage: \\\"\\\",\\n+            mTotalProgress: 0,\\n+\\n             onProgressChange : function (aWebProgress, aRequest,\\n                                          aCurSelfProgress, aMaxSelfProgress,\\n                                          aCurTotalProgress, aMaxTotalProgress)\\n@@ -308,6 +314,8 @@\\n                                        aCurTotalProgress, aMaxTotalProgress);\\n                 }\\n               }\\n+\\n+              this.mTotalProgress = aMaxTotalProgress ? aCurTotalProgress / aMaxTotalProgress : 0;\\n             },\\n \\n             onStateChange : function(aWebProgress, aRequest, aStateFlags, aStatus)\\n@@ -377,6 +385,15 @@\\n                     p.onStateChange(aWebProgress, aRequest, aStateFlags, aStatus);\\n                 }\\n               }\\n+\\n+              if (aStateFlags & (nsIWebProgressListener.STATE_START |\\n+                                 nsIWebProgressListener.STATE_STOP)) {\\n+                // reset cached temporary values at beginning and end\\n+                this.mMessage = \\\"\\\";\\n+                this.mTotalProgress = 0;\\n+              }\\n+              this.mStateFlags = aStateFlags;\\n+              this.mStatus = aStatus;\\n             },\\n \\n             onLocationChange : function(aWebProgress, aRequest, aLocation)\\n@@ -410,6 +427,8 @@\\n                     p.onStatusChange(aWebProgress, aRequest, aStatus, aMessage);\\n                 }\\n               }\\n+\\n+              this.mMessage = aMessage;\\n             },\\n \\n             onSecurityChange : function(aWebProgress, aRequest, aState)\\n@@ -690,6 +709,14 @@\\n                 p.onLocationChange(webProgress, null, loc);\\n                 if (securityUI)\\n                   p.onSecurityChange(webProgress, null, securityUI.state);\\n+\\n+                // make sure that all status indicators are properly updated\\n+                if (\\\"onUpdateCurrentBrowser\\\" in p) {\\n+                  var listener = this.mTabListeners[this.mTabContainer.selectedIndex] || null;\\n+                  if (listener && listener.mStateFlags)\\n+                    p.onUpdateCurrentBrowser(listener.mStateFlags, listener.mStatus,\\n+                                             listener.mMessage, listener.mTotalProgress);\\n+                }\\n               }\\n             }\\n \\n\""}