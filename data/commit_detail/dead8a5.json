{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basdead8a5\""},"diff":"\"dead8a5 Bug 376189 - Show Only This Frame and Open Frame in New Window/Tab don't send referrer, patch by Florian Qu√®ze <f.qu@queze.net>, r=mano\\ndiff --git a/browser/base/content/nsContextMenu.js b/browser/base/content/nsContextMenu.js\\nindex 1fb3341..648b7bb 100644\\n--- a/browser/base/content/nsContextMenu.js\\n+++ b/browser/base/content/nsContextMenu.js\\n@@ -627,8 +627,10 @@ nsContextMenu.prototype = {\\n \\n   // Open frame in a new tab.\\n   openFrameInTab: function() {\\n-    openNewTabWith(this.target.ownerDocument.location.href,\\n-                   null, null, null, false);\\n+    var doc = this.target.ownerDocument;\\n+    var frameURL = doc.documentURIObject.spec;\\n+\\n+    openNewTabWith(frameURL, null, null, null, false, makeURI(doc.referrer));\\n   },\\n \\n   // Reload clicked-in frame.\\n@@ -638,19 +640,20 @@ nsContextMenu.prototype = {\\n \\n   // Open clicked-in frame in its own window.\\n   openFrame: function() {\\n-    openNewWindowWith(this.target.ownerDocument.location.href,\\n-                      null, null, false);\\n+    var doc = this.target.ownerDocument;\\n+    var frameURL = doc.documentURIObject.spec;\\n+\\n+    openNewWindowWith(frameURL, null, null, false, makeURI(doc.referrer));\\n   },\\n \\n   // Open clicked-in frame in the same window.\\n   showOnlyThisFrame: function() {\\n-    var frameURL = this.target.ownerDocument.location.href;\\n+    var doc = this.target.ownerDocument;\\n+    var frameURL = doc.documentURIObject.spec;\\n \\n-    try {\\n-      urlSecurityCheck(frameURL, this.browser.contentPrincipal,\\n-                       Ci.nsIScriptSecurityManager.DISALLOW_SCRIPT);\\n-      this.browser.loadURI(frameURL);\\n-    } catch(e) {}\\n+    urlSecurityCheck(frameURL, this.browser.contentPrincipal,\\n+                     Ci.nsIScriptSecurityManager.DISALLOW_SCRIPT);\\n+    this.browser.loadURI(frameURL, makeURI(doc.referrer));\\n   },\\n \\n   // View Partial Source\\ndiff --git a/browser/base/content/utilityOverlay.js b/browser/base/content/utilityOverlay.js\\nindex 4f62e6b..fd10c04 100644\\n--- a/browser/base/content/utilityOverlay.js\\n+++ b/browser/base/content/utilityOverlay.js\\n@@ -525,9 +525,12 @@ function getBrowserFromContentWindow(aContentWindow)\\n  *        If true, then we allow the URL text to be sent to third party services\\n  *        (e.g., Google's I Feel Lucky) for interpretation. This parameter may\\n  *        be undefined in which case it is treated as false.\\n+ * @param [optional] aReferrer\\n+ *        If aDocument is null, then this will be used as the referrer.\\n+ *        There will be no security check.\\n  */ \\n function openNewTabWith(aURL, aDocument, aPostData, aEvent,\\n-                        aAllowThirdPartyFixup)\\n+                        aAllowThirdPartyFixup, aReferrer)\\n {\\n   if (aDocument)\\n     urlSecurityCheck(aURL, aDocument.nodePrincipal);\\n@@ -555,13 +558,14 @@ function openNewTabWith(aURL, aDocument, aPostData, aEvent,\\n     originCharset = window.content.document.characterSet;\\n \\n   // open link in new tab\\n-  var referrerURI = aDocument ? aDocument.documentURIObject : null;\\n+  var referrerURI = aDocument ? aDocument.documentURIObject : aReferrer;\\n   var browser = top.document.getElementById(\\\"content\\\");\\n   browser.loadOneTab(aURL, referrerURI, originCharset, aPostData,\\n                      loadInBackground, aAllowThirdPartyFixup || false);\\n }\\n \\n-function openNewWindowWith(aURL, aDocument, aPostData, aAllowThirdPartyFixup)\\n+function openNewWindowWith(aURL, aDocument, aPostData, aAllowThirdPartyFixup,\\n+                           aReferrer)\\n {\\n   if (aDocument)\\n     urlSecurityCheck(aURL, aDocument.nodePrincipal);\\n@@ -575,7 +579,7 @@ function openNewWindowWith(aURL, aDocument, aPostData, aAllowThirdPartyFixup)\\n   if (wintype == \\\"navigator:browser\\\")\\n     charsetArg = \\\"charset=\\\" + window.content.document.characterSet;\\n \\n-  var referrerURI = aDocument ? aDocument.documentURIObject : null;\\n+  var referrerURI = aDocument ? aDocument.documentURIObject : aReferrer;\\n   window.openDialog(getBrowserURL(), \\\"_blank\\\", \\\"chrome,all,dialog=no\\\",\\n                     aURL, charsetArg, referrerURI, aPostData,\\n                     aAllowThirdPartyFixup);\\n\""}