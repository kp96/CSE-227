{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas74aec61\""},"diff":"\"74aec61 Fix bug 393671.  r+sr+a=roc\\ndiff --git a/layout/base/nsCSSFrameConstructor.cpp b/layout/base/nsCSSFrameConstructor.cpp\\nindex 5cda87c..1f12619 100644\\n--- a/layout/base/nsCSSFrameConstructor.cpp\\n+++ b/layout/base/nsCSSFrameConstructor.cpp\\n@@ -1208,6 +1208,7 @@ nsFrameConstructorState::nsFrameConstructorState(nsIPresShell*          aPresShe\\n     mFrameState(aHistoryState),\\n     mPseudoFrames()\\n {\\n+  MOZ_COUNT_CTOR(nsFrameConstructorState);\\n }\\n \\n nsFrameConstructorState::nsFrameConstructorState(nsIPresShell* aPresShell,\\n@@ -1228,6 +1229,7 @@ nsFrameConstructorState::nsFrameConstructorState(nsIPresShell* aPresShell,\\n     mFirstLineStyle(PR_FALSE),\\n     mPseudoFrames()\\n {\\n+  MOZ_COUNT_CTOR(nsFrameConstructorState);\\n   mFrameState = aPresShell->GetDocument()->GetLayoutHistoryState();\\n }\\n \\n@@ -1241,6 +1243,7 @@ nsFrameConstructorState::~nsFrameConstructorState()\\n   // for abs-pos and fixed-pos items whose containing blocks are outside the floats.\\n   // Then put abs-pos frames in, because they can contain placeholders for fixed-pos\\n   // items whose containing block is outside the abs-pos frames. \\n+  MOZ_COUNT_DTOR(nsFrameConstructorState);\\n   ProcessFrameInsertions(mFloatedItems, nsGkAtoms::floatList);\\n   ProcessFrameInsertions(mAbsoluteItems, nsGkAtoms::absoluteList);\\n   ProcessFrameInsertions(mFixedItems, nsGkAtoms::fixedList);\\n@@ -7933,6 +7936,16 @@ nsCSSFrameConstructor::AppendFrames(nsFrameConstructorState&       aState,\\n     NS_ASSERTION(firstTrailingInline, \\\"How did that happen?\\\");\\n     nsIFrame* parentFrame = aParentFrame;\\n \\n+    // As we go up the tree creating trailing inlines, we have to move floats\\n+    // up to ancestor blocks.  This means that at any given time we'll be\\n+    // working with two frame constructor states, and aState is one of the two\\n+    // only at the first step.  Create some space to do this so we don't have\\n+    // to allocate as we go.\\n+    char stateBuf[2 * sizeof(nsFrameConstructorState)];\\n+    nsFrameConstructorState* sourceState = &aState;\\n+    nsFrameConstructorState* targetState =\\n+      reinterpret_cast<nsFrameConstructorState*>(stateBuf);\\n+\\n     // Now we loop, because it might be the case that the parent of our special\\n     // block is another special block, and that we're at the very end of it,\\n     // and in that case if we create a new special inline we'll have to create\\n@@ -7957,15 +7970,32 @@ nsCSSFrameConstructor::AppendFrames(nsFrameConstructorState&       aState,\\n       nsIFrame* stateParent =\\n         inlineSibling ? inlineSibling->GetParent() : parentFrame->GetParent();\\n \\n-      nsFrameConstructorState\\n-        targetState(mPresShell, mFixedContainingBlock,\\n-                    GetAbsoluteContainingBlock(stateParent),\\n-                    GetFloatContainingBlock(stateParent));\\n+      new (targetState)\\n+        nsFrameConstructorState(mPresShell, mFixedContainingBlock,\\n+                                GetAbsoluteContainingBlock(stateParent),\\n+                                GetFloatContainingBlock(stateParent));\\n       nsIFrame* newInlineSibling =\\n-        MoveFramesToEndOfIBSplit(aState, inlineSibling,\\n+        MoveFramesToEndOfIBSplit(*sourceState, inlineSibling,\\n                                  isPositioned, content,\\n                                  styleContext, firstTrailingInline,\\n-                                 parentFrame, &targetState);\\n+                                 parentFrame, targetState);\\n+\\n+      if (sourceState == &aState) {\\n+        NS_ASSERTION(targetState ==\\n+                       reinterpret_cast<nsFrameConstructorState*>(stateBuf),\\n+                     \\\"Bogus target state?\\\");\\n+        // Set sourceState to the value targetState should have next.\\n+        sourceState = targetState + 1;\\n+      } else {\\n+        // Go ahead and process whatever insertions we didn't move out\\n+        sourceState->~nsFrameConstructorState();\\n+      }\\n+\\n+      // We're done with the source state.  The target becomes the new source,\\n+      // and we point the target pointer to the available memory.\\n+      nsFrameConstructorState* temp = sourceState;\\n+      sourceState = targetState;\\n+      targetState = temp;;\\n \\n       if (inlineSibling) {\\n         // we're all set -- we just moved things to a frame that was already\\n@@ -7996,6 +8026,9 @@ nsCSSFrameConstructor::AppendFrames(nsFrameConstructorState&       aState,\\n         firstTrailingInline = newInlineSibling;\\n       }      \\n     } while (firstTrailingInline);\\n+\\n+    // Process the float insertions on the last target state we had.\\n+    sourceState->~nsFrameConstructorState();\\n   }\\n     \\n   if (!aFrameList.childList) {\\ndiff --git a/layout/reftests/bugs/393671-1-ref.html b/layout/reftests/bugs/393671-1-ref.html\\nnew file mode 100644\\nindex 0000000..50df959\\n--- /dev/null\\n+++ b/layout/reftests/bugs/393671-1-ref.html\\n@@ -0,0 +1,9 @@\\n+<!DOCTYPE html>\\n+<html>\\n+\\n+<body>\\n+\\n+<span><span><div></div><span style=\\\"float: right\\\">float</span></span></span>\\n+\\n+</body>\\n+</html>\\ndiff --git a/layout/reftests/bugs/393671-1.html b/layout/reftests/bugs/393671-1.html\\nnew file mode 100644\\nindex 0000000..01f3982\\n--- /dev/null\\n+++ b/layout/reftests/bugs/393671-1.html\\n@@ -0,0 +1,21 @@\\n+<!DOCTYPE html>\\n+<html>\\n+<head>\\n+<script>\\n+function boom()\\n+{\\n+  var floater = document.createElement(\\\"span\\\");\\n+  floater.style.cssFloat = \\\"right\\\";\\n+  floater.appendChild(document.createTextNode(\\\"float\\\"));\\n+\\n+  document.getElementById(\\\"s\\\").appendChild(floater);\\n+}\\n+</script>\\n+</head>\\n+\\n+<body onload=\\\"boom();\\\">\\n+\\n+<span><span id=\\\"s\\\"><div></div></span></span>\\n+\\n+</body>\\n+</html>\\ndiff --git a/layout/reftests/bugs/393671-2-ref.html b/layout/reftests/bugs/393671-2-ref.html\\nnew file mode 100644\\nindex 0000000..2931848\\n--- /dev/null\\n+++ b/layout/reftests/bugs/393671-2-ref.html\\n@@ -0,0 +1,9 @@\\n+<!DOCTYPE html>\\n+<html>\\n+\\n+<body>\\n+\\n+<span><span><span><div></div><span style=\\\"float: right\\\">float</span></span></span></span>\\n+\\n+</body>\\n+</html>\\ndiff --git a/layout/reftests/bugs/393671-2.html b/layout/reftests/bugs/393671-2.html\\nnew file mode 100644\\nindex 0000000..81b076e\\n--- /dev/null\\n+++ b/layout/reftests/bugs/393671-2.html\\n@@ -0,0 +1,21 @@\\n+<!DOCTYPE html>\\n+<html>\\n+<head>\\n+<script>\\n+function boom()\\n+{\\n+  var floater = document.createElement(\\\"span\\\");\\n+  floater.style.cssFloat = \\\"right\\\";\\n+  floater.appendChild(document.createTextNode(\\\"float\\\"));\\n+\\n+  document.getElementById(\\\"s\\\").appendChild(floater);\\n+}\\n+</script>\\n+</head>\\n+\\n+<body onload=\\\"boom();\\\">\\n+\\n+<span><span><span id=\\\"s\\\"><div></div></span></span></span>\\n+\\n+</body>\\n+</html>\\ndiff --git a/layout/reftests/bugs/393671-3-ref.html b/layout/reftests/bugs/393671-3-ref.html\\nnew file mode 100644\\nindex 0000000..33336f5\\n--- /dev/null\\n+++ b/layout/reftests/bugs/393671-3-ref.html\\n@@ -0,0 +1,9 @@\\n+<!DOCTYPE html>\\n+<html>\\n+\\n+<body>\\n+\\n+<span><span><span><span><div></div><span style=\\\"float: right\\\">float</span></span></span></span></span>\\n+\\n+</body>\\n+</html>\\ndiff --git a/layout/reftests/bugs/393671-3.html b/layout/reftests/bugs/393671-3.html\\nnew file mode 100644\\nindex 0000000..abe5ae7\\n--- /dev/null\\n+++ b/layout/reftests/bugs/393671-3.html\\n@@ -0,0 +1,21 @@\\n+<!DOCTYPE html>\\n+<html>\\n+<head>\\n+<script>\\n+function boom()\\n+{\\n+  var floater = document.createElement(\\\"span\\\");\\n+  floater.style.cssFloat = \\\"right\\\";\\n+  floater.appendChild(document.createTextNode(\\\"float\\\"));\\n+\\n+  document.getElementById(\\\"s\\\").appendChild(floater);\\n+}\\n+</script>\\n+</head>\\n+\\n+<body onload=\\\"boom();\\\">\\n+\\n+<span><span><span><span id=\\\"s\\\"><div></div></span></span></span></span>\\n+\\n+</body>\\n+</html>\\ndiff --git a/layout/reftests/bugs/reftest.list b/layout/reftests/bugs/reftest.list\\nindex 3b899b8..c3bc190e 100644\\n--- a/layout/reftests/bugs/reftest.list\\n+++ b/layout/reftests/bugs/reftest.list\\n@@ -370,3 +370,6 @@ random-if(MOZ_WIDGET_TOOLKIT==\\\"cocoa\\\") == 379316-2.html 379316-2-ref.html # bug\\n == 391994-1.html 391994-1-ref.html\\n == 393649-1.html 393649-1-ref.html\\n == 393517-1.xhtml about:blank  # crash test\\n+== 393671-1.html 393671-1-ref.html\\n+== 393671-2.html 393671-2-ref.html\\n+== 393671-3.html 393671-3-ref.html\\n\""}