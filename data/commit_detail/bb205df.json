{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basbb205df\""},"diff":"\"bb205df Bug 385266 - New starring, bookmarking and tagging UI, changes noted in comment 333. r=dietrich.\\ndiff --git a/browser/base/content/browser-places.js b/browser/base/content/browser-places.js\\nindex feca1eb..399675f 100644\\n--- a/browser/base/content/browser-places.js\\n+++ b/browser/base/content/browser-places.js\\n@@ -105,10 +105,13 @@ var PlacesCommandHook = {\\n   },\\n \\n   /**\\n-   * Adds a bookmark to the page loaded in the given browser\\n+   * Adds a bookmark to the page loaded in the given browser.\\n    *\\n    * @param aBrowser\\n-   *        a <browser> element\\n+   *        a <browser> element.\\n+   * @param [optional] aParent\\n+   *        The folder in which to create a new bookmark if the page loaded in\\n+   *        aBrowser isn't bookmarked yet, defaults to the places root.\\n    * @param [optional] aShowEditUI\\n    *        whether or not to show the edit-bookmark UI for the bookmark item\\n    * @param [optional] aAnchorElement\\n@@ -116,10 +119,9 @@ var PlacesCommandHook = {\\n    * @param [optional] aPosition\\n    *        required if aShowEditUI is set, see popup's openPopup.\\n    */  \\n-  bookmarkPage: function PCH_bookmarkPage(aBrowser, aShowEditUI,\\n+  bookmarkPage: function PCH_bookmarkPage(aBrowser, aParent, aShowEditUI,\\n                                           aAnchorElement, aPosition) {\\n     var uri = aBrowser.currentURI;\\n-\\n     var itemId = PlacesUtils.getMostRecentBookmarkForURI(uri);\\n     if (itemId == -1) {\\n       // Copied over from addBookmarkForBrowser:\\n@@ -138,8 +140,9 @@ var PlacesCommandHook = {\\n       }\\n       catch (e) { }\\n \\n+      var parent = aParent != undefined ? aParent : PlacesUtils.placesRootId;\\n       var descAnno = { name: DESCRIPTION_ANNO, value: description };\\n-      var txn = PlacesUtils.ptm.createItem(uri, PlacesUtils.placesRootId, -1,\\n+      var txn = PlacesUtils.ptm.createItem(uri, parent, -1,\\n                                            title, null, [descAnno]);\\n       PlacesUtils.ptm.commitTransaction(txn);\\n       if (aShowEditUI)\\n@@ -153,33 +156,36 @@ var PlacesCommandHook = {\\n   /**\\n    * Adds a bookmark to the page loaded in the current tab. \\n    */\\n-  bookmarkCurrentPage: function PCH_bookmarkCurrentPage(aShowEditUI) {\\n+  bookmarkCurrentPage: function PCH_bookmarkCurrentPage(aShowEditUI, aParent) {\\n     // dock the panel to the star icon if it is visible, otherwise dock\\n     // it to the content area\\n-    var starIcon = document.getElementById(\\\"star-icon\\\");\\n+    var starIcon = document.getElementById(\\\"star-button\\\");\\n     if (starIcon && isElementVisible(starIcon)) {\\n-      this.bookmarkPage(getBrowser().selectedBrowser, aShowEditUI, starIcon,\\n-                        \\\"after_end\\\");\\n+      var dockTo = document.getElementById(\\\"go-button-bottom\\\");\\n+      this.bookmarkPage(getBrowser().selectedBrowser, aParent, aShowEditUI,\\n+                        dockTo, \\\"after_start\\\");\\n     }\\n     else {\\n-      this.bookmarkPage(getBrowser().selectedBrowser, aShowEditUI, getBrowser(),\\n-                        \\\"overlap\\\");\\n+      this.bookmarkPage(getBrowser().selectedBrowser, aParent, aShowEditUI,\\n+                        getBrowser(), \\\"overlap\\\");\\n     }\\n   },\\n \\n   /**\\n    * Adds a bookmark to the page targeted by a link.\\n-   * @param   url\\n-   *          The address of the link target\\n-   * @param   title\\n-   *          The link text\\n+   * @param aParent\\n+   *        The folder in which to create a new bookmark if aURL isn't\\n+   *        bookmarked.\\n+   * @param aURL (string)\\n+   *        the address of the link target\\n+   * @param aTitle\\n+   *        The link text\\n    */\\n-  bookmarkLink: function PCH_bookmarkLink(url, title) {\\n-    var linkURI = IO.newURI(url)\\n+  bookmarkLink: function PCH_bookmarkLink(aParent, aURL, aTitle) {\\n+    var linkURI = IO.newURI(aURL)\\n     var itemId = PlacesUtils.getMostRecentBookmarkForURI(linkURI);\\n     if (itemId == -1) {\\n-      var txn = PlacesUtils.ptm.createItem(linkURI, PlacesUtils.placesRootId, -1,\\n-                                           title);\\n+      var txn = PlacesUtils.ptm.createItem(linkURI, aParent, -1, aTitle);\\n       PlacesUtils.ptm.commitTransaction(txn);\\n       itemId = PlacesUtils.getMostRecentBookmarkForURI(linkURI);\\n     }\\n@@ -728,12 +734,12 @@ var PlacesStarButton = {\\n   _batching: false,\\n \\n   updateState: function PSB_updateState() {\\n-    var starIcon = document.getElementById(\\\"star-icon\\\");\\n+    var starIcon = document.getElementById(\\\"star-button\\\");\\n     if (!starIcon)\\n       return;\\n \\n     var uri = getBrowser().currentURI;\\n-    this._starred = uri && PlacesUtils.bookmarks.isBookmarked(uri);\\n+    this._starred = uri && (PlacesUtils.getMostRecentBookmarkForURI(uri) != -1);\\n     if (this._starred)\\n       starIcon.setAttribute(\\\"starred\\\", \\\"true\\\");\\n     else\\ndiff --git a/browser/base/content/browser-sets.inc b/browser/base/content/browser-sets.inc\\nindex 0878e2e..2c4f17c 100644\\n--- a/browser/base/content/browser-sets.inc\\n+++ b/browser/base/content/browser-sets.inc\\n@@ -88,7 +88,7 @@\\n              observes=\\\"isImage\\\"/>\\n     <!-- work-around bug 392512 -->\\n     <command id=\\\"Browser:AddBookmarkAs\\\" \\n-             oncommand=\\\"setTimeout(function() { PlacesCommandHook.bookmarkCurrentPage(true); }, 0);\\\"/>\\n+             oncommand=\\\"PlacesCommandHook.bookmarkCurrentPage(true, PlacesUtils.bookmarksRootId);\\\"/>\\n     <!-- The command is disabled for the hidden window. Otherwise its enabled\\n          state is handled by the BookmarkAllTabsHandler object. -->\\n     <command id=\\\"Browser:BookmarkAllTabs\\\"\\ndiff --git a/browser/base/content/browser.js b/browser/base/content/browser.js\\nindex db24b37..7b39af0 100644\\n--- a/browser/base/content/browser.js\\n+++ b/browser/base/content/browser.js\\n@@ -284,10 +284,9 @@ function BookmarkThisTab()\\n   if (tab.localName != \\\"tab\\\")\\n     tab = getBrowser().mCurrentTab;\\n \\n-  setTimeout(function() { // workaround bug 392512\\n-    PlacesCommandHook.bookmarkPage(tab.linkedBrowser, true, getBrowser(),\\n-                                   \\\"overlap\\\")\\n-  }, 0);\\n+  PlacesCommandHook.bookmarkPage(tab.linkedBrowser,\\n+                                 PlacesUtils.bookmarksRootId,\\n+                                 true, getBrowser(), \\\"overlap\\\");\\n }\\n \\n /**\\ndiff --git a/browser/base/content/browser.xul b/browser/base/content/browser.xul\\nindex 753fb91..406f30a 100644\\n--- a/browser/base/content/browser.xul\\n+++ b/browser/base/content/browser.xul\\n@@ -261,7 +261,6 @@\\n                        level=\\\"safe\\\"\\n                        onclick=\\\"goDoCommand('safebrowsing-show-warning')\\\" />\\n #endif\\n-                <image id=\\\"star-icon\\\" onclick=\\\"if (event.button == 0) PlacesStarButton.onClick(event);\\\"/>\\n               </hbox>\\n             </textbox>\\n             <stack id=\\\"go-button-stack\\\">\\n@@ -284,15 +283,17 @@\\n                        chromedir=\\\"&locale.dir;\\\" />\\n               </vbox>\\n \\t\\t\\t\\t\\t\\t\\t\\n-            <toolbarbutton id=\\\"go-button\\\"\\n-                           flex=\\\"1\\\"\\n-                           chromedir=\\\"&locale.dir;\\\"\\n-                           label=\\\"&goEndCap.label;\\\"\\n-                           onclick=\\\"handleURLBarCommand(event);\\\"\\n-                           ondragover=\\\"nsDragAndDrop.dragOver(event, goButtonObserver);\\\"\\n-                           ondragdrop=\\\"nsDragAndDrop.drop(event, goButtonObserver);\\\"\\n-                           ondragexit=\\\"nsDragAndDrop.dragExit(event, goButtonObserver);\\\"\\n-                           tooltiptext=\\\"&goEndCap.tooltip;\\\"/>\\n+              <hbox>\\n+                <toolbarbutton id=\\\"star-button\\\" onclick=\\\"if (event.button == 0) PlacesStarButton.onClick(event);\\\"/>\\n+                <toolbarbutton id=\\\"go-button\\\"\\n+                               chromedir=\\\"&locale.dir;\\\"\\n+                               label=\\\"&goEndCap.label;\\\"\\n+                               onclick=\\\"handleURLBarCommand(event);\\\"\\n+                               ondragover=\\\"nsDragAndDrop.dragOver(event, goButtonObserver);\\\"\\n+                               ondragdrop=\\\"nsDragAndDrop.drop(event, goButtonObserver);\\\"\\n+                               ondragexit=\\\"nsDragAndDrop.dragExit(event, goButtonObserver);\\\"\\n+                               tooltiptext=\\\"&goEndCap.tooltip;\\\"/>\\n+              </hbox>\\n           </stack>\\n         </hbox>\\n       </toolbaritem>\\ndiff --git a/browser/base/content/nsContextMenu.js b/browser/base/content/nsContextMenu.js\\nindex 648b7bb..2bcf606 100644\\n--- a/browser/base/content/nsContextMenu.js\\n+++ b/browser/base/content/nsContextMenu.js\\n@@ -1123,17 +1123,13 @@ nsContextMenu.prototype = {\\n   },\\n \\n   bookmarkThisPage: function CM_bookmarkThisPage() {\\n-    // workaround bug 392512\\n-    setTimeout(function(aSelf) {\\n-      PlacesCommandHook.bookmarkPage(aSelf.browser, true, aSelf.browser,\\n-                                     \\\"overlap\\\"); }, 0, this);\\n+    PlacesCommandHook.bookmarkPage(this.browser, PlacesUtils.bookmarksRootId,\\n+                                   true, this.browser, \\\"overlap\\\");\\n   },\\n \\n   bookmarkLink: function CM_bookmarkLink() {\\n-    // workaround bug 392512\\n-    setTimeout(function(aSelf) {\\n-      PlacesCommandHook.bookmarkLink(aSelf.linkURL, aSelf.linkText());\\n-    }, 0, this);\\n+    PlacesCommandHook.bookmarkLink(PlacesUtils.bookmarksRootId, this.linkURL,\\n+                                   this.linkText());\\n   },\\n \\n   addBookmarkForFrame: function CM_addBookmarkForFrame() {\\n@@ -1146,16 +1142,13 @@ nsContextMenu.prototype = {\\n       var description = PlacesUtils.getDescriptionFromDocument(doc);\\n \\n       var descAnno = { name: DESCRIPTION_ANNO, value: description };\\n-      var txn = PlacesUtils.ptm.createItem(uri, PlacesUtils.placesRootId, -1,\\n+      var txn = PlacesUtils.ptm.createItem(uri, PlacesUtils.bookmarksRootId, -1,\\n                                            title, null, [descAnno]);\\n       PlacesUtils.ptm.commitTransaction(txn);\\n       itemId = PlacesUtils.getMostRecentBookmarkForURI(uri);\\n     }\\n \\n-    // workaround bug 392512\\n-    setTimeout(function(aSelf) {\\n-      PlacesCommandHook.showEditBookmarkPopup(itemId, aSelf.browser, \\\"overlap\\\");\\n-    }, 0, this);\\n+    PlacesCommandHook.showEditBookmarkPopup(itemId, this.browser, \\\"overlap\\\");\\n   },\\n \\n   savePageAs: function CM_savePageAs() {\\ndiff --git a/browser/components/places/content/editBookmarkOverlay.js b/browser/components/places/content/editBookmarkOverlay.js\\nindex 873a240..f640c89 100644\\n--- a/browser/components/places/content/editBookmarkOverlay.js\\n+++ b/browser/components/places/content/editBookmarkOverlay.js\\n@@ -348,7 +348,7 @@ var gEditItemOverlay = {\\n       // hide the tag selector if it was previously visible\\n       var tagsSelector = this._element(\\\"tagsSelector\\\");\\n       if (!tagsSelector.collapsed)\\n-        tagsSelector.collapsed = true;\\n+        this._toggleTagsSelector();\\n     }\\n \\n     if (this._observersAdded) {\\n@@ -547,7 +547,7 @@ var gEditItemOverlay = {\\n     // Update folder-tree selection\\n     if (isElementVisible(this._folderTree)) {\\n       var selectedNode = this._folderTree.selectedNode;\\n-      if (selectedNode.itemId != container)\\n+      if (!selectedNode || selectedNode.itemId != container)\\n         this._folderTree.selectFolders([container]);\\n     }\\n   },\\n@@ -558,13 +558,7 @@ var gEditItemOverlay = {\\n       return;\\n \\n     var folderId = selectedNode.itemId;\\n-    // Don't set the selected item if the static item for the folder is\\n-    // already selected\\n-    var oldSelectedItem = this._folderMenuList.selectedItem;\\n-    if ((oldSelectedItem.id == \\\"editBMPanel_toolbarFolderItem\\\" &&\\n-         folderId == PlacesUtils.toolbarFolderId) ||\\n-        (oldSelectedItem.id == \\\"editBMPanel_bmRootItem\\\" &&\\n-         folderId == PlacesUtils.bookmarksRootId))\\n+    if (this._getFolderIdFromMenuList() == folderId)\\n       return;\\n \\n     var folderItem = this._getFolderMenuItem(folderId, false);\\ndiff --git a/browser/components/places/content/editBookmarkOverlay.xul b/browser/components/places/content/editBookmarkOverlay.xul\\nindex 8b4d928..0fe726b 100644\\n--- a/browser/components/places/content/editBookmarkOverlay.xul\\n+++ b/browser/components/places/content/editBookmarkOverlay.xul\\n@@ -74,12 +74,14 @@\\n             </menupopup>\\n           </menulist>\\n         </row>\\n+\\n         <row align=\\\"center\\\" id=\\\"editBMPanel_locationRow\\\">\\n           <label value=\\\"&editBookmarkOverlay.location.label;\\\"\\n                  contorl=\\\"editBMPanel_locationField\\\"/>\\n           <textbox id=\\\"editBMPanel_locationField\\\"\\n                    onblur=\\\"gEditItemOverlay.onLocationFieldBlur();\\\"/>\\n         </row>\\n+\\n         <row align=\\\"center\\\" id=\\\"editBMPanel_folderRow\\\">\\n           <label value=\\\"&editBookmarkOverlay.folder.label;\\\"\\n                  control=\\\"editBMPanel_folderMenuList\\\"/>\\n@@ -107,6 +109,7 @@\\n                   tooltiptextup=\\\"&editBookmarkOverlay.expanderUp.tooltip;\\\"\\n                   oncommand=\\\"gEditItemOverlay.toggleFolderTreeVisibility();\\\"/>\\n         </row>\\n+\\n         <tree id=\\\"editBMPanel_folderTree\\\"\\n               class=\\\"placesTree\\\"\\n               type=\\\"places\\\"\\n@@ -121,6 +124,7 @@\\n           </treecols>\\n           <treechildren flex=\\\"1\\\"/>\\n         </tree>\\n+\\n         <row align=\\\"center\\\" id=\\\"editBMPanel_tagsRow\\\">\\n           <label value=\\\"&editBookmarkOverlay.tags.label;\\\"\\n                  control=\\\"tagsField\\\"/>\\n@@ -134,10 +138,7 @@\\n                   oncommand=\\\"gEditItemOverlay.toggleTagsSelector();\\\"/>\\n         </row>\\n \\n-        <!-- XXX: Temporary workaround -->\\n-        </rows></grid>\\n         <listbox id=\\\"editBMPanel_tagsSelector\\\" height=\\\"150\\\" collapsed=\\\"true\\\"/>\\n-        <grid flex=\\\"1\\\"><columns><column/><column flex=\\\"1\\\"/></columns><rows>\\n \\n         <row id=\\\"editBMPanel_descriptionRow\\\" align=\\\"center\\\">\\n           <label value=\\\"&editBookmarkOverlay.description.label;\\\"\\ndiff --git a/browser/components/places/content/utils.js b/browser/components/places/content/utils.js\\nindex 40fa901..904a25b 100644\\n--- a/browser/components/places/content/utils.js\\n+++ b/browser/components/places/content/utils.js\\n@@ -1495,7 +1495,7 @@ var PlacesUtils = {\\n \\n   /**\\n    * Get the most recently added/modified bookmark for a URL, excluding items\\n-   * under tag containers. -1 is returned if no item is found.\\n+   * under tag or livemark containers. -1 is returned if no item is found.\\n    */\\n   getMostRecentBookmarkForURI:\\n   function PU_getMostRecentBookmarkForURI(aURI) {\\n@@ -1503,10 +1503,12 @@ var PlacesUtils = {\\n     for each (var bk in bmkIds) {\\n       // Find the first folder which isn't a tag container\\n       var folder = this.bookmarks.getFolderIdForItem(bk);\\n-      if (folder == this.placesRootId ||\\n-        this.bookmarks.getFolderIdForItem(folder) != this.tagRootId) {\\n+      if (folder == this.placesRootId)\\n+        return bk;\\n+      var parent = this.bookmarks.getFolderIdForItem(folder)\\n+      if (parent != this.tagRootId &&\\n+          !this.annotations.itemHasAnnotation(parent, \\\"livemark/feedURI\\\"))\\n         return bk;\\n-      }\\n     }\\n     return -1;\\n   }\\ndiff --git a/browser/themes/pinstripe/browser/browser.css b/browser/themes/pinstripe/browser/browser.css\\nindex b506f30..9de75f6e 100755\\n--- a/browser/themes/pinstripe/browser/browser.css\\n+++ b/browser/themes/pinstripe/browser/browser.css\\n@@ -1037,6 +1037,26 @@ toolbarpaletteitem:not([place=\\\"toolbar\\\"]) .search-go-button {\\n   padding: 0px;\\n }\\n \\n+/* STAR BUTTON */\\n+#star-button {\\n+  list-style-image: url(\\\"chrome://browser/skin/places/starPage.png\\\");\\n+  margin: 0;\\n+  padding: 0;\\n+  max-width: 0;\\n+  height: 24px;\\n+}\\n+\\n+#star-button > .toolbarbutton-icon {\\n+  padding: 2px 2px 2px 0;\\n+  border: 1px solid #A3A3A3;\\n+  border-left: 0;\\n+  background: url(\\\"chrome://global/skin/10pct_transparent_grey.png\\\") repeat;\\n+}\\n+\\n+#star-button[starred=\\\"true\\\"] {\\n+  list-style-image: url(\\\"chrome://browser/skin/places/pageStarred.png\\\");\\n+}\\n+\\n /* ----- SIDEBAR ELEMENTS ----- */\\n \\n sidebarheader {\\n@@ -1666,13 +1686,3 @@ toolbarbutton.bookmark-item[dragover=\\\"true\\\"][open=\\\"true\\\"] {\\n   -moz-border-left-colors: ThreeDLightShadow ThreeDHighlight !important;\\n }\\n \\n-/* star icon */\\n-#star-icon {\\n-  list-style-image: url(\\\"chrome://browser/skin/places/starPage.png\\\");\\n-  width: 16px;\\n-  height: 16px;\\n-}\\n-\\n-#star-icon[starred=\\\"true\\\"] {\\n-  list-style-image: url(\\\"chrome://browser/skin/places/pageStarred.png\\\");\\n-}\\ndiff --git a/browser/themes/winstripe/browser/browser.css b/browser/themes/winstripe/browser/browser.css\\nindex 2ca9a55..db53a66 100644\\n--- a/browser/themes/winstripe/browser/browser.css\\n+++ b/browser/themes/winstripe/browser/browser.css\\n@@ -1025,6 +1025,20 @@ toolbar:not([mode=\\\"text\\\"]) #go-button,\\n   padding: 0;\\n }\\n \\n+/* star button */\\n+toolbar:not([mode=\\\"text\\\"]) #star-button,\\n+#palette-box #star-button {\\n+  -moz-appearance: none;\\n+  list-style-image: url(\\\"chrome://browser/skin/places/starPage.png\\\");\\n+  padding: 0;\\n+  border: none;\\n+}\\n+\\n+toolbar:not([mode=\\\"text\\\"]) #star-button[starred=\\\"true\\\"],\\n+#palette-box #star-button[starred=\\\"true\\\"] {\\n+  list-style-image: url(\\\"chrome://browser/skin/places/pageStarred.png\\\");\\n+}\\n+\\n #go-button[chromedir=\\\"rtl\\\"] {\\n   list-style-image: url(\\\"chrome://browser/skin/Go-arrow-rtl.png\\\");\\n }\\n@@ -1928,14 +1942,3 @@ toolbarbutton.bookmark-item[dragover=\\\"true\\\"][open=\\\"true\\\"] {\\n .bookmark-item[dragover-bottom=\\\"true\\\"] {\\n   -moz-border-bottom-colors: #000000;\\n }\\n-\\n-/* star icon */\\n-#star-icon {\\n-  list-style-image: url(\\\"chrome://browser/skin/places/starPage.png\\\");\\n-  width: 16px;\\n-  height: 16px;\\n-}\\n-\\n-#star-icon[starred=\\\"true\\\"] {\\n-  list-style-image: url(\\\"chrome://browser/skin/places/pageStarred.png\\\");\\n-}\\n\""}