{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas651a54c\""},"diff":"\"651a54c Fixing bug 394275. Fix problem with UTF16 to UTF8 character conversions when dealing with broken UTF16 characters. r+sr=jonas@sicking.cc\\ndiff --git a/xpcom/string/public/nsUTF8Utils.h b/xpcom/string/public/nsUTF8Utils.h\\nindex 917a444..5b24366 100644\\n--- a/xpcom/string/public/nsUTF8Utils.h\\n+++ b/xpcom/string/public/nsUTF8Utils.h\\n@@ -603,9 +603,16 @@ class ConvertUTF16toUTF8\\n                 ++p;\\n                 if (p == end)\\n                   {\\n-                    NS_ERROR(\\\"Surrogate pair split between fragments\\\");\\n-                    mBuffer = out;\\n-                    return N;\\n+                    // Treat broken characters as the Unicode\\n+                    // replacement character 0xFFFD (0xEFBFBD in\\n+                    // UTF-8)\\n+                    *out++ = 0xEF;\\n+                    *out++ = 0xBF;\\n+                    *out++ = 0xBD;\\n+\\n+                    NS_WARNING(\\\"String ending in half a surrogate pair!\\\");\\n+\\n+                    break;\\n                   }\\n                 c = *p;\\n \\n@@ -692,8 +699,14 @@ class CalculateUTF8Size\\n                 ++p;\\n                 if (p == end)\\n                   {\\n-                    NS_ERROR(\\\"Surrogate pair split between fragments\\\");\\n-                    return N;\\n+                    // Treat broken characters as the Unicode\\n+                    // replacement character 0xFFFD (0xEFBFBD in\\n+                    // UTF-8)\\n+                    mSize += 3;\\n+\\n+                    NS_WARNING(\\\"String ending in half a surrogate pair!\\\");\\n+\\n+                    break;\\n                   }\\n                 c = *p;\\n \\n\""}