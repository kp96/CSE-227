{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas766c82a\""},"diff":"\"766c82a Fixing bug 394534. Make first attribute win in misplaced content. Patch by bzbarsky@mit.edu, r=mrbkap@gmail.com, sr=peterv@propagandism.org, a=jonas@sicking.cc/dsicore@mozilla.com\\ndiff --git a/layout/reftests/bugs/reftest.list b/layout/reftests/bugs/reftest.list\\nindex 66508eb..5278448 100644\\n--- a/layout/reftests/bugs/reftest.list\\n+++ b/layout/reftests/bugs/reftest.list\\n@@ -377,3 +377,4 @@ random-if(MOZ_WIDGET_TOOLKIT==\\\"cocoa\\\") == 379316-2.html 379316-2-ref.html # bug\\n == 393671-2.html 393671-2-ref.html\\n == 393671-3.html 393671-3-ref.html\\n == 394111-1.html about:blank  # Really an assertion test rather than a rendering test\\n+== 394534-1.html 394534-1-ref.html\\ndiff --git a/parser/htmlparser/src/CNavDTD.cpp b/parser/htmlparser/src/CNavDTD.cpp\\nindex 8f6e1a0..d004e7a 100644\\n--- a/parser/htmlparser/src/CNavDTD.cpp\\n+++ b/parser/htmlparser/src/CNavDTD.cpp\\n@@ -1062,7 +1062,7 @@ PushMisplacedAttributes(nsIParserNode& aNode, nsDeque& aDeque)\\n   nsCParserNode& theAttrNode = static_cast<nsCParserNode &>(aNode);\\n \\n   for (PRInt32 count = aNode.GetAttributeCount(); count > 0; --count) {\\n-    CToken* theAttrToken = theAttrNode.PopAttributeToken();\\n+    CToken* theAttrToken = theAttrNode.PopAttributeTokenFront();\\n     if (theAttrToken) {\\n       theAttrToken->SetNewlineCount(0);\\n       aDeque.Push(theAttrToken);\\n@@ -1742,14 +1742,19 @@ CNavDTD::HandleSavedTokens(PRInt32 anIndex)\\n         if (theToken) {\\n           theTag       = (eHTMLTags)theToken->GetTypeID();\\n           attrCount    = theToken->GetAttributeCount();\\n-          // Put back attributes, which once got popped out, into the tokenizer\\n+          // Put back attributes, which once got popped out, into the\\n+          // tokenizer.  Make sure we preserve their ordering, however!\\n+          // XXXbz would it be faster to get the tokens out with ObjectAt and\\n+          // the PopFront them all?\\n+          nsDeque temp;\\n           for (PRInt32 j = 0; j < attrCount; ++j) {\\n             CToken* theAttrToken = (CToken*)mMisplacedContent.PopFront();\\n             if (theAttrToken) {\\n-              mTokenizer->PushTokenFront(theAttrToken);\\n+              temp.Push(theAttrToken);\\n             }\\n             theBadTokenCount--;\\n           }\\n+          mTokenizer->PrependTokens(temp);\\n \\n           if (eToken_end == theToken->GetTokenType()) {\\n             // Ref: Bug 25202\\ndiff --git a/parser/htmlparser/src/nsParserNode.cpp b/parser/htmlparser/src/nsParserNode.cpp\\nindex 493f561..6646032 100644\\n--- a/parser/htmlparser/src/nsParserNode.cpp\\n+++ b/parser/htmlparser/src/nsParserNode.cpp\\n@@ -264,6 +264,11 @@ nsCParserNode::PopAttributeToken() {\\n   return 0;\\n }\\n \\n+CToken* \\n+nsCParserNode::PopAttributeTokenFront() {\\n+  return 0;\\n+}\\n+\\n /** Retrieve a string containing the tag and its attributes in \\\"source\\\" form\\n  * @update\\trickg 06June2000\\n  * @return  void\\n@@ -353,6 +358,12 @@ nsCParserStartNode::PopAttributeToken()\\n   return static_cast<CToken*>(mAttributes.Pop());\\n }\\n \\n+CToken* \\n+nsCParserStartNode::PopAttributeTokenFront() \\n+{\\n+  return static_cast<CToken*>(mAttributes.PopFront());\\n+}\\n+\\n void nsCParserStartNode::GetSource(nsString& aString) const\\n {\\n   aString.Assign(PRUnichar('<'));\\ndiff --git a/parser/htmlparser/src/nsParserNode.h b/parser/htmlparser/src/nsParserNode.h\\nindex 0353cd3..34214bf 100644\\n--- a/parser/htmlparser/src/nsParserNode.h\\n+++ b/parser/htmlparser/src/nsParserNode.h\\n@@ -239,6 +239,9 @@ class nsCParserNode :  public nsIParserNode {\\n      */\\n     virtual CToken* PopAttributeToken();\\n \\n+    /** Like PopAttributeToken, but pops off the front of the attribute list */\\n+    virtual CToken* PopAttributeTokenFront();\\n+\\n     /** Retrieve a string containing the tag and its attributes in \\\"source\\\" form\\n      * @update\\trickg 06June2000\\n      * @return  void\\n@@ -314,6 +317,7 @@ public:\\n     virtual const    nsAString& GetKeyAt(PRUint32 anIndex) const;\\n     virtual const    nsAString& GetValueAt(PRUint32 anIndex) const;\\n     virtual CToken*  PopAttributeToken();\\n+    virtual CToken*  PopAttributeTokenFront();\\n     virtual void     GetSource(nsString& aString) const;\\n     virtual nsresult ReleaseAll();\\n protected:\\n\""}