{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas989760a\""},"diff":"\"989760a bug 203102 - Investigate/port patches for URL field... Tab browser should remember user's typed value when switching tabs. Also, prevent about:blank from showing up when it shouldn't. Based on a patch by Will Levine <yakgoatcamel@myrealbox.com> with some modifications.\\ndiff --git a/browser/base/content/tabbrowser.xml b/browser/base/content/tabbrowser.xml\\nindex fd96d5a..a7d005f 100644\\n--- a/browser/base/content/tabbrowser.xml\\n+++ b/browser/base/content/tabbrowser.xml\\n@@ -154,14 +154,15 @@\\n \\n       <!-- A web progress listener object definition for a given tab. -->\\n       <method name=\\\"mTabProgressListener\\\">\\n-        <parameter name=\\\"aTabBrowser\\\"/>\\n         <parameter name=\\\"aTab\\\"/>\\n+        <parameter name=\\\"aBrowser\\\"/>\\n         <parameter name=\\\"aStartsBlank\\\"/>\\n         <body>\\n         <![CDATA[\\n           return ({\\n-            mTabBrowser: aTabBrowser,\\n+            mTabBrowser: this,\\n             mTab: aTab,\\n+            mBrowser: aBrowser,\\n             mBlank: aStartsBlank,\\n             mIcon: \\\"\\\", \\n \\n@@ -189,15 +190,23 @@\\n \\n               const nsIWebProgressListener = Components.interfaces.nsIWebProgressListener;\\n               const nsIChannel = Components.interfaces.nsIChannel;\\n-              if (!this.mBlank && aStateFlags & nsIWebProgressListener.STATE_START && \\n-                  aStateFlags & nsIWebProgressListener.STATE_IS_NETWORK) {\\n-                this.mTab.setAttribute(\\\"busy\\\", \\\"true\\\"); \\n-                this.mTab.label = this.mTabBrowser.mStringBundle.getString(\\\"tabs.loading\\\");\\n-                this.mTab.removeAttribute(\\\"image\\\");\\n-                this.mIcon = \\\"\\\";\\n \\n-                if (this.mTabBrowser.mCurrentTab == this.mTab)\\n-                  this.mTabBrowser.mIsBusy = true;\\n+              if (aStateFlags & nsIWebProgressListener.STATE_START && \\n+                  aStateFlags & nsIWebProgressListener.STATE_IS_NETWORK) {\\n+                // Reset so we can see if the user typed between the document\\n+                // load starting and the location changing.\\n+                if (aWebProgress.DOMWindow == this.mBrowser.contentWindow)\\n+                  this.mBrowser.userTypedValue = null;\\n+\\n+                if (!this.mBlank) {\\n+                  this.mTab.setAttribute(\\\"busy\\\", \\\"true\\\");\\n+                  this.mTab.label = this.mTabBrowser.mStringBundle.getString(\\\"tabs.loading\\\");\\n+                  this.mTab.removeAttribute(\\\"image\\\"); \\n+                  this.mIcon = \\\"\\\";\\n+\\n+                  if (this.mTabBrowser.mCurrentTab == this.mTab)\\n+                    this.mTabBrowser.mIsBusy = true;\\n+                }\\n               }\\n               else if (aStateFlags & nsIWebProgressListener.STATE_STOP &&\\n                        aStateFlags & nsIWebProgressListener.STATE_IS_NETWORK) {\\n@@ -666,7 +675,7 @@\\n             }\\n \\n             // Wire up a progress listener to our filter.\\n-            const listener = (this.mTabProgressListener)(this, this.mCurrentTab, false);\\n+            const listener = this.mTabProgressListener(this.mCurrentTab, this.mCurrentBrowser, false);\\n             filter.addProgressListener(listener, Components.interfaces.nsIWebProgress.NOTIFY_ALL);\\n             this.mTabListeners[0] = listener;\\n           ]]>\\n@@ -725,7 +734,7 @@\\n \\n             // wire up a progress listener for the new browser object.\\n             var position = this.mTabContainer.childNodes.length-1;\\n-            var tabListener = (this.mTabProgressListener)(this, t, blank);\\n+            var tabListener = this.mTabProgressListener(t, b, blank);\\n             const filter = Components.classes[\\\"@mozilla.org/appshell/component/browser-status-filter;1\\\"]\\n                                      .createInstance(Components.interfaces.nsIWebProgress);\\n             filter.addProgressListener(tabListener, Components.interfaces.nsIWebProgress.NOTIFY_ALL);\\n@@ -1240,10 +1249,14 @@\\n                 onget=\\\"return this.mCurrentBrowser.canFindAgain;\\\"\\n                 readonly=\\\"true\\\"/>\\n \\n+      <property name=\\\"userTypedValue\\\"\\n+                onget=\\\"return this.mCurrentBrowser.userTypedValue;\\\"\\n+                onset=\\\"return this.mCurrentBrowser.userTypedValue = val;\\\"/>\\n+\\n       <constructor>\\n         <![CDATA[\\n-        this.mCurrentBrowser = this.mPanelContainer.firstChild;\\n-        this.mCurrentTab = this.mTabContainer.firstChild;\\n+          this.mCurrentBrowser = this.mPanelContainer.firstChild;\\n+          this.mCurrentTab = this.mTabContainer.firstChild;\\n         ]]>\\n       </constructor>\\n \\n\""}