{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Base2da917\""},"diff":"\"e2da917 Bug 175893 Make XUL <tab>'s focusable Bug 251513 content of tabs not focused to keyboard scrolling when switching tabs Relanding relevant parts of patches following aviary branch landing\\ndiff --git a/browser/base/content/tabbrowser.xml b/browser/base/content/tabbrowser.xml\\nindex e42f533..e85bbec 100644\\n--- a/browser/base/content/tabbrowser.xml\\n+++ b/browser/base/content/tabbrowser.xml\\n@@ -51,7 +51,7 @@\\n \\n     <content>\\n       <xul:stringbundle src=\\\"chrome://global/locale/tabbrowser.properties\\\"/>\\n-      <xul:tabbox flex=\\\"1\\\" eventnode=\\\"document\\\" xbl:inherits=\\\"handleCtrlPageUpDown\\\"\\n+      <xul:tabbox flex=\\\"1\\\" eventnode=\\\"document\\\" xbl:inherits=\\\"handleCtrlPageUpDown\\\" eventnode=\\\"document\\\"\\n                   onselect=\\\"if (!('updateCurrentBrowser' in this.parentNode) || event.target.localName != 'tabpanels') return; this.parentNode.updateCurrentBrowser();\\\">\\n         <xul:hbox class=\\\"tabbrowser-strip chromeclass-toolbar\\\" collapsed=\\\"true\\\" tooltip=\\\"_child\\\" context=\\\"_child\\\">\\n           <xul:tooltip onpopupshowing=\\\"event.preventBubble(); if (document.tooltipNode.hasAttribute('label')) { this.setAttribute('label', document.tooltipNode.getAttribute('label')); return true; } return false;\\\"/>\\n@@ -542,7 +542,11 @@\\n             if (this.mCurrentBrowser) {\\n               this.mCurrentBrowser.focusedWindow = document.commandDispatcher.focusedWindow;\\n               this.mCurrentBrowser.focusedElement = document.commandDispatcher.focusedElement;\\n-               this.mCurrentBrowser.setAttribute(\\\"type\\\", \\\"content\\\");\\n+              if (this.mCurrentBrowser.focusedElement) {\\n+                // Clear focus outline before we draw on top of it\\n+                this.mCurrentBrowser.focusedElement.blur();\\n+              }\\n+              this.mCurrentBrowser.setAttribute(\\\"type\\\", \\\"content\\\");\\n             }\\n             \\n             var updatePageReport = false;\\n@@ -617,24 +621,34 @@\\n               }\\n             }\\n \\n-            function setFocus(element) {\\n-              Components.lookupMethod(element, \\\"focus\\\").call(element);\\n+            if (document.commandDispatcher.focusedElement &&\\n+                document.commandDispatcher.focusedElement.parentNode ==\\n+                this.mCurrentTab.parentNode) {\\n+              // The focus is on a tab in the same tab panel\\n+              return;  // If focus was on a tab, switching tabs focuses the new tab\\n             }\\n \\n+            var whatToFocus = window.content;\\n+\\n             // Focus the previously focused element or window\\n-            document.commandDispatcher.suppressFocusScroll = true;\\n             if (newBrowser.focusedElement) {\\n-              try {\\n-                setFocus(newBrowser.focusedElement);\\n-              } catch (e) {\\n-                setFocus(newBrowser.focusedWindow);\\n+              if (newBrowser.focusedElement.parentNode !=\\n+                  this.mCurrentTab.parentNode) {\\n+                // Focus the remembered element unless it's in the current tab panel\\n+                whatToFocus = newBrowser.focusedElement;\\n               }\\n             }\\n-            else if (newBrowser.focusedWindow)\\n-              setFocus(newBrowser.focusedWindow);\\n-            else // new tab, focus our new content area\\n-              setTimeout(setFocus, 0, window.content);\\n-            document.commandDispatcher.suppressFocusScroll = false;    \\n+            else if (newBrowser.focusedWindow) {\\n+              whatToFocus = newBrowser.focusedWindow;\\n+            }\\n+\\n+            function setFocus(element) {\\n+              document.commandDispatcher.suppressFocusScroll = true;\\n+              Components.lookupMethod(element, \\\"focus\\\").call(element);\\n+              document.commandDispatcher.suppressFocusScroll = false;    \\n+            }\\n+\\n+            setTimeout(setFocus, 0, window.content);\\n           ]]>\\n         </body>\\n       </method>\\n@@ -1594,6 +1608,7 @@\\n         <![CDATA[\\n           this.mCurrentBrowser = this.getBrowserAtIndex(0);\\n           this.mCurrentTab = this.mTabContainer.firstChild;\\n+          this.mTabBox.handleCtrlTab = !/Mac/.test(navigator.platform);\\n           document.addEventListener(\\\"keypress\\\", this._keyEventHandler, false);\\n         ]]>\\n       </constructor>\\n\""}