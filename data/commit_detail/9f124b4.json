{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas9f124b4\""},"diff":"\"9f124b4 Relanding bug 383183 with some additional perf fixes: include an identity indicator in primary chrome, patch by Johnathan Nightingale <johnath@mozilla.com>, r=me\\ndiff --git a/browser/base/content/browser.js b/browser/base/content/browser.js\\nindex 91091fb..32927ae 100644\\n--- a/browser/base/content/browser.js\\n+++ b/browser/base/content/browser.js\\n@@ -3698,9 +3698,8 @@ nsBrowserStatusHandler.prototype =\\n \\n     var securityUI = gBrowser.securityUI;\\n     this.securityButton.setAttribute(\\\"tooltiptext\\\", securityUI.tooltipText);\\n-    var lockIcon = document.getElementById(\\\"lock-icon\\\");\\n-    if (lockIcon)\\n-      lockIcon.setAttribute(\\\"tooltiptext\\\", securityUI.tooltipText);\\n+    \\n+    getIdentityHandler().checkIdentity(aWebProgress, aRequest, aState);\\n   },\\n \\n   // simulate all change notifications after switching tabs\\n@@ -5583,3 +5582,201 @@ function showToolbars() {\\n   \\n   return false; // Dismiss the notification message\\n }\\n+\\n+/**\\n+ * Utility class to handle manipulations of the identity indicators in the UI\\n+ */\\n+function IdentityHandler() {}\\n+\\n+IdentityHandler.prototype = {\\n+\\n+  // Mode strings used to control CSS display\\n+  IDENTITY_MODE_IDENTIFIED       : \\\"verifiedIdentity\\\", // High-quality identity information\\n+  IDENTITY_MODE_DOMAIN_VERIFIED  : \\\"verifiedDomain\\\",   // Minimal SSL CA-signed domain verification\\n+  IDENTITY_MODE_UNKNOWN          : \\\"unknownIdentity\\\",  // No trusted identity information\\n+\\n+  // Cache the most recently seen SSLStatus and URI to prevent unnecessary updates\\n+  _lastStatus : null,\\n+  _lastURI : null,\\n+\\n+  /**\\n+   * Handler for mouseclicks on the \\\"Tell me more about this website\\\" link text\\n+   * in the \\\"identity-popup\\\" panel.\\n+   */\\n+  handleMoreInfoClick : function(event) {\\n+    if (event.button == 0) {\\n+      displaySecurityInfo();\\n+      event.stopPropagation();\\n+    }   \\n+  },\\n+  \\n+  /**\\n+   * Determine the identity of the page being displayed by examining its SSL cert\\n+   * (if available) and, if necessary, update the UI to reflect this.  Intended to\\n+   * be called by an nsIWebProgressListener.\\n+   *\\n+   * @param nsIWebProgress webProgress\\n+   * @param nsIRequest request\\n+   * @param PRUint32 state\\n+   */\\n+  checkIdentity : function(webProgress, request, state) {\\n+    var currentStatus = gBrowser.securityUI\\n+                                .QueryInterface(Components.interfaces.nsISSLStatusProvider)\\n+                                .SSLStatus;\\n+    var currentURI = gBrowser.currentURI;\\n+    if (currentStatus == this._lastStatus && currentURI == this._lastURI) {\\n+      // No need to update, this is a no-op check\\n+      return;\\n+    }\\n+\\n+    this._lastStatus = currentStatus;\\n+    this._lastURI = currentURI;\\n+    \\n+    if (state & Components.interfaces.nsIWebProgressListener.STATE_IDENTITY_EV_TOPLEVEL)\\n+      this.setMode(this.IDENTITY_MODE_IDENTIFIED);\\n+    else if (state & Components.interfaces.nsIWebProgressListener.STATE_SECURE_HIGH)\\n+      this.setMode(this.IDENTITY_MODE_DOMAIN_VERIFIED);\\n+    else\\n+      this.setMode(this.IDENTITY_MODE_UNKNOWN);\\n+  },\\n+  \\n+  /**\\n+   * Update the UI to reflect the specified mode, which should be one of the\\n+   * IDENTITY_MODE_* constants.\\n+   */\\n+  setMode : function(newMode) {\\n+    document.getElementById(\\\"identity-popup\\\").className = newMode;\\n+    document.getElementById(\\\"identity-box\\\").className = newMode;\\n+    document.getElementById(\\\"identity-popup-content-box\\\").className = newMode;\\n+    this.setMessages(newMode);\\n+  },\\n+  \\n+  /**\\n+   * Set up the title and content messages for the identity message bubble, and\\n+   * primary UI based on the specified mode, and the details of the SSL cert, where\\n+   * applicable\\n+   *\\n+   * @param newMode The newly set identity mode.  Should be one of the IDENTITY_MODE_* constants.\\n+   */\\n+  setMessages : function(newMode) {\\n+      \\n+    var stringBundle = document.getElementById(\\\"bundle_browser\\\");\\n+    \\n+    // Initialize the optional strings to empty values\\n+    var supplemental = \\\"\\\";\\n+    var verifier = \\\"\\\";\\n+      \\n+    if (newMode == this.IDENTITY_MODE_DOMAIN_VERIFIED) {\\n+      var title = stringBundle.getString(\\\"identity.domainverified.title\\\");\\n+      var encryption_label = stringBundle.getString(\\\"identity.encrypted\\\");\\n+      var status = this._lastStatus.QueryInterface(Components.interfaces.nsISSLStatus);\\n+      var cert = status.serverCert;\\n+\\n+      // It would be sort of nice to use the CN= field in the cert, since that's\\n+      // typically what we want here, but thanks to x509 certs being extensible,\\n+      // it's not the only place you have to check, there can be more than one domain,\\n+      // et cetera, ad nauseum.  We know the cert is valid for location.host, so\\n+      // let's just use that, it's what the status bar does too.\\n+      var body = this._lastURI.host;\\n+      var caOrg = cert.issuerOrganization || cert.issuerCommonName;      \\n+      verifier = stringBundle.getFormattedString(\\\"identity.identified.verifier\\\",\\n+                                                 [caOrg]);\\n+      supplemental = stringBundle.getString(\\\"identity.domainverified.supplemental\\\");\\n+      \\n+      var icon_label = body;\\n+      var tooltip = verifier;\\n+    }\\n+    else if (newMode == this.IDENTITY_MODE_IDENTIFIED) {\\n+      title = stringBundle.getString(\\\"identity.identified.title\\\");\\n+      encryption_label = stringBundle.getString(\\\"identity.encrypted\\\");\\n+  \\n+      // If it's identified, then we can populate the dialog with credentials\\n+      status = this._lastStatus.QueryInterface(Components.interfaces.nsISSLStatus);\\n+      cert = status.serverCert;\\n+\\n+      // Pull the basics out with fallback options in case common\\n+      // (optional) fields are left blank\\n+      body = cert.organization || cert.commonName;\\n+      caOrg = cert.issuerOrganization || cert.issuerCommonName;        \\n+      verifier = tooltip = stringBundle.getFormattedString(\\\"identity.identified.verifier\\\",\\n+                                                           [caOrg]);\\n+            \\n+      // Now try to extract out supplemental location fields and append\\n+      // them, where available.  subjectName is a comma-delimited list of\\n+      // key=value pairs.\\n+      if (cert.subjectName) {\\n+        var subjectNameFields = {};\\n+        cert.subjectName.split(\\\",\\\").forEach(function(v) {\\n+          var field = v.split(\\\"=\\\");\\n+          this[field[0]] = field[1];\\n+        }, subjectNameFields);\\n+\\n+        if (subjectNameFields.L) // City\\n+          supplemental += subjectNameFields.L + \\\"\\\\n\\\";\\n+                \\n+        if (subjectNameFields.ST && subjectNameFields.C) // State and Country\\n+          supplemental += stringBundle.getFormattedString(\\\"identity.identified.state_and_country\\\",\\n+                                                          [subjectNameFields.ST,\\n+                                                          subjectNameFields.C]);\\n+        else if (subjectNameFields.ST) // State only\\n+          supplemental += subjectNameFields.ST;\\n+        else if (subjectNameFields.C) // Country only\\n+          supplemental += subjectNameFields.C;\\n+          \\n+        // Include country code in top-level label, if we have one\\n+        if (subjectNameFields.C)\\n+          icon_label = stringBundle.getFormattedString(\\\"identity.identified.title_with_country\\\",\\n+                                                       [body, subjectNameFields.C]);\\n+        else\\n+          icon_label = body;\\n+      }\\n+    }\\n+    else {\\n+      encryption_label = stringBundle.getString(\\\"identity.unencrypted\\\");\\n+      title = stringBundle.getString(\\\"identity.unknown.title\\\");\\n+      body = stringBundle.getString(\\\"identity.unknown.body\\\");\\n+      icon_label = \\\"\\\";\\n+      tooltip = body;\\n+    }\\n+    \\n+    // Push the appropriate strings out to the UI\\n+    document.getElementById(\\\"identity-popup-title\\\").value = title;\\n+    document.getElementById(\\\"identity-popup-content\\\").textContent = body;\\n+    document.getElementById(\\\"identity-popup-content-supplemental\\\")\\n+            .textContent = supplemental;\\n+    document.getElementById(\\\"identity-popup-content-verifier\\\")\\n+            .textContent = verifier;\\n+    document.getElementById(\\\"identity-popup-encryption-label\\\")\\n+            .textContent = encryption_label;\\n+    document.getElementById(\\\"identity-box\\\").tooltipText = tooltip;\\n+    document.getElementById(\\\"identity-icon-label\\\").value = icon_label;\\n+  },\\n+  \\n+  /**\\n+   * Click handler for the identity-box element in primary chrome.  \\n+   */\\n+  handleMouseUp : function(event) {\\n+    if (event.button != 0)\\n+      return; // We only want left-clicks\\n+        \\n+    // Make sure that the display:none style we set in xul is removed now that\\n+    // the popup is actually needed\\n+    var popup = document.getElementById('identity-popup');\\n+    popup.hidden = false;\\n+    \\n+    // Now open the popup, anchored off the primary chrome element\\n+    popup.openPopup(document.getElementById('identity-box'), 'after_start');\\n+  }\\n+};\\n+\\n+var gIdentityHandler; \\n+\\n+/**\\n+ * Returns the singleton instance of the identity handler class.  Should always be\\n+ * used instead of referencing the global variable directly or creating new instances\\n+ */\\n+function getIdentityHandler() {\\n+  if (!gIdentityHandler)\\n+    gIdentityHandler = new IdentityHandler();\\n+  return gIdentityHandler;    \\n+}\\ndiff --git a/browser/base/content/browser.xul b/browser/base/content/browser.xul\\nindex f6e162c..066844c 100644\\n--- a/browser/base/content/browser.xul\\n+++ b/browser/base/content/browser.xul\\n@@ -28,6 +28,7 @@\\n #   Joe Hewitt <hewitt@netscape.com>\\n #   Pierre Chanial <chanial@noos.fr>\\n #   Dean Tessman <dean_tessman@hotmail.com>\\n+#   Johnathan Nightingale <johnath@mozilla.com>\\n #\\n # Alternatively, the contents of this file may be used under the terms of\\n # either the GNU General Public License Version 2 or later (the \\\"GPL\\\"), or\\n@@ -136,6 +137,34 @@\\n \\n     <popup id=\\\"placesContext\\\"/>\\n \\n+    <!-- Popup for site identity information -->\\n+    <panel id=\\\"identity-popup\\\" position=\\\"after_start\\\" hidden=\\\"true\\\">\\n+      <hbox id=\\\"identity-popup-container\\\" align=\\\"top\\\">\\n+        <image id=\\\"identity-popup-icon\\\"/>\\n+        <vbox id=\\\"identity-popup-content-box\\\">\\n+          <!-- Title Bar -->\\n+          <label id=\\\"identity-popup-title\\\"/>\\n+          <!-- Content area -->\\n+          <description id=\\\"identity-popup-content\\\"/>\\n+          <description id=\\\"identity-popup-content-supplemental\\\"/>\\n+          <description id=\\\"identity-popup-content-verifier\\\"/>\\n+          <hbox id=\\\"identity-popup-encryption\\\" flex=\\\"1\\\">\\n+            <vbox>\\n+              <image id=\\\"identity-popup-encryption-icon\\\"/>\\n+              <spacer flex=\\\"1\\\"/>\\n+            </vbox>\\n+            <description id=\\\"identity-popup-encryption-label\\\" flex=\\\"1\\\"/>\\n+          </hbox>\\n+          <spacer flex=\\\"1\\\"/>\\n+          <!-- Footer link to page info -->\\n+          <label id=\\\"identity-popup-more-info-link\\\"\\n+                 class=\\\"text-link plain\\\"\\n+                 value=\\\"&identity.moreInfoLinkText;\\\"\\n+                 onclick=\\\"getIdentityHandler().handleMoreInfoClick(event);\\\"/>\\n+        </vbox>\\n+      </hbox>\\n+    </panel>\\n+\\n     <tooltip id=\\\"urlTooltip\\\">\\n       <label crop=\\\"center\\\" flex=\\\"1\\\"/>\\n     </tooltip>\\n@@ -231,19 +260,25 @@\\n                      oninput=\\\"gBrowser.userTypedValue = this.value\\\"\\n                      ontextentered=\\\"return handleURLBarCommand(param);\\\"\\n                      ontextreverted=\\\"return handleURLBarRevert();\\\">\\n-              <deck id=\\\"page-proxy-deck\\\" onclick=\\\"PageProxyClickHandler(event);\\\">\\n-                <image id=\\\"page-proxy-button\\\"\\n-                        ondraggesture=\\\"PageProxyDragGesture(event);\\\"\\n-                        tooltiptext=\\\"&proxyIcon.tooltip;\\\"/>\\n-                <image id=\\\"page-proxy-favicon\\\" validate=\\\"never\\\"\\n-                        ondraggesture=\\\"PageProxyDragGesture(event);\\\"\\n-                        onload=\\\"this.parentNode.selectedIndex = 1;\\n-                                event.stopPropagation();\\\"\\n-                        onerror=\\\"gBrowser.addToMissedIconCache(this.src);\\n-                                 this.removeAttribute('src');\\n-                                 this.parentNode.selectedIndex = 0;\\\"\\n-                        tooltiptext=\\\"&proxyIcon.tooltip;\\\"/>\\n-              </deck>\\n+              <!-- Use onmouseup instead of normal popup= syntax since the popup\\n+                   code fires onmousedown, and hence eats our favicon drag events -->\\n+              <box id=\\\"identity-box\\\" align=\\\"center\\\"\\n+                   onmouseup=\\\"getIdentityHandler().handleMouseUp(event);\\\">\\n+                <deck id=\\\"page-proxy-deck\\\" onclick=\\\"PageProxyClickHandler(event);\\\">\\n+                  <image id=\\\"page-proxy-button\\\"\\n+                         ondraggesture=\\\"PageProxyDragGesture(event);\\\"\\n+                         tooltiptext=\\\"&proxyIcon.tooltip;\\\"/>\\n+                  <image id=\\\"page-proxy-favicon\\\" validate=\\\"never\\\"\\n+                         ondraggesture=\\\"PageProxyDragGesture(event);\\\"\\n+                         onload=\\\"this.parentNode.selectedIndex = 1;\\n+                                 event.stopPropagation();\\\"\\n+                         onerror=\\\"gBrowser.addToMissedIconCache(this.src);\\n+                                  this.removeAttribute('src');\\n+                                  this.parentNode.selectedIndex = 0;\\\"\\n+                         tooltiptext=\\\"&proxyIcon.tooltip;\\\"/>\\n+                </deck>\\n+                <label id=\\\"identity-icon-label\\\"/>\\n+              </box> \\n               <hbox id=\\\"urlbar-icons\\\">\\n                 <button type=\\\"menu\\\"\\n                         style=\\\"-moz-user-focus: none\\\"\\n@@ -256,7 +291,6 @@\\n                              oncommand=\\\"return FeedHandler.subscribeToFeed(null, event);\\\"\\n                              onclick=\\\"checkForMiddleClick(this, event);\\\"/>\\n                 </button>\\n-                <image id=\\\"lock-icon\\\" onclick=\\\"if (event.button == 0) displaySecurityInfo(); event.stopPropagation();\\\"/>\\n #ifdef MOZ_SAFE_BROWSING\\n                 <image id=\\\"safebrowsing-urlbar-icon\\\" tooltiptext=\\\"&safeb.urlbaricon.tooltip;\\\"\\n                        level=\\\"safe\\\"\\ndiff --git a/browser/base/content/urlbarBindings.xml b/browser/base/content/urlbarBindings.xml\\nindex c576c23..ac0cad8 100644\\n--- a/browser/base/content/urlbarBindings.xml\\n+++ b/browser/base/content/urlbarBindings.xml\\n@@ -46,7 +46,7 @@\\n   <binding id=\\\"urlbar\\\" extends=\\\"chrome://global/content/bindings/autocomplete.xml#autocomplete\\\">\\n     <content sizetopopup=\\\"pref\\\">\\n       <xul:hbox class=\\\"autocomplete-textbox-container\\\" flex=\\\"1\\\">\\n-        <children includes=\\\"image|deck|stack\\\">\\n+        <children includes=\\\"image|deck|stack|box\\\">\\n           <xul:image class=\\\"autocomplete-icon\\\" allowevents=\\\"true\\\"/>\\n         </children>\\n \\ndiff --git a/browser/components/safebrowsing/content/phishing-afterload-displayer.js b/browser/components/safebrowsing/content/phishing-afterload-displayer.js\\nindex a0b3ecf..09aa7d8 100644\\n--- a/browser/components/safebrowsing/content/phishing-afterload-displayer.js\\n+++ b/browser/components/safebrowsing/content/phishing-afterload-displayer.js\\n@@ -208,7 +208,6 @@ PROT_PhishMsgDisplayerBase.prototype.browserSelected = function() {\\n     this.messageShouldShow_ = true;\\n   }\\n \\n-  this.hideLockIcon_();        // Comes back when we are unselected or unloaded\\n   this.addWarningInUrlbar_();  // Goes away when we are unselected or unloaded\\n \\n   // messageShouldShow might be false if the user dismissed the warning, \\n@@ -234,7 +233,6 @@ PROT_PhishMsgDisplayerBase.prototype.explicitShow = function() {\\n  */\\n PROT_PhishMsgDisplayerBase.prototype.browserUnselected = function() {\\n   this.removeWarningInUrlbar_();\\n-  this.unhideLockIcon_();\\n   if (this.messageShowing_)\\n     this.hideMessage_();\\n }\\n@@ -290,7 +288,6 @@ PROT_PhishMsgDisplayerBase.prototype.done = function() {\\n     // If we were started, we must be the current problem, so these things\\n     // must be showing\\n     this.removeWarningInUrlbar_();\\n-    this.unhideLockIcon_();\\n \\n     // Could be though that they've closed the warning dialog\\n     if (this.messageShowing_)\\n@@ -328,28 +325,6 @@ PROT_PhishMsgDisplayerBase.prototype.removeIfExists_ = function(orig,\\n }\\n \\n /**\\n- * We don't want to confuse users if they land on a phishy page that uses\\n- * SSL, so ensure that the lock icon never shows when we're showing our \\n- * warning.\\n- */\\n-PROT_PhishMsgDisplayerBase.prototype.hideLockIcon_ = function() {\\n-  var lockIcon = this.doc_.getElementById(\\\"lock-icon\\\");\\n-  if (!lockIcon)\\n-    return;\\n-  lockIcon.hidden = true;\\n-}\\n-\\n-/**\\n- * Ensure they can see it after our warning is finished.\\n- */\\n-PROT_PhishMsgDisplayerBase.prototype.unhideLockIcon_ = function() {\\n-  var lockIcon = this.doc_.getElementById(\\\"lock-icon\\\");\\n-  if (!lockIcon)\\n-    return;\\n-  lockIcon.hidden = false;\\n-}\\n-\\n-/**\\n  * This method makes our warning icon visible in the location bar. It will\\n  * be removed only when the problematic document is navigated awy from \\n  * (i.e., when done() is called), and not when the warning is dismissed.\\ndiff --git a/browser/locales/en-US/chrome/browser/browser.dtd b/browser/locales/en-US/chrome/browser/browser.dtd\\nindex 436fe64..ab572e4 100644\\n--- a/browser/locales/en-US/chrome/browser/browser.dtd\\n+++ b/browser/locales/en-US/chrome/browser/browser.dtd\\n@@ -350,3 +350,5 @@\\n \\n <!ENTITY editBookmark.done.label                      \\\"Done\\\">\\n <!ENTITY editBookmark.delete.label                    \\\"Delete\\\">\\n+\\n+<!ENTITY identity.moreInfoLinkText \\\"Tell me more about this web site...\\\">\\ndiff --git a/browser/locales/en-US/chrome/browser/browser.properties b/browser/locales/en-US/chrome/browser/browser.properties\\nindex a0d47a1..139d93e 100644\\n--- a/browser/locales/en-US/chrome/browser/browser.properties\\n+++ b/browser/locales/en-US/chrome/browser/browser.properties\\n@@ -97,3 +97,20 @@ chromelessWindow.warningMessage=The web site at %S has hidden your toolbars.\\n chromelessWindow.warningNoLocation=This web site has hidden your toolbars.\\n chromelessWindow.showToolbarsButton=Show Toolbars\\n chromelessWindow.accessKey=S\\n+\\n+# Identity information\\n+identity.domainverified.title=Location Verified\\n+identity.domainverified.body=You are currently visiting:\\n+identity.domainverified.supplemental=Information identifying the owner of this site may not have been validated.\\n+\\n+identity.identified.title=Identity Verified\\n+identity.identified.body=This website is owned by:\\n+identity.identified.verifier=Verified by: %S\\n+identity.identified.state_and_country=%S, %S\\n+identity.identified.title_with_country=%S (%S)\\n+\\n+identity.unknown.title=Identity Unknown\\n+identity.unknown.body=This web site does not supply identity information.\\n+\\n+identity.encrypted=Your connection to this web site is encrypted to prevent eavesdropping.\\n+identity.unencrypted=Your connection to this web site is not encrypted.\\ndiff --git a/browser/themes/pinstripe/browser/browser.css b/browser/themes/pinstripe/browser/browser.css\\nindex 5905ee3..7fea759 100755\\n--- a/browser/themes/pinstripe/browser/browser.css\\n+++ b/browser/themes/pinstripe/browser/browser.css\\n@@ -827,7 +827,7 @@ toolbar[iconsize=\\\"small\\\"] #paste-button:hover:active {\\n #urlbar {\\n   margin-top: 5px;\\n   margin-bottom: 5px;\\n-  -moz-margin-start: 4px;\\n+  -moz-margin-start: 0px;\\n   -moz-margin-end: 0px;\\n   width: 7em;\\n   min-width: 7em;\\n@@ -879,46 +879,6 @@ toolbar[iconsize=\\\"small\\\"] #paste-button:hover:active {\\n   background: url(\\\"chrome://browser/skin/Secure-background.gif\\\") #FFFED8 repeat-x;\\n }\\n \\n-#urlbar #lock-icon {\\n-  height: 18px;\\n-  margin: -1px;\\n-}\\n-\\n-#urlbar[level=\\\"high\\\"] #lock-icon {\\n-  list-style-image: url(\\\"chrome://browser/skin/Secure.png\\\");\\n-  -moz-image-region: rect(0px, 18px, 18px, 0px);\\n-}\\n-#urlbar[level=\\\"high\\\"] #lock-icon:hover {\\n-  -moz-image-region: rect(18px, 18px, 36px, 0px);\\n-}\\n-#urlbar[level=\\\"high\\\"] #lock-icon:active {\\n-  -moz-image-region: rect(36px, 18px, 54px, 0px);\\n-}\\n-\\n-#urlbar[level=\\\"low\\\"] #lock-icon {\\n-  list-style-image: url(\\\"chrome://browser/skin/Secure.png\\\");\\n-  -moz-image-region: rect(0px, 18px, 18px, 0px);\\n-}\\n-#urlbar[level=\\\"low\\\"] #lock-icon:hover {\\n-  -moz-image-region: rect(18px, 18px, 36px, 0px);\\n-}\\n-#urlbar[level=\\\"low\\\"] #lock-icon:active {\\n-  -moz-image-region: rect(36px, 18px, 54px, 0px);\\n-}\\n-\\n-#urlbar[level=\\\"broken\\\"] #lock-icon {\\n-  list-style-image: url(\\\"chrome://browser/skin/Security-broken.png\\\");\\n-  -moz-image-region: rect(0px, 18px, 18px, 0px);\\n-}\\n-\\n-#urlbar[level=\\\"broken\\\"] #lock-icon:hover {\\n-  -moz-image-region: rect(18px, 18px, 36px, 0px);\\n-}\\n-\\n-#urlbar[level=\\\"broken\\\"] #lock-icon:active {\\n-  -moz-image-region: rect(36px, 18px, 54px, 0px);\\n-}\\n-\\n #urlbar-container {\\n   -moz-padding-end: 5px;\\n }\\n@@ -1697,3 +1657,116 @@ toolbarbutton.bookmark-item[dragover=\\\"true\\\"][open=\\\"true\\\"] {\\n   -moz-border-left-colors: ThreeDLightShadow ThreeDHighlight !important;\\n }\\n \\n+/* ::::: Identity Indicator Styling ::::: */\\n+/* Location bar visuals*/\\n+#identity-box {\\n+  /* Extend our margins out so that our highlight/separator bar covers the\\n+    location bar properly */\\n+  margin: -1px 0 -2px;\\n+  padding: 1px 2px 2px 0;\\n+  border-right: 1px solid #888;\\n+  background-color: white;\\n+  opacity: 0.9;\\n+}\\n+\\n+#identity-box:hover {\\n+  opacity: 1.0;\\n+}\\n+\\n+#identity-box.verifiedIdentity {\\n+  background-color: #BFA;\\n+}\\n+\\n+#urlbar[level=\\\"high\\\"] > #identity-box,\\n+#urlbar[level=\\\"low\\\"] > #identity-box {\\n+  /* urlbar adds padding when security level is set, which we need to\\n+  counteract here so that we still fill the background.  */\\n+  margin: -2px;\\n+  padding: 1px 2px;\\n+}\\n+\\n+#identity-icon-label {\\n+    padding: 1px 2px 2px;\\n+    margin: 0;\\n+    color: black;\\n+    vertical-align: middle;\\n+}\\n+\\n+.unknownIdentity > #identity-icon-label {\\n+    display: none;\\n+}\\n+\\n+/* Popup Icons */\\n+#identity-popup-icon {\\n+    height: 64px;\\n+    width: 64px;\\n+    padding: 0;\\n+    margin: 10px 0 0;\\n+    list-style-image: url(\\\"chrome://browser/skin/identity.png\\\");\\n+    -moz-image-region: rect(0px, 64px, 64px, 0px);\\n+}\\n+\\n+.verifiedDomain > #identity-popup-container > #identity-popup-icon {\\n+    -moz-image-region: rect(64px, 64px, 128px, 0px);\\n+}\\n+\\n+.verifiedIdentity > #identity-popup-container > #identity-popup-icon {\\n+    -moz-image-region: rect(128px, 64px, 192px, 0px);\\n+}\\n+\\n+/* Popup Title */\\n+#identity-popup-title {\\n+    font-size: 120%;\\n+    font-weight: bold;\\n+}\\n+\\n+.verifiedIdentity > #identity-popup-title {\\n+    color: #6A6;\\n+}\\n+\\n+.unknownIdentity > #identity-popup-title {\\n+    color: #999;\\n+}\\n+\\n+.verifiedDomain > #identity-popup-title {\\n+    color: black;\\n+}\\n+\\n+/* Popup Body Text */\\n+#identity-popup-content-box > description,\\n+#identity-popup-encryption-label {\\n+    white-space: -moz-pre-wrap;\\n+    color: black;\\n+    padding-left: 10px;\\n+}\\n+\\n+#identity-popup-content {\\n+    padding-top: 5px;\\n+    margin-bottom: 0;\\n+    max-width: 200px;\\n+}\\n+\\n+.verifiedIdentity > #identity-popup-content,\\n+.verifiedDomain > #identity-popup-content {\\n+   font-size: 140%;\\n+   font-weight: bold;\\n+   max-width: 300px;\\n+}\\n+\\n+#identity-popup-encryption {\\n+  margin: 10px 0;\\n+}\\n+\\n+.verifiedIdentity > #identity-popup-encryption > * > #identity-popup-encryption-icon,\\n+.verifiedDomain > #identity-popup-encryption > * >#identity-popup-encryption-icon {\\n+  list-style-image: url(\\\"chrome://browser/skin/Secure.png\\\");\\n+  -moz-image-region: rect(0px, 18px, 18px, 0px);\\n+}\\n+\\n+/* Popup Bounding Box */\\n+#identity-popup-container {\\n+    background-image: none;\\n+    background-color: white;\\n+    min-width: 280px;\\n+    padding: 10px;\\n+}\\ndiff --git a/browser/themes/pinstripe/browser/jar.mn b/browser/themes/pinstripe/browser/jar.mn\\nindex 8a6e1d9..fd5ae79 100644\\n--- a/browser/themes/pinstripe/browser/jar.mn\\n+++ b/browser/themes/pinstripe/browser/jar.mn\\n@@ -10,6 +10,7 @@ classic.jar:\\n   skin/classic/browser/find.png\\n   skin/classic/browser/find-bar-background.png\\n   skin/classic/browser/Go.png\\n+  skin/classic/browser/identity.png\\n   skin/classic/browser/Info.png\\n   skin/classic/browser/page-livemarks.png\\n   skin/classic/browser/livemark-item.png\\ndiff --git a/browser/themes/winstripe/browser/browser.css b/browser/themes/winstripe/browser/browser.css\\nindex be1451e..a32c11c 100644\\n--- a/browser/themes/winstripe/browser/browser.css\\n+++ b/browser/themes/winstripe/browser/browser.css\\n@@ -850,7 +850,7 @@ toolbar[iconsize=\\\"small\\\"] #paste-button:not([disabled=\\\"true\\\"]):hover:active {\\n   margin-bottom: 2px;\\n   margin-top: 2px;\\n   -moz-margin-end: 0px;\\n-  -moz-margin-start: 3px;\\n+  -moz-margin-start: 0px;\\n   width: 7em;\\n   min-width: 7em;\\n \\n@@ -1804,43 +1804,6 @@ toolbar[mode=\\\"text\\\"] > #window-controls > toolbarbutton > .toolbarbutton-text {\\n   color: #000000;\\n }\\n \\n-#urlbar[level=\\\"high\\\"] #lock-icon {\\n-  -moz-image-region: rect(0px, 18px, 18px, 0px);\\n-  list-style-image: url(\\\"chrome://browser/skin/Secure.png\\\");\\n-}\\n-#urlbar[level=\\\"high\\\"] #lock-icon:hover {\\n-  -moz-image-region: rect(18px, 18px, 36px, 0px);\\n-  list-style-image: url(\\\"chrome://browser/skin/Secure.png\\\");\\n-}\\n-#urlbar[level=\\\"high\\\"] #lock-icon:active {\\n-  -moz-image-region: rect(36px, 18px, 54px, 0px);\\n-  list-style-image: url(\\\"chrome://browser/skin/Secure.png\\\");\\n-}\\n-#urlbar[level=\\\"low\\\"] #lock-icon {\\n-  -moz-image-region: rect(0px, 18px, 18px, 0px);\\n-  list-style-image: url(\\\"chrome://browser/skin/Secure.png\\\");\\n-}\\n-#urlbar[level=\\\"low\\\"] #lock-icon:hover {\\n-  -moz-image-region: rect(18px, 18px, 36px, 0px);\\n-  list-style-image: url(\\\"chrome://browser/skin/Secure.png\\\");\\n-}\\n-#urlbar[level=\\\"low\\\"] #lock-icon:active {\\n-  -moz-image-region: rect(36px, 18px, 54px, 0px);\\n-  list-style-image: url(\\\"chrome://browser/skin/Secure.png\\\");\\n-}\\n-#urlbar[level=\\\"broken\\\"] #lock-icon {\\n-  -moz-image-region: rect(0px, 18px, 18px, 0px);\\n-  list-style-image: url(\\\"chrome://browser/skin/Security-broken.png\\\");\\n-}\\n-#urlbar[level=\\\"broken\\\"] #lock-icon:hover {\\n-  -moz-image-region: rect(18px, 18px, 36px, 0px);\\n-  list-style-image: url(\\\"chrome://browser/skin/Security-broken.png\\\");\\n-}\\n-#urlbar[level=\\\"broken\\\"] #lock-icon:active {\\n-  -moz-image-region: rect(36px, 18px, 54px, 0px);\\n-  list-style-image: url(\\\"chrome://browser/skin/Security-broken.png\\\");\\n-}\\n-\\n %ifdef MOZ_WIDGET_GTK2\\n #urlbar > .autocomplete-textbox-container {\\n   -moz-binding: url(chrome://browser/skin/browser.xml#autocomplete-security-wrapper);\\n@@ -1953,3 +1916,105 @@ toolbarbutton.bookmark-item[dragover=\\\"true\\\"][open=\\\"true\\\"] {\\n .bookmark-item[dragover-bottom=\\\"true\\\"] {\\n   -moz-border-bottom-colors: #000000;\\n }\\n+\\n+/* ::::: Identity Indicator Styling ::::: */\\n+/* Location bar visuals*/\\n+#identity-box {\\n+  border-right: 1px solid #888;\\n+  background-color: white;\\n+  opacity: 0.9;\\n+}\\n+\\n+#identity-box:hover {\\n+  opacity: 1.0;\\n+}\\n+\\n+#identity-box.verifiedIdentity {\\n+  background-color: #BFA;\\n+}\\n+\\n+#identity-icon-label {\\n+    padding: 1px 2px 2px;\\n+    margin: 0;\\n+    color: black;\\n+    vertical-align: middle;\\n+}\\n+\\n+.unknownIdentity > #identity-icon-label {\\n+    display: none;\\n+}\\n+\\n+/* Popup Icons */\\n+#identity-popup-icon {\\n+    height: 64px;\\n+    width: 64px;\\n+    padding: 0;\\n+    margin: 10px 0 0;\\n+    list-style-image: url(\\\"chrome://browser/skin/identity.png\\\");\\n+    -moz-image-region: rect(0px, 64px, 64px, 0px);\\n+}\\n+\\n+.verifiedDomain > #identity-popup-container > #identity-popup-icon {\\n+    -moz-image-region: rect(64px, 64px, 128px, 0px);\\n+}\\n+\\n+.verifiedIdentity > #identity-popup-container > #identity-popup-icon {\\n+    -moz-image-region: rect(128px, 64px, 192px, 0px);\\n+}\\n+\\n+/* Popup Title */\\n+#identity-popup-title {\\n+    font-size: 120%;\\n+    font-weight: bold;\\n+}\\n+\\n+.verifiedIdentity > #identity-popup-title {\\n+    color: #6A6;\\n+}\\n+\\n+.unknownIdentity > #identity-popup-title {\\n+    color: #999;\\n+}\\n+\\n+.verifiedDomain > #identity-popup-title {\\n+    color: black;\\n+}\\n+\\n+/* Popup Body Text */\\n+#identity-popup-content-box > description,\\n+#identity-popup-encryption-label {\\n+    white-space: -moz-pre-wrap;\\n+    color: black;\\n+    padding-left: 10px;\\n+}\\n+\\n+#identity-popup-content {\\n+    padding-top: 5px;\\n+    margin-bottom: 0;\\n+    max-width: 200px;\\n+}\\n+\\n+.verifiedIdentity > #identity-popup-content,\\n+.verifiedDomain > #identity-popup-content {\\n+   font-size: 140%;\\n+   font-weight: bold;\\n+   max-width: 300px;\\n+}\\n+\\n+#identity-popup-encryption {\\n+  margin: 10px 0;\\n+}\\n+\\n+.verifiedIdentity > #identity-popup-encryption > * > #identity-popup-encryption-icon,\\n+.verifiedDomain > #identity-popup-encryption > * >#identity-popup-encryption-icon {\\n+  list-style-image: url(\\\"chrome://browser/skin/Secure.png\\\");\\n+  -moz-image-region: rect(0px, 18px, 18px, 0px);\\n+}\\n+\\n+/* Popup Bounding Box */\\n+#identity-popup-container {\\n+    background-image: none;\\n+    background-color: white;\\n+    min-width: 280px;\\n+    padding: 10px;\\n+}\\ndiff --git a/browser/themes/winstripe/browser/jar.mn b/browser/themes/winstripe/browser/jar.mn\\nindex 3748f3b..3b0d5030 100644\\n--- a/browser/themes/winstripe/browser/jar.mn\\n+++ b/browser/themes/winstripe/browser/jar.mn\\n@@ -4,6 +4,7 @@ classic.jar:\\n         skin/classic/browser/browser.xml\\n *       skin/classic/browser/engineManager.css                  (engineManager.css)\\n         skin/classic/browser/Info.png\\n+        skin/classic/browser/identity.png\\n         skin/classic/browser/pageInfo.css\\n         skin/classic/browser/pageInfo.png\\n         skin/classic/browser/page-livemarks.png\\n\""}