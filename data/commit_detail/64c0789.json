{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas64c0789\""},"diff":"\"64c0789 more tests for nsIResumableChannel\\ndiff --git a/netwerk/test/unit/test_resumable_channel.js b/netwerk/test/unit/test_resumable_channel.js\\nindex d33e413..3e3ba57 100644\\n--- a/netwerk/test/unit/test_resumable_channel.js\\n+++ b/netwerk/test/unit/test_resumable_channel.js\\n@@ -72,6 +72,7 @@ function run_test() {\\n   httpserver = new nsHttpServer();\\n   httpserver.registerPathHandler(\\\"/auth\\\", authHandler);\\n   httpserver.registerPathHandler(\\\"/range\\\", rangeHandler);\\n+  httpserver.registerPathHandler(\\\"/redir\\\", redirHandler);\\n \\n   var entityID;\\n \\n@@ -142,6 +143,39 @@ function run_test() {\\n \\n   function test_404(request, data, ctx) {\\n     do_check_eq(request.status, NS_ERROR_ENTITY_CHANGED);\\n+    do_check_eq(request.nsIHttpChannel.responseStatus, 404);\\n+\\n+    // 416 Requested Range Not Satisfiable\\n+    var chan = make_channel(\\\"http://localhost:4444/range\\\");\\n+    chan.nsIResumableChannel.resumeAt(1000, entityID);\\n+    chan.asyncOpen(new ChannelListener(test_416, null, CL_EXPECT_FAILURE), null);\\n+  }\\n+\\n+  function test_416(request, data, ctx) {\\n+    do_check_eq(request.status, NS_ERROR_ENTITY_CHANGED);\\n+    do_check_eq(request.nsIHttpChannel.responseStatus, 416);\\n+\\n+    // Redirect + successful resume\\n+    var chan = make_channel(\\\"http://localhost:4444/redir\\\");\\n+    chan.nsIHttpChannel.setRequestHeader(\\\"X-Redir-To\\\", \\\"http://localhost:4444/range\\\", false);\\n+    chan.nsIResumableChannel.resumeAt(1, entityID);\\n+    chan.asyncOpen(new ChannelListener(test_redir_resume, null), null);\\n+  }\\n+\\n+  function test_redir_resume(request, data, ctx) {\\n+    do_check_true(request.nsIHttpChannel.requestSucceeded);\\n+    do_check_eq(data, rangeBody.substring(1));\\n+    do_check_eq(request.nsIHttpChannel.responseStatus, 206);\\n+\\n+    // Redirect + failed resume\\n+    var chan = make_channel(\\\"http://localhost:4444/redir\\\");\\n+    chan.nsIHttpChannel.setRequestHeader(\\\"X-Redir-To\\\", \\\"http://localhost:4444/\\\", false);\\n+    chan.nsIResumableChannel.resumeAt(1, entityID);\\n+    chan.asyncOpen(new ChannelListener(test_redir_noresume, null, CL_EXPECT_FAILURE), null);\\n+  }\\n+\\n+  function test_redir_noresume(request, data, ctx) {\\n+    do_check_eq(request.status, NS_ERROR_NOT_RESUMABLE);\\n \\n     httpserver.stop();\\n     do_test_finished();\\n@@ -226,5 +260,13 @@ function rangeHandler(metadata, response) {\\n   response.bodyOutputStream.write(body, body.length);\\n }\\n \\n+// /redir\\n+function redirHandler(metadata, response) {\\n+  response.setStatusLine(metadata.httpVersion, 302, \\\"Found\\\");\\n+  response.setHeader(\\\"Content-Type\\\", \\\"text/html\\\", false);\\n+  response.setHeader(\\\"Location\\\", metadata.getHeader(\\\"X-Redir-To\\\"));\\n+  var body = \\\"redirect\\\\r\\\\n\\\";\\n+  response.bodyOutputStream.write(body, body.length);\\n+}\\n \\n \\n\""}