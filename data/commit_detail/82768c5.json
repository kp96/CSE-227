{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas82768c5\""},"diff":"\"82768c5 Bug 395066  Hang when trying to clear browsing history (r=sspitzer, a=mconnor)\\ndiff --git a/toolkit/components/places/src/nsNavHistoryExpire.cpp b/toolkit/components/places/src/nsNavHistoryExpire.cpp\\nindex 75ce80f..2da96cd 100644\\n--- a/toolkit/components/places/src/nsNavHistoryExpire.cpp\\n+++ b/toolkit/components/places/src/nsNavHistoryExpire.cpp\\n@@ -532,28 +532,19 @@ nsresult\\n nsNavHistoryExpire::EraseAnnotations(mozIStorageConnection* aConnection,\\n     const nsTArray<nsNavHistoryExpireRecord>& aRecords)\\n {\\n-  nsresult rv;\\n-  nsCOMPtr<nsIAnnotationService> annotationService = do_GetService(\\\"@mozilla.org/browser/annotation-service;1\\\", &rv);\\n-  NS_ENSURE_SUCCESS(rv, rv);\\n-\\n-  nsCOMPtr<mozIStorageStatement> statement;\\n-  rv = aConnection->CreateStatement(NS_LITERAL_CSTRING(\\n-    \\\"DELETE FROM moz_annos WHERE id in (\\\"\\n-      \\\"SELECT a.id from moz_annos a JOIN moz_places p on a.place_id = p.id \\\"\\n-      \\\"WHERE p.url = ?1 AND a.expiration != ?2)\\\"),\\n-    getter_AddRefs(statement));\\n-  NS_ENSURE_SUCCESS(rv, rv);\\n-\\n   // remove annotations for the set of records passed in\\n+  nsCString placeIds;\\n   for (PRUint32 i = 0; i < aRecords.Length(); i ++) {\\n-    // delete annotations (except EXPIRE_NEVER)\\n-    rv = statement->BindUTF8StringParameter(0, aRecords[i].uri);\\n-    NS_ENSURE_SUCCESS(rv, rv);\\n-    rv = statement->BindInt32Parameter(1, nsIAnnotationService::EXPIRE_NEVER);\\n-    NS_ENSURE_SUCCESS(rv, rv);\\n-    rv = statement->Execute();\\n-    NS_ENSURE_SUCCESS(rv, rv);\\n+    if (!placeIds.IsEmpty())\\n+      placeIds.AppendLiteral(\\\", \\\");\\n+    placeIds.AppendInt(aRecords[i].placeID);\\n   }\\n+  \\n+  nsresult rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(\\n+    \\\"DELETE FROM moz_annos WHERE place_id in (\\\") +\\n+      placeIds + NS_LITERAL_CSTRING(\\\") AND expiration != \\\") +\\n+      nsPrintfCString(\\\"%d\\\", nsIAnnotationService::EXPIRE_NEVER));\\n+  NS_ENSURE_SUCCESS(rv, rv);\\n   return NS_OK;\\n }\\n \\ndiff --git a/toolkit/components/places/tests/unit/test_expiration.js b/toolkit/components/places/tests/unit/test_expiration.js\\nindex 8fc7a5a..29868cd 100644\\n--- a/toolkit/components/places/tests/unit/test_expiration.js\\n+++ b/toolkit/components/places/tests/unit/test_expiration.js\\n@@ -135,20 +135,35 @@ function run_test() {\\n   but doesn't remove bookmarks or EXPIRE_NEVER annotations.\\n   */\\n   var removeAllTestURI = uri(\\\"http://removeallpages.com\\\");\\n+  var removeAllTestURINever = uri(\\\"http://removeallpagesnever.com\\\");\\n   histsvc.addVisit(removeAllTestURI, Date.now(), 0, histsvc.TRANSITION_TYPED, false, 0);\\n+  var bmURI = uri(\\\"http://bookmarked\\\");\\n+  bmsvc.insertBookmark(bmsvc.bookmarksRoot, bmURI, bmsvc.DEFAULT_INDEX, \\\"foo\\\");\\n+  //bhist.addPageWithDetails(placeURI, \\\"place uri\\\", Date.now());\\n+  var placeURI = uri(\\\"place:folder=23\\\");\\n+  bhist.addPageWithDetails(placeURI, \\\"place uri\\\", Date.now());\\n   annosvc.setPageAnnotation(removeAllTestURI, testAnnoName + \\\"Hist\\\", testAnnoVal, 0, annosvc.EXPIRE_WITH_HISTORY);\\n-  annosvc.setPageAnnotation(removeAllTestURI, testAnnoName + \\\"Never\\\", testAnnoVal, 0, annosvc.EXPIRE_NEVER);\\n+  annosvc.setPageAnnotation(removeAllTestURINever, testAnnoName + \\\"Never\\\", testAnnoVal, 0, annosvc.EXPIRE_NEVER);\\n   bhist.removeAllPages();\\n   try {\\n-    annosvc.getPageAnnotation(testAnnoName + \\\"Hist\\\");\\n-    do_throw(\\\"nsIBrowserHistory.removePagesFromHost() didn't remove an EXPIRE_WITH_HISTORY annotation\\\");\\n+    annosvc.getPageAnnotation(removeAllTestURI, testAnnoName + \\\"Hist\\\");\\n+    do_throw(\\\"nsIBrowserHistory.removeAllPages() didn't remove an EXPIRE_WITH_HISTORY annotation\\\");\\n   } catch(ex) {}\\n+  // test that the moz_places record was removed for this URI\\n+  do_check_eq(histsvc.getPageTitle(removeAllTestURI), null);\\n   try {\\n-    do_check_eq(annosvc.getPageAnnotation(removeAllTestURI, testAnnoName + \\\"Never\\\"), testAnnoVal);\\n-    annosvc.removePageAnnotation(removeAllTestURI, testAnnoName + \\\"Never\\\");\\n+    do_check_eq(annosvc.getPageAnnotation(removeAllTestURINever, testAnnoName + \\\"Never\\\"), testAnnoVal);\\n+    annosvc.removePageAnnotation(removeAllTestURINever, testAnnoName + \\\"Never\\\");\\n   } catch(ex) {\\n     do_throw(\\\"nsIBrowserHistory.removeAllPages deleted EXPIRE_NEVER annos!\\\");\\n   }\\n+  // test that the moz_places record was not removed for EXPIRE_NEVER anno\\n+  do_check_neq(histsvc.getPageTitle(removeAllTestURINever), null);\\n+  // for place URI\\n+  do_check_neq(histsvc.getPageTitle(placeURI), null);\\n+  // for bookmarked URI\\n+  do_check_neq(histsvc.getPageTitle(bmURI), null);\\n+  \\n \\n   /*\\n   test age-based history and anno expiration via the browser.history_expire_days pref.\\n\""}