{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas171e7e6\""},"diff":"\"171e7e6 Bug 386678  append the default bookmarks when first run migration from IE, Opera, Safari, etc. (r=sspitzer)\\ndiff --git a/browser/components/migration/src/nsBrowserProfileMigratorUtils.cpp b/browser/components/migration/src/nsBrowserProfileMigratorUtils.cpp\\nindex e939fc1..1a1244a 100644\\n--- a/browser/components/migration/src/nsBrowserProfileMigratorUtils.cpp\\n+++ b/browser/components/migration/src/nsBrowserProfileMigratorUtils.cpp\\n@@ -59,6 +59,8 @@\\n \\n #define MIGRATION_BUNDLE \\\"chrome://browser/locale/migration/migration.properties\\\"\\n \\n+#define BOOKMARKS_FILE_NAME NS_LITERAL_STRING(\\\"bookmarks.html\\\")\\n+\\n void SetUnicharPref(const char* aPref, const nsAString& aValue,\\n                     nsIPrefBranch* aPrefs)\\n {\\n@@ -217,11 +219,25 @@ AnnotatePersonalToolbarFolder(nsIFile* aSourceBookmarksFile,\\n \\n nsresult\\n ImportBookmarksHTML(nsIFile* aBookmarksFile, \\n+                    PRBool aImportIntoRoot,\\n+                    PRBool aOverwriteDefaults,\\n                     const PRUnichar* aImportSourceNameKey)\\n {\\n   nsresult rv;\\n \\n-  // Look for the localized name of the bookmarks toolbar\\n+  nsCOMPtr<nsILocalFile> localFile(do_QueryInterface(aBookmarksFile));\\n+  NS_ENSURE_TRUE(localFile, NS_ERROR_FAILURE);\\n+  nsCOMPtr<nsIPlacesImportExportService> importer = do_GetService(NS_PLACESIMPORTEXPORTSERVICE_CONTRACTID, &rv);\\n+  NS_ENSURE_SUCCESS(rv, rv);\\n+\\n+  // Import file directly into the bookmarks root folder.\\n+  if (aImportIntoRoot) {\\n+    rv = importer->ImportHTMLFromFile(localFile, aOverwriteDefaults);\\n+    NS_ENSURE_SUCCESS(rv, rv);\\n+    return NS_OK;\\n+  }\\n+\\n+  // Get the source application name.\\n   nsCOMPtr<nsIStringBundleService> bundleService =\\n     do_GetService(NS_STRINGBUNDLE_CONTRACTID, &rv);\\n   NS_ENSURE_SUCCESS(rv, rv);\\n@@ -239,7 +255,7 @@ ImportBookmarksHTML(nsIFile* aBookmarksFile,\\n                                sourceNameStrings, 1, \\n                                getter_Copies(importedBookmarksTitle));\\n \\n-  // Get the bookmarks service\\n+  // Get the bookmarks service.\\n   nsCOMPtr<nsINavBookmarksService> bms =\\n     do_GetService(NS_NAVBOOKMARKSSERVICE_CONTRACTID, &rv);\\n   NS_ENSURE_SUCCESS(rv, rv);\\n@@ -254,9 +270,17 @@ ImportBookmarksHTML(nsIFile* aBookmarksFile,\\n   NS_ENSURE_SUCCESS(rv, rv);\\n \\n   // Import the bookmarks into the folder.\\n-  nsCOMPtr<nsILocalFile> localFile(do_QueryInterface(aBookmarksFile));\\n-  NS_ENSURE_TRUE(localFile, NS_ERROR_FAILURE);\\n-  nsCOMPtr<nsIPlacesImportExportService> importer = do_GetService(NS_PLACESIMPORTEXPORTSERVICE_CONTRACTID, &rv);\\n-  NS_ENSURE_SUCCESS(rv, rv);\\n   return importer->ImportHTMLFromFileToFolder(localFile, folder, PR_FALSE);\\n }\\n+\\n+nsresult\\n+InitializeBookmarks(nsIFile* aTargetProfile)\\n+{\\n+  nsCOMPtr<nsIFile> bookmarksFile;\\n+  aTargetProfile->Clone(getter_AddRefs(bookmarksFile));\\n+  bookmarksFile->Append(BOOKMARKS_FILE_NAME);\\n+  \\n+  nsresult rv = ImportBookmarksHTML(bookmarksFile, PR_TRUE, PR_TRUE, EmptyString().get());\\n+  NS_ENSURE_SUCCESS(rv, rv);\\n+  return NS_OK;\\n+}\\ndiff --git a/browser/components/migration/src/nsBrowserProfileMigratorUtils.h b/browser/components/migration/src/nsBrowserProfileMigratorUtils.h\\nindex 992d92b..b7c25e8 100644\\n--- a/browser/components/migration/src/nsBrowserProfileMigratorUtils.h\\n+++ b/browser/components/migration/src/nsBrowserProfileMigratorUtils.h\\n@@ -101,11 +101,18 @@ nsresult AnnotatePersonalToolbarFolder(nsIFile* aSourceBookmarksFile,\\n                                        nsIFile* aTargetBookmarksFile,\\n                                        const char* aToolbarFolderName);\\n \\n-// In-place import from aBookmarksFile into a folder in the user's bookmarks\\n-// with the name \\\"From (STR:aImportSourceNameKey)\\\" (aImportSourceNameKey\\n-// is a key into migration.properties with the pretty name of the application.\\n+// In-place import from aBookmarksFile into a folder in the user's bookmarks.\\n+// If the importIntoRoot parameter has a value of true, the bookmarks will be\\n+// imported into the bookmarks root folder. Otherwise, they'll be imported into\\n+// a new folder with the name \\\"From (STR:aImportSourceNameKey)\\\".\\n+// aImportSourceNameKey is a key into migration.properties with the pretty name\\n+// of the application.\\n nsresult ImportBookmarksHTML(nsIFile* aBookmarksFile, \\n+                             PRBool aImportIntoRoot,\\n+                             PRBool aOverwriteDefaults,\\n                              const PRUnichar* aImportSourceNameKey);\\n \\n+nsresult InitializeBookmarks(nsIFile* aTargetProfile);\\n+\\n #endif\\n \\ndiff --git a/browser/components/migration/src/nsDogbertProfileMigrator.cpp b/browser/components/migration/src/nsDogbertProfileMigrator.cpp\\nindex 5980a20..b05eb203 100644\\n--- a/browser/components/migration/src/nsDogbertProfileMigrator.cpp\\n+++ b/browser/components/migration/src/nsDogbertProfileMigrator.cpp\\n@@ -622,8 +622,11 @@ nsresult\\n nsDogbertProfileMigrator::CopyBookmarks(PRBool aReplace)\\n {\\n   // If we're blowing away existing content, just copy the file, don't do fancy importing.\\n-  if (aReplace)\\n+  if (aReplace) {\\n+    nsresult rv = InitializeBookmarks(mTargetProfile);\\n+    NS_ENSURE_SUCCESS(rv, rv);\\n     return MigrateDogbertBookmarks();\\n+  }\\n \\n   return ImportNetscapeBookmarks(BOOKMARKS_FILE_NAME_IN_4x, \\n                                  NS_LITERAL_STRING(\\\"sourceNameDogbert\\\").get());\\ndiff --git a/browser/components/migration/src/nsIEProfileMigrator.cpp b/browser/components/migration/src/nsIEProfileMigrator.cpp\\nindex 6a62f85..e2a96bd 100644\\n--- a/browser/components/migration/src/nsIEProfileMigrator.cpp\\n+++ b/browser/components/migration/src/nsIEProfileMigrator.cpp\\n@@ -1199,6 +1199,12 @@ nsIEProfileMigrator::CopyFavorites(PRBool aReplace) {\\n     bms->CreateFolder(root, importedIEFavsTitle, -1, &folder);\\n   }\\n   else {\\n+    // Initialize the default bookmarks\\n+    nsCOMPtr<nsIFile> profile;\\n+    GetProfilePath(nsnull, profile);\\n+    rv = InitializeBookmarks(profile);\\n+    NS_ENSURE_SUCCESS(rv, rv);\\n+\\n     // Locate the Links toolbar folder, we want to replace the Personal Toolbar content with \\n     // Favorites in this folder. \\n     nsCOMPtr<nsIWindowsRegKey> regKey = \\n@@ -1419,9 +1425,6 @@ nsIEProfileMigrator::ParseFavoritesFolder(nsIFile* aDirectory,\\n       PRInt64 folder;\\n       if (bookmarkName.Equals(aPersonalToolbarFolderName)) {\\n         aBookmarksService->GetToolbarFolder(&folder);\\n-        // If we're here, it means the user's doing a _replace_ import which means\\n-        // clear out the content of this folder, and replace it with the new content\\n-        aBookmarksService->RemoveFolderChildren(folder);\\n       }\\n       else {\\n         rv = aBookmarksService->CreateFolder(aParentFolder,\\ndiff --git a/browser/components/migration/src/nsMacIEProfileMigrator.cpp b/browser/components/migration/src/nsMacIEProfileMigrator.cpp\\nindex 5ed3dc0..f01e3ad 100644\\n--- a/browser/components/migration/src/nsMacIEProfileMigrator.cpp\\n+++ b/browser/components/migration/src/nsMacIEProfileMigrator.cpp\\n@@ -51,7 +51,7 @@\\n \\n #define MACIE_BOOKMARKS_FILE_NAME NS_LITERAL_STRING(\\\"Favorites.html\\\")\\n #define MACIE_PREFERENCES_FOLDER_NAME NS_LITERAL_STRING(\\\"Explorer\\\")\\n-#define FIREFOX_BOOKMARKS_FILE_NAME NS_LITERAL_STRING(\\\"bookmarks.html\\\")\\n+#define TEMP_BOOKMARKS_FILE_NAME NS_LITERAL_STRING(\\\"bookmarks_tmp.html\\\")\\n \\n #define MIGRATION_BUNDLE \\\"chrome://browser/locale/migration/migration.properties\\\"\\n \\n@@ -172,6 +172,7 @@ nsMacIEProfileMigrator::GetSourceHomePageURL(nsACString& aResult)\\n nsresult\\n nsMacIEProfileMigrator::CopyBookmarks(PRBool aReplace)\\n {\\n+  nsresult rv;\\n   nsCOMPtr<nsIFile> sourceFile;\\n   mSourceProfile->Clone(getter_AddRefs(sourceFile));\\n \\n@@ -181,46 +182,52 @@ nsMacIEProfileMigrator::CopyBookmarks(PRBool aReplace)\\n   if (!exists)\\n     return NS_OK;\\n \\n-  nsCOMPtr<nsIFile> targetFile;\\n-  mTargetProfile->Clone(getter_AddRefs(targetFile));\\n-  targetFile->Append(FIREFOX_BOOKMARKS_FILE_NAME);\\n+  // it's an import\\n+  if (!aReplace)\\n+    return ImportBookmarksHTML(sourceFile,\\n+                               PR_FALSE,\\n+                               PR_FALSE,\\n+                               NS_LITERAL_STRING(\\\"sourceNameIE\\\").get());\\n \\n-  // If we're blowing away existing content, annotate the Personal Toolbar and\\n-  // then just copy the file. \\n-  if (aReplace) {\\n-    nsresult rv;\\n+  // Initialize the default bookmarks\\n+  rv = InitializeBookmarks(mTargetProfile);\\n+  NS_ENSURE_SUCCESS(rv, rv);\\n \\n-    // Look for the localized name of the IE Favorites Bar\\n-    nsCOMPtr<nsIStringBundleService> bundleService =\\n-      do_GetService(NS_STRINGBUNDLE_CONTRACTID, &rv);\\n-    NS_ENSURE_SUCCESS(rv, rv);\\n-\\n-    nsCOMPtr<nsIStringBundle> bundle;\\n-    rv = bundleService->CreateBundle(MIGRATION_BUNDLE, getter_AddRefs(bundle));\\n-    NS_ENSURE_SUCCESS(rv, rv);\\n-\\n-    nsString toolbarFolderNameMacIE;\\n-    bundle->GetStringFromName(NS_LITERAL_STRING(\\\"toolbarFolderNameMacIE\\\").get(), \\n-                              getter_Copies(toolbarFolderNameMacIE));\\n-    nsCAutoString ctoolbarFolderNameMacIE;\\n-    CopyUTF16toUTF8(toolbarFolderNameMacIE, ctoolbarFolderNameMacIE);\\n-\\n-    // If we can't find it for some reason, just copy the file. \\n-    if (NS_FAILED(rv)) {\\n-      targetFile->Exists(&exists);\\n-      if (exists)\\n-        targetFile->Remove(PR_FALSE);\\n-\\n-      return sourceFile->CopyTo(mTargetProfile, FIREFOX_BOOKMARKS_FILE_NAME);\\n-    }\\n-\\n-    // Now read the 4.x bookmarks file, correcting the Personal Toolbar Folder \\n-    // line and writing to the new location.\\n-    return AnnotatePersonalToolbarFolder(sourceFile,\\n-                                         targetFile,\\n-                                         ctoolbarFolderNameMacIE.get());\\n-  }\\n-\\n-  return ImportBookmarksHTML(sourceFile,\\n-                             NS_LITERAL_STRING(\\\"sourceNameIE\\\").get());\\n+  // If we're blowing away existing content, annotate the Personal Toolbar and\\n+  // then import the file. \\n+  nsCOMPtr<nsIFile> tempFile;\\n+  mTargetProfile->Clone(getter_AddRefs(tempFile));\\n+  tempFile->Append(TEMP_BOOKMARKS_FILE_NAME);\\n+\\n+  // Look for the localized name of the IE Favorites Bar\\n+  nsCOMPtr<nsIStringBundleService> bundleService =\\n+    do_GetService(NS_STRINGBUNDLE_CONTRACTID, &rv);\\n+  NS_ENSURE_SUCCESS(rv, rv);\\n+\\n+  nsCOMPtr<nsIStringBundle> bundle;\\n+  rv = bundleService->CreateBundle(MIGRATION_BUNDLE, getter_AddRefs(bundle));\\n+  NS_ENSURE_SUCCESS(rv, rv);\\n+\\n+  nsString toolbarFolderNameMacIE;\\n+  bundle->GetStringFromName(NS_LITERAL_STRING(\\\"toolbarFolderNameMacIE\\\").get(), \\n+                            getter_Copies(toolbarFolderNameMacIE));\\n+  nsCAutoString ctoolbarFolderNameMacIE;\\n+  CopyUTF16toUTF8(toolbarFolderNameMacIE, ctoolbarFolderNameMacIE);\\n+\\n+  // Now read the 4.x bookmarks file, correcting the Personal Toolbar Folder \\n+  // line and writing to the temporary file.\\n+  rv = AnnotatePersonalToolbarFolder(sourceFile,\\n+                                     tempFile,\\n+                                     ctoolbarFolderNameMacIE.get());\\n+  NS_ENSURE_SUCCESS(rv, rv);\\n+\\n+  // import the temp file\\n+  rv = ImportBookmarksHTML(tempFile,\\n+                           PR_TRUE,\\n+                           PR_FALSE,\\n+                           EmptyString().get());\\n+  NS_ENSURE_SUCCESS(rv, rv);\\n+\\n+  // remove the temp file\\n+  return tempFile->Remove(PR_FALSE);\\n }\\ndiff --git a/browser/components/migration/src/nsNetscapeProfileMigratorBase.cpp b/browser/components/migration/src/nsNetscapeProfileMigratorBase.cpp\\nindex 7691f5d..51b28e3 100644\\n--- a/browser/components/migration/src/nsNetscapeProfileMigratorBase.cpp\\n+++ b/browser/components/migration/src/nsNetscapeProfileMigratorBase.cpp\\n@@ -318,7 +318,7 @@ nsNetscapeProfileMigratorBase::ImportNetscapeBookmarks(const nsAString& aBookmar\\n   mSourceProfile->Clone(getter_AddRefs(bookmarksFile));\\n   bookmarksFile->Append(aBookmarksFileName);\\n   \\n-  return ImportBookmarksHTML(bookmarksFile, aImportSourceNameKey);\\n+  return ImportBookmarksHTML(bookmarksFile, PR_FALSE, PR_FALSE, aImportSourceNameKey);\\n }\\n \\n nsresult\\ndiff --git a/browser/components/migration/src/nsOperaProfileMigrator.cpp b/browser/components/migration/src/nsOperaProfileMigrator.cpp\\nindex bc01b46..1f2ec03 100644\\n--- a/browser/components/migration/src/nsOperaProfileMigrator.cpp\\n+++ b/browser/components/migration/src/nsOperaProfileMigrator.cpp\\n@@ -963,15 +963,15 @@ nsOperaCookieMigrator::ReadHeader()\\n nsresult\\n nsOperaProfileMigrator::CopyHistory(PRBool aReplace)\\n {\\n-  nsresult rv;\\r\\n-  nsCOMPtr<nsINavHistoryService> history = do_GetService(NS_NAVHISTORYSERVICE_CONTRACTID, &rv);\\r\\n-  NS_ENSURE_SUCCESS(rv, rv);\\r\\n- \\r\\n-  return history->RunInBatchMode(this, nsnull);\\r\\n-}\\r\\n- \\r\\n-NS_IMETHODIMP\\r\\n-nsOperaProfileMigrator::RunBatched(nsISupports* aUserData)\\r\\n+  nsresult rv;\\n+  nsCOMPtr<nsINavHistoryService> history = do_GetService(NS_NAVHISTORYSERVICE_CONTRACTID, &rv);\\n+  NS_ENSURE_SUCCESS(rv, rv);\\n+ \\n+  return history->RunInBatchMode(this, nsnull);\\n+}\\n+ \\n+NS_IMETHODIMP\\n+nsOperaProfileMigrator::RunBatched(nsISupports* aUserData)\\n {\\n   nsCOMPtr<nsIBrowserHistory> hist(do_GetService(NS_GLOBALHISTORY2_CONTRACTID));\\n \\n@@ -1071,8 +1071,13 @@ nsOperaProfileMigrator::CopyBookmarks(PRBool aReplace)\\n     bms->CreateFolder(parentFolder, importedOperaHotlistTitle,\\n                       nsINavBookmarksService::DEFAULT_INDEX, &parentFolder);\\n   }\\n-  else\\n+  else {\\n+    nsCOMPtr<nsIFile> profile;\\n+    GetProfilePath(nsnull, profile);\\n+    rv = InitializeBookmarks(profile);\\n+    NS_ENSURE_SUCCESS(rv, rv);\\n     parentFolder = root;\\n+  }\\n \\n #if defined(XP_WIN) || (defined(XP_UNIX) && !defined(XP_MACOSX))\\n   printf(\\\"*** about to copy smart keywords\\\\n\\\");\\ndiff --git a/browser/components/migration/src/nsPhoenixProfileMigrator.cpp b/browser/components/migration/src/nsPhoenixProfileMigrator.cpp\\nindex 1da588a..7af1132 100644\\n--- a/browser/components/migration/src/nsPhoenixProfileMigrator.cpp\\n+++ b/browser/components/migration/src/nsPhoenixProfileMigrator.cpp\\n@@ -423,6 +423,7 @@ nsPhoenixProfileMigrator::CopyPasswords(PRBool aReplace)\\n nsresult\\n nsPhoenixProfileMigrator::CopyBookmarks(PRBool aReplace)\\n {\\n+  // This overwrites the defaults. This might be ok in this instance.\\n   return aReplace ? CopyFile(FILE_NAME_BOOKMARKS, FILE_NAME_BOOKMARKS) : NS_OK;\\n }\\n \\ndiff --git a/browser/components/migration/src/nsSafariProfileMigrator.cpp b/browser/components/migration/src/nsSafariProfileMigrator.cpp\\nindex d647352..935745e 100644\\n--- a/browser/components/migration/src/nsSafariProfileMigrator.cpp\\n+++ b/browser/components/migration/src/nsSafariProfileMigrator.cpp\\n@@ -899,7 +899,7 @@ nsresult\\n nsSafariProfileMigrator::CopyBookmarks(PRBool aReplace)\\n {\\n   // If \\\"aReplace\\\" is true, merge into the root level of bookmarks. Otherwise, create\\n-  // a folder called \\\"Imported IE Favorites\\\" and place all the Bookmarks there.\\n+  // a folder called \\\"Imported Safari Favorites\\\" and place all the Bookmarks there.\\n   nsresult rv;\\n \\n   nsCOMPtr<nsINavBookmarksService> bms(do_GetService(NS_NAVBOOKMARKSSERVICE_CONTRACTID, &rv));\\n@@ -930,7 +930,11 @@ nsSafariProfileMigrator::CopyBookmarks(PRBool aReplace)\\n                       &folder);\\n   }\\n   else {\\n-    // In non-replace mode we are merging at the top level.\\n+    nsCOMPtr<nsIFile> profile;\\n+    GetProfilePath(nsnull, profile);\\n+    rv = InitializeBookmarks(profile);\\n+    NS_ENSURE_SUCCESS(rv, rv);\\n+    // In replace mode we are merging at the top level.\\n     folder = root;\\n   }\\n \\ndiff --git a/browser/components/migration/src/nsSeamonkeyProfileMigrator.cpp b/browser/components/migration/src/nsSeamonkeyProfileMigrator.cpp\\nindex 728aea1..cece725 100644\\n--- a/browser/components/migration/src/nsSeamonkeyProfileMigrator.cpp\\n+++ b/browser/components/migration/src/nsSeamonkeyProfileMigrator.cpp\\n@@ -723,8 +723,11 @@ nsSeamonkeyProfileMigrator::CopyPasswords(PRBool aReplace)\\n nsresult\\n nsSeamonkeyProfileMigrator::CopyBookmarks(PRBool aReplace)\\n {\\n-  if (aReplace)\\n+  if (aReplace) {\\n+    nsresult rv = InitializeBookmarks(mTargetProfile);\\n+    NS_ENSURE_SUCCESS(rv, rv);\\n     return CopyFile(FILE_NAME_BOOKMARKS, FILE_NAME_BOOKMARKS);\\n+  }\\n   return ImportNetscapeBookmarks(FILE_NAME_BOOKMARKS, \\n                                  NS_LITERAL_STRING(\\\"sourceNameSeamonkey\\\").get());\\n }\\n\""}