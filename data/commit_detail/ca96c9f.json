{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basca96c9f\""},"diff":"\"ca96c9f Bug 396451 - Index with i++ for DownloadManager sql queries.  Patch by Edward Lee <edilee@gmail.com>.  r=sdwilsh, a=mconnor\\ndiff --git a/toolkit/components/downloads/src/nsDownloadManager.cpp b/toolkit/components/downloads/src/nsDownloadManager.cpp\\nindex 40f998e..2b616c5 100644\\n--- a/toolkit/components/downloads/src/nsDownloadManager.cpp\\n+++ b/toolkit/components/downloads/src/nsDownloadManager.cpp\\n@@ -581,11 +581,12 @@ nsDownloadManager::RestoreDatabaseState()\\n       \\\"OR state = ?3\\\"), getter_AddRefs(stmt));\\n   NS_ENSURE_SUCCESS(rv, rv);\\n \\n-  rv = stmt->BindInt32Parameter(0, nsIDownloadManager::DOWNLOAD_NOTSTARTED);\\n+  PRInt32 i = 0;\\n+  rv = stmt->BindInt32Parameter(i++, nsIDownloadManager::DOWNLOAD_NOTSTARTED);\\n   NS_ENSURE_SUCCESS(rv, rv);\\n-  rv = stmt->BindInt32Parameter(1, nsIDownloadManager::DOWNLOAD_QUEUED);\\n+  rv = stmt->BindInt32Parameter(i++, nsIDownloadManager::DOWNLOAD_QUEUED);\\n   NS_ENSURE_SUCCESS(rv, rv);\\n-  rv = stmt->BindInt32Parameter(2, nsIDownloadManager::DOWNLOAD_DOWNLOADING);\\n+  rv = stmt->BindInt32Parameter(i++, nsIDownloadManager::DOWNLOAD_DOWNLOADING);\\n   NS_ENSURE_SUCCESS(rv, rv);\\n \\n   // Next, we iterate through them storing them in an array\\n@@ -607,13 +608,14 @@ nsDownloadManager::RestoreDatabaseState()\\n       \\\"OR state = ?4\\\"), getter_AddRefs(stmt));\\n   NS_ENSURE_SUCCESS(rv, rv);\\n \\n-  rv = stmt->BindInt32Parameter(0, nsIDownloadManager::DOWNLOAD_FAILED);\\n+  i = 0;\\n+  rv = stmt->BindInt32Parameter(i++, nsIDownloadManager::DOWNLOAD_FAILED);\\n   NS_ENSURE_SUCCESS(rv, rv);\\n-  rv = stmt->BindInt32Parameter(1, nsIDownloadManager::DOWNLOAD_NOTSTARTED);\\n+  rv = stmt->BindInt32Parameter(i++, nsIDownloadManager::DOWNLOAD_NOTSTARTED);\\n   NS_ENSURE_SUCCESS(rv, rv);\\n-  rv = stmt->BindInt32Parameter(2, nsIDownloadManager::DOWNLOAD_QUEUED);\\n+  rv = stmt->BindInt32Parameter(i++, nsIDownloadManager::DOWNLOAD_QUEUED);\\n   NS_ENSURE_SUCCESS(rv, rv);\\n-  rv = stmt->BindInt32Parameter(3, nsIDownloadManager::DOWNLOAD_DOWNLOADING);\\n+  rv = stmt->BindInt32Parameter(i++, nsIDownloadManager::DOWNLOAD_DOWNLOADING);\\n   NS_ENSURE_SUCCESS(rv, rv);\\n \\n   // Finally, let's retry all of those downloads\\n@@ -638,28 +640,29 @@ nsDownloadManager::AddDownloadToDB(const nsAString &aName,\\n     \\\"VALUES (?1, ?2, ?3, ?4, ?5, ?6)\\\"), getter_AddRefs(stmt));\\n   NS_ENSURE_SUCCESS(rv, 0);\\n \\n+  PRInt32 i = 0;\\n   // name\\n-  rv = stmt->BindStringParameter(0, aName);\\n+  rv = stmt->BindStringParameter(i++, aName);\\n   NS_ENSURE_SUCCESS(rv, 0);\\n \\n   // source\\n-  rv = stmt->BindUTF8StringParameter(1, aSource);\\n+  rv = stmt->BindUTF8StringParameter(i++, aSource);\\n   NS_ENSURE_SUCCESS(rv, 0);\\n \\n   // target\\n-  rv = stmt->BindUTF8StringParameter(2, aTarget);\\n+  rv = stmt->BindUTF8StringParameter(i++, aTarget);\\n   NS_ENSURE_SUCCESS(rv, 0);\\n \\n   // startTime\\n-  rv = stmt->BindInt64Parameter(3, aStartTime);\\n+  rv = stmt->BindInt64Parameter(i++, aStartTime);\\n   NS_ENSURE_SUCCESS(rv, 0);\\n \\n   // endTime\\n-  rv = stmt->BindInt64Parameter(4, aEndTime);\\n+  rv = stmt->BindInt64Parameter(i++, aEndTime);\\n   NS_ENSURE_SUCCESS(rv, 0);\\n \\n   // state\\n-  rv = stmt->BindInt32Parameter(5, aState);\\n+  rv = stmt->BindInt32Parameter(i++, aState);\\n   NS_ENSURE_SUCCESS(rv, 0);\\n \\n   PRBool hasMore;\\n@@ -775,26 +778,27 @@ nsDownloadManager::GetDownloadFromDB(PRUint32 aID, nsDownload **retVal)\\n   if (!dl)\\n     return NS_ERROR_OUT_OF_MEMORY;\\n \\n+  PRInt32 i = 0;\\n   // Setting all properties of the download now\\n   dl->mCancelable = nsnull;\\n-  dl->mID = stmt->AsInt64(0);\\n-  dl->mDownloadState = stmt->AsInt32(1);\\n-  dl->mStartTime = stmt->AsInt64(2);\\n+  dl->mID = stmt->AsInt64(i++);\\n+  dl->mDownloadState = stmt->AsInt32(i++);\\n+  dl->mStartTime = stmt->AsInt64(i++);\\n \\n   nsCString source;\\n-  stmt->GetUTF8String(3, source);\\n+  stmt->GetUTF8String(i++, source);\\n   rv = NS_NewURI(getter_AddRefs(dl->mSource), source);\\n   NS_ENSURE_SUCCESS(rv, rv);\\n \\n   nsCString target;\\n-  stmt->GetUTF8String(4, target);\\n+  stmt->GetUTF8String(i++, target);\\n   rv = NS_NewURI(getter_AddRefs(dl->mTarget), target);\\n   NS_ENSURE_SUCCESS(rv, rv);\\n \\n-  stmt->GetString(5, dl->mDisplayName);\\n+  stmt->GetString(i++, dl->mDisplayName);\\n \\n   nsCString referrer;\\n-  rv = stmt->GetUTF8String(6, referrer);\\n+  rv = stmt->GetUTF8String(i++, referrer);\\n   if (NS_SUCCEEDED(rv) && !referrer.IsEmpty()) {\\n     rv = NS_NewURI(getter_AddRefs(dl->mReferrer), referrer);\\n     NS_ENSURE_SUCCESS(rv, rv);\\n@@ -823,7 +827,7 @@ nsDownloadManager::GetDownloadFromDB(PRUint32 aID, nsDownload **retVal)\\n     dl->mCurrBytes = 0;\\n   }\\n \\n-  rv = stmt->GetUTF8String(7, dl->mEntityID);\\n+  rv = stmt->GetUTF8String(i++, dl->mEntityID);\\n   NS_ENSURE_SUCCESS(rv, rv);\\n \\n   // Addrefing and returning\\n@@ -2164,16 +2168,17 @@ nsDownload::UpdateDB()\\n \\n   mozIStorageStatement *stmt = mDownloadManager->mUpdateDownloadStatement;\\n \\n+  PRInt32 i = 0;\\n   // startTime\\n-  nsresult rv = stmt->BindInt64Parameter(0, mStartTime);\\n+  nsresult rv = stmt->BindInt64Parameter(i++, mStartTime);\\n   NS_ENSURE_SUCCESS(rv, rv);\\n \\n   // endTime\\n-  rv = stmt->BindInt64Parameter(1, mLastUpdate);\\n+  rv = stmt->BindInt64Parameter(i++, mLastUpdate);\\n   NS_ENSURE_SUCCESS(rv, rv);\\n \\n   // state\\n-  rv = stmt->BindInt32Parameter(2, mDownloadState);\\n+  rv = stmt->BindInt32Parameter(i++, mDownloadState);\\n   NS_ENSURE_SUCCESS(rv, rv);\\n \\n   // referrer\\n@@ -2181,18 +2186,18 @@ nsDownload::UpdateDB()\\n     nsCAutoString referrer;\\n     rv = mReferrer->GetSpec(referrer);\\n     NS_ENSURE_SUCCESS(rv, rv);\\n-    rv = stmt->BindUTF8StringParameter(3, referrer);\\n+    rv = stmt->BindUTF8StringParameter(i++, referrer);\\n   } else {\\n-    rv = stmt->BindNullParameter(3);\\n+    rv = stmt->BindNullParameter(i++);\\n   }\\n   NS_ENSURE_SUCCESS(rv, rv);\\n \\n   // entityID\\n-  rv = stmt->BindUTF8StringParameter(4, mEntityID);\\n+  rv = stmt->BindUTF8StringParameter(i++, mEntityID);\\n   NS_ENSURE_SUCCESS(rv, rv);\\n \\n   // id\\n-  rv = stmt->BindInt64Parameter(5, mID);\\n+  rv = stmt->BindInt64Parameter(i++, mID);\\n   NS_ENSURE_SUCCESS(rv, rv);\\n \\n   return stmt->Execute();\\n\""}