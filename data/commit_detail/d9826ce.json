{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basd9826ce\""},"diff":"\"d9826ce Bug 280438 - tab gives away password when no title is defined. patch by Gavin Sharp <gavin.sharp@gmail.com> r=mconnor\\ndiff --git a/browser/base/content/tabbrowser.xml b/browser/base/content/tabbrowser.xml\\nindex 7d5a259..63bd537 100644\\n--- a/browser/base/content/tabbrowser.xml\\n+++ b/browser/base/content/tabbrowser.xml\\n@@ -116,6 +116,10 @@\\n                   .getService(Components.interfaces.nsIPrefService)\\n                   .getBranch(null);\\n       </field>\\n+      <field name=\\\"mURIFixup\\\" readonly=\\\"true\\\">\\n+        Components.classes[\\\"@mozilla.org/docshell/urifixup;1\\\"]\\n+                  .getService(Components.interfaces.nsIURIFixup);\\n+      </field>\\n       <field name=\\\"mTabBox\\\">\\n         document.getAnonymousNodes(this)[1]\\n       </field>\\n@@ -784,16 +788,34 @@\\n           <![CDATA[\\n             var browser = this.getBrowserForTab(aTab);\\n             var crop = \\\"end\\\";\\n-            var titleViaGetter = browser.contentDocument.__proto__.__lookupGetter__('title').call(browser.contentDocument);\\n-            var title;\\n-            if (titleViaGetter)\\n-              title = titleViaGetter\\n-            else if (browser.currentURI.spec && browser.currentURI.spec != \\\"about:blank\\\") {\\n-              title = browser.currentURI.spec;\\n-              crop  = \\\"center\\\";\\n+            var title = browser.contentDocument.__proto__.__lookupGetter__('title').call(browser.contentDocument);\\n+            \\n+            if (!title) {\\n+              if (browser.currentURI.spec) {\\n+                try {\\n+                  title = this.mURIFixup.createExposableURI(browser.currentURI).spec;\\n+                } catch(ex) {\\n+                  title = browser.currentURI.spec;\\n+                }\\n+              }\\n+\\n+              if (title && title != \\\"about:blank\\\") {\\n+                // At this point, we now have a URI.\\n+                // Let's try to unescape it using a character set\\n+                // in case the URI is not ASCII.\\n+                try {\\n+                  var characterSet = Components.lookupMethod(browser.contentDocument, 'characterSet')\\n+                                               .call(browser.contentDocument);\\n+                  const textToSubURI = Components.classes[\\\"@mozilla.org/intl/texttosuburi;1\\\"]\\n+                                                 .getService(Components.interfaces.nsITextToSubURI);\\n+                  title = textToSubURI.unEscapeNonAsciiURI(characterSet, title);\\n+                } catch(ex) { /* Do nothing. */ }\\n+\\n+                crop = \\\"center\\\";\\n+\\n+              } else // Still no title?  Fall back to our untitled string.\\n+                title = this.mStringBundle.getString(\\\"tabs.untitled\\\");\\n             }\\n-            else\\n-              title = this.mStringBundle.getString(\\\"tabs.untitled\\\");\\n \\n             aTab.label = title;\\n             aTab.setAttribute(\\\"crop\\\", crop);\\n\""}