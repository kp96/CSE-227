{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basb353757\""},"diff":"\"b353757 Make getElementsByClassName handle the root element properly.  Bug 395915, r+sr=peterv, a=sicking.\\ndiff --git a/content/base/src/nsDocument.cpp b/content/base/src/nsDocument.cpp\\nindex 92b5d71..9d503b5 100644\\n--- a/content/base/src/nsDocument.cpp\\n+++ b/content/base/src/nsDocument.cpp\\n@@ -1710,16 +1710,18 @@ NS_IMETHODIMP\\n nsDocument::GetElementsByClassName(const nsAString& aClasses,\\n                                    nsIDOMNodeList** aReturn)\\n {\\n-  return GetElementsByClassNameHelper(mRootContent, aClasses, aReturn);\\n+  return GetElementsByClassNameHelper(this, aClasses, aReturn);\\n }\\n \\n \\n // static GetElementsByClassName helpers\\n nsresult\\n-nsDocument::GetElementsByClassNameHelper(nsIContent* aContent,\\n+nsDocument::GetElementsByClassNameHelper(nsINode* aRootNode,\\n                                          const nsAString& aClasses,\\n                                          nsIDOMNodeList** aReturn)\\n {\\n+  NS_PRECONDITION(aRootNode, \\\"Must have root node\\\");\\n+  \\n   nsAttrValue attrValue;\\n   attrValue.ParseAtomArray(aClasses);\\n   // nsAttrValue::Equals is sensitive to order, so we'll send an array\\n@@ -1733,8 +1735,8 @@ nsDocument::GetElementsByClassNameHelper(nsIContent* aContent,\\n   }\\n   \\n   nsBaseContentList* elements;\\n-  if (classes->Count() > 0 && aContent) {\\n-    elements = new nsContentList(aContent, MatchClassNames,\\n+  if (classes->Count() > 0) {\\n+    elements = new nsContentList(aRootNode, MatchClassNames,\\n                                  DestroyClassNameArray, classes);\\n   } else {\\n     elements = new nsBaseContentList();\\ndiff --git a/content/base/src/nsDocument.h b/content/base/src/nsDocument.h\\nindex 482458d..5f873e6 100644\\n--- a/content/base/src/nsDocument.h\\n+++ b/content/base/src/nsDocument.h\\n@@ -649,9 +649,10 @@ public:\\n   NS_DECL_CYCLE_COLLECTION_CLASS_AMBIGUOUS(nsDocument, nsIDocument)\\n \\n   /**\\n-   * Utility method for getElementsByClassName\\n+   * Utility method for getElementsByClassName.  aRootNode is the node (either\\n+   * document or element), which getElementsByClassName was called on.\\n    */\\n-  static nsresult GetElementsByClassNameHelper(nsIContent* aContent,\\n+  static nsresult GetElementsByClassNameHelper(nsINode* aRootNode,\\n                                                const nsAString& aClasses,\\n                                                nsIDOMNodeList** aReturn);\\n protected:\\ndiff --git a/content/base/test/Makefile.in b/content/base/test/Makefile.in\\nindex d1f4d74..00d1a6e 100644\\n--- a/content/base/test/Makefile.in\\n+++ b/content/base/test/Makefile.in\\n@@ -88,6 +88,7 @@ _TEST_FILES = \\ttest_bug5141.html \\\\\\n \\t\\ttest_bug382113.html \\\\\\n \\t\\ttest_bug390735.html \\\\\\n \\t\\ttest_bug392511.html \\\\\\n+\\t\\ttest_bug395915.html \\\\\\n \\t\\tbug382113_object.html \\\\\\n \\t\\ttest_CrossSiteXHR.html \\\\\\n \\t\\tfile_CrossSiteXHR_fail1.xml \\\\\\ndiff --git a/content/base/test/test_bug395915.html b/content/base/test/test_bug395915.html\\nnew file mode 100644\\nindex 0000000..164fa56\\n--- /dev/null\\n+++ b/content/base/test/test_bug395915.html\\n@@ -0,0 +1,44 @@\\n+<!DOCTYPE HTML>\\n+<html class=\\\"A b\\\">\\n+<!--\\n+https://bugzilla.mozilla.org/show_bug.cgi?id=395915\\n+-->\\n+<head>\\n+  <title>Test for Bug 395915</title>\\n+  <script type=\\\"text/javascript\\\" src=\\\"/MochiKit/MochiKit.js\\\"></script>\\n+  <script type=\\\"text/javascript\\\" src=\\\"/tests/SimpleTest/SimpleTest.js\\\"></script>\\n+  <link rel=\\\"stylesheet\\\" type=\\\"text/css\\\" href=\\\"/tests/SimpleTest/test.css\\\" />\\n+</head>\\n+<body>\\n+<a target=\\\"_blank\\\" href=\\\"https://bugzilla.mozilla.org/show_bug.cgi?id=395915\\\">Mozilla Bug 395915</a>\\n+<p id=\\\"display\\\"></p>\\n+<div id=\\\"content\\\" style=\\\"display: none\\\">\\n+  \\n+</div>\\n+<pre id=\\\"test\\\">\\n+<script class=\\\"testbody\\\" type=\\\"text/javascript\\\">\\n+\\n+/** Test for Bug 395915 **/\\n+is(document.getElementsByClassName(\\\"a\\\").length, 0,\\n+   \\\"Class names are case-sensitive\\\");\\n+is(document.getElementsByClassName(\\\"A\\\").length, 1,\\n+   \\\"Have one node of class A\\\");\\n+is(document.getElementsByClassName(\\\"A\\\")[0], document.documentElement,\\n+   \\\"Root is class A\\\");\\n+\\n+is(document.getElementsByClassName(\\\"a b\\\").length, 0,\\n+   \\\"Class names are case-sensitive two\\\");\\n+is(document.getElementsByClassName(\\\"A B\\\").length, 0,\\n+   \\\"Class names are case-sensitive three\\\");\\n+is(document.getElementsByClassName(\\\"a B\\\").length, 0,\\n+   \\\"Class names are case-sensitive four\\\");\\n+is(document.getElementsByClassName(\\\"A b\\\").length, 1,\\n+   \\\"Have one node of class 'A b'\\\");\\n+is(document.getElementsByClassName(\\\"A b\\\")[0], document.documentElement,\\n+   \\\"Root is class 'A b'\\\");\\n+\\n+</script>\\n+</pre>\\n+</body>\\n+</html>\\n+\\n\""}