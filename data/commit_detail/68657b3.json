{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas68657b3\""},"diff":"\"68657b3 Bug 394120, 'ASSERTION: post-reflow queues not empty' with xul:listboxbody and xul:text, r+sr+a=roc\\ndiff --git a/layout/xul/base/src/nsTextBoxFrame.cpp b/layout/xul/base/src/nsTextBoxFrame.cpp\\nindex a42b648..281ecf4 100644\\n--- a/layout/xul/base/src/nsTextBoxFrame.cpp\\n+++ b/layout/xul/base/src/nsTextBoxFrame.cpp\\n@@ -142,7 +142,8 @@ nsTextBoxFrame::AttributeChanged(PRInt32         aNameSpaceID,\\n }\\n \\n nsTextBoxFrame::nsTextBoxFrame(nsIPresShell* aShell, nsStyleContext* aContext):\\n-  nsLeafBoxFrame(aShell, aContext), mCropType(CropRight),mAccessKeyInfo(nsnull)\\n+  nsLeafBoxFrame(aShell, aContext), mCropType(CropRight), mAccessKeyInfo(nsnull),\\n+  mNeedsReflowCallback(PR_FALSE)\\n {\\n     mState |= NS_STATE_NEED_LAYOUT;\\n     MarkIntrinsicWidthsDirty();\\n@@ -249,7 +250,6 @@ nsTextBoxFrame::UpdateAccesskey(nsWeakFrame& aWeakThis)\\n         mContent->GetAttr(kNameSpaceID_None, nsGkAtoms::accesskey, accesskey);\\n     }\\n \\n-    mReflowCallbackPosted = PR_FALSE;\\n     if (!accesskey.Equals(mAccessKey)) {\\n         // Need to get clean mTitle.\\n         mContent->GetAttr(kNameSpaceID_None, nsGkAtoms::value, mTitle);\\n@@ -306,15 +306,10 @@ nsTextBoxFrame::UpdateAttributes(nsIAtom*         aAttribute,\\n         doUpdateTitle = PR_TRUE;\\n     }\\n \\n-    if (!mReflowCallbackPosted &&\\n-        (aAttribute == nsnull || aAttribute == nsGkAtoms::accesskey)) {\\n-        mReflowCallbackPosted = PR_TRUE;\\n+    if (aAttribute == nsnull || aAttribute == nsGkAtoms::accesskey) {\\n+        mNeedsReflowCallback = PR_TRUE;\\n         // Ensure that layout is refreshed and reflow callback called.\\n         aResize = PR_TRUE;\\n-        nsIReflowCallback* cb = new nsAsyncAccesskeyUpdate(this);\\n-        if (cb) {\\n-            PresContext()->PresShell()->PostReflowCallback(cb);\\n-        }\\n     }\\n \\n     if (doUpdateTitle) {\\n@@ -891,6 +886,14 @@ nsTextBoxFrame::UpdateAccessIndex()\\n NS_IMETHODIMP\\n nsTextBoxFrame::DoLayout(nsBoxLayoutState& aBoxLayoutState)\\n {\\n+    if (mNeedsReflowCallback) {\\n+        nsIReflowCallback* cb = new nsAsyncAccesskeyUpdate(this);\\n+        if (cb) {\\n+            PresContext()->PresShell()->PostReflowCallback(cb);\\n+        }\\n+        mNeedsReflowCallback = PR_FALSE;\\n+    }\\n+\\n     mState |= NS_STATE_NEED_LAYOUT;\\n \\n     return nsLeafBoxFrame::DoLayout(aBoxLayoutState);\\ndiff --git a/layout/xul/base/src/nsTextBoxFrame.h b/layout/xul/base/src/nsTextBoxFrame.h\\nindex bcfc4cb..1a70416 100644\\n--- a/layout/xul/base/src/nsTextBoxFrame.h\\n+++ b/layout/xul/base/src/nsTextBoxFrame.h\\n@@ -130,7 +130,7 @@ private:\\n   nscoord mTitleWidth;\\n   nsAccessKeyInfo* mAccessKeyInfo;\\n   PRPackedBool mNeedsRecalc;\\n-  PRPackedBool mReflowCallbackPosted;\\n+  PRPackedBool mNeedsReflowCallback;\\n   nsSize mTextSize;\\n   nscoord mAscent;\\n \\n\""}