{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas21a7ac2\""},"diff":"\"21a7ac2 Bug 392055: NS_ENSURE_SUCCESS should print out the error code. Original patch by Shawn Wilsher (sdwilsh) <comrade693+bmo@gmail.com>, updated by me to handle the standalone xpcom glue case and to use printf safely. r=bsmedberg, sr=bzbarsky, a=dsicore.\\ndiff --git a/xpcom/glue/nsDebug.h b/xpcom/glue/nsDebug.h\\nindex b5b62d7..ecd5bcc 100644\\n--- a/xpcom/glue/nsDebug.h\\n+++ b/xpcom/glue/nsDebug.h\\n@@ -50,6 +50,7 @@\\n \\n #ifdef DEBUG\\n #define NS_DEBUG\\n+#include \\\"prprf.h\\\"\\n #endif\\n \\n #ifdef DEBUG\\n@@ -203,8 +204,29 @@\\n ** Macros for checking results\\n ******************************************************************************/\\n \\n-#define NS_ENSURE_SUCCESS(res, ret) \\\\\\n-  NS_ENSURE_TRUE(NS_SUCCEEDED(res), ret)\\n+#if defined(DEBUG) && !defined(XPCOM_GLUE_AVOID_NSPR)\\n+\\n+#define NS_ENSURE_SUCCESS_BODY(res, ret)                                  \\\\\\n+    char *msg = PR_smprintf(\\\"NS_ENSURE_SUCCESS(%s, %s) failed with \\\"      \\\\\\n+                            \\\"result 0x%X\\\", #res, #ret, __rv);             \\\\\\n+    NS_WARNING(msg);                                                      \\\\\\n+    PR_smprintf_free(msg);\\n+\\n+#else\\n+\\n+#define NS_ENSURE_SUCCESS_BODY(res, ret)                                  \\\\\\n+    NS_WARNING(\\\"NS_ENSURE_SUCCESS(\\\" #res \\\", \\\" #ret \\\") failed\\\");\\n+\\n+#endif\\n+\\n+#define NS_ENSURE_SUCCESS(res, ret)                                       \\\\\\n+  PR_BEGIN_MACRO                                                          \\\\\\n+    nsresult __rv = res; /* Don't evaluate |res| more than once */        \\\\\\n+    if (NS_FAILED(__rv)) {                                                \\\\\\n+      NS_ENSURE_SUCCESS_BODY(res, ret)                                    \\\\\\n+      return ret;                                                         \\\\\\n+    }                                                                     \\\\\\n+  PR_END_MACRO\\n \\n /******************************************************************************\\n ** Macros for checking state and arguments upon entering interface boundaries\\n\""}