{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas7306206\""},"diff":"\"7306206 Fix bug 392318.  r+sr+a=sicking.\\ndiff --git a/content/base/src/nsDocument.cpp b/content/base/src/nsDocument.cpp\\nindex 9d503b5..0fd285b 100644\\n--- a/content/base/src/nsDocument.cpp\\n+++ b/content/base/src/nsDocument.cpp\\n@@ -2852,7 +2852,10 @@ void\\n nsDocument::EndLoad()\\n {\\n   // Drop the ref to our parser, if any\\n-  mParser = nsnull;\\n+  if (mParser) {\\n+    mWeakSink = do_GetWeakReference(mParser->GetContentSink());\\n+    mParser = nsnull;\\n+  }\\n   \\n   NS_DOCUMENT_NOTIFY_OBSERVERS(EndLoad, (this));\\n \\n@@ -4842,13 +4845,16 @@ nsDocument::CreateEventGroup(nsIDOMEventGroup **aInstancePtrResult)\\n void\\n nsDocument::FlushPendingNotifications(mozFlushType aType)\\n {\\n+  nsCOMPtr<nsIContentSink> sink;\\n+  if (mParser) {\\n+    sink = mParser->GetContentSink();\\n+  } else {\\n+    sink = do_QueryReferent(mWeakSink);\\n+  }\\n   // Determine if it is safe to flush the sink notifications\\n   // by determining if it safe to flush all the presshells.\\n-  if (mParser && (aType == Flush_Content || IsSafeToFlush())) {\\n-    nsCOMPtr<nsIContentSink> sink = mParser->GetContentSink();\\n-    if (sink) {\\n-      sink->FlushPendingNotifications(aType);\\n-    }\\n+  if (sink && (aType == Flush_Content || IsSafeToFlush())) {\\n+    sink->FlushPendingNotifications(aType);\\n   }\\n \\n   // Should we be flushing pending binding constructors in here?\\ndiff --git a/content/base/src/nsDocument.h b/content/base/src/nsDocument.h\\nindex 5f873e6..849f108 100644\\n--- a/content/base/src/nsDocument.h\\n+++ b/content/base/src/nsDocument.h\\n@@ -728,6 +728,11 @@ protected:\\n   // parsed into.\\n   nsCOMPtr<nsIParser> mParser;\\n \\n+  // Weak reference to our sink for in case we no longer have a parser.  This\\n+  // will allow us to flush out any pending stuff from the sink even if\\n+  // EndLoad() has already happened.\\n+  nsWeakPtr mWeakSink;\\n+\\n   nsCOMArray<nsIStyleSheet> mStyleSheets;\\n   nsCOMArray<nsIStyleSheet> mCatalogSheets;\\n \\ndiff --git a/content/base/test/Makefile.in b/content/base/test/Makefile.in\\nindex 00d1a6e..c2b42f5 100644\\n--- a/content/base/test/Makefile.in\\n+++ b/content/base/test/Makefile.in\\n@@ -87,6 +87,7 @@ _TEST_FILES = \\ttest_bug5141.html \\\\\\n \\t\\ttest_bug375314.html \\\\\\n \\t\\ttest_bug382113.html \\\\\\n \\t\\ttest_bug390735.html \\\\\\n+\\t\\ttest_bug392318.html \\\\\\n \\t\\ttest_bug392511.html \\\\\\n \\t\\ttest_bug395915.html \\\\\\n \\t\\tbug382113_object.html \\\\\\ndiff --git a/content/base/test/test_bug392318.html b/content/base/test/test_bug392318.html\\nnew file mode 100644\\nindex 0000000..c4c10a7\\n--- /dev/null\\n+++ b/content/base/test/test_bug392318.html\\n@@ -0,0 +1,46 @@\\n+<!DOCTYPE HTML>\\n+<html>\\n+<!--\\n+https://bugzilla.mozilla.org/show_bug.cgi?id=392318\\n+-->\\n+<head>\\n+  <title>Test for Bug 392318</title>\\n+  <script type=\\\"text/javascript\\\" src=\\\"/MochiKit/MochiKit.js\\\"></script>\\n+  <script type=\\\"text/javascript\\\" src=\\\"/tests/SimpleTest/SimpleTest.js\\\"></script>\\n+  <link rel=\\\"stylesheet\\\" type=\\\"text/css\\\" href=\\\"/tests/SimpleTest/test.css\\\" />\\n+</head>\\n+<body>\\n+<a target=\\\"_blank\\\" href=\\\"https://bugzilla.mozilla.org/show_bug.cgi?id=392318\\\">Mozilla Bug 392318</a>\\n+<p id=\\\"display\\\"></p>\\n+<div id=\\\"content\\\" style=\\\"display: none\\\">\\n+  \\n+</div>\\n+<pre id=\\\"test\\\">\\n+<script class=\\\"testbody\\\" type=\\\"text/javascript\\\">\\n+/** Test for Bug 392318 **/\\n+\\n+SimpleTest.waitForExplicitFinish();\\n+var testRan = false;\\n+\\n+function runTest() {\\n+  is($(\\\"t\\\").offsetWidth, 202, \\\"Unexpected offsetWidth\\\");\\n+  is($(\\\"t\\\").offsetHeight, 102, \\\"Unexpected offsetHeight\\\");\\n+  testRan = true;\\n+}\\n+\\n+document.addEventListener(\\\"DOMContentLoaded\\\", runTest, false);\\n+\\n+addLoadEvent(function() {\\n+  is(testRan, true, \\\"Onload firing too early\\\");\\n+});\\n+\\n+addLoadEvent(SimpleTest.finish);\\n+</script>\\n+<!-- IMPORTANT: This sheet must come after the test that sets up the\\n+     DOMContentLoaded handler -->\\n+<link rel=\\\"stylesheet\\\" type=\\\"text/css\\\" href=\\\"data:text/css;%20charset=utf-8,%23t%20%7B%0Awidth%3A%20200px%3B%0Aborder%3A%201px%20solid%20black%3B%0Aheight%3A%20100px%3B%0A%7D\\\">\\n+<div id=\\\"t\\\"></div>\\n+</pre>\\n+</body>\\n+</html>\\n+\\n\""}