{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas2521c27\""},"diff":"\"2521c27 Bug 390193 - incorrect gradient transform inside filter. r=longsonr, sr=roc, a=vlad\\ndiff --git a/layout/svg/base/src/nsISVGChildFrame.h b/layout/svg/base/src/nsISVGChildFrame.h\\nindex 0a58ccb..0be28de 100644\\n--- a/layout/svg/base/src/nsISVGChildFrame.h\\n+++ b/layout/svg/base/src/nsISVGChildFrame.h\\n@@ -51,7 +51,8 @@ class nsSVGRenderState;\\n struct nsRect;\\n \\n #define NS_ISVGCHILDFRAME_IID \\\\\\n-{ 0x154fa60f, 0xc605, 0x49c7, { 0x88, 0xc4, 0xc5, 0xb4, 0xdc, 0x12, 0x47, 0xeb } }\\n+{ 0x93560e72, 0x6818, 0x4218, \\\\\\n+ { 0xa1, 0xe9, 0xf3, 0xb9, 0x63, 0x6a, 0xff, 0xc2 } }\\n \\n class nsISVGChildFrame : public nsISupports {\\n public:\\n@@ -85,9 +86,10 @@ public:\\n   NS_IMETHOD SetMatrixPropagation(PRBool aPropagate)=0;\\n \\n   // Set the current transformation matrix to a particular matrix.\\n-  // Value is only used if matrix propogation is prevented\\n+  // Value is only used if matrix propagation is prevented\\n   // (SetMatrixPropagation()).  nsnull aCTM means identity transform.\\n   NS_IMETHOD SetOverrideCTM(nsIDOMSVGMatrix *aCTM)=0;\\n+  virtual already_AddRefed<nsIDOMSVGMatrix> GetOverrideCTM()=0;\\n \\n   // XXX move this function into interface nsISVGLocatableMetrics\\n   NS_IMETHOD GetBBox(nsIDOMSVGRect **_retval)=0; // bbox in local coords\\ndiff --git a/layout/svg/base/src/nsSVGContainerFrame.h b/layout/svg/base/src/nsSVGContainerFrame.h\\nindex a593a94..ad4020d 100644\\n--- a/layout/svg/base/src/nsSVGContainerFrame.h\\n+++ b/layout/svg/base/src/nsSVGContainerFrame.h\\n@@ -111,6 +111,7 @@ public:\\n   NS_IMETHOD NotifyRedrawUnsuspended();\\n   NS_IMETHOD SetMatrixPropagation(PRBool aPropagate) { return NS_ERROR_FAILURE; }\\n   NS_IMETHOD SetOverrideCTM(nsIDOMSVGMatrix *aCTM) { return NS_ERROR_FAILURE; }\\n+  virtual already_AddRefed<nsIDOMSVGMatrix> GetOverrideCTM() { return nsnull; }\\n   NS_IMETHOD GetBBox(nsIDOMSVGRect **_retval);\\n   NS_IMETHOD_(PRBool) IsDisplayContainer() { return PR_TRUE; }\\n   NS_IMETHOD_(PRBool) HasValidCoveredRect() { return PR_FALSE; }\\ndiff --git a/layout/svg/base/src/nsSVGForeignObjectFrame.cpp b/layout/svg/base/src/nsSVGForeignObjectFrame.cpp\\nindex 93e55f9..bb7d2218 100644\\n--- a/layout/svg/base/src/nsSVGForeignObjectFrame.cpp\\n+++ b/layout/svg/base/src/nsSVGForeignObjectFrame.cpp\\n@@ -425,6 +425,14 @@ nsSVGForeignObjectFrame::SetOverrideCTM(nsIDOMSVGMatrix *aCTM)\\n   return NS_OK;\\n }\\n \\n+already_AddRefed<nsIDOMSVGMatrix>\\n+nsSVGForeignObjectFrame::GetOverrideCTM()\\n+{\\n+  nsIDOMSVGMatrix *matrix = mOverrideCTM.get();\\n+  NS_IF_ADDREF(matrix);\\n+  return matrix;\\n+}\\n+\\n NS_IMETHODIMP\\n nsSVGForeignObjectFrame::GetBBox(nsIDOMSVGRect **_retval)\\n {\\ndiff --git a/layout/svg/base/src/nsSVGForeignObjectFrame.h b/layout/svg/base/src/nsSVGForeignObjectFrame.h\\nindex 3e1c1b9..69a6cc7 100644\\n--- a/layout/svg/base/src/nsSVGForeignObjectFrame.h\\n+++ b/layout/svg/base/src/nsSVGForeignObjectFrame.h\\n@@ -121,6 +121,7 @@ public:\\n   NS_IMETHOD NotifyRedrawUnsuspended();\\n   NS_IMETHOD SetMatrixPropagation(PRBool aPropagate);\\n   NS_IMETHOD SetOverrideCTM(nsIDOMSVGMatrix *aCTM);\\n+  virtual already_AddRefed<nsIDOMSVGMatrix> GetOverrideCTM();\\n   NS_IMETHOD GetBBox(nsIDOMSVGRect **_retval);\\n   NS_IMETHOD_(PRBool) IsDisplayContainer() { return PR_TRUE; }\\n   NS_IMETHOD_(PRBool) HasValidCoveredRect() { return PR_FALSE; }\\ndiff --git a/layout/svg/base/src/nsSVGGFrame.cpp b/layout/svg/base/src/nsSVGGFrame.cpp\\nindex faa31a1..3566a50 100644\\n--- a/layout/svg/base/src/nsSVGGFrame.cpp\\n+++ b/layout/svg/base/src/nsSVGGFrame.cpp\\n@@ -93,6 +93,14 @@ nsSVGGFrame::SetOverrideCTM(nsIDOMSVGMatrix *aCTM)\\n }\\n \\n already_AddRefed<nsIDOMSVGMatrix>\\n+nsSVGGFrame::GetOverrideCTM()\\n+{\\n+  nsIDOMSVGMatrix *matrix = mOverrideCTM.get();\\n+  NS_IF_ADDREF(matrix);\\n+  return matrix;\\n+}\\n+\\n+already_AddRefed<nsIDOMSVGMatrix>\\n nsSVGGFrame::GetCanvasTM()\\n {\\n   if (!mPropagateTransform) {\\ndiff --git a/layout/svg/base/src/nsSVGGFrame.h b/layout/svg/base/src/nsSVGGFrame.h\\nindex b5633e8..1b95bc6 100644\\n--- a/layout/svg/base/src/nsSVGGFrame.h\\n+++ b/layout/svg/base/src/nsSVGGFrame.h\\n@@ -76,6 +76,7 @@ public:\\n   NS_IMETHOD NotifyCanvasTMChanged(PRBool suppressInvalidation);\\n   NS_IMETHOD SetMatrixPropagation(PRBool aPropagate);\\n   NS_IMETHOD SetOverrideCTM(nsIDOMSVGMatrix *aCTM);\\n+  virtual already_AddRefed<nsIDOMSVGMatrix> GetOverrideCTM();\\n \\n   // nsSVGContainerFrame methods:\\n   virtual already_AddRefed<nsIDOMSVGMatrix> GetCanvasTM();\\ndiff --git a/layout/svg/base/src/nsSVGGlyphFrame.h b/layout/svg/base/src/nsSVGGlyphFrame.h\\nindex a6f1f26..c01249e 100644\\n--- a/layout/svg/base/src/nsSVGGlyphFrame.h\\n+++ b/layout/svg/base/src/nsSVGGlyphFrame.h\\n@@ -117,6 +117,7 @@ public:\\n   NS_IMETHOD NotifyRedrawUnsuspended();\\n   NS_IMETHOD SetMatrixPropagation(PRBool aPropagate) { return NS_OK; }\\n   NS_IMETHOD SetOverrideCTM(nsIDOMSVGMatrix *aCTM) { return NS_ERROR_FAILURE; }\\n+  virtual already_AddRefed<nsIDOMSVGMatrix> GetOverrideCTM() { return nsnull; }\\n   NS_IMETHOD GetBBox(nsIDOMSVGRect **_retval);\\n   NS_IMETHOD_(PRBool) IsDisplayContainer() { return PR_FALSE; }\\n   NS_IMETHOD_(PRBool) HasValidCoveredRect() { return PR_TRUE; }\\ndiff --git a/layout/svg/base/src/nsSVGGradientFrame.cpp b/layout/svg/base/src/nsSVGGradientFrame.cpp\\nindex d06f0e8..ab55815 100644\\n--- a/layout/svg/base/src/nsSVGGradientFrame.cpp\\n+++ b/layout/svg/base/src/nsSVGGradientFrame.cpp\\n@@ -269,10 +269,13 @@ nsSVGGradientFrame::GetGradientTransform(nsSVGGeometryFrame *aSource)\\n     }\\n     nsCOMPtr<nsIDOMSVGRect> rect;\\n     if (frame) {\\n+      nsCOMPtr<nsIDOMSVGMatrix> matrix = frame->GetOverrideCTM();\\n       frame->SetMatrixPropagation(PR_FALSE);\\n+      frame->SetOverrideCTM(nsnull);\\n       frame->NotifyCanvasTMChanged(PR_TRUE);\\n       frame->GetBBox(getter_AddRefs(rect));\\n       frame->SetMatrixPropagation(PR_TRUE);\\n+      frame->SetOverrideCTM(matrix);\\n       frame->NotifyCanvasTMChanged(PR_TRUE);\\n     }\\n     if (rect) {\\ndiff --git a/layout/svg/base/src/nsSVGInnerSVGFrame.cpp b/layout/svg/base/src/nsSVGInnerSVGFrame.cpp\\nindex f747df8f..a30f0bc 100644\\n--- a/layout/svg/base/src/nsSVGInnerSVGFrame.cpp\\n+++ b/layout/svg/base/src/nsSVGInnerSVGFrame.cpp\\n@@ -90,6 +90,7 @@ public:\\n   NS_IMETHOD NotifyCanvasTMChanged(PRBool suppressInvalidation);\\n   NS_IMETHOD SetMatrixPropagation(PRBool aPropagate);\\n   NS_IMETHOD SetOverrideCTM(nsIDOMSVGMatrix *aCTM);\\n+  virtual already_AddRefed<nsIDOMSVGMatrix> GetOverrideCTM();\\n   NS_IMETHOD GetFrameForPointSVG(float x, float y, nsIFrame** hit);\\n \\n   // nsSVGContainerFrame methods:\\n@@ -213,6 +214,14 @@ nsSVGInnerSVGFrame::SetOverrideCTM(nsIDOMSVGMatrix *aCTM)\\n   return NS_OK;\\n }\\n \\n+already_AddRefed<nsIDOMSVGMatrix>\\n+nsSVGInnerSVGFrame::GetOverrideCTM()\\n+{\\n+  nsIDOMSVGMatrix *matrix = mOverrideCTM.get();\\n+  NS_IF_ADDREF(matrix);\\n+  return matrix;\\n+}\\n+\\n NS_IMETHODIMP\\n nsSVGInnerSVGFrame::GetFrameForPointSVG(float x, float y, nsIFrame** hit)\\n {\\ndiff --git a/layout/svg/base/src/nsSVGPathGeometryFrame.cpp b/layout/svg/base/src/nsSVGPathGeometryFrame.cpp\\nindex 74d41d5..a3f9c36 100644\\n--- a/layout/svg/base/src/nsSVGPathGeometryFrame.cpp\\n+++ b/layout/svg/base/src/nsSVGPathGeometryFrame.cpp\\n@@ -496,6 +496,14 @@ nsSVGPathGeometryFrame::SetOverrideCTM(nsIDOMSVGMatrix *aCTM)\\n   return NS_OK;\\n }\\n \\n+already_AddRefed<nsIDOMSVGMatrix>\\n+nsSVGPathGeometryFrame::GetOverrideCTM()\\n+{\\n+  nsIDOMSVGMatrix *matrix = mOverrideCTM.get();\\n+  NS_IF_ADDREF(matrix);\\n+  return matrix;\\n+}\\n+\\n NS_IMETHODIMP\\n nsSVGPathGeometryFrame::GetBBox(nsIDOMSVGRect **_retval)\\n {\\ndiff --git a/layout/svg/base/src/nsSVGPathGeometryFrame.h b/layout/svg/base/src/nsSVGPathGeometryFrame.h\\nindex 146d4c5..859c888 100644\\n--- a/layout/svg/base/src/nsSVGPathGeometryFrame.h\\n+++ b/layout/svg/base/src/nsSVGPathGeometryFrame.h\\n@@ -113,6 +113,7 @@ protected:\\n   NS_IMETHOD NotifyRedrawUnsuspended();\\n   NS_IMETHOD SetMatrixPropagation(PRBool aPropagate);\\n   NS_IMETHOD SetOverrideCTM(nsIDOMSVGMatrix *aCTM);\\n+  virtual already_AddRefed<nsIDOMSVGMatrix> GetOverrideCTM();\\n   NS_IMETHOD GetBBox(nsIDOMSVGRect **_retval);\\n   NS_IMETHOD_(PRBool) IsDisplayContainer() { return PR_FALSE; }\\n   NS_IMETHOD_(PRBool) HasValidCoveredRect() { return PR_TRUE; }\\ndiff --git a/layout/svg/base/src/nsSVGTSpanFrame.cpp b/layout/svg/base/src/nsSVGTSpanFrame.cpp\\nindex adff538..39d8745 100644\\n--- a/layout/svg/base/src/nsSVGTSpanFrame.cpp\\n+++ b/layout/svg/base/src/nsSVGTSpanFrame.cpp\\n@@ -116,6 +116,14 @@ nsSVGTSpanFrame::SetOverrideCTM(nsIDOMSVGMatrix *aCTM)\\n   return NS_OK;\\n }\\n \\n+already_AddRefed<nsIDOMSVGMatrix>\\n+nsSVGTSpanFrame::GetOverrideCTM()\\n+{\\n+  nsIDOMSVGMatrix *matrix = mOverrideCTM.get();\\n+  NS_IF_ADDREF(matrix);\\n+  return matrix;\\n+}\\n+\\n //----------------------------------------------------------------------\\n // nsSVGContainerFrame methods:\\n \\ndiff --git a/layout/svg/base/src/nsSVGTSpanFrame.h b/layout/svg/base/src/nsSVGTSpanFrame.h\\nindex c7f98bc..95a9bfa 100644\\n--- a/layout/svg/base/src/nsSVGTSpanFrame.h\\n+++ b/layout/svg/base/src/nsSVGTSpanFrame.h\\n@@ -83,7 +83,8 @@ public:\\n   // nsISVGChildFrame interface:\\n   NS_IMETHOD SetMatrixPropagation(PRBool aPropagate);\\n   NS_IMETHOD SetOverrideCTM(nsIDOMSVGMatrix *aCTM);\\n-  \\n+  virtual already_AddRefed<nsIDOMSVGMatrix> GetOverrideCTM();\\n+\\n   // nsSVGContainerFrame methods:\\n   virtual already_AddRefed<nsIDOMSVGMatrix> GetCanvasTM();\\n   \\ndiff --git a/layout/svg/base/src/nsSVGTextFrame.cpp b/layout/svg/base/src/nsSVGTextFrame.cpp\\nindex abb4789..50d48b6 100644\\n--- a/layout/svg/base/src/nsSVGTextFrame.cpp\\n+++ b/layout/svg/base/src/nsSVGTextFrame.cpp\\n@@ -238,6 +238,14 @@ nsSVGTextFrame::SetOverrideCTM(nsIDOMSVGMatrix *aCTM)\\n   return NS_OK;\\n }\\n \\n+already_AddRefed<nsIDOMSVGMatrix>\\n+nsSVGTextFrame::GetOverrideCTM()\\n+{\\n+  nsIDOMSVGMatrix *matrix = mOverrideCTM.get();\\n+  NS_IF_ADDREF(matrix);\\n+  return matrix;\\n+}\\n+\\n NS_IMETHODIMP\\n nsSVGTextFrame::GetBBox(nsIDOMSVGRect **_retval)\\n {\\ndiff --git a/layout/svg/base/src/nsSVGTextFrame.h b/layout/svg/base/src/nsSVGTextFrame.h\\nindex 697c73c..3d98d06 100755\\n--- a/layout/svg/base/src/nsSVGTextFrame.h\\n+++ b/layout/svg/base/src/nsSVGTextFrame.h\\n@@ -80,6 +80,7 @@ public:\\n   // nsISVGChildFrame interface:\\n   NS_IMETHOD SetMatrixPropagation(PRBool aPropagate);\\n   NS_IMETHOD SetOverrideCTM(nsIDOMSVGMatrix *aCTM);\\n+  virtual already_AddRefed<nsIDOMSVGMatrix> GetOverrideCTM();\\n   NS_IMETHOD NotifyCanvasTMChanged(PRBool suppressInvalidation);\\n   NS_IMETHOD NotifyRedrawSuspended();\\n   NS_IMETHOD NotifyRedrawUnsuspended();\\n\""}