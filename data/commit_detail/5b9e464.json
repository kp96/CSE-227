{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas5b9e464\""},"diff":"\"5b9e464 bug 393632. cache cjk resolved font list as well. r=elif\\ndiff --git a/gfx/thebes/src/gfxWindowsFonts.cpp b/gfx/thebes/src/gfxWindowsFonts.cpp\\nindex 4fff9fc..6ae5cbe 100644\\n--- a/gfx/thebes/src/gfxWindowsFonts.cpp\\n+++ b/gfx/thebes/src/gfxWindowsFonts.cpp\\n@@ -1344,6 +1344,7 @@ private:\\n         return -1;\\n     }\\n \\n+    // this function appends to the array passed in.\\n     void GetPrefFonts(const char *aLangGroup, nsTArray<nsRefPtr<FontEntry> >& array) {\\n         NS_ASSERTION(aLangGroup, \\\"aLangGroup is null\\\");\\n         gfxWindowsPlatform *platform = gfxWindowsPlatform::GetPlatform();\\n@@ -1361,58 +1362,64 @@ private:\\n         array.AppendElements(fonts);\\n     }\\n \\n+    // this function assigns to the array passed in.\\n     void GetCJKPrefFonts(nsTArray<nsRefPtr<FontEntry> >& array) {\\n-       nsCOMPtr<nsIPrefService> prefs = do_GetService(NS_PREFSERVICE_CONTRACTID);\\n-       if (!prefs)\\n-           return;\\n-\\n-       nsCOMPtr<nsIPrefBranch> prefBranch;\\n-       prefs->GetBranch(0, getter_AddRefs(prefBranch));\\n-       if (!prefBranch)\\n-           return;\\n-\\n-       // Add by the order of accept languages.\\n-       nsXPIDLCString list;\\n-       nsresult rv = prefBranch->GetCharPref(\\\"intl.accept_languages\\\", getter_Copies(list));\\n-       if (NS_SUCCEEDED(rv) && !list.IsEmpty()) {\\n-           const char kComma = ',';\\n-           const char *p, *p_end;\\n-           list.BeginReading(p);\\n-           list.EndReading(p_end);\\n-           while (p < p_end) {\\n-               while (nsCRT::IsAsciiSpace(*p)) {\\n-                   if (++p == p_end)\\n-                       break;\\n-               }\\n-               if (p == p_end)\\n-                   break;\\n-               const char *start = p;\\n-               while (++p != p_end && *p != kComma)\\n-                   /* nothing */ ;\\n-               nsCAutoString lang(Substring(start, p));\\n-               lang.CompressWhitespace(PR_FALSE, PR_TRUE);\\n-               PRInt32 index = GetCJKLangGroupIndex(lang.get());\\n-               if (index >= 0)\\n-                   GetPrefFonts(sCJKLangGroup[index], array);\\n-               p++;\\n-           }\\n-       }\\n-\\n-       // Add the system locale\\n-       switch (::GetACP()) {\\n-           case 932: GetPrefFonts(CJK_LANG_JA, array);    break;\\n-           case 936: GetPrefFonts(CJK_LANG_ZH_CN, array); break;\\n-           case 949: GetPrefFonts(CJK_LANG_KO, array);    break;\\n-           // XXX Don't we need to append CJK_LANG_ZH_HK if the codepage is 950?\\n-           case 950: GetPrefFonts(CJK_LANG_ZH_TW, array); break;\\n-       }\\n-\\n-       // last resort...\\n-       GetPrefFonts(CJK_LANG_JA, array);\\n-       GetPrefFonts(CJK_LANG_KO, array);\\n-       GetPrefFonts(CJK_LANG_ZH_CN, array);\\n-       GetPrefFonts(CJK_LANG_ZH_HK, array);\\n-       GetPrefFonts(CJK_LANG_ZH_TW, array);\\n+        gfxWindowsPlatform *platform = gfxWindowsPlatform::GetPlatform();\\n+        if (!platform->GetPrefFontEntries(\\\"x-internal-cjk\\\", &array)) {\\n+            nsCOMPtr<nsIPrefService> prefs = do_GetService(NS_PREFSERVICE_CONTRACTID);\\n+            if (!prefs)\\n+                return;\\n+\\n+            nsCOMPtr<nsIPrefBranch> prefBranch;\\n+            prefs->GetBranch(0, getter_AddRefs(prefBranch));\\n+            if (!prefBranch)\\n+                return;\\n+\\n+            // Add by the order of accept languages.\\n+            nsXPIDLCString list;\\n+            nsresult rv = prefBranch->GetCharPref(\\\"intl.accept_languages\\\", getter_Copies(list));\\n+            if (NS_SUCCEEDED(rv) && !list.IsEmpty()) {\\n+                const char kComma = ',';\\n+                const char *p, *p_end;\\n+                list.BeginReading(p);\\n+                list.EndReading(p_end);\\n+                while (p < p_end) {\\n+                    while (nsCRT::IsAsciiSpace(*p)) {\\n+                        if (++p == p_end)\\n+                            break;\\n+                    }\\n+                    if (p == p_end)\\n+                        break;\\n+                    const char *start = p;\\n+                    while (++p != p_end && *p != kComma)\\n+                        /* nothing */ ;\\n+                    nsCAutoString lang(Substring(start, p));\\n+                    lang.CompressWhitespace(PR_FALSE, PR_TRUE);\\n+                    PRInt32 index = GetCJKLangGroupIndex(lang.get());\\n+                    if (index >= 0)\\n+                        GetPrefFonts(sCJKLangGroup[index], array);\\n+                    p++;\\n+                }\\n+            }\\n+\\n+            // Add the system locale\\n+            switch (::GetACP()) {\\n+                case 932: GetPrefFonts(CJK_LANG_JA, array); break;\\n+                case 936: GetPrefFonts(CJK_LANG_ZH_CN, array); break;\\n+                case 949: GetPrefFonts(CJK_LANG_KO, array); break;\\n+                // XXX Don't we need to append CJK_LANG_ZH_HK if the codepage is 950?\\n+                case 950: GetPrefFonts(CJK_LANG_ZH_TW, array); break;\\n+            }\\n+\\n+            // last resort...\\n+            GetPrefFonts(CJK_LANG_JA, array);\\n+            GetPrefFonts(CJK_LANG_KO, array);\\n+            GetPrefFonts(CJK_LANG_ZH_CN, array);\\n+            GetPrefFonts(CJK_LANG_ZH_HK, array);\\n+            GetPrefFonts(CJK_LANG_ZH_TW, array);\\n+\\n+            platform->SetPrefFontEntries(\\\"x-internal-cjk\\\", array);\\n+        }\\n     }\\n \\n     void GenerateAlternativeString() {\\n@@ -1456,8 +1463,6 @@ private:\\n     GOFFSET *mOffsets;\\n     int *mAdvances;\\n \\n-    nsTArray< nsRefPtr<gfxWindowsFont> > mFonts;\\n-\\n     nsRefPtr<gfxWindowsFont> mCurrentFont;\\n \\n     PRPackedBool mFontSelected;\\ndiff --git a/gfx/thebes/src/gfxWindowsPlatform.cpp b/gfx/thebes/src/gfxWindowsPlatform.cpp\\nindex e9e77e6..1a683d5 100644\\n--- a/gfx/thebes/src/gfxWindowsPlatform.cpp\\n+++ b/gfx/thebes/src/gfxWindowsPlatform.cpp\\n@@ -70,6 +70,8 @@\\n int PR_CALLBACK\\n gfxWindowsPlatform::PrefChangedCallback(const char *aPrefName, void *closure)\\n {\\n+    // XXX this could be made to only clear out the cache for the prefs that were changed\\n+    // but it probably isn't that big a deal.\\n     gfxWindowsPlatform *plat = static_cast<gfxWindowsPlatform *>(closure);\\n     plat->mPrefFonts.Clear();\\n     return 0;\\n@@ -87,6 +89,7 @@ gfxWindowsPlatform::gfxWindowsPlatform()\\n     nsCOMPtr<nsIPref> pref = do_GetService(NS_PREF_CONTRACTID);\\n     pref->RegisterCallback(\\\"font.\\\", PrefChangedCallback, this);\\n     pref->RegisterCallback(\\\"font.name-list.\\\", PrefChangedCallback, this);\\n+    pref->RegisterCallback(\\\"intl.accept_languages\\\", PrefChangedCallback, this);\\n     // don't bother unregistering.  We'll get shutdown after the pref service\\n }\\n \\n\""}