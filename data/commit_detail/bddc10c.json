{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basbddc10c\""},"diff":"\"bddc10c bug 231393 - Tab URL does not persist on bad links if tabs switched, patch by pike@pikey.me.uk based on jag's patch for bug 103720, r=me\\ndiff --git a/browser/base/content/tabbrowser.xml b/browser/base/content/tabbrowser.xml\\nindex 9e5b19a..d46ed82 100644\\n--- a/browser/base/content/tabbrowser.xml\\n+++ b/browser/base/content/tabbrowser.xml\\n@@ -194,10 +194,13 @@\\n \\n               if (aStateFlags & nsIWebProgressListener.STATE_START && \\n                   aStateFlags & nsIWebProgressListener.STATE_IS_NETWORK) {\\n-                // Reset so we can see if the user typed between the document\\n-                // load starting and the location changing.\\n+                // It's okay to clear what the user typed when we start\\n+                // loading a document. If the user types, this flag gets\\n+                // set to false, if the document load ends without an\\n+                // onLocationChange, this flag also gets set to false\\n+                // (so we keep it while switching tabs after failed load\\n                 if (aWebProgress.DOMWindow == this.mBrowser.contentWindow)\\n-                  this.mBrowser.userTypedValue = null;\\n+                  this.mBrowser.userTypedClear = true;\\n \\n                 if (!this.mBlank) {\\n                   this.mTab.setAttribute(\\\"busy\\\", \\\"true\\\");\\n@@ -211,6 +214,11 @@\\n               }\\n               else if (aStateFlags & nsIWebProgressListener.STATE_STOP &&\\n                        aStateFlags & nsIWebProgressListener.STATE_IS_NETWORK) {\\n+                // The document is done loading, it's okay to clear\\n+                // the value again.\\n+                if (aWebProgress.DOMWindow == this.mBrowser.contentWindow)\\n+                  this.mBrowser.userTypedClear = false;\\n+\\n                 if (this.mBlank)\\n                   this.mBlank = false;\\n \\n@@ -242,6 +250,10 @@\\n             ,\\n \\n             onLocationChange : function(aWebProgress, aRequest, aLocation) {\\n+              // The document loaded correctly, clear the value if we should\\n+              if (this.mBrowser.userTypedClear)\\n+                this.mBrowser.userTypedValue = null;\\n+\\n               if (!this.mBlank && this.mTabBrowser.mCurrentTab == this.mTab) {\\n                 for (var i = 0; i < this.mTabBrowser.mProgressListeners.length; i++) {\\n                   var p = this.mTabBrowser.mProgressListeners[i];\\n@@ -451,6 +463,11 @@\\n \\n             var webProgress = this.mCurrentBrowser.webProgress;\\n             var securityUI = this.mCurrentBrowser.securityUI;\\n+            // Remember the current clear state, then set it to false\\n+            // so we don't clear the userTypedValue when just switching\\n+            // tabs. Set it back to its old state after we're done.\\n+            var userTypedClear = this.mCurrentBrowser.userTypedClear;\\n+            this.mCurrentBrowser.userTypedClear = false;\\n             var i, p;\\n             for (i = 0; i < this.mProgressListeners.length; i++) {\\n               p = this.mProgressListeners[i];\\n@@ -463,6 +480,7 @@\\n                   p.onLinkIconAvailable(listener.mIcon);\\n               }\\n             }\\n+            this.mCurrentBrowser.userTypedClear = userTypedClear;\\n \\n             // Update the window title.\\n             this.updateTitlebar();\\n@@ -817,6 +835,10 @@\\n             this.mTabFilters[position] = filter;\\n \\n             if (!blank) {\\n+              // pretend the user typed this so it'll be available till\\n+              // the document successfully loads\\n+              b.userTypedValue = aURI;\\n+\\n               if (aPostData === undefined)\\n                 aPostData = null;\\n               b.loadURIWithFlags(aURI, nsIWebNavigation.LOAD_FLAGS_NONE,\\n@@ -1349,6 +1371,10 @@\\n                 onget=\\\"return this.mCurrentBrowser.canFindAgain;\\\"\\n                 readonly=\\\"true\\\"/>\\n \\n+      <property name=\\\"userTypedClear\\\"\\n+                onget=\\\"return this.mCurrentBrowser.userTypedClear;\\\"\\n+                onset=\\\"return this.mCurrentBrowser.userTypedClear = val;\\\"/>\\n+\\n       <property name=\\\"userTypedValue\\\"\\n                 onget=\\\"return this.mCurrentBrowser.userTypedValue;\\\"\\n                 onset=\\\"return this.mCurrentBrowser.userTypedValue = val;\\\"/>\\n\""}