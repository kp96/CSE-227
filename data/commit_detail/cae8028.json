{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bascae8028\""},"diff":"\"cae8028 Bug 379886 - Font preferences panel selects random fonts in cairo builds, patch by Karl Tomlinson <mozbugz@karlt.net>, r+sr=vlad/pavlov\\ndiff --git a/gfx/thebes/src/gfxFontconfigUtils.cpp b/gfx/thebes/src/gfxFontconfigUtils.cpp\\nindex a11b571..7d8091e 100755\\n--- a/gfx/thebes/src/gfxFontconfigUtils.cpp\\n+++ b/gfx/thebes/src/gfxFontconfigUtils.cpp\\n@@ -78,7 +78,9 @@ gfxFontconfigUtils::GetFontList(const nsACString& aLangGroup,\\n     for (PRInt32 i = 0; i < fonts->Count(); ++i)\\n          aListOfFonts.AppendString(NS_ConvertUTF8toUTF16(*fonts->CStringAt(i)));\\n \\n-    PRInt32 serif = 0, sansSerif = 0, monospace = 0, nGenerics;\\n+    aListOfFonts.Sort();\\n+\\n+    PRInt32 serif = 0, sansSerif = 0, monospace = 0;\\n \\n     // Fontconfig supports 3 generic fonts, \\\"serif\\\", \\\"sans-serif\\\", and\\n     // \\\"monospace\\\", slightly different from CSS's 5.\\n@@ -95,16 +97,16 @@ gfxFontconfigUtils::GetFontList(const nsACString& aLangGroup,\\n         serif = sansSerif = 1;\\n     else\\n         NS_NOTREACHED(\\\"unexpected CSS generic font family\\\");\\n-    nGenerics = serif + sansSerif + monospace;\\n \\n-    if (serif)\\n-        aListOfFonts.AppendString(NS_LITERAL_STRING(\\\"serif\\\"));\\n-    if (sansSerif)\\n-        aListOfFonts.AppendString(NS_LITERAL_STRING(\\\"sans-serif\\\"));\\n+    // The first in the list becomes the default in\\n+    // gFontsDialog.readFontSelection() if the preference-selected font is not\\n+    // available, so put system configured defaults first.\\n     if (monospace)\\n-        aListOfFonts.AppendString(NS_LITERAL_STRING(\\\"monospace\\\"));\\n-\\n-    aListOfFonts.Sort();\\n+        aListOfFonts.InsertStringAt(NS_LITERAL_STRING(\\\"monospace\\\"), 0);\\n+    if (sansSerif)\\n+        aListOfFonts.InsertStringAt(NS_LITERAL_STRING(\\\"sans-serif\\\"), 0);\\n+    if (serif)\\n+        aListOfFonts.InsertStringAt(NS_LITERAL_STRING(\\\"serif\\\"), 0);\\n \\n     return NS_OK;\\n }\\ndiff --git a/modules/libpref/src/init/all.js b/modules/libpref/src/init/all.js\\nindex 8e6e314..82bb4cb 100644\\n--- a/modules/libpref/src/init/all.js\\n+++ b/modules/libpref/src/init/all.js\\n@@ -2057,33 +2057,33 @@ pref(\\\"font.name.monospace.ko\\\", \\\"monospace\\\");\\n \\n // th\\n \\n-pref(\\\"font.name.serif.tr\\\", \\\"Times\\\");\\n-pref(\\\"font.name.sans-serif.tr\\\", \\\"Helvetica\\\");\\n-pref(\\\"font.name.monospace.tr\\\", \\\"Courier\\\");\\n+pref(\\\"font.name.serif.tr\\\", \\\"serif\\\");\\n+pref(\\\"font.name.sans-serif.tr\\\", \\\"sans-serif\\\");\\n+pref(\\\"font.name.monospace.tr\\\", \\\"monospace\\\");\\n \\n pref(\\\"font.name.serif.x-baltic\\\", \\\"serif\\\");\\n pref(\\\"font.name.sans-serif.x-baltic\\\", \\\"sans-serif\\\");\\n pref(\\\"font.name.monospace.x-baltic\\\", \\\"monospace\\\");\\n \\n-pref(\\\"font.name.serif.x-central-euro\\\", \\\"Times\\\");\\n-pref(\\\"font.name.sans-serif.x-central-euro\\\", \\\"Helvetica\\\");\\n-pref(\\\"font.name.monospace.x-central-euro\\\", \\\"Courier\\\");\\n+pref(\\\"font.name.serif.x-central-euro\\\", \\\"serif\\\");\\n+pref(\\\"font.name.sans-serif.x-central-euro\\\", \\\"sans-serif\\\");\\n+pref(\\\"font.name.monospace.x-central-euro\\\", \\\"monospace\\\");\\n \\n pref(\\\"font.name.serif.x-cyrillic\\\", \\\"serif\\\");\\n pref(\\\"font.name.sans-serif.x-cyrillic\\\", \\\"sans-serif\\\");\\n pref(\\\"font.name.monospace.x-cyrillic\\\", \\\"monospace\\\");\\n \\n-pref(\\\"font.name.serif.x-unicode\\\", \\\"Times\\\");\\n-pref(\\\"font.name.sans-serif.x-unicode\\\", \\\"Helvetica\\\");\\n-pref(\\\"font.name.monospace.x-unicode\\\", \\\"Courier\\\");\\n+pref(\\\"font.name.serif.x-unicode\\\", \\\"serif\\\");\\n+pref(\\\"font.name.sans-serif.x-unicode\\\", \\\"sans-serif\\\");\\n+pref(\\\"font.name.monospace.x-unicode\\\", \\\"monospace\\\");\\n \\n-pref(\\\"font.name.serif.x-user-def\\\", \\\"Times\\\");\\n-pref(\\\"font.name.sans-serif.x-user-def\\\", \\\"Helvetica\\\");\\n-pref(\\\"font.name.monospace.x-user-def\\\", \\\"Courier\\\");\\n+pref(\\\"font.name.serif.x-user-def\\\", \\\"serif\\\");\\n+pref(\\\"font.name.sans-serif.x-user-def\\\", \\\"sans-serif\\\");\\n+pref(\\\"font.name.monospace.x-user-def\\\", \\\"monospace\\\");\\n \\n-pref(\\\"font.name.serif.x-western\\\", \\\"Times\\\");\\n-pref(\\\"font.name.sans-serif.x-western\\\", \\\"Helvetica\\\");\\n-pref(\\\"font.name.monospace.x-western\\\", \\\"Courier\\\");\\n+pref(\\\"font.name.serif.x-western\\\", \\\"serif\\\");\\n+pref(\\\"font.name.sans-serif.x-western\\\", \\\"sans-serif\\\");\\n+pref(\\\"font.name.monospace.x-western\\\", \\\"monospace\\\");\\n \\n pref(\\\"font.name.serif.zh-CN\\\", \\\"serif\\\");\\n pref(\\\"font.name.sans-serif.zh-CN\\\", \\\"sans-serif\\\");\\n\""}