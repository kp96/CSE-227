{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas9700f55\""},"diff":"\"9700f55 Bug 392567 - \\\"Impossible to submit forms to JAR URLs\\\" [p=trev.moz@adblockplus.org (Wladimir Palant) r=bzbarsky sr=sicking a1.9=sicking]\\ndiff --git a/content/html/content/src/nsFormSubmission.cpp b/content/html/content/src/nsFormSubmission.cpp\\nindex 559c3ae..6992401 100644\\n--- a/content/html/content/src/nsFormSubmission.cpp\\n+++ b/content/html/content/src/nsFormSubmission.cpp\\n@@ -57,6 +57,7 @@\\n #include \\\"nsStringStream.h\\\"\\n #include \\\"nsIFormProcessor.h\\\"\\n #include \\\"nsIURI.h\\\"\\n+#include \\\"nsIURL.h\\\"\\n #include \\\"nsNetUtil.h\\\"\\n #include \\\"nsLinebreakConverter.h\\\"\\n #include \\\"nsICharsetConverterManager.h\\\"\\n@@ -532,29 +533,35 @@ nsFSURLEncoded::GetEncodedSubmission(nsIURI* aURI,\\n       return NS_OK;\\n     }\\n \\n-    nsCAutoString path;\\n-    rv = aURI->GetPath(path);\\n-    NS_ENSURE_SUCCESS(rv, rv);\\n-    // Bug 42616: Trim off named anchor and save it to add later\\n-    PRInt32 namedAnchorPos = path.FindChar('#');\\n-    nsCAutoString namedAnchor;\\n-    if (kNotFound != namedAnchorPos) {\\n-      path.Right(namedAnchor, (path.Length() - namedAnchorPos));\\n-      path.Truncate(namedAnchorPos);\\n+    nsCOMPtr<nsIURL> url = do_QueryInterface(aURI);\\n+    if (url) {\\n+      url->SetQuery(mQueryString);\\n     }\\n+    else {\\n+      nsCAutoString path;\\n+      rv = aURI->GetPath(path);\\n+      NS_ENSURE_SUCCESS(rv, rv);\\n+      // Bug 42616: Trim off named anchor and save it to add later\\n+      PRInt32 namedAnchorPos = path.FindChar('#');\\n+      nsCAutoString namedAnchor;\\n+      if (kNotFound != namedAnchorPos) {\\n+        path.Right(namedAnchor, (path.Length() - namedAnchorPos));\\n+        path.Truncate(namedAnchorPos);\\n+      }\\n \\n-    // Chop off old query string (bug 25330, 57333)\\n-    // Only do this for GET not POST (bug 41585)\\n-    PRInt32 queryStart = path.FindChar('?');\\n-    if (kNotFound != queryStart) {\\n-      path.Truncate(queryStart);\\n-    }\\n+      // Chop off old query string (bug 25330, 57333)\\n+      // Only do this for GET not POST (bug 41585)\\n+      PRInt32 queryStart = path.FindChar('?');\\n+      if (kNotFound != queryStart) {\\n+        path.Truncate(queryStart);\\n+      }\\n \\n-    path.Append('?');\\n-    // Bug 42616: Add named anchor to end after query string\\n-    path.Append(mQueryString + namedAnchor);\\n+      path.Append('?');\\n+      // Bug 42616: Add named anchor to end after query string\\n+      path.Append(mQueryString + namedAnchor);\\n \\n-    aURI->SetPath(path);\\n+      aURI->SetPath(path);\\n+    }\\n   }\\n \\n   return rv;\\ndiff --git a/content/html/content/test/Makefile.in b/content/html/content/test/Makefile.in\\nindex 6c19dce..c98acd1 100644\\n--- a/content/html/content/test/Makefile.in\\n+++ b/content/html/content/test/Makefile.in\\n@@ -96,6 +96,7 @@ _TEST_FILES = \\ttest_bug589.html \\\\\\n \\t\\ttest_bug388746.html \\\\\\n \\t\\ttest_bug389797.html \\\\\\n \\t\\ttest_bug391994.html \\\\\\n+\\t\\ttest_bug392567.html \\\\\\n \\t\\ttest_bug394700.html \\\\\\n \\t\\t$(NULL)\\n \\ndiff --git a/content/html/content/test/test_bug392567.html b/content/html/content/test/test_bug392567.html\\nnew file mode 100644\\nindex 0000000..4087618\\n--- /dev/null\\n+++ b/content/html/content/test/test_bug392567.html\\n@@ -0,0 +1,72 @@\\n+<!DOCTYPE HTML>\\n+<html>\\n+<!--\\n+https://bugzilla.mozilla.org/show_bug.cgi?id=392567\\n+-->\\n+<head>\\n+  <title>Test for Bug 392567</title>\\n+  <script type=\\\"text/javascript\\\" src=\\\"/MochiKit/MochiKit.js\\\"></script>\\n+  <script type=\\\"text/javascript\\\" src=\\\"/tests/SimpleTest/SimpleTest.js\\\"></script>\\n+  <link rel=\\\"stylesheet\\\" type=\\\"text/css\\\" href=\\\"/tests/SimpleTest/test.css\\\" />\\n+</head>\\n+<body>\\n+<a target=\\\"_blank\\\" href=\\\"https://bugzilla.mozilla.org/show_bug.cgi?id=392567\\\">Mozilla Bug 392567</a>\\n+<p id=\\\"display\\\"><iframe name=\\\"testFrame\\\" id=\\\"testFrame\\\" style=\\\"visibility: hidden;\\\"></iframe></p>\\n+<div id=\\\"content\\\" style=\\\"display: none\\\">\\n+  <form name=\\\"testForm\\\" target=\\\"testFrame\\\">\\n+    <input type=\\\"text\\\" name=\\\"key\\\" />\\n+  </form>\\n+</div>\\n+<pre id=\\\"test\\\">\\n+<script class=\\\"testbody\\\" type=\\\"text/javascript\\\">\\n+\\n+/** Test for Bug 392567 **/\\n+\\n+var dataUrl = \\\"data:application/octet-stream;base64,UEsDBBQAAgAIAO1yETcAAAAAAgAAAAAAAAAKAAAAaW5kZXguaHRtbAMAUEsBAhQAFAACAAgA7XIRNwAAAAACAAAAAAAAAAoAAAAAAAAAAAAgAAAAAAAAAGluZGV4Lmh0bWxQSwUGAAAAAAEAAQA4AAAAKgAAAAAA\\\";\\n+var jarUrl = \\\"jar:\\\" + dataUrl + \\\"!/index.html\\\";\\n+var httpUrl = location.href.replace(/\\\\.html.*/, \\\"_404\\\");\\n+\\n+var form = document.forms.testForm;\\n+var frame = frames.testFrame;\\n+document.getElementById(\\\"testFrame\\\").onload = processTestResult;\\n+\\n+// List of tests to run, each test consists of form action URL and expected result URL\\n+var tests = [\\n+  [jarUrl, jarUrl + \\\"?$PARAMS\\\"],\\n+  [jarUrl + \\\"?jarTest1=jarTest2\\\", jarUrl + \\\"?$PARAMS\\\"],\\n+  [jarUrl + \\\"?jarTest3=jarTest4#jarTest5\\\", jarUrl + \\\"?$PARAMS#jarTest5\\\"],\\n+  [\\\"data:text/html,<html></html>\\\", \\\"data:text/html,<html></html>?$PARAMS\\\"],\\n+  [\\\"data:text/html,<html>How%20about%20this?</html>\\\", \\\"data:text/html,<html>How%20about%20this?$PARAMS\\\"],\\n+  [httpUrl, httpUrl + \\\"?$PARAMS\\\"],\\n+  [httpUrl + \\\"?httpTest1=httpTest2\\\", httpUrl + \\\"?$PARAMS\\\"],\\n+  [httpUrl + \\\"?httpTest3=httpTest4#httpTest5\\\", httpUrl + \\\"?$PARAMS#httpTest5\\\"]\\n+];\\n+\\n+var currentTest = -1;\\n+\\n+SimpleTest.waitForExplicitFinish(); \\n+runNextTest();\\n+\\n+function runNextTest() {\\n+  currentTest++;\\n+  if (currentTest >= tests.length) {\\n+    SimpleTest.finish();\\n+    return;\\n+  }\\n+\\n+  form.action = tests[currentTest][0];\\n+  form.key.value = \\\"value\\\" + currentTest;\\n+  form.submit();\\n+}\\n+\\n+function processTestResult() {\\n+  var expected = tests[currentTest][1].replace(/\\\\$PARAMS/, \\\"key=value\\\" + currentTest);\\n+  is(frame.location.href, expected, \\\"Submitting to \\\" + tests[currentTest][0]);\\n+\\n+  setTimeout(runNextTest, 0);\\n+}\\n+\\n+</script>\\n+</pre>\\n+</body>\\n+</html>\\n\""}