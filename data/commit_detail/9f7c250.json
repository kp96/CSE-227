{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas9f7c250\""},"diff":"\"9f7c250 Bug 392652, nsXULPopupManager::Rollup should hide popups synchronously, r+sr=bz, a=mconnor\\ndiff --git a/layout/xul/base/public/nsXULPopupManager.h b/layout/xul/base/public/nsXULPopupManager.h\\nindex 48b0247..2ad4e00 100644\\n--- a/layout/xul/base/public/nsXULPopupManager.h\\n+++ b/layout/xul/base/public/nsXULPopupManager.h\\n@@ -79,7 +79,8 @@ class nsIDOMKeyEvent;\\n enum nsPopupType {\\n   ePopupTypePanel,\\n   ePopupTypeMenu,\\n-  ePopupTypeTooltip\\n+  ePopupTypeTooltip,\\n+  ePopupTypeAny = 0xF000 // used only to pass to GetTopPopup\\n };\\n \\n // when a menu command is executed, the closemenu attribute may be used\\n@@ -483,7 +484,8 @@ public:\\n \\n   /**\\n    * Return the frame for the topmost open popup of a given type, or null if\\n-   * no popup of that type is open.\\n+   * no popup of that type is open. If aType is ePopupTypeAny, a menu of any\\n+   * type is returned, except for popups in the mPanels list.\\n    */\\n   nsIFrame* GetTopPopup(nsPopupType aType);\\n \\ndiff --git a/layout/xul/base/src/nsMenuBarFrame.cpp b/layout/xul/base/src/nsMenuBarFrame.cpp\\nindex 37aec01..5d3c381 100644\\n--- a/layout/xul/base/src/nsMenuBarFrame.cpp\\n+++ b/layout/xul/base/src/nsMenuBarFrame.cpp\\n@@ -298,8 +298,11 @@ nsMenuBarFrame::FindMenuWithShortcut(nsIDOMKeyEvent* aKeyEvent)\\n   }\\n \\n   nsXULPopupManager* pm = nsXULPopupManager::GetInstance();\\n-  if (pm)\\n-    pm->Rollup();\\n+  if (pm) {\\n+    nsIFrame* popup = pm->GetTopPopup(ePopupTypeAny);\\n+    if (popup)\\n+      pm->HidePopup(popup->GetContent(), PR_TRUE, PR_TRUE, PR_TRUE);\\n+  }\\n \\n   SetCurrentMenuItem(nsnull);\\n   SetActive(PR_FALSE);\\ndiff --git a/layout/xul/base/src/nsMenuFrame.cpp b/layout/xul/base/src/nsMenuFrame.cpp\\nindex 2e28ac6..c0eeeca 100644\\n--- a/layout/xul/base/src/nsMenuFrame.cpp\\n+++ b/layout/xul/base/src/nsMenuFrame.cpp\\n@@ -824,8 +824,11 @@ nsMenuFrame::Enter()\\n     // behavior on Windows - close the popup chain\\n     if (mMenuParent) {\\n       nsXULPopupManager* pm = nsXULPopupManager::GetInstance();\\n-      if (pm)\\n-        pm->Rollup();\\n+      if (pm) {\\n+        nsIFrame* popup = pm->GetTopPopup(ePopupTypeAny);\\n+        if (popup)\\n+          pm->HidePopup(popup->GetContent(), PR_TRUE, PR_TRUE, PR_TRUE);\\n+      }\\n     }\\n #endif   // #ifdef XP_WIN\\n     // this menu item was disabled - exit\\ndiff --git a/layout/xul/base/src/nsXULPopupManager.cpp b/layout/xul/base/src/nsXULPopupManager.cpp\\nindex d9a1ac2..170efa7 100644\\n--- a/layout/xul/base/src/nsXULPopupManager.cpp\\n+++ b/layout/xul/base/src/nsXULPopupManager.cpp\\n@@ -160,8 +160,9 @@ nsXULPopupManager::GetInstance()\\n NS_IMETHODIMP\\n nsXULPopupManager::Rollup()\\n {\\n-  if (mCurrentMenu)\\n-    HidePopup(mCurrentMenu->Content(), PR_TRUE, PR_TRUE, PR_TRUE);\\n+  nsMenuChainItem* item = GetTopVisibleMenu();\\n+  if (item)\\n+    HidePopup(item->Content(), PR_TRUE, PR_TRUE, PR_FALSE);\\n   return NS_OK;\\n }\\n \\n@@ -984,7 +985,7 @@ nsXULPopupManager::GetTopPopup(nsPopupType aType)\\n \\n   nsMenuChainItem* item = GetTopVisibleMenu();\\n   while (item) {\\n-    if (item->PopupType() == aType)\\n+    if (item->PopupType() == aType || aType == ePopupTypeAny)\\n       return item->Frame();\\n     item = item->GetParent();\\n   }\\n@@ -1866,7 +1867,7 @@ nsXULMenuCommandEvent::Run()\\n   }\\n \\n   if (popup && mCloseMenuMode != CloseMenuMode_None)\\n-    pm->HidePopup(popup, mCloseMenuMode == CloseMenuMode_Auto, PR_TRUE, PR_TRUE);\\n+    pm->HidePopup(popup, mCloseMenuMode == CloseMenuMode_Auto, PR_TRUE, PR_FALSE);\\n \\n   return NS_OK;\\n }\\ndiff --git a/toolkit/content/tests/widgets/popup_trigger.js b/toolkit/content/tests/widgets/popup_trigger.js\\nindex 3225653..c4a78fc 100644\\n--- a/toolkit/content/tests/widgets/popup_trigger.js\\n+++ b/toolkit/content/tests/widgets/popup_trigger.js\\n@@ -251,8 +251,9 @@ var popupTests = [\\n },\\n {\\n   testname: \\\"activate menuitem with mouse\\\",\\n-  events: [ \\\"DOMMenuInactive thepopup\\\", \\\"command item3\\\", \\\"DOMMenuItemInactive item3\\\",\\n-            \\\"popuphiding thepopup\\\", \\\"popuphidden thepopup\\\" ],\\n+  events: [ \\\"DOMMenuInactive thepopup\\\", \\\"command item3\\\",\\n+            \\\"popuphiding thepopup\\\", \\\"popuphidden thepopup\\\",\\n+            \\\"DOMMenuItemInactive item3\\\" ],\\n   test: function(testname, step) {\\n     var item3 = document.getElementById(\\\"item3\\\");\\n     synthesizeMouse(item3, 4, 4, { });\\n@@ -284,8 +285,8 @@ var popupTests = [\\n   testname: \\\"menuitem accelerator\\\",\\n   events: [ \\\"DOMMenuItemActive amenu\\\", \\\"DOMMenuItemInactive amenu\\\",\\n             \\\"DOMMenuInactive thepopup\\\",\\n-            \\\"command amenu\\\", \\\"DOMMenuItemInactive amenu\\\",\\n-            \\\"popuphiding thepopup\\\", \\\"popuphidden thepopup\\\",\\n+            \\\"command amenu\\\", \\\"popuphiding thepopup\\\", \\\"popuphidden thepopup\\\",\\n+            \\\"DOMMenuItemInactive amenu\\\"\\n            ],\\n   test: function() { synthesizeKey(\\\"M\\\", { }); },\\n   result: function(testname) { checkClosed(\\\"trigger\\\", testname); }\\n@@ -414,8 +415,8 @@ var popupTests = [\\n   testname: \\\"menuitem with non accelerator single\\\",\\n   events: [ \\\"DOMMenuItemInactive item1\\\", \\\"DOMMenuItemActive amenu\\\",\\n             \\\"DOMMenuItemInactive amenu\\\", \\\"DOMMenuInactive thepopup\\\",\\n-            \\\"command amenu\\\", \\\"DOMMenuItemInactive amenu\\\",\\n-            \\\"popuphiding thepopup\\\", \\\"popuphidden thepopup\\\",\\n+            \\\"command amenu\\\", \\\"popuphiding thepopup\\\", \\\"popuphidden thepopup\\\",\\n+            \\\"DOMMenuItemInactive amenu\\\",\\n            ],\\n   test: function() { synthesizeKey(\\\"M\\\", { }); },\\n   result: function(testname) {\\n@@ -433,7 +434,7 @@ var popupTests = [\\n       compareEdge(gTrigger, gMenuPopup, \\\"after_start\\\", 0, 0, testname);\\n   }\\n },\\n-{ end: true,\\n+{end: true,\\n   testname: \\\"open submenu with open property\\\",\\n   events: [ \\\"popupshowing submenupopup\\\", \\\"DOMMenuItemActive submenu\\\",\\n             \\\"popupshown submenupopup\\\" ],\\n@@ -553,8 +554,8 @@ var popupTests = [\\n   condition: function() { return gIsMenu; },\\n   events: [ \\\"DOMMenuItemActive item1\\\", \\\"DOMMenuItemInactive item1\\\",\\n             \\\"DOMMenuInactive thepopup\\\", \\\"command item1\\\",\\n-            \\\"DOMMenuItemInactive item1\\\",\\n-            \\\"popuphiding thepopup\\\", \\\"popuphidden thepopup\\\" ],\\n+            \\\"popuphiding thepopup\\\", \\\"popuphidden thepopup\\\",\\n+            \\\"DOMMenuItemInactive item1\\\" ],\\n   test: function(testname, step) {\\n     synthesizeKey(\\\"VK_DOWN\\\", { });\\n     synthesizeKey(\\\"VK_ENTER\\\", { });\\ndiff --git a/toolkit/content/tests/widgets/window_menubar.xul b/toolkit/content/tests/widgets/window_menubar.xul\\nindex bb89c87..f8fd519 100644\\n--- a/toolkit/content/tests/widgets/window_menubar.xul\\n+++ b/toolkit/content/tests/widgets/window_menubar.xul\\n@@ -190,8 +190,8 @@ var popupTests = [\\n       return [ \\\"DOMMenuItemInactive copy\\\", \\\"DOMMenuInactive editpopup\\\",\\n                \\\"DOMMenuBarInactive menubar\\\",\\n                \\\"DOMMenuItemInactive editmenu\\\", \\\"DOMMenuItemInactive editmenu\\\",\\n-               \\\"command copy\\\", \\\"DOMMenuItemInactive copy\\\",\\n-               \\\"popuphiding editpopup\\\", \\\"popuphidden editpopup\\\" ];\\n+               \\\"command copy\\\", \\\"popuphiding editpopup\\\", \\\"popuphidden editpopup\\\",\\n+               \\\"DOMMenuItemInactive copy\\\" ];\\n   },\\n   test: function() { synthesizeKey(\\\"VK_ENTER\\\", { }); },\\n   result: function(testname) { checkClosed(\\\"editmenu\\\", testname); }\\n@@ -358,8 +358,8 @@ var popupTests = [\\n             \\\"DOMMenuItemInactive amenu\\\", \\\"DOMMenuInactive helppopup\\\",\\n             \\\"DOMMenuBarInactive menubar\\\", \\\"DOMMenuItemInactive helpmenu\\\",\\n             \\\"DOMMenuItemInactive helpmenu\\\",\\n-            \\\"command amenu\\\", \\\"DOMMenuItemInactive amenu\\\",\\n-            \\\"popuphiding helppopup\\\", \\\"popuphidden helppopup\\\",\\n+            \\\"command amenu\\\", \\\"popuphiding helppopup\\\", \\\"popuphidden helppopup\\\",\\n+            \\\"DOMMenuItemInactive amenu\\\",\\n            ],\\n   test: function() { synthesizeKey(\\\"M\\\", { }); },\\n   result: function(testname) { checkClosed(\\\"helpmenu\\\", testname); }\\n@@ -423,8 +423,8 @@ var popupTests = [\\n                   \\\"DOMMenuBarInactive menubar\\\",\\n                   \\\"DOMMenuItemInactive helpmenu\\\",\\n                   \\\"DOMMenuItemInactive helpmenu\\\",\\n-                  \\\"command third\\\", \\\"DOMMenuItemInactive third\\\",\\n-                  \\\"popuphiding helppopup\\\", \\\"popuphidden helppopup\\\",\\n+                  \\\"command third\\\", \\\"popuphiding helppopup\\\",\\n+                  \\\"popuphidden helppopup\\\", \\\"DOMMenuItemInactive third\\\",\\n                 ];\\n     if (navigator.platform.indexOf(\\\"Win\\\") == -1)\\n       elist[0] = \\\"DOMMenuItemInactive only\\\";\\n@@ -485,8 +485,8 @@ var popupTests = [\\n             \\\"DOMMenuBarInactive menubar\\\",\\n             \\\"DOMMenuItemInactive editmenu\\\",\\n             \\\"DOMMenuItemInactive editmenu\\\",\\n-            \\\"command copy\\\", \\\"DOMMenuItemInactive copy\\\",\\n-            \\\"popuphiding editpopup\\\", \\\"popuphidden editpopup\\\",\\n+            \\\"command copy\\\", \\\"popuphiding editpopup\\\", \\\"popuphidden editpopup\\\",\\n+            \\\"DOMMenuItemInactive copy\\\",\\n            ],\\n   test: function() {\\n     synthesizeMouse(document.getElementById(\\\"copy\\\"), 8, 8, { });\\n\""}