{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas1b531c7\""},"diff":"\"1b531c7 Bug 317433: Richlistbox attempts to give focus to hidden items. p=Simon Bunzli <zeniko@gmail.com> r=enndeakin\\ndiff --git a/toolkit/content/tests/widgets/Makefile.in b/toolkit/content/tests/widgets/Makefile.in\\nindex c9ef667..e483327 100644\\n--- a/toolkit/content/tests/widgets/Makefile.in\\n+++ b/toolkit/content/tests/widgets/Makefile.in\\n@@ -68,6 +68,8 @@ _TEST_FILES = \\ttest_bug360220.xul \\\\\\n \\t\\ttest_datepicker.xul \\\\\\n \\t\\ttest_timepicker.xul \\\\\\n \\t\\txul_selectcontrol.js \\\\\\n+\\t\\ttest_hiddenitems.xul \\\\\\n+\\t\\ttest_hiddenpaging.xul \\\\\\n \\t\\t$(NULL)\\n \\n ifeq (,$(filter mac cocoa,$(MOZ_WIDGET_TOOLKIT)))\\ndiff --git a/toolkit/content/tests/widgets/test_hiddenitems.xul b/toolkit/content/tests/widgets/test_hiddenitems.xul\\nnew file mode 100644\\nindex 0000000..126b1b2\\n--- /dev/null\\n+++ b/toolkit/content/tests/widgets/test_hiddenitems.xul\\n@@ -0,0 +1,89 @@\\n+<?xml version=\\\"1.0\\\"?>\\n+<?xml-stylesheet href=\\\"chrome://global/skin\\\" type=\\\"text/css\\\"?>\\n+<?xml-stylesheet href=\\\"/tests/SimpleTest/test.css\\\" type=\\\"text/css\\\"?>\\n+<!--\\n+https://bugzilla.mozilla.org/show_bug.cgi?id=317422\\n+-->\\n+<window title=\\\"Mozilla Bug 317422\\\"\\n+  xmlns=\\\"http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul\\\">\\n+  <script type=\\\"application/javascript\\\" src=\\\"/MochiKit/packed.js\\\" />\\n+  <script type=\\\"application/javascript\\\" src=\\\"/tests/SimpleTest/SimpleTest.js\\\"/>\\n+  <script type=\\\"application/javascript\\\" src=\\\"/tests/SimpleTest/EventUtils.js\\\"/>\\n+\\n+  <!-- test resuls are displayed in the html:body -->\\n+  <body xmlns=\\\"http://www.w3.org/1999/xhtml\\\">\\n+  <a href=\\\"https://bugzilla.mozilla.org/show_bug.cgi?id=317422\\\"\\n+     target=\\\"_blank\\\">Mozilla Bug 317422</a>\\n+  </body>\\n+\\n+  <richlistbox id=\\\"richlistbox\\\" seltype=\\\"multiple\\\">\\n+    <richlistitem id=\\\"richlistbox_item1\\\"><label value=\\\"Item 1\\\"/></richlistitem>\\n+    <richlistitem id=\\\"richlistbox_item2\\\"><label value=\\\"Item 2\\\"/></richlistitem>\\n+    <richlistitem id=\\\"richlistbox_item3\\\" hidden=\\\"true\\\"><label value=\\\"Item 3\\\"/></richlistitem>\\n+    <richlistitem id=\\\"richlistbox_item4\\\"><label value=\\\"Item 4\\\"/></richlistitem>\\n+    <richlistitem id=\\\"richlistbox_item5\\\" collapsed=\\\"true\\\"><label value=\\\"Item 5\\\"/></richlistitem>\\n+    <richlistitem id=\\\"richlistbox_item6\\\"><label value=\\\"Item 6\\\"/></richlistitem>\\n+    <richlistitem id=\\\"richlistbox_item7\\\" hidden=\\\"true\\\"><label value=\\\"Item 7\\\"/></richlistitem>\\n+  </richlistbox>\\n+  \\n+  <listbox id=\\\"listbox\\\" seltype=\\\"multiple\\\">\\n+    <listitem id=\\\"listbox_item1\\\" label=\\\"Item 1\\\"/>\\n+    <listitem id=\\\"listbox_item2\\\" label=\\\"Item 2\\\"/>\\n+    <listitem id=\\\"listbox_item3\\\" label=\\\"Item 3\\\" hidden=\\\"true\\\"/>\\n+    <listitem id=\\\"listbox_item4\\\" label=\\\"Item 4\\\"/>\\n+    <listitem id=\\\"listbox_item5\\\" label=\\\"Item 5\\\" collapsed=\\\"true\\\"/>\\n+    <listitem id=\\\"listbox_item6\\\" label=\\\"Item 6\\\"/>\\n+    <listitem id=\\\"listbox_item7\\\" label=\\\"Item 7\\\" hidden=\\\"true\\\"/>\\n+  </listbox>\\n+  \\n+  <!-- test code goes here -->\\n+  <script type=\\\"application/javascript\\\"><![CDATA[\\n+\\n+/** Test for Bug 317422 **/\\n+SimpleTest.waitForExplicitFinish();\\n+\\n+function testListbox(id)\\n+{\\n+  var listbox = document.getElementById(id);\\n+  is(listbox.getRowCount(), 7, id + \\\": Returned the wrong number of rows\\\");\\n+  is(listbox.getItemAtIndex(2).id, id + \\\"_item3\\\", id + \\\": Should still return hidden items\\\");\\n+  listbox.selectedIndex = 0;\\n+  is(listbox.selectedItem.id, id + \\\"_item1\\\", id + \\\": First item was not selected\\\");\\n+  sendKey(\\\"DOWN\\\", id);\\n+  is(listbox.selectedItem.id, id + \\\"_item2\\\", id + \\\": Down didn't move to second item\\\");\\n+  sendKey(\\\"DOWN\\\", id);\\n+  is(listbox.selectedItem.id, id + \\\"_item4\\\", id + \\\": Down didn't skip hidden item\\\");\\n+  sendKey(\\\"DOWN\\\", id);\\n+  is(listbox.selectedItem.id, id + \\\"_item6\\\", id + \\\": Down didn't skip collapsed item\\\");\\n+  sendKey(\\\"UP\\\", id);\\n+  is(listbox.selectedItem.id, id + \\\"_item4\\\", id + \\\": Up didn't skip collapsed item\\\");\\n+  sendKey(\\\"UP\\\", id);\\n+  is(listbox.selectedItem.id, id + \\\"_item2\\\", id + \\\": Up didn't skip hidden item\\\");\\n+  listbox.selectAll();\\n+  is(listbox.selectedItems.length, 7, id + \\\": Should have still selected all items\\\");\\n+  listbox.invertSelection();\\n+  is(listbox.selectedItems.length, 0, id + \\\": Should have unselected all items\\\");\\n+  listbox.selectedIndex = 2;\\n+  ok(listbox.selectedItem == listbox.getItemAtIndex(2), id + \\\": Should have selected the hidden item\\\");\\n+  listbox.selectedIndex = 0;\\n+  sendKey(\\\"END\\\", id);\\n+  is(listbox.selectedItem.id, id + \\\"_item6\\\", id + \\\": Should have moved to the last unhidden item\\\");\\n+  sendMouseEvent({type: 'click'}, id + \\\"_item1\\\");\\n+  ok(listbox.selectedItem == listbox.getItemAtIndex(0), id + \\\": Should have selected the first item\\\");\\n+  is(listbox.selectedItems.length, 1, id + \\\": Should only be one selected item\\\");\\n+  sendMouseEvent({type: 'click', shiftKey: true}, id + \\\"_item6\\\");\\n+  is(listbox.selectedItems.length, 4, id + \\\": Should have selected all visible items\\\");\\n+  listbox.selectedIndex = 0;\\n+  sendKey(\\\"PAGE_DOWN\\\", id);\\n+  is(listbox.selectedItem.id, id + \\\"_item6\\\", id + \\\": Page down should go to the last visible item\\\");\\n+  sendKey(\\\"PAGE_UP\\\", id);\\n+  is(listbox.selectedItem.id, id + \\\"_item1\\\", id + \\\": Page up should go to the first visible item\\\");\\n+}\\n+\\n+window.onload = function runTests() {\\n+  testListbox(\\\"richlistbox\\\");\\n+  testListbox(\\\"listbox\\\");\\n+  SimpleTest.finish();\\n+};\\n+  ]]></script>\\n+</window>\\ndiff --git a/toolkit/content/tests/widgets/test_hiddenpaging.xul b/toolkit/content/tests/widgets/test_hiddenpaging.xul\\nnew file mode 100644\\nindex 0000000..3c106a8\\n--- /dev/null\\n+++ b/toolkit/content/tests/widgets/test_hiddenpaging.xul\\n@@ -0,0 +1,128 @@\\n+<?xml version=\\\"1.0\\\"?>\\n+<?xml-stylesheet href=\\\"chrome://global/skin\\\" type=\\\"text/css\\\"?>\\n+<?xml-stylesheet href=\\\"/tests/SimpleTest/test.css\\\" type=\\\"text/css\\\"?>\\n+<!--\\n+https://bugzilla.mozilla.org/show_bug.cgi?id=317422\\n+-->\\n+<window title=\\\"Mozilla Bug 317422\\\"\\n+  xmlns=\\\"http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul\\\">\\n+  <script type=\\\"application/javascript\\\" src=\\\"/MochiKit/packed.js\\\" />\\n+  <script type=\\\"application/javascript\\\" src=\\\"/tests/SimpleTest/SimpleTest.js\\\"/>\\n+  <script type=\\\"application/javascript\\\" src=\\\"/tests/SimpleTest/EventUtils.js\\\"/>\\n+\\n+  <style xmlns=\\\"http://www.w3.org/1999/xhtml\\\">\\n+    /* This makes the richlistbox about 4.5 rows high */\\n+    richlistitem {\\n+      height: 30px;\\n+    }\\n+    richlistbox {\\n+      height: 135px;\\n+    }\\n+  </style>\\n+  \\n+  <!-- test resuls are displayed in the html:body -->\\n+  <body xmlns=\\\"http://www.w3.org/1999/xhtml\\\">\\n+  <a href=\\\"https://bugzilla.mozilla.org/show_bug.cgi?id=317422\\\"\\n+     target=\\\"_blank\\\">Mozilla Bug 317422</a>\\n+  </body>\\n+\\n+  <richlistbox id=\\\"richlistbox\\\" seltype=\\\"multiple\\\">\\n+    <richlistitem id=\\\"richlistbox_item1\\\"><label value=\\\"Item 1\\\"/></richlistitem>\\n+    <richlistitem id=\\\"richlistbox_item2\\\"><label value=\\\"Item 2\\\"/></richlistitem>\\n+    <richlistitem id=\\\"richlistbox_item3\\\" hidden=\\\"true\\\"><label value=\\\"Item 3\\\"/></richlistitem>\\n+    <richlistitem id=\\\"richlistbox_item4\\\"><label value=\\\"Item 4\\\"/></richlistitem>\\n+    <richlistitem id=\\\"richlistbox_item5\\\" collapsed=\\\"true\\\"><label value=\\\"Item 5\\\"/></richlistitem>\\n+    <richlistitem id=\\\"richlistbox_item6\\\"><label value=\\\"Item 6\\\"/></richlistitem>\\n+    <richlistitem id=\\\"richlistbox_item7\\\"><label value=\\\"Item 7\\\"/></richlistitem>\\n+    <richlistitem id=\\\"richlistbox_item8\\\"><label value=\\\"Item 8\\\"/></richlistitem>\\n+    <richlistitem id=\\\"richlistbox_item9\\\"><label value=\\\"Item 9\\\"/></richlistitem>\\n+    <richlistitem id=\\\"richlistbox_item10\\\"><label value=\\\"Item 10\\\"/></richlistitem>\\n+    <richlistitem id=\\\"richlistbox_item11\\\"><label value=\\\"Item 11\\\"/></richlistitem>\\n+    <richlistitem id=\\\"richlistbox_item12\\\"><label value=\\\"Item 12\\\"/></richlistitem>\\n+    <richlistitem id=\\\"richlistbox_item13\\\"><label value=\\\"Item 13\\\"/></richlistitem>\\n+    <richlistitem id=\\\"richlistbox_item14\\\"><label value=\\\"Item 14\\\"/></richlistitem>\\n+    <richlistitem id=\\\"richlistbox_item15\\\" hidden=\\\"true\\\"><label value=\\\"Item 15\\\"/></richlistitem>\\n+  </richlistbox>\\n+  \\n+  <listbox id=\\\"listbox\\\" seltype=\\\"multiple\\\" rows=\\\"5\\\">\\n+    <listitem id=\\\"listbox_item1\\\" label=\\\"Item 1\\\"/>\\n+    <listitem id=\\\"listbox_item2\\\" label=\\\"Item 2\\\"/>\\n+    <listitem id=\\\"listbox_item3\\\" label=\\\"Item 3\\\" hidden=\\\"true\\\"/>\\n+    <listitem id=\\\"listbox_item4\\\" label=\\\"Item 4\\\"/>\\n+    <listitem id=\\\"listbox_item5\\\" label=\\\"Item 5\\\" hidden=\\\"true\\\"/>\\n+    <listitem id=\\\"listbox_item6\\\" label=\\\"Item 6\\\"/>\\n+    <listitem id=\\\"listbox_item7\\\" label=\\\"Item 7\\\"/>\\n+    <listitem id=\\\"listbox_item8\\\" label=\\\"Item 8\\\"/>\\n+    <listitem id=\\\"listbox_item9\\\" label=\\\"Item 9\\\"/>\\n+    <listitem id=\\\"listbox_item10\\\" label=\\\"Item 10\\\"/>\\n+    <listitem id=\\\"listbox_item11\\\" label=\\\"Item 11\\\"/>\\n+    <listitem id=\\\"listbox_item12\\\" label=\\\"Item 12\\\"/>\\n+    <listitem id=\\\"listbox_item13\\\" label=\\\"Item 13\\\"/>\\n+    <listitem id=\\\"listbox_item14\\\" label=\\\"Item 14\\\"/>\\n+    <listitem id=\\\"listbox_item15\\\" label=\\\"Item 15\\\" hidden=\\\"true\\\"/>\\n+  </listbox>\\n+  \\n+  <!-- test code goes here -->\\n+  <script type=\\\"application/javascript\\\"><![CDATA[\\n+\\n+/** Test for Bug 317422 **/\\n+SimpleTest.waitForExplicitFinish();\\n+\\n+function testRichlistbox()\\n+{\\n+  var id = \\\"richlistbox\\\";\\n+  var listbox = document.getElementById(id);\\n+  listbox.selectedIndex = 0;\\n+  sendKey(\\\"PAGE_DOWN\\\", id);\\n+  is(listbox.selectedItem.id, id + \\\"_item7\\\", id + \\\": Page down should go to the item one visible page away\\\");\\n+  is(listbox.getIndexOfFirstVisibleRow(), 6, id + \\\": Page down should have scrolled down a visible page\\\");\\n+  sendKey(\\\"PAGE_DOWN\\\", id);\\n+  is(listbox.selectedItem.id, id + \\\"_item11\\\", id + \\\": Second page down should go to the item two visible pages away\\\");\\n+  is(listbox.getIndexOfFirstVisibleRow(), 9, id + \\\": Second page down should not scroll beyond the end\\\");\\n+  sendKey(\\\"PAGE_DOWN\\\", id);\\n+  is(listbox.selectedItem.id, id + \\\"_item14\\\", id + \\\": Third page down should go to the last visible item\\\");\\n+  is(listbox.getIndexOfFirstVisibleRow(), 9, id + \\\": Third page down should not have scrolled at all\\\");\\n+  sendKey(\\\"PAGE_UP\\\", id);\\n+  is(listbox.selectedItem.id, id + \\\"_item10\\\", id + \\\": Page up should go to the item one visible page away\\\");\\n+  is(listbox.getIndexOfFirstVisibleRow(), 5, id + \\\": Page up should scroll up a visible page\\\");\\n+  sendKey(\\\"PAGE_UP\\\", id);\\n+  is(listbox.selectedItem.id, id + \\\"_item6\\\", id + \\\": Second page up should go to the item two visible pages away\\\");\\n+  is(listbox.getIndexOfFirstVisibleRow(), 0, id + \\\": Second page up should not scroll beyond the start\\\");\\n+  sendKey(\\\"PAGE_UP\\\", id);\\n+  is(listbox.selectedItem.id, id + \\\"_item1\\\", id + \\\": Third page up should return to the first visible item\\\");\\n+  is(listbox.getIndexOfFirstVisibleRow(), 0, id + \\\": Third page up should not have scrolled at all\\\");\\n+}\\n+\\n+function testListbox()\\n+{\\n+  var id = \\\"listbox\\\";\\n+  var listbox = document.getElementById(id);\\n+  listbox.selectedIndex = 0;\\n+  sendKey(\\\"PAGE_DOWN\\\", id);\\n+  is(listbox.selectedItem.id, id + \\\"_item8\\\", id + \\\": Page down should go to the item one visible page away\\\");\\n+  is(listbox.getIndexOfFirstVisibleRow(), 7, id + \\\": Page down should have scrolled down a visible page\\\");\\n+  sendKey(\\\"PAGE_DOWN\\\", id);\\n+  is(listbox.selectedItem.id, id + \\\"_item13\\\", id + \\\": Second page down should go to the item two visible pages away\\\");\\n+  is(listbox.getIndexOfFirstVisibleRow(), 9, id + \\\": Second page down should not scroll beyond the end\\\");\\n+  sendKey(\\\"PAGE_DOWN\\\", id);\\n+  is(listbox.selectedItem.id, id + \\\"_item14\\\", id + \\\": Third page down should go to the last visible item\\\");\\n+  is(listbox.getIndexOfFirstVisibleRow(), 9, id + \\\": Third page down should not have scrolled at all\\\");\\n+  sendKey(\\\"PAGE_UP\\\", id);\\n+  is(listbox.selectedItem.id, id + \\\"_item9\\\", id + \\\": Page up should go to the item one visible page away\\\");\\n+  // the listScrollbox seems to go haywire when scrolling up with hidden listitems\\n+  todo_is(listbox.getIndexOfFirstVisibleRow(), 3, id + \\\": Page up should scroll up a visible page\\\");\\n+  sendKey(\\\"PAGE_UP\\\", id);\\n+  is(listbox.selectedItem.id, id + \\\"_item2\\\", id + \\\": Second page up should go to the item two visible pages away\\\");\\n+  is(listbox.getIndexOfFirstVisibleRow(), 0, id + \\\": Second page up should not scroll beyond the start\\\");\\n+  sendKey(\\\"PAGE_UP\\\", id);\\n+  is(listbox.selectedItem.id, id + \\\"_item1\\\", id + \\\": Third page up should return to the first visible item\\\");\\n+  is(listbox.getIndexOfFirstVisibleRow(), 0, id + \\\": Third page up should not have scrolled at all\\\");\\n+}\\n+\\n+window.onload = function runTests() {\\n+  testRichlistbox();\\n+  testListbox();\\n+  SimpleTest.finish();\\n+};\\n+  ]]></script>\\n+</window>\\ndiff --git a/toolkit/content/widgets/listbox.xml b/toolkit/content/widgets/listbox.xml\\nindex 199252f..36b26aa 100644\\n--- a/toolkit/content/widgets/listbox.xml\\n+++ b/toolkit/content/widgets/listbox.xml\\n@@ -99,8 +99,9 @@\\n     insertItemAt(aIndex, aLabel, aValue)\\n \\n     /** Scroll up/down one page\\n-     * @param aDirection - specifies scrolling direction, should be either -1\\n-                           or 1 */\\n+     * @param aDirection - specifies scrolling direction, should be either -1 or 1\\n+     * @return the number of elements the selection scrolled\\n+     */\\n     scrollOnePage(aDirection)\\n \\n     /** Fire \\\"select\\\" event */\\n@@ -334,12 +335,15 @@\\n           // Don't use clearSelection() because it causes a lot of noise\\n           // with respect to selection removed notifications used by the\\n           // accessibility API support.\\n+          var userSelecting = this._userSelecting;\\n+          this._userSelecting = false; // that's US automatically unselecting\\n           for (; currentItem; currentItem = this.getNextItem(currentItem, 1))\\n             this.removeItemFromSelection(currentItem);\\n \\n           for (currentItem = this.getItemAtIndex(0); currentItem != aStartItem;\\n                currentItem = this.getNextItem(currentItem, 1))\\n             this.removeItemFromSelection(currentItem);\\n+          this._userSelecting = userSelecting;\\n \\n           this._suppressOnSelect = suppressSelect;\\n \\n@@ -478,8 +482,13 @@\\n             newIndex = numItems - 1;\\n \\n           var newItem = this.getItemAtIndex(newIndex);\\n+          // make sure that the item is actually visible/selectable\\n+          if (this._userSelecting && newItem && !this._canUserSelect(newItem))\\n+            newItem =\\n+              aOffset > 0 ? this.getNextItem(newItem, 1) || this.getPreviousItem(newItem, 1) :\\n+                            this.getPreviousItem(newItem, 1) || this.getNextItem(newItem, 1);\\n           if (newItem) {\\n-            this.ensureIndexIsVisible(newIndex);\\n+            this.ensureIndexIsVisible(this.getIndexOfItem(newItem));\\n             if (aIsSelectingRange)\\n               this.selectItemRange(null, newItem);\\n             else if (aIsSelecting)\\n@@ -500,7 +509,8 @@\\n           while (aStartItem) {\\n             aStartItem = aStartItem.nextSibling;\\n             if (aStartItem && aStartItem instanceof\\n-                Components.interfaces.nsIDOMXULSelectControlItemElement) {\\n+                Components.interfaces.nsIDOMXULSelectControlItemElement &&\\n+                (!this._userSelecting || this._canUserSelect(aStartItem))) {\\n               --aDelta;\\n               if (aDelta == 0)\\n                 return aStartItem;\\n@@ -518,7 +528,8 @@\\n           while (aStartItem) {\\n             aStartItem = aStartItem.previousSibling;\\n             if (aStartItem && aStartItem instanceof\\n-                Components.interfaces.nsIDOMXULSelectControlItemElement) {\\n+                Components.interfaces.nsIDOMXULSelectControlItemElement &&\\n+                (!this._userSelecting || this._canUserSelect(aStartItem))) {\\n               --aDelta;\\n               if (aDelta == 0)\\n                 return aStartItem;\\n@@ -529,6 +540,28 @@\\n         </body>\\n       </method>\\n \\n+      <method name=\\\"_moveByOffsetFromUserEvent\\\">\\n+        <parameter name=\\\"aOffset\\\"/>\\n+        <parameter name=\\\"aEvent\\\"/>\\n+        <body>\\n+        <![CDATA[\\n+          this._userSelecting = true;\\n+          this.moveByOffset(aOffset, !aEvent.ctrlKey, aEvent.shiftKey);\\n+          this._userSelecting = false;\\n+        ]]>\\n+        </body>\\n+      </method>\\n+\\n+      <method name=\\\"_canUserSelect\\\">\\n+        <parameter name=\\\"aItem\\\"/>\\n+        <body>\\n+        <![CDATA[\\n+          var style = document.defaultView.getComputedStyle(aItem, \\\"\\\");\\n+          return style.display != \\\"none\\\" && style.visibility == \\\"visible\\\";\\n+        ]]>\\n+        </body>\\n+      </method>\\n+\\n       <method name=\\\"_selectTimeoutHandler\\\">\\n         <parameter name=\\\"aMe\\\"/>\\n         <body>\\n@@ -538,6 +571,7 @@\\n       </method>\\n \\n       <field name=\\\"_suppressOnSelect\\\">false</field>\\n+      <field name=\\\"_userSelecting\\\">false</field>\\n       <field name=\\\"_selectTimeout\\\">null</field>\\n       <field name=\\\"_currentItem\\\">null</field>\\n       <field name=\\\"_selectionStart\\\">null</field>\\n@@ -545,22 +579,22 @@\\n \\n     <handlers>\\n       <handler event=\\\"keypress\\\" keycode=\\\"VK_UP\\\" modifiers=\\\"control shift any\\\"\\n-               action=\\\"moveByOffset(-1, !event.ctrlKey, event.shiftKey);\\\"\\n+               action=\\\"this._moveByOffsetFromUserEvent(-1, event);\\\"\\n                phase=\\\"target\\\" preventdefault=\\\"true\\\"/>\\n       <handler event=\\\"keypress\\\" keycode=\\\"VK_DOWN\\\" modifiers=\\\"control shift any\\\"\\n-               action=\\\"moveByOffset(1, !event.ctrlKey, event.shiftKey);\\\"\\n+               action=\\\"this._moveByOffsetFromUserEvent(1, event);\\\"\\n                phase=\\\"target\\\" preventdefault=\\\"true\\\"/>\\n       <handler event=\\\"keypress\\\" keycode=\\\"VK_HOME\\\" modifiers=\\\"control shift any\\\"\\n-               action=\\\"moveByOffset(-this.currentIndex, !event.ctrlKey, event.shiftKey);\\\"\\n+               action=\\\"this._moveByOffsetFromUserEvent(-this.currentIndex, event);\\\"\\n                phase=\\\"target\\\" preventdefault=\\\"true\\\"/>\\n       <handler event=\\\"keypress\\\" keycode=\\\"VK_END\\\" modifiers=\\\"control shift any\\\"\\n-               action=\\\"moveByOffset(this.getRowCount() - this.currentIndex - 1, !event.ctrlKey, event.shiftKey);\\\"\\n+               action=\\\"this._moveByOffsetFromUserEvent(this.getRowCount() - this.currentIndex - 1, event);\\\"\\n                phase=\\\"target\\\" preventdefault=\\\"true\\\"/>\\n       <handler event=\\\"keypress\\\" keycode=\\\"VK_PAGE_UP\\\" modifiers=\\\"control shift any\\\"\\n-               action=\\\"moveByOffset(this.scrollOnePage(-1), !event.ctrlKey, event.shiftKey);\\\"\\n+               action=\\\"this._moveByOffsetFromUserEvent(this.scrollOnePage(-1), event);\\\"\\n                phase=\\\"target\\\" preventdefault=\\\"true\\\"/>\\n       <handler event=\\\"keypress\\\" keycode=\\\"VK_PAGE_DOWN\\\" modifiers=\\\"control shift any\\\"\\n-               action=\\\"moveByOffset(this.scrollOnePage(1), !event.ctrlKey, event.shiftKey);\\\"\\n+               action=\\\"this._moveByOffsetFromUserEvent(this.scrollOnePage(1), event);\\\"\\n                phase=\\\"target\\\" preventdefault=\\\"true\\\"/>\\n       <handler event=\\\"keypress\\\" key=\\\" \\\" modifiers=\\\"control\\\" phase=\\\"target\\\">\\n       <![CDATA[\\n@@ -606,6 +640,8 @@\\n         for (var i = 0; i < rowCount; i++) {\\n           var k = (start + i) % rowCount;\\n           var listitem = this.getItemAtIndex(k);\\n+          if (!this._canUserSelect(listitem))\\n+            continue;\\n           // allow richlistitems to specify the string being searched for\\n           var searchText = \\\"searchLabel\\\" in listitem ? listitem.searchLabel :\\n                            listitem.getAttribute(\\\"label\\\"); // (see also bug 250123)\\n@@ -770,14 +806,24 @@\\n         <body>      \\n           <![CDATA[\\n             var pageOffset = this.getNumberOfVisibleRows() * direction;\\n+            // skip over invisible elements - the user won't care about them\\n+            for (var i = 0; i != pageOffset; i += direction) {\\n+              var item = this.getItemAtIndex(this.currentIndex + i);\\n+              if (item && !this._canUserSelect(item))\\n+                pageOffset += direction;\\n+            }\\n             var newTop = this.getIndexOfFirstVisibleRow() + pageOffset;\\n             if (direction == 1) {\\n-              var maxTop = this.getRowCount() - pageOffset;\\n-              if (newTop >= maxTop && maxTop > this.currentIndex) {\\n-                newTop = maxTop;\\n+              var maxTop = this.getRowCount() - this.getNumberOfVisibleRows();\\n+              for (i = this.getRowCount(); i >= 0 && i > maxTop; i--) {\\n+                item = this.getItemAtIndex(i);\\n+                if (item && !this._canUserSelect(item))\\n+                  maxTop--;\\n               }\\n+              if (newTop >= maxTop)\\n+                newTop = maxTop;\\n             }\\n-            else if (newTop < 0)\\n+            if (newTop < 0)\\n               newTop = 0;\\n             this.scrollToIndex(newTop);\\n             return pageOffset;          \\n@@ -924,6 +970,7 @@\\n         var control = this.control;\\n         if (!control || control.disabled)\\n           return;\\n+        control._userSelecting = true;\\n         if (control.selType != \\\"multiple\\\") {\\n           control.selectItem(this);\\n         }\\n@@ -945,6 +992,7 @@\\n           // doesn't de- and reselect this item if it is selected\\n           control.selectItemRange(this, this);\\n         }\\n+        control._userSelecting = false;\\n       ]]>\\n       </handler>\\n     </handlers>\\ndiff --git a/toolkit/content/widgets/richlistbox.xml b/toolkit/content/widgets/richlistbox.xml\\nindex 47b8be5..75a4f4a 100644\\n--- a/toolkit/content/widgets/richlistbox.xml\\n+++ b/toolkit/content/widgets/richlistbox.xml\\n@@ -265,19 +265,20 @@\\n             // (including the currently selected one), and determine\\n             // the index of the first one lying (partially) outside\\n             var height = this.scrollBoxObject.height;\\n-            var border = this.currentItem.boxObject.y;\\n+            var startBorder = this.currentItem.boxObject.y;\\n             if (aDirection == -1)\\n-              border += this.currentItem.boxObject.height;\\n+              startBorder += this.currentItem.boxObject.height;\\n+\\n             var index = this.currentIndex;\\n-            while (0 <= index && index < children.length) {\\n-              var border2 = children[index].boxObject.y;\\n-              if (aDirection == -1)\\n-                border2 += children[index].boxObject.height;\\n-              if ((border2 - border) * aDirection > height)\\n-                break;\\n-              index += aDirection;\\n+            for (var ix = index; 0 <= ix && ix < children.length; ix += aDirection) {\\n+              var boxObject = children[ix].boxObject;\\n+              if (boxObject.height == 0)\\n+                continue; // hidden children have a y of 0\\n+              var endBorder = boxObject.y + (aDirection == -1 ? boxObject.height : 0);\\n+              if ((endBorder - startBorder) * aDirection > height)\\n+                break; // we've reached the desired distance\\n+              index = ix;\\n             }\\n-            index -= aDirection;\\n \\n             return index != this.currentIndex ? index - this.currentIndex : aDirection;\\n           ]]>\\n\""}