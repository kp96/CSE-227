{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas93d1e48\""},"diff":"\"93d1e48 Bug 394042 - \\\"Dangling pointer in nsXULPDGlobalObject leads to mem corruption/crashes\\\". r+sr=bzbarsky, a=jst.\\ndiff --git a/content/xul/document/src/nsXULPrototypeDocument.cpp b/content/xul/document/src/nsXULPrototypeDocument.cpp\\nindex 74abcc8..37a0aa0 100644\\n--- a/content/xul/document/src/nsXULPrototypeDocument.cpp\\n+++ b/content/xul/document/src/nsXULPrototypeDocument.cpp\\n@@ -105,6 +105,8 @@ protected:\\n     nsCOMPtr<nsIScriptContext>  mScriptContexts[NS_STID_ARRAY_UBOUND];\\n     void *                      mScriptGlobals[NS_STID_ARRAY_UBOUND];\\n \\n+    nsCOMPtr<nsIPrincipal> mCachedPrincipal;\\n+\\n     static JSClass gSharedGlobalClass;\\n };\\n \\n@@ -759,6 +761,12 @@ nsXULPDGlobalObject::GetScriptGlobal(PRUint32 lang_id)\\n void\\n nsXULPDGlobalObject::ClearGlobalObjectOwner()\\n {\\n+    NS_ASSERTION(!mCachedPrincipal, \\\"This shouldn't ever be set until now!\\\");\\n+\\n+    // Cache mGlobalObjectOwner's principal if possible.\\n+    if (this != nsXULPrototypeDocument::gSystemGlobal)\\n+        mCachedPrincipal = mGlobalObjectOwner->DocumentPrincipal();\\n+\\n     PRUint32 lang_ndx;\\n     NS_STID_FOR_INDEX(lang_ndx) {\\n         if (mScriptContexts[lang_ndx]) {\\n@@ -766,6 +774,7 @@ nsXULPDGlobalObject::ClearGlobalObjectOwner()\\n             mScriptContexts[lang_ndx] = nsnull;\\n         }\\n     }\\n+\\n     mGlobalObjectOwner = nsnull;\\n }\\n \\n@@ -806,9 +815,9 @@ nsXULPDGlobalObject::GetPrincipal()\\n         if (this == nsXULPrototypeDocument::gSystemGlobal) {\\n             return nsXULPrototypeDocument::gSystemPrincipal;\\n         }\\n-        return nsnull;\\n+        // Return the cached principal if it exists.\\n+        return mCachedPrincipal;\\n     }\\n \\n     return mGlobalObjectOwner->DocumentPrincipal();\\n }\\n-\\n\""}