{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas0fba10ee\""},"diff":"\"0fba10ee Bug 393695 - Kill old gfx code in nsDeviceContextSpec with OS p=Jonathan Steele <xfsunoles@gmail.com> r+sr+a=roc\\ndiff --git a/widget/public/nsIDeviceContextSpec.h b/widget/public/nsIDeviceContextSpec.h\\nindex e76f9ff..8dbca11 100644\\n--- a/widget/public/nsIDeviceContextSpec.h\\n+++ b/widget/public/nsIDeviceContextSpec.h\\n@@ -44,9 +44,7 @@\\n class nsIWidget;\\n class nsIPrintSettings;\\n \\n-#ifdef MOZ_CAIRO_GFX\\n class gfxASurface;\\n-#endif\\n \\n #define NS_IDEVICE_CONTEXT_SPEC_IID   \\\\\\n { 0x205c614f, 0x39f8, 0x42e1, \\\\\\n@@ -68,7 +66,6 @@ public:\\n                    nsIPrintSettings* aPrintSettings,\\n                    PRBool aIsPrintPreview) = 0;\\n \\n-#ifdef MOZ_CAIRO_GFX\\n    NS_IMETHOD GetSurfaceForPrinter(gfxASurface **nativeSurface) = 0;\\n \\n    NS_IMETHOD BeginDocument(PRUnichar*  aTitle,\\n@@ -79,9 +76,6 @@ public:\\n    NS_IMETHOD EndDocument() = 0;\\n    NS_IMETHOD BeginPage() = 0;\\n    NS_IMETHOD EndPage() = 0;\\n-\\n-\\n-#endif\\n };\\n \\n NS_DEFINE_STATIC_IID_ACCESSOR(nsIDeviceContextSpec,\\ndiff --git a/widget/src/os2/nsDeviceContextSpecOS2.cpp b/widget/src/os2/nsDeviceContextSpecOS2.cpp\\nindex abd51a5..3b7ec4c 100644\\n--- a/widget/src/os2/nsDeviceContextSpecOS2.cpp\\n+++ b/widget/src/os2/nsDeviceContextSpecOS2.cpp\\n@@ -329,7 +329,6 @@ nsresult nsDeviceContextSpecOS2::GetPRTQUEUE( PRTQUEUE *&p)\\n    return NS_OK;\\n }\\n \\n-#ifdef MOZ_CAIRO_GFX\\n NS_IMETHODIMP nsDeviceContextSpecOS2::GetSurfaceForPrinter(gfxASurface **nativeSurface)\\n {\\n    return NS_ERROR_NOT_IMPLEMENTED;\\n@@ -357,7 +356,6 @@ NS_IMETHODIMP nsDeviceContextSpecOS2::EndPage()\\n {\\n     return NS_ERROR_NOT_IMPLEMENTED;\\n }\\n-#endif\\n \\n //  Printer Enumerator\\n nsPrinterEnumeratorOS2::nsPrinterEnumeratorOS2()\\ndiff --git a/widget/src/os2/nsDeviceContextSpecOS2.h b/widget/src/os2/nsDeviceContextSpecOS2.h\\nindex 80a9114..ac1d427 100644\\n--- a/widget/src/os2/nsDeviceContextSpecOS2.h\\n+++ b/widget/src/os2/nsDeviceContextSpecOS2.h\\n@@ -96,14 +96,12 @@ public:\\n \\n   NS_IMETHOD GetPRTQUEUE(PRTQUEUE *&p);\\n \\n-#ifdef MOZ_CAIRO_GFX\\n   NS_IMETHOD GetSurfaceForPrinter(gfxASurface **nativeSurface);\\n   NS_IMETHOD BeginDocument(PRUnichar* aTitle, PRUnichar* aPrintToFileName,\\n                            PRInt32 aStartPage, PRInt32 aEndPage);\\n   NS_IMETHOD EndDocument();\\n   NS_IMETHOD BeginPage();\\n   NS_IMETHOD EndPage();\\n-#endif\\n \\n /**\\n  * Destructor for nsDeviceContextSpecOS2, this will release the printrecord\\ndiff --git a/widget/src/windows/nsDeviceContextSpecWin.cpp b/widget/src/windows/nsDeviceContextSpecWin.cpp\\nindex 90fa126..3ee98d3 100644\\n--- a/widget/src/windows/nsDeviceContextSpecWin.cpp\\n+++ b/widget/src/windows/nsDeviceContextSpecWin.cpp\\n@@ -51,10 +51,9 @@\\n #include \\\"nsIServiceManager.h\\\"\\n #include \\\"nsReadableUtils.h\\\"\\n #include \\\"nsStringEnumerator.h\\\"\\n-#ifdef MOZ_CAIRO_GFX\\n+\\n #include \\\"gfxPDFSurface.h\\\"\\n #include \\\"gfxWindowsSurface.h\\\"\\n-#endif\\n \\n #include \\\"nsIFileStreams.h\\\"\\n #include \\\"nsUnitConversion.h\\\"\\n@@ -181,11 +180,9 @@ nsDeviceContextSpecWin::nsDeviceContextSpecWin()\\n \\n \\n //----------------------------------------------------------------------------------\\n-#ifdef MOZ_CAIRO_GFX\\n+\\n NS_IMPL_ISUPPORTS1(nsDeviceContextSpecWin, nsIDeviceContextSpec)\\n-#else\\n-NS_IMPL_ISUPPORTS2(nsDeviceContextSpecWin, nsIDeviceContextSpec, nsISupportsVoid)\\n-#endif\\n+\\n nsDeviceContextSpecWin::~nsDeviceContextSpecWin()\\n {\\n   SetDeviceName(nsnull);\\n@@ -515,7 +512,6 @@ static void CleanAndCopyString(char*& aStr, char* aNewStr)\\n   }\\n }\\n \\n-#ifdef MOZ_CAIRO_GFX\\n NS_IMETHODIMP nsDeviceContextSpecWin::GetSurfaceForPrinter(gfxASurface **surface)\\n {\\n   NS_ASSERTION(mDevMode, \\\"DevMode can't be NULL here\\\");\\n@@ -565,24 +561,6 @@ NS_IMETHODIMP nsDeviceContextSpecWin::GetSurfaceForPrinter(gfxASurface **surface\\n   return NS_ERROR_FAILURE;\\n }\\n \\n-#else\\n-\\n-// nsISupportsVoid impl stuff. goes away when we turn on cairo.\\n-NS_IMETHODIMP nsDeviceContextSpecWin::GetData(void **data)\\n-{\\n-  NS_ASSERTION(mDevMode, \\\"DevMode can't be NULL here\\\");\\n-\\n-  if (mDevMode) {\\n-    HDC dc = ::CreateDC(mDriverName, mDeviceName, NULL, mDevMode);\\n-    *data = (void*)dc;\\n-\\n-    return NS_OK;\\n-  }\\n-  return NS_ERROR_FAILURE;\\n-}\\n-\\n-#endif\\n-\\n //----------------------------------------------------------------------------------\\n void nsDeviceContextSpecWin::SetDeviceName(char* aDeviceName)\\n {\\ndiff --git a/widget/src/windows/nsDeviceContextSpecWin.h b/widget/src/windows/nsDeviceContextSpecWin.h\\nindex 2c94cb8..48513ca 100644\\n--- a/widget/src/windows/nsDeviceContextSpecWin.h\\n+++ b/widget/src/windows/nsDeviceContextSpecWin.h\\n@@ -47,16 +47,12 @@\\n #include <windows.h>\\n \\n class nsDeviceContextSpecWin : public nsIDeviceContextSpec\\n-#ifndef MOZ_CAIRO_GFX\\n-  , public nsISupportsVoid\\n-#endif\\n {\\n public:\\n   nsDeviceContextSpecWin();\\n \\n   NS_DECL_ISUPPORTS\\n \\n-#ifdef MOZ_CAIRO_GFX\\n   NS_IMETHOD GetSurfaceForPrinter(gfxASurface **surface);\\n   NS_IMETHOD BeginDocument(PRUnichar*  aTitle, \\n                            PRUnichar*  aPrintToFileName,\\n@@ -65,13 +61,6 @@ public:\\n   NS_IMETHOD EndDocument() { return NS_ERROR_NOT_IMPLEMENTED; }\\n   NS_IMETHOD BeginPage() { return NS_ERROR_NOT_IMPLEMENTED; }\\n   NS_IMETHOD EndPage() { return NS_ERROR_NOT_IMPLEMENTED; }\\n-#else\\n-  // kill these when we move to CAIRO_GFX\\n-  NS_IMETHOD GetType(PRUint16 *aType) { *aType = nsISupportsPrimitive::TYPE_VOID; return NS_OK; }\\n-  NS_IMETHOD GetData(void * *aData);\\n-  NS_IMETHOD SetData(void * aData) { return NS_ERROR_FAILURE; }\\n-  NS_IMETHOD ToString(char **_retval) { return NS_ERROR_FAILURE; }\\n-#endif\\n \\n   NS_IMETHOD Init(nsIWidget* aWidget, nsIPrintSettings* aPS, PRBool aIsPrintPreview);\\n \\n\""}