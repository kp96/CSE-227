{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas0aa9489\""},"diff":"\"0aa9489 Make line-height specified in ch units work.  Bug 391909, r+sr+a+dbaron\\ndiff --git a/layout/base/nsLayoutUtils.cpp b/layout/base/nsLayoutUtils.cpp\\nindex 9f6ac35..4755ca9 100644\\n--- a/layout/base/nsLayoutUtils.cpp\\n+++ b/layout/base/nsLayoutUtils.cpp\\n@@ -39,7 +39,6 @@\\n  * ***** END LICENSE BLOCK ***** */\\n \\n #include \\\"nsLayoutUtils.h\\\"\\n-#include \\\"nsIFrame.h\\\"\\n #include \\\"nsIFontMetrics.h\\\"\\n #include \\\"nsIFormControlFrame.h\\\"\\n #include \\\"nsPresContext.h\\\"\\n@@ -1254,7 +1253,7 @@ static nscoord AddPercents(nsLayoutUtils::IntrinsicWidthType aType,\\n /* static */ PRBool\\n nsLayoutUtils::GetAbsoluteCoord(const nsStyleCoord& aStyle,\\n                                 nsIRenderingContext* aRenderingContext,\\n-                                nsIFrame* aFrame,\\n+                                nsStyleContext* aStyleContext,\\n                                 nscoord& aResult)\\n {\\n   nsStyleUnit unit = aStyle.GetUnit();\\n@@ -1264,7 +1263,7 @@ nsLayoutUtils::GetAbsoluteCoord(const nsStyleCoord& aStyle,\\n   }\\n   if (eStyleUnit_Chars == unit) {\\n     aResult = nsLayoutUtils::CharsToCoord(aStyle, aRenderingContext,\\n-                                          aFrame->GetStyleContext());\\n+                                          aStyleContext);\\n     return PR_TRUE;\\n   }\\n   return PR_FALSE;\\ndiff --git a/layout/base/nsLayoutUtils.h b/layout/base/nsLayoutUtils.h\\nindex 66916b1..8209bc9 100644\\n--- a/layout/base/nsLayoutUtils.h\\n+++ b/layout/base/nsLayoutUtils.h\\n@@ -41,7 +41,6 @@\\n #ifndef nsLayoutUtils_h__\\n #define nsLayoutUtils_h__\\n \\n-class nsIFrame;\\n class nsIFormControlFrame;\\n class nsPresContext;\\n class nsIContent;\\n@@ -58,6 +57,7 @@ class nsIFontMetrics;\\n #include \\\"nsAutoPtr.h\\\"\\n #include \\\"nsStyleSet.h\\\"\\n #include \\\"nsIView.h\\\"\\n+#include \\\"nsIFrame.h\\\"\\n \\n class nsBlockFrame;\\n \\n@@ -547,6 +547,18 @@ public:\\n   static PRBool GetAbsoluteCoord(const nsStyleCoord& aStyle,\\n                                  nsIRenderingContext* aRenderingContext,\\n                                  nsIFrame* aFrame,\\n+                                 nscoord& aResult)\\n+  {\\n+    return GetAbsoluteCoord(aStyle, aRenderingContext,\\n+                            aFrame->GetStyleContext(), aResult);\\n+  }\\n+\\n+  /**\\n+   * Same as above but doesn't need a frame\\n+   */\\n+  static PRBool GetAbsoluteCoord(const nsStyleCoord& aStyle,\\n+                                 nsIRenderingContext* aRenderingContext,\\n+                                 nsStyleContext* aStyleContext,\\n                                  nscoord& aResult);\\n   /**\\n    * Get the contribution of aFrame to its containing block's intrinsic\\ndiff --git a/layout/generic/nsHTMLReflowState.cpp b/layout/generic/nsHTMLReflowState.cpp\\nindex a439acf..d97acf4 100644\\n--- a/layout/generic/nsHTMLReflowState.cpp\\n+++ b/layout/generic/nsHTMLReflowState.cpp\\n@@ -2040,62 +2040,40 @@ GetNormalLineHeight(nsIFontMetrics* aFontMetrics)\\n // Need only one of aRenderingContext and aDeviceContext\\n static nscoord\\n ComputeLineHeight(nsIRenderingContext* aRenderingContext,\\n-                  nsIDeviceContext* aDeviceContext,\\n                   nsStyleContext* aStyleContext)\\n {\\n-  NS_PRECONDITION(aRenderingContext || aDeviceContext,\\n-                  \\\"Need to have a way of getting a device context\\\");\\n-\\n   nscoord lineHeight;\\n \\n-  const nsStyleFont* font = aStyleContext->GetStyleFont();\\n   const nsStyleCoord& lhCoord = aStyleContext->GetStyleText()->mLineHeight;\\n   \\n-  nsStyleUnit unit = lhCoord.GetUnit();\\n-\\n-  if (unit == eStyleUnit_Coord) {\\n-    // For length values just use the pre-computed value\\n-    lineHeight = lhCoord.GetCoordValue();\\n-  } else if (unit == eStyleUnit_Factor) {\\n-    // For factor units the computed value of the line-height property \\n-    // is found by multiplying the factor by the font's computed size\\n-    // (adjusted for min-size prefs and text zoom).\\n-    float factor = lhCoord.GetFactorValue();\\n-    lineHeight = NSToCoordRound(factor * font->mFont.size);\\n-  } else {\\n-    NS_ASSERTION(eStyleUnit_Normal == unit, \\\"bad unit\\\");\\n-    nsCOMPtr<nsIFontMetrics> fm;\\n-    nsLayoutUtils::GetFontMetricsForStyleContext(aStyleContext,\\n-                                                 getter_AddRefs(fm));\\n-    lineHeight = GetNormalLineHeight(fm);\\n+  if (!nsLayoutUtils::GetAbsoluteCoord(lhCoord, aRenderingContext,\\n+                                       aStyleContext, lineHeight)) {\\n+    const nsStyleFont* font = aStyleContext->GetStyleFont();\\n+    if (lhCoord.GetUnit() == eStyleUnit_Factor) {\\n+      // For factor units the computed value of the line-height property \\n+      // is found by multiplying the factor by the font's computed size\\n+      // (adjusted for min-size prefs and text zoom).\\n+      float factor = lhCoord.GetFactorValue();\\n+      lineHeight = NSToCoordRound(factor * font->mFont.size);\\n+    } else {\\n+      NS_ASSERTION(eStyleUnit_Normal == lhCoord.GetUnit(), \\\"bad unit\\\");\\n+      nsCOMPtr<nsIFontMetrics> fm;\\n+      nsLayoutUtils::GetFontMetricsForStyleContext(aStyleContext,\\n+                                                   getter_AddRefs(fm));\\n+      lineHeight = GetNormalLineHeight(fm);\\n+    }\\n   }\\n   return lineHeight;\\n }\\n \\n nscoord\\n nsHTMLReflowState::CalcLineHeight(nsIRenderingContext* aRenderingContext,\\n-                                  nsIFrame* aFrame)\\n-{\\n-  NS_ASSERTION(aFrame && aFrame->GetStyleContext(),\\n-               \\\"Bogus data passed in to CalcLineHeight\\\");\\n-\\n-  nscoord lineHeight = ComputeLineHeight(aRenderingContext, nsnull,\\n-                                         aFrame->GetStyleContext());\\n-\\n-  NS_ASSERTION(lineHeight >= 0, \\\"ComputeLineHeight screwed up\\\");\\n-\\n-  return lineHeight;\\n-}\\n-\\n-nscoord\\n-nsHTMLReflowState::CalcLineHeight(nsStyleContext* aStyleContext,\\n-                                  nsIDeviceContext* aDeviceContext)\\n+                                  nsStyleContext* aStyleContext)\\n {\\n+  NS_PRECONDITION(aRenderingContext, \\\"Must have a rendering context\\\");\\n   NS_PRECONDITION(aStyleContext, \\\"Must have a style context\\\");\\n-  NS_PRECONDITION(aDeviceContext, \\\"Must have a device context\\\");\\n   \\n-  nscoord lineHeight = ComputeLineHeight(nsnull, aDeviceContext,\\n-                                         aStyleContext);\\n+  nscoord lineHeight = ComputeLineHeight(aRenderingContext, aStyleContext);\\n \\n   NS_ASSERTION(lineHeight >= 0, \\\"ComputeLineHeight screwed up\\\");\\n \\ndiff --git a/layout/generic/nsHTMLReflowState.h b/layout/generic/nsHTMLReflowState.h\\nindex a6a837f..b216f2a 100644\\n--- a/layout/generic/nsHTMLReflowState.h\\n+++ b/layout/generic/nsHTMLReflowState.h\\n@@ -419,12 +419,16 @@ public:\\n    * value will be >= 0.\\n    */\\n   static nscoord CalcLineHeight(nsIRenderingContext* aRenderingContext,\\n-                                nsIFrame* aFrame);\\n+                                nsIFrame* aFrame)\\n+  {\\n+    return CalcLineHeight(aRenderingContext, aFrame->GetStyleContext());\\n+  }\\n+  \\n   /**\\n-   * Same as above, but doesn't need quite as much info.\\n+   * Same as above, but doesn't need a frame.\\n    */\\n-  static nscoord CalcLineHeight(nsStyleContext* aStyleContext,\\n-                                nsIDeviceContext* aDeviceContext);\\n+  static nscoord CalcLineHeight(nsIRenderingContext* aRenderingContext,\\n+                                nsStyleContext* aStyleContext);\\n \\n \\n   void ComputeContainingBlockRectangle(nsPresContext*          aPresContext,\\ndiff --git a/layout/reftests/bugs/391909-1-ref.html b/layout/reftests/bugs/391909-1-ref.html\\nnew file mode 100644\\nindex 0000000..cb236ec\\n--- /dev/null\\n+++ b/layout/reftests/bugs/391909-1-ref.html\\n@@ -0,0 +1,14 @@\\n+<!DOCTYPE html>\\n+<html>\\n+ <body>\\n+   <div id=\\\"source\\\" style=\\\"width: 3ch\\\"></div>\\n+   <div id=\\\"target\\\" style=\\\"width: 0\\\">\\n+    This is a test\\n+   </div>\\n+   <script>\\n+    document.getElementById(\\\"target\\\").style.lineHeight =\\n+      document.defaultView\\n+              .getComputedStyle(document.getElementById(\\\"source\\\"), \\\"\\\").width;\\n+   </script>\\n+ </body>\\n+</html>\\ndiff --git a/layout/reftests/bugs/391909-1.html b/layout/reftests/bugs/391909-1.html\\nnew file mode 100644\\nindex 0000000..34b2d06\\n--- /dev/null\\n+++ b/layout/reftests/bugs/391909-1.html\\n@@ -0,0 +1,8 @@\\n+<!DOCTYPE html>\\n+<html>\\n+<body>\\n+<div style=\\\"line-height: 3ch; width: 0\\\">\\n+This is a test\\n+</div>\\n+</body>\\n+</html>\\ndiff --git a/layout/reftests/bugs/reftest.list b/layout/reftests/bugs/reftest.list\\nindex d674c20..893c763 100644\\n--- a/layout/reftests/bugs/reftest.list\\n+++ b/layout/reftests/bugs/reftest.list\\n@@ -365,4 +365,5 @@ random-if(MOZ_WIDGET_TOOLKIT==\\\"cocoa\\\") == 379316-2.html 379316-2-ref.html # bug\\n == 390318-1a.html 390318-1-ref.html\\n == 390318-1b.html 390318-1-ref.html\\n == 391140-1.html 391140-1-ref.html\\n+== 391909-1.html 391909-1-ref.html\\n == 391994-1.html 391994-1-ref.html\\ndiff --git a/layout/style/nsComputedDOMStyle.cpp b/layout/style/nsComputedDOMStyle.cpp\\nindex 0135a00..5fca84b 100644\\n--- a/layout/style/nsComputedDOMStyle.cpp\\n+++ b/layout/style/nsComputedDOMStyle.cpp\\n@@ -2765,9 +2765,20 @@ nsComputedDOMStyle::GetPaddingWidthFor(PRUint8 aSide, nsIDOMCSSValue** aValue)\\n PRBool\\n nsComputedDOMStyle::GetLineHeightCoord(nscoord& aCoord)\\n {\\n-  aCoord = nsHTMLReflowState::CalcLineHeight(mStyleContextHolder,\\n-                                             mPresShell->GetPresContext()->\\n-                                               DeviceContext());\\n+  // Get a rendering context\\n+  nsCOMPtr<nsIRenderingContext> cx;\\n+  nsIFrame* frame = mPresShell->FrameManager()->GetRootFrame();\\n+  if (frame) {\\n+    mPresShell->CreateRenderingContext(frame, getter_AddRefs(cx));\\n+  }\\n+  if (!cx) {\\n+    // Give up\\n+    aCoord = 0;\\n+    return PR_FALSE;\\n+  }\\n+  \\n+  aCoord = nsHTMLReflowState::CalcLineHeight(cx, mStyleContextHolder);\\n+  \\n   // CalcLineHeight uses font->mFont.size, but we want to use\\n   // font->mSize as the font size.  Adjust for that.  Also adjust for\\n   // the text zoom, if any.\\n\""}