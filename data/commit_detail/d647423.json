{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basd647423\""},"diff":"\"d647423 Fix bug 394111.  r+sr+a=bzbarsky\\ndiff --git a/layout/base/nsCSSFrameConstructor.cpp b/layout/base/nsCSSFrameConstructor.cpp\\nindex 1f12619..a433661 100644\\n--- a/layout/base/nsCSSFrameConstructor.cpp\\n+++ b/layout/base/nsCSSFrameConstructor.cpp\\n@@ -1647,12 +1647,13 @@ static void\\n MoveChildrenTo(nsFrameManager*          aFrameManager,\\n                nsIFrame*                aNewParent,\\n                nsIFrame*                aFrameList,\\n+               nsIFrame*                aFrameListEnd,\\n                nsFrameConstructorState* aState,\\n                nsFrameConstructorState* aOuterState)\\n {\\n   PRBool setHasChildWithView = PR_FALSE;\\n \\n-  while (aFrameList) {\\n+  while (aFrameList && aFrameList != aFrameListEnd) {\\n     if (!setHasChildWithView\\n         && (aFrameList->GetStateBits() & (NS_FRAME_HAS_VIEW | NS_FRAME_HAS_CHILD_WITH_VIEW))) {\\n       setHasChildWithView = PR_TRUE;\\n@@ -12465,7 +12466,8 @@ nsCSSFrameConstructor::ConstructInline(nsFrameConstructorState& aState,\\n   // parent block of the inline, but its parent pointer will be the anonymous\\n   // block we create...  AdjustFloatParentPtrs() deals with this by moving the\\n   // float from the outer state |aState| to the inner |state|.\\n-  MoveChildrenTo(state.mFrameManager, blockFrame, list2, &state, &aState);\\n+  MoveChildrenTo(state.mFrameManager, blockFrame, list2, nsnull, &state,\\n+                 &aState);\\n \\n   // list3's frames belong to another inline frame\\n   nsIFrame* inlineFrame = nsnull;\\n@@ -12553,7 +12555,8 @@ nsCSSFrameConstructor::MoveFramesToEndOfIBSplit(nsFrameConstructorState& aState,\\n   }\\n \\n   // Reparent (cheaply) the frames in list3\\n-  if (!inlineFrame->GetFirstChild(nsnull) &&\\n+  nsIFrame* existingFirstChild = inlineFrame->GetFirstChild(nsnull);\\n+  if (!existingFirstChild &&\\n       (inlineFrame->GetStateBits() & NS_FRAME_FIRST_REFLOW)) {\\n     inlineFrame->SetInitialChildList(nsnull, aFramesToMove);\\n   } else {\\n@@ -12561,7 +12564,7 @@ nsCSSFrameConstructor::MoveFramesToEndOfIBSplit(nsFrameConstructorState& aState,\\n   }\\n   nsFrameConstructorState* startState = aTargetState ? &aState : nsnull;\\n   MoveChildrenTo(aState.mFrameManager, inlineFrame, aFramesToMove,\\n-                 aTargetState, startState);\\n+                 existingFirstChild, aTargetState, startState);\\n   SetFrameIsSpecial(inlineFrame, nsnull);\\n   return inlineFrame;\\n }\\ndiff --git a/layout/reftests/bugs/394111-1.html b/layout/reftests/bugs/394111-1.html\\nnew file mode 100644\\nindex 0000000..439307b\\n--- /dev/null\\n+++ b/layout/reftests/bugs/394111-1.html\\n@@ -0,0 +1,18 @@\\n+<html>\\n+<head>\\n+<script>\\n+function boom()\\n+{\\n+  var k = document.getElementById(\\\"k\\\");\\n+  k.appendChild(document.createTextNode(\\\" \\\"));\\n+}\\n+</script>\\n+</head>\\n+\\n+<body onload=\\\"boom();\\\">\\n+\\n+<span><span id=\\\"k\\\"><div></div></span><span style=\\\"float: right;\\\"></span></span>\\n+\\n+</body>\\n+\\n+</html>\\ndiff --git a/layout/reftests/bugs/reftest.list b/layout/reftests/bugs/reftest.list\\nindex 619442d..9817db0 100644\\n--- a/layout/reftests/bugs/reftest.list\\n+++ b/layout/reftests/bugs/reftest.list\\n@@ -375,3 +375,4 @@ random-if(MOZ_WIDGET_TOOLKIT==\\\"cocoa\\\") == 379316-2.html 379316-2-ref.html # bug\\n == 393671-1.html 393671-1-ref.html\\n == 393671-2.html 393671-2-ref.html\\n == 393671-3.html 393671-3-ref.html\\n+== 394111-1.html about:blank  # Really an assertion test rather than a rendering test\\n\""}