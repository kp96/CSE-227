{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas93ab174\""},"diff":"\"93ab174 Bug 395134 - When resuming a download, strange things happen in the UI.  Patch by Edward Lee <edilee@gmail.com>.  r=sdwilsh, a=mconnor\\ndiff --git a/toolkit/components/downloads/src/nsDownloadManager.cpp b/toolkit/components/downloads/src/nsDownloadManager.cpp\\nindex ae5a637..e793164 100644\\n--- a/toolkit/components/downloads/src/nsDownloadManager.cpp\\n+++ b/toolkit/components/downloads/src/nsDownloadManager.cpp\\n@@ -1498,6 +1498,7 @@ nsDownload::nsDownload() : mDownloadState(nsIDownloadManager::DOWNLOAD_NOTSTARTE\\n                            mLastUpdate(PR_Now() - (PRUint32)gUpdateInterval),\\n                            mPaused(PR_FALSE),\\n                            mWasResumed(PR_FALSE),\\n+                           mResumedAt(0),\\n                            mSpeed(0)\\n {\\n }\\n@@ -1744,9 +1745,7 @@ nsDownload::OnProgressChange64(nsIWebProgress *aWebProgress,\\n   // during that time for more accuracy.\\n   double elapsedSecs = double(delta) / PR_USEC_PER_SEC;\\n   if (elapsedSecs > 0) {\\n-    nsUint64 curTotalProgress = (PRUint64)aCurTotalProgress;\\n-    nsUint64 diffBytes = curTotalProgress - nsUint64(mCurrBytes);\\n-    double speed = double(diffBytes) / elapsedSecs;\\n+    double speed = double(aCurTotalProgress - mCurrBytes) / elapsedSecs;\\n     if (mCurrBytes == 0) {\\n       mSpeed = speed;\\n     } else {\\n@@ -1755,17 +1754,19 @@ nsDownload::OnProgressChange64(nsIWebProgress *aWebProgress,\\n     }\\n   }\\n \\n+  mCurrBytes = aCurTotalProgress;\\n+  mMaxBytes = aMaxTotalProgress;\\n+\\n+  PRUint64 currBytes, maxBytes;\\n+  (void)GetAmountTransferred(&currBytes);\\n+  (void)GetSize(&maxBytes);\\n   if (aMaxTotalProgress > 0)\\n-    mPercentComplete = (PRInt32)((PRFloat64)aCurTotalProgress * 100 / aMaxTotalProgress + .5);\\n+    mPercentComplete = (PRInt32)((PRFloat64)currBytes * 100 / maxBytes + .5);\\n   else\\n     mPercentComplete = -1;\\n \\n-  mCurrBytes = aCurTotalProgress;\\n-  mMaxBytes = aMaxTotalProgress;\\n-\\n   mDownloadManager->NotifyListenersOnProgressChange(\\n-    aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress,\\n-    aCurTotalProgress, aMaxTotalProgress, this);\\n+    aWebProgress, aRequest, currBytes, maxBytes, currBytes, maxBytes, this);\\n \\n   return NS_OK;\\n }\\n@@ -1884,12 +1885,6 @@ nsDownload::OnStateChange(nsIWebProgress* aWebProgress,\\n       if (mMaxBytes == LL_MAXUINT)\\n         mMaxBytes = mCurrBytes;\\n \\n-      // Files less than 1Kb shouldn't show up as 0Kb.\\n-      if (mMaxBytes < 1024) {\\n-        mCurrBytes = 1024;\\n-        mMaxBytes  = 1024;\\n-      }\\n-\\n       mPercentComplete = 100;\\n \\n #ifdef XP_WIN\\n@@ -1985,14 +1980,14 @@ nsDownload::GetPercentComplete(PRInt32* aPercentComplete)\\n NS_IMETHODIMP\\n nsDownload::GetAmountTransferred(PRUint64* aAmountTransferred)\\n {\\n-  *aAmountTransferred = mCurrBytes;\\n+  *aAmountTransferred = mCurrBytes + mResumedAt;\\n   return NS_OK;\\n }\\n \\n NS_IMETHODIMP\\n nsDownload::GetSize(PRUint64* aSize)\\n {\\n-  *aSize = mMaxBytes;\\n+  *aSize = mMaxBytes + (mMaxBytes != LL_MAXUINT ? mResumedAt : 0);\\n   return NS_OK;\\n }\\n \\n@@ -2112,6 +2107,11 @@ nsDownload::PauseResume(PRBool aPause)\\n     rv = resumableChannel->ResumeAt(fileSize, mEntityID);\\n     NS_ENSURE_SUCCESS(rv, rv);\\n \\n+    // Track where we resumed because progress notifications restart at 0\\n+    mResumedAt = fileSize;\\n+    mCurrBytes = 0;\\n+    mMaxBytes = LL_MAXUINT;\\n+\\n     // Set the referrer\\n     if (mReferrer) {\\n       nsCOMPtr<nsIHttpChannel> httpChannel(do_QueryInterface(channel));\\ndiff --git a/toolkit/components/downloads/src/nsDownloadManager.h b/toolkit/components/downloads/src/nsDownloadManager.h\\nindex 2ccf60c..88e369e 100644\\n--- a/toolkit/components/downloads/src/nsDownloadManager.h\\n+++ b/toolkit/components/downloads/src/nsDownloadManager.h\\n@@ -243,12 +243,20 @@ private:\\n \\n   PRUint32 mID;\\n   PRInt32 mPercentComplete;\\n+\\n+  /**\\n+   * These bytes are based on the position of where the request started, so 0\\n+   * doesn't necessarily mean we have nothing. Use GetAmountTransferred and\\n+   * GetSize for the real transferred amount and size.\\n+   */\\n   PRUint64 mCurrBytes;\\n   PRUint64 mMaxBytes;\\n+\\n   PRTime mStartTime;\\n   PRTime mLastUpdate;\\n   PRBool mPaused;\\n   PRBool mWasResumed;\\n+  PRUint64 mResumedAt;\\n   double mSpeed;\\n \\n   friend class nsDownloadManager;\\n\""}