{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas5749b66\""},"diff":"\"5749b66 Bug 394545 - Remove intl.collationOption, r+moa=smontagu, a1.9=dsicore\\ndiff --git a/browser/app/profile/firefox.js b/browser/app/profile/firefox.js\\nindex bde7132..7ef0af5 100644\\n--- a/browser/app/profile/firefox.js\\n+++ b/browser/app/profile/firefox.js\\n@@ -341,9 +341,6 @@ pref(\\\"network.cookie.enableForCurrentSessionOnly\\\", false);\\n \\n // l12n and i18n\\n pref(\\\"intl.accept_languages\\\", \\\"chrome://global/locale/intl.properties\\\");\\n-// collationOption is only set on linux for japanese. see bug 18338 and 62015\\n-// we need to check if this pref is still useful.\\n-pref(\\\"intl.collationOption\\\",  \\\"chrome://global-platform/locale/intl.properties\\\");\\n pref(\\\"intl.charsetmenu.browser.static\\\", \\\"chrome://global/locale/intl.properties\\\");\\n pref(\\\"intl.charsetmenu.browser.more1\\\",  \\\"chrome://global/locale/intl.properties\\\");\\n pref(\\\"intl.charsetmenu.browser.more2\\\",  \\\"chrome://global/locale/intl.properties\\\");\\ndiff --git a/intl/locale/src/unix/nsCollationUnix.cpp b/intl/locale/src/unix/nsCollationUnix.cpp\\nindex e7ceaf8..463194c 100644\\n--- a/intl/locale/src/unix/nsCollationUnix.cpp\\n+++ b/intl/locale/src/unix/nsCollationUnix.cpp\\n@@ -72,7 +72,6 @@ inline void nsCollationUnix::DoRestoreLocale()\\n nsCollationUnix::nsCollationUnix() \\n {\\n   mCollation = NULL;\\n-  mUseCodePointOrder = PR_FALSE;\\n }\\n \\n nsCollationUnix::~nsCollationUnix() \\n@@ -90,20 +89,6 @@ nsresult nsCollationUnix::Initialize(nsILocale* locale)\\n \\n   nsresult res;\\n \\n-  nsCOMPtr<nsIPrefBranch> prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID);\\n-  if (prefBranch) {\\n-    nsCOMPtr<nsIPrefLocalizedString> prefLocalString;\\n-    res = prefBranch->GetComplexValue(\\\"intl.collationOption\\\",\\n-                                      NS_GET_IID(nsIPrefLocalizedString),\\n-                                      getter_AddRefs(prefLocalString));\\n-    if (NS_SUCCEEDED(res) && prefLocalString) {\\n-      nsXPIDLString prefValue;\\n-      prefLocalString->GetData(getter_Copies(prefValue));\\n-      mUseCodePointOrder =\\n-        prefValue.LowerCaseEqualsLiteral(\\\"usecodepointorder\\\");\\n-    }\\n-  }\\n-\\n   mCollation = new nsCollation;\\n   if (mCollation == NULL) {\\n     NS_ASSERTION(0, \\\"mCollation creation failed\\\");\\n@@ -189,14 +174,9 @@ nsresult nsCollationUnix::CompareString(PRInt32 strength,\\n   if (NS_SUCCEEDED(res) && str1 != NULL) {\\n     res = mCollation->UnicodeToChar(stringNormalized2, &str2);\\n     if (NS_SUCCEEDED(res) && str2 != NULL) {\\n-      if (mUseCodePointOrder) {\\n-        *result = strcmp(str1, str2);\\n-      }\\n-      else {\\n-        DoSetLocale();\\n-        *result = strcoll(str1, str2);\\n-        DoRestoreLocale();\\n-      }\\n+      DoSetLocale();\\n+      *result = strcoll(str1, str2);\\n+      DoRestoreLocale();\\n       PR_Free(str2);\\n     }\\n     PR_Free(str1);\\n@@ -225,26 +205,21 @@ nsresult nsCollationUnix::AllocateRawSortKey(PRInt32 strength,\\n \\n   res = mCollation->UnicodeToChar(stringNormalized, &str);\\n   if (NS_SUCCEEDED(res) && str != NULL) {\\n-    if (mUseCodePointOrder) {\\n-      *key = (PRUint8 *)str;\\n-      *outLen = strlen(str) + 1;\\n+    DoSetLocale();\\n+    // call strxfrm to generate a key \\n+    size_t len = strxfrm(nsnull, str, 0) + 1;\\n+    void *buffer = PR_Malloc(len);\\n+    if (!buffer) {\\n+      res = NS_ERROR_OUT_OF_MEMORY;\\n+    } else if (strxfrm((char *)buffer, str, len) >= len) {\\n+      PR_Free(buffer);\\n+      res = NS_ERROR_FAILURE;\\n     } else {\\n-      DoSetLocale();\\n-      // call strxfrm to generate a key \\n-      size_t len = strxfrm(nsnull, str, 0) + 1;\\n-      void *buffer = PR_Malloc(len);\\n-      if (!buffer) {\\n-        res = NS_ERROR_OUT_OF_MEMORY;\\n-      } else if (strxfrm((char *)buffer, str, len) >= len) {\\n-        PR_Free(buffer);\\n-        res = NS_ERROR_FAILURE;\\n-      } else {\\n-        *key = (PRUint8 *)buffer;\\n-        *outLen = len;\\n-      }\\n-      DoRestoreLocale();\\n-      PR_Free(str);\\n+      *key = (PRUint8 *)buffer;\\n+      *outLen = len;\\n     }\\n+    DoRestoreLocale();\\n+    PR_Free(str);\\n   }\\n \\n   return res;\\ndiff --git a/modules/libpref/src/init/all.js b/modules/libpref/src/init/all.js\\nindex c3de828..3a26c12 100644\\n--- a/modules/libpref/src/init/all.js\\n+++ b/modules/libpref/src/init/all.js\\n@@ -785,7 +785,6 @@ pref(\\\"converter.html2txt.header_strategy\\\",  1); // 0 = no indention; 1 = indenti\\n \\n pref(\\\"intl.accept_languages\\\",               \\\"chrome://navigator/locale/navigator.properties\\\");\\n pref(\\\"intl.accept_charsets\\\",                \\\"iso-8859-1,*,utf-8\\\");\\n-pref(\\\"intl.collationOption\\\",                \\\"chrome://navigator-platform/locale/navigator.properties\\\");\\n pref(\\\"intl.menuitems.alwaysappendaccesskeys\\\",\\\"chrome://navigator/locale/navigator.properties\\\");\\n pref(\\\"intl.menuitems.insertseparatorbeforeaccesskeys\\\",\\\"chrome://navigator/locale/navigator.properties\\\");\\n pref(\\\"intl.charsetmenu.browser.static\\\",     \\\"chrome://navigator/locale/navigator.properties\\\");\\ndiff --git a/toolkit/locales/en-US/chrome/global-platform/mac/intl.properties b/toolkit/locales/en-US/chrome/global-platform/mac/intl.properties\\nindex 608897d..ca40892 100644\\n--- a/toolkit/locales/en-US/chrome/global-platform/mac/intl.properties\\n+++ b/toolkit/locales/en-US/chrome/global-platform/mac/intl.properties\\n@@ -1,4 +1,2 @@\\n # moved from navigator/locale/navigator.properties\\n-# valid collation options are: <empty string> or useCodePointOrder\\n-intl.collationOption=\\n intl.charset.default=ISO-8859-1\\ndiff --git a/toolkit/locales/en-US/chrome/global-platform/unix/intl.properties b/toolkit/locales/en-US/chrome/global-platform/unix/intl.properties\\nindex 608897d..ca40892 100644\\n--- a/toolkit/locales/en-US/chrome/global-platform/unix/intl.properties\\n+++ b/toolkit/locales/en-US/chrome/global-platform/unix/intl.properties\\n@@ -1,4 +1,2 @@\\n # moved from navigator/locale/navigator.properties\\n-# valid collation options are: <empty string> or useCodePointOrder\\n-intl.collationOption=\\n intl.charset.default=ISO-8859-1\\ndiff --git a/toolkit/locales/en-US/chrome/global-platform/win/intl.properties b/toolkit/locales/en-US/chrome/global-platform/win/intl.properties\\nindex 608897d..ca40892 100644\\n--- a/toolkit/locales/en-US/chrome/global-platform/win/intl.properties\\n+++ b/toolkit/locales/en-US/chrome/global-platform/win/intl.properties\\n@@ -1,4 +1,2 @@\\n # moved from navigator/locale/navigator.properties\\n-# valid collation options are: <empty string> or useCodePointOrder\\n-intl.collationOption=\\n intl.charset.default=ISO-8859-1\\ndiff --git a/toolkit/locales/en-US/chrome/global/intl.properties b/toolkit/locales/en-US/chrome/global/intl.properties\\nindex c11bd04..741e097 100644\\n--- a/toolkit/locales/en-US/chrome/global/intl.properties\\n+++ b/toolkit/locales/en-US/chrome/global/intl.properties\\n@@ -26,8 +26,6 @@ intl.charsetmenu.browser.unicode=UTF-8, UTF-16LE, UTF-16BE, UTF-32LE, UTF-32BE,\\n intl.charset.default=ISO-8859-1\\n intl.charset.detector=\\n intl.charsetmenu.mailedit=ISO-8859-1, ISO-8859-15, ISO-8859-6, armscii-8, geostd8, ISO-8859-13, ISO-8859-14, ISO-8859-2, GB2312, GB18030, Big5, KOI8-R, windows-1251, KOI8-U, ISO-8859-7, ISO-8859-8-I, windows-1255, ISO-2022-JP, EUC-KR, ISO-8859-10, ISO-8859-3, TIS-620, ISO-8859-9, UTF-8, VISCII\\n-# valid collation options are: <empty string> or useCodePointOrder\\n-intl.collationOption=\\n # valid intl.menuitems.appendedacceskeys are: true or false, <empty string> (missing or empty preference equals false)\\n intl.menuitems.alwaysappendaccesskeys=\\n # valid intl.menuitems.insertseparatorbeforeaccesskeys are: true or false, <empty string> (missing or empty preference equals false)\\ndiff --git a/xulrunner/app/xulrunner.js b/xulrunner/app/xulrunner.js\\nindex d0ffc62..9a9ae9f 100644\\n--- a/xulrunner/app/xulrunner.js\\n+++ b/xulrunner/app/xulrunner.js\\n@@ -42,7 +42,6 @@\\n pref(\\\"general.useragent.locale\\\", \\\"@AB_CD@\\\");\\n pref(\\\"font.language.group\\\", \\\"chrome://global/locale/intl.properties\\\");\\n pref(\\\"intl.accept_languages\\\", \\\"chrome://global/locale/intl.properties\\\");\\n-pref(\\\"intl.collationOption\\\",  \\\"chrome://global-platform/locale/intl.properties\\\");\\n pref(\\\"intl.charsetmenu.browser.static\\\", \\\"chrome://global/locale/intl.properties\\\");\\n pref(\\\"intl.charsetmenu.browser.more1\\\",  \\\"chrome://global/locale/intl.properties\\\");\\n pref(\\\"intl.charsetmenu.browser.more2\\\",  \\\"chrome://global/locale/intl.properties\\\");\\n\""}