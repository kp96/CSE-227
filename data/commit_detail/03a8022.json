{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas03a8022\""},"diff":"\"03a8022 Bug 389224: Clipped objects are sometimes not fully redrawn after clipping. r+sr=roc, a=dbaron\\ndiff --git a/layout/generic/nsAbsoluteContainingBlock.cpp b/layout/generic/nsAbsoluteContainingBlock.cpp\\nindex 4149905..35b0a02 100644\\n--- a/layout/generic/nsAbsoluteContainingBlock.cpp\\n+++ b/layout/generic/nsAbsoluteContainingBlock.cpp\\n@@ -423,12 +423,12 @@ nsAbsoluteContainingBlock::ReflowAbsoluteFrame(nsIFrame*                aDelegat\\n \\n   if (oldRect.TopLeft() != rect.TopLeft() || \\n       (aDelegatingFrame->GetStateBits() & NS_FRAME_FIRST_REFLOW) ||\\n-      ((aKidFrame->GetStyleDisplay()->mClipFlags & NS_STYLE_CLIP_RECT) && \\n-       (kidDesiredSize.mOverflowArea != oldOverflowRect))) {\\n+      (kidDesiredSize.mOverflowArea + rect.TopLeft() != oldOverflowRect &&\\n+        (kidDesiredSize.mOverflowArea + rect.TopLeft() != rect || oldRect != oldOverflowRect))) {\\n     // The frame moved; we have to invalidate the whole frame\\n     // because the children may have moved after they were reflowed\\n-    // We also have to invalidate when we're clipping and the overflow\\n-    // changes; the style code doesn't know how to deal with this case\\n+    // We also have to invalidate when we have overflow and the overflow\\n+    // changes because the change might be caused by clipping\\n     // XXX This could be optimized in some cases, especially clipping changes\\n     aKidFrame->GetParent()->Invalidate(oldOverflowRect);\\n     aKidFrame->GetParent()->Invalidate(kidDesiredSize.mOverflowArea +\\ndiff --git a/layout/style/nsStyleStruct.cpp b/layout/style/nsStyleStruct.cpp\\nindex f0fbdbc..133b634 100644\\n--- a/layout/style/nsStyleStruct.cpp\\n+++ b/layout/style/nsStyleStruct.cpp\\n@@ -1169,11 +1169,6 @@ nsChangeHint nsStyleDisplay::CalcDifference(const nsStyleDisplay& aOther) const\\n \\n   if (mClipFlags != aOther.mClipFlags || mClip != aOther.mClip) {\\n     NS_UpdateHint(hint, nsChangeHint_ReflowFrame);\\n-    // The reflow code in naAbsoluteContainingBlock can deal with invalidation\\n-    // in all cases except changing from non-auto clip to auto clip; when\\n-    // changing to auto clip, the frame can't tell what happened\\n-    if (mClipFlags == NS_STYLE_CLIP_AUTO)\\n-      NS_UpdateHint(hint, nsChangeHint_RepaintFrame);\\n   }\\n   // XXX the following is conservative, for now: changing float breaking shouldn't\\n   // necessarily require a repaint, reflow should suffice.\\n\""}