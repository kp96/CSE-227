{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas72444a1\""},"diff":"\"72444a1 Bug 348369 - Tabbrowser steals focus any time the current browser changes. r=gavin.\\ndiff --git a/browser/base/content/tabbrowser.xml b/browser/base/content/tabbrowser.xml\\nindex feee2fd..f96ed53 100644\\n--- a/browser/base/content/tabbrowser.xml\\n+++ b/browser/base/content/tabbrowser.xml\\n@@ -763,16 +763,37 @@\\n             else if (newBrowser.focusedWindow) {\\n               whatToFocus = newBrowser.focusedWindow;\\n             }\\n-\\n-            function setFocus(element) {\\n-              document.commandDispatcher.suppressFocusScroll = true;\\n-              try {\\n-                element.focus();\\n+ \\n+            // Change focus for this window to |aElement|, without focusing the\\n+            // window itself.\\n+            function setFocus(aElement) {\\n+              var cmdDispatcher = document.commandDispatcher;\\n+\\n+              var ww =\\n+                Components.classes[\\\"@mozilla.org/embedcomp/window-watcher;1\\\"]\\n+                          .getService(Components.interfaces.nsIWindowWatcher);\\n+              if (ww.activeWindow == window) {\\n+                cmdDispatcher.suppressFocusScroll = true;\\n+                try {\\n+                  aElement.focus();\\n+                }\\n+                catch(ex) {\\n+                  dump(\\\"XXX focus() failed, see bug #348183: ex = \\\" + ex + \\\"\\\\n\\\");\\n+                }\\n+                cmdDispatcher.suppressFocusScroll = false;\\n               }\\n-              catch(ex) {\\n-                dump(\\\"XXX focus() failed, see bug #348183: ex = \\\" + ex + \\\"\\\\n\\\");\\n+              else {\\n+                // set the element in command dispatcher so focus will restore\\n+                // properly when the window does become active\\n+                if (aElement instanceof Window) {\\n+                  cmdDispatcher.focusedWindow = aElement;\\n+                  cmdDispatcher.focusedElement = null;\\n+                }\\n+                else {\\n+                  cmdDispatcher.focusedWindow = aElement.ownerDocument.defaultView;\\n+                  cmdDispatcher.focusedElement = aElement;\\n+                }\\n               }\\n-              document.commandDispatcher.suppressFocusScroll = false;\\n             }\\n \\n             // Use setTimeout to avoid focus outline ghosting.\\n\""}