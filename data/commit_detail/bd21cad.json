{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basbd21cad\""},"diff":"\"bd21cad Make \\\"view iamge\\\" work on -moz-icon images.  Bug 392799, patch by Rich Dougherty <rich@rd.gen.nz>, r+a=pavlov, sr=biesi\\ndiff --git a/modules/libpr0n/decoders/icon/nsIconModule.cpp b/modules/libpr0n/decoders/icon/nsIconModule.cpp\\nindex f48d786..7d7afc8 100644\\n--- a/modules/libpr0n/decoders/icon/nsIconModule.cpp\\n+++ b/modules/libpr0n/decoders/icon/nsIconModule.cpp\\n@@ -39,6 +39,8 @@\\n \\n #include \\\"nsIGenericFactory.h\\\"\\n #include \\\"nsIModule.h\\\"\\n+#include \\\"nsICategoryManager.h\\\"\\n+#include \\\"nsServiceManagerUtils.h\\\"\\n \\n #ifdef USE_ICON_DECODER\\n #include \\\"nsIconDecoder.h\\\"\\n@@ -58,13 +60,47 @@ NS_GENERIC_FACTORY_CONSTRUCTOR(nsIconDecoder)\\n #endif\\n NS_GENERIC_FACTORY_CONSTRUCTOR(nsIconProtocolHandler)\\n \\n+#ifdef USE_ICON_DECODER\\n+static const char gIconMimeType[] = \\\"image/icon\\\";\\n+\\n+static NS_METHOD IconDecoderRegisterProc(nsIComponentManager *aCompMgr,\\n+                                   nsIFile *aPath,\\n+                                   const char *registryLocation,\\n+                                   const char *componentType,\\n+                                   const nsModuleComponentInfo *info) {\\n+  nsresult rv;\\n+  nsCOMPtr<nsICategoryManager> catMan(do_GetService(NS_CATEGORYMANAGER_CONTRACTID, &rv));\\n+  if (NS_FAILED(rv))\\n+    return rv;\\n+  catMan->AddCategoryEntry(\\\"Gecko-Content-Viewers\\\", gIconMimeType,\\n+                           \\\"@mozilla.org/content/document-loader-factory;1\\\",\\n+                           PR_TRUE, PR_TRUE, nsnull);\\n+  return NS_OK;\\n+}\\n+\\n+static NS_METHOD IconDecoderUnregisterProc(nsIComponentManager *aCompMgr,\\n+                                     nsIFile *aPath,\\n+                                     const char *registryLocation,\\n+                                     const nsModuleComponentInfo *info) {\\n+  nsresult rv;\\n+  nsCOMPtr<nsICategoryManager> catMan(do_GetService(NS_CATEGORYMANAGER_CONTRACTID, &rv));\\n+  if (NS_FAILED(rv))\\n+    return rv;\\n+  catMan->DeleteCategoryEntry(\\\"Gecko-Content-Viewers\\\", gIconMimeType, PR_TRUE);\\n+  return NS_OK;\\n+}\\n+\\n+#endif\\n+\\n static const nsModuleComponentInfo components[] =\\n {\\n #ifdef USE_ICON_DECODER\\n   { \\\"icon decoder\\\",\\n     NS_ICONDECODER_CID,\\n     \\\"@mozilla.org/image/decoder;2?type=image/icon\\\",\\n-    nsIconDecoderConstructor, },\\n+    nsIconDecoderConstructor,\\n+    IconDecoderRegisterProc,\\n+    IconDecoderUnregisterProc, },\\n #endif\\n \\n    { \\\"Icon Protocol Handler\\\",      \\n\""}