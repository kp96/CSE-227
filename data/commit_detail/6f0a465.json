{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas6f0a465\""},"diff":"\"6f0a465 Bug 396649: Content viewers not evicted when going back.  r+sr+a=bzbarsky\\ndiff --git a/docshell/shistory/src/nsSHistory.cpp b/docshell/shistory/src/nsSHistory.cpp\\nindex fd231b6..102beae 100644\\n--- a/docshell/shistory/src/nsSHistory.cpp\\n+++ b/docshell/shistory/src/nsSHistory.cpp\\n@@ -766,7 +766,13 @@ nsSHistory::EvictWindowContentViewers(PRInt32 aFromIndex, PRInt32 aToIndex)\\n {\\n   // To enforce the per SHistory object limit on cached content viewers, we\\n   // need to release all of the content viewers that are no longer in the\\n-  // \\\"window\\\" that now ends/begins at aToIndex.\\n+  // \\\"window\\\" that now ends/begins at aToIndex.  Existing content viewers\\n+  // should be in the window from\\n+  // aFromIndex - gHistoryMaxViewers to aFromIndex + gHistoryMaxViewers\\n+  //\\n+  // We make the assumption that entries outside this range have no viewers so\\n+  // that we don't have to walk the whole entire session history checking for\\n+  // content viewers.\\n \\n   // This can happen on the first load of a page in a particular window\\n   if (aFromIndex < 0 || aToIndex < 0) {\\n@@ -787,7 +793,7 @@ nsSHistory::EvictWindowContentViewers(PRInt32 aFromIndex, PRInt32 aToIndex)\\n     if (startIndex >= mLength) {\\n       return;\\n     }\\n-    endIndex = PR_MIN(mLength, aFromIndex + gHistoryMaxViewers);\\n+    endIndex = PR_MIN(mLength, aFromIndex + gHistoryMaxViewers + 1);\\n   }\\n   \\n   EvictContentViewersInRange(startIndex, endIndex);\\n\""}