{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas52b4920\""},"diff":"\"52b4920 Fix for bug 224416 - tabs don't remember focused element. patch by Will Devine. <yakgoatcamel@myrealbox.com>\\ndiff --git a/browser/base/content/tabbrowser.xml b/browser/base/content/tabbrowser.xml\\nindex a7d005f..3c8d7e1 100644\\n--- a/browser/base/content/tabbrowser.xml\\n+++ b/browser/base/content/tabbrowser.xml\\n@@ -78,6 +78,7 @@\\n           </xul:menupopup>\\n \\n           <xul:tabs class=\\\"tabbrowser-tabs\\\" closebutton=\\\"true\\\" flex=\\\"1\\\"\\n+                    setfocus=\\\"false\\\"\\n                     onclick=\\\"this.parentNode.parentNode.parentNode.onTabClick(event);\\\"\\n                     onmousedown=\\\"this.parentNode.parentNode.parentNode.updateContextTab(event);\\\"\\n                     ondragover=\\\"nsDragAndDrop.dragOver(event, this.parentNode.parentNode.parentNode);\\n@@ -421,8 +422,11 @@\\n             if (this.mCurrentBrowser == newBrowser)\\n               return;\\n \\n-            if (this.mCurrentBrowser)\\n-              this.mCurrentBrowser.setAttribute(\\\"type\\\", \\\"content\\\");\\n+            if (this.mCurrentBrowser) {\\n+              this.mCurrentBrowser.focusedWindow = document.commandDispatcher.focusedWindow;\\n+              this.mCurrentBrowser.focusedElement = document.commandDispatcher.focusedElement;\\n+               this.mCurrentBrowser.setAttribute(\\\"type\\\", \\\"content\\\");\\n+            }\\n             \\n             var updatePageReport = false;\\n             if ((this.mCurrentBrowser.pageReport && !newBrowser.pageReport) ||\\n@@ -484,8 +488,24 @@\\n               }\\n             }\\n \\n-            // Focus our new content area.\\n-            setTimeout(\\\"window._content.focus()\\\", 0);\\n+            function setFocus(element) {\\n+              Components.lookupMethod(element, \\\"focus\\\").call(element);\\n+            }\\n+\\n+            // Focus the previously focused element or window\\n+            document.commandDispatcher.suppressFocusScroll = true;\\n+            if (newBrowser.focusedElement) {\\n+              try {\\n+                setFocus(newBrowser.focusedElement);\\n+              } catch (e) {\\n+                setFocus(newBrowser.focusedWindow);\\n+              }\\n+            }\\n+            else if (newBrowser.focusedWindow)\\n+              setFocus(newBrowser.focusedWindow);\\n+            else // new tab, focus our new content area\\n+              setTimeout(setFocus, 0, window.content);\\n+            document.commandDispatcher.suppressFocusScroll = false;    \\n           ]]>\\n         </body>\\n       </method>\\n\""}