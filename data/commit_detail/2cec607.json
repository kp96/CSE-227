{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas2cec607\""},"diff":"\"2cec607 Bug 395155 - Changing CSS text inside svg:style has no effect. r=tor,sr=roc,a=roc\\ndiff --git a/content/html/content/src/nsHTMLStyleElement.cpp b/content/html/content/src/nsHTMLStyleElement.cpp\\nindex 283d1c3..d9da5c0 100644\\n--- a/content/html/content/src/nsHTMLStyleElement.cpp\\n+++ b/content/html/content/src/nsHTMLStyleElement.cpp\\n@@ -97,20 +97,10 @@ public:\\n   virtual nsresult Clone(nsINodeInfo *aNodeInfo, nsINode **aResult) const;\\n \\n   // nsIMutationObserver\\n-  virtual void CharacterDataChanged(nsIDocument* aDocument,\\n-                                    nsIContent* aContent,\\n-                                    CharacterDataChangeInfo* aInfo);\\n-  virtual void ContentAppended(nsIDocument* aDocument,\\n-                                nsIContent* aContainer,\\n-                               PRInt32 aNewIndexInContainer);\\n-  virtual void ContentInserted(nsIDocument* aDocument,\\n-                               nsIContent* aContainer,\\n-                               nsIContent* aChild,\\n-                               PRInt32 aIndexInContainer);\\n-  virtual void ContentRemoved(nsIDocument* aDocument,\\n-                              nsIContent* aContainer,\\n-                              nsIContent* aChild,\\n-                              PRInt32 aIndexInContainer);\\n+  NS_DECL_NSIMUTATIONOBSERVER_CHARACTERDATACHANGED\\n+  NS_DECL_NSIMUTATIONOBSERVER_CONTENTAPPENDED\\n+  NS_DECL_NSIMUTATIONOBSERVER_CONTENTINSERTED\\n+  NS_DECL_NSIMUTATIONOBSERVER_CONTENTREMOVED\\n \\n protected:\\n   void GetStyleSheetURL(PRBool* aIsInline,\\ndiff --git a/content/svg/content/src/nsSVGStyleElement.cpp b/content/svg/content/src/nsSVGStyleElement.cpp\\nindex 78a6a12..6a0fd15 100644\\n--- a/content/svg/content/src/nsSVGStyleElement.cpp\\n+++ b/content/svg/content/src/nsSVGStyleElement.cpp\\n@@ -47,7 +47,8 @@ typedef nsSVGElement nsSVGStyleElementBase;\\n \\n class nsSVGStyleElement : public nsSVGStyleElementBase,\\n                           public nsIDOMSVGStyleElement,\\n-                          public nsStyleLinkElement\\n+                          public nsStyleLinkElement,\\n+                          public nsStubMutationObserver\\n {\\n protected:\\n   friend nsresult NS_NewSVGStyleElement(nsIContent **aResult,\\n@@ -64,9 +65,6 @@ public:\\n   NS_FORWARD_NSIDOMSVGELEMENT(nsSVGStyleElementBase::)\\n \\n   // nsIContent\\n-  virtual nsresult InsertChildAt(nsIContent* aKid, PRUint32 aIndex,\\n-                                 PRBool aNotify);\\n-  virtual nsresult RemoveChildAt(PRUint32 aIndex, PRBool aNotify);\\n   virtual nsresult BindToTree(nsIDocument* aDocument, nsIContent* aParent,\\n                               nsIContent* aBindingParent,\\n                               PRBool aCompileEventHandlers);\\n@@ -85,6 +83,12 @@ public:\\n \\n   virtual nsresult Clone(nsINodeInfo *aNodeInfo, nsINode **aResult) const;\\n \\n+  // nsIMutationObserver\\n+  NS_DECL_NSIMUTATIONOBSERVER_CHARACTERDATACHANGED\\n+  NS_DECL_NSIMUTATIONOBSERVER_CONTENTAPPENDED\\n+  NS_DECL_NSIMUTATIONOBSERVER_CONTENTINSERTED\\n+  NS_DECL_NSIMUTATIONOBSERVER_CONTENTREMOVED\\n+\\n protected:\\n   // Dummy init method to make the NS_IMPL_NS_NEW_SVG_ELEMENT and\\n   // NS_IMPL_ELEMENT_CLONE_WITH_INIT usable with this class. This should be\\n@@ -101,6 +105,12 @@ protected:\\n                          nsAString& aType,\\n                          nsAString& aMedia,\\n                          PRBool* aIsAlternate);\\n+  /**\\n+   * Common method to call from the various mutation observer methods.\\n+   * aContent is a content node that's either the one that changed or its\\n+   * parent; we should only respond to the change if aContent is non-anonymous.\\n+   */\\n+  void ContentChanged(nsIContent* aContent);\\n };\\n \\n \\n@@ -120,6 +130,7 @@ NS_INTERFACE_MAP_BEGIN(nsSVGStyleElement)\\n   NS_INTERFACE_MAP_ENTRY(nsIDOMSVGStyleElement)\\n   NS_INTERFACE_MAP_ENTRY(nsIDOMLinkStyle)\\n   NS_INTERFACE_MAP_ENTRY(nsIStyleSheetLinkingElement)\\n+  NS_INTERFACE_MAP_ENTRY(nsIMutationObserver)\\n   NS_INTERFACE_MAP_ENTRY_CONTENT_CLASSINFO(SVGStyleElement)\\n NS_INTERFACE_MAP_END_INHERITING(nsSVGStyleElementBase)\\n \\n@@ -129,7 +140,7 @@ NS_INTERFACE_MAP_END_INHERITING(nsSVGStyleElementBase)\\n nsSVGStyleElement::nsSVGStyleElement(nsINodeInfo *aNodeInfo)\\n   : nsSVGStyleElementBase(aNodeInfo)\\n {\\n-\\n+  AddMutationObserver(this);\\n }\\n \\n \\n@@ -144,29 +155,6 @@ NS_IMPL_ELEMENT_CLONE_WITH_INIT(nsSVGStyleElement)\\n // nsIContent methods\\n \\n nsresult\\n-nsSVGStyleElement::InsertChildAt(nsIContent* aKid, PRUint32 aIndex,\\n-                                 PRBool aNotify)\\n-{\\n-  nsresult rv = nsSVGStyleElementBase::InsertChildAt(aKid, aIndex, aNotify);\\n-  if (NS_SUCCEEDED(rv)) {\\n-    UpdateStyleSheetInternal(nsnull);\\n-  }\\n-\\n-  return rv;\\n-}\\n-\\n-nsresult\\n-nsSVGStyleElement::RemoveChildAt(PRUint32 aIndex, PRBool aNotify)\\n-{\\n-  nsresult rv = nsSVGStyleElementBase::RemoveChildAt(aIndex, aNotify);\\n-  if (NS_SUCCEEDED(rv)) {\\n-    UpdateStyleSheetInternal(nsnull);\\n-  }\\n-\\n-  return rv;\\n-}\\n-\\n-nsresult\\n nsSVGStyleElement::BindToTree(nsIDocument* aDocument, nsIContent* aParent,\\n                               nsIContent* aBindingParent,\\n                               PRBool aCompileEventHandlers)\\n@@ -226,6 +214,51 @@ nsSVGStyleElement::UnsetAttr(PRInt32 aNameSpaceID, nsIAtom* aAttribute,\\n }\\n \\n //----------------------------------------------------------------------\\n+// nsIMutationObserver methods\\n+\\n+void\\n+nsSVGStyleElement::CharacterDataChanged(nsIDocument* aDocument,\\n+                                        nsIContent* aContent,\\n+                                        CharacterDataChangeInfo* aInfo)\\n+{\\n+  ContentChanged(aContent);\\n+}\\n+\\n+void\\n+nsSVGStyleElement::ContentAppended(nsIDocument* aDocument,\\n+                                   nsIContent* aContainer,\\n+                                   PRInt32 aNewIndexInContainer)\\n+{\\n+  ContentChanged(aContainer);\\n+}\\n+ \\n+void\\n+nsSVGStyleElement::ContentInserted(nsIDocument* aDocument,\\n+                                   nsIContent* aContainer,\\n+                                   nsIContent* aChild,\\n+                                   PRInt32 aIndexInContainer)\\n+{\\n+  ContentChanged(aChild);\\n+}\\n+ \\n+void\\n+nsSVGStyleElement::ContentRemoved(nsIDocument* aDocument,\\n+                                  nsIContent* aContainer,\\n+                                  nsIContent* aChild,\\n+                                  PRInt32 aIndexInContainer)\\n+{\\n+  ContentChanged(aChild);\\n+}\\n+\\n+void\\n+nsSVGStyleElement::ContentChanged(nsIContent* aContent)\\n+{\\n+  if (nsContentUtils::IsInSameAnonymousTree(this, aContent)) {\\n+    UpdateStyleSheetInternal(nsnull);\\n+  }\\n+}\\n+\\n+//----------------------------------------------------------------------\\n // nsIDOMSVGStyleElement methods\\n \\n /* attribute DOMString xmlspace; */\\ndiff --git a/layout/reftests/svg/reftest.list b/layout/reftests/svg/reftest.list\\nindex f7fe45c..2332707 100755\\n--- a/layout/reftests/svg/reftest.list\\n+++ b/layout/reftests/svg/reftest.list\\n@@ -22,5 +22,10 @@ skip-if(MOZ_WIDGET_TOOLKIT==\\\"gtk2\\\") == pseudo-classes-02.svg pseudo-classes-02-r\\n fails == style-property-not-on-script-element-01.svg pass.svg\\n fails-if(MOZ_WIDGET_TOOLKIT==\\\"gtk2\\\") == text-font-weight-01.svg text-font-weight-01-ref.svg # bug 386713\\n skip-if(MOZ_WIDGET_TOOLKIT==\\\"gtk2\\\") == text-in-link-01.svg text-in-link-01-ref.svg # bug 379600 (crashes linux)\\n+== text-style-01a.svg text-style-01-ref.svg\\n+== text-style-01b.svg text-style-01-ref.svg\\n+== text-style-01c.svg text-style-01-ref.svg\\n+== text-style-01d.svg text-style-01-ref.svg\\n+== text-style-01e.svg text-style-01-ref.svg\\n == viewport-percent-graphic-user-01.svg pass.svg\\n == dynamic-reflow-01.svg dynamic-reflow-01-ref.svg\\ndiff --git a/layout/reftests/svg/text-style-01-ref.svg b/layout/reftests/svg/text-style-01-ref.svg\\nnew file mode 100755\\nindex 0000000..36480d7\\n--- /dev/null\\n+++ b/layout/reftests/svg/text-style-01-ref.svg\\n@@ -0,0 +1,21 @@\\n+<!--\\n+     Any copyright is dedicated to the Public Domain.\\n+     http://creativecommons.org/licenses/publicdomain/\\n+-->\\n+<svg xmlns=\\\"http://www.w3.org/2000/svg\\\">\\n+\\n+<title>Reference for style changes</title>\\n+\\n+<!-- From https://bugzilla.mozilla.org/show_bug.cgi?id=395155 -->\\n+\\n+<style id=\\\"s\\\" type=\\\"text/css\\\">\\n+tspan { fill: green; }\\n+</style>\\n+\\n+<text>\\n+  <tspan x=\\\"10\\\" y=\\\"50\\\">\\n+    This should be green\\n+  </tspan>\\n+</text>\\n+\\n+</svg>\\ndiff --git a/layout/reftests/svg/text-style-01a.svg b/layout/reftests/svg/text-style-01a.svg\\nnew file mode 100755\\nindex 0000000..59e943c\\n--- /dev/null\\n+++ b/layout/reftests/svg/text-style-01a.svg\\n@@ -0,0 +1,29 @@\\n+<!--\\n+     Any copyright is dedicated to the Public Domain.\\n+     http://creativecommons.org/licenses/publicdomain/\\n+-->\\n+<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" onload=\\\"m();>\\n+\\n+<title>Reference for style changes</title>\\n+\\n+<!-- From https://bugzilla.mozilla.org/show_bug.cgi?id=395155 -->\\n+\\n+<style id=\\\"s\\\" type=\\\"text/css\\\">\\n+* { fill: red; }\\n+</style>\\n+\\n+<script>\\n+function m()\\n+{\\n+  var s = document.getElementById(\\\"s\\\");\\n+  s.appendChild(document.createTextNode(\\\"tspan { fill: green }\\\"));\\n+}\\n+</script>\\n+\\n+<text>\\n+  <tspan x=\\\"10\\\" y=\\\"50\\\">\\n+    This should be green\\n+  </tspan>\\n+</text>\\n+\\n+</svg>\\ndiff --git a/layout/reftests/svg/text-style-01b.svg b/layout/reftests/svg/text-style-01b.svg\\nnew file mode 100755\\nindex 0000000..d11e921\\n--- /dev/null\\n+++ b/layout/reftests/svg/text-style-01b.svg\\n@@ -0,0 +1,30 @@\\n+<!--\\n+     Any copyright is dedicated to the Public Domain.\\n+     http://creativecommons.org/licenses/publicdomain/\\n+-->\\n+<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" onload=\\\"m();>\\n+\\n+<title>Reference for style changes</title>\\n+\\n+<!-- From https://bugzilla.mozilla.org/show_bug.cgi?id=395155 -->\\n+\\n+<style id=\\\"s\\\" type=\\\"text/css\\\">\\n+* { fill: red; }\\n+</style>\\n+\\n+<script>\\n+function m()\\n+{\\n+  var s = document.getElementById(\\\"s\\\");\\n+  s.appendChild(document.createTextNode(\\\"tspan { fill: \\\"));\\n+  s.appendChild(document.createTextNode(\\\"green }\\\"));\\n+}\\n+</script>\\n+\\n+<text>\\n+  <tspan x=\\\"10\\\" y=\\\"50\\\">\\n+    This should be green\\n+  </tspan>\\n+</text>\\n+\\n+</svg>\\ndiff --git a/layout/reftests/svg/text-style-01c.svg b/layout/reftests/svg/text-style-01c.svg\\nnew file mode 100755\\nindex 0000000..d48ce64\\n--- /dev/null\\n+++ b/layout/reftests/svg/text-style-01c.svg\\n@@ -0,0 +1,29 @@\\n+<!--\\n+     Any copyright is dedicated to the Public Domain.\\n+     http://creativecommons.org/licenses/publicdomain/\\n+-->\\n+<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" onload=\\\"m();>\\n+\\n+<title>Reference for style changes</title>\\n+\\n+<!-- From https://bugzilla.mozilla.org/show_bug.cgi?id=395155 -->\\n+\\n+<style id=\\\"s\\\" type=\\\"text/css\\\">\\n+tspan { fill: red; }\\n+</style>\\n+\\n+<script>\\n+function m()\\n+{\\n+  var s = document.getElementById(\\\"s\\\");\\n+  s.firstChild.data = s.firstChild.data.replace(\\\"red\\\", \\\"green\\\");\\n+}\\n+</script>\\n+\\n+<text>\\n+  <tspan x=\\\"10\\\" y=\\\"50\\\">\\n+    This should be green\\n+  </tspan>\\n+</text>\\n+\\n+</svg>\\ndiff --git a/layout/reftests/svg/text-style-01d.svg b/layout/reftests/svg/text-style-01d.svg\\nnew file mode 100755\\nindex 0000000..1721e63\\n--- /dev/null\\n+++ b/layout/reftests/svg/text-style-01d.svg\\n@@ -0,0 +1,30 @@\\n+<!--\\n+     Any copyright is dedicated to the Public Domain.\\n+     http://creativecommons.org/licenses/publicdomain/\\n+-->\\n+<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" onload=\\\"m();>\\n+\\n+<title>Reference for style changes</title>\\n+\\n+<!-- From https://bugzilla.mozilla.org/show_bug.cgi?id=395155 -->\\n+\\n+<style id=\\\"s\\\" type=\\\"text/css\\\">\\n+* { fill: red; }\\n+</style>\\n+\\n+<script>\\n+function m()\\n+{\\n+  var s = document.getElementById(\\\"s\\\");\\n+  s.appendChild(document.createTextNode(\\\"\\\"));\\n+  s.firstChild.data = \\\"tspan { fill: green }\\\";\\n+}\\n+</script>\\n+\\n+<text>\\n+  <tspan x=\\\"10\\\" y=\\\"50\\\">\\n+    This should be green\\n+  </tspan>\\n+</text>\\n+\\n+</svg>\\ndiff --git a/layout/reftests/svg/text-style-01e.svg b/layout/reftests/svg/text-style-01e.svg\\nnew file mode 100755\\nindex 0000000..0308d5c\\n--- /dev/null\\n+++ b/layout/reftests/svg/text-style-01e.svg\\n@@ -0,0 +1,31 @@\\n+<!--\\n+     Any copyright is dedicated to the Public Domain.\\n+     http://creativecommons.org/licenses/publicdomain/\\n+-->\\n+<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" onload=\\\"m();>\\n+\\n+<title>Reference for style changes</title>\\n+\\n+<!-- From https://bugzilla.mozilla.org/show_bug.cgi?id=395155 -->\\n+\\n+<style id=\\\"s\\\" type=\\\"text/css\\\">\\n+tspan { fill: red; }\\n+</style>\\n+\\n+<script>\\n+function m()\\n+{\\n+  var s = document.getElementById(\\\"s\\\");\\n+  s.appendChild(document.createTextNode(\\\"tspan { fill: green }\\\"));\\n+  s.appendChild(document.createTextNode(\\\"tspan { fill: red }\\\"));\\n+  s.removeChild(s.lastChild);\\n+}\\n+</script>\\n+\\n+<text>\\n+  <tspan x=\\\"10\\\" y=\\\"50\\\">\\n+    This should be green\\n+  </tspan>\\n+</text>\\n+\\n+</svg>\\n\""}