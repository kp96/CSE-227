{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas05dc3cb\""},"diff":"\"05dc3cb Bug 394510. Don't leak the hyphen textrun when we display a soft hyphen. r=smontagu\\ndiff --git a/layout/generic/nsTextFrameThebes.cpp b/layout/generic/nsTextFrameThebes.cpp\\nindex a366c95..d553861 100644\\n--- a/layout/generic/nsTextFrameThebes.cpp\\n+++ b/layout/generic/nsTextFrameThebes.cpp\\n@@ -1472,6 +1472,10 @@ GetFontGroupForFrame(nsIFrame* aFrame)\\n   return fm->GetThebesFontGroup();\\n }\\n \\n+/**\\n+ * The returned textrun must be released via gfxTextRunCache::ReleaseTextRun\\n+ * or gfxTextRunCache::AutoTextRun.\\n+ */\\n static gfxTextRun*\\n GetHyphenTextRun(gfxTextRun* aTextRun, nsIRenderingContext* aRefContext)\\n {\\n@@ -2524,9 +2528,9 @@ PropertyProvider::GetHyphenWidth()\\n {\\n   if (mHyphenWidth < 0) {\\n     nsCOMPtr<nsIRenderingContext> rc = GetReferenceRenderingContext(mFrame, nsnull);\\n-    gfxTextRun* hyphenTextRun = GetHyphenTextRun(mTextRun, rc);\\n+    gfxTextRunCache::AutoTextRun hyphenTextRun(GetHyphenTextRun(mTextRun, rc));\\n     mHyphenWidth = mLetterSpacing;\\n-    if (hyphenTextRun) {\\n+    if (hyphenTextRun.get()) {\\n       mHyphenWidth += hyphenTextRun->GetAdvanceWidth(0, hyphenTextRun->GetLength(), nsnull);\\n     }\\n   }\\n@@ -2635,8 +2639,8 @@ PropertyProvider::SetupJustificationSpacing()\\n                               GetSkippedDistance(mStart, realEnd), this);\\n   if (mFrame->GetStateBits() & TEXT_HYPHEN_BREAK) {\\n     nsCOMPtr<nsIRenderingContext> rc = GetReferenceRenderingContext(mFrame, nsnull);\\n-    gfxTextRun* hyphenTextRun = GetHyphenTextRun(mTextRun, rc);\\n-    if (hyphenTextRun) {\\n+    gfxTextRunCache::AutoTextRun hyphenTextRun(GetHyphenTextRun(mTextRun, rc));\\n+    if (hyphenTextRun.get()) {\\n       naturalWidth +=\\n         hyphenTextRun->GetAdvanceWidth(0, hyphenTextRun->GetLength(), nsnull);\\n     }\\n@@ -4127,8 +4131,8 @@ nsTextFrame::PaintTextWithSelectionColors(gfxContext* aCtx,\\n       // Get a reference rendering context because aCtx might not have the\\n       // reference matrix currently set\\n       nsCOMPtr<nsIRenderingContext> rc = GetReferenceRenderingContext(this, nsnull);\\n-      gfxTextRun* hyphenTextRun = GetHyphenTextRun(mTextRun, rc);\\n-      if (hyphenTextRun) {\\n+      gfxTextRunCache::AutoTextRun hyphenTextRun(GetHyphenTextRun(mTextRun, rc));\\n+      if (hyphenTextRun.get()) {\\n         hyphenTextRun->Draw(aCtx, gfxPoint(hyphenBaselineX, aTextBaselinePt.y),\\n                             0, hyphenTextRun->GetLength(), &aDirtyRect, nsnull, nsnull);\\n       }\\n@@ -4295,8 +4299,8 @@ nsTextFrame::PaintText(nsIRenderingContext* aRenderingContext, nsPoint aPt,\\n   if (GetStateBits() & TEXT_HYPHEN_BREAK) {\\n     gfxFloat hyphenBaselineX = textBaselinePt.x + mTextRun->GetDirection()*advanceWidth;\\n     nsCOMPtr<nsIRenderingContext> rc = GetReferenceRenderingContext(this, nsnull);\\n-    gfxTextRun* hyphenTextRun = GetHyphenTextRun(mTextRun, rc);\\n-    if (hyphenTextRun) {\\n+    gfxTextRunCache::AutoTextRun hyphenTextRun(GetHyphenTextRun(mTextRun, rc));\\n+    if (hyphenTextRun.get()) {\\n       hyphenTextRun->Draw(ctx, gfxPoint(hyphenBaselineX, textBaselinePt.y),\\n                           0, hyphenTextRun->GetLength(), &dirtyRect, nsnull, nsnull);\\n     }\\n@@ -5481,9 +5485,9 @@ nsTextFrame::Reflow(nsPresContext*           aPresContext,\\n   }\\n   if (usedHyphenation) {\\n     // Fix up metrics to include hyphen\\n-    gfxTextRun* hyphenTextRun = GetHyphenTextRun(mTextRun, aReflowState.rendContext);\\n-    if (hyphenTextRun) {\\n-      AddCharToMetrics(hyphenTextRun,\\n+    gfxTextRunCache::AutoTextRun hyphenTextRun(GetHyphenTextRun(mTextRun, aReflowState.rendContext));\\n+    if (hyphenTextRun.get()) {\\n+      AddCharToMetrics(hyphenTextRun.get(),\\n                        mTextRun, &textMetrics, needTightBoundingBox);\\n     }\\n     AddStateBits(TEXT_HYPHEN_BREAK);\\n\""}