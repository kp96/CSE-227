{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basf1194c9\""},"diff":"\"f1194c9 Bug 397386. Large leak on grono.net front page. r/sr=peterv, a=dsicore\\ndiff --git a/content/xslt/src/xpath/nsXPathResult.cpp b/content/xslt/src/xpath/nsXPathResult.cpp\\nindex e670883..07c59eb 100644\\n--- a/content/xslt/src/xpath/nsXPathResult.cpp\\n+++ b/content/xslt/src/xpath/nsXPathResult.cpp\\n@@ -47,6 +47,7 @@\\n #include \\\"nsIDOMDocument.h\\\"\\n #include \\\"nsDOMString.h\\\"\\n #include \\\"txXPathTreeWalker.h\\\"\\n+#include \\\"nsCycleCollectionParticipant.h\\\"\\n \\n nsXPathResult::nsXPathResult() : mDocument(nsnull),\\n                                  mCurrentPos(0),\\n@@ -57,21 +58,52 @@ nsXPathResult::nsXPathResult() : mDocument(nsnull),\\n \\n nsXPathResult::~nsXPathResult()\\n {\\n+    RemoveObserver();\\n+}\\n+\\n+NS_IMPL_CYCLE_COLLECTION_CLASS(nsXPathResult)\\n+NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(nsXPathResult)\\n+    {\\n+        tmp->RemoveObserver();\\n+    }\\n+    NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mDocument)\\n+NS_IMPL_CYCLE_COLLECTION_UNLINK_END\\n+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN(nsXPathResult)\\n+    NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mDocument)\\n+    {\\n+        txAExprResult *result = tmp->mResult.get();\\n+        if (result && result->getResultType() == txAExprResult::NODESET) {\\n+            txNodeSet *nodeSet = static_cast<txNodeSet*>(result);\\n+            nsCOMPtr<nsIDOMNode> node;\\n+            PRInt32 count = nodeSet->size();\\n+            PRInt32 i;\\n+            for (i = 0; i < count; ++i) {\\n+                txXPathNativeNode::getNode(nodeSet->get(i),\\n+                                           getter_AddRefs(node));\\n+                cb.NoteXPCOMChild(node);\\n+            }\\n+        }\\n+    }\\n+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END\\n+\\n+NS_IMPL_CYCLE_COLLECTING_ADDREF_AMBIGUOUS(nsXPathResult, nsIDOMXPathResult)\\n+NS_IMPL_CYCLE_COLLECTING_RELEASE_AMBIGUOUS(nsXPathResult, nsIDOMXPathResult)\\n+NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(nsXPathResult)\\n+    NS_INTERFACE_MAP_ENTRY(nsIDOMXPathResult)\\n+    NS_INTERFACE_MAP_ENTRY(nsIMutationObserver)\\n+    NS_INTERFACE_MAP_ENTRY(nsIXPathResult)\\n+    NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIDOMXPathResult)\\n+    NS_INTERFACE_MAP_ENTRY_CONTENT_CLASSINFO(XPathResult)\\n+NS_INTERFACE_MAP_END\\n+\\n+void\\n+nsXPathResult::RemoveObserver()\\n+{\\n     if (mDocument) {\\n         mDocument->RemoveMutationObserver(this);\\n     }\\n }\\n \\n-NS_IMPL_ADDREF(nsXPathResult)\\n-NS_IMPL_RELEASE(nsXPathResult)\\n-NS_INTERFACE_MAP_BEGIN(nsXPathResult)\\n-  NS_INTERFACE_MAP_ENTRY(nsIDOMXPathResult)\\n-  NS_INTERFACE_MAP_ENTRY(nsIMutationObserver)\\n-  NS_INTERFACE_MAP_ENTRY(nsIXPathResult)\\n-  NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIDOMXPathResult)\\n-  NS_INTERFACE_MAP_ENTRY_CONTENT_CLASSINFO(XPathResult)\\n-NS_INTERFACE_MAP_END\\n-\\n NS_IMETHODIMP\\n nsXPathResult::GetResultType(PRUint16 *aResultType)\\n {\\ndiff --git a/content/xslt/src/xpath/nsXPathResult.h b/content/xslt/src/xpath/nsXPathResult.h\\nindex 887ef21..8820bfd 100644\\n--- a/content/xslt/src/xpath/nsXPathResult.h\\n+++ b/content/xslt/src/xpath/nsXPathResult.h\\n@@ -46,6 +46,7 @@\\n #include \\\"nsCOMPtr.h\\\"\\n #include \\\"nsCOMArray.h\\\"\\n #include \\\"nsWeakPtr.h\\\"\\n+#include \\\"nsCycleCollectionParticipant.h\\\"\\n \\n // {662f2c9a-c7cd-4cab-9349-e733df5a838c}\\n #define NS_IXPATHRESULT_IID \\\\\\n@@ -100,7 +101,8 @@ public:\\n     ~nsXPathResult();\\n \\n     // nsISupports interface\\n-    NS_DECL_ISUPPORTS\\n+    NS_DECL_CYCLE_COLLECTING_ISUPPORTS\\n+    NS_DECL_CYCLE_COLLECTION_CLASS_AMBIGUOUS(nsXPathResult, nsIDOMXPathResult)\\n \\n     // nsIDOMXPathResult interface\\n     NS_DECL_NSIDOMXPATHRESULT\\n@@ -118,7 +120,7 @@ public:\\n                            nsINode* aContextNode);\\n     nsresult GetExprResult(txAExprResult **aExprResult);\\n     nsresult Clone(nsIXPathResult **aResult);\\n-\\n+    void RemoveObserver();\\n private:\\n     PRBool isSnapshot() const\\n     {\\n\""}