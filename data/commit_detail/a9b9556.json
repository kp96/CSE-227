{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basa9b9556\""},"diff":"\"a9b9556 Unit testing for Bug 394300. r=robstrong\\ndiff --git a/toolkit/mozapps/extensions/test/unit/addons/test_bug394300_1/install.rdf b/toolkit/mozapps/extensions/test/unit/addons/test_bug394300_1/install.rdf\\nnew file mode 100644\\nindex 0000000..2e5ace7\\n--- /dev/null\\n+++ b/toolkit/mozapps/extensions/test/unit/addons/test_bug394300_1/install.rdf\\n@@ -0,0 +1,22 @@\\n+<?xml version=\\\"1.0\\\"?>\\n+\\n+<RDF xmlns=\\\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\\\"\\n+     xmlns:em=\\\"http://www.mozilla.org/2004/em-rdf#\\\">\\n+\\n+  <Description about=\\\"urn:mozilla:install-manifest\\\">\\n+    <em:id>bug394300_1@tests.mozilla.org</em:id>\\n+    <em:version>5</em:version>\\n+    \\n+    <em:targetApplication>\\n+      <Description>\\n+        <em:id>xpcshell@tests.mozilla.org</em:id>\\n+        <em:minVersion>1</em:minVersion>\\n+        <em:maxVersion>1</em:maxVersion>\\n+      </Description>\\n+    </em:targetApplication>\\n+    \\n+    <em:name>Bug 394300 Test 1</em:name>\\n+    <em:updateURL>http://localhost:4444/test_bug394300.rdf</em:updateURL>\\n+    \\n+  </Description>      \\n+</RDF>\\ndiff --git a/toolkit/mozapps/extensions/test/unit/addons/test_bug394300_2/install.rdf b/toolkit/mozapps/extensions/test/unit/addons/test_bug394300_2/install.rdf\\nnew file mode 100644\\nindex 0000000..ae54424\\n--- /dev/null\\n+++ b/toolkit/mozapps/extensions/test/unit/addons/test_bug394300_2/install.rdf\\n@@ -0,0 +1,22 @@\\n+<?xml version=\\\"1.0\\\"?>\\n+\\n+<RDF xmlns=\\\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\\\"\\n+     xmlns:em=\\\"http://www.mozilla.org/2004/em-rdf#\\\">\\n+\\n+  <Description about=\\\"urn:mozilla:install-manifest\\\">\\n+    <em:id>bug394300_2@tests.mozilla.org</em:id>\\n+    <em:version>5</em:version>\\n+    \\n+    <em:targetApplication>\\n+      <Description>\\n+        <em:id>toolkit@mozilla.org</em:id>\\n+        <em:minVersion>1.9</em:minVersion>\\n+        <em:maxVersion>1.9</em:maxVersion>\\n+      </Description>\\n+    </em:targetApplication>\\n+    \\n+    <em:name>Bug 394300 Test 2</em:name>\\n+    <em:updateURL>http://localhost:4444/test_bug394300.rdf</em:updateURL>\\n+    \\n+  </Description>      \\n+</RDF>\\ndiff --git a/toolkit/mozapps/extensions/test/unit/data/test_bug394300.rdf b/toolkit/mozapps/extensions/test/unit/data/test_bug394300.rdf\\nnew file mode 100644\\nindex 0000000..bbe216e\\n--- /dev/null\\n+++ b/toolkit/mozapps/extensions/test/unit/data/test_bug394300.rdf\\n@@ -0,0 +1,158 @@\\n+<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n+\\n+<RDF:RDF xmlns:RDF=\\\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\\\"\\n+         xmlns:em=\\\"http://www.mozilla.org/2004/em-rdf#\\\">\\n+\\n+  <RDF:Description about=\\\"urn:mozilla:extension:bug394300_1@tests.mozilla.org\\\">\\n+    <em:updates>\\n+      <RDF:Seq>\\n+        <!-- Not a valid install - incompatible app versions -->\\n+        <RDF:li>\\n+          <RDF:Description>\\n+            <em:version>20</em:version>\\n+            <em:targetApplication>\\n+              <RDF:Description>\\n+                <em:id>xpcshell@tests.mozilla.org</em:id>\\n+                <em:minVersion>2</em:minVersion>\\n+                <em:maxVersion>2</em:maxVersion>\\n+                <em:updateLink>http://localhost:4444/broken.xpi</em:updateLink>\\n+              </RDF:Description>\\n+            </em:targetApplication>\\n+          </RDF:Description>\\n+        </RDF:li>\\n+        <!-- Valid install should be the version detected -->\\n+        <RDF:li>\\n+          <RDF:Description>\\n+            <em:version>10</em:version>\\n+            <em:targetApplication>\\n+              <RDF:Description>\\n+                <em:id>xpcshell@tests.mozilla.org</em:id>\\n+                <em:minVersion>1</em:minVersion>\\n+                <em:maxVersion>1</em:maxVersion>\\n+                <em:updateLink>http://localhost:4444/broken.xpi</em:updateLink>\\n+              </RDF:Description>\\n+            </em:targetApplication>\\n+          </RDF:Description>\\n+        </RDF:li>\\n+        <!-- Valid install. Detecting this would indicate that the order\\n+             of entries is playing a part in the update detection. -->\\n+        <RDF:li>\\n+          <RDF:Description>\\n+            <em:version>6</em:version>\\n+            <em:targetApplication>\\n+              <RDF:Description>\\n+                <em:id>xpcshell@tests.mozilla.org</em:id>\\n+                <em:minVersion>1</em:minVersion>\\n+                <em:maxVersion>1</em:maxVersion>\\n+                <em:updateLink>http://localhost:4444/broken.xpi</em:updateLink>\\n+              </RDF:Description>\\n+            </em:targetApplication>\\n+          </RDF:Description>\\n+        </RDF:li>\\n+        <!-- Not a valid install - no minVersion or maxVersion specified -->\\n+        <RDF:li>\\n+          <RDF:Description>\\n+            <em:version>40</em:version>\\n+            <em:targetApplication>\\n+              <RDF:Description>\\n+                <em:id>xpcshell@tests.mozilla.org</em:id>\\n+                <em:updateLink>http://localhost:4444/broken.xpi</em:updateLink>\\n+              </RDF:Description>\\n+            </em:targetApplication>\\n+          </RDF:Description>\\n+        </RDF:li>\\n+        <!-- Not a valid install - incompatible app versions -->\\n+        <RDF:li>\\n+          <RDF:Description>\\n+            <em:version>30</em:version>\\n+            <em:targetApplication>\\n+              <RDF:Description>\\n+                <em:id>xpcshell@tests.mozilla.org</em:id>\\n+                <em:minVersion>2</em:minVersion>\\n+                <em:maxVersion>2</em:maxVersion>\\n+                <em:updateLink>http://localhost:4444/broken.xpi</em:updateLink>\\n+              </RDF:Description>\\n+            </em:targetApplication>\\n+          </RDF:Description>\\n+        </RDF:li>\\n+      </RDF:Seq>\\n+    </em:updates>\\n+  </RDF:Description>\\n+\\n+  <RDF:Description about=\\\"urn:mozilla:extension:bug394300_2@tests.mozilla.org\\\">\\n+    <em:updates>\\n+      <RDF:Seq>\\n+        <!-- Not a valid install - incompatible app versions -->\\n+        <RDF:li>\\n+          <RDF:Description>\\n+            <em:version>20</em:version>\\n+            <em:targetApplication>\\n+              <RDF:Description>\\n+                <em:id>toolkit@mozilla.org</em:id>\\n+                <em:minVersion>2</em:minVersion>\\n+                <em:maxVersion>2</em:maxVersion>\\n+                <em:updateLink>http://localhost:4444/broken.xpi</em:updateLink>\\n+              </RDF:Description>\\n+            </em:targetApplication>\\n+          </RDF:Description>\\n+        </RDF:li>\\n+        <!-- Valid install should be the version detected -->\\n+        <RDF:li>\\n+          <RDF:Description>\\n+            <em:version>10</em:version>\\n+            <em:targetApplication>\\n+              <RDF:Description>\\n+                <em:id>toolkit@mozilla.org</em:id>\\n+                <em:minVersion>1.9</em:minVersion>\\n+                <em:maxVersion>1.9</em:maxVersion>\\n+                <em:updateLink>http://localhost:4444/broken.xpi</em:updateLink>\\n+              </RDF:Description>\\n+            </em:targetApplication>\\n+          </RDF:Description>\\n+        </RDF:li>\\n+        <!-- Valid install. Detecting this would indicate that the order\\n+             of entries is playing a part in the update detection. -->\\n+        <RDF:li>\\n+          <RDF:Description>\\n+            <em:version>6</em:version>\\n+            <em:targetApplication>\\n+              <RDF:Description>\\n+                <em:id>toolkit@mozilla.org</em:id>\\n+                <em:minVersion>1.9</em:minVersion>\\n+                <em:maxVersion>1.9</em:maxVersion>\\n+                <em:updateLink>http://localhost:4444/broken.xpi</em:updateLink>\\n+              </RDF:Description>\\n+            </em:targetApplication>\\n+          </RDF:Description>\\n+        </RDF:li>\\n+        <!-- Not a valid install - no minVersion or maxVersion specified -->\\n+        <RDF:li>\\n+          <RDF:Description>\\n+            <em:version>40</em:version>\\n+            <em:targetApplication>\\n+              <RDF:Description>\\n+                <em:id>toolkit@mozilla.org</em:id>\\n+                <em:updateLink>http://localhost:4444/broken.xpi</em:updateLink>\\n+              </RDF:Description>\\n+            </em:targetApplication>\\n+          </RDF:Description>\\n+        </RDF:li>\\n+        <!-- Not a valid install - incompatible app versions -->\\n+        <RDF:li>\\n+          <RDF:Description>\\n+            <em:version>30</em:version>\\n+            <em:targetApplication>\\n+              <RDF:Description>\\n+                <em:id>toolkit@mozilla.org</em:id>\\n+                <em:minVersion>2</em:minVersion>\\n+                <em:maxVersion>2</em:maxVersion>\\n+                <em:updateLink>http://localhost:4444/broken.xpi</em:updateLink>\\n+              </RDF:Description>\\n+            </em:targetApplication>\\n+          </RDF:Description>\\n+        </RDF:li>\\n+      </RDF:Seq>\\n+    </em:updates>\\n+  </RDF:Description>\\n+\\n+</RDF:RDF>\\ndiff --git a/toolkit/mozapps/extensions/test/unit/test_bug394300.js b/toolkit/mozapps/extensions/test/unit/test_bug394300.js\\nnew file mode 100644\\nindex 0000000..d3c1f80\\n--- /dev/null\\n+++ b/toolkit/mozapps/extensions/test/unit/test_bug394300.js\\n@@ -0,0 +1,101 @@\\n+/* ***** BEGIN LICENSE BLOCK *****\\n+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1\\n+ *\\n+ * The contents of this file are subject to the Mozilla Public License Version\\n+ * 1.1 (the \\\"License\\\"); you may not use this file except in compliance with\\n+ * the License. You may obtain a copy of the License at\\n+ * http://www.mozilla.org/MPL/\\n+ *\\n+ * Software distributed under the License is distributed on an \\\"AS IS\\\" basis,\\n+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\\n+ * for the specific language governing rights and limitations under the\\n+ * License.\\n+ *\\n+ * The Original Code is mozilla.org code.\\n+ *\\n+ * The Initial Developer of the Original Code is\\n+ *      Dave Townsend <dtownsend@oxymoronical.com>.\\n+ *\\n+ * Portions created by the Initial Developer are Copyright (C) 2007\\n+ * the Initial Developer. All Rights Reserved.\\n+ *\\n+ * Contributor(s):\\n+ *\\n+ * Alternatively, the contents of this file may be used under the terms of\\n+ * either the GNU General Public License Version 2 or later (the \\\"GPL\\\"), or\\n+ * the GNU Lesser General Public License Version 2.1 or later (the \\\"LGPL\\\"),\\n+ * in which case the provisions of the GPL or the LGPL are applicable instead\\n+ * of those above. If you wish to allow use of your version of this file only\\n+ * under the terms of either the GPL or the LGPL, and not to allow others to\\n+ * use your version of this file under the terms of the MPL, indicate your\\n+ * decision by deleting the provisions above and replace them with the notice\\n+ * and other provisions required by the GPL or the LGPL. If you do not delete\\n+ * the provisions above, a recipient may use your version of this file under\\n+ * the terms of any one of the MPL, the GPL or the LGPL.\\n+ *\\n+ * ***** END LICENSE BLOCK *****\\n+ */\\n+\\n+// Disables security checking our updates which haven't been signed\\n+gPrefs.setBoolPref(\\\"extensions.checkUpdateSecurity\\\", false);\\n+\\n+do_import_script(\\\"netwerk/test/httpserver/httpd.js\\\");\\n+var server;\\n+\\n+// nsIAddonUpdateCheckListener implementation\\n+var updateListener = {\\n+  _count: 0,\\n+  \\n+  onUpdateStarted: function onUpdateStarted()\\n+  {\\n+  },\\n+\\n+  onUpdateEnded: function onUpdateEnded()\\n+  {\\n+    server.stop();\\n+    do_test_finished();\\n+    do_check_eq(this._count, 2);\\n+  },\\n+\\n+  onAddonUpdateStarted: function onAddonUpdateStarted(aAddon)\\n+  {\\n+  },\\n+\\n+  onAddonUpdateEnded: function onAddonUpdateEnded(aAddon, aStatus)\\n+  {\\n+    this._count++;\\n+    do_check_eq(aStatus, Components.interfaces.nsIAddonUpdateCheckListener.STATUS_UPDATE);\\n+    do_check_eq(aAddon.version, 10);\\n+  }\\n+}\\n+\\n+function run_test()\\n+{\\n+  // Setup for test\\n+  createAppInfo(\\\"xpcshell@tests.mozilla.org\\\", \\\"XPCShell\\\", \\\"1\\\", \\\"1.9\\\");\\n+  \\n+  startupEM();\\n+  \\n+  gEM.installItemFromFile(do_get_addon(\\\"test_bug394300_1\\\"),  NS_INSTALL_LOCATION_APPPROFILE);\\n+  gEM.installItemFromFile(do_get_addon(\\\"test_bug394300_2\\\"),  NS_INSTALL_LOCATION_APPPROFILE);\\n+  \\n+  restartEM();\\n+  \\n+  var updates = [\\n+    gEM.getItemForID(\\\"bug394300_1@tests.mozilla.org\\\"),\\n+    gEM.getItemForID(\\\"bug394300_2@tests.mozilla.org\\\")\\n+  ];\\n+  \\n+  do_check_neq(updates[0], null);\\n+  do_check_neq(updates[1], null);\\n+  \\n+  server = new nsHttpServer();\\n+  server.registerDirectory(\\\"/\\\", do_get_file(\\\"toolkit/mozapps/extensions/test/unit/data\\\"));\\n+  server.start(4444);\\n+  \\n+  do_test_pending();\\n+  \\n+  gEM.update(updates, updates.length,\\n+             Components.interfaces.nsIExtensionManager.UPDATE_CHECK_NEWVERSION,\\n+             updateListener);\\n+}\\n\""}