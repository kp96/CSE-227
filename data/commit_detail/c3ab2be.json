{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basc3ab2be\""},"diff":"\"c3ab2be fix for bug #397527:  append folder and all ancestors to the include / exclude folder array in nsNavHistory::FilterResultSet(), to save repeated queries r=dietrich, a=mconnor\\ndiff --git a/toolkit/components/places/src/nsNavHistory.cpp b/toolkit/components/places/src/nsNavHistory.cpp\\nindex df8b219..f4cf4c6 100644\\n--- a/toolkit/components/places/src/nsNavHistory.cpp\\n+++ b/toolkit/components/places/src/nsNavHistory.cpp\\n@@ -4199,22 +4199,28 @@ nsNavHistory::FilterResultSet(nsNavHistoryQueryResultNode* aQueryNode,\\n           // check ancestors\\n           PRInt64 ancestor = parentId, lastAncestor;\\n           PRBool belongs = PR_FALSE;\\n+          nsTArray<PRInt64> ancestorFolders;\\n \\n           while (!belongs) {\\n             // Avoid using |ancestor| itself if GetFolderIdForItem failed.\\n             lastAncestor = ancestor;\\n+            ancestorFolders.AppendElement(ancestor);\\n \\n             // GetFolderIdForItems throws when called for the places-root\\n             if (NS_FAILED(bookmarks->GetFolderIdForItem(ancestor,&ancestor))) {\\n               break;\\n+            } else if (excludeFolders[queryIndex]->IndexOf(ancestor) != -1) {\\n+              break;\\n             } else if (includeFolders[queryIndex]->IndexOf(ancestor) != -1) {\\n               belongs = PR_TRUE;\\n             }\\n           }\\n+          // if the parentId or any of its ancestors \\\"belong\\\",\\n+          // include all of them.  otherwise, exclude all of them.\\n           if (belongs) {\\n-            includeFolders[queryIndex]->AppendElement(lastAncestor);\\n+            includeFolders[queryIndex]->AppendElements(ancestorFolders);\\n           } else {\\n-            excludeFolders[queryIndex]->AppendElement(lastAncestor);\\n+            excludeFolders[queryIndex]->AppendElements(ancestorFolders);\\n             continue;\\n           }\\n         }\\n\""}