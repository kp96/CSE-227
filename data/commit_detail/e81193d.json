{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Base81193d\""},"diff":"\"e81193d Bug 381074 - Add overflow check for unit conversion in NSFloatPixelsToAppUnits. r=bz sr=roc blocking1.9=dbaron\\ndiff --git a/xpcom/ds/nsUnitConversion.h b/xpcom/ds/nsUnitConversion.h\\nindex 7516759..c468424 100644\\n--- a/xpcom/ds/nsUnitConversion.h\\n+++ b/xpcom/ds/nsUnitConversion.h\\n@@ -88,9 +88,27 @@ inline PRInt32 NSToIntRound(float aValue)\\n  */\\n inline nscoord NSFloatPixelsToAppUnits(float aPixels, PRInt32 aAppUnitsPerPixel)\\n {\\n-  nscoord r = NSToCoordRound(aPixels * aAppUnitsPerPixel);\\n-  VERIFY_COORD(r);\\n-  return r;\\n+  float product = aPixels * aAppUnitsPerPixel;\\n+  nscoord result;\\n+\\n+#ifdef NS_COORD_IS_FLOAT\\n+  // No need to bounds-check if converting float to float\\n+  result = NSToCoordRound(product);\\n+#else\\n+  // Bounds-check before converting out of float, to avoid overflow\\n+  if (product >= nscoord_MAX) {\\n+    NS_WARNING(\\\"Overflowed nscoord_MAX in conversion to nscoord\\\");\\n+    result = nscoord_MAX;\\n+  } else if (product <= nscoord_MIN) {\\n+    NS_WARNING(\\\"Overflowed nscoord_MIN in conversion to nscoord\\\");\\n+    result = nscoord_MIN;\\n+  } else {\\n+    result = NSToCoordRound(product);\\n+  }\\n+#endif\\n+\\n+  VERIFY_COORD(result);\\n+  return result;\\n }\\n \\n inline nscoord NSIntPixelsToAppUnits(PRInt32 aPixels, PRInt32 aAppUnitsPerPixel)\\n\""}