{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas4414a6a\""},"diff":"\"4414a6a Bug 397804. pages loading feeds as content can trigger a leak. r=jst, sr=sicking, a=sicking\\ndiff --git a/parser/htmlparser/src/nsParser.cpp b/parser/htmlparser/src/nsParser.cpp\\nindex 7cb84d4..cab3d05 100644\\n--- a/parser/htmlparser/src/nsParser.cpp\\n+++ b/parser/htmlparser/src/nsParser.cpp\\n@@ -289,10 +289,26 @@ nsParser::~nsParser()\\n   NS_ASSERTION(!(mFlags & NS_PARSER_FLAG_PENDING_CONTINUE_EVENT), \\\"bad\\\");\\n }\\n \\n-NS_IMPL_ISUPPORTS3(nsParser,\\n-                   nsIRequestObserver,\\n-                   nsIParser,\\n-                   nsIStreamListener)\\n+NS_IMPL_CYCLE_COLLECTION_CLASS(nsParser)\\n+\\n+NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(nsParser)\\n+ NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mSink)\\n+ NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mObserver)\\n+NS_IMPL_CYCLE_COLLECTION_UNLINK_END\\n+\\n+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN(nsParser)\\n+ NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mSink)\\n+ NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mObserver)\\n+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END\\n+\\n+NS_IMPL_CYCLE_COLLECTING_ADDREF_AMBIGUOUS(nsParser, nsIParser)\\n+NS_IMPL_CYCLE_COLLECTING_RELEASE_AMBIGUOUS(nsParser, nsIParser)\\n+NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(nsParser)\\n+ NS_INTERFACE_MAP_ENTRY(nsIStreamListener)\\n+ NS_INTERFACE_MAP_ENTRY(nsIParser)\\n+ NS_INTERFACE_MAP_ENTRY(nsIRequestObserver)\\n+ NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIParser)\\n+NS_INTERFACE_MAP_END\\n \\n // The parser continue event is posted only if\\n // all of the data to parse has been passed to ::OnDataAvailable\\ndiff --git a/parser/htmlparser/src/nsParser.h b/parser/htmlparser/src/nsParser.h\\nindex bfd2300..ef3497f 100644\\n--- a/parser/htmlparser/src/nsParser.h\\n+++ b/parser/htmlparser/src/nsParser.h\\n@@ -88,6 +88,7 @@\\n #include \\\"nsIParserFilter.h\\\"\\n #include \\\"nsCOMArray.h\\\"\\n #include \\\"nsIUnicharStreamListener.h\\\"\\n+#include \\\"nsCycleCollectionParticipant.h\\\"\\n \\n class nsIDTD;\\n class nsScanner;\\n@@ -114,8 +115,8 @@ class nsParser : public nsIParser,\\n      */\\n     static void Shutdown();\\n \\n-    NS_DECL_ISUPPORTS\\n-\\n+    NS_DECL_CYCLE_COLLECTING_ISUPPORTS\\n+    NS_DECL_CYCLE_COLLECTION_CLASS_AMBIGUOUS(nsParser, nsIParser)\\n \\n     /**\\n      * default constructor\\ndiff --git a/parser/xml/src/nsSAXXMLReader.cpp b/parser/xml/src/nsSAXXMLReader.cpp\\nindex b40452d..0835e78 100644\\n--- a/parser/xml/src/nsSAXXMLReader.cpp\\n+++ b/parser/xml/src/nsSAXXMLReader.cpp\\n@@ -52,10 +52,36 @@\\n \\n static NS_DEFINE_CID(kParserCID, NS_PARSER_CID);\\n \\n-NS_IMPL_ISUPPORTS6(nsSAXXMLReader, nsISAXXMLReader,\\n-                   nsIExpatSink, nsIExtendedExpatSink,\\n-                   nsIContentSink,  nsIRequestObserver,\\n-                   nsIStreamListener)\\n+NS_IMPL_CYCLE_COLLECTION_CLASS(nsSAXXMLReader)\\n+NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(nsSAXXMLReader)\\n+  NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mContentHandler)\\n+  NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mDTDHandler)\\n+  NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mErrorHandler)\\n+  NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mLexicalHandler)\\n+  NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mBaseURI)\\n+  NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mListener)\\n+  NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mParserObserver)\\n+NS_IMPL_CYCLE_COLLECTION_UNLINK_END\\n+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN(nsSAXXMLReader)\\n+  NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mContentHandler)\\n+  NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mDTDHandler)\\n+  NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mErrorHandler)\\n+  NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mLexicalHandler)\\n+  NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mBaseURI)\\n+  NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mListener)\\n+  NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mParserObserver)\\n+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END\\n+NS_IMPL_CYCLE_COLLECTING_ADDREF_AMBIGUOUS(nsSAXXMLReader, nsISAXXMLReader)\\n+NS_IMPL_CYCLE_COLLECTING_RELEASE_AMBIGUOUS(nsSAXXMLReader, nsISAXXMLReader)\\n+NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(nsSAXXMLReader)\\n+  NS_INTERFACE_MAP_ENTRY(nsISAXXMLReader)\\n+  NS_INTERFACE_MAP_ENTRY(nsIExpatSink)\\n+  NS_INTERFACE_MAP_ENTRY(nsIExtendedExpatSink)\\n+  NS_INTERFACE_MAP_ENTRY(nsIContentSink)\\n+  NS_INTERFACE_MAP_ENTRY(nsIRequestObserver)\\n+  NS_INTERFACE_MAP_ENTRY(nsIStreamListener)\\n+  NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsISAXXMLReader)\\n+NS_INTERFACE_MAP_END\\n \\n nsSAXXMLReader::nsSAXXMLReader() : mIsAsyncParse(PR_FALSE)\\n {\\ndiff --git a/parser/xml/src/nsSAXXMLReader.h b/parser/xml/src/nsSAXXMLReader.h\\nindex b0682ab..c42edc8 100644\\n--- a/parser/xml/src/nsSAXXMLReader.h\\n+++ b/parser/xml/src/nsSAXXMLReader.h\\n@@ -48,6 +48,7 @@\\n #include \\\"nsISAXDTDHandler.h\\\"\\n #include \\\"nsISAXErrorHandler.h\\\"\\n #include \\\"nsISAXLexicalHandler.h\\\"\\n+#include \\\"nsCycleCollectionParticipant.h\\\"\\n \\n #define NS_SAXXMLREADER_CONTRACTID \\\"@mozilla.org/saxparser/xmlreader;1\\\"\\n #define NS_SAXXMLREADER_CLASSNAME \\\"SAX XML Reader\\\"\\n@@ -60,7 +61,8 @@ class nsSAXXMLReader : public nsISAXXMLReader,\\n                        public nsIContentSink\\n {\\n public:\\n-  NS_DECL_ISUPPORTS\\n+  NS_DECL_CYCLE_COLLECTING_ISUPPORTS\\n+  NS_DECL_CYCLE_COLLECTION_CLASS_AMBIGUOUS(nsSAXXMLReader, nsISAXXMLReader)\\n   NS_DECL_NSIEXPATSINK\\n   NS_DECL_NSIEXTENDEDEXPATSINK\\n   NS_DECL_NSISAXXMLREADER\\ndiff --git a/toolkit/components/feeds/src/FeedProcessor.js b/toolkit/components/feeds/src/FeedProcessor.js\\nindex f9858a6..36a6a87 100644\\n--- a/toolkit/components/feeds/src/FeedProcessor.js\\n+++ b/toolkit/components/feeds/src/FeedProcessor.js\\n@@ -1074,6 +1074,7 @@ function FeedProcessor() {\\n   this._result = null;\\n   this._extensionHandler = null;\\n   this._xhtmlHandler = null;\\n+  this._haveSentResult = false;\\n   \\n   // http://www.w3.org/WAI/PF/GUI/ uses QNames in content :(\\n   this._waiPrefixes = {};\\n@@ -1262,6 +1263,7 @@ FeedProcessor.prototype = {\\n   // When we're done with the feed, let the listener know what\\n   // happened.\\n   _sendResult: function FP_sendResult() {\\n+    this._haveSentResult = true;\\n     try {\\n       // Can be null when a non-feed is fed to us\\n       if (this._result.doc)\\n@@ -1331,7 +1333,8 @@ FeedProcessor.prototype = {\\n   fatalError: function FP_reportError() {\\n     this._result.bozo = true;\\n     //XXX need to QI to FeedProgressListener\\n-    this._sendResult();\\n+    if (!this._haveSentResult)\\n+      this._sendResult();\\n   },\\n \\n   // nsISAXContentHandler\\n@@ -1341,7 +1344,8 @@ FeedProcessor.prototype = {\\n   },\\n \\n   endDocument: function FP_endDocument() {\\n-    this._sendResult();\\n+    if (!this._haveSentResult)\\n+      this._sendResult();\\n   },\\n \\n   // The transitions defined above identify elements that contain more\\n\""}