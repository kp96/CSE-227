{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas4a0275d\""},"diff":"\"4a0275d better log viewer performance thanks to chris; small bugfixes in the component; temporarily disable some very verbose logging output\\ndiff --git a/services/sync/nsBookmarksSyncService.js b/services/sync/nsBookmarksSyncService.js\\nindex e5c6cf7..463d366 100644\\n--- a/services/sync/nsBookmarksSyncService.js\\n+++ b/services/sync/nsBookmarksSyncService.js\\n@@ -110,8 +110,7 @@ BookmarksSyncService.prototype = {\\n   // DAVCollection object\\n   _dav: null,\\n \\n-  // Last synced tree\\n-  // FIXME: this should be serialized to disk\\n+  // Last synced tree and version\\n   _snapshot: {},\\n   _snapshotVersion: 0,\\n \\n@@ -263,7 +262,7 @@ BookmarksSyncService.prototype = {\\n   },\\n \\n   _nodeParentsInt: function BSS__nodeParentsInt(guid, tree, parents) {\\n-    if (tree[guid] && tree[guid].parentGuid == null)\\n+    if (!tree[guid] || !tree[guid].parentGuid)\\n       return parents;\\n     parents.push(tree[guid].parentGuid);\\n     return this._nodeParentsInt(tree[guid].parentGuid, tree, parents);\\n@@ -317,7 +316,6 @@ BookmarksSyncService.prototype = {\\n       return true;\\n     if ((a.guid == b.guid) && !this._deepEquals(a, b))\\n       return true;\\n-// FIXME - how else can two commands conflict?\\n     return false;\\n   },\\n \\n@@ -608,13 +606,16 @@ BookmarksSyncService.prototype = {\\n       case \\\"uri\\\":\\n         this._bms.changeBookmarkURI(itemId, makeURI(command.data.uri));\\n         break;\\n-      case \\\"index\\\": // FIXME: what if we do this one before parentGuid ? that'd be wrong\\n+      case \\\"index\\\":\\n         this._bms.moveItem(itemId, this._bms.getFolderIdForItem(itemId),\\n                            command.data.index);\\n         break;\\n       case \\\"parentGuid\\\":\\n+        let index = -1;\\n+        if (command.data.index && command.data.index >= 0)\\n+          index = command.data.index;\\n         this._bms.moveItem(\\n-          itemId, this._bms.getItemIdForGUID(command.data.parentGuid), -1);\\n+          itemId, this._bms.getItemIdForGUID(command.data.parentGuid), index);\\n         break;\\n       default:\\n         this.notice(\\\"Warning: Can't change item property: \\\" + key);\\n@@ -791,9 +792,15 @@ BookmarksSyncService.prototype = {\\n                                                   this._wrapNode(localBookmarks));\\n         this._snapshotVersion = server['version'];\\n         this._applyCommands(clientChanges);\\n-        // FIXME: should wrapNode to a separate variable and make sure\\n-        // that snapshot -> that is an empty diff.\\n-        this._snapshot = this._wrapNode(localBookmarks);\\n+\\n+        let newSnapshot = this._wrapNode(localBookmarks);\\n+        let diff = this._detectUpdates(this._snapshot, newSnapshot);\\n+        if (diff.length != 0) {\\n+          this.notice(\\\"Error: commands did not apply correctly.  Diff:\\\\n\\\" +\\n+                      uneval(diff));\\n+          this._snapshot = this._wrapNode(localBookmarks);\\n+          // FIXME: What else can we do?\\n+        }\\n         this._saveSnapshot();\\n       }\\n \\n@@ -810,7 +817,8 @@ BookmarksSyncService.prototype = {\\n           this.notice(\\\"Successfully updated deltas on server\\\");\\n           this._saveSnapshot();\\n         } else {\\n-          // FIXME: revert snapshot here?\\n+          // FIXME: revert snapshot here? - can't, we already applied\\n+          // updates locally! - need to save and retry\\n           this.notice(\\\"Error: could not update deltas on server\\\");\\n         }\\n       }\\n@@ -857,6 +865,7 @@ BookmarksSyncService.prototype = {\\n       var tmp = eval(uneval(this._snapshot)); // fixme hack hack hack\\n \\n       // FIXME: debug here for conditional below...\\n+      /*\\n       this.notice(\\\"[sync bowels] local version: \\\" + this._snapshotVersion);\\n       for (var z in ret.deltas) {\\n         this.notice(\\\"[sync bowels] remote version: \\\" + z);\\n@@ -866,6 +875,7 @@ BookmarksSyncService.prototype = {\\n         this.notice(\\\"-> is true\\\");\\n       else\\n         this.notice(\\\"-> is false\\\");\\n+      */\\n \\n       if (ret.deltas[this._snapshotVersion + 1]) {\\n         // Merge the matching deltas into one, find highest version\\n@@ -877,10 +887,10 @@ BookmarksSyncService.prototype = {\\n             ret.version = v;\\n         }\\n         keys = keys.sort();\\n-        this.notice(\\\"TMP: \\\" + uneval(tmp));\\n+        //this.notice(\\\"TMP: \\\" + uneval(tmp));\\n         for (var i = 0; i < keys.length; i++) {\\n           tmp = this._applyCommandsToObj(ret.deltas[keys[i]], tmp);\\n-          this.notice(\\\"TMP: \\\" + uneval(tmp));\\n+          //this.notice(\\\"TMP: \\\" + uneval(tmp));\\n         }\\n         ret.status = 1;\\n         ret[\\\"updates\\\"] = this._detectUpdates(this._snapshot, tmp);\\n\""}