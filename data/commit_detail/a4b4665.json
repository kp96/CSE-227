{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basa4b4665\""},"diff":"\"a4b4665 Fixing bug 393900. Make windows opened with showModalDialog() obey window feature prefs. r+sr=jonas@sicking.cc, a=dsicore@mozilla.com\\ndiff --git a/dom/src/base/nsGlobalWindow.cpp b/dom/src/base/nsGlobalWindow.cpp\\nindex e7f516f..ca10ffb 100644\\n--- a/dom/src/base/nsGlobalWindow.cpp\\n+++ b/dom/src/base/nsGlobalWindow.cpp\\n@@ -4579,6 +4579,7 @@ nsGlobalWindow::Open(const nsAString& aUrl, const nsAString& aName,\\n {\\n   return OpenInternal(aUrl, aName, aOptions,\\n                       PR_FALSE,          // aDialog\\n+                      PR_FALSE,          // aContentModal\\n                       PR_TRUE,           // aCalledNoScript\\n                       PR_FALSE,          // aDoJSFixups\\n                       nsnull, nsnull,    // No args\\n@@ -4630,6 +4631,7 @@ nsGlobalWindow::Open(nsIDOMWindow **_retval)\\n \\n   return OpenInternal(url, name, options,\\n                       PR_FALSE,          // aDialog\\n+                      PR_FALSE,          // aContentModal\\n                       PR_FALSE,          // aCalledNoScript\\n                       PR_TRUE,           // aDoJSFixups\\n                       nsnull, nsnull,    // No args\\n@@ -4647,6 +4649,7 @@ nsGlobalWindow::OpenDialog(const nsAString& aUrl, const nsAString& aName,\\n {\\n   return OpenInternal(aUrl, aName, aOptions,\\n                       PR_TRUE,                    // aDialog\\n+                      PR_FALSE,                   // aContentModal\\n                       PR_TRUE,                    // aCalledNoScript\\n                       PR_FALSE,                   // aDoJSFixups\\n                       nsnull, aExtraArgument,     // Arguments\\n@@ -4706,6 +4709,7 @@ nsGlobalWindow::OpenDialog(nsIDOMWindow** _retval)\\n \\n   return OpenInternal(url, name, options,\\n                       PR_TRUE,             // aDialog\\n+                      PR_FALSE,            // aContentModal\\n                       PR_FALSE,            // aCalledNoScript\\n                       PR_FALSE,            // aDoJSFixups\\n                       argvArray, nsnull,   // Arguments\\n@@ -5237,6 +5241,7 @@ nsGlobalWindow::ShowModalDialog(const nsAString& aURI, nsIVariant *aArgs,\\n \\n   nsresult rv = OpenInternal(aURI, EmptyString(), options,\\n                              PR_FALSE,          // aDialog\\n+                             PR_TRUE,           // aContentModal\\n                              PR_TRUE,           // aCalledNoScript\\n                              PR_FALSE,          // aDoJSFixups\\n                              nsnull, aArgs,     // args\\n@@ -6445,15 +6450,15 @@ nsGlobalWindow::CloseBlockScriptTerminationFunc(nsISupports *aRef)\\n nsresult\\n nsGlobalWindow::OpenInternal(const nsAString& aUrl, const nsAString& aName,\\n                              const nsAString& aOptions, PRBool aDialog,\\n-                             PRBool aCalledNoScript, PRBool aDoJSFixups,\\n-                             nsIArray *argv,\\n+                             PRBool aContentModal, PRBool aCalledNoScript,\\n+                             PRBool aDoJSFixups, nsIArray *argv,\\n                              nsISupports *aExtraArgument,\\n                              nsIPrincipal *aCalleePrincipal,\\n                              JSContext *aJSCallerContext,\\n                              nsIDOMWindow **aReturn)\\n {\\n   FORWARD_TO_OUTER(OpenInternal, (aUrl, aName, aOptions, aDialog,\\n-                                  aCalledNoScript, aDoJSFixups,\\n+                                  aContentModal, aCalledNoScript, aDoJSFixups,\\n                                   argv, aExtraArgument, aCalleePrincipal,\\n                                   aJSCallerContext, aReturn),\\n                    NS_ERROR_NOT_INITIALIZED);\\n@@ -6574,8 +6579,11 @@ nsGlobalWindow::OpenInternal(const nsAString& aUrl, const nsAString& aName,\\n       // up.  We do NOT want this case looking at the JS context on the stack\\n       // when searching.  Compare comments on\\n       // nsIDOMWindowInternal::OpenWindow and nsIWindowWatcher::OpenWindow.\\n-      nsCOMPtr<nsIJSContextStack> stack =\\n-        do_GetService(sJSStackContractID);\\n+      nsCOMPtr<nsIJSContextStack> stack;\\n+\\n+      if (!aContentModal) {\\n+        stack = do_GetService(sJSStackContractID);\\n+      }\\n \\n       if (stack) {\\n         rv = stack->Push(nsnull);\\ndiff --git a/dom/src/base/nsGlobalWindow.h b/dom/src/base/nsGlobalWindow.h\\nindex ceb98f6..7a11b01 100644\\n--- a/dom/src/base/nsGlobalWindow.h\\n+++ b/dom/src/base/nsGlobalWindow.h\\n@@ -493,6 +493,7 @@ protected:\\n                                     const nsAString& aName,\\n                                     const nsAString& aOptions,\\n                                     PRBool aDialog,\\n+                                    PRBool aContentModal,\\n                                     PRBool aCalledNoScript,\\n                                     PRBool aDoJSFixups,\\n                                     nsIArray *argv,\\ndiff --git a/embedding/components/windowwatcher/src/nsWindowWatcher.cpp b/embedding/components/windowwatcher/src/nsWindowWatcher.cpp\\nindex b41b74cf..af62108 100644\\n--- a/embedding/components/windowwatcher/src/nsWindowWatcher.cpp\\n+++ b/embedding/components/windowwatcher/src/nsWindowWatcher.cpp\\n@@ -1377,7 +1377,7 @@ void nsWindowWatcher::CheckWindowName(nsString& aName)\\n \\n #define NS_CALCULATE_CHROME_FLAG_FOR(feature, flag)               \\\\\\n     prefBranch->GetBoolPref(feature, &forceEnable);               \\\\\\n-    if (forceEnable && !aDialog &&                                \\\\\\n+    if (forceEnable && !(aDialog && isChrome) &&                  \\\\\\n         !(isChrome && aHasChromeParent)) {                        \\\\\\n       chromeFlags |= flag;                                        \\\\\\n     } else {                                                      \\\\\\n\""}