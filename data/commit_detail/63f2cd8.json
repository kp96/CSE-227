{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas63f2cd8\""},"diff":"\"63f2cd8 Bug 175893. Make tab labels focusable (when clicking on label of foreground tab). Make unmodified arrow key navigation work with tabs. r=neil, sr=?\\ndiff --git a/browser/base/content/tabbrowser.xml b/browser/base/content/tabbrowser.xml\\nindex 9d68508..9190ede 100644\\n--- a/browser/base/content/tabbrowser.xml\\n+++ b/browser/base/content/tabbrowser.xml\\n@@ -425,7 +425,11 @@\\n             if (this.mCurrentBrowser) {\\n               this.mCurrentBrowser.focusedWindow = document.commandDispatcher.focusedWindow;\\n               this.mCurrentBrowser.focusedElement = document.commandDispatcher.focusedElement;\\n-               this.mCurrentBrowser.setAttribute(\\\"type\\\", \\\"content\\\");\\n+              if (this.mCurrentBrowser.focusedElement) {\\n+                // Clear focus outline before we draw on top of it\\n+                this.mCurrentBrowser.focusedElement.blur();\\n+              }\\n+              this.mCurrentBrowser.setAttribute(\\\"type\\\", \\\"content\\\");\\n             }\\n             \\n             var updatePageReport = false;\\n@@ -489,22 +493,31 @@\\n             }\\n \\n             function setFocus(element) {\\n-              Components.lookupMethod(element, \\\"focus\\\").call(element);\\n+              if (document.commandDispatcher.focusedElement && \\n+                  document.commandDispatcher.focusedElement.parentNode == \\n+                  this.mCurrentTab.parentNode) {\\n+                // The focus is on a tab in the same tab panel\\n+                return;  // If focus was on a tab, switching tabs focuses the new tab\\n+              }\\n             }\\n+            \\n+            var whatToFocus = window.content;\\n \\n             // Focus the previously focused element or window\\n-            document.commandDispatcher.suppressFocusScroll = true;\\n             if (newBrowser.focusedElement) {\\n-              try {\\n-                setFocus(newBrowser.focusedElement);\\n-              } catch (e) {\\n-                setFocus(newBrowser.focusedWindow);\\n+              if (newBrowser.focusedElement.parentNode != \\n+                  this.mCurrentTab.parentNode) {\\n+                // Focus the remembered element unless it's in the current tab panel\\n+                whatToFocus = newBrowser.focusedElement;\\n               }\\n             }\\n-            else if (newBrowser.focusedWindow)\\n-              setFocus(newBrowser.focusedWindow);\\n-            else // new tab, focus our new content area\\n-              setTimeout(setFocus, 0, window.content);\\n+            else if (newBrowser.focusedWindow) {\\n+              whatToFocus = newBrowser.focusedWindow;\\n+            }\\n+\\n+            document.commandDispatcher.suppressFocusScroll = true;\\n+            // Use setTimeout to avoid focus outline ghosting.\\n+            setTimeout(setFocus, 0, whatToFocus);\\n             document.commandDispatcher.suppressFocusScroll = false;    \\n           ]]>\\n         </body>\\n\""}