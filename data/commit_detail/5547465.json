{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas5547465\""},"diff":"\"5547465 added wizard to setup service and get login information for new users updated server pointers to point to the new services.mozilla.com backend\\ndiff --git a/services/sync/nsBookmarksSyncService.js b/services/sync/nsBookmarksSyncService.js\\nindex e6095dd..e62778b 100644\\n--- a/services/sync/nsBookmarksSyncService.js\\n+++ b/services/sync/nsBookmarksSyncService.js\\n@@ -1120,7 +1120,7 @@ DAVCollection.prototype = {\\n                                  'Use your ldap username/password - dotmoz');\\n       LOG(\\\"Found \\\" + logins.length + \\\" logins\\\");\\n \\n-      for (let i = 0; i < logins.length; i++) {\\n+          for (let i = 0; i < logins.length; i++) {\\n         if (logins[i].username == username) {\\n           password = logins[i].password;\\n           break;\\n@@ -1154,14 +1154,30 @@ DAVCollection.prototype = {\\n     }\\n \\n     // fixme: hacktastic\\n-    let hello = /Hello (.+)@mozilla.com/.exec(event.target.responseText)\\n-    if (hello) {\\n-      this._currentUserPath = hello[1];\\t\\n-      this._currentUser = this._currentUserPath + \\\"@mozilla.com\\\";\\n-      this._baseURL = \\\"http://dotmoz.mozilla.org/~\\\" +\\n-        this._currentUserPath + \\\"/\\\";\\n-    }\\n+//    let hello = /Hello (.+)@mozilla.com/.exec(event.target.responseText)\\n+//    let hello = /Index of/.exec(event.target.responseText)\\n+//    if (hello) {\\n+//      this._currentUserPath = hello[1];\\t\\n+//      this._currentUser = this._currentUserPath + \\\"@mozilla.com\\\";\\n+//      this._baseURL = \\\"http://dotmoz.mozilla.org/~\\\" +\\n+//        this._currentUserPath + \\\"/\\\";\\n+//    }\\n+\\n+      // XXX we need to refine some server response codes\\n+      let branch = Cc[\\\"@mozilla.org/preferences-service;1\\\"].\\n+        getService(Ci.nsIPrefBranch);\\n+      this._currentUser = branch.getCharPref(\\\"browser.places.sync.username\\\");\\n+\\n+      // XXX\\n+      let path = this._currentUser.split(\\\"@\\\");\\n+      this._currentUserPath = path[0];\\n+\\n+LOG(\\\"currentUser: \\\"+this._currentUser);\\n+LOG(\\\"currentUSerPath: \\\"+this._currentUserPath);\\n \\n+      let serverURL = branch.getCharPref(\\\"browser.places.sync.serverURL\\\");\\n+      this._baseURL = serverURL + this._currentUserPath + \\\"/\\\";\\n+    \\n     this._loggedIn = true;\\n \\n     if (this._loginHandlers && this._loginHandlers.load)\\ndiff --git a/services/sync/services-sync.js b/services/sync/services-sync.js\\nindex 0b00a72..9767dc7 100644\\n--- a/services/sync/services-sync.js\\n+++ b/services/sync/services-sync.js\\n@@ -1,6 +1,4 @@\\n-pref(\\\"browser.places.sync.serverURL\\\", \\\"http://dotmoz.mozilla.org/\\\");\\n+pref(\\\"browser.places.sync.serverURL\\\", \\\"https://services.mozilla.com/user/\\\");\\n pref(\\\"browser.places.sync.username\\\", \\\"nobody@mozilla.com\\\");\\n-pref(\\\"extensions.sync.lastversion\\\", \\\"firstrun\\\");\\n-pref(\\\"extensions.sync.lastsync\\\", \\\"\\\");\\n-pref(\\\"extensions.sync.remember\\\", false);\\n-\\n+pref(\\\"extensions.sync.autoconnect\\\", false);\\n+pref(\\\"extensions.sync.lastsync\\\", \\\"0\\\");\\n\""}