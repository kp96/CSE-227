{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas81e6026\""},"diff":"\"81e6026 Add a flag to nsIWebNavigation to disable popup-blocking for loads as needed. Bug 278357, r=biesi, sr=jst, a=bsmedberg\\ndiff --git a/docshell/base/nsDocShell.cpp b/docshell/base/nsDocShell.cpp\\nindex fa2f62e..8dd14bc8 100644\\n--- a/docshell/base/nsDocShell.cpp\\n+++ b/docshell/base/nsDocShell.cpp\\n@@ -2801,6 +2801,16 @@ nsDocShell::LoadURI(const PRUnichar * aURI,\\n     if (NS_FAILED(rv) || !uri)\\n         return NS_ERROR_FAILURE;\\n \\n+    PopupControlState popupState;\\n+    if (aLoadFlags & LOAD_FLAGS_ALLOW_POPUPS) {\\n+        popupState = openAllowed;\\n+        aLoadFlags &= ~LOAD_FLAGS_ALLOW_POPUPS;\\n+    } else {\\n+        popupState = openOverridden;\\n+    }\\n+    nsCOMPtr<nsPIDOMWindow> win(do_QueryInterface(mScriptGlobal));\\n+    nsAutoPopupStatePusher statePusher(win, popupState);\\n+\\n     // Don't pass certain flags that aren't needed and end up confusing\\n     // ConvertLoadTypeToDocShellLoadInfo.  We do need to ensure that they are\\n     // passed to LoadURI though, since it uses them.\\ndiff --git a/docshell/base/nsIWebNavigation.idl b/docshell/base/nsIWebNavigation.idl\\nindex cbc8e56..a9dff96 100644\\n--- a/docshell/base/nsIWebNavigation.idl\\n+++ b/docshell/base/nsIWebNavigation.idl\\n@@ -192,6 +192,12 @@ interface nsIWebNavigation : nsISupports\\n   const unsigned long LOAD_FLAGS_FIRST_LOAD = 0x4000;\\n \\n   /**\\n+   * This flag specifies that the load should not be subject to popup\\n+   * blocking checks.\\n+   */\\n+  const unsigned long LOAD_FLAGS_ALLOW_POPUPS = 0x8000;\\n+\\n+  /**\\n    * Loads a given URI.  This will give priority to loading the requested URI\\n    * in the object implementing\\tthis interface.  If it can't be loaded here\\n    * however, the URI dispatcher will go through its normal process of content\\n\""}