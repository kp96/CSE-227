{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas0c13afb\""},"diff":"\"0c13afb Bug 396031 - with color management on, ycck/cymk jpeg images crash. r=alfredkayser, sr+a=pavlov\\ndiff --git a/modules/libpr0n/decoders/jpeg/nsJPEGDecoder.cpp b/modules/libpr0n/decoders/jpeg/nsJPEGDecoder.cpp\\nindex e6c39f3..a1cfc0c 100644\\n--- a/modules/libpr0n/decoders/jpeg/nsJPEGDecoder.cpp\\n+++ b/modules/libpr0n/decoders/jpeg/nsJPEGDecoder.cpp\\n@@ -309,8 +309,8 @@ NS_IMETHODIMP nsJPEGDecoder::WriteFrom(nsIInputStream *inStr, PRUint32 count, PR\\n           CHANNELS_SH(channels) |\\n           BYTES_SH(1);\\n \\n-        /* Adobe Photoshop writes CMYK files with inverted data */\\n-        if (mInfo.jpeg_color_space == JCS_CMYK)\\n+        /* Adobe Photoshop writes YCCK/CMYK files with inverted data */\\n+        if (mInfo.out_color_space == JCS_CMYK)\\n           type |= FLAVOR_SH(mInfo.saw_Adobe_marker ? 1 : 0);\\n \\n         if (gfxPlatform::GetCMSOutputProfile())\\n@@ -569,7 +569,8 @@ nsJPEGDecoder::OutputScanlines()\\n \\n       /* Use the Cairo image buffer as scanline buffer */\\n       JSAMPROW sampleRow = (JSAMPROW)imageRow;\\n-      if (!mTransform || mInfo.out_color_space != JCS_GRAYSCALE) {\\n+      if (!mTransform || (mInfo.out_color_space != JCS_GRAYSCALE &&\\n+                          mInfo.out_color_space != JCS_CMYK)) {\\n         /* Put the pixels at end of row to enable in-place expansion */\\n         sampleRow += mInfo.output_width;\\n       }\\n@@ -587,6 +588,13 @@ nsJPEGDecoder::OutputScanlines()\\n           sampleRow += mInfo.output_width;\\n         }\\n         cmsDoTransform(mTransform, source, sampleRow, mInfo.output_width);\\n+        /* Move 3byte RGB data to end of row */\\n+        if (mInfo.out_color_space == JCS_CMYK) {\\n+          memmove(sampleRow + mInfo.output_width,\\n+                  sampleRow,\\n+                  3 * mInfo.output_width);\\n+          sampleRow += mInfo.output_width;\\n+        }\\n       } else if (gfxPlatform::IsCMSEnabled()) {\\n         /* No embedded ICC profile - treat as sRGB */\\n         cmsHTRANSFORM transform = gfxPlatform::GetCMSRGBTransform();\\n\""}