{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas287b0da\""},"diff":"\"287b0da Fix serialization of '&' in \\\"script\\\" attribute values so that it round-trips correctly.  Bug 392511, r+sr=peterv, a=jst\\ndiff --git a/content/base/src/nsXMLContentSerializer.cpp b/content/base/src/nsXMLContentSerializer.cpp\\nindex 19a0475..09320ec 100644\\n--- a/content/base/src/nsXMLContentSerializer.cpp\\n+++ b/content/base/src/nsXMLContentSerializer.cpp\\n@@ -529,7 +529,9 @@ nsXMLContentSerializer::SerializeAttr(const nsAString& aPrefix,\\n     // need to select the delimiter character and escape characters using\\n     // character entity references, ignoring the value of aDoEscapeEntities.\\n     // See http://www.w3.org/TR/REC-html40/appendix/notes.html#h-B.3.2.2 for\\n-    // the standard on character entity references in values. \\n+    // the standard on character entity references in values.  We also have to\\n+    // make sure to escape any '&' characters.\\n+    \\n     PRBool bIncludesSingle = PR_FALSE;\\n     PRBool bIncludesDouble = PR_FALSE;\\n     nsAString::const_iterator iCurr, iEnd;\\n@@ -565,18 +567,16 @@ nsXMLContentSerializer::SerializeAttr(const nsAString& aPrefix,\\n         (bIncludesDouble && !bIncludesSingle) ? PRUnichar('\\\\'') : PRUnichar('\\\"');\\n     AppendToString(PRUnichar('='), aStr);\\n     AppendToString(cDelimiter, aStr);\\n+    nsAutoString sValue(aValue);\\n+    sValue.ReplaceSubstring(NS_LITERAL_STRING(\\\"&\\\"),\\n+                            NS_LITERAL_STRING(\\\"&amp;\\\"));\\n     if (bIncludesDouble && bIncludesSingle) {\\n-      nsAutoString sValue(aValue);\\n-      sValue.ReplaceSubstring(NS_LITERAL_STRING(\\\"\\\\\\\"\\\").get(), NS_LITERAL_STRING(\\\"&quot;\\\").get());\\n-      mInAttribute = PR_TRUE;\\n-      AppendToString(sValue, aStr, PR_FALSE);\\n-      mInAttribute = PR_FALSE;\\n-    }\\n-    else {\\n-      mInAttribute = PR_TRUE;\\n-      AppendToString(aValue, aStr, PR_FALSE);\\n-      mInAttribute = PR_FALSE;\\n+      sValue.ReplaceSubstring(NS_LITERAL_STRING(\\\"\\\\\\\"\\\"),\\n+                              NS_LITERAL_STRING(\\\"&quot;\\\"));\\n     }\\n+    mInAttribute = PR_TRUE;\\n+    AppendToString(sValue, aStr, PR_FALSE);\\n+    mInAttribute = PR_FALSE;\\n     AppendToString(cDelimiter, aStr);\\n   }\\n }\\ndiff --git a/content/base/test/Makefile.in b/content/base/test/Makefile.in\\nindex fa56b4d..d1f4d74 100644\\n--- a/content/base/test/Makefile.in\\n+++ b/content/base/test/Makefile.in\\n@@ -87,6 +87,7 @@ _TEST_FILES = \\ttest_bug5141.html \\\\\\n \\t\\ttest_bug375314.html \\\\\\n \\t\\ttest_bug382113.html \\\\\\n \\t\\ttest_bug390735.html \\\\\\n+\\t\\ttest_bug392511.html \\\\\\n \\t\\tbug382113_object.html \\\\\\n \\t\\ttest_CrossSiteXHR.html \\\\\\n \\t\\tfile_CrossSiteXHR_fail1.xml \\\\\\ndiff --git a/content/base/test/test_bug392511.html b/content/base/test/test_bug392511.html\\nnew file mode 100644\\nindex 0000000..c50994d\\n--- /dev/null\\n+++ b/content/base/test/test_bug392511.html\\n@@ -0,0 +1,54 @@\\n+<!DOCTYPE HTML>\\n+<html>\\n+<!--\\n+https://bugzilla.mozilla.org/show_bug.cgi?id=392511\\n+-->\\n+<head>\\n+  <title>Test for Bug 392511</title>\\n+  <script type=\\\"text/javascript\\\" src=\\\"/MochiKit/MochiKit.js\\\"></script>\\n+  <script type=\\\"text/javascript\\\" src=\\\"/tests/SimpleTest/SimpleTest.js\\\"></script>\\n+  <link rel=\\\"stylesheet\\\" type=\\\"text/css\\\" href=\\\"/tests/SimpleTest/test.css\\\" />\\n+</head>\\n+<body>\\n+<a target=\\\"_blank\\\" href=\\\"https://bugzilla.mozilla.org/show_bug.cgi?id=392511\\\">Mozilla Bug 392511</a>\\n+<p id=\\\"display\\\"></p>\\n+<div id=\\\"content\\\" style=\\\"display: none\\\">\\n+  <div id=\\\"t1\\\"><span onclick=\\\"&quot;&amp;\\\"></span></div>  \\n+  <div id=\\\"t2\\\"><span foo=\\\"&quot;&amp;\\\"></span></div>  \\n+  <div id=\\\"t3\\\"><span onclick='&apos;&amp;'></span></div>  \\n+  <div id=\\\"t4\\\"><span foo='&apos;&amp;'></span></div>  \\n+  <div id=\\\"t5\\\"><span onclick='\\\"&apos;&amp;'></span></div>  \\n+  <div id=\\\"t6\\\"><span foo='\\\"&apos;&amp;'></span></div>  \\n+  <div id=\\\"t7\\\"><span onclick=\\\"'&quot;&amp;\\\"></span></div>  \\n+  <div id=\\\"t8\\\"><span foo=\\\"'&quot;&amp;\\\"></span></div>  \\n+</div>\\n+<pre id=\\\"test\\\">\\n+<script class=\\\"testbody\\\" type=\\\"text/javascript\\\">\\n+\\n+/** Test for Bug 392511 **/\\n+\\n+var results = [\\n+ \\\"'\\\\\\\"&amp;'\\\",\\n+ \\\"\\\\\\\"&quot;&amp;\\\\\\\"\\\",\\n+ \\\"\\\\\\\"'&amp;\\\\\\\"\\\",\\n+ \\\"\\\\\\\"'&amp;\\\\\\\"\\\",\\n+ \\\"\\\\\\\"&quot;'&amp;\\\\\\\"\\\",\\n+ \\\"\\\\\\\"&quot;'&amp;\\\\\\\"\\\",\\n+ \\\"\\\\\\\"'&quot;&amp;\\\\\\\"\\\",\\n+ \\\"\\\\\\\"'&quot;&amp;\\\\\\\"\\\"\\n+];\\n+ \\n+for (var i = 1; i <= 8; ++i) {\\n+  var id = \\\"t\\\" + i;\\n+  var str = $(id).innerHTML;\\n+  var expect = \\\"<span \\\";\\n+  expect += (i % 2) ? \\\"onclick\\\" : \\\"foo\\\";\\n+  expect += \\\"=\\\" + results[i-1] + \\\"></span>\\\";\\n+  is (str, expect, \\\"Wrong string for test \\\" + id);\\n+}\\n+\\n+</script>\\n+</pre>\\n+</body>\\n+</html>\\n+\\n\""}