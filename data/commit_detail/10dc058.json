{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas10dc058\""},"diff":"\"10dc058 Bug 394689. Cannot use setCaretOffset() to position caret at end of HTML entry. r=david.bolter, a=dsicore\\ndiff --git a/accessible/src/html/nsHyperTextAccessible.cpp b/accessible/src/html/nsHyperTextAccessible.cpp\\nindex 9d939a9..dcd40b0 100644\\n--- a/accessible/src/html/nsHyperTextAccessible.cpp\\n+++ b/accessible/src/html/nsHyperTextAccessible.cpp\\n@@ -330,6 +330,13 @@ nsHyperTextAccessible::GetPosAndText(PRInt32& aStartOffset, PRInt32& aEndOffset,\\n                                      nsIAccessible **aStartAcc,\\n                                      nsIAccessible **aEndAcc)\\n {\\n+  if (aStartOffset < 0) {\\n+    GetCharacterCount(&aStartOffset);\\n+  }\\n+  if (aEndOffset < 0) {\\n+    GetCharacterCount(&aEndOffset);\\n+  }\\n+\\n   PRInt32 startOffset = aStartOffset;\\n   PRInt32 endOffset = aEndOffset;\\n \\n@@ -358,7 +365,7 @@ nsHyperTextAccessible::GetPosAndText(PRInt32& aStartOffset, PRInt32& aEndOffset,\\n     *aEndAcc = nsnull;\\n \\n   nsIntRect unionRect;\\n-  nsCOMPtr<nsIAccessible> accessible;\\n+  nsCOMPtr<nsIAccessible> accessible, lastAccessible;\\n \\n   gfxSkipChars skipChars;\\n   gfxSkipCharsIterator iter;\\n@@ -366,6 +373,7 @@ nsHyperTextAccessible::GetPosAndText(PRInt32& aStartOffset, PRInt32& aEndOffset,\\n   // Loop through children and collect valid offsets, text and bounds\\n   // depending on what we need for out parameters\\n   while (NextChild(accessible)) {\\n+    lastAccessible = accessible;\\n     nsCOMPtr<nsPIAccessNode> accessNode(do_QueryInterface(accessible));\\n     nsIFrame *frame = accessNode->GetFrame();\\n     if (!frame) {\\n@@ -479,10 +487,13 @@ nsHyperTextAccessible::GetPosAndText(PRInt32& aStartOffset, PRInt32& aEndOffset,\\n     }\\n   }\\n \\n+  if (aStartAcc && !*aStartAcc) {\\n+    NS_IF_ADDREF(*aStartAcc = lastAccessible);\\n+  }\\n   if (aEndFrame && !*aEndFrame) {\\n     *aEndFrame = startFrame;\\n     if (aStartAcc && aEndAcc)\\n-      NS_ADDREF(*aEndAcc = *aStartAcc);\\n+      NS_IF_ADDREF(*aEndAcc = *aStartAcc);\\n   }\\n \\n   return startFrame;\\n@@ -1571,35 +1582,56 @@ NS_IMETHODIMP nsHyperTextAccessible::SetSelectionBounds(PRInt32 aSelectionNum, P\\n   }\\n \\n   nsIFrame *endFrame;\\n-  nsIFrame *startFrame = GetPosAndText(aStartOffset, aEndOffset, nsnull, &endFrame);\\n-  NS_ENSURE_TRUE(startFrame, NS_ERROR_FAILURE);\\n+  nsCOMPtr<nsIAccessible> startAcc, endAcc;\\n+  nsIFrame *startFrame = GetPosAndText(aStartOffset, aEndOffset, nsnull, &endFrame, nsnull,\\n+                                       getter_AddRefs(startAcc), getter_AddRefs(endAcc));\\n \\n   nsCOMPtr<nsIPresShell> shell = GetPresShell();\\n \\n-  nsIContent *startParentContent = startFrame->GetContent();\\n-  PRInt32 startOffset;\\n-  if (startFrame->GetType() != nsAccessibilityAtoms::textFrame) {\\n-    nsIContent *newParent = startParentContent->GetParent();\\n-    startOffset = newParent->IndexOf(startParentContent);\\n-    startParentContent = newParent;\\n+  if (!startFrame) { // past the end of the hyper text\\n+    nsCOMPtr<nsIAccessNode> startAccessNode = do_QueryInterface(startAcc);\\n+    NS_ENSURE_TRUE(startAccessNode, NS_ERROR_FAILURE);\\n+    nsCOMPtr<nsIDOMNode> node;\\n+    startAccessNode->GetDOMNode(getter_AddRefs(node));\\n+    NS_ENSURE_TRUE(node, NS_ERROR_FAILURE);\\n+    rv = range->SetStartAfter(node);\\n+    NS_ENSURE_SUCCESS(rv, rv);\\n   }\\n   else {\\n-    // We have a rendered offset into the text frame, and it needs to be\\n-    // a content offset for us to set the caret\\n-    nsIFrame *startPrimaryFrame =\\n-      shell->GetPrimaryFrameFor(startFrame->GetContent());\\n-    rv = RenderedToContentOffset(startPrimaryFrame, aStartOffset, &startOffset);\\n+    nsIContent *startParentContent = startFrame->GetContent();\\n+    PRInt32 startOffset;\\n+    if (startFrame->GetType() != nsAccessibilityAtoms::textFrame) {\\n+      nsIContent *newParent = startParentContent->GetParent();\\n+      startOffset = newParent->IndexOf(startParentContent);\\n+      startParentContent = newParent;\\n+    }\\n+    else {\\n+      // We have a rendered offset into the text frame, and it needs to be\\n+      // a content offset for us to set the caret\\n+      nsIFrame *startPrimaryFrame =\\n+        shell->GetPrimaryFrameFor(startFrame->GetContent());\\n+      rv = RenderedToContentOffset(startPrimaryFrame, aStartOffset, &startOffset);\\n+      NS_ENSURE_SUCCESS(rv, rv);\\n+    }\\n+    nsCOMPtr<nsIDOMNode> startParentNode(do_QueryInterface(startParentContent));\\n+    NS_ENSURE_TRUE(startParentNode, NS_ERROR_FAILURE);\\n+    rv = range->SetStart(startParentNode, startOffset);\\n     NS_ENSURE_SUCCESS(rv, rv);\\n   }\\n-  nsCOMPtr<nsIDOMNode> startParentNode(do_QueryInterface(startParentContent));\\n-  NS_ENSURE_TRUE(startParentNode, NS_ERROR_FAILURE);\\n-  rv = range->SetStart(startParentNode, startOffset);\\n-  NS_ENSURE_SUCCESS(rv, rv);\\n \\n   if (isOnlyCaret) { \\n     rv = range->Collapse(PR_TRUE);\\n     NS_ENSURE_SUCCESS(rv, rv);\\n   }\\n+  else if (!endFrame) {  // past the end of the hyper text\\n+    nsCOMPtr<nsIAccessNode> endAccessNode = do_QueryInterface(endAcc);\\n+    NS_ENSURE_TRUE(endAccessNode, NS_ERROR_FAILURE);\\n+    nsCOMPtr<nsIDOMNode> node;\\n+    endAccessNode->GetDOMNode(getter_AddRefs(node));\\n+    NS_ENSURE_TRUE(node, NS_ERROR_FAILURE);\\n+    rv = range->SetEndAfter(node);\\n+    NS_ENSURE_SUCCESS(rv, rv);\\n+  }\\n   else {\\n     nsIContent *endParentContent = endFrame->GetContent();\\n     PRInt32 endOffset;\\n\""}