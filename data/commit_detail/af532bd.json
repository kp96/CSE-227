{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basaf532bd\""},"diff":"\"af532bd Bug 392812: Restart button remains disabled after extension updates. r=robstrong\\ndiff --git a/toolkit/mozapps/extensions/content/extensions.js b/toolkit/mozapps/extensions/content/extensions.js\\nindex fbe5d01..f26fd71 100644\\n--- a/toolkit/mozapps/extensions/content/extensions.js\\n+++ b/toolkit/mozapps/extensions/content/extensions.js\\n@@ -817,6 +817,7 @@ XPInstallDownloadManager.prototype = {\\n     }\\n \\n     gExtensionManager.addDownloads(items, items.length, false);\\n+    updateOptionalViews();\\n     updateGlobalCommands();\\n   },\\n \\n@@ -833,15 +834,8 @@ XPInstallDownloadManager.prototype = {\\n   onStateChange: function (aAddon, aState, aValue)\\n   {\\n     const nsIXPIProgressDialog = Components.interfaces.nsIXPIProgressDialog;\\n-    var element = this.getElementForAddon(aAddon);\\n-    if (!element && aState != nsIXPIProgressDialog.DIALOG_CLOSE)\\n-      return;\\n     switch (aState) {\\n       case nsIXPIProgressDialog.DOWNLOAD_START:\\n-        gInstallCount++;\\n-        if (gInstallCount == 1)\\n-          updateGlobalCommands();\\n-        break;\\n       case nsIXPIProgressDialog.DOWNLOAD_DONE:\\n       case nsIXPIProgressDialog.INSTALL_START:\\n         break;\\n@@ -1455,6 +1449,7 @@ function updateOptionalViews() {\\n   var showLocales = false;\\n   var showUpdates = false;\\n   var showInstalls = false;\\n+  gInstallCount = 0;\\n   while (elements.hasMoreElements()) {\\n     var e = elements.getNext().QueryInterface(Components.interfaces.nsIRDFResource);\\n     if (!showLocales) {\\n@@ -1570,6 +1565,7 @@ function installUpdatesAll() {\\n     showView(\\\"installs\\\");\\n     // Remove the updates view if there are no add-ons left to update\\n     updateOptionalViews();\\n+    updateGlobalCommands();\\n   }\\n }\\n \\n@@ -1845,9 +1841,9 @@ var gExtensionsViewController = {\\n       showView(\\\"installs\\\");\\n       var item = gExtensionManager.getItemForID(getIDFromResourceURI(aSelectedItem.id));\\n       gExtensionManager.addDownloads([item], 1, true);\\n-      updateGlobalCommands();\\n       // Remove the updates view if there are no add-ons left to update\\n       updateOptionalViews();\\n+      updateGlobalCommands();\\n     },\\n \\n     cmd_includeUpdate: function (aSelectedItem)\\ndiff --git a/toolkit/mozapps/extensions/src/nsExtensionManager.js.in b/toolkit/mozapps/extensions/src/nsExtensionManager.js.in\\nindex f99dffe..5d09751 100644\\n--- a/toolkit/mozapps/extensions/src/nsExtensionManager.js.in\\n+++ b/toolkit/mozapps/extensions/src/nsExtensionManager.js.in\\n@@ -5384,7 +5384,6 @@ ExtensionManager.prototype = {\\n \\n       var txnID = Math.round(Math.random() * 100);\\n       txn.addDownload(currItem, txnID);\\n-      this._transactions.push(txn);\\n       urls.push(currItem.xpiURL);\\n       hashes.push(currItem.xpiHash ? currItem.xpiHash : null);\\n       // if this is an update remove the update metadata to prevent it from\\n@@ -5400,6 +5399,7 @@ ExtensionManager.prototype = {\\n       var id = fromChrome ? PREFIX_ITEM_URI + currItem.id : currItem.xpiURL;\\n       ds.updateDownloadState(id, \\\"waiting\\\");\\n     }\\n+    this._transactions.push(txn);\\n \\n     if (fromChrome) {\\n       // Initiate an install from chrome\\n@@ -5485,7 +5485,6 @@ ExtensionManager.prototype = {\\n       for (var i = 0; i < this._transactions.length; ++i) {\\n         if (this._transactions[i].id == transaction.id) {\\n           this._transactions.splice(i, 1);\\n-          delete transaction;\\n           // Remove the observers when all transactions have completed.\\n           if (this._transactions.length == 0) {\\n             gOS.removeObserver(this, \\\"offline-requested\\\");\\n\""}