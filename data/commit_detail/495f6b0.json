{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas495f6b0\""},"diff":"\"495f6b0 Bug 383252: Cannot drag / drop URL or link onto tabbar, r=mconnor When SeaMonkey switched to toolkit's nsDragAndDrop.js, it lost the dragDropSecurityCheck method, which for SM was on nsDragAndDrop, but for FF was on tabbrowser. Moving that method from tabbrowser to toolkit's nsDragAndDrop.js, and cleaning it up a little.\\ndiff --git a/browser/base/content/tabbrowser.xml b/browser/base/content/tabbrowser.xml\\nindex 82a5f08..18cfe83 100644\\n--- a/browser/base/content/tabbrowser.xml\\n+++ b/browser/base/content/tabbrowser.xml\\n@@ -1912,7 +1912,7 @@\\n                   /^\\\\s*(javascript|data):/.test(url))\\n                 return;\\n \\n-              this.dragDropSecurityCheck(aEvent, aDragSession, url);\\n+              nsDragAndDrop.dragDropSecurityCheck(aEvent, aDragSession, url);\\n \\n               var bgLoad = true;\\n               try {\\n@@ -2310,51 +2310,7 @@\\n         <parameter name=\\\"aUri\\\"/>\\n         <body>\\n           <![CDATA[\\n-            // Do a security check for drag n' drop. Make sure the\\n-            // source document can load the dragged link.\\n-            var sourceDoc = aDragSession.sourceDocument;\\n-\\n-            if (sourceDoc) {\\n-              // Strip leading and trailing whitespace, then try to\\n-              // create a URI from the dropped string. If that\\n-              // succeeds, we're dropping a URI and we need to do a\\n-              // security check to make sure the source document can\\n-              // load the dropped URI. We don't so much care about\\n-              // creating the real URI here (i.e. encoding differences\\n-              // etc don't matter), we just want to know if aUri\\n-              // really is a URI.\\n-\\n-              var uriStr = aUri.replace(/^\\\\s*|\\\\s*$/g, '');\\n-              var uri = null;\\n-\\n-              try {\\n-                uri = Components.classes[\\\"@mozilla.org/network/io-service;1\\\"]\\n-                  .getService(Components.interfaces.nsIIOService)\\n-                  .newURI(uriStr, null, null);\\n-              } catch (e) {\\n-              }\\n-\\n-              if (uri) {\\n-                // aUri is a URI, do the security check.\\n-                var sourceURI = sourceDoc.documentURI;\\n-\\n-                const nsIScriptSecurityManager =\\n-                  Components.interfaces.nsIScriptSecurityManager;\\n-                var secMan =\\n-                  Components.classes[\\\"@mozilla.org/scriptsecuritymanager;1\\\"]\\n-                  .getService(nsIScriptSecurityManager);\\n-\\n-                try {\\n-                  secMan.checkLoadURIStr(sourceURI, uriStr,\\n-                                         nsIScriptSecurityManager.STANDARD);\\n-                } catch (e) {\\n-                  // Stop event propagation right here.\\n-                  aEvent.stopPropagation();\\n-\\n-                  throw \\\"Drop of \\\" + aUri + \\\" denied.\\\";\\n-                }\\n-              }\\n-            }\\n+            nsDragAndDrop.dragDropSecurityCheck(aEvent, aDragSession, aUri);\\n           ]]>\\n         </body>\\n       </method>\\n\""}