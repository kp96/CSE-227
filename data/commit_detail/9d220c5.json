{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas9d220c5\""},"diff":"\"9d220c5 Bug 391899: getItemForID returns an empty nsIUpdateItem if the item doesn't exist. r=robstrong\\ndiff --git a/browser/fuel/src/fuelApplication.js b/browser/fuel/src/fuelApplication.js\\nindex 5ae3629..fbdc8cd 100644\\n--- a/browser/fuel/src/fuelApplication.js\\n+++ b/browser/fuel/src/fuelApplication.js\\n@@ -527,10 +527,7 @@ Extensions.prototype = {\\n   },\\n   \\n   has : function exts_has(aId) {\\n-    // getItemForID never returns null for a non-existent id, so we\\n-    // check the type of the returned update item, which should be\\n-    // greater than 1 for a valid extension.\\n-    return !!(this._extmgr.getItemForID(aId).type);\\n+    return this._extmgr.getItemForID(aId) != null;\\n   },\\n   \\n   get : function exts_get(aId) {\\ndiff --git a/toolkit/mozapps/extensions/public/nsIExtensionManager.idl b/toolkit/mozapps/extensions/public/nsIExtensionManager.idl\\nindex 2d89b07..d293b70 100644\\n--- a/toolkit/mozapps/extensions/public/nsIExtensionManager.idl\\n+++ b/toolkit/mozapps/extensions/public/nsIExtensionManager.idl\\n@@ -311,7 +311,8 @@ interface nsIExtensionManager : nsISupports\\n    * Gets a nsIUpdateItem for the item with the specified id.\\n    * @param   id\\n    *          The GUID of the item to construct a nsIUpdateItem for.\\n-   * @returns The nsIUpdateItem representing the item.\\n+   * @returns The nsIUpdateItem representing the item or null if the item does\\n+   *          not exist.\\n    */\\n   nsIUpdateItem getItemForID(in AString id);\\n \\ndiff --git a/toolkit/mozapps/extensions/src/nsExtensionManager.js.in b/toolkit/mozapps/extensions/src/nsExtensionManager.js.in\\nindex da91c175..37939b2 100644\\n--- a/toolkit/mozapps/extensions/src/nsExtensionManager.js.in\\n+++ b/toolkit/mozapps/extensions/src/nsExtensionManager.js.in\\n@@ -6561,6 +6561,9 @@ ExtensionsDataSource.prototype = {\\n    * @returns The nsIUpdateItem for the id.\\n    */  \\n   getItemForID: function(id) {\\n+    if (!this.visibleItems[id])\\n+      return null;\\n+\\n     var r = getResourceForID(id);\\n     if (!r)\\n       return null;\\ndiff --git a/toolkit/mozapps/extensions/test/unit/test_bug391899.js b/toolkit/mozapps/extensions/test/unit/test_bug391899.js\\nnew file mode 100644\\nindex 0000000..ceb6d9f\\n--- /dev/null\\n+++ b/toolkit/mozapps/extensions/test/unit/test_bug391899.js\\n@@ -0,0 +1,64 @@\\n+/* ***** BEGIN LICENSE BLOCK *****\\n+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1\\n+ *\\n+ * The contents of this file are subject to the Mozilla Public License Version\\n+ * 1.1 (the \\\"License\\\"); you may not use this file except in compliance with\\n+ * the License. You may obtain a copy of the License at\\n+ * http://www.mozilla.org/MPL/\\n+ *\\n+ * Software distributed under the License is distributed on an \\\"AS IS\\\" basis,\\n+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\\n+ * for the specific language governing rights and limitations under the\\n+ * License.\\n+ *\\n+ * The Original Code is mozilla.org code.\\n+ *\\n+ * The Initial Developer of the Original Code is\\n+ *      Dave Townsend <dtownsend@oxymoronical.com>.\\n+ *\\n+ * Portions created by the Initial Developer are Copyright (C) 2007\\n+ * the Initial Developer. All Rights Reserved.\\n+ *\\n+ * Contributor(s):\\n+ *\\n+ * Alternatively, the contents of this file may be used under the terms of\\n+ * either the GNU General Public License Version 2 or later (the \\\"GPL\\\"), or\\n+ * the GNU Lesser General Public License Version 2.1 or later (the \\\"LGPL\\\"),\\n+ * in which case the provisions of the GPL or the LGPL are applicable instead\\n+ * of those above. If you wish to allow use of your version of this file only\\n+ * under the terms of either the GPL or the LGPL, and not to allow others to\\n+ * use your version of this file under the terms of the MPL, indicate your\\n+ * decision by deleting the provisions above and replace them with the notice\\n+ * and other provisions required by the GPL or the LGPL. If you do not delete\\n+ * the provisions above, a recipient may use your version of this file under\\n+ * the terms of any one of the MPL, the GPL or the LGPL.\\n+ *\\n+ * ***** END LICENSE BLOCK *****\\n+ */\\n+\\n+const ADDON = \\\"test_bug257155\\\";\\n+const ID = \\\"bug257155@tests.mozilla.org\\\";\\n+\\n+function run_test()\\n+{\\n+  // Setup for test\\n+  createAppInfo(\\\"xpcshell@tests.mozilla.org\\\", \\\"XPCShell\\\", \\\"1\\\");\\n+  startupEM();\\n+  \\n+  // Install an extension\\n+  gEM.installItemFromFile(do_get_addon(ADDON), NS_INSTALL_LOCATION_APPPROFILE);\\n+  var addon = gEM.getItemForID(ID);\\n+  do_check_neq(addon, null);\\n+  do_check_eq(addon.id, ID);\\n+  restartEM();\\n+\\n+  // Check after the restart\\n+  addon = gEM.getItemForID(ID);\\n+  do_check_neq(addon, null);\\n+  do_check_eq(addon.id, ID);\\n+\\n+  // Dummy extension should not exist\\n+  addon = gEM.getItemForID(\\\"test-dummy-extension@mozilla.org\\\");\\n+  do_check_eq(addon, null);\\n+  shutdownEM();\\n+}\\n\""}