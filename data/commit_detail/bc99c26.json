{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basbc99c26\""},"diff":"\"bc99c26 Bug 389578 - Remove field wrappers. r=myk, a=mconnor\\ndiff --git a/browser/components/microsummaries/src/nsMicrosummaryService.js b/browser/components/microsummaries/src/nsMicrosummaryService.js\\nindex d288197..4de6a74 100644\\n--- a/browser/components/microsummaries/src/nsMicrosummaryService.js\\n+++ b/browser/components/microsummaries/src/nsMicrosummaryService.js\\n@@ -59,10 +59,10 @@ const GENERATOR_INTERVAL = 7 * 86400; // 1 week\\n const MICSUM_NS = new Namespace(\\\"http://www.mozilla.org/microsummaries/0.1\\\");\\n const XSLT_NS = new Namespace(\\\"http://www.w3.org/1999/XSL/Transform\\\");\\n \\n-const FIELD_MICSUM_GEN_URI    = \\\"microsummary/generatorURI\\\";\\n-const FIELD_MICSUM_EXPIRATION = \\\"microsummary/expiration\\\";\\n-const FIELD_STATIC_TITLE      = \\\"bookmarks/staticTitle\\\";\\n-const FIELD_CONTENT_TYPE      = \\\"bookmarks/contentType\\\";\\n+const ANNO_MICSUM_GEN_URI    = \\\"microsummary/generatorURI\\\";\\n+const ANNO_MICSUM_EXPIRATION = \\\"microsummary/expiration\\\";\\n+const ANNO_STATIC_TITLE      = \\\"bookmarks/staticTitle\\\";\\n+const ANNO_CONTENT_TYPE      = \\\"bookmarks/contentType\\\";\\n \\n const MAX_SUMMARY_LENGTH = 4096;\\n \\n@@ -224,13 +224,13 @@ MicrosummaryService.prototype = {\\n       var bookmarkID = bookmarks[i];\\n \\n       // Skip this page if its microsummary hasn't expired yet.\\n-      if (this._hasField(bookmarkID, FIELD_MICSUM_EXPIRATION) &&\\n-          this._getField(bookmarkID, FIELD_MICSUM_EXPIRATION) > now)\\n+      if (this._ans.itemHasAnnotation(bookmarkID, ANNO_MICSUM_EXPIRATION) &&\\n+          this._ans.getItemAnnotation(bookmarkID, ANNO_MICSUM_EXPIRATION) > now)\\n         continue;\\n \\n       // Reset the expiration time immediately, so if the refresh is failing\\n       // we don't try it every 15 seconds, potentially overloading the server.\\n-      this._setField(bookmarkID, FIELD_MICSUM_EXPIRATION, now + updateInterval);\\n+      this._setAnnotation(bookmarkID, ANNO_MICSUM_EXPIRATION, now + updateInterval);\\n \\n       // Try to update the microsummary, but trap errors, so an update\\n       // that throws doesn't prevent us from updating the rest of them.\\n@@ -254,18 +254,18 @@ MicrosummaryService.prototype = {\\n   },\\n \\n   _updateMicrosummary: function MSS__updateMicrosummary(bookmarkID, microsummary) {\\n-    var title = this._getTitle(bookmarkID);\\n+    var title = this._bms.getItemTitle(bookmarkID);\\n \\n     // Ensure the user-given title is cached\\n-    if (!this._hasField(bookmarkID, FIELD_STATIC_TITLE))\\n-      this._setField(bookmarkID, FIELD_STATIC_TITLE, title);\\n+    if (!this._ans.itemHasAnnotation(bookmarkID, ANNO_STATIC_TITLE))\\n+      this._setAnnotation(bookmarkID, ANNO_STATIC_TITLE, title);\\n \\n     // A string identifying the bookmark to use when logging the update.\\n     var bookmarkIdentity = bookmarkID;\\n \\n     // Update if the microsummary differs from the current title.\\n     if (!title || title != microsummary.content) {\\n-      this._setTitle(bookmarkID, microsummary.content);\\n+      this._bms.setItemTitle(bookmarkID, microsummary.content);\\n       var subject = new LiveTitleNotificationSubject(bookmarkID, microsummary);\\n       LOG(\\\"updated live title for \\\" + bookmarkIdentity +\\n           \\\" from '\\\" + (title == null ? \\\"<no live title>\\\" : title) +\\n@@ -280,8 +280,8 @@ MicrosummaryService.prototype = {\\n     // to the update interval, since the interval represents how long to wait\\n     // before checking again for updates, and that can vary across updates,\\n     // even when the title itself hasn't changed.\\n-    this._setField(bookmarkID, FIELD_MICSUM_EXPIRATION,\\n-                   Date.now() + (microsummary.updateInterval || this._updateInterval));\\n+    this._setAnnotation(bookmarkID, ANNO_MICSUM_EXPIRATION,\\n+                  Date.now() + (microsummary.updateInterval || this._updateInterval));\\n   },\\n \\n   /**\\n@@ -494,7 +494,7 @@ MicrosummaryService.prototype = {\\n         // If this is the current microsummary for this bookmark, load the content\\n         // from the datastore so it shows up immediately in microsummary picking UI.\\n         if (bookmarkID != -1 && this.isMicrosummary(bookmarkID, microsummary))\\n-          microsummary._content = this._getTitle(bookmarkID);\\n+          microsummary._content = this._bms.getItemTitle(bookmarkID);\\n \\n         microsummaries.AppendElement(microsummary);\\n       }\\n@@ -557,9 +557,9 @@ MicrosummaryService.prototype = {\\n     for ( var i = 0; i < bookmarks.length; i++ ) {\\n       var bookmarkID = bookmarks[i];\\n \\n-      if (this._hasField(bookmarkID, fieldName) &&\\n-          this._getField(bookmarkID, fieldName) == oldValue)\\n-        this._setField(bookmarkID, fieldName, newValue);\\n+      if (this._ans.itemHasAnnotation(bookmarkID, fieldName) &&\\n+          this._ans.getItemAnnotation(bookmarkID, fieldName) == oldValue)\\n+        this._setAnnotation(bookmarkID, fieldName, newValue);\\n     }\\n   },\\n \\n@@ -578,7 +578,7 @@ MicrosummaryService.prototype = {\\n \\n     // This try/catch block is a temporary workaround for bug 336194.\\n     try {\\n-      bookmarks = this._ans.getItemsWithAnnotation(FIELD_MICSUM_GEN_URI, {});\\n+      bookmarks = this._ans.getItemsWithAnnotation(ANNO_MICSUM_GEN_URI, {});\\n     }\\n     catch(e) {\\n       bookmarks = [];\\n@@ -587,11 +587,7 @@ MicrosummaryService.prototype = {\\n     return bookmarks;\\n   },\\n \\n-  _getField: function MSS__getField(aBookmarkId, aFieldName) {\\n-    return this._ans.getItemAnnotation(aBookmarkId, aFieldName);\\n-  },\\n-\\n-  _setField: function MSS__setField(aBookmarkId, aFieldName, aFieldValue) {\\n+  _setAnnotation: function MSS__setAnnotation(aBookmarkId, aFieldName, aFieldValue) {\\n     this._ans.setItemAnnotation(aBookmarkId,\\n                                 aFieldName,\\n                                 aFieldValue,\\n@@ -599,26 +595,6 @@ MicrosummaryService.prototype = {\\n                                 this._ans.EXPIRE_NEVER);\\n   },\\n \\n-  _getTitle: function MSS_getTitle(aBookmarkId) {\\n-    return this._bms.getItemTitle(aBookmarkId);\\n-  },\\n-\\n-  _setTitle: function MSS_setTitle(aBookmarkId, aValue) {\\n-    this._bms.setItemTitle(aBookmarkId, aValue);\\n-  },\\n-\\n-  _clearField: function MSS__clearField(aBookmarkId, aFieldName) {\\n-    this._ans.removeItemAnnotation(aBookmarkId, aFieldName);\\n-  },\\n-\\n-  _hasField: function MSS__hasField(aBookmarkId, fieldName) {\\n-    return this._ans.itemHasAnnotation(aBookmarkId, fieldName);\\n-  },\\n-\\n-  _getPageForBookmark: function MSS__getPageForBookmark(aBookmarkId) {\\n-    return this._bms.getBookmarkURI(aBookmarkId);\\n-  },\\n-\\n   /**\\n    * Get the set of bookmarks with microsummaries.\\n    *\\n@@ -647,8 +623,9 @@ MicrosummaryService.prototype = {\\n     if (!this.hasMicrosummary(bookmarkID))\\n       return null;\\n \\n-    var pageURI = this._getPageForBookmark(bookmarkID);\\n-    var generatorURI = this._uri(this._getField(bookmarkID, FIELD_MICSUM_GEN_URI));\\n+    var pageURI = this._bms.getBookmarkURI(bookmarkID);\\n+    var generatorURI = this._uri(this._ans.getItemAnnotation(bookmarkID,\\n+                                                             ANNO_MICSUM_GEN_URI));\\n     var generator = this.getGenerator(generatorURI);\\n \\n     return new Microsummary(pageURI, generator);\\n@@ -682,15 +659,12 @@ MicrosummaryService.prototype = {\\n    *\\n    */\\n   setMicrosummary: function MSS_setMicrosummary(bookmarkID, microsummary) {\\n-    this._setField(bookmarkID, FIELD_MICSUM_GEN_URI, microsummary.generator.uri.spec);\\n+    this._setAnnotation(bookmarkID, ANNO_MICSUM_GEN_URI, microsummary.generator.uri.spec);\\n \\n-    if (microsummary.content) {\\n+    if (microsummary.content)\\n       this._updateMicrosummary(bookmarkID, microsummary);\\n-    }\\n-    else {\\n-      // Use the bookmark's title for now and attempt an update\\n+    else\\n       this.refreshMicrosummary(bookmarkID);\\n-    }\\n   },\\n \\n   /**\\n@@ -702,18 +676,18 @@ MicrosummaryService.prototype = {\\n    */\\n   removeMicrosummary: function MSS_removeMicrosummary(bookmarkID) {\\n     // Restore the user's title\\n-    if (this._hasField(bookmarkID, FIELD_STATIC_TITLE))\\n-      this._setTitle(bookmarkID, this._getField(bookmarkID, FIELD_STATIC_TITLE));\\n+    if (this._ans.itemHasAnnotation(bookmarkID, ANNO_STATIC_TITLE))\\n+      this._bms.setItemTitle(bookmarkID, this._ans.getItemAnnotation(bookmarkID, ANNO_STATIC_TITLE));\\n \\n-    var fields = [FIELD_MICSUM_GEN_URI,\\n-                  FIELD_MICSUM_EXPIRATION,\\n-                  FIELD_STATIC_TITLE,\\n-                  FIELD_CONTENT_TYPE];\\n+    var fields = [ANNO_MICSUM_GEN_URI,\\n+                  ANNO_MICSUM_EXPIRATION,\\n+                  ANNO_STATIC_TITLE,\\n+                  ANNO_CONTENT_TYPE];\\n \\n     for (let i = 0; i < fields.length; i++) {\\n       var field = fields[i];\\n-      if (this._hasField(bookmarkID, field))\\n-        this._clearField(bookmarkID, field);\\n+      if (this._ans.itemHasAnnotation(bookmarkID, field))\\n+        this._ans.removeItemAnnotation(bookmarkID, field);\\n     }\\n   },\\n \\n@@ -728,7 +702,7 @@ MicrosummaryService.prototype = {\\n    *\\n    */\\n   hasMicrosummary: function MSS_hasMicrosummary(bookmarkID) {\\n-    return this._hasField(bookmarkID, FIELD_MICSUM_GEN_URI);\\n+    return this._ans.itemHasAnnotation(bookmarkID, ANNO_MICSUM_GEN_URI);\\n   },\\n \\n   /**\\n@@ -779,10 +753,11 @@ MicrosummaryService.prototype = {\\n     if (!this.hasMicrosummary(bookmarkID))\\n       throw \\\"bookmark \\\" + bookmarkID + \\\" does not have a microsummary\\\";\\n \\n-    var pageURI = this._getPageForBookmark(bookmarkID);\\n+    var pageURI = this._bms.getBookmarkURI(bookmarkID);\\n     if (!pageURI)\\n       throw(\\\"can't get URL for bookmark with ID \\\" + bookmarkID);\\n-    var generatorURI = this._uri(this._getField(bookmarkID, FIELD_MICSUM_GEN_URI));\\n+    var generatorURI = this._uri(this._ans.getItemAnnotation(bookmarkID,\\n+                                                             ANNO_MICSUM_GEN_URI));\\n \\n     var generator = this._localGenerators[generatorURI.spec] ||\\n                     new MicrosummaryGenerator(generatorURI);\\n\""}