{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basc3e5ad3\""},"diff":"\"c3e5ad3 Bug 367907: allow printing to PDF file on gtk2-cairo, p=chpe, r=pavlov, sr=roc, a=pavlov\\ndiff --git a/widget/src/gtk2/nsDeviceContextSpecG.cpp b/widget/src/gtk2/nsDeviceContextSpecG.cpp\\nindex b1b464e..6165515 100644\\n--- a/widget/src/gtk2/nsDeviceContextSpecG.cpp\\n+++ b/widget/src/gtk2/nsDeviceContextSpecG.cpp\\n@@ -394,12 +394,13 @@ nsDeviceContextSpecGTK::~nsDeviceContextSpecGTK()\\n NS_IMPL_ISUPPORTS1(nsDeviceContextSpecGTK,\\n                    nsIDeviceContextSpec)\\n \\n-//#define USE_PDF 1\\n #include \\\"gfxPDFSurface.h\\\"\\n #include \\\"gfxPSSurface.h\\\"\\n #include \\\"nsUnitConversion.h\\\"\\n NS_IMETHODIMP nsDeviceContextSpecGTK::GetSurfaceForPrinter(gfxASurface **aSurface)\\n {\\n+  *aSurface = nsnull;\\n+\\n   const char *path;\\n   GetPath(&path);\\n \\n@@ -425,15 +426,20 @@ NS_IMETHODIMP nsDeviceContextSpecGTK::GetSurfaceForPrinter(gfxASurface **aSurfac\\n   if (NS_FAILED(rv))\\n     return rv;\\n \\n-#ifdef USE_PDF\\n-  gfxPDFSurface *surface = new gfxPDFSurface(stream, gfxSize(width, height));\\n-#else\\n-  gfxPSSurface *surface = new gfxPSSurface(stream, gfxSize(width, height));\\n-#endif\\n-//  surface->SetDPI(600, 600);\\n-  \\n-  *aSurface = surface;\\n-  NS_ADDREF(*aSurface);\\n+  PRInt16 format;\\n+  mPrintSettings->GetOutputFormat(&format);\\n+\\n+  nsRefPtr<gfxASurface> surface;\\n+  if (nsIPrintSettings::kOutputFormatPDF == format) {\\n+    surface = new gfxPDFSurface(stream, gfxSize(width, height));\\n+  } else {\\n+    surface = new gfxPSSurface(stream, gfxSize(width, height));\\n+  }\\n+\\n+  if (!surface)\\n+    return NS_ERROR_OUT_OF_MEMORY;\\n+\\n+  surface.swap(*aSurface);\\n \\n   return NS_OK;\\n }\\n\""}