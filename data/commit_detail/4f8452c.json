{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas4f8452c\""},"diff":"\"4f8452c Bug 345428 - No spellcheck on focus out, second try, r=Olli.Pettay, r=brettw, a=dsicore\\ndiff --git a/extensions/spellcheck/src/Makefile.in b/extensions/spellcheck/src/Makefile.in\\nindex 7d9fbfd..0ec8c8c 100644\\n--- a/extensions/spellcheck/src/Makefile.in\\n+++ b/extensions/spellcheck/src/Makefile.in\\n@@ -54,6 +54,7 @@ REQUIRES\\t= xpcom \\\\\\n \\t\\t  string \\\\\\n \\t\\t  editor \\\\\\n \\t\\t  content \\\\\\n+\\t\\t  gfx \\\\\\n \\t\\t  layout \\\\\\n \\t\\t  dom \\\\\\n \\t\\t  necko \\\\\\ndiff --git a/extensions/spellcheck/src/mozInlineSpellChecker.cpp b/extensions/spellcheck/src/mozInlineSpellChecker.cpp\\nindex d2ccf21..3dfbcd4 100644\\n--- a/extensions/spellcheck/src/mozInlineSpellChecker.cpp\\n+++ b/extensions/spellcheck/src/mozInlineSpellChecker.cpp\\n@@ -96,6 +96,8 @@\\n #include \\\"nsUnicharUtils.h\\\"\\n #include \\\"nsIContent.h\\\"\\n #include \\\"nsIEventStateManager.h\\\"\\n+#include \\\"nsIEventListenerManager.h\\\"\\n+#include \\\"nsGUIEvent.h\\\"\\n \\n // Set to spew messages to the console about what is happening.\\n //#define DEBUG_INLINESPELL\\n@@ -504,6 +506,7 @@ public:\\n NS_INTERFACE_MAP_BEGIN(mozInlineSpellChecker)\\n NS_INTERFACE_MAP_ENTRY(nsIInlineSpellChecker)\\n NS_INTERFACE_MAP_ENTRY(nsIEditActionListener)\\n+NS_INTERFACE_MAP_ENTRY(nsIDOMFocusListener)\\n NS_INTERFACE_MAP_ENTRY(nsIDOMMouseListener)\\n NS_INTERFACE_MAP_ENTRY(nsISupportsWeakReference)\\n NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIDOMKeyListener)\\n@@ -624,10 +627,19 @@ mozInlineSpellChecker::RegisterEventListeners()\\n \\n   nsCOMPtr<nsIDOMDocument> doc;\\n   nsresult rv = editor->GetDocument(getter_AddRefs(doc));\\n-  NS_ENSURE_SUCCESS(rv, rv); \\n+  NS_ENSURE_SUCCESS(rv, rv);\\n \\n   nsCOMPtr<nsPIDOMEventTarget> piTarget = do_QueryInterface(doc, &rv);\\n-  NS_ENSURE_SUCCESS(rv, rv); \\n+  NS_ENSURE_SUCCESS(rv, rv);\\n+\\n+  nsCOMPtr<nsIEventListenerManager> elmP;\\n+  piTarget->GetListenerManager(PR_TRUE, getter_AddRefs(elmP));\\n+  if (elmP) {\\n+    // Focus event doesn't bubble so adding the listener to capturing phase\\n+    elmP->AddEventListenerByIID(static_cast<nsIDOMFocusListener *>(this),\\n+                                NS_GET_IID(nsIDOMFocusListener),\\n+                                NS_EVENT_FLAG_CAPTURE);\\n+  }\\n \\n   piTarget->AddEventListenerByIID(static_cast<nsIDOMMouseListener*>(this),\\n                                   NS_GET_IID(nsIDOMMouseListener));\\n@@ -654,6 +666,14 @@ mozInlineSpellChecker::UnregisterEventListeners()\\n   nsCOMPtr<nsPIDOMEventTarget> piTarget = do_QueryInterface(doc);\\n   NS_ENSURE_TRUE(piTarget, NS_ERROR_NULL_POINTER);\\n \\n+  nsCOMPtr<nsIEventListenerManager> elmP;\\n+  piTarget->GetListenerManager(PR_TRUE, getter_AddRefs(elmP));\\n+  if (elmP) {\\n+    elmP->RemoveEventListenerByIID(static_cast<nsIDOMFocusListener *>(this),\\n+                                   NS_GET_IID(nsIDOMFocusListener),\\n+                                   NS_EVENT_FLAG_CAPTURE);\\n+  }\\n+\\n   piTarget->RemoveEventListenerByIID(static_cast<nsIDOMMouseListener*>(this),\\n                                      NS_GET_IID(nsIDOMMouseListener));\\n   piTarget->RemoveEventListenerByIID(static_cast<nsIDOMKeyListener*>(this),\\n@@ -1651,6 +1671,18 @@ NS_IMETHODIMP mozInlineSpellChecker::HandleEvent(nsIDOMEvent* aEvent)\\n   return NS_OK;\\n }\\n \\n+NS_IMETHODIMP mozInlineSpellChecker::Focus(nsIDOMEvent* aEvent)\\n+{\\n+  return NS_OK;\\n+}\\n+\\n+NS_IMETHODIMP mozInlineSpellChecker::Blur(nsIDOMEvent* aEvent)\\n+{\\n+  // force spellcheck on blur, for instance when tabbing out of a textbox\\n+  HandleNavigationEvent(aEvent, PR_TRUE);\\n+  return NS_OK;\\n+}\\n+\\n NS_IMETHODIMP mozInlineSpellChecker::MouseClick(nsIDOMEvent *aMouseEvent)\\n {\\n   nsCOMPtr<nsIDOMMouseEvent>mouseEvent = do_QueryInterface(aMouseEvent);\\ndiff --git a/extensions/spellcheck/src/mozInlineSpellChecker.h b/extensions/spellcheck/src/mozInlineSpellChecker.h\\nindex 1e4c2b0..31e2e9d 100644\\n--- a/extensions/spellcheck/src/mozInlineSpellChecker.h\\n+++ b/extensions/spellcheck/src/mozInlineSpellChecker.h\\n@@ -48,6 +48,7 @@\\n #include \\\"nsIDOMTreeWalker.h\\\"\\n #include \\\"nsWeakReference.h\\\"\\n #include \\\"nsIEditor.h\\\"\\n+#include \\\"nsIDOMFocusListener.h\\\"\\n #include \\\"nsIDOMMouseListener.h\\\"\\n #include \\\"nsIDOMKeyListener.h\\\"\\n #include \\\"nsWeakReference.h\\\"\\n@@ -138,7 +139,7 @@ protected:\\n                                     nsIDOMRange** aRange);\\n };\\n \\n-class mozInlineSpellChecker : public nsIInlineSpellChecker, nsIEditActionListener, nsIDOMMouseListener, nsIDOMKeyListener,\\n+class mozInlineSpellChecker : public nsIInlineSpellChecker, nsIEditActionListener, nsIDOMFocusListener, nsIDOMMouseListener, nsIDOMKeyListener,\\n                                      nsSupportsWeakReference\\n {\\n private:\\n@@ -224,6 +225,11 @@ public:\\n   // returns true if it looks likely that we can enable real-time spell checking\\n   static PRBool CanEnableInlineSpellChecking();\\n \\n+  /*BEGIN implementations of focus event handler interface*/\\n+  NS_IMETHOD Focus(nsIDOMEvent* aEvent);\\n+  NS_IMETHOD Blur(nsIDOMEvent* aEvent);\\n+  /*END implementations of focus event handler interface*/\\n+\\n   /*BEGIN implementations of mouseevent handler interface*/\\n   NS_IMETHOD HandleEvent(nsIDOMEvent* aEvent);\\n   NS_IMETHOD MouseDown(nsIDOMEvent* aMouseEvent);\\n\""}