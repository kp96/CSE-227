{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas2efc644\""},"diff":"\"2efc644 Bug 396648. nsPermissionManager tries to open two files that usually don't exist. r/sr=biesi, a=bzbarsky\\ndiff --git a/extensions/cookie/nsPermissionManager.cpp b/extensions/cookie/nsPermissionManager.cpp\\nindex 6407f30..99ef7a2 100644\\n--- a/extensions/cookie/nsPermissionManager.cpp\\n+++ b/extensions/cookie/nsPermissionManager.cpp\\n@@ -636,23 +636,34 @@ nsPermissionManager::Read()\\n   nsresult rv;\\n   \\n   PRBool readingOldFile = PR_FALSE;\\n-\\n   nsCOMPtr<nsIInputStream> fileInputStream;\\n-  rv = NS_NewLocalFileInputStream(getter_AddRefs(fileInputStream), mPermissionsFile);\\n-  if (rv == NS_ERROR_FILE_NOT_FOUND) {\\n+\\n+  PRBool fileExists = PR_FALSE;\\n+  rv = mPermissionsFile->Exists(&fileExists);\\n+  NS_ENSURE_SUCCESS(rv, rv);\\n+\\n+  if (fileExists) {\\n+    rv = NS_NewLocalFileInputStream(getter_AddRefs(fileInputStream),\\n+                                    mPermissionsFile);\\n+  } else {\\n     // Try finding the old-style file\\n \\n     nsCOMPtr<nsIFile> oldPermissionsFile;\\n-    rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR, getter_AddRefs(oldPermissionsFile));\\n+    rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,\\n+                                getter_AddRefs(oldPermissionsFile));\\n     NS_ENSURE_SUCCESS(rv, rv);\\n \\n     rv = oldPermissionsFile->AppendNative(NS_LITERAL_CSTRING(kOldPermissionsFileName));\\n     NS_ENSURE_SUCCESS(rv, rv);\\n \\n-    rv = NS_NewLocalFileInputStream(getter_AddRefs(fileInputStream), oldPermissionsFile);\\n-\\n-    readingOldFile = PR_TRUE;\\n-\\n+    rv = oldPermissionsFile->Exists(&fileExists);\\n+    if (NS_SUCCEEDED(rv) && fileExists) {\\n+      rv = NS_NewLocalFileInputStream(getter_AddRefs(fileInputStream),\\n+                                      oldPermissionsFile);\\n+      readingOldFile = PR_TRUE;\\n+    } else {\\n+      rv = NS_ERROR_FILE_NOT_FOUND;\\n+    }\\n     /* old format is:\\n      * host \\\\t number permission \\\\t number permission ... \\\\n\\n      * if this format isn't respected we move onto the next line in the file.\\n\""}