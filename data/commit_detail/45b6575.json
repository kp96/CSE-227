{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas45b6575\""},"diff":"\"45b6575 Bug 392807 - Severe performance degradation loading file listings p=Dao Gottwald <dao@design-noir.de> r+sr+a=bz\\ndiff --git a/netwerk/streamconv/converters/nsIndexedToHTML.cpp b/netwerk/streamconv/converters/nsIndexedToHTML.cpp\\nindex 00a8cca..eff353b 100644\\n--- a/netwerk/streamconv/converters/nsIndexedToHTML.cpp\\n+++ b/netwerk/streamconv/converters/nsIndexedToHTML.cpp\\n@@ -391,7 +391,6 @@ nsIndexedToHTML::OnStartRequest(nsIRequest* request, nsISupports *aContext) {\\n                              \\\"    headCells[i].appendChild(anchor);\\\\n\\\"\\n                              \\\"    headCells[i].addEventListener(\\\\\\\"click\\\\\\\", rowAction(i), true);\\\\n\\\"\\n                              \\\"  }\\\\n\\\"\\n-                             \\\"  gOrderBy = gTable.getAttribute(\\\\\\\"order-by\\\\\\\");\\\\n\\\"\\n                              \\\"  gRows = [];\\\\n\\\"\\n                              \\\"  for (var row, i = gTBody.rows.length - 1; i >= 0; i--) {\\\\n\\\"\\n                              \\\"    row = gTBody.rows[i];\\\\n\\\"\\n@@ -399,8 +398,7 @@ nsIndexedToHTML::OnStartRequest(nsIRequest* request, nsISupports *aContext) {\\n                              \\\"    if (gUI_showHidden && !hiddenObjects)\\\\n\\\"\\n                              \\\"      hiddenObjects = (row.className == \\\\\\\"hidden-object\\\\\\\");\\\\n\\\"\\n                              \\\"  }\\\\n\\\"\\n-                             \\\"  gRows.sort(compareRows);\\\\n\\\"\\n-                             \\\"  orderBy(gOrderBy);\\\\n\\\"\\n+                             \\\"  gTable.setAttribute(\\\\\\\"order\\\\\\\", \\\\\\\"\\\\\\\");\\\\n\\\"\\n                              \\\"  if (hiddenObjects) {\\\\n\\\"\\n                              \\\"    gUI_showHidden.style.display = \\\\\\\"block\\\\\\\";\\\\n\\\"\\n                              \\\"    updateHidden();\\\\n\\\"\\n@@ -434,6 +432,7 @@ nsIndexedToHTML::OnStartRequest(nsIRequest* request, nsISupports *aContext) {\\n                              \\\"    gTable.setAttribute(\\\\\\\"order-by\\\\\\\", column);\\\\n\\\"\\n                              \\\"    gRows.sort(compareRows);\\\\n\\\"\\n                              \\\"  }\\\\n\\\"\\n+                             \\\"  gTable.removeChild(gTBody);\\\\n\\\"\\n                              \\\"  gTable.setAttribute(\\\\\\\"order\\\\\\\", order);\\\\n\\\"\\n                              \\\"  if (order == \\\\\\\"asc\\\\\\\")\\\\n\\\"\\n                              \\\"    for (var i = 0; i < gRows.length; i++)\\\\n\\\"\\n@@ -441,6 +440,7 @@ nsIndexedToHTML::OnStartRequest(nsIRequest* request, nsISupports *aContext) {\\n                              \\\"  else\\\\n\\\"\\n                              \\\"    for (var i = gRows.length - 1; i >= 0; i--)\\\\n\\\"\\n                              \\\"      gTBody.appendChild(gRows[i]);\\\\n\\\"\\n+                             \\\"  gTable.appendChild(gTBody);\\\\n\\\"\\n                              \\\"}\\\\n\\\"\\n                              \\\"function updateHidden() {\\\\n\\\"\\n                              \\\"  gTable.className = gUI_showHidden.getElementsByTagName(\\\\\\\"input\\\\\\\")[0].checked ?\\\\n\\\"\\n@@ -610,9 +610,9 @@ nsIndexedToHTML::OnStartRequest(nsIRequest* request, nsISupports *aContext) {\\n         buffer.AppendLiteral(\\\"</label></p>\\\\n\\\");\\n     }\\n \\n-    if (!isSchemeGopher) {\\n-        buffer.AppendLiteral(\\\"<table order-by=\\\\\\\"0\\\\\\\">\\\\n\\\");\\n+    buffer.AppendLiteral(\\\"<table>\\\\n\\\");\\n \\n+    if (!isSchemeGopher) {\\n         nsXPIDLString columnText;\\n \\n         buffer.AppendLiteral(\\\" <thead>\\\\n\\\"\\n@@ -640,8 +640,6 @@ nsIndexedToHTML::OnStartRequest(nsIRequest* request, nsISupports *aContext) {\\n         buffer.AppendLiteral(\\\"</th>\\\\n\\\"\\n                              \\\"  </tr>\\\\n\\\"\\n                              \\\" </thead>\\\\n\\\");\\n-    } else {\\n-        buffer.AppendLiteral(\\\"<table>\\\\n\\\");\\n     }\\n     buffer.AppendLiteral(\\\" <tbody>\\\\n\\\");\\n \\n@@ -893,7 +891,13 @@ nsIndexedToHTML::OnIndexAvailable(nsIRequest *aRequest,\\n \\n     if (type == nsIDirIndex::TYPE_FILE || type == nsIDirIndex::TYPE_UNKNOWN) {\\n         pushBuffer.AppendLiteral(\\\"<img src=\\\\\\\"moz-icon://\\\");\\n-        AppendUTF8toUTF16(escapeBuf, pushBuffer);\\n+        PRInt32 lastDot = escapeBuf.RFindChar('.');\\n+        if (lastDot != kNotFound) {\\n+            escapeBuf.Cut(0, lastDot);\\n+            AppendUTF8toUTF16(escapeBuf, pushBuffer);\\n+        } else {\\n+            pushBuffer.AppendLiteral(\\\"unknown\\\");\\n+        }\\n         pushBuffer.AppendLiteral(\\\"?size=16\\\\\\\" alt=\\\\\\\"\\\");\\n \\n         nsXPIDLString altText;\\n\""}