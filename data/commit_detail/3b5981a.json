{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas3b5981a\""},"diff":"\"3b5981a Bug 392251 - Load extensions from appdir/distribution/bundles, r=mfinkle\\ndiff --git a/toolkit/xre/nsXREDirProvider.cpp b/toolkit/xre/nsXREDirProvider.cpp\\nindex 3fea87e..8504b1b 100644\\n--- a/toolkit/xre/nsXREDirProvider.cpp\\n+++ b/toolkit/xre/nsXREDirProvider.cpp\\n@@ -45,6 +45,7 @@\\n #include \\\"jsapi.h\\\"\\n \\n #include \\\"nsIJSContextStack.h\\\"\\n+#include \\\"nsIDirectoryEnumerator.h\\\"\\n #include \\\"nsILocalFile.h\\\"\\n #include \\\"nsIObserverService.h\\\"\\n #include \\\"nsIProfileChangeStatus.h\\\"\\n@@ -474,7 +475,6 @@ LoadDirsIntoArray(nsIFile* aComponentsList, const char* aSection,\\n   while (PR_TRUE);\\n }\\n \\n-\\n static void\\n LoadAppPlatformDirIntoArray(nsIFile* aXULAppDir,\\n                   const char *const* aAppendList,\\n@@ -538,6 +538,50 @@ LoadAppPlatformDirIntoArray(nsIFile* aXULAppDir,\\n #endif\\n }\\n \\n+static void\\n+LoadAppBundlesIntoArray(nsIFile* aXULAppDir,\\n+                        const char *const* aAppendList,\\n+                        nsCOMArray<nsIFile>& aDirectories)\\n+{\\n+  nsCOMPtr<nsIFile> dir;\\n+  nsresult rv = aXULAppDir->Clone(getter_AddRefs(dir));\\n+  if (NS_FAILED(rv))\\n+    return;\\n+\\n+  dir->AppendNative(NS_LITERAL_CSTRING(\\\"distribution\\\"));\\n+  dir->AppendNative(NS_LITERAL_CSTRING(\\\"bundles\\\"));\\n+\\n+  nsCOMPtr<nsISimpleEnumerator> e;\\n+  rv = dir->GetDirectoryEntries(getter_AddRefs(e));\\n+  if (NS_FAILED(rv))\\n+    return;\\n+\\n+  nsCOMPtr<nsIDirectoryEnumerator> files = do_QueryInterface(e);\\n+  if (!files)\\n+    return;\\n+\\n+  nsCOMPtr<nsIFile> file;\\n+  while (NS_SUCCEEDED(files->GetNextFile(getter_AddRefs(file))) && file) {\\n+    nsCOMPtr<nsIFile> subdir;\\n+    file->Clone(getter_AddRefs(subdir));\\n+    if (!subdir)\\n+      break;\\n+\\n+    const char* const* a = aAppendList;\\n+    while (*a) {\\n+      subdir->AppendNative(nsDependentCString(*a));\\n+      ++a;\\n+    }\\n+    \\n+    PRBool exists;\\n+    rv = subdir->Exists(&exists);\\n+    if (NS_SUCCEEDED(rv) && exists)\\n+      aDirectories.AppendObject(subdir);\\n+\\n+    LoadAppPlatformDirIntoArray(file, aAppendList, aDirectories);\\n+  }\\n+}\\n+\\n static const char *const kAppendChromeManifests[] =\\n   { \\\"chrome.manifest\\\", nsnull };\\n \\n@@ -594,9 +638,14 @@ nsXREDirProvider::GetFilesInternal(const char* aProperty,\\n   if (!strcmp(aProperty, XRE_EXTENSIONS_DIR_LIST)) {\\n     nsCOMArray<nsIFile> directories;\\n     \\n-    if (mProfileDir && !gSafeMode) {\\n-      static const char *const kAppendNothing[] = { nsnull };\\n+    static const char *const kAppendNothing[] = { nsnull };\\n \\n+    if (mXULAppDir) {\\n+      LoadAppPlatformDirIntoArray(mXULAppDir, kAppendNothing, directories);\\n+      LoadAppBundlesIntoArray(mXULAppDir, kAppendNothing, directories);\\n+    }\\n+\\n+    if (mProfileDir && !gSafeMode) {\\n       LoadDirsIntoArray(profileFile, \\\"ExtensionDirs\\\",\\n                         kAppendNothing, directories);\\n     }\\n@@ -616,6 +665,7 @@ nsXREDirProvider::GetFilesInternal(const char* aProperty,\\n         directories.AppendObject(file);\\n \\n        LoadAppPlatformDirIntoArray(mXULAppDir, kAppendCompDir, directories);\\n+       LoadAppBundlesIntoArray(mXULAppDir, kAppendCompDir, directories);\\n     }\\n \\n     if (mProfileDir && !gSafeMode) {\\n@@ -639,6 +689,7 @@ nsXREDirProvider::GetFilesInternal(const char* aProperty,\\n         directories.AppendObject(file);\\n \\n        LoadAppPlatformDirIntoArray(mXULAppDir, kAppendPrefDir, directories);\\n+       LoadAppBundlesIntoArray(mXULAppDir, kAppendPrefDir, directories);\\n     }\\n     \\n     if (mProfileDir) {\\n@@ -679,6 +730,8 @@ nsXREDirProvider::GetFilesInternal(const char* aProperty,\\n \\n       LoadAppPlatformDirIntoArray(mXULAppDir, kAppendChromeManifests,\\n                                   manifests);\\n+      LoadAppBundlesIntoArray(mXULAppDir, kAppendChromeManifests,\\n+                              manifests);\\n     }\\n \\n     if (mProfileDir && !gSafeMode) {\\n@@ -713,6 +766,7 @@ nsXREDirProvider::GetFilesInternal(const char* aProperty,\\n         directories.AppendObject(file);\\n \\n       LoadAppPlatformDirIntoArray(mXULAppDir, kAppendChromeDir, directories);\\n+      LoadAppBundlesIntoArray(mXULAppDir, kAppendChromeDir, directories);\\n     }\\n \\n     if (mProfileDir && !gSafeMode) {\\n@@ -737,6 +791,7 @@ nsXREDirProvider::GetFilesInternal(const char* aProperty,\\n         directories.AppendObject(file);\\n \\n       LoadAppPlatformDirIntoArray(mXULAppDir, kAppendPlugins, directories);\\n+      LoadAppBundlesIntoArray(mXULAppDir, kAppendPlugins, directories);\\n     }\\n \\n     if (mProfileDir && !gSafeMode) {\\n\""}