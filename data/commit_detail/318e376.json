{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas318e376\""},"diff":"\"318e376 Process XBL constructors after processing style reresolves.  In particular, this makes sure that we process the former even if there were none of the latter.  Bug 394676 and bug 394014, r=smaug, sr=sicking, a=roc\\ndiff --git a/layout/base/nsCSSFrameConstructor.cpp b/layout/base/nsCSSFrameConstructor.cpp\\nindex a433661..778ba2d 100644\\n--- a/layout/base/nsCSSFrameConstructor.cpp\\n+++ b/layout/base/nsCSSFrameConstructor.cpp\\n@@ -13020,11 +13020,6 @@ nsCSSFrameConstructor::ProcessPendingRestyles()\\n \\n   delete [] restylesToProcess;\\n \\n-  // Run the XBL binding constructors for any new frames we've constructed.\\n-  // Note that the restyle event is holding a strong ref to us, so we're ok\\n-  // here.\\n-  mDocument->BindingManager()->ProcessAttachedQueue();\\n-\\n   EndUpdate();\\n \\n #ifdef DEBUG\\n@@ -13071,7 +13066,7 @@ NS_IMETHODIMP nsCSSFrameConstructor::RestyleEvent::Run() {\\n   if (!mConstructor)\\n     return NS_OK;  // event was revoked\\n \\n-  nsIViewManager* viewManager =\\n+  nsCOMPtr<nsIViewManager> viewManager =\\n     mConstructor->mPresShell->GetViewManager();\\n   NS_ASSERTION(viewManager, \\\"Must have view manager for update\\\");\\n \\n@@ -13087,6 +13082,7 @@ NS_IMETHODIMP nsCSSFrameConstructor::RestyleEvent::Run() {\\n   mConstructor->mRestyleEvent.Forget();\\n \\n   mConstructor->ProcessPendingRestyles();\\n+  mConstructor->mDocument->BindingManager()->ProcessAttachedQueue();\\n   viewManager->EndUpdateViewBatch(NS_VMREFRESH_NO_SYNC);\\n \\n   return NS_OK;\\ndiff --git a/layout/base/nsCSSFrameConstructor.h b/layout/base/nsCSSFrameConstructor.h\\nindex b9371b8..f88db7b 100644\\n--- a/layout/base/nsCSSFrameConstructor.h\\n+++ b/layout/base/nsCSSFrameConstructor.h\\n@@ -171,8 +171,9 @@ private:\\n public:\\n   // Note: It's the caller's responsibility to make sure to wrap a\\n   // ProcessPendingRestyles call in a view update batch.\\n-  // ProcessPendingRestyles will handle calling ProcessAttachedQueue() on the\\n-  // binding manager.\\n+  // This function does not call ProcessAttachedQueue() on the binding manager.\\n+  // If the caller wants that to happen synchronously, it needs to handle that\\n+  // itself.\\n   void ProcessPendingRestyles();\\n \\n   void PostRestyleEvent(nsIContent* aContent, nsReStyleHint aRestyleHint,\\ndiff --git a/layout/base/nsPresShell.cpp b/layout/base/nsPresShell.cpp\\nindex 696f604..9ab6fad 100644\\n--- a/layout/base/nsPresShell.cpp\\n+++ b/layout/base/nsPresShell.cpp\\n@@ -4418,6 +4418,10 @@ PresShell::DoFlushPendingNotifications(mozFlushType aType,\\n       mFrameConstructor->ProcessPendingRestyles();\\n     }\\n \\n+    if (!mIsDestroying) {\\n+      mDocument->BindingManager()->ProcessAttachedQueue();\\n+    }\\n+\\n     if (aType >= Flush_Layout && !mIsDestroying) {\\n       mFrameConstructor->RecalcQuotesAndCounters();\\n       ProcessReflowCommands(aInterruptibleReflow);\\ndiff --git a/layout/reftests/bugs/394676-1-ref.xhtml b/layout/reftests/bugs/394676-1-ref.xhtml\\nnew file mode 100644\\nindex 0000000..dd5bd0e\\n--- /dev/null\\n+++ b/layout/reftests/bugs/394676-1-ref.xhtml\\n@@ -0,0 +1,6 @@\\n+<html xmlns=\\\"http://www.w3.org/1999/xhtml\\\">\\n+<body>\\n+<span id=\\\"test\\\">constructor onload </span>\\n+</body>\\n+</html>\\n+\\ndiff --git a/layout/reftests/bugs/394676-1.xhtml b/layout/reftests/bugs/394676-1.xhtml\\nnew file mode 100644\\nindex 0000000..fad3ae4\\n--- /dev/null\\n+++ b/layout/reftests/bugs/394676-1.xhtml\\n@@ -0,0 +1,39 @@\\n+<html xmlns=\\\"http://www.w3.org/1999/xhtml\\\" class=\\\"reftest-wait\\\">\\n+<head>\\n+  <bindings xmlns=\\\"http://www.mozilla.org/xbl\\\">\\n+    <binding id=\\\"xbltest\\\">\\n+      <implementation>\\n+        <constructor>\\n+          <![CDATA[\\n+            str += \\\"constructor \\\"\\n+            testFinished();\\n+          ]]>\\n+        </constructor>\\n+      </implementation>\\n+    </binding>\\n+  </bindings>\\n+</head>\\n+<body>\\n+<span id=\\\"test\\\" style=\\\"-moz-binding: url(#xbltest)\\\"></span>\\n+<script class=\\\"testbody\\\" type=\\\"text/javascript\\\">\\n+<![CDATA[\\n+  var testsToFinish = 2;\\n+  var str = \\\"\\\";\\n+  \\n+  function testFinished() {\\n+    --testsToFinish;\\n+    if (!testsToFinish) {\\n+      document.getElementById(\\\"test\\\").textContent = str;\\n+      document.documentElement.className = '';\\n+    }\\n+  }\\n+\\n+  window.onload = function() {\\n+    str += \\\"onload \\\";\\n+    testFinished();\\n+  }\\n+]]>\\n+</script>\\n+</body>\\n+</html>\\n+\\ndiff --git a/layout/reftests/bugs/reftest.list b/layout/reftests/bugs/reftest.list\\nindex 5278448..85471b8 100644\\n--- a/layout/reftests/bugs/reftest.list\\n+++ b/layout/reftests/bugs/reftest.list\\n@@ -378,3 +378,4 @@ random-if(MOZ_WIDGET_TOOLKIT==\\\"cocoa\\\") == 379316-2.html 379316-2-ref.html # bug\\n == 393671-3.html 393671-3-ref.html\\n == 394111-1.html about:blank  # Really an assertion test rather than a rendering test\\n == 394534-1.html 394534-1-ref.html\\n+== 394676-1.xhtml 394676-1-ref.xhtml\\n\""}