{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas7383100\""},"diff":"\"7383100 Bug 391514 - Login Manager gets confused with password/PIN on usaa.com. r=gavin\\ndiff --git a/toolkit/components/passwordmgr/src/nsLoginManager.js b/toolkit/components/passwordmgr/src/nsLoginManager.js\\nindex 0181a0e..a8f6c69 100644\\n--- a/toolkit/components/passwordmgr/src/nsLoginManager.js\\n+++ b/toolkit/components/passwordmgr/src/nsLoginManager.js\\n@@ -913,10 +913,11 @@ LoginManager.prototype = {\\n             // Only the actionOrigin might be changing, so if it's the same\\n             // as the last form on the page we can reuse the same logins.\\n             if (actionOrigin != previousActionOrigin) {\\n-                var logins =\\n+                var foundLogins =\\n                     this.findLogins({}, formOrigin, actionOrigin, null);\\n \\n-                this.log(\\\"form[\\\" + i + \\\"]: got \\\" + logins.length + \\\" logins.\\\");\\n+                this.log(\\\"form[\\\" + i + \\\"]: got \\\" +\\n+                         foundLogins.length + \\\" logins.\\\");\\n \\n                 previousActionOrigin = actionOrigin;\\n             } else {\\n@@ -924,6 +925,29 @@ LoginManager.prototype = {\\n             }\\n \\n \\n+            // Discard logins which have username/password values that don't\\n+            // fit into the fields (as specified by the maxlength attribute).\\n+            // The user couldn't enter these values anyway, and it helps\\n+            // with sites that have an extra PIN to be entered (bug 391514)\\n+            var maxUsernameLen = Number.MAX_VALUE;\\n+            var maxPasswordLen = Number.MAX_VALUE;\\n+\\n+            // If attribute wasn't set, default is -1.\\n+            if (usernameField && usernameField.maxLength >= 0)\\n+                maxUsernameLen = usernameField.maxLength;\\n+            if (passwordField.maxLength >= 0)\\n+                maxPasswordLen = passwordField.maxLength;\\n+\\n+            logins = foundLogins.filter(function (l) {\\n+                    var fit = (l.username.length <= maxUsernameLen &&\\n+                               l.password.length <= maxPasswordLen);\\n+                    if (!fit)\\n+                        this.log(\\\"Ignored \\\" + l.username + \\\" login: won't fit\\\");\\n+\\n+                    return fit;\\n+                }, this);\\n+\\n+\\n             // Nothing to do if we have no matching logins available.\\n             if (logins.length == 0)\\n                 continue;\\n@@ -943,13 +967,13 @@ LoginManager.prototype = {\\n                 if (usernameField && usernameField.value) {\\n                     var username = usernameField.value;\\n \\n-                    var foundLogin;\\n+                    var matchingLogin;\\n                     var found = logins.some(function(l) {\\n-                                                foundLogin = l;\\n+                                                matchingLogin = l;\\n                                                 return (l.username == username);\\n                                             });\\n                     if (found)\\n-                        passwordField.value = foundLogin.password;\\n+                        passwordField.value = matchingLogin.password;\\n \\n                 } else if (logins.length == 1) {\\n                     if (usernameField)\\ndiff --git a/toolkit/components/passwordmgr/test/Makefile.in b/toolkit/components/passwordmgr/test/Makefile.in\\nindex dc377be..4bd037a 100644\\n--- a/toolkit/components/passwordmgr/test/Makefile.in\\n+++ b/toolkit/components/passwordmgr/test/Makefile.in\\n@@ -61,6 +61,7 @@ MOCHI_TESTS = \\\\\\n \\t\\ttest_bug_242956.html \\\\\\n \\t\\ttest_bug_360493_1.html \\\\\\n \\t\\ttest_bug_360493_2.html \\\\\\n+\\t\\ttest_bug_391514.html \\\\\\n \\t\\t$(NULL)\\n \\n XPCSHELL_TESTS  = unit\\ndiff --git a/toolkit/components/passwordmgr/test/test_bug_391514.html b/toolkit/components/passwordmgr/test/test_bug_391514.html\\nnew file mode 100644\\nindex 0000000..2749575\\n--- /dev/null\\n+++ b/toolkit/components/passwordmgr/test/test_bug_391514.html\\n@@ -0,0 +1,139 @@\\n+<!DOCTYPE HTML>\\n+<html>\\n+<head>\\n+  <title>Test for Login Manager</title>\\n+  <script type=\\\"text/javascript\\\" src=\\\"/MochiKit/MochiKit.js\\\"></script>\\n+  <script type=\\\"text/javascript\\\" src=\\\"/tests/SimpleTest/SimpleTest.js\\\"></script>  \\n+  <script type=\\\"text/javascript\\\" src=\\\"pwmgr_common.js\\\"></script>\\n+  <link rel=\\\"stylesheet\\\" type=\\\"text/css\\\" href=\\\"/tests/SimpleTest/test.css\\\" />\\n+</head>\\n+<body>\\n+Login Manager test: 391514\\n+<p id=\\\"display\\\"></p>\\n+<div id=\\\"content\\\" style=\\\"display: none\\\">\\n+  <!-- normal form. -->\\n+  <form id=\\\"form1\\\" action=\\\"formtest.js\\\">\\n+    <input  type=\\\"text\\\"     name=\\\"uname\\\">\\n+    <input  type=\\\"password\\\" name=\\\"pword\\\">\\n+\\n+    <button type=\\\"submit\\\">Submit</button>\\n+    <button type=\\\"reset\\\"> Reset </button>\\n+  </form>\\n+\\n+  <!-- limited username -->\\n+  <form id=\\\"form2\\\" action=\\\"formtest.js\\\">\\n+    <input  type=\\\"text\\\"     name=\\\"uname\\\" maxlength=\\\"4\\\">\\n+    <input  type=\\\"password\\\" name=\\\"pword\\\">\\n+  </form>\\n+\\n+  <!-- limited password -->\\n+  <form id=\\\"form3\\\" action=\\\"formtest.js\\\">\\n+    <input  type=\\\"text\\\"     name=\\\"uname\\\">\\n+    <input  type=\\\"password\\\" name=\\\"pword\\\" maxlength=\\\"4\\\">\\n+  </form>\\n+\\n+  <!-- limited username and password -->\\n+  <form id=\\\"form4\\\" action=\\\"formtest.js\\\">\\n+    <input  type=\\\"text\\\"     name=\\\"uname\\\" maxlength=\\\"4\\\">\\n+    <input  type=\\\"password\\\" name=\\\"pword\\\" maxlength=\\\"4\\\">\\n+  </form>\\n+\\n+\\n+  <!-- limited username -->\\n+  <form id=\\\"form5\\\" action=\\\"formtest.js\\\">\\n+    <input  type=\\\"text\\\"     name=\\\"uname\\\" maxlength=\\\"0\\\">\\n+    <input  type=\\\"password\\\" name=\\\"pword\\\">\\n+  </form>\\n+\\n+  <!-- limited password -->\\n+  <form id=\\\"form6\\\" action=\\\"formtest.js\\\">\\n+    <input  type=\\\"text\\\"     name=\\\"uname\\\">\\n+    <input  type=\\\"password\\\" name=\\\"pword\\\" maxlength=\\\"0\\\">\\n+  </form>\\n+\\n+  <!-- limited username and password -->\\n+  <form id=\\\"form7\\\" action=\\\"formtest.js\\\">\\n+    <input  type=\\\"text\\\"     name=\\\"uname\\\" maxlength=\\\"0\\\">\\n+    <input  type=\\\"password\\\" name=\\\"pword\\\" maxlength=\\\"0\\\">\\n+  </form>\\n+\\n+\\n+  <!-- limited, but ok, username -->\\n+  <form id=\\\"form8\\\" action=\\\"formtest.js\\\">\\n+    <input  type=\\\"text\\\"     name=\\\"uname\\\" maxlength=\\\"999\\\">\\n+    <input  type=\\\"password\\\" name=\\\"pword\\\">\\n+  </form>\\n+\\n+  <!-- limited, but ok, password -->\\n+  <form id=\\\"form9\\\" action=\\\"formtest.js\\\">\\n+    <input  type=\\\"text\\\"     name=\\\"uname\\\">\\n+    <input  type=\\\"password\\\" name=\\\"pword\\\" maxlength=\\\"999\\\">\\n+  </form>\\n+\\n+  <!-- limited, but ok, username and password -->\\n+  <form id=\\\"form10\\\" action=\\\"formtest.js\\\">\\n+    <input  type=\\\"text\\\"     name=\\\"uname\\\" maxlength=\\\"999\\\">\\n+    <input  type=\\\"password\\\" name=\\\"pword\\\" maxlength=\\\"999\\\">\\n+  </form>\\n+\\n+\\n+  <!-- limited, but ok, username -->\\n+  <!-- (note that filled values are exactly 8 characters) -->\\n+  <form id=\\\"form11\\\" action=\\\"formtest.js\\\">\\n+    <input  type=\\\"text\\\"     name=\\\"uname\\\" maxlength=\\\"8\\\">\\n+    <input  type=\\\"password\\\" name=\\\"pword\\\">\\n+  </form>\\n+\\n+  <!-- limited, but ok, password -->\\n+  <!-- (note that filled values are exactly 8 characters) -->\\n+  <form id=\\\"form12\\\" action=\\\"formtest.js\\\">\\n+    <input  type=\\\"text\\\"     name=\\\"uname\\\">\\n+    <input  type=\\\"password\\\" name=\\\"pword\\\" maxlength=\\\"8\\\">\\n+  </form>\\n+\\n+  <!-- limited, but ok, username and password -->\\n+  <!-- (note that filled values are exactly 8 characters) -->\\n+  <form id=\\\"form13\\\" action=\\\"formtest.js\\\">\\n+    <input  type=\\\"text\\\"     name=\\\"uname\\\" maxlength=\\\"8\\\">\\n+    <input  type=\\\"password\\\" name=\\\"pword\\\" maxlength=\\\"8\\\">\\n+  </form>\\n+\\n+</div>\\n+<pre id=\\\"test\\\">\\n+<script class=\\\"testbody\\\" type=\\\"text/javascript\\\">\\n+\\n+/* Test for Login Manager: 391514 (Login Manager gets confused with\\n+ * password/PIN on usaa.com)\\n+ */\\n+\\n+function startTest() {\\n+  var i;\\n+\\n+  is($_(1, \\\"uname\\\").value, \\\"testuser\\\", \\\"Checking for filled username 1\\\");\\n+  is($_(1, \\\"pword\\\").value, \\\"testpass\\\", \\\"Checking for filled password 1\\\");\\n+\\n+  for (i = 2; i < 8; i++) {\\n+    is($_(i, \\\"uname\\\").value, \\\"\\\", \\\"Checking for unfilled username \\\" + i);\\n+    is($_(i, \\\"pword\\\").value, \\\"\\\", \\\"Checking for unfilled password \\\" + i);\\n+  }\\n+\\n+  for (i = 8; i < 14; i++) {\\n+    is($_(i, \\\"uname\\\").value, \\\"testuser\\\", \\\"Checking for filled username \\\" + i);\\n+    is($_(i, \\\"pword\\\").value, \\\"testpass\\\", \\\"Checking for filled password \\\" + i);\\n+  }\\n+\\n+  // Note that tests 11-13 are limited to exactly the expected value.\\n+  // Assert this lest someone change the login we're testing with.\\n+  is($_(11, \\\"uname\\\").value.length, 8, \\\"asserting test assumption is valid.\\\");\\n+\\n+  SimpleTest.finish();\\n+}\\n+\\n+window.onload = startTest;\\n+\\n+SimpleTest.waitForExplicitFinish();\\n+\\n+</script>\\n+</pre>\\n+</body>\\n+</html>\\n\""}