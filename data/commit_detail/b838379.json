{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basb838379\""},"diff":"\"b838379 bug 396610: make it possible once again to disable user configuration of handlers; r=gavin, a=mconnor\\ndiff --git a/browser/components/preferences/applications.js b/browser/components/preferences/applications.js\\nindex 149b329..8a7ac6c 100755\\n--- a/browser/components/preferences/applications.js\\n+++ b/browser/components/preferences/applications.js\\n@@ -919,9 +919,9 @@ var gApplicationsPane = {\\n       item.setAttribute(\\\"actionIcon\\\",\\n                         this._getIconURLForPreferredAction(visibleType));\\n       this._list.appendChild(item);\\n-      if (visibleType.type == this._list.getAttribute(\\\"lastSelectedType\\\"))\\n-        this._list.selectedItem = item;\\n     }\\n+\\n+    this._selectLastSelectedType();\\n   },\\n \\n   _getVisibleTypes: function() {\\n@@ -1036,6 +1036,25 @@ var gApplicationsPane = {\\n     }\\n   },\\n \\n+  _selectLastSelectedType: function() {\\n+    // If the list is disabled by the pref.downloads.disable_button.edit_actions\\n+    // preference being locked, then don't select the type, as that would cause\\n+    // it to appear selected, with a different background and an actions menu\\n+    // that makes it seem like you can choose an action for the type.\\n+    if (this._list.disabled)\\n+      return;\\n+\\n+    var lastSelectedType = this._list.getAttribute(\\\"lastSelectedType\\\");\\n+    if (!lastSelectedType)\\n+      return;\\n+\\n+    var item = this._list.getElementsByAttribute(\\\"type\\\", lastSelectedType)[0];\\n+    if (!item)\\n+      return;\\n+\\n+    this._list.selectedItem = item;\\n+  },\\n+\\n   /**\\n    * Whether or not the given handler app is valid.\\n    *\\n@@ -1382,8 +1401,9 @@ var gApplicationsPane = {\\n   // Mark which item in the list was last selected so we can reselect it\\n   // when we rebuild the list or when the user returns to the prefpane.\\n   onSelectionChanged: function() {\\n-    this._list.setAttribute(\\\"lastSelectedType\\\",\\n-                            this._list.selectedItem.getAttribute(\\\"type\\\"));\\n+    if (this._list.selectedItem)\\n+      this._list.setAttribute(\\\"lastSelectedType\\\",\\n+                              this._list.selectedItem.getAttribute(\\\"type\\\"));\\n   },\\n \\n   _getIconURLForPreferredAction: function(aHandlerInfo) {\\ndiff --git a/browser/components/preferences/applications.xul b/browser/components/preferences/applications.xul\\nindex 0452003..335309c 100755\\n--- a/browser/components/preferences/applications.xul\\n+++ b/browser/components/preferences/applications.xul\\n@@ -69,6 +69,9 @@\\n       <preference id=\\\"browser.feeds.handlers.webservice\\\"\\n                   name=\\\"browser.feeds.handlers.webservice\\\"\\n                   type=\\\"string\\\"/>\\n+      <preference id=\\\"pref.downloads.disable_button.edit_actions\\\"\\n+                  name=\\\"pref.downloads.disable_button.edit_actions\\\"\\n+                  type=\\\"bool\\\"/>\\n     </preferences>\\n \\n     <script type=\\\"application/x-javascript\\\" src=\\\"chrome://browser/content/preferences/applications.js\\\"/>\\n@@ -88,9 +91,9 @@\\n \\n     <separator class=\\\"thin\\\"/>\\n \\n-    <richlistbox id=\\\"handlersView\\\" orient=\\\"vertical\\\"\\n-                 onselect=\\\"gApplicationsPane.onSelectionChanged();\\\"\\n-                 persist=\\\"lastSelectedType\\\">\\n+    <richlistbox id=\\\"handlersView\\\" orient=\\\"vertical\\\" persist=\\\"lastSelectedType\\\"\\n+                 preference=\\\"pref.downloads.disable_button.edit_actions\\\"\\n+                 onselect=\\\"gApplicationsPane.onSelectionChanged();\\\">\\n       <listheader equalsize=\\\"always\\\" style=\\\"border: 0; padding: 0;\\\">\\n         <treecol id=\\\"typeColumn\\\" label=\\\"&typeColumn.label;\\\" value=\\\"type\\\"\\n                  accesskey=\\\"&typeColumn.accesskey;\\\" persist=\\\"sortDirection\\\"\\n\""}