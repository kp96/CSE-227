{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Bas2599d5e\""},"diff":"\"2599d5e Override fLinkBefore except for the first range of an item, and fLinkAfter except for the last range. Bug 391045, r+a=pavlov\\ndiff --git a/gfx/thebes/src/gfxWindowsFonts.cpp b/gfx/thebes/src/gfxWindowsFonts.cpp\\nindex 053aec9..dac48fc 100644\\n--- a/gfx/thebes/src/gfxWindowsFonts.cpp\\n+++ b/gfx/thebes/src/gfxWindowsFonts.cpp\\n@@ -35,9 +35,6 @@\\n  * the terms of any one of the MPL, the GPL or the LGPL.\\n  *\\n  * ***** END LICENSE BLOCK ***** */\\n-#ifdef DEBUG_smontagu\\n-#define DEBUG_pavlov\\n-#endif\\n \\n //#define FORCE_UNISCRIBE 1\\n #define FORCE_PR_LOG\\n@@ -919,12 +916,26 @@ public:\\n \\n         const PRUnichar *str = mAlternativeString ? mAlternativeString : mRangeString;\\n \\n+        SCRIPT_ANALYSIS sa = mScriptItem->a;\\n+        sa.fLogicalOrder = PR_TRUE;\\n+        /*\\n+          fLinkBefore and fLinkAfter in the SCRIPT_ANALYSIS structure refer to\\n+          the whole item, so if the current range begins after the beginning\\n+          of the item or ends before the end of the item, we need to override\\n+          them here.\\n+          This assumes that we won't split an item into ranges between two\\n+          characters that need to be shaped together.\\n+        */\\n+        if (mRangeString > mItemString)\\n+            sa.fLinkBefore = PR_FALSE;\\n+        if (mRangeString + mRangeLength < mItemString + mItemLength)\\n+            sa.fLinkAfter = PR_FALSE;\\n+\\n         while (PR_TRUE) {\\n-            mScriptItem->a.fLogicalOrder = PR_TRUE;\\n \\n             rv = ScriptShape(shapeDC, mCurrentFont->ScriptCache(),\\n                              str, mRangeLength,\\n-                             mMaxGlyphs, &mScriptItem->a,\\n+                             mMaxGlyphs, &sa,\\n                              mGlyphs, mClusters,\\n                              mAttr, &mNumGlyphs);\\n \\n\""}