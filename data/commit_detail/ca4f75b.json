{"sha":"\"47e7bc67f932866e4467f7ab8a23bb167405bebd\"","commit":{"author":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"committer":{"name":"\"Nicolas Silva\"","email":"\"nsilva@mozilla.com\"","date":"\"2016-09-01T15:51:09+02:00\""},"message":"\"Bug 1298345 - Refactor CanvasRenderingContext2D's texture allocation code. r=Basca4f75b\""},"diff":"\"ca4f75b Bug 395444 - Fast-path QueryInterface in XPCWrappedNative::CallMethod, r=mrbkap sr=jst a=damons\\ndiff --git a/js/src/xpconnect/src/xpcwrappednative.cpp b/js/src/xpconnect/src/xpcwrappednative.cpp\\nindex e38b688..2b1d3e8 100644\\n--- a/js/src/xpconnect/src/xpcwrappednative.cpp\\n+++ b/js/src/xpconnect/src/xpcwrappednative.cpp\\n@@ -1889,16 +1889,6 @@ XPCWrappedNative::CallMethod(XPCCallContext& ccx,\\n     jsval* argv = ccx.GetArgv();\\n     PRUint32 argc = ccx.GetArgc();\\n \\n-#ifdef DEBUG_stats_jband\\n-    PRIntervalTime startTime = PR_IntervalNow();\\n-    PRIntervalTime endTime = 0;\\n-    static int totalTime = 0;\\n-    static int count = 0;\\n-    static const int interval = 10;\\n-    if(0 == (++count % interval))\\n-        printf(\\\">>>>>>>> %d calls on XPCWrappedNatives made.  (%d)\\\\n\\\", count, PR_IntervalToMilliseconds(totalTime));\\n-#endif\\n-\\n     ccx.SetRetVal(JSVAL_VOID);\\n \\n     tls->SetException(nsnull);\\n@@ -1925,7 +1915,7 @@ XPCWrappedNative::CallMethod(XPCCallContext& ccx,\\n             break;\\n         default:\\n             NS_ASSERTION(0,\\\"bad value\\\");\\n-            goto done;\\n+            return JS_FALSE;\\n     }\\n \\n     sm = xpcc->GetAppropriateSecurityManager(secFlag);\\n@@ -1936,7 +1926,58 @@ XPCWrappedNative::CallMethod(XPCCallContext& ccx,\\n                                      ccx.GetWrapper()->GetSecurityInfoAddr())))\\n     {\\n         // the security manager vetoed. It should have set an exception.\\n-        goto done;\\n+        return JS_FALSE;\\n+    }\\n+\\n+    // fast-path QueryInterface: we already know the signature and can avoid a\\n+    // lot of work\\n+    if(vtblIndex == 0)\\n+    {\\n+        if(argc < 1)\\n+        {\\n+            Throw(NS_ERROR_XPC_NOT_ENOUGH_ARGS, ccx);\\n+            return JS_FALSE;\\n+        }\\n+        nsID* iid;\\n+        JSObject* obj;\\n+        if(!JSVAL_IS_OBJECT(argv[0]) ||\\n+           (!(obj = JSVAL_TO_OBJECT(argv[0]))) ||\\n+           (!(iid = xpc_JSObjectToID(ccx, obj))))\\n+        {\\n+            ThrowBadParam(NS_ERROR_XPC_BAD_CONVERT_JS, 0, ccx);\\n+            return JS_FALSE;\\n+        }\\n+\\n+        nsISupports* qiresult = nsnull;\\n+        {\\n+            AutoJSSuspendRequest req(ccx);\\n+            invokeResult = callee->QueryInterface(*iid, (void**) &qiresult);\\n+        }\\n+\\n+        xpcc->SetLastResult(invokeResult);\\n+\\n+        if(NS_FAILED(invokeResult))\\n+        {\\n+            ThrowBadResult(invokeResult, ccx);\\n+            PR_Free(iid);\\n+            return JS_FALSE;\\n+        }\\n+\\n+        jsval v = JSVAL_NULL;\\n+        retval = XPCConvert::NativeData2JS(ccx, &v, &qiresult, \\n+                                           nsXPTType::T_INTERFACE_IS | XPT_TDP_POINTER,\\n+                                           iid, ccx.GetCurrentJSObject(), &err);\\n+        PR_Free(iid);\\n+        NS_IF_RELEASE(qiresult);\\n+\\n+        if(!retval)\\n+        {\\n+            ThrowBadParam(err, 0, ccx);\\n+            return JS_FALSE;\\n+        }\\n+\\n+        ccx.SetRetVal(v);\\n+        return JS_TRUE;\\n     }\\n \\n     if(NS_FAILED(ifaceInfo->GetMethodInfo(vtblIndex, &methodInfo)))\\n@@ -2465,17 +2506,6 @@ done:\\n     if(dispatchParams && dispatchParams != paramBuffer)\\n         delete [] dispatchParams;\\n \\n-#ifdef off_DEBUG_stats_jband\\n-    endTime = PR_IntervalNow();\\n-\\n-    printf(\\\"%s::%s %d ( js->c ) \\\\n\\\",\\n-           ccx.GetInterface()->GetNameString(),\\n-           ccx.GetInterface()->GetMemberName(ccx, ccx.GetMember()),\\n-           PR_IntervalToMilliseconds(endTime-startTime));\\n-\\n-    totalTime += (endTime-startTime);\\n-#endif\\n-\\n     return retval;\\n }\\n \\n\""}